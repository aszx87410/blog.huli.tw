<!DOCTYPE html>
<html class="has-navbar-fixed-top" lang="en">
<head>
    <meta charset="utf-8">
<title>Preventing XSS may be more difficult than you think - Huli&#39;s blog</title>
<meta name="viewport" content="width=device-width, initial-scale=1">


            
<link href="https://blog.huli.tw/2021/05/25/prevent-xss-is-not-that-easy/" rel="alternate" hreflang="zh-TW" />
            
    




    
<link rel="canonical" href="https://blog.huli.tw/2021/05/25/en/prevent-xss-is-not-that-easy/">
    





    <meta name="description" content="PrefaceIf you don’t know what XSS (Cross-site Scripting) is, in simple terms, it is when a hacker can execute JavaScript code on your website. Since it can be executed, it is possible to steal the use">
<meta property="og:type" content="article">
<meta property="og:title" content="Preventing XSS may be more difficult than you think">
<meta property="og:url" content="https://blog.huli.tw/2021/05/25/en/prevent-xss-is-not-that-easy/index.html">
<meta property="og:site_name" content="Huli&#39;s blog">
<meta property="og:description" content="PrefaceIf you don’t know what XSS (Cross-site Scripting) is, in simple terms, it is when a hacker can execute JavaScript code on your website. Since it can be executed, it is possible to steal the use">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://blog.huli.tw/img/prevent-xss-is-not-that-easy/cover-en.png">
<meta property="article:published_time" content="2021-05-25T13:59:58.000Z">
<meta property="article:modified_time" content="2023-06-20T05:46:56.925Z">
<meta property="article:author" content="Huli">
<meta property="article:tag" content="Front-end">
<meta property="article:tag" content="Security">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://blog.huli.tw/img/prevent-xss-is-not-that-easy/cover-en.png">



<link rel="alternative" href="/atom.xml" title="Preventing XSS may be more difficult than you think" type="application/atom+xml">



<link rel="icon" href="/img/lidemy_logo.png">


<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Ovo|Source+Code+Pro">


<link rel="stylesheet" href="/css/bulma.css?v=2.css">



<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/lightgallery/1.6.8/css/lightgallery.min.css">


<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/line-numbers/prism-line-numbers.min.css" />


<link rel="stylesheet" href="/css/style.css?v=4.css">





    
    
    
    
    
    
    
    
    
    
<script async src="https://www.googletagmanager.com/gtag/js?id=G-1393J2EVCZ"></script>
<script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-1393J2EVCZ');
</script>


    


<meta name="generator" content="Hexo 6.3.0"></head>
<body>
    <script>
        if (localStorage.getItem('dark-mode')) {
            if (localStorage.getItem('dark-mode') === 'true') {
                document.body.classList.add('dark-mode')
            }
        } else {
            if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                document.body.classList.add('dark-mode')
            }
        }
    </script>
    
<nav class="navbar is-transparent is-fixed-top navbar-main" role="navigation" aria-label="main navigation">
    <div class="container">
        <div class="navbar-brand">
            <a class="navbar-item navbar-logo" href="/en">
                
                    
                    Huli&#39;s blog
                    
                
            </a>
            <div class="navbar-burger">
                <span></span>
                <span></span>
                <span></span>
            </div>
        </div>
        
        <div class="navbar-menu navbar-start">
            
            <a class="navbar-item "
               href="/en/archives">Archive</a>
            
            <a class="navbar-item "
               href="/en/categories">Categories</a>
            
            <a class="navbar-item "
               href="/en/about">About</a>
            
        </div>
        
        <div class="navbar-menu navbar-end">
            
            
            <div class="navbar-item is-hoverable has-dropdown is-hidden-mobile is-hidden-tablet-only toc">
                <a class="navbar-item" title="Table of Contents">
                    Table of Contents
                </a>
                <div class="navbar-dropdown">
                    
                    
                    
                    
                    <a class="navbar-item" href="#preface">1&nbsp;&nbsp;<b>Preface</b></a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#incorrect-settings-unexpected-results">2&nbsp;&nbsp;<b>Incorrect settings, unexpected results</b></a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#first-problem-incorrect-attribute-filtering">3&nbsp;&nbsp;<b>First problem: Incorrect attribute filtering</b></a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#the-second-issue-unfiltered-html">4&nbsp;&nbsp;<b>The second issue: Unfiltered HTML</b></a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#summary">5&nbsp;&nbsp;<b>Summary</b></a>
                    
                </div>
            </div>
            
            
            <a class="navbar-item" target="_blank" title="Twitter" href="https://twitter.com/aszx87410">
                
                <i class="fab fa-twitter"></i>
                
            </a>
               
            <a class="navbar-item" target="_blank" title="RSS" href="/atom-en.xml">
                
                <i class="fas fa-rss"></i>
                
            </a>
               
            
            <a class="navbar-item btn-dark-mode" title="dark-mode" href="#">
                <div>
                    <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" width="15" height="15" viewBox="0 0 256 256" xml:space="preserve">
                    <defs>
                    </defs>
                    <g style="stroke: none; stroke-width: 0; stroke-dasharray: none; stroke-linecap: butt; stroke-linejoin: miter; stroke-miterlimit: 10; fill: none; fill-rule: nonzero; opacity: 1;" transform="translate(1.4065934065934016 1.4065934065934016) scale(2.81 2.81)" >
                        <path d="M 87.823 60.7 c -0.463 -0.423 -1.142 -0.506 -1.695 -0.214 c -15.834 8.398 -35.266 2.812 -44.232 -12.718 c -8.966 -15.53 -4.09 -35.149 11.101 -44.665 c 0.531 -0.332 0.796 -0.963 0.661 -1.574 c -0.134 -0.612 -0.638 -1.074 -1.259 -1.153 c -9.843 -1.265 -19.59 0.692 -28.193 5.66 C 13.8 12.041 6.356 21.743 3.246 33.35 S 1.732 57.08 7.741 67.487 c 6.008 10.407 15.709 17.851 27.316 20.961 C 38.933 89.486 42.866 90 46.774 90 c 7.795 0 15.489 -2.044 22.42 -6.046 c 8.601 -4.966 15.171 -12.43 18.997 -21.586 C 88.433 61.79 88.285 61.123 87.823 60.7 z" style="stroke: none; stroke-width: 1; stroke-dasharray: none; stroke-linecap: butt; stroke-linejoin: miter; stroke-miterlimit: 10; fill: #ffa716; fill-rule: nonzero; opacity: 1;" transform=" matrix(1 0 0 1 0 0) " stroke-linecap="round" />
                    </g>
                    </svg>
                </div>
            </a>
            
               <a class="navbar-item" href="/2021/05/25/prevent-xss-is-not-that-easy/">中文</a>
            
            

        </div>
    </div>
</nav>

    <section class="section">
    <div class="container">
      
      <div data-nosnippet class="self-notice">
        If you have any thoughts on my blog or articles and you want to let me know, you can either post a comment below(public) or tell me via this <a href="https://forms.gle/SjJZ4cnNs6NnjXQG8" target="_blank">feedback form</a>
      </div>
      
    <article class="article content gallery" itemscope itemprop="blogPost">
    <h1 class="article-title is-size-3 is-size-4-mobile" itemprop="name">
        
            Preventing XSS may be more difficult than you think
        
    </h1>
    <div class="article-meta columns is-variable is-1 is-multiline is-mobile is-size-7-mobile">
        <span class="column is-narrow">
            <time datetime="2021-05-25T13:59:58.000Z" itemprop="datePublished">25 May 2021</time>
        </span>
        
        <span class="column is-narrow article-category">
            <i class="far fa-folder"></i>
            <a class="article-category-link" href="/en/categories/Security/">Security</a>
        </span>
        
        
        
        <spen data-nosnippet class="column is-narrow">(Translated by ChatGPT)</span>
        
    </div>
    
    <div class="article-entry is-size-6-mobile" itemprop="articleBody">
    
        <h2><span id="preface">Preface</span></h2><p>If you don’t know what XSS (Cross-site Scripting) is, in simple terms, it is when a hacker can execute JavaScript code on your website. Since it can be executed, it is possible to steal the user’s token, impersonate the user’s identity to log in, even if the token cannot be stolen, it can still modify the page content, or redirect the user to a phishing website, and so on.</p>
<p>To prevent XSS, it is necessary to prevent hackers from executing code on the website, and there are many ways to defend against it. For example, CSP (Content-Security-Policy) can be used as an HTTP response header to prevent the execution of inline scripts or restrict the domains from which scripts can be loaded. Trusted Types can also be used to prevent some potential attacks and specify rules, or use some libraries that filter XSS, such as DOMPurify and js-xss.</p>
<p>But is it enough to use these? Yes and no.</p>
<p>If used correctly, of course, there is no problem, but if there are incorrect settings, there may still be XSS vulnerabilities.</p>
<p>Recently, I just transferred from a company to a cybersecurity team, <a target="_blank" rel="noopener" href="https://cymetrics.io/zh-tw">Cymetrics</a>, and when I was researching some websites, I found a ready-made case. Therefore, this article uses this ready-made case to illustrate what is called incorrect settings and what impact this setting will have.</p>
<span id="more"></span>

<h2><span id="incorrect-settings-unexpected-results">Incorrect settings, unexpected results</span></h2><p><a target="_blank" rel="noopener" href="https://matters.news/">Matters News</a> is a decentralized writing community platform, and all the code is <a target="_blank" rel="noopener" href="https://github.com/thematters">open source</a>!</p>
<p>For this kind of blog platform, what I like to see most is how they handle content filtering. With a curious and research-oriented attitude, let’s take a look at how they do it in the article and comment sections.</p>
<p>The server-side filtering code is here: <a target="_blank" rel="noopener" href="https://github.com/thematters/matters-server/blob/bf49f129eb63acaab707609f6a12fced7aaf0f4c/src/common/utils/xss.ts">matters-server&#x2F;src&#x2F;common&#x2F;utils&#x2F;xss.ts</a>:</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">import</span> xss <span class="token keyword">from</span> <span class="token string">'xss'</span>

<span class="token keyword">const</span> <span class="token constant">CUSTOM_WHITE_LISTS</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
  <span class="token literal-property property">a</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token operator">...</span><span class="token punctuation">(</span>xss<span class="token punctuation">.</span>whiteList<span class="token punctuation">.</span>a <span class="token operator">||</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'class'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token literal-property property">figure</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token literal-property property">figcaption</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token literal-property property">source</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'src'</span><span class="token punctuation">,</span> <span class="token string">'type'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token literal-property property">iframe</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'src'</span><span class="token punctuation">,</span> <span class="token string">'frameborder'</span><span class="token punctuation">,</span> <span class="token string">'allowfullscreen'</span><span class="token punctuation">,</span> <span class="token string">'sandbox'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">const</span> <span class="token function-variable function">onIgnoreTagAttr</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">tag</span><span class="token operator">:</span> string<span class="token punctuation">,</span> <span class="token literal-property property">name</span><span class="token operator">:</span> string<span class="token punctuation">,</span> <span class="token literal-property property">value</span><span class="token operator">:</span> string</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  <span class="token comment">/**
   * Allow attributes of whitelist tags start with "data-" or "class"
   *
   * @see https://github.com/leizongmin/js-xss#allow-attributes-of-whitelist-tags-start-with-data-
   */</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>name<span class="token punctuation">.</span><span class="token function">substr</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token string">'data-'</span> <span class="token operator">||</span> name<span class="token punctuation">.</span><span class="token function">substr</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token string">'class'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// escape its value using built-in escapeAttrValue function</span>
    <span class="token keyword">return</span> name <span class="token operator">+</span> <span class="token string">'="'</span> <span class="token operator">+</span> xss<span class="token punctuation">.</span><span class="token function">escapeAttrValue</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'"'</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">const</span> <span class="token function-variable function">ignoreTagProcessor</span> <span class="token operator">=</span> <span class="token punctuation">(</span>
  <span class="token parameter"><span class="token literal-property property">tag</span><span class="token operator">:</span> string<span class="token punctuation">,</span>
  <span class="token literal-property property">html</span><span class="token operator">:</span> string<span class="token punctuation">,</span>
  <span class="token literal-property property">options</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span> <span class="token punctuation">[</span>key<span class="token operator">:</span> string<span class="token punctuation">]</span><span class="token operator">:</span> any <span class="token punctuation">&#125;</span></span>
<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>tag <span class="token operator">===</span> <span class="token string">'input'</span> <span class="token operator">||</span> tag <span class="token operator">===</span> <span class="token string">'textarea'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> <span class="token string">''</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">const</span> xssOptions <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
  <span class="token literal-property property">whiteList</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span> <span class="token operator">...</span>xss<span class="token punctuation">.</span>whiteList<span class="token punctuation">,</span> <span class="token operator">...</span><span class="token constant">CUSTOM_WHITE_LISTS</span> <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
  onIgnoreTagAttr<span class="token punctuation">,</span>
  <span class="token literal-property property">onIgnoreTag</span><span class="token operator">:</span> ignoreTagProcessor<span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span>
<span class="token keyword">const</span> customXSS <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">xss<span class="token punctuation">.</span>FilterXSS</span><span class="token punctuation">(</span>xssOptions<span class="token punctuation">)</span>

<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">sanitize</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">string</span><span class="token operator">:</span> string</span><span class="token punctuation">)</span> <span class="token operator">=></span> customXSS<span class="token punctuation">.</span><span class="token function">process</span><span class="token punctuation">(</span>string<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>What is worth noting here is this part:</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> <span class="token constant">CUSTOM_WHITE_LISTS</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
  <span class="token literal-property property">a</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token operator">...</span><span class="token punctuation">(</span>xss<span class="token punctuation">.</span>whiteList<span class="token punctuation">.</span>a <span class="token operator">||</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'class'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token literal-property property">figure</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token literal-property property">figcaption</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token literal-property property">source</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'src'</span><span class="token punctuation">,</span> <span class="token string">'type'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token literal-property property">iframe</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'src'</span><span class="token punctuation">,</span> <span class="token string">'frameborder'</span><span class="token punctuation">,</span> <span class="token string">'allowfullscreen'</span><span class="token punctuation">,</span> <span class="token string">'sandbox'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>This part allows the tags and attributes that can be used, and the content of the attributes will also be filtered. For example, although iframe and src attributes are allowed, <code>&lt;iframe src=&quot;javascript:alert(1)&quot;&gt;</code> will not work because src starting with <code>javascript:</code> will be filtered out.</p>
<p>It’s not enough to just look at the server-side, we also need to see how the client-side renders.</p>
<p>For displaying articles, it is like this: <a target="_blank" rel="noopener" href="https://github.com/thematters/matters-web/blob/0349fd87cc4737ff9509ec5eae2c2d4bda9de057/src/views/ArticleDetail/Content/index.tsx">src&#x2F;views&#x2F;ArticleDetail&#x2F;Content&#x2F;index.tsx</a></p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token operator">&lt;</span><span class="token operator">></span>
  <span class="token operator">&lt;</span>div
    className<span class="token operator">=</span><span class="token punctuation">&#123;</span><span class="token function">classNames</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span> <span class="token string-property property">'u-content'</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> translating <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span>
    dangerouslySetInnerHTML<span class="token operator">=</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span>
      <span class="token literal-property property">__html</span><span class="token operator">:</span> <span class="token function">optimizeEmbed</span><span class="token punctuation">(</span>translation <span class="token operator">||</span> article<span class="token punctuation">.</span>content<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span>
    onClick<span class="token operator">=</span><span class="token punctuation">&#123;</span>captureClicks<span class="token punctuation">&#125;</span>
    ref<span class="token operator">=</span><span class="token punctuation">&#123;</span>contentContainer<span class="token punctuation">&#125;</span>
  <span class="token operator">/</span><span class="token operator">></span>

  <span class="token operator">&lt;</span>style jsx<span class="token operator">></span><span class="token punctuation">&#123;</span>styles<span class="token punctuation">&#125;</span><span class="token operator">&lt;</span><span class="token operator">/</span>style<span class="token operator">></span>
<span class="token operator">&lt;</span><span class="token operator">/</span><span class="token operator">></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>Matters’ frontend uses React, and everything rendered in React is escaped by default, so there are basically no XSS vulnerabilities. But sometimes we don’t want it to be filtered, such as the content of an article, we may need some tags to be rendered as HTML, and then we can use <code>dangerouslySetInnerHTML</code>, which will render the content directly as innerHTML and will not be filtered.</p>
<p>So generally, the approach is to use js-xss + dangerouslySetInnerHTML to ensure that the rendered content is HTML but not XSS.</p>
<p>Here, before passing in dangerouslySetInnerHTML, there is a function called optimizeEmbed, and you can continue to trace down to <a target="_blank" rel="noopener" href="https://github.com/thematters/matters-web/blob/0349fd87cc4737ff9509ec5eae2c2d4bda9de057/src/common/utils/text.ts#L89">src&#x2F;common&#x2F;utils&#x2F;text.ts</a>:</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">optimizeEmbed</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">content</span><span class="token operator">:</span> string</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">return</span> content
    <span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\&lt;iframe </span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">,</span> <span class="token string">'&lt;iframe loading="lazy"'</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>
      <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">&lt;img\s[^>]*?src\s*=\s*['\"]([^'\"]*?)['\"][^>]*?></span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">,</span>
      <span class="token punctuation">(</span><span class="token parameter">match<span class="token punctuation">,</span> src<span class="token punctuation">,</span> offset</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token comment">/* html */</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
      &lt;picture>
        &lt;source
          type="image/webp"
          media="(min-width: 768px)"
          srcSet=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span><span class="token function">toSizedImageURL</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span> <span class="token literal-property property">url</span><span class="token operator">:</span> src<span class="token punctuation">,</span> <span class="token literal-property property">size</span><span class="token operator">:</span> <span class="token string">'1080w'</span><span class="token punctuation">,</span> <span class="token literal-property property">ext</span><span class="token operator">:</span> <span class="token string">'webp'</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">
          onerror="this.srcset='</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>src<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">'"
        />
        &lt;source
          media="(min-width: 768px)"
          srcSet=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span><span class="token function">toSizedImageURL</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span> <span class="token literal-property property">url</span><span class="token operator">:</span> src<span class="token punctuation">,</span> <span class="token literal-property property">size</span><span class="token operator">:</span> <span class="token string">'1080w'</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">
          onerror="this.srcset='</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>src<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">'"
        />
        &lt;source
          type="image/webp"
          srcSet=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span><span class="token function">toSizedImageURL</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span> <span class="token literal-property property">url</span><span class="token operator">:</span> src<span class="token punctuation">,</span> <span class="token literal-property property">size</span><span class="token operator">:</span> <span class="token string">'540w'</span><span class="token punctuation">,</span> <span class="token literal-property property">ext</span><span class="token operator">:</span> <span class="token string">'webp'</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">
        />
        &lt;img
          src=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>src<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">
          srcSet=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span><span class="token function">toSizedImageURL</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span> <span class="token literal-property property">url</span><span class="token operator">:</span> src<span class="token punctuation">,</span> <span class="token literal-property property">size</span><span class="token operator">:</span> <span class="token string">'540w'</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">
          loading="lazy"
        />
      &lt;/picture>
    </span><span class="token template-punctuation string">`</span></span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>Here, RegExp is used to extract the <code>img src</code>, and then the HTML is directly spliced together using string concatenation. Then, see <a target="_blank" rel="noopener" href="https://github.com/thematters/matters-web/blob/0349fd87cc4737ff9509ec5eae2c2d4bda9de057/src/common/utils/url.ts#L49">toSizedImageURL</a>:</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">toSizedImageURL</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">&#123;</span> url<span class="token punctuation">,</span> size<span class="token punctuation">,</span> ext <span class="token punctuation">&#125;</span><span class="token operator">:</span> ToSizedImageURLProps</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">const</span> assetDomain <span class="token operator">=</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NEXT_PUBLIC_ASSET_DOMAIN</span>
    <span class="token operator">?</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">https://</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NEXT_PUBLIC_ASSET_DOMAIN</span><span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token template-punctuation string">`</span></span>
    <span class="token operator">:</span> <span class="token string">''</span>
  <span class="token keyword">const</span> isOutsideLink <span class="token operator">=</span> url<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>assetDomain<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span>
  <span class="token keyword">const</span> isGIF <span class="token operator">=</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">gif</span><span class="token regex-delimiter">/</span><span class="token regex-flags">i</span></span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>assetDomain <span class="token operator">||</span> isOutsideLink <span class="token operator">||</span> isGIF<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> url
  <span class="token punctuation">&#125;</span>

  <span class="token keyword">const</span> key <span class="token operator">=</span> url<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>assetDomain<span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> extedUrl <span class="token operator">=</span> <span class="token function">changeExt</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span> key<span class="token punctuation">,</span> ext <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> prefix <span class="token operator">=</span> size <span class="token operator">?</span> <span class="token string">'/'</span> <span class="token operator">+</span> <span class="token constant">PROCESSED_PREFIX</span> <span class="token operator">+</span> <span class="token string">'/'</span> <span class="token operator">+</span> size <span class="token operator">:</span> <span class="token string">''</span>

  <span class="token keyword">return</span> assetDomain <span class="token operator">+</span> prefix <span class="token operator">+</span> extedUrl
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>As long as the domain is the assets’ domain and meets other conditions, it will be returned after some string processing.</p>
<p>Seeing this, you can roughly understand the entire rendering process of the article.</p>
<p><code>js-xss</code> is used to filter on the server-side, and <code>dangerouslySetInnerHTML</code> is used to render on the client-side. Among them, some processing is done on the <code>img</code> tag, and the <code>img</code> is changed to load different images for different resolutions or screen sizes using <code>picture + source</code>.</p>
<p>The above is the entire process of rendering articles on this website. Before continuing to read, you can think about whether there are any problems?</p>
<p>&#x3D;&#x3D; Lightning Protection Separator &#x3D;&#x3D;<br>&#x3D;&#x3D; Lightning Protection Separator &#x3D;&#x3D;<br>&#x3D;&#x3D; Lightning Protection Separator &#x3D;&#x3D;<br>&#x3D;&#x3D; Lightning Protection Separator &#x3D;&#x3D;<br>&#x3D;&#x3D; Lightning Protection Separator &#x3D;&#x3D;<br>&#x3D;&#x3D; Lightning Protection Separator &#x3D;&#x3D;<br>&#x3D;&#x3D; Lightning Protection Separator &#x3D;&#x3D;<br>&#x3D;&#x3D; Lightning Protection Separator &#x3D;&#x3D;<br>&#x3D;&#x3D; Lightning Protection Separator &#x3D;&#x3D;<br>&#x3D;&#x3D; Lightning Protection Separator &#x3D;&#x3D;<br>&#x3D;&#x3D; Lightning Protection Separator &#x3D;&#x3D;<br>&#x3D;&#x3D; Lightning Protection Separator &#x3D;&#x3D;<br>&#x3D;&#x3D; Lightning Protection Separator &#x3D;&#x3D;<br>&#x3D;&#x3D; Lightning Protection Separator &#x3D;&#x3D;<br>&#x3D;&#x3D; Lightning Protection Separator &#x3D;&#x3D;  </p>
<h2><span id="first-problem-incorrect-attribute-filtering">First problem: Incorrect attribute filtering</span></h2><p>Did you notice any problems with the filtering here?</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> <span class="token constant">CUSTOM_WHITE_LISTS</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
  <span class="token literal-property property">a</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token operator">...</span><span class="token punctuation">(</span>xss<span class="token punctuation">.</span>whiteList<span class="token punctuation">.</span>a <span class="token operator">||</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'class'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token literal-property property">figure</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token literal-property property">figcaption</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token literal-property property">source</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'src'</span><span class="token punctuation">,</span> <span class="token string">'type'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token literal-property property">iframe</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'src'</span><span class="token punctuation">,</span> <span class="token string">'frameborder'</span><span class="token punctuation">,</span> <span class="token string">'allowfullscreen'</span><span class="token punctuation">,</span> <span class="token string">'sandbox'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>Opening <code>iframe</code> should be to allow users to embed things like YouTube videos, but the problem is that this website does not specify a valid domain using CSP, so the <code>src</code> here can be filled in randomly. I can make a website myself and embed it using <code>iframe</code>. If the webpage is designed well, it will look like a part of this website:</p>
<p><img src="/img/prevent-xss/iframe.png"></p>
<p>The above is just a random example, mainly to give you an idea. If you really want to attack, you can make it more sophisticated and more attractive.</p>
<p>If that’s all, whether the attack can succeed depends on whether the content can be trusted by the user. But actually, more can be done. Do you know that you can manipulate the external website inside the <code>iframe</code>?</p>
<p>The things that cross-origin windows can access are limited, and the only thing that can be changed is <code>location</code>, which means that we can redirect the embedded website:</p>
<pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">></span></span><span class="token script"><span class="token language-javascript">
  top<span class="token punctuation">.</span>location <span class="token operator">=</span> <span class="token string">'https://google.com'</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>If I do this, I can redirect the entire website to anywhere. The simplest application that can be thought of is to redirect to a phishing website. The success rate of such phishing websites is relatively high because users may not even realize that they have been redirected to another website.</p>
<p>In fact, browsers have defenses against such redirects, and the above code will produce an error:</p>
<blockquote>
<p>Unsafe attempt to initiate navigation for frame with origin ‘<a target="_blank" rel="noopener" href="https://matters.news/">https://matters.news</a>‘ from frame with URL ‘<a target="_blank" rel="noopener" href="https://53469602917d.ngrok.io/">https://53469602917d.ngrok.io/</a>‘. The frame attempting navigation is targeting its top-level window, but is neither same-origin with its target nor has it received a user gesture. See <a target="_blank" rel="noopener" href="https://www.chromestatus.com/features/5851021045661696">https://www.chromestatus.com/features/5851021045661696</a>.</p>
</blockquote>
<blockquote>
<p>Uncaught DOMException: Failed to set the ‘href’ property on ‘Location’: The current window does not have permission to navigate the target frame to ‘<a target="_blank" rel="noopener" href="https://google.com/">https://google.com</a>‘</p>
</blockquote>
<p>Because it is not the same origin, the iframe will be prevented from redirecting the top-level window.</p>
<p>However, this can be bypassed, and it will use the <code>sandbox</code> attribute. This attribute actually specifies what permissions the embedded <code>iframe</code> has, so as long as it is changed to: <code>&lt;iframe sandbox=&quot;allow-top-navigation allow-scripts allow-same-origin&quot; src=example.com&gt;&lt;/iframe&gt;</code>, it can successfully redirect the top-level window and redirect the entire website.</p>
<p>This vulnerability has been found in both GitLab and codimd.</p>
<p>There are several ways to fix this issue. The first one is to remove the <code>sandbox</code> attribute so that it cannot be used. If it is needed somewhere, the value inside should be checked, and the more dangerous <code>allow-top-navigation</code> should be removed.</p>
<p>Another way is to restrict the location of the iframe src, which can be done at different levels. For example, filtering src in the code and only allowing specific domains, or using <code>CSP:frame-src</code> to let the browser block domains that do not comply.</p>
<h2><span id="the-second-issue-unfiltered-html">The second issue: Unfiltered HTML</span></h2><p>The first issue can cause the biggest danger, probably just a redirect (the codimd article says that XSS can be done in Safari, but I can’t do it QQ). However, there is a bigger problem besides this, which is here:</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token operator">&lt;</span><span class="token operator">></span>
  <span class="token operator">&lt;</span>div
    className<span class="token operator">=</span><span class="token punctuation">&#123;</span><span class="token function">classNames</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span> <span class="token string-property property">'u-content'</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> translating <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span>
    dangerouslySetInnerHTML<span class="token operator">=</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span>
      <span class="token literal-property property">__html</span><span class="token operator">:</span> <span class="token function">optimizeEmbed</span><span class="token punctuation">(</span>translation <span class="token operator">||</span> article<span class="token punctuation">.</span>content<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span>
    onClick<span class="token operator">=</span><span class="token punctuation">&#123;</span>captureClicks<span class="token punctuation">&#125;</span>
    ref<span class="token operator">=</span><span class="token punctuation">&#123;</span>contentContainer<span class="token punctuation">&#125;</span>
  <span class="token operator">/</span><span class="token operator">></span>

  <span class="token operator">&lt;</span>style jsx<span class="token operator">></span><span class="token punctuation">&#123;</span>styles<span class="token punctuation">&#125;</span><span class="token operator">&lt;</span><span class="token operator">/</span>style<span class="token operator">></span>
<span class="token operator">&lt;</span><span class="token operator">/</span><span class="token operator">></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><code>article.content</code> is an HTML string filtered by js-xss, so it is safe. However, here it goes through an <code>optimizeEmbed</code> to do custom conversion, which is a more dangerous thing to do after filtering, because if there is negligence in the process, it will cause an XSS vulnerability.</p>
<p>In the conversion, there is a piece of code:</p>
<pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>source</span>
  <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>image/webp<span class="token punctuation">"</span></span>
  <span class="token attr-name">media</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>(min-width: 768px)<span class="token punctuation">"</span></span>
  <span class="token attr-name">srcSet</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span>$&#123;toSizedImageURL(&#123;</span> <span class="token attr-name"><span class="token namespace">url:</span></span> <span class="token attr-name">src,</span> <span class="token attr-name"><span class="token namespace">size:</span></span> <span class="token attr-name">'1080w',</span> <span class="token attr-name"><span class="token namespace">ext:</span></span> <span class="token attr-name">'webp'</span> <span class="token attr-name">&#125;)&#125;</span>
  <span class="token special-attr"><span class="token attr-name">onerror</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token value javascript language-javascript"><span class="token keyword">this</span><span class="token punctuation">.</span>srcset<span class="token operator">=</span><span class="token string">'$&#123;src&#125;'</span></span><span class="token punctuation">"</span></span></span>
<span class="token punctuation">/></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>Looking closely at this code, if <code>$&#123;toSizedImageURL(&#123; url: src, size: &#39;1080w&#39;, ext: &#39;webp&#39; &#125;)&#125;</code> or <code>src</code> can be controlled, there is a chance to change the content of the attribute or add a new attribute.</p>
<p>I originally wanted to insert a malicious src to make onerror become <code>onerror=&quot;this.srcset=&#39;test&#39;;alert(1)&quot;</code> and other code, but I later found that the onerror event of the source under the picture seems to be invalid, even if there is an error in srcset, it will not trigger, so it is useless.</p>
<p>Therefore, I focused on srcSet and inserting new attributes. Here, <code>onanimationstart</code> can be used, which is an event that will be triggered when the animation starts, and the name of the animation can be found in CSS. Fortunately, I found a keyframe called <code>spinning</code>.</p>
<p>So if the img src is: <code>https://assets.matters.news/processed/1080w/embed/test style=animation-name:spinning onanimationstart=console.log(1337)</code></p>
<p>The combined code is:</p>
<pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>source</span>
  <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>image/webp<span class="token punctuation">"</span></span>
  <span class="token attr-name">media</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>(min-width: 768px)<span class="token punctuation">"</span></span>   
  <span class="token attr-name">srcSet</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span>https://assets.matters.news/processed/1080w/embed/test</span> 
  <span class="token special-attr"><span class="token attr-name">style</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token value css language-css"><span class="token property">animation-name</span><span class="token punctuation">:</span>spinning</span></span></span> 
  <span class="token attr-name">onanimationstart</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span>console.log(1337)</span>
  <span class="token special-attr"><span class="token attr-name">onerror</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token value javascript language-javascript"><span class="token keyword">this</span><span class="token punctuation">.</span>srcset<span class="token operator">=</span><span class="token string">'$&#123;src&#125;'</span></span><span class="token punctuation">"</span></span></span>
<span class="token punctuation">/></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>In this way, an XSS vulnerability is created:</p>
<p><img src="/img/prevent-xss/xss1.png"><br><img src="/img/prevent-xss/xss2.png"></p>
<p>There are several ways to fix it:</p>
<ol>
<li>Add a CSP header to prevent the execution of inline scripts (this is more difficult to achieve because it may conflict with existing things and requires more time to process).</li>
<li>Filter the img url passed in (there is still a risk if the filtering is not done well).</li>
<li>Change the HTML first and then call js-xss to filter out the attributes that should not exist.</li>
</ol>
<h2><span id="summary">Summary</span></h2><p>We found two vulnerabilities:</p>
<ol>
<li>Redirect users to any location through <code>&lt;iframe&gt;</code></li>
<li>Execute an XSS attack on the article page through <code>&lt;source&gt;</code></li>
</ol>
<p>What kind of attack can actually be done?</p>
<p>First, use the second vulnerability to publish an article with an XSS attack, and then write a bot to leave a message under all articles, using <code>&lt;iframe&gt;</code> to redirect users to the article with XSS. In this way, as long as the user clicks on any article, they will be attacked.</p>
<p>However, the defense of other parts of the website itself is well done. Although there is XSS, the Cookie is HttpOnly, so it cannot be stolen, and the password modification is sent by email, so the password cannot be modified. It seems that it is not possible to do really serious things.</p>
<p>Many libraries that filter XSS are safe (although sometimes there are still vulnerabilities found, such as <a target="_blank" rel="noopener" href="https://portswigger.net/research/bypassing-dompurify-again-with-mutation-xss">bypassing DOMPurify</a>), but people who use the library may ignore some settings or do extra things, resulting in HTML that is still unsafe.</p>
<p>When dealing with user input, every step should be carefully reviewed to avoid negligence.</p>
<p>It is also recommended to set up CSP headers as a last line of defense against XSS attacks. Although some CSP rules can be bypassed, it is still better than having nothing.</p>
<p>Matters has its own Bug Bounty Program, which offers rewards for finding vulnerabilities that can prove harmful. The XSS vulnerability found in this article is classified as High, with a value of $150 USD. The team believes that open source can benefit technical professionals and make websites more secure, so they hope everyone knows about this program.</p>
<p>Finally, thanks to the Matters team for their quick response and handling, and thanks to the colleagues at Cymetrics.</p>
<p>Timeline:</p>
<ul>
<li>May 7, 2021: Vulnerability reported</li>
<li>May 12, 2021: Received confirmation from the Matters team that they are fixing the vulnerability</li>
<li>May 12, 2021: Asked for permission to publish the article after the fix, received permission</li>
<li>May 13, 2021: Fix completed</li>
</ul>

    
    </div>
    
    <div class="columns is-variable is-1 is-multiline is-mobile">
    
        <span class="column is-narrow"><a class="tag is-light article-tag" href="/en/tags/Front-end/">#Front-end</a></span>
    
        <span class="column is-narrow"><a class="tag is-light article-tag" href="/en/tags/Security/">#Security</a></span>
    
    </div>
    
    
    <div class="columns is-mobile is-multiline article-nav">
        <span class="column is-12-mobile is-half-desktop  article-nav-prev">
            
            <a href="/2021/05/25/en/xss-challenge-by-intigriti-writeup/">Solving Intigriti&#39;s 0421 XSS Challenge (Part 1)</a>
            
        </span>
        <span class="column is-12-mobile is-half-desktop  article-nav-next">
            
            <a href="/2021/04/17/en/css-attrs/">Some useful CSS properties that are not easy to remember</a>
            
        </span>
    </div>
    
</article>




<div class="comments">
    <h3 class="title is-4">Comments</h3>
    <script src="https://utteranc.es/client.js"
        repo="aszx87410/huli-blog"
        issue-term="title"
        theme="github-light"
        crossorigin="anonymous"
        async>
</script>
</div>

    </div>
</section>
    <footer class="footer">
    <div class="container">
        <div class="columns content">
            <div class="column is-narrow has-text-centered">
                &copy; 2024 Huli&nbsp;
                Powered by <a href="http://hexo.io/" target="_blank">Hexo</a> & <a
                        target="_blank" rel="noopener" href="http://github.com/ppoffice/hexo-theme-minos">Minos</a>
            </div>
            <div class="column is-hidden-mobile"></div>

            
            <div class="column is-narrow">
                <div class="columns is-mobile is-multiline is-centered">
                
                    
                <a class="column is-narrow" title="GitHub" target="_blank" rel="noopener" href="https://github.com/ppoffice/hexo-theme-minos">
                    
                    GitHub
                    
                </a>
                
                </div>
            </div>
            
            
<div class="column is-narrow has-text-centered">
    <div class="dropdown is-up is-right is-hoverable" style="margin-top: -0.2em;">
        <div class="dropdown-trigger">
            <button class="button is-small" aria-haspopup="true">
                <span class="icon">
                    <i class="fas fa-globe"></i>
                </span>
                <span>English</span>
                <span class="icon is-small">
            <i class="fas fa-angle-down" aria-hidden="true"></i>
          </span>
            </button>
        </div>
        <div class="dropdown-menu has-text-left" role="menu" style="top:100%">
            <div class="dropdown-content">
            <!-- NOTE: 永遠回到首頁 -->
            
                <a href="/2021/05/25/prevent-xss-is-not-that-easy/" class="dropdown-item">
                    繁體中文
                </a>
            
            </div>
        </div>
    </div>
</div>

        </div>
    </div>
</footer>
    <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/3.6.3/jquery.min.js"></script>



    
    
    
    
    
    
<script src="//cdnjs.cloudflare.com/ajax/libs/lightgallery/1.6.8/js/lightgallery-all.min.js"></script>
<script>
    (function ($) {
        $(document).ready(function () {
            if (typeof($.fn.lightGallery) === 'function') {
                $('.article.gallery').lightGallery({ selector: '.gallery-item' });
            }
        });
    })(jQuery);
</script>

    
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.0/clipboard.min.js"></script>
    <style>
        .hljs {
            position: relative;
        }

        .hljs .clipboard-btn {
            float: right;
            color: #9a9a9a;
            background: none;
            border: none;
            cursor: pointer;
        }

        .hljs .clipboard-btn:hover {
          color: #8a8a8a;
        }

        .hljs > .clipboard-btn {
            display: none;
            position: absolute;
            right: 4px;
            top: 4px;
        }

        .hljs:hover > .clipboard-btn {
            display: inline;
        }

        .hljs > figcaption > .clipboard-btn {
            margin-right: 4px;
        }
    </style>
    <script>
      $(document).ready(function () {
        $('figure.hljs').each(function(i, figure) {
          var codeId = 'code-' + i;
          var code = figure.querySelector('.code');
          var copyButton = $('<button>Copy <i class="far fa-clipboard"></i></button>');
          code.id = codeId;
          copyButton.addClass('clipboard-btn');
          copyButton.attr('data-clipboard-target-id', codeId);

          var figcaption = figure.querySelector('figcaption');

          if (figcaption) {
            figcaption.append(copyButton[0]);
          } else {
            figure.prepend(copyButton[0]);
          }
        })

        var clipboard = new ClipboardJS('.clipboard-btn', {
          target: function(trigger) {
            return document.getElementById(trigger.getAttribute('data-clipboard-target-id'));
          }
        });
        clipboard.on('success', function(e) {
          e.clearSelection();
        })
      })
    </script>

    
    

    



<script src="/js/script.js?v=3.js"></script>


    
</body>
</html>