<!DOCTYPE html>
<html class="has-navbar-fixed-top" lang="en">
<head>
    <meta charset="utf-8">
<title>CORS Complete Guide (5): Security Issues of Cross-Origin - Huli&#39;s blog</title>
<meta name="viewport" content="width=device-width, initial-scale=1">


            
<link href="https://blog.huli.tw/2021/02/19/cors-guide-5/" rel="alternate" hreflang="zh-TW" />
            
    




    
<link rel="canonical" href="https://blog.huli.tw/2021/02/19/en/cors-guide-5/">
    





    <meta name="description" content="IntroductionIn the previous articles, we learned that the CORS protocol is essentially a security protocol. In addition to CORS, there are actually a series of things related to cross-origin, such as:">
<meta property="og:type" content="article">
<meta property="og:title" content="CORS Complete Guide (5): Security Issues of Cross-Origin">
<meta property="og:url" content="https://blog.huli.tw/2021/02/19/en/cors-guide-5/index.html">
<meta property="og:site_name" content="Huli&#39;s blog">
<meta property="og:description" content="IntroductionIn the previous articles, we learned that the CORS protocol is essentially a security protocol. In addition to CORS, there are actually a series of things related to cross-origin, such as:">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://blog.huli.tw/img/cors-guide-5/cover-en.png">
<meta property="article:published_time" content="2021-02-18T16:20:13.000Z">
<meta property="article:modified_time" content="2023-06-20T05:46:56.903Z">
<meta property="article:author" content="Huli">
<meta property="article:tag" content="Front-end">
<meta property="article:tag" content="Ajax">
<meta property="article:tag" content="JavaScript">
<meta property="article:tag" content="CORS">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://blog.huli.tw/img/cors-guide-5/cover-en.png">



<link rel="alternative" href="/atom.xml" title="CORS Complete Guide (5): Security Issues of Cross-Origin" type="application/atom+xml">



<link rel="icon" href="/img/lidemy_logo.png">


<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Ovo|Source+Code+Pro">


<link rel="stylesheet" href="/css/bulma.css?v=2.css">



<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/lightgallery/1.6.8/css/lightgallery.min.css">


<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/line-numbers/prism-line-numbers.min.css" />


<link rel="stylesheet" href="/css/style.css?v=4.css">





    
    
    
    
    
    
    
    
    
    
<script async src="https://www.googletagmanager.com/gtag/js?id=G-1393J2EVCZ"></script>
<script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-1393J2EVCZ');
</script>


    


<meta name="generator" content="Hexo 6.3.0"></head>
<body>
    <script>
        if (localStorage.getItem('dark-mode')) {
            if (localStorage.getItem('dark-mode') === 'true') {
                document.body.classList.add('dark-mode')
            }
        } else {
            if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                document.body.classList.add('dark-mode')
            }
        }
    </script>
    
<nav class="navbar is-transparent is-fixed-top navbar-main" role="navigation" aria-label="main navigation">
    <div class="container">
        <div class="navbar-brand">
            <a class="navbar-item navbar-logo" href="/en">
                
                    
                    Huli&#39;s blog
                    
                
            </a>
            <div class="navbar-burger">
                <span></span>
                <span></span>
                <span></span>
            </div>
        </div>
        
        <div class="navbar-menu navbar-start">
            
            <a class="navbar-item "
               href="/en/archives">Archive</a>
            
            <a class="navbar-item "
               href="/en/categories">Categories</a>
            
            <a class="navbar-item "
               href="/en/about">About</a>
            
        </div>
        
        <div class="navbar-menu navbar-end">
            
            
            <div class="navbar-item is-hoverable has-dropdown is-hidden-mobile is-hidden-tablet-only toc">
                <a class="navbar-item" title="Table of Contents">
                    Table of Contents
                </a>
                <div class="navbar-dropdown">
                    
                    
                    
                    
                    <a class="navbar-item" href="#introduction">1&nbsp;&nbsp;<b>Introduction</b></a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#cors-misconfiguration">2&nbsp;&nbsp;<b>CORS misconfiguration</b></a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#bypass-same-origin-policy">3&nbsp;&nbsp;<b>Bypass Same-origin Policy?</b></a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#lets-get-to-the-point-what-are-the-other-coxxs">4&nbsp;&nbsp;<b>Let’s get to the point: What are the other COXXs?</b></a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#serious-security-vulnerabilities-meltdown-and-spectre">5&nbsp;&nbsp;<b>Serious Security Vulnerabilities: Meltdown and Spectre</b></a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#super-simplified-explanation-of-spectre-attack">6&nbsp;&nbsp;<b>Super Simplified Explanation of Spectre Attack</b></a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#corb-cross-origin-read-blocking">7&nbsp;&nbsp;<b>CORB (Cross-Origin Read Blocking)</b></a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#corp-cross-origin-resource-policy">8&nbsp;&nbsp;<b>CORP (Cross-Origin Resource Policy)</b></a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#site-isolation">9&nbsp;&nbsp;<b>Site Isolation</b></a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#coep-cross-origin-embedder-policy">10&nbsp;&nbsp;<b>COEP (Cross-Origin-Embedder-Policy)</b></a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#coop-cross-origin-opener-policy">11&nbsp;&nbsp;<b>COOP (Cross-Origin-Opener-Policy)</b></a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#back-to-cross-origin-isolated-state">12&nbsp;&nbsp;<b>Back to cross-origin isolated state</b></a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#summary">13&nbsp;&nbsp;<b>Summary</b></a>
                    
                </div>
            </div>
            
            
            <a class="navbar-item" target="_blank" title="Twitter" href="https://twitter.com/aszx87410">
                
                <i class="fab fa-twitter"></i>
                
            </a>
               
            <a class="navbar-item" target="_blank" title="RSS" href="/atom-en.xml">
                
                <i class="fas fa-rss"></i>
                
            </a>
               
            
            <a class="navbar-item btn-dark-mode" title="dark-mode" href="#">
                <div>
                    <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" width="15" height="15" viewBox="0 0 256 256" xml:space="preserve">
                    <defs>
                    </defs>
                    <g style="stroke: none; stroke-width: 0; stroke-dasharray: none; stroke-linecap: butt; stroke-linejoin: miter; stroke-miterlimit: 10; fill: none; fill-rule: nonzero; opacity: 1;" transform="translate(1.4065934065934016 1.4065934065934016) scale(2.81 2.81)" >
                        <path d="M 87.823 60.7 c -0.463 -0.423 -1.142 -0.506 -1.695 -0.214 c -15.834 8.398 -35.266 2.812 -44.232 -12.718 c -8.966 -15.53 -4.09 -35.149 11.101 -44.665 c 0.531 -0.332 0.796 -0.963 0.661 -1.574 c -0.134 -0.612 -0.638 -1.074 -1.259 -1.153 c -9.843 -1.265 -19.59 0.692 -28.193 5.66 C 13.8 12.041 6.356 21.743 3.246 33.35 S 1.732 57.08 7.741 67.487 c 6.008 10.407 15.709 17.851 27.316 20.961 C 38.933 89.486 42.866 90 46.774 90 c 7.795 0 15.489 -2.044 22.42 -6.046 c 8.601 -4.966 15.171 -12.43 18.997 -21.586 C 88.433 61.79 88.285 61.123 87.823 60.7 z" style="stroke: none; stroke-width: 1; stroke-dasharray: none; stroke-linecap: butt; stroke-linejoin: miter; stroke-miterlimit: 10; fill: #ffa716; fill-rule: nonzero; opacity: 1;" transform=" matrix(1 0 0 1 0 0) " stroke-linecap="round" />
                    </g>
                    </svg>
                </div>
            </a>
            
               <a class="navbar-item" href="/2021/02/19/cors-guide-5/">中文</a>
            
            

        </div>
    </div>
</nav>

    <section class="section">
    <div class="container">
      
      <div data-nosnippet class="self-notice">
        If you have any thoughts on my blog or articles and you want to let me know, you can either post a comment below(public) or tell me via this <a href="https://forms.gle/SjJZ4cnNs6NnjXQG8" target="_blank">feedback form</a>
      </div>
      
    <article class="article content gallery" itemscope itemprop="blogPost">
    <h1 class="article-title is-size-3 is-size-4-mobile" itemprop="name">
        
            CORS Complete Guide (5): Security Issues of Cross-Origin
        
    </h1>
    <div class="article-meta columns is-variable is-1 is-multiline is-mobile is-size-7-mobile">
        <span class="column is-narrow">
            <time datetime="2021-02-18T16:20:13.000Z" itemprop="datePublished">19 February 2021</time>
        </span>
        
        <span class="column is-narrow article-category">
            <i class="far fa-folder"></i>
            <a class="article-category-link" href="/en/categories/Front-end/">Front-end</a>
        </span>
        
        
        
        <spen data-nosnippet class="column is-narrow">(Translated by ChatGPT)</span>
        
    </div>
    
    <div class="article-entry is-size-6-mobile" itemprop="articleBody">
    
        <h2><span id="introduction">Introduction</span></h2><p>In the previous articles, we learned that the CORS protocol is essentially a security protocol. In addition to CORS, there are actually a series of things related to cross-origin, such as:</p>
<ol>
<li>CORB (Cross-Origin Read Blocking)</li>
<li>CORP (Cross-Origin Resource Policy)</li>
<li>COEP (Cross-Origin-Embedder-Policy)</li>
<li>COOP (Cross-Origin-Opener-Policy)</li>
</ol>
<p>Doesn’t just seeing this series of similar terms make you dizzy? Yes, me too. In the process of organizing this information, I found that the security issues related to cross-origin are more complicated than I thought, but after spending some time organizing them, I found that there is still a logical sequence to follow. Therefore, this article will explain why these things appear in a context that I think should be easier to understand.</p>
<p>In addition to the various COXX things mentioned above, there are other cross-origin related security issues that I want to mention in this article.</p>
<p>Before we continue, I would like to remind everyone that this article is about “security issues of cross-origin”, not just “security issues of CORS”. The things protected by the CORS protocol and their content have been introduced before. What this article is going to talk about is actually somewhat deviating from the main title “CORS” complete guide, because this is not very related to the CORS protocol, but rather raises the level again and talks about “cross-origin” itself.</p>
<p>So when you read the following things, don’t confuse them with CORS. Except for the first thing to be discussed later, the others are not very related to CORS.</p>
<span id="more"></span>

<h2><span id="cors-misconfiguration">CORS misconfiguration</span></h2><p>If you still remember, I mentioned earlier that if a cross-origin request wants to carry a cookie, <code>Access-Control-Allow-Origin</code> cannot be <code>*</code>, but must specify a single origin, otherwise the browser will not pass it.</p>
<p>But the reality is that we cannot have only one origin. We may have many origins, such as <code>buy.example.com</code>, <code>social.example.com</code>, <code>note.example.com</code>, all of which need to access <code>api.example.com</code>. At this time, we cannot hard-code the origin in the response header, but must adjust it dynamically.</p>
<p>Let’s talk about the worst way first, like this:</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  res<span class="token punctuation">.</span>headers<span class="token punctuation">[</span><span class="token string">'Access-Control-Allow-Credentials'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'true'</span>
  res<span class="token punctuation">.</span>headers<span class="token punctuation">[</span><span class="token string">'Access-Control-Allow-Origin'</span><span class="token punctuation">]</span> <span class="token operator">=</span> req<span class="token punctuation">.</span>headers<span class="token punctuation">[</span><span class="token string">'Origin'</span><span class="token punctuation">]</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>For convenience, the origin in the request header is directly mapped. By doing so, it actually means that any origin can pass the CORS check.</p>
<p>What problems will this cause?</p>
<p>The problem is huge.</p>
<p>Assuming that I make a phishing website today, the URL is <code>http://fake-example.com</code>, and I try to make the user click on this website, and the phishing website writes a script:</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// 用 api 去拿使用者資料，並且帶上 cookie</span>
<span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">'http://api.example.com/me'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>
  <span class="token literal-property property">credentials</span><span class="token operator">:</span> <span class="token string">'include'</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">res</span> <span class="token operator">=></span> res<span class="token punctuation">.</span><span class="token function">text</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">res</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 成功拿到使用者資料，我可以傳送到我自己的 server</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span>

    <span class="token comment">// 把使用者導回真正的網站</span>
    window<span class="token punctuation">.</span>location <span class="token operator">=</span> <span class="token string">'http://example.com'</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>I use fetch to request <code>http://api.example.com/me</code> to get data and carry cookies. Then, because the server will always respond with the correct header, the CORS check will pass and I will get the data.</p>
<p>Therefore, this attack will be successful as long as the user clicks on the phishing website and is logged in to <code>example.com</code>. As for the scope of influence, it depends on the website’s api. The most basic thing is to only get user data, and more serious things may be able to get user tokens (if there is this api).</p>
<p>There are several things to note about this attack:</p>
<ol>
<li>This is not XSS, because I did not execute code on <code>example.com</code>, but executed it on my own phishing website <code>http://fake-example.com</code>.</li>
<li>This is somewhat like CSRF, but the website usually does not add CSRF token protection to GET APIs, so it can pass.</li>
<li>If SameSite cookie is set, the attack will fail because the cookie cannot be carried.</li>
</ol>
<p>Therefore, there are several prerequisites for this attack to succeed:</p>
<ol>
<li>The CORS header is given to the wrong origin.</li>
<li>The website uses cookies for identity authentication and does not set SameSite.</li>
<li>The user actively clicks on the phishing website and is logged in.</li>
</ol>
<p>Regarding the first point, no one may write like me above, directly using the origin in the request header. The more likely approach is like this:</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  res<span class="token punctuation">.</span>headers<span class="token punctuation">[</span><span class="token string">'Access-Control-Allow-Credentials'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'true'</span>
  <span class="token keyword">const</span> origin <span class="token operator">=</span> req<span class="token punctuation">.</span>headers<span class="token punctuation">[</span><span class="token string">'Origin'</span><span class="token punctuation">]</span>

  <span class="token comment">// 偵測是不是 example.com 結尾</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">example\.com$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>origin<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    res<span class="token punctuation">.</span>headers<span class="token punctuation">[</span><span class="token string">'Access-Control-Allow-Origin'</span><span class="token punctuation">]</span> <span class="token operator">=</span> origin
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>In this way, the origins below can all pass:</p>
<ol>
<li>example.com</li>
<li>buy.example.com</li>
<li>social.example.com</li>
</ol>
<p>However, writing like this is problematic because it can also pass:</p>
<ol>
<li>fakeexample.com</li>
</ol>
<p>This type of vulnerability is caused by incorrect CORS settings, so it is called CORS misconfiguration.</p>
<p>The solution is not to use RegExp for judgment, but to prepare a list in advance. Only those that appear in the list pass, otherwise they all fail. In this way, it can be ensured that there are no vulnerabilities in the judgment, and remember to add the SameSite attribute to the cookie.</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> allowOrigins <span class="token operator">=</span> <span class="token punctuation">[</span>
  <span class="token string">'example.com'</span><span class="token punctuation">,</span>
  <span class="token string">'buy.example.com'</span><span class="token punctuation">,</span>
  <span class="token string">'social.example.com'</span>
<span class="token punctuation">]</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  res<span class="token punctuation">.</span>headers<span class="token punctuation">[</span><span class="token string">'Access-Control-Allow-Credentials'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'true'</span>
  <span class="token keyword">const</span> origin <span class="token operator">=</span> req<span class="token punctuation">.</span>headers<span class="token punctuation">[</span><span class="token string">'Origin'</span><span class="token punctuation">]</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>allowOrigins<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span>origin<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    res<span class="token punctuation">.</span>headers<span class="token punctuation">[</span><span class="token string">'Access-Control-Allow-Origin'</span><span class="token punctuation">]</span> <span class="token operator">=</span> origin
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>For more information, please refer to:</p>
<ol>
<li><a target="_blank" rel="noopener" href="https://we45.com/blog/3-ways-to-exploit-misconfigured-cross-origin-resource-sharing-cors/">3 Ways to Exploit Misconfigured Cross-Origin Resource Sharing (CORS)</a></li>
<li><a target="_blank" rel="noopener" href="http://blog.saynotolinux.com/blog/2016/08/15/jetbrains-ide-remote-code-execution-and-local-file-disclosure-vulnerability-analysis/">JetBrains IDE Remote Code Execution and Local File Disclosure</a></li>
<li><a target="_blank" rel="noopener" href="https://www.youtube.com/watch?v=wgkj4ZgxI4c&ab_channel=OWASP">AppSec EU 2017 Exploiting CORS Misconfigurations For Bitcoins And Bounties by James Kettle</a></li>
</ol>
<h2><span id="bypass-same-origin-policy">Bypass Same-origin Policy?</span></h2><p>In addition to CORS, Same-origin policy actually appears in various places in the browser, such as <code>window.open</code> and <code>iframe</code>. When you use <code>window.open</code> to open a webpage, the return value will be the window of the new webpage (more precisely, it is WindowProxy, you can refer to <a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Web/API/Window/open">MDN: Window.open()</a>), but only in the same origin. Accessible, if it is not the same origin, only a small part of things can be accessed.</p>
<p>Assuming that I am now in <code>a.example.com</code>, and then wrote this script:</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">var</span> win <span class="token operator">=</span> window<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token string">'http://b.example.com'</span><span class="token punctuation">)</span>
<span class="token comment">// 等新的頁面載入完成</span>
<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>win<span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token number">2000</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>Use <code>window.open</code> to open <code>b.example.com</code>, and then go to access the window of <code>b.example.com</code> after the page is loaded.</p>
<p>After execution, you will see an error message in the console:</p>
<p><img src="/img/cors/part5/frame-block.png"></p>
<p>Because <code>a.example.com</code> and <code>b.example.com</code> are cross-origin, the window cannot be accessed. This specification is actually very reasonable, because if you can access the window, you can actually do a lot of things, so it is limited to being able to get the window only under the same origin.</p>
<p>However, the statement “cannot access the window” is not very accurate, because even if it is cross-origin, there are still some operations that are allowed, such as:</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">var</span> win <span class="token operator">=</span> window<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token string">'http://b.example.com'</span><span class="token punctuation">)</span>
<span class="token comment">// 等新的頁面載入完成</span>
<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  <span class="token comment">// 變更開啟的 window 的位置</span>
  win<span class="token punctuation">.</span>location <span class="token operator">=</span> <span class="token string">'https://google.com'</span>
  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 關閉視窗</span>
    win<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token number">2000</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token number">2000</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>Can change the location of the opened window and close the opened window.</p>
<p>On the other hand, as the opened window (<code>b.example.com</code>), you can also use <code>window.opener</code> to get the window of the webpage (<code>a.example.com</code>) that opened it, but only some operations are allowed.</p>
<p>However, if these two websites are under the same subdomain and you have control over both websites, you can make their origins the same by changing <code>document.domain</code>!</p>
<p>In <code>a.example.com</code>, do this:</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// 新增這個，把 domain 設為 example.com</span>
document<span class="token punctuation">.</span>domain <span class="token operator">=</span> <span class="token string">'example.com'</span>

<span class="token keyword">var</span> win <span class="token operator">=</span> window<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token string">'http://b.example.com'</span><span class="token punctuation">)</span>
<span class="token comment">// 等新的頁面載入完成</span>
<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>win<span class="token punctuation">.</span>secret<span class="token punctuation">)</span> <span class="token comment">// 12345</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token number">2000</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>In <code>b.example.com</code>, you also need to do the same thing:</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">document<span class="token punctuation">.</span>domain <span class="token operator">=</span> <span class="token string">'example.com'</span>
window<span class="token punctuation">.</span>secret <span class="token operator">=</span> <span class="token number">12345</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>Then you will magically find that you can now get the window of <code>b.example.com</code>! And almost everything can be done.</p>
<p>For more detailed introduction, please refer to MDN: <a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Web/API/Document/domain">Document.domain</a>. This may be due to historical factors, but it may be removed in the future due to security issues.</p>
<p>You can refer to the related spec: <a target="_blank" rel="noopener" href="https://html.spec.whatwg.org/multipage/origin.html#relaxing-the-same-origin-restriction">7.5.2 Relaxing the same-origin restriction</a></p>
<h2><span id="lets-get-to-the-point-what-are-the-other-coxxs">Let’s get to the point: What are the other COXXs?</span></h2><p>The first two are just small potatoes and not the main focus of this article. What I really want to share with you are:</p>
<ol>
<li>CORB (Cross-Origin Read Blocking)</li>
<li>CORP (Cross-Origin Resource Policy)</li>
<li>COEP (Cross-Origin-Embedder-Policy)</li>
<li>COOP (Cross-Origin-Opener-Policy)</li>
</ol>
<p>I will explain these things in a way that I think is easier to understand, as they can be easily confused if not explained properly.</p>
<h2><span id="serious-security-vulnerabilities-meltdown-and-spectre">Serious Security Vulnerabilities: Meltdown and Spectre</span></h2><p>On January 3, 2018, Google’s Project Zero released an article titled <a target="_blank" rel="noopener" href="https://googleprojectzero.blogspot.com/2018/01/reading-privileged-memory-with-side.html">Reading privileged memory with a side-channel</a>, which described three attacks on CPU data cache:</p>
<ul>
<li>Variant 1: bounds check bypass (CVE-2017-5753)</li>
<li>Variant 2: branch target injection (CVE-2017-5715)</li>
<li>Variant 3: rogue data cache load (CVE-2017-5754)</li>
</ul>
<p>The first two are called Spectre, and the third is called Meltdown. This was a big deal at the time because the problem was with the CPU and was not an easy fix.</p>
<p>The disclosure of this vulnerability had a significant impact on the operation of browsers (or at least accelerated the evolution of browsers), especially since Spectre can be used to attack browsers, which of course also affects this series of topics: Cross-Origin Resource Sharing.</p>
<p>Therefore, it is necessary to understand what Spectre is doing. If you want to fully understand this attack, you need a lot of background knowledge, but this is not the main topic of this article. Therefore, I will explain Spectre in a very simplified model below. If you want to fully understand it, you can refer to the link above.</p>
<h2><span id="super-simplified-explanation-of-spectre-attack">Super Simplified Explanation of Spectre Attack</span></h2><p>Again, this is a simplified version for easy understanding, and there are some differences from the original attack, but the core concept should be similar.</p>
<p>Assume that there is a piece of code (in C language) that looks like this:</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token class-name">uint8_t</span> arr1<span class="token punctuation">[</span><span class="token number">16</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span> 
<span class="token class-name">uint8_t</span> arr2<span class="token punctuation">[</span><span class="token number">256</span><span class="token punctuation">]</span><span class="token punctuation">;</span> 
<span class="token keyword">unsigned</span> <span class="token keyword">int</span> array1_size <span class="token operator">=</span> <span class="token number">16</span><span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">size_t</span> x<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span>x <span class="token operator">&lt;</span> array1_size<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token class-name">uint8_t</span> y <span class="token operator">=</span> array2<span class="token punctuation">[</span>array1<span class="token punctuation">[</span>x<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token class-name">size_t</span> x <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token function">run</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>I declared two arrays, both of type uint8_t, so each element of the array will be 1 byte (8 bits) in size. The length of arr1 is 16, and the length of arr2 is 256.</p>
<p>Next, I have a function called run, which takes a number x, and checks if x is less than array1_size. If it is, I first take the value of <code>array1[x]</code>, then use it as an index to access <code>array2</code>, and assign the obtained value to y.</p>
<p>For example, if <code>run(1)</code> is executed, the following code will be executed:</p>
<pre class="line-numbers language-C" data-language="C"><code class="language-C">uint8_t y &#x3D; array2[array1[1]];<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>And the value of <code>array1[1]</code> is 2, so it is <code>y = array2[2]</code>.</p>
<p>This code looks fine, and I have done the length check of the array, so there will be no Out-of-Bounds (OOB) situation, only when x is less than array1_size will it continue to execute.</p>
<p>However, this is just what you see.</p>
<p>When the CPU executes the code, there is a mechanism called branch prediction. In order to improve the efficiency of code execution, if the CPU encounters an if condition during execution, it will first predict whether the result is true or false. If the predicted result is true, it will first execute the code inside the if statement and calculate the result.</p>
<p>All of the above are just “predictions”. After the actual if condition is executed, if the result is the same as the predicted result, everything is fine. If it is different, the result just calculated will be discarded. This mechanism is called speculative execution.</p>
<p>Because the CPU discards the result, we cannot get the result of speculative execution unless the CPU leaves some clues.</p>
<p>And this is the main reason why the Spectre attack is successful, because there are indeed clues left.</p>
<p>To improve execution efficiency, some results are placed in the CPU cache during speculative execution to improve the efficiency of subsequent data reads.</p>
<p>Assuming there are three things, ABC, and one is in the CPU cache while the other two are not, how do we know which one is in the cache? The answer is by accessing these three things and measuring the time it takes to access them. Since the thing in the CPU cache is always accessed faster, if it takes 10ms to read A, 10ms to read B, and only 1ms to read C, we know that C must be in the CPU cache. This type of attack that obtains information through other clues is called a side-channel attack, which obtains information from other channels. </p>
<p>Using the timing-attack method mentioned above, we can now look back at the previous code:</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token class-name">uint8_t</span> arr1<span class="token punctuation">[</span><span class="token number">16</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span> 
<span class="token class-name">uint8_t</span> arr2<span class="token punctuation">[</span><span class="token number">256</span><span class="token punctuation">]</span><span class="token punctuation">;</span> 
<span class="token keyword">unsigned</span> <span class="token keyword">int</span> array1_size <span class="token operator">=</span> <span class="token number">16</span><span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">size_t</span> x<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span>x <span class="token operator">&lt;</span> array1_size<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token class-name">uint8_t</span> y <span class="token operator">=</span> array2<span class="token punctuation">[</span>array1<span class="token punctuation">[</span>x<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token class-name">size_t</span> x <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token function">run</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>Suppose I run <code>run(10)</code> many times, and the CPU predicts that I will satisfy the if condition next time and execute the code inside it. At this point, I suddenly set x to 100 and run <code>run(100)</code>. </p>
<p>The code inside the if statement will be predicted to execute:</p>
<pre class="line-numbers language-C" data-language="C"><code class="language-C">uint8_t y &#x3D; array2[array1[100]];<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>Suppose the value of array1[100] is 38, then <code>y = array2[38]</code>, so <code>array2[38]</code> will be placed in the CPU cache, improving the efficiency of subsequent loading.</p>
<p>Then, when actually executing the if condition, it is found that the condition is not met, so the result obtained is discarded, and nothing happens, and the function is executed. </p>
<p>Then, according to the timing attack mentioned above, we read each element of array2 and calculate the time, and find that the reading time of <code>array2[38]</code> is the shortest. </p>
<p>At this point, we know one thing:</p>
<blockquote>
<p>The content of array1[100] is 38.</p>
</blockquote>
<p>You may ask, “What can you do with this?” There are many things you can do. The length of array1 is only 16, so the value I read is not the thing in array1 itself, but the memory of other parts, which is the place I should not access. And as long as I keep copying this pattern, I can read all the data from other places. </p>
<p>If this attack is placed on a browser, I can read data from other websites in the same process. In other words, if there is content from other websites in the same process, I can read that content! </p>
<p>This is the Spectre attack, which uses some mechanisms of the CPU to perform side-channel attacks and read data that should not be read, causing security issues. </p>
<p>So, to put it simply, in a browser, Spectre can give you the opportunity to read data from other websites. </p>
<p>This is the explanation of Spectre. The above simplifies many details, and I do not fully understand those details. If you want to know more, you can refer to the following:</p>
<ol>
<li><a target="_blank" rel="noopener" href="https://googleprojectzero.blogspot.com/2018/01/reading-privileged-memory-with-side.html">Reading privileged memory with a side-channel</a></li>
<li><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/32757727">解读 Meltdown &amp; Spectre CPU 漏洞</a></li>
<li><a target="_blank" rel="noopener" href="https://yangrz.github.io/blog/2018/01/09/cpu/">浅谈处理器级Spectre Attack及Poc分析</a></li>
<li><a target="_blank" rel="noopener" href="https://www.ptt.cc/bbs/NetSecurity/M.1515146856.A.750.html">[閒聊] Spectre &amp; Meltdown漏洞概論(翻譯)</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/hdzitao/spectre-attack-zh">Spectre漏洞示例代码注释</a></li>
<li><a target="_blank" rel="noopener" href="https://developers.google.com/web/updates/2018/02/meltdown-spectre">Google update: Meltdown&#x2F;Spectre</a></li>
<li><a target="_blank" rel="noopener" href="https://security.googleblog.com/2018/07/mitigating-spectre-with-site-isolation.html">Mitigating Spectre with Site Isolation in Chrome</a></li>
</ol>
<p>All those COXX things have the same purpose, which is to prevent a website from being able to read data from other websites. As long as the malicious website and the target website are not in the same process, this type of attack will fail. </p>
<p>From this perspective, let’s take a look at various related mechanisms. </p>
<h2><span id="corb-cross-origin-read-blocking">CORB (Cross-Origin Read Blocking)</span></h2><p>A month after Google publicly announced the Spectre attack, in February 2018, they published a blog post explaining what Chrome did to prevent this type of attack: <a target="_blank" rel="noopener" href="https://developers.google.com/web/updates/2018/02/meltdown-spectre">Meltdown&#x2F;Spectre</a>.</p>
<p>The Cross-Site Document Blocking mentioned in the article is the predecessor of CORB. According to the Chrome Platform Status, it was officially enabled by default in Chrome for desktop release 67, which was around May 2018. At that time, it was also merged into the fetch spec and became part of the specification (CORB: blocking of nosniff and 206 responses).</p>
<p>As mentioned earlier, Spectre can read data under the same process, so one way to defend against it is not to let data from other websites appear under the same process.</p>
<p>A website has many ways to bring in cross-origin resources, such as fetch or xhr, but these two have been controlled by CORS, and the response obtained should be stored in the network-related process rather than the website’s own process, so even with Spectre, it cannot be read.</p>
<p>However, using tags such as <code>&lt;img&gt;</code> or <code>&lt;script&gt;</code> can easily load resources from other websites. For example: <code>&lt;img src=&quot;https://bank.com/secret.json&quot;&gt;</code>, assuming that <code>secret.json</code> is confidential data, we can “load” this confidential data.</p>
<p>You may wonder, “What’s the point of doing this? It’s not an image, and I can’t even read it with JS.” That’s right, this is not an image, but in terms of Chrome’s operation mechanism, Chrome does not know that it is not an image before downloading it (it may have a file extension of .json but is actually an image), so it will download it first. After downloading, it will put the result into the render process. At this time, it will know that this is not an image and then trigger a loading error.</p>
<p>It seems that there is no problem, but don’t forget that Spectre has opened a new window, which is “I have the opportunity to read data in the same process.” Therefore, just “putting the result into the render process” is not enough, because through Spectre attacks, attackers can still get data stored in memory.</p>
<p>Therefore, the purpose of the CORB mechanism is:</p>
<blockquote>
<p>If the data type you want to read is completely unreasonable, then I don’t need to put the result into the render process at all, I can just discard it!</p>
</blockquote>
<p>Continuing with the example above, if the MIME type of that json file is application&#x2F;json, it means that it cannot be an image at all, so it cannot be placed in the img tag. This is what I mean by “the data type you want to read is completely unreasonable.”</p>
<p>CORB mainly protects three types of data: HTML, XML, and JSON. How does the browser know that it is one of these three types? Why not judge from the content type in the response header?</p>
<p>Unfortunately, it is not possible. The reason is that the content type of many websites is set incorrectly. It may be a JavaScript file but set as <code>text/html</code>, which will be blocked by CORB and the website will break.</p>
<p>Therefore, Chrome will detect (sniffing) the file type based on the content and then decide whether to apply CORB.</p>
<p>But this may also cause misjudgments, so if the content type provided by your server is confirmed to be correct, you can pass a response header <code>X-Content-Type-Options: nosniff</code>, and Chrome will directly use the content type you provided instead of detecting it by itself.</p>
<p>In summary, CORB is a mechanism that is already enabled by default in Chrome, which automatically blocks unreasonable cross-origin resource loading, such as using <code>&lt;img&gt;</code> to load json or using <code>&lt;script&gt;</code> to load HTML, etc. In addition to Chrome, Safari and Firefox have not yet implemented this mechanism.</p>
<p>For more detailed explanations, please refer to:</p>
<ol>
<li>Cross-Origin Read Blocking for Web Developers</li>
<li>Cross-Origin Read Blocking (CORB)</li>
</ol>
<h2><span id="corp-cross-origin-resource-policy">CORP (Cross-Origin Resource Policy)</span></h2><p>CORB is a built-in mechanism in browsers that automatically protects HTML, XML, and JSON from being loaded into a cross-origin render process, preventing Spectre attacks. But what about other resources? If other types of resources, such as some photos and videos, are also confidential data, can I protect them?</p>
<p>This is where the CORP HTTP response header comes in. CORP, formerly known as From-Origin, is described in <a target="_blank" rel="noopener" href="https://github.com/whatwg/fetch/issues/687">Cross-Origin-Resource-Policy (was: From-Origin) #687</a>:</p>
<blockquote>
<p>Cross-Origin Read Blocking (CORB) automatically protects against Spectre attacks that load cross-origin, cross-type HTML, XML, and JSON resources, and is based on the browser’s ability to distinguish resource types. We think CORB is a good idea. From-Origin would offer servers an opt-in protection beyond CORB.</p>
</blockquote>
<p>If you know which resources to protect, you can use the CORP header to specify which sources can load these resources. There are three types of CORP content:</p>
<ol>
<li>Cross-Origin-Resource-Policy: <code>same-site</code></li>
<li>Cross-Origin-Resource-Policy: <code>same-origin</code></li>
<li>Cross-Origin-Resource-Policy: <code>cross-origin</code></li>
</ol>
<p>The third type is similar to not setting it (but there is still a difference, which will be explained later), meaning that all cross-origin sources can load resources. Let’s see what happens after setting this up!</p>
<p>First, we use express to start a simple server, add the CORP header, and put a picture with the URL <code>http://b.example.com/logo.jpg</code>:</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  res<span class="token punctuation">.</span><span class="token function">header</span><span class="token punctuation">(</span><span class="token string">'Cross-Origin-Resource-Policy'</span><span class="token punctuation">,</span> <span class="token string">'same-origin'</span><span class="token punctuation">)</span>
  <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>express<span class="token punctuation">.</span><span class="token function">static</span><span class="token punctuation">(</span><span class="token string">'public'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>Then, we import this picture at <code>http://a.example.com</code>:</p>
<pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://b.example.com/logo.jpg<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>After refreshing and opening the console, you will see an error message that the picture cannot be loaded, and opening the network tab will explain the reason in detail:</p>
<p><img src="/img/cors/part5/corp-fail.png"></p>
<p>If the header is changed to <code>same-site</code> or <code>cross-origin</code>, the picture can be loaded correctly.</p>
<p>So this header is actually the “CORS for resources”. The original CORS is more like a protocol for accessing APIs or “data” between sources, requiring permission for cross-origin access to data. For resource loading, such as using <code>&lt;img&gt;</code> or <code>&lt;script&gt;</code>, if you want to prevent cross-origin loading, you should only judge the <code>Origin</code> or <code>Referer</code> values on the server side and dynamically determine whether to return data.</p>
<p>After the appearance of the CORP header, it provides a way to prevent “any cross-origin loading” by simply setting a header. So this is not just a security consideration, security is just one point, the key is that you can prevent others from loading your resources.</p>
<p>As the <a target="_blank" rel="noopener" href="https://www.w3.org/TR/from-origin/">spec</a> of CORP’s predecessor From-Origin states:</p>
<blockquote>
<p>The Web platform has no limitations on embedding resources from different origins currently. E.g. an HTML document on <a target="_blank" rel="noopener" href="http://example.org/">http://example.org</a> can embed an image from <a target="_blank" rel="noopener" href="http://corp.invalid/">http://corp.invalid</a> without issue. This has led to a number of problems:</p>
</blockquote>
<p>For this type of embedded resource, the Web has no restrictions, and you can load whatever you want, which is convenient but also causes some problems, such as:</p>
<blockquote>
<p>Inline linking — the practice of embedding resources (e.g. images or fonts) from another server, causing the owner of that server to get a higher hosting bill.</p>
<p>Clickjacking — embedding a resource from another origin and attempting to let the visitor click on a concealed link thereof, causing harm to the visitor.</p>
</blockquote>
<p>For example, if I directly link to someone else’s image on my blog, the traffic will be on their server, and they will have to pay the bill. In addition, there may be Clickjacking issues.</p>
<blockquote>
<p>Privacy leakage - sometimes resource availability depends on whether a visitor is signed in to a particular website. E.g. only with a I’m-signed-in-cookie will an image be returned, and if there is no such cookie an HTML document. An HTML document embedding such a resource (requested with the user’s credentials) can figure out the existence of that resource and thus whether the visitor is signed in and therefore has an account with a particular service.</p>
</blockquote>
<p>I have seen a website before that can tell whether you are logged in to certain websites, but I can’t find the link now. How does it know? Because some resources may only be accessible when you are logged in. Suppose a certain image URL will only return the image correctly when logged in, and will return a server error if not logged in. Then I just need to write like this:</p>
<pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span>xxx</span> <span class="token special-attr"><span class="token attr-name">onerror</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token value javascript language-javascript"><span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">'not login'</span><span class="token punctuation">)</span></span><span class="token punctuation">"</span></span></span> <span class="token special-attr"><span class="token attr-name">onload</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token value javascript language-javascript"><span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">'login'</span><span class="token punctuation">)</span></span><span class="token punctuation">"</span></span></span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>By whether the image is loaded successfully, you can know whether you are logged in. However, after setting the SameSite cookie, this should not be a problem.</p>
<blockquote>
<p>License checking - certain font licenses require that the font be prevented from being embedded on other origins.</p>
</blockquote>
<p>Font websites will prevent users without a license from loading fonts, which is also suitable for this header.</p>
<p>In short, the CORB introduced earlier only “prevents unreasonable reading”, such as using img to load HTML, which is purely for security considerations.</p>
<p>But CORP can prevent any reading (except for iframe, which has no effect on iframe) and can protect your website’s resources from being loaded by others. It is a more powerful and widely used header.</p>
<p>Nowadays, mainstream browsers already support this header.</p>
<h2><span id="site-isolation">Site Isolation</span></h2><p>There are two ways to prevent Spectre attacks:</p>
<ol>
<li>Don’t give attackers a chance to execute Spectre attacks</li>
<li>Even if the attack is executed, the desired information cannot be obtained</li>
</ol>
<p>The principle of Spectre attack was mentioned earlier. By knowing which data is placed in the cache by reading the time difference, data can be “stolen” from memory. If the timer provided on the browser intentionally is not accurate, can’t it be defended? Because the seconds calculated by the attacker will be similar, and they don’t know which reading is faster.</p>
<p>After the Spectre attack appeared, the browser did two things:</p>
<ol>
<li>Reduce the accuracy of <code>performance.now</code></li>
<li>Disable <code>SharedArrayBuffer</code></li>
</ol>
<p>The first point is easy to understand. By reducing the accuracy of the time function, attackers cannot determine the correct reading speed. Why is the second point?</p>
<p>Let’s talk about <code>SharedArrayBuffer</code> first. This thing allows the JS of your document and web worker to share the same memory and share data. So in the web worker, you can make a counter that keeps adding up, and then read this counter in JS to achieve the function of a timer.</p>
<p>So after Spectre appeared, the browser made these two adjustments, starting from the perspective of “preventing the source of the attack”, which is the first way.</p>
<p>The other way is not to let malicious websites get information from cross-origin websites, which is the CORB mentioned earlier, and now to introduce: Site Isolation.</p>
<p>Here is an introduction from <a target="_blank" rel="noopener" href="https://developers.google.com/web/updates/2018/07/site-isolation">Site Isolation for web developers</a>:</p>
<blockquote>
<p>Site Isolation is a security feature in Chrome that offers an additional line of defense to make such attacks less likely to succeed. It ensures that pages from different websites are always put into different processes, each running in a sandbox that limits what the process is allowed to do. It also blocks the process from receiving certain types of sensitive data from other sites.</p>
</blockquote>
<p>In short, Site Isolation ensures that resources from different websites are placed in different processes. Therefore, even if you execute a Spectre attack on your own website, it doesn’t matter because you cannot read data from other websites.</p>
<p>Site Isolation is currently enabled by default in Chrome, and the corresponding disadvantage is that more memory is used because more processes are opened. Other impacts can be found in the article mentioned above.</p>
<p>In addition to Site Isolation, there is another thing that is easy to confuse (I originally thought they were the same when writing this article, but later found out that they are different), called “cross-origin isolated state.”</p>
<p>What is the difference between these two? According to my understanding (not guaranteed to be completely correct), the article “Mitigating Spectre with Site Isolation in Chrome” mentions:</p>
<blockquote>
<p>Note that Chrome uses a specific definition of “site” that includes just the scheme and registered domain. Thus, <a target="_blank" rel="noopener" href="https://google.co.uk/">https://google.co.uk</a> would be a site, and subdomains like <a target="_blank" rel="noopener" href="https://maps.google.co.uk/">https://maps.google.co.uk</a> would stay in the same process.</p>
</blockquote>
<p>The definition of “Site” in Site Isolation is the same as that of the same site. <code>http://a.example.com</code> and <code>http://b.example.com</code> are the same site, so even under Site Isolation, these two web pages will still be placed in the same process.</p>
<p>Cross-origin isolated state should be a stronger isolation, isolating everything that is not the same origin, even if it is the same site. Therefore, <code>http://a.example.com</code> and <code>http://b.example.com</code> will be isolated. Moreover, the object of Site Isolation is the process, while cross-origin isolated state seems to isolate the browsing context group, not allowing cross-origin things to be in the same browsing context group.</p>
<p>This cross-origin isolated state is not enabled by default, and you must set these two headers on your webpage to enable it:</p>
<ol>
<li>Cross-Origin-Embedder-Policy: require-corp</li>
<li>Cross-Origin-Opener-Policy: same-origin</li>
</ol>
<p>As for why these two are used, I will tell you later.</p>
<h2><span id="coep-cross-origin-embedder-policy">COEP (Cross-Origin-Embedder-Policy)</span></h2><p>To achieve cross-origin isolated state, you must ensure that all cross-origin access on your website is legal and authorized.</p>
<p>The COEP (Cross-Origin-Embedder-Policy) header has two values:</p>
<ol>
<li>unsafe-none</li>
<li>require-corp</li>
</ol>
<p>The first is the default value, which means there are no restrictions, and the second is related to CORP (Cross-Origin-Resource-Policy) mentioned earlier. If you use require-corp, it means telling the browser that “all resources I load on the page must have the existence of CORP (or CORS), and they must be legal.”</p>
<p>Now, suppose we have a website <code>a.example.com</code> and we want to make it a cross-origin isolated state, so we add a header to it: <code>Cross-Origin-Embedder-Policy: require-corp</code>, and then introduce a resource in the webpage:</p>
<pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://b.example.com/logo.jpg<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>Then we send the correct header on the b side:</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  res<span class="token punctuation">.</span><span class="token function">header</span><span class="token punctuation">(</span><span class="token string">'Cross-Origin-Resource-Policy'</span><span class="token punctuation">,</span> <span class="token string">'cross-origin'</span><span class="token punctuation">)</span>
  <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>This completes the first step.</p>
<p>In addition, I mentioned earlier that there is a slight difference between not setting CORP and setting it to <code>cross-origin</code>, which is the difference here. If b does not send this header in the above example, the Embedder Policy will not pass.</p>
<h2><span id="coop-cross-origin-opener-policy">COOP (Cross-Origin-Opener-Policy)</span></h2><p>The second step is the COOP (Cross-Origin-Opener-Policy) header. As I mentioned earlier, when you use <code>window.open</code> to open a webpage, you can manipulate the location of that webpage, and the opened webpage can also manipulate your webpage using <code>window.opener</code>. This creates a connection between the windows, which violates cross-origin isolation. Therefore, the COOP header is used to regulate the relationship between windows and openers, and there are three values:</p>
<ol>
<li>Cross-Origin-Opener-Policy: <code>unsafe-none</code></li>
<li>Cross-Origin-Opener-Policy: <code>same-origin</code></li>
<li>Cross-Origin-Opener-Policy: <code>same-origin-allow-popups</code></li>
</ol>
<p>The first one is the default value and has no effect. The second one is the strictest. If you set it to <code>same-origin</code>, the “window you opened” must also have this header and must also be set to <code>same-origin</code> so that you can share the window between them.</p>
<p>Let’s do an experiment. We have two webpages:</p>
<ol>
<li><a target="_blank" rel="noopener" href="http://localhost:5566/page1.html">http://localhost:5566/page1.html</a></li>
<li><a target="_blank" rel="noopener" href="http://localhost:5566/page2.html">http://localhost:5566/page2.html</a></li>
</ol>
<p>The content of page1.html is as follows:</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token operator">&lt;</span>script<span class="token operator">></span>
  <span class="token keyword">var</span> win <span class="token operator">=</span> window<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token string">'http://localhost:5566/page2.html'</span><span class="token punctuation">)</span>
  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>win<span class="token punctuation">.</span>secret<span class="token punctuation">)</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token number">2000</span><span class="token punctuation">)</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>The content of page2.html is as follows:</p>
<pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">></span></span><span class="token script"><span class="token language-javascript">
  window<span class="token punctuation">.</span>secret <span class="token operator">=</span> <span class="token number">5566</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>If page1 successfully outputs 5566, it means that the two windows are shared. Otherwise, they are not.</p>
<p>Let’s try without any header first. Since these two are the same origin, they can already share windows, and 5566 is successfully output.</p>
<p>Next, we change the server-side code to this:</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>req<span class="token punctuation">.</span>url <span class="token operator">===</span> <span class="token string">'/page1.html'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    res<span class="token punctuation">.</span><span class="token function">header</span><span class="token punctuation">(</span><span class="token string">'Cross-Origin-Opener-Policy'</span><span class="token punctuation">,</span> <span class="token string">'same-origin'</span><span class="token punctuation">)</span>
  <span class="token punctuation">&#125;</span>
  <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>Only <code>page1.html</code> has COOP, and <code>page2.html</code> does not. The result of the experiment is “cannot share”. Even if it is changed to this:</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>req<span class="token punctuation">.</span>url <span class="token operator">===</span> <span class="token string">'/page1.html'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    res<span class="token punctuation">.</span><span class="token function">header</span><span class="token punctuation">(</span><span class="token string">'Cross-Origin-Opener-Policy'</span><span class="token punctuation">,</span> <span class="token string">'same-origin'</span><span class="token punctuation">)</span>
  <span class="token punctuation">&#125;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>req<span class="token punctuation">.</span>url <span class="token operator">===</span> <span class="token string">'/page2.html'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    res<span class="token punctuation">.</span><span class="token function">header</span><span class="token punctuation">(</span><span class="token string">'Cross-Origin-Opener-Policy'</span><span class="token punctuation">,</span> <span class="token string">'same-origin-allow-popups'</span><span class="token punctuation">)</span>
  <span class="token punctuation">&#125;</span>
  <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>It is still impossible to share because the <code>same-origin</code> condition is:</p>
<ol>
<li>The opened window must be in the same origin.</li>
<li>The response header of the opened window must have COOP, and the value must be <code>same-origin</code>.</li>
</ol>
<p>Only when these two points are met can you successfully access the complete window. And one thing to note is that once this header is set but the rules are not met, not only can you not access the complete window, but you cannot even get <code>openedWindow.close</code> and <code>window.opener</code>. The two windows are completely unrelated.</p>
<p>The conditions for <code>same-origin-allow-popups</code> are more relaxed:</p>
<ol>
<li>The opened window must be in the same origin.</li>
<li>The opened window does not have COOP, or the value of COOP is not <code>same-origin</code>.</li>
</ol>
<p>In short, <code>same-origin</code> not only protects others but also protects yourself. When you set it to this value, whether you open someone else’s or are opened by someone else, you must be in the same origin and have the same header to access each other’s windows.</p>
<p>For example, I adjusted it to this:</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>req<span class="token punctuation">.</span>url <span class="token operator">===</span> <span class="token string">'/page1.html'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    res<span class="token punctuation">.</span><span class="token function">header</span><span class="token punctuation">(</span><span class="token string">'Cross-Origin-Opener-Policy'</span><span class="token punctuation">,</span> <span class="token string">'same-origin-allow-popups'</span><span class="token punctuation">)</span>
  <span class="token punctuation">&#125;</span>
  <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>Only page1 has set <code>same-origin-allow-popups</code>, and page2 has not set anything. In this case, they can access each other’s windows.</p>
<p>Next, if they are the same:</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>req<span class="token punctuation">.</span>url <span class="token operator">===</span> <span class="token string">'/page1.html'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    res<span class="token punctuation">.</span><span class="token function">header</span><span class="token punctuation">(</span><span class="token string">'Cross-Origin-Opener-Policy'</span><span class="token punctuation">,</span> <span class="token string">'same-origin-allow-popups'</span><span class="token punctuation">)</span>
  <span class="token punctuation">&#125;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>req<span class="token punctuation">.</span>url <span class="token operator">===</span> <span class="token string">'/page2.html'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    res<span class="token punctuation">.</span><span class="token function">header</span><span class="token punctuation">(</span><span class="token string">'Cross-Origin-Opener-Policy'</span><span class="token punctuation">,</span> <span class="token string">'same-origin-allow-popups'</span><span class="token punctuation">)</span>
  <span class="token punctuation">&#125;</span>
  <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>This is also fine.</p>
<p>But what if it’s like this?</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>req<span class="token punctuation">.</span>url <span class="token operator">===</span> <span class="token string">'/page1.html'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    res<span class="token punctuation">.</span><span class="token function">header</span><span class="token punctuation">(</span><span class="token string">'Cross-Origin-Opener-Policy'</span><span class="token punctuation">,</span> <span class="token string">'same-origin-allow-popups'</span><span class="token punctuation">)</span>
  <span class="token punctuation">&#125;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>req<span class="token punctuation">.</span>url <span class="token operator">===</span> <span class="token string">'/page2.html'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    res<span class="token punctuation">.</span><span class="token function">header</span><span class="token punctuation">(</span><span class="token string">'Cross-Origin-Opener-Policy'</span><span class="token punctuation">,</span> <span class="token string">'same-origin'</span><span class="token punctuation">)</span>
  <span class="token punctuation">&#125;</span>
  <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>This won’t work.</p>
<p>So to summarize, suppose there is a webpage A that opens a webpage B using <code>window.open</code>:</p>
<ol>
<li>If AB is cross-origin, the browser has restrictions and can only access methods such as <code>window.location</code> or <code>window.close</code>. It cannot access the DOM or other things.</li>
<li>If AB is same-origin, they can access almost the entire window, including the DOM.</li>
<li>If A adds a COOP header and the value is <code>same-origin</code>, it means that more restrictions have been imposed on the second case, and only when B also has this header and the value is also <code>same-origin</code> can they access each other’s windows.</li>
<li>If A adds a COOP header and the value is <code>same-origin-allow-popups</code>, it is also a restriction on the second case, but it is more relaxed. As long as the COOP header of B is not <code>same-origin</code>, they can access each other’s windows.</li>
</ol>
<p>In short, to “have the opportunity to access the window mutually”, it must first be same-origin, which is unchangeable. In fact, whether it can be accessed or not depends on whether the COOP header and the value of the header are set. If the COOP header is set but does not comply with the rules, <code>window.opener</code> will become null directly, and you cannot even get the location (if the rules are not set, you can get it even if it is cross-origin).</p>
<p>In fact, according to the <a target="_blank" rel="noopener" href="https://html.spec.whatwg.org/multipage/origin.html#cross-origin-opener-policies">spec</a>, there is also a fourth type: same-origin-plus-COEP, but it seems more complicated, so let’s not study it for now.</p>
<h2><span id="back-to-cross-origin-isolated-state">Back to cross-origin isolated state</span></h2><p>As mentioned earlier, cross-origin isolated state requires setting these two headers:</p>
<ol>
<li>Cross-Origin-Embedder-Policy: require-corp</li>
<li>Cross-Origin-Opener-Policy: same-origin</li>
</ol>
<p>Why? Because once set, it means that all cross-origin resources on the page are accessible to you, and if you do not have permission, an error will occur. So if it is set and passed, it means that all cross-origin resources are allowed to be accessed by you, and there will be no security issues.</p>
<p>On the website, you can use:</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">self<span class="token punctuation">.</span>crossOriginIsolated<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>to determine if you have entered the cross-origin isolated state. If so, you can use some sealed (?) functions because the browser knows you are very safe.</p>
<p>In addition, if you enter this state, the trick of bypassing the same-origin policy by modifying <code>document.domain</code> mentioned earlier will not work, and the browser will not let you modify this thing.</p>
<p>To learn more about COOP, COEP, and cross-origin isolated state, please refer to:</p>
<ol>
<li><a target="_blank" rel="noopener" href="https://web.dev/coop-coep/">Making your website “cross-origin isolated” using COOP and COEP</a></li>
<li><a target="_blank" rel="noopener" href="https://web.dev/why-coop-coep/">Why you need “cross-origin isolated” for powerful features</a></li>
<li><a target="_blank" rel="noopener" href="https://scotthelme.co.uk/coop-and-coep/">COEP COOP CORP CORS CORB - CRAP that’s a lot of new stuff!</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/whatwg/html/issues/4175">Making postMessage() work for SharedArrayBuffer (Cross-Origin-Embedder-Policy) #4175</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/whatwg/html/issues/3740">Restricting cross-origin WindowProxy access (Cross-Origin-Opener-Policy) #3740</a></li>
<li><a target="_blank" rel="noopener" href="https://www.chromestatus.com/feature/4647328103268352">Feature: Cross-Origin Resource Policy</a></li>
</ol>
<h2><span id="summary">Summary</span></h2><p>This article actually talks about a lot of things, all revolving around security. At the beginning, we talked about the consequences of incorrect CORS settings and defense methods, followed by using <code>document.cookie</code> to modify same-site to same-origin (both websites must agree to do so), and finally the highlight of this article:</p>
<ol>
<li>CORB (Cross-Origin Read Blocking)</li>
<li>CORP (Cross-Origin Resource Policy)</li>
<li>COEP (Cross-Origin-Embedder-Policy)</li>
<li>COOP (Cross-Origin-Opener-Policy)</li>
</ol>
<p>It took a lot of time to find information because the names are too similar and some of the functions are actually quite similar, but after looking at them for a long time, you will find that they are quite different, and each policy focuses on different things. I hope that the context I have organized will help you better understand these things.</p>
<p>If you want to summarize these four things in one sentence, it may be:</p>
<ol>
<li>CORB: the default mechanism of the browser, mainly to prevent loading unreasonable resources, such as using img to load HTML</li>
<li>CORP: an HTTP response header that determines who can load this resource, and can prevent cross-origin loading of images, videos, or any resources</li>
<li>COEP: an HTTP response header that ensures that all resources on the page are legally loaded</li>
<li>COOP: an HTTP response header that adds stricter window sharing settings to same-origin</li>
</ol>
<p>Compared to the others, I am not as familiar with the content of this article. If there are any mistakes, please don’t hesitate to point them out. Thank you.</p>
<p>Next, the next article will be the last one in this series: <a href="/2021/02/19/cors-guide-6">CORS Complete Guide (Part 6): Summary, Afterword, and Leftovers</a></p>

    
    </div>
    
    <div class="columns is-variable is-1 is-multiline is-mobile">
    
        <span class="column is-narrow"><a class="tag is-light article-tag" href="/en/tags/Front-end/">#Front-end</a></span>
    
        <span class="column is-narrow"><a class="tag is-light article-tag" href="/en/tags/Ajax/">#Ajax</a></span>
    
        <span class="column is-narrow"><a class="tag is-light article-tag" href="/en/tags/JavaScript/">#JavaScript</a></span>
    
        <span class="column is-narrow"><a class="tag is-light article-tag" href="/en/tags/CORS/">#CORS</a></span>
    
    </div>
    
    
    <div class="columns is-mobile is-multiline article-nav">
        <span class="column is-12-mobile is-half-desktop  article-nav-prev">
            
            <a href="/2021/02/19/en/cors-guide-6/">CORS Complete Guide (6): Summary, Afterword, and Leftovers</a>
            
        </span>
        <span class="column is-12-mobile is-half-desktop  article-nav-next">
            
            <a href="/2021/02/19/en/cors-guide-4/">CORS Complete Guide (Part 4): Understanding the Specification</a>
            
        </span>
    </div>
    
</article>




<div class="comments">
    <h3 class="title is-4">Comments</h3>
    <script src="https://utteranc.es/client.js"
        repo="aszx87410/huli-blog"
        issue-term="title"
        theme="github-light"
        crossorigin="anonymous"
        async>
</script>
</div>

    </div>
</section>
    <footer class="footer">
    <div class="container">
        <div class="columns content">
            <div class="column is-narrow has-text-centered">
                &copy; 2024 Huli&nbsp;
                Powered by <a href="http://hexo.io/" target="_blank">Hexo</a> & <a
                        target="_blank" rel="noopener" href="http://github.com/ppoffice/hexo-theme-minos">Minos</a>
            </div>
            <div class="column is-hidden-mobile"></div>

            
            <div class="column is-narrow">
                <div class="columns is-mobile is-multiline is-centered">
                
                    
                <a class="column is-narrow" title="GitHub" target="_blank" rel="noopener" href="https://github.com/ppoffice/hexo-theme-minos">
                    
                    GitHub
                    
                </a>
                
                </div>
            </div>
            
            
<div class="column is-narrow has-text-centered">
    <div class="dropdown is-up is-right is-hoverable" style="margin-top: -0.2em;">
        <div class="dropdown-trigger">
            <button class="button is-small" aria-haspopup="true">
                <span class="icon">
                    <i class="fas fa-globe"></i>
                </span>
                <span>English</span>
                <span class="icon is-small">
            <i class="fas fa-angle-down" aria-hidden="true"></i>
          </span>
            </button>
        </div>
        <div class="dropdown-menu has-text-left" role="menu" style="top:100%">
            <div class="dropdown-content">
            <!-- NOTE: 永遠回到首頁 -->
            
                <a href="/2021/02/19/cors-guide-5/" class="dropdown-item">
                    繁體中文
                </a>
            
            </div>
        </div>
    </div>
</div>

        </div>
    </div>
</footer>
    <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/3.6.3/jquery.min.js"></script>



    
    
    
    
    
    
<script src="//cdnjs.cloudflare.com/ajax/libs/lightgallery/1.6.8/js/lightgallery-all.min.js"></script>
<script>
    (function ($) {
        $(document).ready(function () {
            if (typeof($.fn.lightGallery) === 'function') {
                $('.article.gallery').lightGallery({ selector: '.gallery-item' });
            }
        });
    })(jQuery);
</script>

    
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.0/clipboard.min.js"></script>
    <style>
        .hljs {
            position: relative;
        }

        .hljs .clipboard-btn {
            float: right;
            color: #9a9a9a;
            background: none;
            border: none;
            cursor: pointer;
        }

        .hljs .clipboard-btn:hover {
          color: #8a8a8a;
        }

        .hljs > .clipboard-btn {
            display: none;
            position: absolute;
            right: 4px;
            top: 4px;
        }

        .hljs:hover > .clipboard-btn {
            display: inline;
        }

        .hljs > figcaption > .clipboard-btn {
            margin-right: 4px;
        }
    </style>
    <script>
      $(document).ready(function () {
        $('figure.hljs').each(function(i, figure) {
          var codeId = 'code-' + i;
          var code = figure.querySelector('.code');
          var copyButton = $('<button>Copy <i class="far fa-clipboard"></i></button>');
          code.id = codeId;
          copyButton.addClass('clipboard-btn');
          copyButton.attr('data-clipboard-target-id', codeId);

          var figcaption = figure.querySelector('figcaption');

          if (figcaption) {
            figcaption.append(copyButton[0]);
          } else {
            figure.prepend(copyButton[0]);
          }
        })

        var clipboard = new ClipboardJS('.clipboard-btn', {
          target: function(trigger) {
            return document.getElementById(trigger.getAttribute('data-clipboard-target-id'));
          }
        });
        clipboard.on('success', function(e) {
          e.clearSelection();
        })
      })
    </script>

    
    

    



<script src="/js/script.js?v=3.js"></script>


    
</body>
</html>