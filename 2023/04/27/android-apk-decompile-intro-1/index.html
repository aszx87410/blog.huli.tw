<!DOCTYPE html>
<html class="has-navbar-fixed-top" lang="zh-tw">
<head>
    <meta charset="utf-8">
<title>Android App 逆向入門之一：拆開與重組 apk - Huli&#39;s blog</title>
<meta name="viewport" content="width=device-width, initial-scale=1">


<link href="https://blog.huli.tw/2023/04/27/android-apk-decompile-intro-1/" rel="alternate" hreflang="zh-TW" />


<link href="https://blog.huli.tw/2023/04/27/android-apk-decompile-intro-1/" rel="alternate" hreflang="x-default" />


            
<link href="https://blog.huli.tw/2023/04/27/en/android-apk-decompile-intro-1/" rel="alternate" hreflang="en" />
            





    
<link rel="canonical" href="https://blog.huli.tw/2023/04/27/android-apk-decompile-intro-1/">
    





    <meta name="description" content="五年前我有寫過一篇：[Android] 人人都會的 apk 反編譯，那時我還是個寫 Android 的工程師，因為工作上的需求跟同事一起研究了基本的 Android 逆向工程，想達成的目標是全自動的流程，上傳一個 apk 以後自動把 apk 拆開來，塞一些奇怪的東西再裝回去。 而現在同樣是因為工作上的需求，再次回憶並補強了一下對於 apk 反編譯以及修改等等的相關知識，寫成這一系列的文章跟大家分享">
<meta property="og:type" content="article">
<meta property="og:title" content="Android App 逆向入門之一：拆開與重組 apk">
<meta property="og:url" content="https://blog.huli.tw/2023/04/27/android-apk-decompile-intro-1/index.html">
<meta property="og:site_name" content="Huli&#39;s blog">
<meta property="og:description" content="五年前我有寫過一篇：[Android] 人人都會的 apk 反編譯，那時我還是個寫 Android 的工程師，因為工作上的需求跟同事一起研究了基本的 Android 逆向工程，想達成的目標是全自動的流程，上傳一個 apk 以後自動把 apk 拆開來，塞一些奇怪的東西再裝回去。 而現在同樣是因為工作上的需求，再次回憶並補強了一下對於 apk 反編譯以及修改等等的相關知識，寫成這一系列的文章跟大家分享">
<meta property="og:locale" content="zh_TW">
<meta property="og:image" content="https://blog.huli.tw/img/android-apk-decompile-intro/cover1.png">
<meta property="article:published_time" content="2023-04-27T05:10:44.000Z">
<meta property="article:modified_time" content="2023-05-07T01:15:16.473Z">
<meta property="article:author" content="Huli">
<meta property="article:tag" content="Security">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://blog.huli.tw/img/android-apk-decompile-intro/cover1.png">



<link rel="alternative" href="/atom.xml" title="Android App 逆向入門之一：拆開與重組 apk" type="application/atom+xml">



<link rel="icon" href="/img/lidemy_logo.png">


<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Ovo|Source+Code+Pro">


<link rel="stylesheet" href="/css/bulma.css?v=2.css">



<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/lightgallery/1.6.8/css/lightgallery.min.css">


<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/line-numbers/prism-line-numbers.min.css" />


<link rel="stylesheet" href="/css/style.css?v=4.css">





    
    
    
    
    
    
    
    
    
    
<script async src="https://www.googletagmanager.com/gtag/js?id=G-1393J2EVCZ"></script>
<script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-1393J2EVCZ');
</script>


    


<meta name="generator" content="Hexo 6.3.0"></head>
<body>
    <script>
        if (localStorage.getItem('dark-mode')) {
            if (localStorage.getItem('dark-mode') === 'true') {
                document.body.classList.add('dark-mode')
            }
        } else {
            if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                document.body.classList.add('dark-mode')
            }
        }
    </script>
    
<nav class="navbar is-transparent is-fixed-top navbar-main" role="navigation" aria-label="main navigation">
    <div class="container">
        <div class="navbar-brand">
            <a class="navbar-item navbar-logo" href="/">
                
                    
                    Huli&#39;s blog
                    
                
            </a>
            <div class="navbar-burger">
                <span></span>
                <span></span>
                <span></span>
            </div>
        </div>
        
        <div class="navbar-menu navbar-start">
            
            <a class="navbar-item "
               href="/archives">文章列表</a>
            
            <a class="navbar-item "
               href="/categories">分類</a>
            
            <a class="navbar-item "
               href="/recommend">推薦閱讀</a>
            
            <a class="navbar-item "
               href="/about">關於我</a>
            
        </div>
        
        <div class="navbar-menu navbar-end">
            
            
            <div class="navbar-item is-hoverable has-dropdown is-hidden-mobile is-hidden-tablet-only toc">
                <a class="navbar-item" title="目錄">
                    目錄
                </a>
                <div class="navbar-dropdown">
                    
                    
                    
                    
                    <a class="navbar-item" href="#要逆向先從正向了解-android-app-開始">1&nbsp;&nbsp;<b>要逆向，先從正向了解 Android app 開始</b></a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#簡易-apk-拆解">2&nbsp;&nbsp;<b>簡易 apk 拆解</b></a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#利用-apktool-拆解-apk">3&nbsp;&nbsp;<b>利用 Apktool 拆解 apk</b></a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#重新打包-apk">4&nbsp;&nbsp;<b>重新打包 apk</b></a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#總結">5&nbsp;&nbsp;<b>總結</b></a>
                    
                </div>
            </div>
            
            
            <a class="navbar-item" target="_blank" title="Medium" href="https://hulitw.medium.com/">
                
                <i class="fab fa-medium"></i>
                
            </a>
               
            <a class="navbar-item" target="_blank" title="Facebook" href="https://www.facebook.com/huli.blog">
                
                <i class="fab fa-facebook"></i>
                
            </a>
               
            <a class="navbar-item" target="_blank" title="RSS" href="/atom-ch.xml">
                
                <i class="fas fa-rss"></i>
                
            </a>
               
            
            <a class="navbar-item btn-dark-mode" title="dark-mode" href="#">
                <div>
                    <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" width="15" height="15" viewBox="0 0 256 256" xml:space="preserve">
                    <defs>
                    </defs>
                    <g style="stroke: none; stroke-width: 0; stroke-dasharray: none; stroke-linecap: butt; stroke-linejoin: miter; stroke-miterlimit: 10; fill: none; fill-rule: nonzero; opacity: 1;" transform="translate(1.4065934065934016 1.4065934065934016) scale(2.81 2.81)" >
                        <path d="M 87.823 60.7 c -0.463 -0.423 -1.142 -0.506 -1.695 -0.214 c -15.834 8.398 -35.266 2.812 -44.232 -12.718 c -8.966 -15.53 -4.09 -35.149 11.101 -44.665 c 0.531 -0.332 0.796 -0.963 0.661 -1.574 c -0.134 -0.612 -0.638 -1.074 -1.259 -1.153 c -9.843 -1.265 -19.59 0.692 -28.193 5.66 C 13.8 12.041 6.356 21.743 3.246 33.35 S 1.732 57.08 7.741 67.487 c 6.008 10.407 15.709 17.851 27.316 20.961 C 38.933 89.486 42.866 90 46.774 90 c 7.795 0 15.489 -2.044 22.42 -6.046 c 8.601 -4.966 15.171 -12.43 18.997 -21.586 C 88.433 61.79 88.285 61.123 87.823 60.7 z" style="stroke: none; stroke-width: 1; stroke-dasharray: none; stroke-linecap: butt; stroke-linejoin: miter; stroke-miterlimit: 10; fill: #ffa716; fill-rule: nonzero; opacity: 1;" transform=" matrix(1 0 0 1 0 0) " stroke-linecap="round" />
                    </g>
                    </svg>
                </div>
            </a>
            
                <a class="navbar-item" href="/2023/04/27/en/android-apk-decompile-intro-1/">English</a>
            
            

        </div>
    </div>
</nav>

    <section class="section">
    <div class="container">
      
      <div data-nosnippet class="self-notice">
        最近開了一個讀者回饋表單，無論是對文章的感想或是對部落格的感想，有什麼想回饋的都可以填表單跟我說：<a href="https://forms.gle/XuWyRC5qtSd2ANta8" target="_blank">表單連結</a>
      </div>
      
    <article class="article content gallery" itemscope itemprop="blogPost">
    <h1 class="article-title is-size-3 is-size-4-mobile" itemprop="name">
        
            Android App 逆向入門之一：拆開與重組 apk
        
    </h1>
    <div class="article-meta columns is-variable is-1 is-multiline is-mobile is-size-7-mobile">
        <span class="column is-narrow">
            <time datetime="2023-04-27T05:10:44.000Z" itemprop="datePublished">2023年4月27日</time>
        </span>
        
        <span class="column is-narrow article-category">
            <i class="far fa-folder"></i>
            <a class="article-category-link" href="/categories/Security/">Security</a>
        </span>
        
        
        
    </div>
    
    <div class="article-entry is-size-6-mobile" itemprop="articleBody">
    
        <p>五年前我有寫過一篇：<a href="https://blog.huli.tw/2016/03/20/android-apk-decompile/">[Android] 人人都會的 apk 反編譯</a>，那時我還是個寫 Android 的工程師，因為工作上的需求跟同事一起研究了基本的 Android 逆向工程，想達成的目標是全自動的流程，上傳一個 apk 以後自動把 apk 拆開來，塞一些奇怪的東西再裝回去。</p>
<p>而現在同樣是因為工作上的需求，再次回憶並補強了一下對於 apk 反編譯以及修改等等的相關知識，寫成這一系列的文章跟大家分享。</p>
<p>先說在前面，這一系列都只是「入門」而已，利用各種工具把 apk 拆開來再裝回去，對於沒有加殼的 app 應該夠用了，但如果有加殼過的話，需要再更深一點的 binary 相關知識才能夠解開，那又是另一個世界了。</p>
<p>總之呢，這個系列適合沒有接觸過 Android App 逆向，想要玩玩看的人，也適合 Android 工程師，可以把自己寫的 app 拆開來，看看是什麼樣子，我覺得也滿有用的。</p>
<span id="more"></span>

<p>系列文連結：</p>
<ol>
<li><a href="/2023/04/27/android-apk-decompile-intro-1/">Android App 逆向入門之一：拆開與重組 apk</a></li>
<li><a href="/2023/04/27/android-apk-decompile-intro-2/">Android App 逆向入門之二：修改 smali 程式碼</a></li>
<li><a href="/2023/04/27/android-apk-decompile-intro-3/">Android App 逆向入門之三：監聽 app 封包</a></li>
<li><a href="/2023/04/27/android-apk-decompile-intro-4/">Android App 逆向入門之四：使用 Frida 進行動態分析</a></li>
</ol>
<h2><span id="要逆向先從正向了解-android-app-開始">要逆向，先從正向了解 Android app 開始</span></h2><p>我認為想要逆向 Android app 的話，先大致了解一下 app 到底是怎麼寫出來的會滿有幫助的，至少在把 app 拆開來以後可以快速地知道各個部分大概在幹嘛。</p>
<p>所以我很推薦大家隨便找個 Android app 的教學，跟著教學把 Android Studio 裝起來，然後寫一個非常簡單的 app 並且跑起來，甚至打包成 apk 檔案，都會加強對於整個流程的理解。</p>
<p>接下來我就帶大家簡單看看一個 app 是怎麼寫成的。</p>
<p>首先呢，一個 app 大概是由三個元件所組成的：</p>
<ol>
<li>AndroidManifest.xml，可以想成是 app 的設定檔，寫著各種 app 相關資訊</li>
<li>resources，各種資源，包括排版、程式中出現的字串、圖片等等所有資訊</li>
<li>程式碼</li>
</ol>
<p>底下是一個簡單的專案截圖，左邊是檔案結構，右邊是 <code>AndroidManifest.xml</code> 的內容：</p>
<p><img src="/img/android-apk-decompile-intro/p1-manifest.png"></p>
<p>為了怕圖片不太清楚，底下是 xml 的內容：</p>
<pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token prolog">&lt;?xml version="1.0" encoding="utf-8"?></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>manifest</span> <span class="token attr-name"><span class="token namespace">xmlns:</span>android</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://schemas.android.com/apk/res/android<span class="token punctuation">"</span></span>
    <span class="token attr-name">package</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>com.example.myapplication<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>application</span>
        <span class="token attr-name"><span class="token namespace">android:</span>allowBackup</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>true<span class="token punctuation">"</span></span>
        <span class="token attr-name"><span class="token namespace">android:</span>icon</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>@mipmap/ic_launcher<span class="token punctuation">"</span></span>
        <span class="token attr-name"><span class="token namespace">android:</span>label</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>@string/app_name<span class="token punctuation">"</span></span>
        <span class="token attr-name"><span class="token namespace">android:</span>roundIcon</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>@mipmap/ic_launcher_round<span class="token punctuation">"</span></span>
        <span class="token attr-name"><span class="token namespace">android:</span>supportsRtl</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>true<span class="token punctuation">"</span></span>
        <span class="token attr-name"><span class="token namespace">android:</span>theme</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>@style/AppTheme<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>activity</span>
            <span class="token attr-name"><span class="token namespace">android:</span>name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>.MainActivity<span class="token punctuation">"</span></span>
            <span class="token attr-name"><span class="token namespace">android:</span>label</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>@string/app_name<span class="token punctuation">"</span></span>
            <span class="token attr-name"><span class="token namespace">android:</span>theme</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>@style/AppTheme.NoActionBar<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>intent-filter</span><span class="token punctuation">></span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>action</span> <span class="token attr-name"><span class="token namespace">android:</span>name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>android.intent.action.MAIN<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>

                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>category</span> <span class="token attr-name"><span class="token namespace">android:</span>name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>android.intent.category.LAUNCHER<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>intent-filter</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>activity</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>application</span><span class="token punctuation">></span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>manifest</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>從這個檔案中我們可以知道幾件事情，包括：</p>
<ol>
<li>這個 app 的 package name 是 <code>com.example.myapplication</code></li>
<li>這個 app 有一個 activity，名稱是 <code>MainActivity</code>，是主要的 activity</li>
</ol>
<p>每一個 app 都會有一個 unique 的 package name，可以想成就是這個 app 的 id，會寫在 AndroidManifest 裡面，而這也會跟你程式碼的檔案結構有關，有寫過 Java 的都會知道。</p>
<p>如果你去網頁版的 Google Play，就會發現網址上寫著的就是 package name，舉例來說 Facebook 的頁面網址長這樣：<a target="_blank" rel="noopener" href="https://play.google.com/store/apps/details?id=com.facebook.katana&hl=zh_TW&gl=US">https://play.google.com/store/apps/details?id=com.facebook.katana&amp;hl=zh_TW&amp;gl=US</a></p>
<p>因此 <code>com.facebook.katana</code> 就是 Facebook app 的 package name。</p>
<p>再來我們看第二點，什麼又是 activity 呢？</p>
<p>你可以把 activity 想成是一個「畫面」，每一個畫面就是一個 activity，所以假設現在是個需要註冊才能使用的 app，很可能會有底下這些畫面：</p>
<ol>
<li>歡迎頁面</li>
<li>註冊頁面</li>
<li>登入頁面</li>
<li>主頁面（登入成功後顯示）</li>
</ol>
<p>而這每一個頁面都是一個 activity，而每一個 activity 可能都有一個 layout，在 Android 開發中，layout 其實就是一個 xml 檔案，會像是這樣：</p>
<p><img src="/img/android-apk-decompile-intro/p2-layout.png"></p>
<p>右邊是你看到的樣子，左邊則是 layout 的 xml 檔案，這就有點像是網頁前端中畫面跟 HTML+CSS 的關係一樣，只是在 Android 開發中是用 xml 來產生畫面，而不是用 HTML+CSS。</p>
<p>像 layout 就屬於資源的一種，會被放在 <code>res</code> 資料夾裡面。</p>
<p>而上面的 layout 檔案，還有兩個值得注意的地方。</p>
<p>第一個是 <code>android:id=&quot;@+id/textview_first&quot;</code>，代表這個 component 對應到一個 id，為什麼要對應到 id 呢？因為這樣我們才能在程式碼裡面存取到這個 component，像這樣：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">TextView</span> tv <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">TextView</span><span class="token punctuation">)</span> <span class="token function">findViewById</span><span class="token punctuation">(</span><span class="token class-name">R</span><span class="token punctuation">.</span>id<span class="token punctuation">.</span>textview_first<span class="token punctuation">)</span><span class="token punctuation">;</span>
tv<span class="token punctuation">.</span><span class="token function">setText</span><span class="token punctuation">(</span><span class="token string">"hello"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>我們要先利用 id 找到這個 component，才能改變它的文字。</p>
<p>第二個值得注意的地方是 <code>android:text=&quot;@string/hello_first_fragment&quot;</code>，這其實就是元件會顯示的文字，假設我寫：<code>android:text=&quot;hello&quot;</code>，畫面上就會顯示 hello。</p>
<p>那為什麼上面的內容是 <code>@string/hello_first_fragment</code> 呢？我們可以去看看 <code>res/values/strings.xml</code> 這個檔案：</p>
<p><img src="/img/android-apk-decompile-intro/p3-strings.png"></p>
<p>內容為：</p>
<pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>resources</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>string</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>app_name<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>My Application<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>string</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>string</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>action_settings<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>Settings<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>string</span><span class="token punctuation">></span></span>
    <span class="token comment">&lt;!-- Strings used for fragments for navigation --></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>string</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>first_fragment_label<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>First Fragment<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>string</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>string</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>second_fragment_label<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>Second Fragment<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>string</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>string</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>next<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>Next<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>string</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>string</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>previous<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>Previous<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>string</span><span class="token punctuation">></span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>string</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>hello_first_fragment<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>Hello first fragment<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>string</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>string</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>hello_second_fragment<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>Hello second fragment. Arg: %1$s<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>string</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>resources</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>可以看到裡面有個 name 為 <code>hello_first_fragment</code> 的 string，內容是 <code>Hello first fragment</code>。</p>
<p>利用這樣的方法，我們可以避免直接在 layout 裡面 hard code 字串，避免將字串寫死。為什麼要避免寫死呢？因為要做多國語系！</p>
<p>如果你想要做成英文版的，那其實你可以建立一個新檔案叫做 <code>res/values/strings-en.xml</code> 之類的，Android 偵測到作業系統是英文時，就會自動去抓這個檔案裡面的字串來用，如此一來，你就只需要改變這個字串檔就好，不需要動到程式碼。</p>
<p>以上就是一些 Android app 的基本介紹，包括：</p>
<ol>
<li>AndroidManifest 是做什麼的？</li>
<li>什麼是 activity？</li>
<li>各種 xml 檔案的用途是什麼？</li>
</ol>
<p>理解這些以後，我們就可以來拆 apk 了。</p>
<p>我寫了一個簡單的範例 app，連結在這：<a target="_blank" rel="noopener" href="https://github.com/aszx87410/demo/raw/master/android/demoapp.apk">https://github.com/aszx87410/demo/raw/master/android/demoapp.apk</a></p>
<p>跑起來以後長這樣，小巧可愛：</p>
<p><img src="/img/android-apk-decompile-intro/p4-scr.png"></p>
<p>按下 <code>Check root</code> 之後會檢查裝置是否有 root，並改變畫面上的文字。</p>
<h2><span id="簡易-apk-拆解">簡易 apk 拆解</span></h2><p>其實 apk 就是一個壓縮檔，所以我們可以直接用內建的指令把 apk 拆開：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">unzip</span> demoapp.apk <span class="token parameter variable">-d</span> demoapp<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>拆開來會長這樣：</p>
<p><img src="/img/android-apk-decompile-intro/p5-apk.png"></p>
<p>大致上有底下幾個資料夾跟檔案：</p>
<ul>
<li>lib - 拿來放 native 程式碼用的，以後會講到</li>
<li>META-INF - 會有一些簽章相關資訊</li>
<li>res - 剛剛寫 app 的時候有看到了</li>
<li>AndroidManifest.xml - 同上 </li>
<li>classes.dex - 程式碼編譯成 dex 後的結果</li>
<li>resources.arsc - resource 相關的索引表</li>
</ul>
<p>先來講一下 <code>resources.arsc</code> 是幹嘛的，如果你打開 res 資料夾底下的任一檔案時，你會發現檔案內容不是純文字，而是一堆 16 進位的東西，像這樣：</p>
<pre class="line-numbers language-none"><code class="language-none">0300 0800 8401 0000 0100 1c00 a800 0000
0700 0000 0000 0000 0001 0000 3800 0000
0000 0000 0000 0000 0f00 0000 1a00 0000
2600 0000 3000 0000 3800 0000 4200 0000
0c0c 696e 7465 7270 6f6c 6174 6f72 0008
0864 7572 6174 696f 6e00 0909 6672 6f6d
416c 7068 6100 0707 746f 416c 7068 6100
0505 616c 7068 6100 0707 616e 6472 6f69
6400 2a2a 6874 7470 3a2f 2f73 6368 656d<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>這是因為這些 xml 已經被編譯過了，需要搭配 <code>resources.arsc</code> 才能還原成文字的形式。</p>
<p>而 <code>classes.dex</code> 也是經過編譯的東西，需要再進一步反編譯之後才能看到裡面的內容。</p>
<p>從上面這些我們可以知道，雖然可以手動利用解壓縮的方式把 apk 拆開，但其實看不到什麼有用的內容。為了進一步看到其中的內容，我們需要其他工具來做這件事情。</p>
<h2><span id="利用-apktool-拆解-apk">利用 Apktool 拆解 apk</span></h2><p>剛剛使用的 <code>unzip</code> 只是單純將壓縮檔解開，而 <a target="_blank" rel="noopener" href="https://ibotpeaches.github.io/Apktool/">Apktool</a> 的網站上開宗明義就寫了：A tool for reverse engineering Android apk files，表明了它就是拿來拆 apk 用的。</p>
<p>有關於下載跟安裝的細節我就不寫了，可自行參考官網：<a target="_blank" rel="noopener" href="https://ibotpeaches.github.io/Apktool/">https://ibotpeaches.github.io/Apktool/</a> 或者是其他網路上的資源。</p>
<p>接著，我們就來用 Apktool 拆開剛剛的 demoapp：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># d 是 decode 的意思</span>
<span class="token comment"># -f 是 --force，代表如果有 demoapp 的資料夾就先刪掉</span>
apktool d <span class="token parameter variable">-f</span> demoapp<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>拆開來以後可以看到底下的檔案結構：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token builtin class-name">.</span>
├── AndroidManifest.xml
├── apktool.yml
├── lib
├── original
├── res
└── smali<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>跟我們用壓縮檔解開的差別在於沒有了 <code>resources.arsc</code>，也沒有了<code>classes.dex</code>，前者是因為已經將資源還原成文字檔，後者則是還原成了 <code>smali</code> 資料夾底下的檔案，這個下一篇會提到。</p>
<p>接著我們先來改改看畫面上的文字。</p>
<p>打開 <code>res/values/strings.xml</code>，搜尋：<code>Hello first fragment</code>，會找到這一段：</p>
<pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>string</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>hello_first_fragment<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>Hello first fragment<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>string</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>我們直接將內容改掉，改成：</p>
<pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>string</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>hello_first_fragment<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>Hacked!<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>string</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>接下來只要將 apk 重新打包並裝回去，應該就能看到改過的文字。</p>
<h2><span id="重新打包-apk">重新打包 apk</span></h2><p>Apktool 除了拿來拆解 apk 以外，也可以將 apk 重新組裝回去，指令如下：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">apktool b demoapp <span class="token parameter variable">-o</span> demoapp2.apk<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>如果在打包的時候有出錯，可以改用：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">apktool b --use-aapt2 demoapp <span class="token parameter variable">-o</span> demoapp2.apk<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>沒意外的話，就會在資料夾底下看到一個 <code>demoapp2.apk</code> 的檔案，但這時如果你直接安裝這個檔案會出錯：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">adb: failed to <span class="token function">install</span> demoapp2.apk: Failure <span class="token punctuation">[</span>INSTALL_PARSE_FAILED_NO_CERTIFICATES: Failed to collect certificates from /data/app/vmdl1575742168.tmp/base.apk: Attempt to get length of null array<span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>這是因為 apk 檔打包出來以後還要經過兩道手續：align 跟 sign，才能安裝到手機上面。</p>
<p>align 是為了效能上的考量，而 sign 則是為了安全性。</p>
<p>在 Google Play 後台上傳新的 apk 時，Google 會檢查 apk 簽署時用的簽章是否跟之前一樣，如果不一樣的話會不讓你上傳。如此一來，就算攻擊者拿到受害者的帳號，也沒辦法上傳新的 apk，因為簽章不符。</p>
<p>我們先來產生一個新的簽章：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">keytool <span class="token parameter variable">-genkey</span> <span class="token parameter variable">-v</span> <span class="token parameter variable">-keystore</span> my-release-key.jks <span class="token parameter variable">-keyalg</span> RSA <span class="token parameter variable">-keysize</span> <span class="token number">2048</span> <span class="token parameter variable">-validity</span> <span class="token number">10000</span> <span class="token parameter variable">-alias</span> my-alias<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>問你 password 的地方輸入 123456 即可，其他都可以不填，執行完畢以後就會看到一個 <code>my-release-key.jks</code> 的檔案。</p>
<p>接著我有寫了一個簡單的 script，自動移除舊版本 + build + align + sign + install：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># compile.sh</span>

<span class="token comment"># 移除舊的 app</span>
adb uninstall com.cymetrics.demo

<span class="token comment"># 刪除舊的 apk</span>
<span class="token function">rm</span> <span class="token parameter variable">-f</span> demoapp2.apk
<span class="token function">rm</span> <span class="token parameter variable">-f</span> demoapp2-final.apk
<span class="token function">rm</span> <span class="token parameter variable">-f</span> demoapp2-aligned.apk

<span class="token comment"># build</span>
apktool b --use-aapt2 demoapp <span class="token parameter variable">-o</span> demoapp2.apk

<span class="token comment"># align</span>
zipalign <span class="token parameter variable">-v</span> <span class="token parameter variable">-p</span> <span class="token number">4</span> demoapp2.apk demoapp2-aligned.apk

<span class="token comment"># sign</span>
apksigner sign <span class="token parameter variable">--ks</span> my-release-key.jks --ks-pass pass:123456 <span class="token parameter variable">--out</span> demoapp2-final.apk demoapp2-aligned.apk
adb <span class="token function">install</span> demoapp2-final.apk<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>跑完 script 以後打開 app，沒意外的話你就會看見字已經被我們改掉了：</p>
<p><img src="/img/android-apk-decompile-intro/p6-apk2.png"></p>
<p>沒錯，修改一個單純的 app 就是這麼簡單。</p>
<h2><span id="總結">總結</span></h2><p>在這篇文章中我們學習了一些 Android 開發的基礎，也利用了 Apktool 將 apk 拆開，看見裡面的 resources 檔案，並且將其改造過後重新包回 apk 檔，安裝到手機上，做出了一個修改版的 app。</p>
<p>如果只是要改文字這些資源的話，就是這麼容易，但如果要改程式碼的話就相對麻煩許多。</p>
<p>在下一篇中，我們會來學習如何把 smali 還原成 Java code，以及如何修改 smali 程式碼。</p>
<p>系列文連結：</p>
<ol>
<li><a href="/2023/04/27/android-apk-decompile-intro-1/">Android App 逆向入門之一：拆開與重組 apk</a> - 你在這篇</li>
<li><a href="/2023/04/27/android-apk-decompile-intro-2/">Android App 逆向入門之二：修改 smali 程式碼</a></li>
<li><a href="/2023/04/27/android-apk-decompile-intro-3/">Android App 逆向入門之三：監聽 app 封包</a></li>
<li><a href="/2023/04/27/android-apk-decompile-intro-4/">Android App 逆向入門之四：使用 Frida 進行動態分析</a></li>
</ol>

    
    </div>
    
    <div class="columns is-variable is-1 is-multiline is-mobile">
    
        <span class="column is-narrow"><a class="tag is-light article-tag" href="/tags/Security/">#Security</a></span>
    
    </div>
    
    
    <div class="columns is-mobile is-multiline article-nav">
        <span class="column is-12-mobile is-half-desktop  article-nav-prev">
            
            <a href="/2023/04/27/android-apk-decompile-intro-2/">Android App 逆向入門之二：修改 smali 程式碼</a>
            
        </span>
        <span class="column is-12-mobile is-half-desktop  article-nav-next">
            
            <a href="/2023/04/14/how-to-prepare-japan-fe-and-sg-exam/">零日文基本情報技術者與情報セキュリティマネジメント試験準備心得</a>
            
        </span>
    </div>
    
</article>




<div class="comments">
    <h3 class="title is-4">評論</h3>
    <script src="https://utteranc.es/client.js"
        repo="aszx87410/huli-blog"
        issue-term="title"
        theme="github-light"
        crossorigin="anonymous"
        async>
</script>
</div>

    </div>
</section>
    <footer class="footer">
    <div class="container">
        <div class="columns content">
            <div class="column is-narrow has-text-centered">
                &copy; 2025 Huli&nbsp;
                Powered by <a href="http://hexo.io/" target="_blank">Hexo</a> & <a
                        target="_blank" rel="noopener" href="http://github.com/ppoffice/hexo-theme-minos">Minos</a>
            </div>
            <div class="column is-hidden-mobile"></div>

            
            <div class="column is-narrow">
                <div class="columns is-mobile is-multiline is-centered">
                
                    
                <a class="column is-narrow" title="GitHub" target="_blank" rel="noopener" href="https://github.com/ppoffice/hexo-theme-minos">
                    
                    GitHub
                    
                </a>
                
                </div>
            </div>
            
            
<div class="column is-narrow has-text-centered">
    <div class="dropdown is-up is-right is-hoverable" style="margin-top: -0.2em;">
        <div class="dropdown-trigger">
            <button class="button is-small" aria-haspopup="true">
                <span class="icon">
                    <i class="fas fa-globe"></i>
                </span>
                <span>繁體中文</span>
                <span class="icon is-small">
            <i class="fas fa-angle-down" aria-hidden="true"></i>
          </span>
            </button>
        </div>
        <div class="dropdown-menu has-text-left" role="menu" style="top:100%">
            <div class="dropdown-content">
            <!-- NOTE: 永遠回到首頁 -->
            
                <a href="/2023/04/27/en/android-apk-decompile-intro-1/" class="dropdown-item">
                    English
                </a>
            
            </div>
        </div>
    </div>
</div>

        </div>
    </div>
</footer>
    <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/3.6.3/jquery.min.js"></script>



    
    
    
    
    
    
<script src="//cdnjs.cloudflare.com/ajax/libs/lightgallery/1.6.8/js/lightgallery-all.min.js"></script>
<script>
    (function ($) {
        $(document).ready(function () {
            if (typeof($.fn.lightGallery) === 'function') {
                $('.article.gallery').lightGallery({ selector: '.gallery-item' });
            }
        });
    })(jQuery);
</script>

    
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.0/clipboard.min.js"></script>
    <style>
        .hljs {
            position: relative;
        }

        .hljs .clipboard-btn {
            float: right;
            color: #9a9a9a;
            background: none;
            border: none;
            cursor: pointer;
        }

        .hljs .clipboard-btn:hover {
          color: #8a8a8a;
        }

        .hljs > .clipboard-btn {
            display: none;
            position: absolute;
            right: 4px;
            top: 4px;
        }

        .hljs:hover > .clipboard-btn {
            display: inline;
        }

        .hljs > figcaption > .clipboard-btn {
            margin-right: 4px;
        }
    </style>
    <script>
      $(document).ready(function () {
        $('figure.hljs').each(function(i, figure) {
          var codeId = 'code-' + i;
          var code = figure.querySelector('.code');
          var copyButton = $('<button>Copy <i class="far fa-clipboard"></i></button>');
          code.id = codeId;
          copyButton.addClass('clipboard-btn');
          copyButton.attr('data-clipboard-target-id', codeId);

          var figcaption = figure.querySelector('figcaption');

          if (figcaption) {
            figcaption.append(copyButton[0]);
          } else {
            figure.prepend(copyButton[0]);
          }
        })

        var clipboard = new ClipboardJS('.clipboard-btn', {
          target: function(trigger) {
            return document.getElementById(trigger.getAttribute('data-clipboard-target-id'));
          }
        });
        clipboard.on('success', function(e) {
          e.clearSelection();
        })
      })
    </script>

    
    

    



<script src="/js/script.js?v=3.js"></script>


    
</body>
</html>