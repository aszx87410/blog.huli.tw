<!DOCTYPE html>
<html class="has-navbar-fixed-top" lang="en">
<head>
    <meta charset="utf-8">
<title>The Evolution of Web Scraping on Medium - Huli&#39;s blog</title>
<meta name="viewport" content="width=device-width, initial-scale=1">



            
<link href="https://blog.huli.tw/2019/07/12/medium-crawler/" rel="alternate" hreflang="zh-TW" />
            
    




    
<link rel="canonical" href="https://blog.huli.tw/2019/07/12/en/medium-crawler/">
    





    <meta name="description" content="IntroductionA few days ago, I posted an article on Medium titled Medium Chinese Writers’ Follower Ranking and Unprofessional Data Analysis, in which I used Node.js to write a simple web scraper and an">
<meta property="og:type" content="article">
<meta property="og:title" content="The Evolution of Web Scraping on Medium">
<meta property="og:url" content="https://blog.huli.tw/2019/07/12/en/medium-crawler/index.html">
<meta property="og:site_name" content="Huli&#39;s blog">
<meta property="og:description" content="IntroductionA few days ago, I posted an article on Medium titled Medium Chinese Writers’ Follower Ranking and Unprofessional Data Analysis, in which I used Node.js to write a simple web scraper and an">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://user-images.githubusercontent.com/2755720/61093603-2e954300-a400-11e9-9e70-acd06b97a6a8.png">
<meta property="og:image" content="https://user-images.githubusercontent.com/2755720/61093627-440a6d00-a400-11e9-9489-1eb6b1e49d62.png">
<meta property="article:published_time" content="2019-07-12T12:10:00.000Z">
<meta property="article:modified_time" content="2023-06-20T05:10:49.068Z">
<meta property="article:author" content="Huli">
<meta property="article:tag" content="Others">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://user-images.githubusercontent.com/2755720/61093603-2e954300-a400-11e9-9e70-acd06b97a6a8.png">



<link rel="alternative" href="/atom.xml" title="The Evolution of Web Scraping on Medium" type="application/atom+xml">



<link rel="icon" href="/img/lidemy_logo.png">


<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Ovo|Source+Code+Pro">


<link rel="stylesheet" href="/css/bulma.css?v=2.css">



<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/lightgallery/1.6.8/css/lightgallery.min.css">


<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/line-numbers/prism-line-numbers.min.css" />


<link rel="stylesheet" href="/css/style.css?v=4.css">





    
    
    
    
    
    
    
    
    
    
<script async src="https://www.googletagmanager.com/gtag/js?id=G-1393J2EVCZ"></script>
<script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-1393J2EVCZ');
</script>


    


<meta name="generator" content="Hexo 6.3.0"></head>
<body>
    <script>
        if (localStorage.getItem('dark-mode')) {
            if (localStorage.getItem('dark-mode') === 'true') {
                document.body.classList.add('dark-mode')
            }
        } else {
            if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                document.body.classList.add('dark-mode')
            }
        }
    </script>
    
<nav class="navbar is-transparent is-fixed-top navbar-main" role="navigation" aria-label="main navigation">
    <div class="container">
        <div class="navbar-brand">
            <a class="navbar-item navbar-logo" href="/en">
                
                    
                    Huli&#39;s blog
                    
                
            </a>
            <div class="navbar-burger">
                <span></span>
                <span></span>
                <span></span>
            </div>
        </div>
        
        <div class="navbar-menu navbar-start">
            
            <a class="navbar-item "
               href="/en/archives">Archive</a>
            
            <a class="navbar-item "
               href="/en/categories">Categories</a>
            
            <a class="navbar-item "
               href="/en/about">About</a>
            
        </div>
        
        <div class="navbar-menu navbar-end">
            
            
            <div class="navbar-item is-hoverable has-dropdown is-hidden-mobile is-hidden-tablet-only toc">
                <a class="navbar-item" title="Table of Contents">
                    Table of Contents
                </a>
                <div class="navbar-dropdown">
                    
                    
                    
                    
                    <a class="navbar-item" href="#introduction">1&nbsp;&nbsp;<b>Introduction</b></a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#first-attempt-finding-the-data-source">2&nbsp;&nbsp;<b>First Attempt: Finding the Data Source</b></a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#second-attempt-puppeteer">3&nbsp;&nbsp;<b>Second Attempt: Puppeteer</b></a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#third-attempt-puppeteer-api">4&nbsp;&nbsp;<b>Third Attempt: Puppeteer + API</b></a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#fourth-attempt-google">5&nbsp;&nbsp;<b>Fourth Attempt: Google</b></a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#crawler-architecture">6&nbsp;&nbsp;<b>Crawler Architecture</b></a>
                    
                    
                    
                    <a class="navbar-item" href="#users">6.1&nbsp;&nbsp;Users</a>
                    
                    
                    
                    <a class="navbar-item" href="#queue">6.2&nbsp;&nbsp;Queue</a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#first-version-of-the-crawler">7&nbsp;&nbsp;<b>First Version of the Crawler</b></a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#second-version-of-the-crawler-judging-chinese">8&nbsp;&nbsp;<b>Second Version of the Crawler: Judging Chinese</b></a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#crawler-version-3-judging-japanese-users">9&nbsp;&nbsp;<b>Crawler Version 3: Judging Japanese Users</b></a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#crawler-version-4-refactoring">10&nbsp;&nbsp;<b>Crawler Version 4: Refactoring</b></a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#summary">11&nbsp;&nbsp;<b>Summary</b></a>
                    
                </div>
            </div>
            
            
            <a class="navbar-item" target="_blank" title="Twitter" href="https://twitter.com/aszx87410">
                
                <i class="fab fa-twitter"></i>
                
            </a>
               
            <a class="navbar-item" target="_blank" title="RSS" href="/atom-en.xml">
                
                <i class="fas fa-rss"></i>
                
            </a>
               
            
            <a class="navbar-item btn-dark-mode" title="dark-mode" href="#">
                <div>
                    <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" width="15" height="15" viewBox="0 0 256 256" xml:space="preserve">
                    <defs>
                    </defs>
                    <g style="stroke: none; stroke-width: 0; stroke-dasharray: none; stroke-linecap: butt; stroke-linejoin: miter; stroke-miterlimit: 10; fill: none; fill-rule: nonzero; opacity: 1;" transform="translate(1.4065934065934016 1.4065934065934016) scale(2.81 2.81)" >
                        <path d="M 87.823 60.7 c -0.463 -0.423 -1.142 -0.506 -1.695 -0.214 c -15.834 8.398 -35.266 2.812 -44.232 -12.718 c -8.966 -15.53 -4.09 -35.149 11.101 -44.665 c 0.531 -0.332 0.796 -0.963 0.661 -1.574 c -0.134 -0.612 -0.638 -1.074 -1.259 -1.153 c -9.843 -1.265 -19.59 0.692 -28.193 5.66 C 13.8 12.041 6.356 21.743 3.246 33.35 S 1.732 57.08 7.741 67.487 c 6.008 10.407 15.709 17.851 27.316 20.961 C 38.933 89.486 42.866 90 46.774 90 c 7.795 0 15.489 -2.044 22.42 -6.046 c 8.601 -4.966 15.171 -12.43 18.997 -21.586 C 88.433 61.79 88.285 61.123 87.823 60.7 z" style="stroke: none; stroke-width: 1; stroke-dasharray: none; stroke-linecap: butt; stroke-linejoin: miter; stroke-miterlimit: 10; fill: #ffa716; fill-rule: nonzero; opacity: 1;" transform=" matrix(1 0 0 1 0 0) " stroke-linecap="round" />
                    </g>
                    </svg>
                </div>
            </a>
            
               <a class="navbar-item" href="/2019/07/12/medium-crawler/">中文</a>
            
            

        </div>
    </div>
</nav>

    <section class="section">
    <div class="container">
      
      <div data-nosnippet class="self-notice">
        If you have any thoughts on my blog or articles and you want to let me know, you can either post a comment below(public) or tell me via this <a href="https://forms.gle/SjJZ4cnNs6NnjXQG8" target="_blank">feedback form</a>
      </div>
      
    <article class="article content gallery" itemscope itemprop="blogPost">
    <h1 class="article-title is-size-3 is-size-4-mobile" itemprop="name">
        
            The Evolution of Web Scraping on Medium
        
    </h1>
    <div class="article-meta columns is-variable is-1 is-multiline is-mobile is-size-7-mobile">
        <span class="column is-narrow">
            <time datetime="2019-07-12T12:10:00.000Z" itemprop="datePublished">12 July 2019</time>
        </span>
        
        <span class="column is-narrow article-category">
            <i class="far fa-folder"></i>
            <a class="article-category-link" href="/en/categories/Others/">Others</a>
        </span>
        
        
        
        <spen data-nosnippet class="column is-narrow">(Translated by ChatGPT)</span>
        
    </div>
    
    <div class="article-entry is-size-6-mobile" itemprop="articleBody">
    
        <h2><span id="introduction">Introduction</span></h2><p>A few days ago, I posted an article on Medium titled <a target="_blank" rel="noopener" href="https://medium.com/@hulitw/medium-analysis-40752b9efa03">Medium Chinese Writers’ Follower Ranking and Unprofessional Data Analysis</a>, in which I used Node.js to write a simple web scraper and analyzed the data.</p>
<p>Although I briefly mentioned the data source of the web scraper in the original article, I did not elaborate much on the technical aspects. In fact, I encountered some difficulties while writing the Medium web scraper. Instead of teaching everyone how to write a Medium web scraper, I think it would be more interesting to share my experience and the solutions I found to the problems I encountered while writing the web scraper.</p>
<p>Therefore, this article is intended to document my experience of writing the Medium web scraper, and also includes some tutorial elements. After reading this article, you should be able to write a similar web scraper, or at least not be confused when looking at the source code.</p>
<p>Although the web scraper I eventually wrote was related to user data, I actually started with the article list because I had a need to scrape all of my own articles.</p>
<p>The reason for this need is that the built-in functionality of Medium is actually quite poor. It is difficult to find all the articles posted by an author, or it is difficult to see them at a glance. Therefore, early articles were difficult to find except through Google.</p>
<p>So I manually created an <a target="_blank" rel="noopener" href="https://aszx87410.github.io/blog/medium">index of articles</a> and organized all the articles I had previously posted. But as an engineer, this is clearly something that can be done with code! So I wanted to try writing a web scraper for the article list.</p>
<span id="more"></span>

<h2><span id="first-attempt-finding-the-data-source">First Attempt: Finding the Data Source</span></h2><p>For me, the first and most difficult step in web scraping is finding the data source. Once this step is completed, everything else is relatively easy.</p>
<p>If you can get the Medium API, that would be the best. If not, you have to use something like puppeteer to scrape the HTML and parse it yourself.</p>
<p>Scrolling through the article list on Medium and opening the devtool, you can see that Medium uses GraphQL:</p>
<img width="792" alt="p1" src="https://user-images.githubusercontent.com/2755720/61093603-2e954300-a400-11e9-9e70-acd06b97a6a8.png">


<p>This is troublesome… I am not very familiar with GraphQL, and it takes time to study its data structure. So at that time, I temporarily gave up this route and decided to try using puppeteer.</p>
<h2><span id="second-attempt-puppeteer">Second Attempt: Puppeteer</span></h2><p>If you don’t know what puppeteer is, I’ll briefly introduce it here. You can think of puppeteer as automatically opening a browser for you, and you can write code to manipulate this browser. For example, if I want to open a page and execute JS on this page, etc., then using puppeteer, the principle of web scraping is to open a certain page, execute a piece of JS, and get the data on the page.</p>
<p>Puppeteer is easy to use. Just find an existing example and look at the syntax, modify it, and you can use it directly. After studying the HTML structure a bit, I wrote the following code:</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> puppeteer <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'puppeteer'</span><span class="token punctuation">)</span>
  
<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">const</span> username <span class="token operator">=</span> <span class="token string">'hulitw'</span>
  <span class="token keyword">const</span> url <span class="token operator">=</span> <span class="token string">'https://medium.com/@'</span> <span class="token operator">+</span> username
  
  <span class="token keyword">const</span> browser <span class="token operator">=</span> <span class="token keyword">await</span> puppeteer<span class="token punctuation">.</span><span class="token function">launch</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
    <span class="token literal-property property">headless</span><span class="token operator">:</span> <span class="token boolean">true</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
  
  <span class="token comment">// 造訪頁面</span>
  <span class="token keyword">const</span> page <span class="token operator">=</span> <span class="token keyword">await</span> browser<span class="token punctuation">.</span><span class="token function">newPage</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">await</span> page<span class="token punctuation">.</span><span class="token function">goto</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>
    <span class="token literal-property property">waitUntil</span><span class="token operator">:</span> <span class="token string">'domcontentloaded'</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
  
  <span class="token comment">// 執行準備好的 script 並回傳資料 </span>
  <span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token keyword">await</span> page<span class="token punctuation">.</span><span class="token function">evaluate</span><span class="token punctuation">(</span>mediumParser<span class="token punctuation">)</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>
  
  <span class="token keyword">await</span> page<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">await</span> browser<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span>
  
<span class="token keyword">function</span> <span class="token function">mediumParser</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  
  <span class="token comment">// selector 是透過觀察而得來的</span>
  <span class="token keyword">const</span> elements <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelectorAll</span><span class="token punctuation">(</span><span class="token string">'section > div:nth-child(2) > div > div'</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> elements<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">const</span> h1 <span class="token operator">=</span> elements<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">'h1'</span><span class="token punctuation">)</span>
    <span class="token keyword">const</span> a <span class="token operator">=</span> elements<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">querySelectorAll</span><span class="token punctuation">(</span><span class="token string">'a'</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>h1<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      result<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
        <span class="token literal-property property">title</span><span class="token operator">:</span> h1<span class="token punctuation">.</span>innerText<span class="token punctuation">,</span>
        <span class="token literal-property property">link</span><span class="token operator">:</span> a<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">.</span>href
      <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>
  <span class="token keyword">return</span> result
<span class="token punctuation">&#125;</span>
  
<span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>As long as you observe the HTML and CSS rules, you can get the data you want. But Medium is difficult to scrape because it uses <a target="_blank" rel="noopener" href="https://blog.techbridge.cc/2019/01/26/functional-css/">functional CSS</a> in the class name, and the class names are processed programmatically, so they may be different when Medium is updated.</p>
<p>So in the end, I had to start with the HTML structure to extract the articles.</p>
<p>After solving this problem, there is another problem, which is infinite scrolling. Like many web pages, Medium needs to scroll down continuously to load new articles, and the rule that needs to be observed here is when to stop scrolling.</p>
<p>After observation, I found that when the published articles are loaded, the <code>Highlighted by xxx</code> block will be displayed. Therefore, this element can be used as the termination condition.</p>
<p>Then you can write a piece of code that keeps scrolling down until all articles are loaded:</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">/*
  要用的話就是： await scroll(page)
*/</span>
  
<span class="token keyword">function</span> <span class="token function">getArticlesCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">const</span> elements <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelectorAll</span><span class="token punctuation">(</span><span class="token string">'section > div:nth-child(2) > div > div'</span><span class="token punctuation">)</span>
  <span class="token keyword">return</span> elements<span class="token punctuation">.</span>length
<span class="token punctuation">&#125;</span>
  
<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">scroll</span><span class="token punctuation">(</span><span class="token parameter">page</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">await</span> page<span class="token punctuation">.</span><span class="token function">evaluate</span><span class="token punctuation">(</span><span class="token string">'window.scrollTo(0, document.body.scrollHeight)'</span><span class="token punctuation">)</span>
  <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
  
    <span class="token comment">// 終止條件</span>
    <span class="token keyword">await</span> page<span class="token punctuation">.</span><span class="token function">waitForSelector</span><span class="token punctuation">(</span><span class="token string">'h4 ~ p'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>
      <span class="token literal-property property">timeout</span><span class="token operator">:</span> <span class="token number">1000</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
  <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  
    <span class="token comment">// 印出目前抓到的文章數目</span>
    <span class="token keyword">const</span> count <span class="token operator">=</span> <span class="token keyword">await</span> page<span class="token punctuation">.</span><span class="token function">evaluate</span><span class="token punctuation">(</span>getArticlesCount<span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Fetching... </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>count<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string"> articles</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
  
    <span class="token comment">// 繼續往下捲動</span>
    <span class="token keyword">await</span> <span class="token function">scroll</span><span class="token punctuation">(</span>page<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>In order to let me see the progress on the console (to confirm that there are no bugs in the program), I added a piece of code that prints the number of articles on the screen every time it scrolls.</p>
<p>At this point, you can get all the titles and links of the user’s articles.</p>
<p>What about the publication date? Can you get it?</p>
<p>Yes, I can, but it’s complicated. You can see from the Medium screenshot below:</p>
<p>[Image]</p>
<p>If the article was published this year (2019), the year won’t be displayed. Otherwise, the publication year will be shown. Therefore, special processing is required here, and only the date can be obtained, not the exact time of publication.</p>
<p>At this point, I got lazy and decided to switch to studying the API instead. </p>
<h2><span id="third-attempt-puppeteer-api">Third Attempt: Puppeteer + API</span></h2><p>As I mentioned earlier, I wasn’t familiar with GraphQL API at the time, so I gave up on it temporarily. However, after trying out Puppeteer, I came up with a new idea.</p>
<p>In Puppeteer, you can add an event listener for network responses. When the page loads the article, it will definitely call the API to retrieve the article. Isn’t this much easier? I don’t have to figure out how to call the API myself. I let the page call the API itself, and I just listen to the response and study its format!</p>
<p>The code looks something like this:</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> apiResponses <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
  
page<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'response'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">response</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>response<span class="token punctuation">.</span>_url<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">'graphql'</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">return</span>
    <span class="token keyword">const</span> json <span class="token operator">=</span> <span class="token keyword">await</span> response<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">const</span> post <span class="token operator">=</span> <span class="token function">parsePosts</span><span class="token punctuation">(</span>json<span class="token punctuation">)</span>
      apiResponses<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token operator">...</span>post<span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
  
<span class="token keyword">function</span> <span class="token function">parsePosts</span><span class="token punctuation">(</span><span class="token parameter">json</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
  <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
  
    <span class="token comment">// 研究到一半沒做完</span>
    <span class="token keyword">const</span> streams <span class="token operator">=</span> json<span class="token punctuation">.</span>data<span class="token punctuation">.</span>user<span class="token punctuation">.</span>profileStreamConnection<span class="token punctuation">.</span>stream
    <span class="token keyword">for</span> <span class="token punctuation">(</span>stream <span class="token keyword">of</span> streams<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>stream<span class="token punctuation">.</span>itemType<span class="token punctuation">.</span>__typename <span class="token operator">===</span> <span class="token string">'StreamItemCompressedPostList'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>Each time a new response comes in, I can parse it and add it to an array. Finally, I will get the complete data from the API.</p>
<p>But then I found out that this approach wouldn’t work either.</p>
<p>Why? Because when the page is first loaded, the HTML returned from the server already contains the data for the first few articles. It’s only when you scroll down that it uses AJAX to load new articles. This means that it’s impossible to use the AJAX response to get all the article data, as you won’t be able to get the data for the first few articles.</p>
<p>At this point, I was a bit discouraged and thought that I had spent two days writing something that couldn’t be used. I gave up on trying to retrieve the article list and decided to focus on what I really wanted to get.</p>
<p>The need to retrieve the article list actually came up suddenly. Before that, there was something else I wanted to get: followers. I wanted to count the number of followers for Taiwanese writers and see where I ranked (just to satisfy my vanity).</p>
<p>After failing to retrieve the article list, I tried to use a similar approach to retrieve followers. However, I found that this method was too inefficient. If I loaded 25 followers each time I scrolled, it would take 40 scrolls to load 1000 followers.</p>
<p>If I couldn’t do it myself, the answer was obvious: Google, please help me!</p>
<h2><span id="fourth-attempt-google">Fourth Attempt: Google</span></h2><p>I searched for “medium follower api” on Google, and the first search result was the official API, which was almost useless and required me to send an email to customer service to apply.</p>
<p>But the second search result caught my eye. It was a gist file: <a target="_blank" rel="noopener" href="https://gist.github.com/newhouse/843c444ddefe084ea7f01603627dbcfd">Medium API: get number of followers for User · GitHub</a>.</p>
<p>The code was only fifty lines long, very short. The most important line was:</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// BUILD THE URL TO REQUEST FROM</span>
<span class="token keyword">function</span> <span class="token function">generateMediumProfileUri</span><span class="token punctuation">(</span><span class="token parameter">username</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">https://medium.com/@</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>username<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">?format=json</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>What! It turns out that if you add <code>?format=json</code> to the URL, you can get the data in JSON format. This is amazing.</p>
<p>After putting the data into <a target="_blank" rel="noopener" href="https://jsonformatter.curiousconcept.com/">JSON Formatter</a>, you can see the general structure:</p>
<p>[Image]</p>
<p>Here, you can get the user’s profile information and some articles they’ve written, as well as our target: followers!</p>
<p>Let’s take a look at what user information we can get:</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token string-property property">"user"</span><span class="token operator">:</span><span class="token punctuation">&#123;</span>  
   <span class="token string-property property">"userId"</span><span class="token operator">:</span><span class="token string">"f1fb3e40dc37"</span><span class="token punctuation">,</span>
   <span class="token string-property property">"name"</span><span class="token operator">:</span><span class="token string">"Huli"</span><span class="token punctuation">,</span>
   <span class="token string-property property">"username"</span><span class="token operator">:</span><span class="token string">"hulitw"</span><span class="token punctuation">,</span>
   <span class="token string-property property">"createdAt"</span><span class="token operator">:</span><span class="token number">1487549030919</span><span class="token punctuation">,</span>
   <span class="token string-property property">"imageId"</span><span class="token operator">:</span><span class="token string">"1*WQyJUJBQpBNIHH8GEWE6Sg.jpeg"</span><span class="token punctuation">,</span>
   <span class="token string-property property">"backgroundImageId"</span><span class="token operator">:</span><span class="token string">""</span><span class="token punctuation">,</span>
   <span class="token string-property property">"bio"</span><span class="token operator">:</span><span class="token string">"自學程式，後來跑去唸哲學系但沒念完，前往新加坡工作了兩年半後決定放一年的假，到處旅遊。喜歡教學，發現自己好像有把事情講得簡單又清楚的能力，相信分享與交流可以讓世界更美好。\bMedium 文章列表請參考：https://aszx87410.github.io/blog/medium"</span><span class="token punctuation">,</span>
   <span class="token string-property property">"allowNotes"</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">,</span>
   <span class="token string-property property">"mediumMemberAt"</span><span class="token operator">:</span><span class="token number">1542441600000</span><span class="token punctuation">,</span>
   <span class="token string-property property">"isNsfw"</span><span class="token operator">:</span><span class="token boolean">false</span><span class="token punctuation">,</span>
   <span class="token string-property property">"isWriterProgramEnrolled"</span><span class="token operator">:</span><span class="token boolean">true</span><span class="token punctuation">,</span>
   <span class="token string-property property">"isQuarantined"</span><span class="token operator">:</span><span class="token boolean">false</span><span class="token punctuation">,</span>
   <span class="token string-property property">"type"</span><span class="token operator">:</span><span class="token string">"User"</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>In addition to basic self-introduction and name, you can also get the time when the user became a Medium paid member and the time when the user became a Medium member. There’s also an interesting flag: isNsfw.</p>
<p>The only thing missing is the list of followers.</p>
<p>Here, I tried the same method and added the parameter <code>https://medium.com/@hulitw/followers?format=json</code> to the Medium URL, and I actually got something! In the response, I found the data for 10 followers.</p>
<p>Once we have the data, we can confirm that this API is useful. Next, we jump directly to the paging section at the bottom of the response:</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token string-property property">"paging"</span><span class="token operator">:</span><span class="token punctuation">&#123;</span>  
   <span class="token string-property property">"path"</span><span class="token operator">:</span><span class="token string">"https://medium.com/_/api/users/f1fb3e40dc37/profile/stream"</span><span class="token punctuation">,</span>
   <span class="token string-property property">"next"</span><span class="token operator">:</span><span class="token punctuation">&#123;</span>  
      <span class="token string-property property">"limit"</span><span class="token operator">:</span><span class="token number">10</span><span class="token punctuation">,</span>
      <span class="token string-property property">"to"</span><span class="token operator">:</span><span class="token string">"10590c54e527"</span><span class="token punctuation">,</span>
      <span class="token string-property property">"source"</span><span class="token operator">:</span><span class="token string">"followers"</span><span class="token punctuation">,</span>
      <span class="token string-property property">"page"</span><span class="token operator">:</span><span class="token number">2</span>
   <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>The path part looks like an API URL, and <code>next</code> should be a parameter. Try adding these parameters to the URL: <a target="_blank" rel="noopener" href="https://medium.com/_/api/users/f1fb3e40dc37/profile/stream?limit=10&to=10590c54e527&source=followers&page=2">https://medium.com/_/api/users/f1fb3e40dc37/profile/stream?limit=10&amp;to=10590c54e527&amp;source=followers&amp;page=2</a>, and only follower-related data appears!</p>
<img width="660" alt="p4" src="https://user-images.githubusercontent.com/2755720/61093627-440a6d00-a400-11e9-9489-1eb6b1e49d62.png">

<p>Try changing the <code>limit</code> value, and it seems that the maximum value should be 25, and 25 pieces of data can be obtained at a time. Changing the <code>page</code> value has no effect, so change the <code>to</code> value, and new data can be successfully obtained. It seems that the pagination mechanism is cursor-based.</p>
<p>After several attempts, we finally got two API URLs, one for obtaining detailed personal information and the other for obtaining a list of followers!</p>
<p>After determining the data source, we can start thinking about the crawler architecture.</p>
<h2><span id="crawler-architecture">Crawler Architecture</span></h2><p>How can we crawl as many Taiwanese writers as possible?</p>
<p>The first problem is that we need to expand the scope a bit, because there may be writers from Hong Kong or China among Chinese writers, and it is difficult for the program to distinguish where they come from, especially Hong Kong and Taiwan, because they both use traditional Chinese.</p>
<p>To avoid making the problem more complicated, we only need to be able to capture “Chinese users”.</p>
<p>So how can we capture the most Chinese users? A very simple strategy is that we assume that the followers of Chinese users should all be Chinese users, so we just need to start from a user and put all of his followers into a queue, and keep doing this.</p>
<p>In text, it is simplified as follows:</p>
<ol>
<li>Take a user out of the queue</li>
<li>Write his data to the database</li>
<li>Put all of his followers into the queue</li>
<li>Go back to step 1</li>
</ol>
<p>This way, we can infinitely extend from one user, and theoretically, we can obtain data from a large number of users. The reason why we choose followers (people who follow me) instead of following (people I follow) is that the users I follow may come from other countries, such as foreign engineers, but because I don’t write in English, foreign engineers should not come to follow me. This way, we can limit users to Chinese, which meets our goals.</p>
<p>Next is the system architecture part, which will have different methods depending on the efficiency you want to achieve.</p>
<p>For me, the most efficient way is to find a service that is very suitable for use as a queue, such as redis, and the database part can use MySQL or any software you are familiar with. The advantage of this is that you can open different machines, and each machine is a worker. For example, if you open five machines, there will be five workers constantly taking things out of the queue and putting followers in.</p>
<p>The reason why so many machines are opened instead of many threads or processes is because of the problem of rate limiting. Generally, APIs have traffic restrictions. If you send too many requests from the same IP, you will be banned or unable to get a response for a period of time. Therefore, opening more processes and threads is useless, and only different machines can be opened to solve the problem (or if there is a way to change the IP).</p>
<p>Later, because I didn’t care about efficiency and was too lazy to open many machines, I only planned to open one and let it crawl slowly. If there is only one worker, the queue part can also be simplified. Here, I also use MySQL to implement a simple queue, making the entire crawler architecture very simple.</p>
<p>Let’s take a look at the database structure:</p>
<h3><span id="users">Users</span></h3><table>
<thead>
<tr>
<th>id</th>
<th>userId</th>
<th>username</th>
<th>name</th>
<th>bio</th>
<th>follower</th>
<th>fr</th>
<th>mediumMemberAt</th>
<th>createdAt</th>
</tr>
</thead>
<tbody><tr>
<td>Auto-increment ID</td>
<td>User ID</td>
<td>Add @ in front to get the profile URL</td>
<td>Username</td>
<td>Bio</td>
<td>Number of followers</td>
<td>Category</td>
<td>Time of becoming a paid member</td>
<td>Time of joining</td>
</tr>
</tbody></table>
<h3><span id="queue">Queue</span></h3><table>
<thead>
<tr>
<th>id</th>
<th>userId</th>
</tr>
</thead>
<tbody><tr>
<td>Auto-increment ID</td>
<td>User ID</td>
</tr>
</tbody></table>
<p>The execution process of the program is as follows:</p>
<ol>
<li>Take out a userId from the Queue.</li>
<li>If the userId already exists in Users, go back to step 1.</li>
<li>Write the user’s data into Users.</li>
<li>Put all of the user’s followers into the Queue.</li>
<li>Go back to step 1.</li>
</ol>
<p>When taking out from the queue, make sure that the user has not been crawled yet. If they have, skip them and put all of their followers back into the queue. This way, the program will keep running until there is nothing left in the queue.</p>
<p>After designing the architecture, we can start coding!</p>
<h2><span id="first-version-of-the-crawler">First Version of the Crawler</span></h2><p>First, we need a queue that can push and pop, and can determine whether the current userId has already been crawled. This is very suitable for implementation using a class:</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">class</span> <span class="token class-name">Queue</span> <span class="token punctuation">&#123;</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">conn</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>conn <span class="token operator">=</span> conn
  <span class="token punctuation">&#125;</span>
  
  <span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>conn<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token string">'SELECT userId from Queues limit 1'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">error<span class="token punctuation">,</span> results</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
          console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span>
          <span class="token keyword">return</span> <span class="token function">reject</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>results<span class="token punctuation">.</span>length <span class="token operator">!==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
          <span class="token keyword">return</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">const</span> data <span class="token operator">=</span> results<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>conn<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token string">'DELETE from Queues where userId=?'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>data<span class="token punctuation">.</span>userId<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> results</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span>
            <span class="token keyword">return</span> <span class="token function">reject</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span>
          <span class="token punctuation">&#125;</span>
          <span class="token keyword">return</span> <span class="token function">resolve</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>userId<span class="token punctuation">)</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
  <span class="token punctuation">&#125;</span>
  
  <span class="token function">check</span><span class="token punctuation">(</span><span class="token parameter">uid</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>conn<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token string">'SELECT userId from Users where userId=?'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>uid<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">error<span class="token punctuation">,</span> results</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
          <span class="token keyword">return</span> <span class="token function">reject</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>results<span class="token punctuation">.</span>length <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
          <span class="token keyword">return</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">return</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
  <span class="token punctuation">&#125;</span>
  
  <span class="token function">push</span><span class="token punctuation">(</span><span class="token parameter">list</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">const</span> values <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> item <span class="token keyword">of</span> list<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        values<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">[</span>item<span class="token punctuation">]</span><span class="token punctuation">)</span>
      <span class="token punctuation">&#125;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>conn<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
        INSERT IGNORE INTO Queues (userId) VALUES ?</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> <span class="token punctuation">[</span>values<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token comment">// console.log(err)</span>
          <span class="token punctuation">&#125;</span>
          <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">&#125;</span>
      <span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>After having the queue, we can write the main logic. The structure of the main program will look like this:</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">var</span> connection <span class="token operator">=</span> mysql<span class="token punctuation">.</span><span class="token function">createPool</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
  <span class="token literal-property property">connectionLimit</span> <span class="token operator">:</span> <span class="token number">10</span><span class="token punctuation">,</span>
  <span class="token literal-property property">host</span>     <span class="token operator">:</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span>host<span class="token punctuation">,</span>
  <span class="token literal-property property">user</span>     <span class="token operator">:</span> <span class="token string">''</span><span class="token punctuation">,</span>
  <span class="token literal-property property">password</span> <span class="token operator">:</span> <span class="token string">''</span><span class="token punctuation">,</span>
  <span class="token literal-property property">database</span> <span class="token operator">:</span> <span class="token string">'medium'</span><span class="token punctuation">,</span>
  <span class="token literal-property property">charset</span><span class="token operator">:</span> <span class="token string">'utf8mb4'</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span>

<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">const</span> queue <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Queue</span><span class="token punctuation">(</span>connection<span class="token punctuation">)</span>
  
  <span class="token comment">// 不斷從 queue 拿東西出來</span>
  <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">const</span> userId <span class="token operator">=</span> <span class="token keyword">await</span> queue<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>userId<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'no data from queue, end'</span><span class="token punctuation">)</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
  
    <span class="token comment">// 看看是否已經爬過，爬過就跳掉</span>
    <span class="token keyword">const</span> check <span class="token operator">=</span> <span class="token keyword">await</span> queue<span class="token punctuation">.</span><span class="token function">check</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>check<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">continue</span>
    <span class="token punctuation">&#125;</span>
  
    <span class="token comment">// 拿 userId 做你想做的事</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'uid:'</span><span class="token punctuation">,</span> userId<span class="token punctuation">)</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>Then, we just need to implement the following two functions:</p>
<ol>
<li>Fetch user data</li>
<li>Write user data into the database</li>
<li>Put followers back into the queue</li>
</ol>
<p>Since the Medium API response always has an anti-<a target="_blank" rel="noopener" href="https://medium.com/@jaydenlin/%E7%82%BA%E4%BD%95-facebook-api-%E8%A6%81%E5%9B%9E%E5%82%B3%E7%84%A1%E7%AA%AE%E8%BF%B4%E5%9C%88-%E8%AB%87%E6%8D%B2%E5%9C%9F%E9%87%8D%E4%BE%86%E7%9A%84-json-hijacking-bc220617ceba">json hijacking</a> header, we can wrap a function specifically to parse the API response:</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">getMediumResponse</span><span class="token punctuation">(</span><span class="token parameter">url</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">const</span> response <span class="token operator">=</span> <span class="token keyword">await</span> axios<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span>
    <span class="token keyword">const</span> json <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span>data<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token string">'])&#125;while(1);&lt;/x>'</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> json
  <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> <span class="token keyword">null</span>
  <span class="token punctuation">&#125;</span> 
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>Then, we can write two functions, one to fetch user data and one to fetch follower data (functions with an underscore are lodash functions):</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">getUserInfo</span><span class="token punctuation">(</span><span class="token parameter">uid</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">const</span> url <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">https://medium.com/_/api/users/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>uid<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">/profile/stream</span><span class="token template-punctuation string">`</span></span>
  <span class="token keyword">const</span> json <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">getMediumResponse</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>json<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>
  <span class="token keyword">const</span> userId <span class="token operator">=</span> _<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>json<span class="token punctuation">,</span> <span class="token string">'payload.user.userId'</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> follower <span class="token operator">=</span> _<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>json<span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">payload.references.SocialStats.</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>userId<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">.usersFollowedByCount</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
  
  <span class="token keyword">return</span> <span class="token punctuation">&#123;</span>
    <span class="token literal-property property">followerCount</span><span class="token operator">:</span> follower<span class="token punctuation">,</span>
    <span class="token literal-property property">userId</span><span class="token operator">:</span> userId<span class="token punctuation">,</span>
    <span class="token literal-property property">name</span><span class="token operator">:</span> _<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>json<span class="token punctuation">,</span> <span class="token string">'payload.user.name'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token literal-property property">username</span><span class="token operator">:</span> _<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>json<span class="token punctuation">,</span> <span class="token string">'payload.user.username'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token literal-property property">bio</span><span class="token operator">:</span> _<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>json<span class="token punctuation">,</span> <span class="token string">'payload.user.bio'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token literal-property property">mediumMemberAt</span><span class="token operator">:</span> _<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>json<span class="token punctuation">,</span> <span class="token string">'payload.user.mediumMemberAt'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token literal-property property">isWriterProgramEnrolled</span><span class="token operator">:</span> _<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>json<span class="token punctuation">,</span> <span class="token string">'payload.user.isWriterProgramEnrolled'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token literal-property property">createdAt</span><span class="token operator">:</span> _<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>json<span class="token punctuation">,</span> <span class="token string">'payload.user.createdAt'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">getFollowers</span><span class="token punctuation">(</span><span class="token parameter">uid<span class="token punctuation">,</span> to</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">let</span> url <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">https://medium.com/_/api/users/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>uid<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">/profile/stream?source=followers&amp;limit=200</span><span class="token template-punctuation string">`</span></span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>to<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    url <span class="token operator">+=</span> <span class="token string">'&amp;to='</span> <span class="token operator">+</span> to
  <span class="token punctuation">&#125;</span>
  <span class="token keyword">const</span> json <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">getMediumResponse</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>json<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>
  <span class="token keyword">const</span> followers <span class="token operator">=</span> _<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>json<span class="token punctuation">.</span>payload<span class="token punctuation">.</span>references<span class="token punctuation">.</span>Social<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
  <span class="token keyword">const</span> nextTo <span class="token operator">=</span> _<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>json<span class="token punctuation">,</span> <span class="token string">'payload.paging.next.to'</span><span class="token punctuation">)</span>
  <span class="token keyword">return</span> <span class="token punctuation">&#123;</span>
    followers<span class="token punctuation">,</span>
    nextTo
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>Basically, we just call the API and process the data a little bit, then return what we are interested in.</p>
<p>We only implemented the function to “fetch one follower” above, so we need to implement another function to “fetch all followers and put them into the queue”:</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">getAllFollowers</span><span class="token punctuation">(</span><span class="token parameter">uid<span class="token punctuation">,</span> queue</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">const</span> followers <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
  <span class="token keyword">let</span> to <span class="token operator">=</span> <span class="token keyword">undefined</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">getFollowers</span><span class="token punctuation">(</span>uid<span class="token punctuation">,</span> to<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>data<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    followers<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token operator">...</span>data<span class="token punctuation">.</span>followers<span class="token punctuation">)</span>
    to <span class="token operator">=</span> data<span class="token punctuation">.</span>nextTo
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>uid<span class="token punctuation">,</span> <span class="token string">'fetching...'</span><span class="token punctuation">,</span> followers<span class="token punctuation">.</span>length<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>data<span class="token punctuation">.</span>followers<span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">0</span> <span class="token operator">||</span> <span class="token operator">!</span>to<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">await</span> queue<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>followers<span class="token punctuation">)</span>
  <span class="token punctuation">&#125;</span>
  <span class="token keyword">return</span> followers
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>This function will continuously fetch followers and put them into the queue, and print out how many followers have been fetched so far. Once all followers have been fetched, it will return all of the followers (it returns because I originally wrote the code to write all of the followers into the queue at once, but later found it to be less efficient, so I changed it to write them one by one).</p>
<p>Finally, here is the code to write user data into the database:</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">format</span><span class="token punctuation">(</span><span class="token parameter">time</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>time<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token keyword">null</span>
  <span class="token keyword">return</span> <span class="token function">moment</span><span class="token punctuation">(</span>time<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">'YYYY-MM-DD HH:mm:ss'</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span>
  
<span class="token keyword">function</span> <span class="token function">saveUserInfo</span><span class="token punctuation">(</span><span class="token parameter">conn<span class="token punctuation">,</span> info</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  conn<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
    INSERT INTO Users
    (
      userId, username, name, bio, follower,
      mediumMemberAt, createdAt, isWriterProgramEnrolled
    ) VALUES ?</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token punctuation">[</span>
      info<span class="token punctuation">.</span>userId<span class="token punctuation">,</span> info<span class="token punctuation">.</span>username<span class="token punctuation">,</span> info<span class="token punctuation">.</span>name<span class="token punctuation">,</span> info<span class="token punctuation">.</span>bio<span class="token punctuation">,</span> info<span class="token punctuation">.</span>followerCount<span class="token punctuation">,</span>
      <span class="token function">format</span><span class="token punctuation">(</span>info<span class="token punctuation">.</span>mediumMemberAt<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">format</span><span class="token punctuation">(</span>info<span class="token punctuation">.</span>createdAt<span class="token punctuation">)</span><span class="token punctuation">,</span> info<span class="token punctuation">.</span>isWriterProgramEnrolled
    <span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// console.log(err)</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>After writing these core functions, we just need to modify our main program to complete the entire crawler:</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">const</span> queue <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Queue</span><span class="token punctuation">(</span>connection<span class="token punctuation">)</span>
  
  <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  
    <span class="token comment">// 1. 從 Queue 裡面拿出一個 userId</span>
    <span class="token keyword">const</span> userId <span class="token operator">=</span> <span class="token keyword">await</span> queue<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>userId<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'no data from queue, end'</span><span class="token punctuation">)</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
  
    <span class="token comment">// 2. 如果 userId 已存在 Users，回到步驟一</span>
    <span class="token keyword">const</span> check <span class="token operator">=</span> <span class="token keyword">await</span> queue<span class="token punctuation">.</span><span class="token function">check</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>check<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">continue</span>
    <span class="token punctuation">&#125;</span>
  
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'uid:'</span><span class="token punctuation">,</span> userId<span class="token punctuation">)</span>
    <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">const</span> info <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">getUserInfo</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span>
      
      <span class="token comment">// 如果沒抓到資料有可能是被擋了，先停個 3 秒</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>info<span class="token punctuation">.</span>userId<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'sleep...'</span><span class="token punctuation">)</span>
        <span class="token keyword">await</span> <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">3000</span><span class="token punctuation">)</span>
      <span class="token punctuation">&#125;</span>
  
      <span class="token comment">// 3. 把他的資料寫進 Users</span>
      <span class="token function">saveUserInfo</span><span class="token punctuation">(</span>connection<span class="token punctuation">,</span> info<span class="token punctuation">)</span>
  
      <span class="token comment">// 4. 把他的所有 follower 丟進 Queue</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>info<span class="token punctuation">.</span>followerCount <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 把 followers 放到 queue 並印出總共幾筆資料</span>
        <span class="token keyword">const</span> followerList <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">getAllFollowers</span><span class="token punctuation">(</span>userId<span class="token punctuation">,</span> queue<span class="token punctuation">)</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Add '</span> <span class="token operator">+</span> followerList<span class="token punctuation">.</span>length <span class="token operator">+</span> <span class="token string">' into queue.'</span><span class="token punctuation">)</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token comment">// 有錯誤就先睡個 3 秒</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'error...sleep'</span><span class="token punctuation">)</span>
      <span class="token keyword">await</span> <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">3000</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span> 
  <span class="token punctuation">&#125;</span>  
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>The above code is what we wrote according to the previous logic:</p>
<ol>
<li>Take out a userId from the Queue.</li>
<li>If the userId already exists in Users, go back to step 1.</li>
<li>Write the user’s data into Users.</li>
<li>Put all of the user’s followers into the Queue.</li>
<li>Go back to step 1.</li>
</ol>
<p>However, I added an additional logic that when there is a problem calling the API, it will pause for 3 seconds. This is to prevent being rate limited. However, this mechanism is not very good because there is no retry, so once an error occurs, the userId is skipped.</p>
<p>The original idea was that skipping one userId was not a big deal, after all, there may be 100,000 userIds in the queue, and even if it is skipped, it may still be thrown back into the queue later, so not implementing a retry mechanism is okay.</p>
<p>After assembling all of the above code, we have the framework for the first version of the crawler. It runs okay, but it is just slower than expected. Also, the speed at which the queue grows is surprisingly fast. I ran it overnight and the queue had about 100,000 more data, but there were only four or five thousand in users.</p>
<p>However, after running it overnight, I found a fatal error.</p>
<h2><span id="second-version-of-the-crawler-judging-chinese">Second Version of the Crawler: Judging Chinese</span></h2><p>The fatal error is that the original assumption: “The followers of Chinese authors are all Chinese authors” is problematic, and upon careful consideration, this assumption is indeed very unreliable.</p>
<p>So after running the crawler overnight, I found that there were a lot of foreign users in the database. And once there is one, there will be a lot of foreign users in your queue.</p>
<p>To avoid this situation, I decided to start with the self-introduction and nickname, and write a function to determine whether the self-introduction and nickname contain Chinese characters. If they do, then they will be put in. Here, I directly copied the code I found on Stack Overflow, which looks very magical:</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">isChinese</span><span class="token punctuation">(</span>text <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token comment">// @see: https://stackoverflow.com/questions/44669073/regular-expression-to-match-and-split-on-chinese-comma-in-javascript/51941287#51941287</span>
  <span class="token keyword">const</span> regex <span class="token operator">=</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">(\p&#123;Script=Hani&#125;)+</span><span class="token regex-delimiter">/</span><span class="token regex-flags">gu</span></span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> text<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span>regex<span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>After fetching user data from the queue, we perform a check:</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> info <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">getUserInfo</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span>
  
<span class="token comment">// 非中文，直接略過</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isChinese</span><span class="token punctuation">(</span>info<span class="token punctuation">.</span>bio<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">isChinese</span><span class="token punctuation">(</span>info<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">continue</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>When doing this check, I already thought of a potential issue. Some people like to use English in their self-introduction and nickname, even though they are writing in Chinese. This could cause them to be misjudged and not added to the queue.</p>
<p>At the time, I didn’t think it was a big deal since there weren’t many people like that, and it would be troublesome to fix. I had a solution in mind, which was to fetch their recently clapped or published articles and check if the titles were in Chinese. This would be a more accurate way to judge. However, I was too lazy to implement it and decided to let the crawler run for another day.</p>
<p>The next morning, I discovered another problem that I never thought I would encounter.</p>
<h2><span id="crawler-version-3-judging-japanese-users">Crawler Version 3: Judging Japanese Users</span></h2><p>There were a lot of Japanese users in the user list.</p>
<p>Some of them had nicknames or self-introductions in kanji, so they wouldn’t be filtered out by the Chinese check. When I discovered this problem, my first thought was, “If this were an interview, I would definitely be rejected for not thinking of this case…”</p>
<p>To solve this problem, I added a regular expression to check if there were any Japanese characters (excluding kanji):</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">isJapanese</span><span class="token punctuation">(</span>text <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token comment">// @see: https://gist.github.com/ryanmcgrath/982242</span>
  <span class="token keyword">const</span> regexJP <span class="token operator">=</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">[\u3040-\u309F]|[\u30A0-\u30FF]</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">;</span> 
  <span class="token keyword">const</span> jp <span class="token operator">=</span> text<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span>regexJP<span class="token punctuation">)</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>jp <span class="token operator">&amp;&amp;</span> jp<span class="token punctuation">.</span>length <span class="token operator">>=</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> <span class="token boolean">true</span>
  <span class="token punctuation">&#125;</span>
  <span class="token keyword">return</span> <span class="token boolean">false</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>If there were three or more Japanese characters, it would be considered Japanese. I set the quantity because I was afraid that some Taiwanese people might use characters like <code>の</code> and be misjudged. However, a better approach would be to look at the ratio, such as if 80-90% of a sentence was in Chinese, it would be considered Chinese.</p>
<p>The updated check logic is as follows:</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> info <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">getUserInfo</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span>
  
<span class="token comment">// 非中文，直接略過</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isChinese</span><span class="token punctuation">(</span>info<span class="token punctuation">.</span>bio<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">isChinese</span><span class="token punctuation">(</span>info<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">continue</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
  
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isJapanese</span><span class="token punctuation">(</span>info<span class="token punctuation">.</span>bio<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token function">isJapanese</span><span class="token punctuation">(</span>info<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">continue</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>If it’s not Chinese, skip it. Then check if it’s Japanese by looking at the self-introduction or nickname.</p>
<p>Okay, now everything should be fine! So I cleared the data and let the crawler run for another night.</p>
<p>The next day, I realized how naive I was.</p>
<h2><span id="crawler-version-4-refactoring">Crawler Version 4: Refactoring</span></h2><p>When I opened the database, I found that there were still many Japanese users. The reason was that some of them had kanji nicknames and no self-introduction, or only a few words in their self-introduction, so they were still considered Chinese users.</p>
<p>In the end, the unreliable judgment mechanism was the root cause of the problem.</p>
<p>Since things had come to this point, I couldn’t be lazy anymore. I had to implement the more accurate solution I mentioned earlier: “Check if the recently published or clapped articles are in Chinese.” Fortunately, the API provided this data, and it was much easier to implement than I thought.</p>
<p>In addition to this, because the queue was growing much faster than it was being consumed, I changed the method. I wrote another small program that removed the “add followers to the queue” step from the original process and fetched 10 user data at a time.</p>
<p>In other words, this new program simply kept fetching user data and storing it in the database, so the queue would become smaller and the user data would accumulate. It could fetch 20,000 data in an hour, and the queue could be cleared in half a day.</p>
<p>The advantage was that I could quickly accumulate user data. The original implementation was too slow, and I could only fetch about 10,000 data a day. The new implementation didn’t need to add things to the queue, so the user data grew quickly.</p>
<p>At that time, I copied and modified the code to create the new program, which made the code more and more messy. Considering that I wanted to open source it later, it was time to clean up the code, so I refactored the program.</p>
<p>The refactored architecture is as follows:</p>
<pre class="line-numbers language-none"><code class="language-none">.
├── README.md     &#x2F;&#x2F; 說明
├── app.js        &#x2F;&#x2F; 主程式
├── getUsers.js   &#x2F;&#x2F; 只抓使用者資料的小程式 
├── config.js     &#x2F;&#x2F; 設定檔
├── db.js         &#x2F;&#x2F; 資料庫相關
├── medium.js     &#x2F;&#x2F; medium API 相關
├── package.json  
├── queue.js     
└── utils.js       <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>Let’s start with config:</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
  <span class="token literal-property property">db</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    <span class="token literal-property property">connectionLimit</span><span class="token operator">:</span> <span class="token number">10</span><span class="token punctuation">,</span>
    <span class="token literal-property property">host</span>     <span class="token operator">:</span> <span class="token string">''</span><span class="token punctuation">,</span>
    <span class="token literal-property property">user</span>     <span class="token operator">:</span> <span class="token string">''</span><span class="token punctuation">,</span>
    <span class="token literal-property property">password</span> <span class="token operator">:</span> <span class="token string">''</span><span class="token punctuation">,</span>
    <span class="token literal-property property">database</span> <span class="token operator">:</span> <span class="token string">'medium'</span><span class="token punctuation">,</span>
    <span class="token literal-property property">charset</span><span class="token operator">:</span> <span class="token string">'utf8mb4'</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
  <span class="token literal-property property">batchLimit</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token comment">// 一次抓多少筆使用者資料</span>
  <span class="token function-variable function">randomDelay</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> Math<span class="token punctuation">.</span><span class="token function">floor</span><span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">200</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">100</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
  <span class="token literal-property property">errorRateTolerance</span><span class="token operator">:</span> <span class="token number">0.2</span><span class="token punctuation">,</span>
  <span class="token literal-property property">delayWhenError</span><span class="token operator">:</span> <span class="token number">500</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>This is where the configuration files are stored, including the database settings and some parameters for fetching data, most of which are related to the program that fetches user data, such as how many data to fetch and how long to wait between each fetch. These are measures to avoid being blocked by sending too many requests.</p>
<p>Next is utils.js:</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
  <span class="token comment">// @see: https://stackoverflow.com/questions/44669073/regular-expression-to-match-and-split-on-chinese-comma-in-javascript/51941287#51941287</span>
  <span class="token literal-property property">isChinese</span><span class="token operator">:</span> <span class="token punctuation">(</span>text <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">const</span> regex <span class="token operator">=</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">(\p&#123;Script=Hani&#125;)+</span><span class="token regex-delimiter">/</span><span class="token regex-flags">gu</span></span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> text<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span>regex<span class="token punctuation">)</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
  
  <span class="token comment">// @see: https://gist.github.com/ryanmcgrath/982242</span>
  <span class="token literal-property property">isJapanese</span><span class="token operator">:</span> <span class="token punctuation">(</span>text <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">const</span> regexJP <span class="token operator">=</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">[\u3040-\u309F]|[\u30A0-\u30FF]</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">;</span> 
    <span class="token keyword">const</span> jp <span class="token operator">=</span> text<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span>regexJP<span class="token punctuation">)</span>
  
    <span class="token comment">// more than 2 japanese char</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>jp <span class="token operator">&amp;&amp;</span> jp<span class="token punctuation">.</span>length <span class="token operator">>=</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">return</span> <span class="token boolean">true</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
  
  <span class="token function-variable function">sleep</span><span class="token operator">:</span> <span class="token parameter">ms</span> <span class="token operator">=></span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token parameter">resolve</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> ms<span class="token punctuation">)</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  
  <span class="token function-variable function">log</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">const</span> args <span class="token operator">=</span> <span class="token class-name">Array</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>arguments<span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>console<span class="token punctuation">,</span> args<span class="token punctuation">)</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>This is where some functions used earlier are placed, including limiting the number of Japanese characters to two and wrapping console.log to make it easier to customize later.</p>
<p>Then there’s medium.js, which is related to the medium API and adds a function <code>isMandarinUser</code> to check if the user is Chinese:</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> axios <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'axios'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> _ <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'lodash'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> utils <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./utils'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> <span class="token constant">JSON_HIJACKING_PREFIX</span> <span class="token operator">=</span> <span class="token string">'])&#125;while(1);&lt;/x>'</span>
  
<span class="token comment">// wrapper function, return null instead of throwing error</span>
<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">getMediumResponse</span><span class="token punctuation">(</span><span class="token parameter">url</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">const</span> response <span class="token operator">=</span> <span class="token keyword">await</span> axios<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span>
    <span class="token keyword">const</span> json <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span>data<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token constant">JSON_HIJACKING_PREFIX</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> json
  <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> <span class="token keyword">null</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
  
<span class="token keyword">function</span> <span class="token function">isMandarinUser</span><span class="token punctuation">(</span><span class="token parameter">name<span class="token punctuation">,</span> bio<span class="token punctuation">,</span> posts</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  
  <span class="token comment">// if bio or name is japanese, must be japanese</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>utils<span class="token punctuation">.</span><span class="token function">isJapanese</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span> <span class="token operator">||</span> utils<span class="token punctuation">.</span><span class="token function">isJapanese</span><span class="token punctuation">(</span>bio<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span>
  <span class="token punctuation">&#125;</span>
  
   <span class="token comment">// this user has no activity on medium, decide by name and bio</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>posts<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> utils<span class="token punctuation">.</span><span class="token function">isChinese</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span> <span class="token operator">||</span> utils<span class="token punctuation">.</span><span class="token function">isChinese</span><span class="token punctuation">(</span>bio<span class="token punctuation">)</span>
  <span class="token punctuation">&#125;</span>
  
  <span class="token keyword">const</span> contents <span class="token operator">=</span> _<span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span>posts<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">item</span> <span class="token operator">=></span> item<span class="token punctuation">.</span>title <span class="token operator">+</span> _<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>item<span class="token punctuation">,</span> <span class="token string">'content.subtitle'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token keyword">return</span> <span class="token function">Boolean</span><span class="token punctuation">(</span>
    contents<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token parameter">item</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">return</span> utils<span class="token punctuation">.</span><span class="token function">isChinese</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>utils<span class="token punctuation">.</span><span class="token function">isJapanese</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
  <span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span>
  
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
  <span class="token function-variable function">getFollowers</span><span class="token operator">:</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">uid<span class="token punctuation">,</span> to</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> url <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">https://medium.com/_/api/users/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>uid<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">/profile/stream?source=followers&amp;limit=200</span><span class="token template-punctuation string">`</span></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>to<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      url <span class="token operator">+=</span> <span class="token string">'&amp;to='</span> <span class="token operator">+</span> to
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">const</span> json <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">getMediumResponse</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>json<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">return</span> <span class="token keyword">null</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">const</span> followers <span class="token operator">=</span> _<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>json<span class="token punctuation">.</span>payload<span class="token punctuation">.</span>references<span class="token punctuation">.</span>Social<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">const</span> nextTo <span class="token operator">=</span> _<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>json<span class="token punctuation">,</span> <span class="token string">'payload.paging.next.to'</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token punctuation">&#123;</span>
      followers<span class="token punctuation">,</span>
      nextTo
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
  
  <span class="token function-variable function">getUserInfo</span><span class="token operator">:</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">uid</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">const</span> url <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">https://medium.com/_/api/users/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>uid<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">/profile/stream</span><span class="token template-punctuation string">`</span></span>
    <span class="token keyword">const</span> json <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">getMediumResponse</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>json<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">return</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">const</span> userId <span class="token operator">=</span> _<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>json<span class="token punctuation">,</span> <span class="token string">'payload.user.userId'</span><span class="token punctuation">)</span>
    <span class="token keyword">const</span> follower <span class="token operator">=</span> _<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>json<span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">payload.references.SocialStats.</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>userId<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">.usersFollowedByCount</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
  
    <span class="token keyword">const</span> posts <span class="token operator">=</span> _<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>json<span class="token punctuation">,</span> <span class="token string">'payload.references.Post'</span><span class="token punctuation">)</span>
    <span class="token keyword">const</span> name <span class="token operator">=</span> _<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>json<span class="token punctuation">,</span> <span class="token string">'payload.user.name'</span><span class="token punctuation">)</span>
    <span class="token keyword">const</span> bio <span class="token operator">=</span> _<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>json<span class="token punctuation">,</span> <span class="token string">'payload.user.bio'</span><span class="token punctuation">)</span>
  
    <span class="token keyword">return</span> <span class="token punctuation">&#123;</span>
      <span class="token literal-property property">isMandarinUser</span><span class="token operator">:</span> <span class="token function">isMandarinUser</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> bio<span class="token punctuation">,</span> posts<span class="token punctuation">)</span><span class="token punctuation">,</span>
      userId<span class="token punctuation">,</span>
      name<span class="token punctuation">,</span>
      <span class="token literal-property property">username</span><span class="token operator">:</span> _<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>json<span class="token punctuation">,</span> <span class="token string">'payload.user.username'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      bio<span class="token punctuation">,</span>
      <span class="token literal-property property">followerCount</span><span class="token operator">:</span> follower<span class="token punctuation">,</span>
      <span class="token literal-property property">mediumMemberAt</span><span class="token operator">:</span> _<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>json<span class="token punctuation">,</span> <span class="token string">'payload.user.mediumMemberAt'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token literal-property property">isWriterProgramEnrolled</span><span class="token operator">:</span> _<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>json<span class="token punctuation">,</span> <span class="token string">'payload.user.isWriterProgramEnrolled'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token literal-property property">createdAt</span><span class="token operator">:</span> _<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>json<span class="token punctuation">,</span> <span class="token string">'payload.user.createdAt'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>isMandarinUser is determined based on three parameters: nickname, self-introduction, and related articles. Related articles may be the most recently published or clapped articles or replies, and the titles and subtitles of the articles are used to determine if they are in Chinese.</p>
<p>If the user has no activity, the self-introduction and nickname are used to judge, so there is still a possibility of misjudgment, but the misjudgment rate is already quite low in practice.</p>
<p>Next, let’s look at the database-related operations, db.js:</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> mysql <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'mysql'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> moment <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'moment'</span><span class="token punctuation">)</span>
  
<span class="token keyword">function</span> <span class="token function">format</span><span class="token punctuation">(</span><span class="token parameter">time</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>time<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token keyword">null</span>
  <span class="token keyword">return</span> <span class="token function">moment</span><span class="token punctuation">(</span>time<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">'YYYY-MM-DD HH:mm:ss'</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span>
  
<span class="token keyword">function</span> <span class="token function">transform</span><span class="token punctuation">(</span><span class="token parameter">info</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">return</span> <span class="token punctuation">[</span>
    info<span class="token punctuation">.</span>userId<span class="token punctuation">,</span> info<span class="token punctuation">.</span>username<span class="token punctuation">,</span> info<span class="token punctuation">.</span>name<span class="token punctuation">,</span> info<span class="token punctuation">.</span>bio<span class="token punctuation">,</span> info<span class="token punctuation">.</span>followerCount<span class="token punctuation">,</span>
    <span class="token function">format</span><span class="token punctuation">(</span>info<span class="token punctuation">.</span>mediumMemberAt<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">format</span><span class="token punctuation">(</span>info<span class="token punctuation">.</span>createdAt<span class="token punctuation">)</span><span class="token punctuation">,</span> info<span class="token punctuation">.</span>isWriterProgramEnrolled<span class="token punctuation">,</span> <span class="token keyword">null</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">&#125;</span>
  
<span class="token keyword">class</span> <span class="token class-name">DB</span> <span class="token punctuation">&#123;</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">config</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>conn <span class="token operator">=</span> mysql<span class="token punctuation">.</span><span class="token function">createPool</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span>
  <span class="token punctuation">&#125;</span>
  
  <span class="token function">getExistingUserIds</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>conn<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token string">'SELECT userId from Users'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> results</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
          <span class="token keyword">return</span> <span class="token function">reject</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
        <span class="token punctuation">&#125;</span>
       <span class="token keyword">return</span> <span class="token function">resolve</span><span class="token punctuation">(</span>results<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">item</span> <span class="token operator">=></span> item<span class="token punctuation">.</span>userId<span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
  <span class="token punctuation">&#125;</span> 
  
  <span class="token function">getUserIds</span><span class="token punctuation">(</span><span class="token parameter">limit</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>conn<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token string">'SELECT userId from Users where fr="TW" order by follower desc limit '</span> <span class="token operator">+</span> limit<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> results</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
          <span class="token keyword">return</span> <span class="token function">reject</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
        <span class="token punctuation">&#125;</span>
       <span class="token keyword">return</span> <span class="token function">resolve</span><span class="token punctuation">(</span>results<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">item</span> <span class="token operator">=></span> item<span class="token punctuation">.</span>userId<span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
  <span class="token punctuation">&#125;</span> 
  
  <span class="token function">deleteUserIds</span><span class="token punctuation">(</span><span class="token parameter">userIds</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>conn<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token string">'DELETE from Queues WHERE userId IN (?)'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>userIds<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> results</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
          <span class="token keyword">return</span> <span class="token function">reject</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">return</span> <span class="token function">resolve</span><span class="token punctuation">(</span>userIds<span class="token punctuation">)</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
  <span class="token punctuation">&#125;</span>
  
  <span class="token function">insertUserData</span><span class="token punctuation">(</span><span class="token parameter">info</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>info<span class="token punctuation">)</span> <span class="token keyword">return</span>
    <span class="token keyword">const</span> data <span class="token operator">=</span> Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>info<span class="token punctuation">)</span> <span class="token operator">?</span> info<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>transform<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token punctuation">[</span><span class="token function">transform</span><span class="token punctuation">(</span>info<span class="token punctuation">)</span><span class="token punctuation">]</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>conn<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
      INSERT INTO Users
      (
        userId, username, name, bio, follower,
        mediumMemberAt, createdAt, isWriterProgramEnrolled, fr
      ) VALUES ?</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> <span class="token punctuation">[</span>data<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
          <span class="token comment">// console.log(err)</span>
        <span class="token punctuation">&#125;</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">)</span>
  <span class="token punctuation">&#125;</span>
  
  <span class="token function">insertIntoQueue</span><span class="token punctuation">(</span><span class="token parameter">list</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">const</span> values <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> item <span class="token keyword">of</span> list<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        values<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">[</span>item<span class="token punctuation">]</span><span class="token punctuation">)</span>
      <span class="token punctuation">&#125;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>conn<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
        INSERT IGNORE INTO Queues (userId) VALUES ?</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> <span class="token punctuation">[</span>values<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token comment">// console.log(err)</span>
          <span class="token punctuation">&#125;</span>
          <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">&#125;</span>
      <span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
  
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token constant">DB</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>Basically, a bunch of SQL queries are wrapped into Promises and functions to make it easier for other modules to use. Most functions can accept an array for batch operations, which is more efficient.</p>
<p>And after packaging these things, the code for the queue becomes very simple:</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">class</span> <span class="token class-name">Queue</span> <span class="token punctuation">&#123;</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">db</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>db <span class="token operator">=</span> db
  <span class="token punctuation">&#125;</span>
  
  <span class="token keyword">async</span> <span class="token function">get</span><span class="token punctuation">(</span>limit<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">const</span> items <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>db<span class="token punctuation">.</span><span class="token function">getUserIds</span><span class="token punctuation">(</span>limit<span class="token punctuation">)</span>
    <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>db<span class="token punctuation">.</span><span class="token function">deleteUserIds</span><span class="token punctuation">(</span>items<span class="token punctuation">)</span>
    <span class="token keyword">return</span> items
  <span class="token punctuation">&#125;</span>
  
  <span class="token keyword">async</span> <span class="token function">push</span><span class="token punctuation">(</span><span class="token parameter">list</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>db<span class="token punctuation">.</span><span class="token function">insertIntoQueue</span><span class="token punctuation">(</span>list<span class="token punctuation">)</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
  
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> Queue<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>Finally, let’s take a look at our main program app.js. After refactoring, the code becomes much cleaner and more readable:</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> <span class="token constant">DB</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./db'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> Queue <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./queue'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> config <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./config'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> medium <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./medium'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> utils <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./utils'</span><span class="token punctuation">)</span>
  
<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">const</span> db <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DB</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>db<span class="token punctuation">)</span>
  <span class="token keyword">const</span> queue <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Queue</span><span class="token punctuation">(</span>db<span class="token punctuation">)</span>
  <span class="token keyword">const</span> existingUserIds <span class="token operator">=</span> <span class="token keyword">await</span> db<span class="token punctuation">.</span><span class="token function">getExistingUserIds</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> userIdMap <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> userId <span class="token keyword">of</span> existingUserIds<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    userIdMap<span class="token punctuation">[</span>userId<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">true</span>
  <span class="token punctuation">&#125;</span>
  
  utils<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Existing userId:'</span><span class="token punctuation">,</span> existingUserIds<span class="token punctuation">.</span>length<span class="token punctuation">)</span>
  
  <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">const</span> userIds <span class="token operator">=</span> <span class="token keyword">await</span> queue<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>userIds<span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      utils<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Done'</span><span class="token punctuation">)</span>
      <span class="token keyword">break</span>
    <span class="token punctuation">&#125;</span>
  
    <span class="token keyword">const</span> userId <span class="token operator">=</span> userIds<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>userIdMap<span class="token punctuation">[</span>userId<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">continue</span>
    <span class="token punctuation">&#125;</span>
    userIdMap<span class="token punctuation">[</span>userId<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">true</span>
    utils<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'userId:'</span><span class="token punctuation">,</span> userId<span class="token punctuation">)</span>
  
    <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">const</span> userInfo <span class="token operator">=</span> <span class="token keyword">await</span> medium<span class="token punctuation">.</span><span class="token function">getUserInfo</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span>
  
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>userInfo<span class="token punctuation">.</span>userId<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        utils<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'getUerrInfo error, sleep for'</span><span class="token punctuation">,</span> config<span class="token punctuation">.</span>delayWhenError<span class="token punctuation">)</span>
        <span class="token keyword">await</span> utils<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>delayWhenError<span class="token punctuation">)</span>
      <span class="token punctuation">&#125;</span>
  
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>userInfo<span class="token punctuation">.</span>isMandarinUser<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        utils<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>userId<span class="token punctuation">,</span> <span class="token string">'not MandarinUser'</span><span class="token punctuation">)</span>
        <span class="token keyword">continue</span>
      <span class="token punctuation">&#125;</span>
  
      db<span class="token punctuation">.</span><span class="token function">insertUserData</span><span class="token punctuation">(</span>userInfo<span class="token punctuation">)</span>
  
      <span class="token keyword">if</span> <span class="token punctuation">(</span>userInfo<span class="token punctuation">.</span>followerCount <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">let</span> to <span class="token operator">=</span> <span class="token keyword">undefined</span>
        <span class="token keyword">let</span> count <span class="token operator">=</span> <span class="token number">0</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
          <span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token keyword">await</span> medium<span class="token punctuation">.</span><span class="token function">getFollowers</span><span class="token punctuation">(</span>userInfo<span class="token punctuation">.</span>userId<span class="token punctuation">,</span> to<span class="token punctuation">)</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>data<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">break</span>
          <span class="token punctuation">&#125;</span>
          <span class="token keyword">const</span> <span class="token punctuation">&#123;</span> nextTo<span class="token punctuation">,</span> followers <span class="token punctuation">&#125;</span> <span class="token operator">=</span> data
          to <span class="token operator">=</span> nextTo
          count <span class="token operator">+=</span> followers<span class="token punctuation">.</span>length
          utils<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>userInfo<span class="token punctuation">.</span>userId<span class="token punctuation">,</span> <span class="token string">'fetching'</span><span class="token punctuation">,</span> count<span class="token punctuation">,</span> <span class="token string">'followers'</span><span class="token punctuation">)</span>
          <span class="token keyword">await</span> queue<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>followers<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token parameter">uid</span> <span class="token operator">=></span> <span class="token operator">!</span>userIdMap<span class="token punctuation">[</span>uid<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>followers<span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">0</span> <span class="token operator">||</span> <span class="token operator">!</span>to<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">break</span>
          <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      utils<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'sleep for'</span><span class="token punctuation">,</span> config<span class="token punctuation">.</span>delayWhenError<span class="token punctuation">)</span>
      utils<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
      <span class="token keyword">await</span> utils<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>delayWhenError<span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>
  process<span class="token punctuation">.</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span>
  
<span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>There is a mechanism here that is different from before. Previously, every time a userId was taken from the queue, it was checked in the database whether it had been crawled. But this is too inefficient. In this version, the program directly retrieves all data from the database when it is executed, and becomes a map. If there is a value, it means that it has been crawled, and vice versa.</p>
<p>The refactored code looks much better after the module is split, and it is easy to make changes. If it hadn’t been refactored, I wouldn’t dare to open source it…</p>
<p>Here is the refactored code: <a target="_blank" rel="noopener" href="https://github.com/aszx87410/medium-user-crawler">https://github.com/aszx87410/medium-user-crawler</a></p>
<h2><span id="summary">Summary</span></h2><p>There were many pitfalls in the process of writing the crawler, and the most troublesome one was the language detection part. I didn’t think about the case of Japanese characters at first, and it took a lot of time. Laziness also took a lot of time. Originally, I didn’t want to use a more accurate method to do the judgment, but in the end, I had to use it, wasting a lot of time in the middle.</p>
<p>There are many places where this crawler can be improved, such as the execution speed or the language detection part. Currently, after I retrieve the data, I manually mark whether it is Hong Kong, Taiwan, or China, but perhaps a small program can be written to automatically determine it. For example, simplified Chinese is China, and if there are some Cantonese characters, it is Hong Kong, and vice versa. Although it may not be accurate, using a program to assist will be much more convenient.</p>
<p>This article mainly shares my experience in writing this crawler. As long as the data source can be determined to be retrievable, everything else is not a big problem. Plus, this crawler is not very complete (for example, there is no retry mechanism), so it can be implemented in a day or two.</p>
<p>I hope this article has attracted everyone’s attention, and I also hope that everyone can try to crawl data and make interesting data analysis!</p>

    
    </div>
    
    <div class="columns is-variable is-1 is-multiline is-mobile">
    
        <span class="column is-narrow"><a class="tag is-light article-tag" href="/en/tags/Others/">#Others</a></span>
    
    </div>
    
    
    <div class="columns is-mobile is-multiline article-nav">
        <span class="column is-12-mobile is-half-desktop  article-nav-prev">
            
            <a href="/2019/08/09/en/session-and-cookie-part2/">A Brief Discussion on Session and Cookie: Reading RFC Together</a>
            
        </span>
        <span class="column is-12-mobile is-half-desktop  article-nav-next">
            
            <a href="/2019/06/14/en/http-status-code-418-teapot/">The Battle to Save the Teapot: 418 I am a teapot</a>
            
        </span>
    </div>
    
</article>




<div class="comments">
    <h3 class="title is-4">Comments</h3>
    <script src="https://utteranc.es/client.js"
        repo="aszx87410/huli-blog"
        issue-term="title"
        theme="github-light"
        crossorigin="anonymous"
        async>
</script>
</div>

    </div>
</section>
    <footer class="footer">
    <div class="container">
        <div class="columns content">
            <div class="column is-narrow has-text-centered">
                &copy; 2023 Huli&nbsp;
                Powered by <a href="http://hexo.io/" target="_blank">Hexo</a> & <a
                        target="_blank" rel="noopener" href="http://github.com/ppoffice/hexo-theme-minos">Minos</a>
            </div>
            <div class="column is-hidden-mobile"></div>

            
            <div class="column is-narrow">
                <div class="columns is-mobile is-multiline is-centered">
                
                    
                <a class="column is-narrow" title="GitHub" target="_blank" rel="noopener" href="https://github.com/ppoffice/hexo-theme-minos">
                    
                    GitHub
                    
                </a>
                
                </div>
            </div>
            
            
<div class="column is-narrow has-text-centered">
    <div class="dropdown is-up is-right is-hoverable" style="margin-top: -0.2em;">
        <div class="dropdown-trigger">
            <button class="button is-small" aria-haspopup="true">
                <span class="icon">
                    <i class="fas fa-globe"></i>
                </span>
                <span>English</span>
                <span class="icon is-small">
            <i class="fas fa-angle-down" aria-hidden="true"></i>
          </span>
            </button>
        </div>
        <div class="dropdown-menu has-text-left" role="menu" style="top:100%">
            <div class="dropdown-content">
            <!-- NOTE: 永遠回到首頁 -->
            
                <a href="/2019/07/12/medium-crawler/" class="dropdown-item">
                    繁體中文
                </a>
            
            </div>
        </div>
    </div>
</div>

        </div>
    </div>
</footer>
    <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/3.6.3/jquery.min.js"></script>



    
    
    
    
    
    
<script src="//cdnjs.cloudflare.com/ajax/libs/lightgallery/1.6.8/js/lightgallery-all.min.js"></script>
<script>
    (function ($) {
        $(document).ready(function () {
            if (typeof($.fn.lightGallery) === 'function') {
                $('.article.gallery').lightGallery({ selector: '.gallery-item' });
            }
        });
    })(jQuery);
</script>

    
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.0/clipboard.min.js"></script>
    <style>
        .hljs {
            position: relative;
        }

        .hljs .clipboard-btn {
            float: right;
            color: #9a9a9a;
            background: none;
            border: none;
            cursor: pointer;
        }

        .hljs .clipboard-btn:hover {
          color: #8a8a8a;
        }

        .hljs > .clipboard-btn {
            display: none;
            position: absolute;
            right: 4px;
            top: 4px;
        }

        .hljs:hover > .clipboard-btn {
            display: inline;
        }

        .hljs > figcaption > .clipboard-btn {
            margin-right: 4px;
        }
    </style>
    <script>
      $(document).ready(function () {
        $('figure.hljs').each(function(i, figure) {
          var codeId = 'code-' + i;
          var code = figure.querySelector('.code');
          var copyButton = $('<button>Copy <i class="far fa-clipboard"></i></button>');
          code.id = codeId;
          copyButton.addClass('clipboard-btn');
          copyButton.attr('data-clipboard-target-id', codeId);

          var figcaption = figure.querySelector('figcaption');

          if (figcaption) {
            figcaption.append(copyButton[0]);
          } else {
            figure.prepend(copyButton[0]);
          }
        })

        var clipboard = new ClipboardJS('.clipboard-btn', {
          target: function(trigger) {
            return document.getElementById(trigger.getAttribute('data-clipboard-target-id'));
          }
        });
        clipboard.on('success', function(e) {
          e.clearSelection();
        })
      })
    </script>

    
    

    



<script src="/js/script.js?v=3.js"></script>


    
</body>
</html>