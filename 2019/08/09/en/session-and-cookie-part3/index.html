<!DOCTYPE html>
<html class="has-navbar-fixed-top" lang="en">
<head>
    <meta charset="utf-8">
<title>In-depth Session and Cookie: Implementation in Express, PHP, and Rails - Huli&#39;s blog</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="google-adsense-account" content="ca-pub-1121865251398741">
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1121865251398741"
     crossorigin="anonymous"></script>


            
<link href="https://blog.huli.tw/2019/08/09/session-and-cookie-part3/" rel="alternate" hreflang="zh-TW" />
            
    




    
<link rel="canonical" href="https://blog.huli.tw/2019/08/09/en/session-and-cookie-part3/">
    





    <meta name="description" content="IntroductionThis is a series of three articles that I call the Session and Cookie Trilogy. The goal of the series is to discuss this classic topic from shallow to deep, from understanding concepts to">
<meta property="og:type" content="article">
<meta property="og:title" content="In-depth Session and Cookie: Implementation in Express, PHP, and Rails">
<meta property="og:url" content="https://blog.huli.tw/2019/08/09/en/session-and-cookie-part3/index.html">
<meta property="og:site_name" content="Huli&#39;s blog">
<meta property="og:description" content="IntroductionThis is a series of three articles that I call the Session and Cookie Trilogy. The goal of the series is to discuss this classic topic from shallow to deep, from understanding concepts to">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://user-images.githubusercontent.com/2755720/62776748-10456480-bade-11e9-8000-6604aca08c8c.png">
<meta property="article:published_time" content="2019-08-09T14:10:00.000Z">
<meta property="article:modified_time" content="2023-06-20T05:10:49.077Z">
<meta property="article:author" content="Huli">
<meta property="article:tag" content="Web">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://user-images.githubusercontent.com/2755720/62776748-10456480-bade-11e9-8000-6604aca08c8c.png">



<link rel="alternative" href="/atom.xml" title="In-depth Session and Cookie: Implementation in Express, PHP, and Rails" type="application/atom+xml">



<link rel="icon" href="/img/lidemy_logo.png">


<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Ovo|Source+Code+Pro">


<link rel="stylesheet" href="/css/bulma.css?v=2.css">



<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/lightgallery/1.6.8/css/lightgallery.min.css">


<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/line-numbers/prism-line-numbers.min.css" />


<link rel="stylesheet" href="/css/style.css?v=4.css">





    
    
    
    
    
    
    
    
    
    
<script async src="https://www.googletagmanager.com/gtag/js?id=G-1393J2EVCZ"></script>
<script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-1393J2EVCZ');
</script>


    


<meta name="generator" content="Hexo 6.3.0"></head>
<body>
    <script>
        if (localStorage.getItem('dark-mode')) {
            if (localStorage.getItem('dark-mode') === 'true') {
                document.body.classList.add('dark-mode')
            }
        } else {
            if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                document.body.classList.add('dark-mode')
            }
        }
    </script>
    
<nav class="navbar is-transparent is-fixed-top navbar-main" role="navigation" aria-label="main navigation">
    <div class="container">
        <div class="navbar-brand">
            <a class="navbar-item navbar-logo" href="/en">
                
                    
                    Huli&#39;s blog
                    
                
            </a>
            <div class="navbar-burger">
                <span></span>
                <span></span>
                <span></span>
            </div>
        </div>
        
        <div class="navbar-menu navbar-start">
            
            <a class="navbar-item "
               href="/en/archives">Archive</a>
            
            <a class="navbar-item "
               href="/en/categories">Categories</a>
            
            <a class="navbar-item "
               href="/en/about">About</a>
            
        </div>
        
        <div class="navbar-menu navbar-end">
            
            
            <div class="navbar-item is-hoverable has-dropdown is-hidden-mobile is-hidden-tablet-only toc">
                <a class="navbar-item" title="Table of Contents">
                    Table of Contents
                </a>
                <div class="navbar-dropdown">
                    
                    
                    
                    
                    <a class="navbar-item" href="#introduction">1&nbsp;&nbsp;<b>Introduction</b></a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#express">2&nbsp;&nbsp;<b>Express</b></a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#php-version-72">3&nbsp;&nbsp;<b>PHP (version 7.2)</b></a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#rails-version-52">4&nbsp;&nbsp;<b>Rails (version 5.2)</b></a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#conclusion">5&nbsp;&nbsp;<b>Conclusion</b></a>
                    
                </div>
            </div>
            
            
            <a class="navbar-item" target="_blank" title="Twitter" href="https://twitter.com/aszx87410">
                
                <i class="fab fa-twitter"></i>
                
            </a>
               
            <a class="navbar-item" target="_blank" title="RSS" href="/atom-en.xml">
                
                <i class="fas fa-rss"></i>
                
            </a>
               
            
            <a class="navbar-item btn-dark-mode" title="dark-mode" href="#">
                <div>
                    <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" width="15" height="15" viewBox="0 0 256 256" xml:space="preserve">
                    <defs>
                    </defs>
                    <g style="stroke: none; stroke-width: 0; stroke-dasharray: none; stroke-linecap: butt; stroke-linejoin: miter; stroke-miterlimit: 10; fill: none; fill-rule: nonzero; opacity: 1;" transform="translate(1.4065934065934016 1.4065934065934016) scale(2.81 2.81)" >
                        <path d="M 87.823 60.7 c -0.463 -0.423 -1.142 -0.506 -1.695 -0.214 c -15.834 8.398 -35.266 2.812 -44.232 -12.718 c -8.966 -15.53 -4.09 -35.149 11.101 -44.665 c 0.531 -0.332 0.796 -0.963 0.661 -1.574 c -0.134 -0.612 -0.638 -1.074 -1.259 -1.153 c -9.843 -1.265 -19.59 0.692 -28.193 5.66 C 13.8 12.041 6.356 21.743 3.246 33.35 S 1.732 57.08 7.741 67.487 c 6.008 10.407 15.709 17.851 27.316 20.961 C 38.933 89.486 42.866 90 46.774 90 c 7.795 0 15.489 -2.044 22.42 -6.046 c 8.601 -4.966 15.171 -12.43 18.997 -21.586 C 88.433 61.79 88.285 61.123 87.823 60.7 z" style="stroke: none; stroke-width: 1; stroke-dasharray: none; stroke-linecap: butt; stroke-linejoin: miter; stroke-miterlimit: 10; fill: #ffa716; fill-rule: nonzero; opacity: 1;" transform=" matrix(1 0 0 1 0 0) " stroke-linecap="round" />
                    </g>
                    </svg>
                </div>
            </a>
            
               <a class="navbar-item" href="/2019/08/09/session-and-cookie-part3/">中文</a>
            
            

        </div>
    </div>
</nav>

    <section class="section">
    <div class="container">
      
      <div data-nosnippet class="self-notice">
        If you have any thoughts on my blog or articles and you want to let me know, you can either post a comment below(public) or tell me via this <a href="https://forms.gle/SjJZ4cnNs6NnjXQG8" target="_blank">feedback form</a>
      </div>
      
    <article class="article content gallery" itemscope itemprop="blogPost">
    <h1 class="article-title is-size-3 is-size-4-mobile" itemprop="name">
        
            In-depth Session and Cookie: Implementation in Express, PHP, and Rails
        
    </h1>
    <div class="article-meta columns is-variable is-1 is-multiline is-mobile is-size-7-mobile">
        <span class="column is-narrow">
            <time datetime="2019-08-09T14:10:00.000Z" itemprop="datePublished">9 August 2019</time>
        </span>
        
        <span class="column is-narrow article-category">
            <i class="far fa-folder"></i>
            <a class="article-category-link" href="/en/categories/Web/">Web</a>
        </span>
        
        
        
        <spen data-nosnippet class="column is-narrow">(Translated by ChatGPT)</span>
        
    </div>
    
    <div class="article-entry is-size-6-mobile" itemprop="articleBody">
    
        <h2><span id="introduction">Introduction</span></h2><p>This is a series of three articles that I call the Session and Cookie Trilogy. The goal of the series is to discuss this classic topic from shallow to deep, from understanding concepts to understanding implementation methods. This is the last article in the series, and the complete links to the three articles are as follows:</p>
<ol>
<li><a target="_blank" rel="noopener" href="https://medium.com/@hulitw/session-and-cookie-15e47ed838bc">Plain Talk on Session and Cookie: Starting with Running a Grocery Store</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/aszx87410/blog/issues/45">Shallow Talk on Session and Cookie: Let’s Read RFC Together</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/aszx87410/blog/issues/46">In-depth Session and Cookie: Implementation in Express, PHP, and Rails</a></li>
</ol>
<p>The first article talks about Session and Cookie in plain language without too many technical terms. The second article directly looks at the three RFCs of Cookie to understand what Session is, and also supplements some knowledge related to Cookie. This article will delve into Session and take a look at three different Session implementation methods.</p>
<p>These three are Node.js Web framework Express, PHP, and Ruby on Rails. I chose these three because their implementation of Session mechanism is different, and I think they are suitable objects for reference.</p>
<span id="more"></span>

<p>Okay, let’s get started!</p>
<h2><span id="express">Express</span></h2><p><a target="_blank" rel="noopener" href="https://expressjs.com/">Express</a> itself is an extremely lightweight framework with many basic functions under other frameworks, which need to be installed with middleware to use.</p>
<p>Let’s start with a brief introduction to the concept of middleware. In Express, when a Request is received, it is handed over to the corresponding middleware for processing, and after processing, it becomes a Response returned. So the essence of Express is actually a bunch of middleware.</p>
<p>If we explain it with a picture, it would look like this:</p>
<p><img src="https://user-images.githubusercontent.com/2755720/62776748-10456480-bade-11e9-8000-6604aca08c8c.png" alt="Screenshot 2019-08-08 23.22.26"></p>
<p>For example, a basic code segment would look like this:</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> port <span class="token operator">=</span> <span class="token number">5001</span>
  
<span class="token comment">// global 的 middleware</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  req<span class="token punctuation">.</span>greeting <span class="token operator">=</span> <span class="token string">'hello'</span>
  <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
  
<span class="token comment">// 特定 route 的 middleware</span>
app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>greeting<span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
  
app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span>port<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Example app listening on port </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>port<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">!</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>The first middleware is global, so any request will first reach this middleware, and you can set some things for the req or res parameters here, and finally call <code>next</code> to transfer control to the next middleware.</p>
<p>The next middleware can get the information processed by the previous middleware and output the content. If next is not called, it means that you do not want to transfer control to the next middleware.</p>
<p>In Express, the middleware that manages Session is <a target="_blank" rel="noopener" href="https://github.com/expressjs/session">express-session</a>, and the sample code looks like this (rewritten from the official website example):</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> session <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express-session'</span><span class="token punctuation">)</span>
  
<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> port <span class="token operator">=</span> <span class="token number">5001</span>
  
<span class="token comment">// 使用 session middleware</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">session</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
  <span class="token literal-property property">secret</span><span class="token operator">:</span> <span class="token string">'keyboard cat'</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
   
app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  
  <span class="token comment">// 可以用 req.session 拿取存在 session 的值</span>
  <span class="token comment">// 這邊判斷有沒有 req.session.views</span>
  <span class="token comment">// 如果有的話就 +1，反之初始化成 1</span>
  <span class="token comment">// 所以 req.session 可讀也可寫</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>req<span class="token punctuation">.</span>session<span class="token punctuation">.</span>views<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    req<span class="token punctuation">.</span>session<span class="token punctuation">.</span>views<span class="token operator">++</span>
    res<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token string">'views: '</span> <span class="token operator">+</span> req<span class="token punctuation">.</span>session<span class="token punctuation">.</span>views<span class="token punctuation">)</span>
    res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
    req<span class="token punctuation">.</span>session<span class="token punctuation">.</span>views <span class="token operator">=</span> <span class="token number">1</span>
    res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token string">'welcome to the session demo. refresh!'</span><span class="token punctuation">)</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
  
app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span>port<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Example app listening on port </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>port<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">!</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>After using the session middleware, you can directly use <code>req.session.key</code> to access the information you want. The same variable can be written and read, which is similar to PHP’s $_SESSION.</p>
<p>Next, let’s take a look at the express-session code! The main code is in <a target="_blank" rel="noopener" href="https://github.com/expressjs/session/blob/master/index.js">index.js</a>, which is about 700 lines long and is unlikely to be explained line by line.</p>
<p>And well-written libraries will spend a lot of effort on backward compatibility and data validity checks, which are some more trivial and less helpful things for understanding mechanisms.</p>
<p>So I will simply organize the code, remove less important parts, and reorganize the code, and only select relevant paragraphs.</p>
<p>We will focus on three key points:</p>
<ol>
<li>How sessionID is generated</li>
<li>How sessionID is stored</li>
<li>How session information is stored</li>
</ol>
<p>Let’s take a look at where sessionID is generated first:</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// get the session id generate function</span>
<span class="token keyword">var</span> generateId <span class="token operator">=</span> opts<span class="token punctuation">.</span>genid <span class="token operator">||</span> generateSessionId
  
<span class="token comment">// generates the new session</span>
store<span class="token punctuation">.</span><span class="token function-variable function">generate</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">req</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
  req<span class="token punctuation">.</span>sessionID <span class="token operator">=</span> <span class="token function">generateId</span><span class="token punctuation">(</span>req<span class="token punctuation">)</span><span class="token punctuation">;</span>
  req<span class="token punctuation">.</span>session <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Session</span><span class="token punctuation">(</span>req<span class="token punctuation">)</span><span class="token punctuation">;</span>
  req<span class="token punctuation">.</span>session<span class="token punctuation">.</span>cookie <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Cookie</span><span class="token punctuation">(</span>cookieOptions<span class="token punctuation">)</span><span class="token punctuation">;</span>
  
  <span class="token keyword">if</span> <span class="token punctuation">(</span>cookieOptions<span class="token punctuation">.</span>secure <span class="token operator">===</span> <span class="token string">'auto'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    req<span class="token punctuation">.</span>session<span class="token punctuation">.</span>cookie<span class="token punctuation">.</span>secure <span class="token operator">=</span> <span class="token function">issecure</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> trustProxy<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
  
<span class="token keyword">function</span> <span class="token function">generateSessionId</span><span class="token punctuation">(</span><span class="token parameter">sess</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">return</span> <span class="token function">uid</span><span class="token punctuation">(</span><span class="token number">24</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>The customizability of <code>express-session</code> is high, as you can pass in your own function to generate the sessionID. If not passed, it defaults to using <code>uid(24)</code>, where <code>uid</code> refers to the <a target="_blank" rel="noopener" href="https://github.com/crypto-utils/uid-safe">uid-safe</a> library, which generates a random ID of length 24 bytes.</p>
<p>The documentation specifically mentions this length:</p>
<blockquote>
<p>Asynchronously create a UID with a specific byte length. Because base64 encoding is used underneath, this is not the string length. For example, to create a UID of length 24, you want a byte length of 18.</p>
</blockquote>
<p>So if you input 24, the resulting string will have a length of 32 characters.</p>
<p>So how is this sessionID stored in a cookie?</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">var</span> cookie <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'cookie'</span><span class="token punctuation">)</span>
<span class="token keyword">var</span> signature <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'cookie-signature'</span><span class="token punctuation">)</span>
  
<span class="token comment">// get the session cookie name</span>
<span class="token keyword">var</span> name <span class="token operator">=</span> opts<span class="token punctuation">.</span>name <span class="token operator">||</span> opts<span class="token punctuation">.</span>key <span class="token operator">||</span> <span class="token string">'connect.sid'</span>
  
<span class="token comment">// get the cookie signing secret</span>
<span class="token keyword">var</span> secret <span class="token operator">=</span> opts<span class="token punctuation">.</span>secret
  
<span class="token keyword">if</span> <span class="token punctuation">(</span>secret <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>secret<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  secret <span class="token operator">=</span> <span class="token punctuation">[</span>secret<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
  
<span class="token comment">// set-cookie</span>
<span class="token function">onHeaders</span><span class="token punctuation">(</span>res<span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
  
  <span class="token comment">// set cookie</span>
  <span class="token function">setcookie</span><span class="token punctuation">(</span>res<span class="token punctuation">,</span> name<span class="token punctuation">,</span> req<span class="token punctuation">.</span>sessionID<span class="token punctuation">,</span> secrets<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> req<span class="token punctuation">.</span>session<span class="token punctuation">.</span>cookie<span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  
<span class="token keyword">function</span> <span class="token function">setcookie</span><span class="token punctuation">(</span><span class="token parameter">res<span class="token punctuation">,</span> name<span class="token punctuation">,</span> val<span class="token punctuation">,</span> secret<span class="token punctuation">,</span> options</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">var</span> signed <span class="token operator">=</span> <span class="token string">'s:'</span> <span class="token operator">+</span> signature<span class="token punctuation">.</span><span class="token function">sign</span><span class="token punctuation">(</span>val<span class="token punctuation">,</span> secret<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> data <span class="token operator">=</span> cookie<span class="token punctuation">.</span><span class="token function">serialize</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> signed<span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">;</span>
  
  <span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">'set-cookie %s'</span><span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>
  
  <span class="token keyword">var</span> prev <span class="token operator">=</span> res<span class="token punctuation">.</span><span class="token function">getHeader</span><span class="token punctuation">(</span><span class="token string">'Set-Cookie'</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
  <span class="token keyword">var</span> header <span class="token operator">=</span> Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>prev<span class="token punctuation">)</span> <span class="token operator">?</span> prev<span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token punctuation">[</span>prev<span class="token punctuation">,</span> data<span class="token punctuation">]</span><span class="token punctuation">;</span>
  
  res<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token string">'Set-Cookie'</span><span class="token punctuation">,</span> header<span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>The key for the sessionID stored in the cookie can also be specified, but the default is <code>connect.sid</code>, so when you see this key, you know it is the default sessionID name for <code>express-session</code>.</p>
<p>The content is a bit special, starting with <code>s:</code> followed by the result of <code>signature.sign(sessionID, secret)</code>.</p>
<p>Here, we need to look at the <a target="_blank" rel="noopener" href="https://github.com/tj/node-cookie-signature">cookie-signature</a> library, with a simple example below:</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">var</span> cookie <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'cookie-signature'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  
<span class="token keyword">var</span> val <span class="token operator">=</span> cookie<span class="token punctuation">.</span><span class="token function">sign</span><span class="token punctuation">(</span><span class="token string">'hello'</span><span class="token punctuation">,</span> <span class="token string">'tobiiscool'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
val<span class="token punctuation">.</span>should<span class="token punctuation">.</span><span class="token function">equal</span><span class="token punctuation">(</span><span class="token string">'hello.DGDUkGlIkCzPz+C0B064FNgHdEjox7ch8tOBGslZ5QI'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>What does the <code>sign</code> function do? The source code is simple:</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">var</span> crypto <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'crypto'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  
<span class="token comment">/**
 * Sign the given `val` with `secret`.
 *
 * @param &#123;String&#125; val
 * @param &#123;String&#125; secret
 * @return &#123;String&#125;
 * @api private
 */</span>
  
exports<span class="token punctuation">.</span><span class="token function-variable function">sign</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">val<span class="token punctuation">,</span> secret</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">'string'</span> <span class="token operator">!=</span> <span class="token keyword">typeof</span> val<span class="token punctuation">)</span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">TypeError</span><span class="token punctuation">(</span><span class="token string">"Cookie value must be provided as a string."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">'string'</span> <span class="token operator">!=</span> <span class="token keyword">typeof</span> secret<span class="token punctuation">)</span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">TypeError</span><span class="token punctuation">(</span><span class="token string">"Secret string must be provided."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> val <span class="token operator">+</span> <span class="token string">'.'</span> <span class="token operator">+</span> crypto
    <span class="token punctuation">.</span><span class="token function">createHmac</span><span class="token punctuation">(</span><span class="token string">'sha256'</span><span class="token punctuation">,</span> secret<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">digest</span><span class="token punctuation">(</span><span class="token string">'base64'</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\=+$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>It simply generates a <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Cryptographic_hash_function">digest</a> using hmac-sha256 for the content to be signed, and appends it to the end of the string, with <code>.</code> used to separate the data.</p>
<p>If you don’t know what hmac is, it is simply a way to generate a digest for a message, to ensure data integrity and prevent tampering. You can think of it as a unique code corresponding to the message. If the message is changed, the code will also be different.</p>
<p>In the example above, <code>hello</code> is signed using the <code>tobiiscool</code> secret, resulting in <code>DGDUkGlIkCzPz+C0B064FNgHdEjox7ch8tOBGslZ5QI</code>. The complete string becomes <code>hello.DGDUkGlIkCzPz+C0B064FNgHdEjox7ch8tOBGslZ5QI</code>, with my data in front and the digest at the end.</p>
<p>If someone tries to tamper with the data, such as changing the front to <code>hello2</code>, the digest will not match the new data, and I will know that someone has tampered with the data. Therefore, this method is used to ensure data integrity, and the principle is similar to <a target="_blank" rel="noopener" href="https://jwt.io/">JWT</a>. You can see the data, but you cannot change it, because any changes will be detected.</p>
<p>You may wonder: why not encrypt the entire sessionID? Why use this method? I guess it’s because the original data is not afraid of being seen by others, but only afraid of being changed. If the original data is sensitive information, encryption will be used. However, since the original data is only the sessionID, it doesn’t matter if it is seen by others, as long as data integrity is ensured. Moreover, encryption requires more system resources than this message verification, so this method is used.</p>
<p>So, going back to the beginning, <code>express-session</code> stores the sessionID in a cookie, with the key being <code>connect.sid</code>, and the value being <code>s:&#123;sessionID&#125;.&#123;hmac-sha256(sessionID, secret)&#125;</code>.</p>
<p>If you are curious, you can go to any website that uses Express and check the cookie content to find the actual data (or run one yourself). Here’s an example using my own: my <code>connect.sid</code> is <code>s%3AfZZVCDHefchle2LDK4PzghaR3Ao9NruG.J%2BsOPkTubkeMJ4EMBcnunPXW0Y7TWTucRSKIPNVgnRM</code>, which becomes <code>s:fZZVCDHefchle2LDK4PzghaR3Ao9NruG.J+sOPkTubkeMJ4EMBcnunPXW0Y7TWTucRSKIPNVgnRM</code> after decoding special characters.</p>
<p>In other words, my sessionID is <code>fZZVCDHefchle2LDK4PzghaR3Ao9NruG</code>, and the authentication code is <code>J+sOPkTubkeMJ4EMBcnunPXW0Y7TWTucRSKIPNVgnRM</code>.</p>
<p>After knowing how to store the sessionID, it should be easy to understand how to retrieve it from the cookie by simply reversing the process:</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// get the session ID from the cookie</span>
<span class="token keyword">var</span> cookieId <span class="token operator">=</span> req<span class="token punctuation">.</span>sessionID <span class="token operator">=</span> <span class="token function">getcookie</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> name<span class="token punctuation">,</span> secrets<span class="token punctuation">)</span><span class="token punctuation">;</span>
  
<span class="token keyword">function</span> <span class="token function">getcookie</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> name<span class="token punctuation">,</span> secrets</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">var</span> header <span class="token operator">=</span> req<span class="token punctuation">.</span>headers<span class="token punctuation">.</span>cookie<span class="token punctuation">;</span>
  <span class="token keyword">var</span> raw<span class="token punctuation">;</span>
  <span class="token keyword">var</span> val<span class="token punctuation">;</span>
  
  <span class="token comment">// read from cookie header</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>header<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">var</span> cookies <span class="token operator">=</span> cookie<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>header<span class="token punctuation">)</span><span class="token punctuation">;</span>
  
    raw <span class="token operator">=</span> cookies<span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token punctuation">;</span>
  
    <span class="token keyword">if</span> <span class="token punctuation">(</span>raw<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>raw<span class="token punctuation">.</span><span class="token function">substr</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token string">'s:'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        val <span class="token operator">=</span> <span class="token function">unsigncookie</span><span class="token punctuation">(</span>raw<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> secrets<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>val <span class="token operator">===</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
          <span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">'cookie signature invalid'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          val <span class="token operator">=</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
      <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
        <span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">'cookie unsigned'</span><span class="token punctuation">)</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>
  
  <span class="token keyword">return</span> val<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
  
<span class="token comment">/**
 * Verify and decode the given `val` with `secrets`.
 *
 * @param &#123;String&#125; val
 * @param &#123;Array&#125; secrets
 * @returns &#123;String|Boolean&#125;
 * @private
 */</span>
<span class="token keyword">function</span> <span class="token function">unsigncookie</span><span class="token punctuation">(</span><span class="token parameter">val<span class="token punctuation">,</span> secrets</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> secrets<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">var</span> result <span class="token operator">=</span> signature<span class="token punctuation">.</span><span class="token function">unsign</span><span class="token punctuation">(</span>val<span class="token punctuation">,</span> secrets<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  
    <span class="token keyword">if</span> <span class="token punctuation">(</span>result <span class="token operator">!==</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">return</span> result<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>
  
  <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>Now, the last question remains: where is the session information stored? Is it stored in memory, files, or somewhere else?</p>
<p>Actually, this is clearly written in the code. By default, it is stored in memory:</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">var</span> warning <span class="token operator">=</span> <span class="token string">'Warning: connect.session() MemoryStore is not\n'</span>
  <span class="token operator">+</span> <span class="token string">'designed for a production environment, as it will leak\n'</span>
  <span class="token operator">+</span> <span class="token string">'memory, and will not scale past a single process.'</span><span class="token punctuation">;</span>
  
<span class="token comment">// get the session store</span>
<span class="token keyword">var</span> store <span class="token operator">=</span> opts<span class="token punctuation">.</span>store <span class="token operator">||</span> <span class="token keyword">new</span> <span class="token class-name">MemoryStore</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  
<span class="token comment">// notify user that this store is not</span>
<span class="token comment">// meant for a production environment</span>
<span class="token comment">/* istanbul ignore next: not tested */</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>env <span class="token operator">===</span> <span class="token string">'production'</span> <span class="token operator">&amp;&amp;</span> store <span class="token keyword">instanceof</span> <span class="token class-name">MemoryStore</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  console<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span>warning<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>So how is it stored? You can refer to <a target="_blank" rel="noopener" href="https://github.com/expressjs/session/blob/master/session/memory.js">session&#x2F;memory.js</a>:</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">MemoryStore</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token function">Store</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>sessions <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span>
  
<span class="token class-name">MemoryStore</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">get</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token parameter">sessionId<span class="token punctuation">,</span> callback</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token function">defer</span><span class="token punctuation">(</span>callback<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token function">getSession</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> sessionId<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span>
  
<span class="token class-name">MemoryStore</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">set</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token function">set</span><span class="token punctuation">(</span><span class="token parameter">sessionId<span class="token punctuation">,</span> session<span class="token punctuation">,</span> callback</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>sessions<span class="token punctuation">[</span>sessionId<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>session<span class="token punctuation">)</span>
  callback <span class="token operator">&amp;&amp;</span> <span class="token function">defer</span><span class="token punctuation">(</span>callback<span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span>
  
<span class="token keyword">function</span> <span class="token function">getSession</span><span class="token punctuation">(</span><span class="token parameter">sessionId</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">var</span> sess <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>sessions<span class="token punctuation">[</span>sessionId<span class="token punctuation">]</span>
  
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>sess<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span>
  <span class="token punctuation">&#125;</span>
  
  <span class="token comment">// parse</span>
  sess <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>sess<span class="token punctuation">)</span>
  
  <span class="token keyword">return</span> sess
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>First, create a clean object using <code>Object.create(null)</code> (this is a common method, for those who haven’t seen it before, you can refer to: <a target="_blank" rel="noopener" href="https://juejin.im/post/5acd8ced6fb9a028d444ee4e">Detailed Explanation of Object.create(null)</a>). Then, use the sessionID as the key and <code>JSON.stringify(session)</code> as the value, and store it in this object.</p>
<p>So, in essence, the session information of express-session is stored in a variable by default, so if you end the process and restart it, all session data will be lost. There may also be memory leak issues, so it is not recommended for production use.</p>
<p>If you want to use it in production, you must find a <code>store</code> to use, such as <a target="_blank" rel="noopener" href="https://github.com/tj/connect-redis#readme">connect-redis</a>, which can be used with express-session to store session information in redis.</p>
<p>The above is the original code analysis of the commonly used middleware in Express: express-session. From the above paragraphs, we clearly know how the sessionID is generated and how it is stored in cookies, as well as where the session information is stored.</p>
<h2><span id="php-version-72">PHP (version 7.2)</span></h2><p>PHP has built-in session mechanism, so you don’t need to use any framework, and the usage is also very simple:</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token function">session_start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">empty</span><span class="token punctuation">(</span><span class="token variable">$_SESSION</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'views'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token variable">$_SESSION</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'views'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
  <span class="token variable">$_SESSION</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'views'</span><span class="token punctuation">]</span><span class="token operator">++</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
  
<span class="token keyword">echo</span> <span class="token variable">$_SESSION</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'views'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token delimiter important">?></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>In fact, it is similar to the usage of express-session, except that one is <code>req.session</code> and the other is <code>$_SESSION</code>.</p>
<p>I originally wanted to look at the PHP source code directly, just like I did with express-session, and then find out how to implement it. However, because PHP’s source code is all in C, it is difficult for someone like me who has hardly written C to understand, so I can only do it the other way around. First, I will introduce how PHP’s Session mechanism is implemented, and then look for evidence from the source code.</p>
<p>First of all, PHP’s Session mechanism is similar to express-session, both of which store a sessionID in a cookie and store session information on the server. express-session is stored in memory by default, while PHP is stored in a file by default.</p>
<p>All of these can be adjusted in the PHP configuration file, which is written in <code>php.ini</code>. Below is an example of some related settings in my file:</p>
<pre class="line-numbers language-ini" data-language="ini"><code class="language-ini"><span class="token section"><span class="token punctuation">[</span><span class="token section-name selector">Session</span><span class="token punctuation">]</span></span>
<span class="token comment">; Handler used to store/retrieve data.</span>
<span class="token comment">; http://php.net/session.save-handler</span>
<span class="token key attr-name">session.save_handler</span><span class="token punctuation">=</span><span class="token value attr-value">files</span>
  
<span class="token comment">; Argument passed to save_handler.  In the case of files, this is the path</span>
<span class="token comment">; where data files are stored. Note: Windows users have to change this</span>
<span class="token comment">; variable in order to use PHP's session functions.</span>
<span class="token comment">;</span>
<span class="token comment">; The path can be defined as:</span>
<span class="token comment">;</span>
<span class="token comment">;     session.save_path = "N;/path"</span>
  
<span class="token key attr-name">session.save_path</span><span class="token punctuation">=</span><span class="token value attr-value">"<span class="token inner-value">/opt/lampp/temp/</span>"</span>
  
<span class="token comment">; Name of the session (used as cookie name).</span>
<span class="token comment">; http://php.net/session.name</span>
<span class="token key attr-name">session.name</span><span class="token punctuation">=</span><span class="token value attr-value">PHPSESSID</span>
  
<span class="token comment">; Handler used to serialize data.  php is the standard serializer of PHP.</span>
<span class="token comment">; http://php.net/session.serialize-handler</span>
<span class="token key attr-name">session.serialize_handler</span><span class="token punctuation">=</span><span class="token value attr-value">php</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>In the cookie, you can see a <code>PHPSESSID</code>, which looks something like this: <code>fc46356f83dcf5712205d78c51b47c4d</code>, which is the sessionID used by PHP.</p>
<p>Then, you can check <code>session.save_path</code> to see where your session information is stored. The file name is easy to recognize, it is <code>sess_</code> plus the sessionID:</p>
<pre class="line-numbers language-none"><code class="language-none">root@debian:&#x2F;opt&#x2F;lampp&#x2F;temp# ls
  
adminer.invalid
adminer.version
sess_04719a35fb67786d574ec6eca969f7cb
sess_fc46356f83dcf5712205d78c51b47c4d<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>If you open the session file, the content will be the result after serialization:</p>
<pre class="line-numbers language-none"><code class="language-none">views|i:5;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>This is the true face of PHP session. All session information is stored in a file.</p>
<p>If you want to study the relevant source code of PHP session, the most important files are these two: <a target="_blank" rel="noopener" href="https://github.com/php/php-src/blob/PHP-7.2/ext/session/session.c">ext&#x2F;session&#x2F;session.c</a> and <a target="_blank" rel="noopener" href="https://github.com/php/php-src/blob/PHP-7.2/ext/session/mod_files.c">ext&#x2F;session&#x2F;mod_files.c</a>. The former manages the session life cycle, and the latter is responsible for storing or reading the session in the file. The latter is actually similar to the Store we saw in express-session. As long as you follow the same interface, you can write another mod yourself, such as mod_redis.c.</p>
<p>Next, let’s find out how the sessionID is generated. You can directly search for relevant keywords in mod_files.c, and you will find the following code:</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/*
 * Create session ID.
 * PARAMETERS: PS_CREATE_SID_ARGS in php_session.h
 * RETURN VALUE: Valid session ID(zend_string *) or NULL for FAILURE.
 *
 * PS_CREATE_SID_FUNC() must check collision. i.e. Check session data if
 * new sid exists already.
 * *mod_data is guaranteed to have non-NULL value.
 * NOTE: Default php_session_create_id() does not check collision. If
 * NULL is returned, session module create new ID by using php_session_create_id().
 * If php_session_create_id() fails due to invalid configuration, it raises E_ERROR.
 * NULL return value checks from php_session_create_id() is not required generally.
 */</span>
<span class="token function">PS_CREATE_SID_FUNC</span><span class="token punctuation">(</span>files<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
  zend_string <span class="token operator">*</span>sid<span class="token punctuation">;</span>
  <span class="token keyword">int</span> maxfail <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>
  PS_FILES_DATA<span class="token punctuation">;</span>
  
  <span class="token keyword">do</span> <span class="token punctuation">&#123;</span>
    sid <span class="token operator">=</span> <span class="token function">php_session_create_id</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>sid<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">--</span>maxfail <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">continue</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token comment">/* Check collision */</span>
    <span class="token comment">/* FIXME: mod_data(data) should not be NULL (User handler could be NULL) */</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>data <span class="token operator">&amp;&amp;</span> <span class="token function">ps_files_key_exists</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> <span class="token function">ZSTR_VAL</span><span class="token punctuation">(</span>sid<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> SUCCESS<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>sid<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token function">zend_string_release</span><span class="token punctuation">(</span>sid<span class="token punctuation">)</span><span class="token punctuation">;</span>
        sid <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">--</span>maxfail <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span> <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token operator">!</span>sid<span class="token punctuation">)</span><span class="token punctuation">;</span>
  
  <span class="token keyword">return</span> sid<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>Here, <code>php_session_create_id</code> is called to generate the sessionID, and then it checks if there are any duplicate IDs generated, retrying up to three times if necessary. <code>php_session_create_id</code> is located in the session.c file:</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">PS_EXTRA_RAND_BYTES</span> <span class="token expression"><span class="token number">60</span></span></span>
  
PHPAPI zend_string <span class="token operator">*</span><span class="token function">php_session_create_id</span><span class="token punctuation">(</span>PS_CREATE_SID_ARGS<span class="token punctuation">)</span> <span class="token comment">/* &#123;&#123;&#123; */</span>
<span class="token punctuation">&#123;</span>
  <span class="token keyword">unsigned</span> <span class="token keyword">char</span> rbuf<span class="token punctuation">[</span>PS_MAX_SID_LENGTH <span class="token operator">+</span> PS_EXTRA_RAND_BYTES<span class="token punctuation">]</span><span class="token punctuation">;</span>
  zend_string <span class="token operator">*</span>outid<span class="token punctuation">;</span>
  
  <span class="token comment">/* Read additional PS_EXTRA_RAND_BYTES just in case CSPRNG is not safe enough */</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">php_random_bytes_throw</span><span class="token punctuation">(</span>rbuf<span class="token punctuation">,</span> <span class="token function">PS</span><span class="token punctuation">(</span>sid_length<span class="token punctuation">)</span> <span class="token operator">+</span> PS_EXTRA_RAND_BYTES<span class="token punctuation">)</span> <span class="token operator">==</span> FAILURE<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  
  outid <span class="token operator">=</span> <span class="token function">zend_string_alloc</span><span class="token punctuation">(</span><span class="token function">PS</span><span class="token punctuation">(</span>sid_length<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">ZSTR_LEN</span><span class="token punctuation">(</span>outid<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">bin_to_readable</span><span class="token punctuation">(</span>rbuf<span class="token punctuation">,</span> <span class="token function">PS</span><span class="token punctuation">(</span>sid_length<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">ZSTR_VAL</span><span class="token punctuation">(</span>outid<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">char</span><span class="token punctuation">)</span><span class="token function">PS</span><span class="token punctuation">(</span>sid_bits_per_character<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  
  <span class="token keyword">return</span> outid<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>The key point is actually only this one: <code>php_random_bytes_throw</code>. If you continue to trace it, you will find <a target="_blank" rel="noopener" href="https://github.com/php/php-src/blob/623911f993f39ebbe75abe2771fc89faf6b15b9b/ext/standard/php_random.h#L32">ext&#x2F;standard&#x2F;php_random.h</a>, and then find <a target="_blank" rel="noopener" href="https://github.com/php/php-src/blob/8fc58a1a1d32dd288bf4b9e09f9302a99d7b35fe/ext/standard/random.c#L89">ext&#x2F;standard&#x2F;random.c</a>, which is the actual place where random numbers are generated.</p>
<p>However, it takes a long time to understand the function found at the end, so I didn’t look into it in detail. In any case, there are different ways of generating sessionIDs on different operating systems, one of which even uses <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki//dev/random">&#x2F;dev&#x2F;urandom</a>.</p>
<p>After knowing how the sessionID is generated, let’s take a look at how PHP serializes session information. You can see a function called <code>session_encode</code> in the <a target="_blank" rel="noopener" href="https://www.php.net/manual/en/function.session-encode.php">official documentation</a>, and the output is exactly the same as the data we see in the session file. The description of this function is:</p>
<blockquote>
<p>session_encode() returns a serialized string of the contents of the current session data stored in the $_SESSION superglobal.</p>
</blockquote>
<blockquote>
<p>By default, the serialization method used is internal to PHP, and is not the same as serialize(). The serialization method can be set using session.serialize_handler.</p>
</blockquote>
<p>Next, we directly search for <code>session_encode</code> in session.c, and find this section:</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/* &#123;&#123;&#123; proto string session_encode(void)
   Serializes the current setup and returns the serialized representation */</span>
<span class="token keyword">static</span> <span class="token function">PHP_FUNCTION</span><span class="token punctuation">(</span>session_encode<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
  zend_string <span class="token operator">*</span>enc<span class="token punctuation">;</span>
  
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">zend_parse_parameters_none</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> FAILURE<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  
  enc <span class="token operator">=</span> <span class="token function">php_session_encode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>enc <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    RETURN_FALSE<span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  
  <span class="token function">RETURN_STR</span><span class="token punctuation">(</span>enc<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>It’s just a wrapper for <code>php_session_encode</code>, and <code>php_session_encode</code> just calls something else:</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">static</span> zend_string <span class="token operator">*</span><span class="token function">php_session_encode</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token comment">/* &#123;&#123;&#123; */</span>
<span class="token punctuation">&#123;</span>
  <span class="token function">IF_SESSION_VARS</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">PS</span><span class="token punctuation">(</span>serializer<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token function">php_error_docref</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> E_WARNING<span class="token punctuation">,</span> <span class="token string">"Unknown session.serialize_handler. Failed to encode session object"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">return</span> <span class="token function">PS</span><span class="token punctuation">(</span>serializer<span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">encode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
    <span class="token function">php_error_docref</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> E_WARNING<span class="token punctuation">,</span> <span class="token string">"Cannot encode non-existent session"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span class="token comment">/* &#125;&#125;&#125; */</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>The key point is <code>return PS(serializer)-&gt;encode();</code>. Actually, when you get to this point, you may get stuck because you don’t know where <code>serializer</code> comes from. But if you look down a bit, you’ll find something that should be related:</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">PS_DELIMITER</span> <span class="token char">'|'</span></span>
  
<span class="token function">PS_SERIALIZER_ENCODE_FUNC</span><span class="token punctuation">(</span>php<span class="token punctuation">)</span> <span class="token comment">/* &#123;&#123;&#123; */</span>
<span class="token punctuation">&#123;</span>
  smart_str buf <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token number">0</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
  <span class="token class-name">php_serialize_data_t</span> var_hash<span class="token punctuation">;</span>
  PS_ENCODE_VARS<span class="token punctuation">;</span>
  
  <span class="token function">PHP_VAR_SERIALIZE_INIT</span><span class="token punctuation">(</span>var_hash<span class="token punctuation">)</span><span class="token punctuation">;</span>
  
  <span class="token function">PS_ENCODE_LOOP</span><span class="token punctuation">(</span>
    <span class="token function">smart_str_appendl</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>buf<span class="token punctuation">,</span> <span class="token function">ZSTR_VAL</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">ZSTR_LEN</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">memchr</span><span class="token punctuation">(</span><span class="token function">ZSTR_VAL</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">,</span> PS_DELIMITER<span class="token punctuation">,</span> <span class="token function">ZSTR_LEN</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token function">PHP_VAR_SERIALIZE_DESTROY</span><span class="token punctuation">(</span>var_hash<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">smart_str_free</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token function">smart_str_appendc</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>buf<span class="token punctuation">,</span> PS_DELIMITER<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">php_var_serialize</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>buf<span class="token punctuation">,</span> struc<span class="token punctuation">,</span> <span class="token operator">&amp;</span>var_hash<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
  
  <span class="token function">smart_str_0</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
  
  <span class="token function">PHP_VAR_SERIALIZE_DESTROY</span><span class="token punctuation">(</span>var_hash<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> buf<span class="token punctuation">.</span>s<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span class="token comment">/* &#125;&#125;&#125; */</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>You will know it is related because of the line <code>#define PS_DELIMITER &#39;|&#39;</code>, which appears in the session file, and you can guess that it is used to separate something. The actual value is handled by <code>php_var_serialize</code>.</p>
<p>If you continue to trace <code>php_var_serialize</code>, you can find <a target="_blank" rel="noopener" href="https://github.com/php/php-src/blob/7686b0b88906e2522300b9e631ddde2051de839f/ext/standard/var.c#L1112">ext&#x2F;standard&#x2F;var.c</a> (you can easily find this file using GitHub’s search function), and finally you will find the real processing place: <a target="_blank" rel="noopener" href="https://github.com/php/php-src/blob/7686b0b88906e2522300b9e631ddde2051de839f/ext/standard/var.c#L883">php_var_serialize_intern</a>, which calls different functions for different forms.</p>
<p>For our example, the views stored in the session are represented by a number, so it will run this function:</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">inline</span> <span class="token keyword">void</span> <span class="token function">php_var_serialize_long</span><span class="token punctuation">(</span>smart_str <span class="token operator">*</span>buf<span class="token punctuation">,</span> zend_long val<span class="token punctuation">)</span> <span class="token comment">/* &#123;&#123;&#123; */</span>
<span class="token punctuation">&#123;</span>
  <span class="token function">smart_str_appendl</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> <span class="token string">"i:"</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">smart_str_append_long</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> val<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">smart_str_appendc</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> <span class="token char">';'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span class="token comment">/* &#125;&#125;&#125; */</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>By following this, we can see why the serialized session result was <code>views|i:5;</code>. The <code>|</code> is used to separate the key and value, <code>i</code> represents the type, <code>5</code> represents the actual number, and <code>;</code> is the end symbol.</p>
<p>The above is the related source code analysis of PHP Session mechanism. We have briefly looked at how to generate sessionID and how to serialize session information. We also know that by default, the cookie name will be called PHPSESSID, and the session content will be stored in a file.</p>
<p>Finally, I would like to share two interesting articles related to PHP Session:</p>
<ol>
<li><a target="_blank" rel="noopener" href="https://blog.orange.tw/2018/10/hitcon-ctf-2018-one-line-php-challenge.html">HITCON CTF 2018 - One Line PHP Challenge</a></li>
<li><a target="_blank" rel="noopener" href="https://cyku.tw/lfi-leads-to-rce-via-session-file/">[Web Security] LFI Leads to RCE via Session File</a></li>
</ol>
<h2><span id="rails-version-52">Rails (version 5.2)</span></h2><p>Rails is a Ruby web framework, commonly known as Ruby on Rails. I chose this framework because I already knew that its method of storing sessions is different. I was curious about how Rails generates sessionIDs, so I searched for “session” in the GitHub repo and found this file: <a target="_blank" rel="noopener" href="https://github.com/rails/rails/blob/5-2-stable/actionpack/test/dispatch/session/cookie_store_test.rb">rails&#x2F;actionpack&#x2F;test&#x2F;dispatch&#x2F;session&#x2F;cookie_store_test.rb</a>. It is a test, but sometimes tests are very helpful in finding code because they contain a lot of related functions and parameters.</p>
<p>I observed it for a while and found that the term “session_id” appeared many times in the file. So I used this keyword to search and found <a target="_blank" rel="noopener" href="https://github.com/rails/rails/blob/5-2-stable/actionpack/lib/action_dispatch/middleware/session/cookie_store.rb">rails&#x2F;actionpack&#x2F;lib&#x2F;action_dispatch&#x2F;middleware&#x2F;session&#x2F;cookie_store.rb</a>, where the comments clearly explain how Rails implements sessions:</p>
<pre class="line-numbers language-ruby" data-language="ruby"><code class="language-ruby"><span class="token comment"># This cookie-based session store is the Rails default. It is</span>
<span class="token comment"># dramatically faster than the alternatives.</span>
<span class="token comment">#</span>
<span class="token comment"># Sessions typically contain at most a user_id and flash message; both fit</span>
<span class="token comment"># within the 4K cookie size limit. A CookieOverflow exception is raised if</span>
<span class="token comment"># you attempt to store more than 4K of data.</span>
<span class="token comment">#</span>
<span class="token comment"># The cookie jar used for storage is automatically configured to be the</span>
<span class="token comment"># best possible option given your application's configuration.</span>
<span class="token comment">#</span>
<span class="token comment"># If you only have secret_token set, your cookies will be signed, but</span>
<span class="token comment"># not encrypted. This means a user cannot alter their +user_id+ without</span>
<span class="token comment"># knowing your app's secret key, but can easily read their +user_id+. This</span>
<span class="token comment"># was the default for Rails 3 apps.</span>
<span class="token comment">#</span>
<span class="token comment"># Your cookies will be encrypted using your apps secret_key_base. This</span>
<span class="token comment"># goes a step further than signed cookies in that encrypted cookies cannot</span>
<span class="token comment"># be altered or read by users. This is the default starting in Rails 4.</span>
<span class="token comment">#</span>
<span class="token comment"># Configure your session store in &lt;tt>config/initializers/session_store.rb&lt;/tt>:</span>
<span class="token comment">#</span>
<span class="token comment">#   Rails.application.config.session_store :cookie_store, key: '_your_app_session'</span>
<span class="token comment">#</span>
<span class="token comment"># In the development and test environments your application's secret key base is</span>
<span class="token comment"># generated by Rails and stored in a temporary file in &lt;tt>tmp/development_secret.txt&lt;/tt>.</span>
<span class="token comment"># In all other environments, it is stored encrypted in the</span>
<span class="token comment"># &lt;tt>config/credentials.yml.enc&lt;/tt> file.</span>
<span class="token comment">#</span>
<span class="token comment"># If your application was not updated to Rails 5.2 defaults, the secret_key_base</span>
<span class="token comment"># will be found in the old &lt;tt>config/secrets.yml&lt;/tt> file.</span>
<span class="token comment">#</span>
<span class="token comment"># Note that changing your secret_key_base will invalidate all existing session.</span>
<span class="token comment"># Additionally, you should take care to make sure you are not relying on the</span>
<span class="token comment"># ability to decode signed cookies generated by your app in external</span>
<span class="token comment"># applications or JavaScript before changing it.</span>
<span class="token comment">#</span>
<span class="token comment"># Because CookieStore extends Rack::Session::Abstract::Persisted, many of the</span>
<span class="token comment"># options described there can be used to customize the session cookie that</span>
<span class="token comment"># is generated. For example:</span>
<span class="token comment">#</span>
<span class="token comment">#   Rails.application.config.session_store :cookie_store, expire_after: 14.days</span>
<span class="token comment">#</span>
<span class="token comment"># would set the session cookie to expire automatically 14 days after creation.</span>
<span class="token comment"># Other useful options include &lt;tt>:key&lt;/tt>, &lt;tt>:secure&lt;/tt> and</span>
<span class="token comment"># &lt;tt>:httponly&lt;/tt>.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>Rails uses cookie-based sessions by default because it is faster than other solutions. Although cookies have size limitations, they can only store flash messages and user IDs, which are far from the 4k limit.</p>
<p>In Rails 3, cookies are only signed, not encrypted, which means that users can see the user ID but cannot change it (just like the sessionID we see in express-session, visible but cannot be changed).</p>
<p>In Rails 4 and later, the cookie value is encrypted, and nothing can be seen. In the test environment, Rails automatically generates a secret for encryption, which can also be set through the Rails configuration file.</p>
<p>In this file, there is also a function called <code>generate_sid</code>, which is used to generate sessionIDs. This function exists in <a target="_blank" rel="noopener" href="https://github.com/rails/rails/blob/5-2-stable/actionpack/lib/action_dispatch/middleware/session/abstract_store.rb">rails&#x2F;actionpack&#x2F;lib&#x2F;action_dispatch&#x2F;middleware&#x2F;session&#x2F;abstract_store.rb</a>:</p>
<pre class="line-numbers language-ruby" data-language="ruby"><code class="language-ruby"><span class="token keyword">def</span> <span class="token method-definition"><span class="token function">generate_sid</span></span>
    sid <span class="token operator">=</span> SecureRandom<span class="token punctuation">.</span>hex<span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span>
    sid<span class="token punctuation">.</span>encode<span class="token operator">!</span><span class="token punctuation">(</span>Encoding<span class="token double-colon punctuation">::</span><span class="token constant">UTF_8</span><span class="token punctuation">)</span>
    sid
<span class="token keyword">end</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>It directly calls the Ruby library <a target="_blank" rel="noopener" href="https://ruby-doc.org/stdlib-2.5.1/libdoc/securerandom/rdoc/SecureRandom.html">SecureRandom</a> to generate random numbers as sessionIDs.</p>
<p>As for the key in the cookie, it can be adjusted by setting <code>app.config.session_store</code>. According to the code <a target="_blank" rel="noopener" href="https://github.com/rails/rails/blob/5-2-stable/railties/lib/rails/application/finisher.rb#L39">here</a>:</p>
<pre class="line-numbers language-ruby" data-language="ruby"><code class="language-ruby"><span class="token comment"># Setup default session store if not already set in config/application.rb</span>
initializer <span class="token symbol">:setup_default_session_store</span><span class="token punctuation">,</span> <span class="token symbol">before</span><span class="token operator">:</span> <span class="token symbol">:build_middleware_stack</span> <span class="token keyword">do</span> <span class="token operator">|</span>app<span class="token operator">|</span>
    <span class="token keyword">unless</span> app<span class="token punctuation">.</span>config<span class="token punctuation">.</span>session_store<span class="token operator">?</span>
        app_name <span class="token operator">=</span> app<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span>name <span class="token operator">?</span> app<span class="token punctuation">.</span>railtie_name<span class="token punctuation">.</span>chomp<span class="token punctuation">(</span><span class="token string-literal"><span class="token string">"_application"</span></span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token string-literal"><span class="token string">""</span></span>
        app<span class="token punctuation">.</span>config<span class="token punctuation">.</span>session_store <span class="token symbol">:cookie_store</span><span class="token punctuation">,</span> <span class="token symbol">key</span><span class="token operator">:</span> <span class="token string-literal"><span class="token string">"_</span><span class="token interpolation"><span class="token delimiter punctuation">#&#123;</span><span class="token content">app_name</span><span class="token delimiter punctuation">&#125;</span></span><span class="token string">_session"</span></span>
    <span class="token keyword">end</span>
<span class="token keyword">end</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>The default value will be <code>_#&#123;app_name&#125;_session</code>, for example, if my app_name is huli, the cookie name will be _huli_session.</p>
<p>Then the place where the session information is actually written into the cookie is in <a target="_blank" rel="noopener" href="https://github.com/rails/rails/blob/5-2-stable/actionpack/lib/action_dispatch/middleware/session/cookie_store.rb">rails&#x2F;actionpack&#x2F;lib&#x2F;action_dispatch&#x2F;middleware&#x2F;session&#x2F;cookie_store.rb</a>:</p>
<pre class="line-numbers language-ruby" data-language="ruby"><code class="language-ruby"><span class="token keyword">def</span> <span class="token method-definition"><span class="token function">set_cookie</span></span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> session_id<span class="token punctuation">,</span> cookie<span class="token punctuation">)</span>
  cookie_jar<span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token variable">@key</span><span class="token punctuation">]</span> <span class="token operator">=</span> cookie
<span class="token keyword">end</span>

<span class="token keyword">def</span> <span class="token method-definition"><span class="token function">get_cookie</span></span><span class="token punctuation">(</span>req<span class="token punctuation">)</span>
  cookie_jar<span class="token punctuation">(</span>req<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token variable">@key</span><span class="token punctuation">]</span>
<span class="token keyword">end</span>

<span class="token keyword">def</span> <span class="token method-definition"><span class="token function">cookie_jar</span></span><span class="token punctuation">(</span>request<span class="token punctuation">)</span>
  request<span class="token punctuation">.</span>cookie_jar<span class="token punctuation">.</span>signed_or_encrypted
<span class="token keyword">end</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>It will call <code>signed_or_encrypted</code> related to the cookie to handle it.</p>
<p>Then I searched the documentation and found that the <a target="_blank" rel="noopener" href="https://guides.rubyonrails.org/security.html#sessions">official document</a> actually explains it very clearly:</p>
<blockquote>
<p>The session ID is generated using SecureRandom.hex which generates a random hex string using platform specific methods (such as OpenSSL, &#x2F;dev&#x2F;urandom or Win32 CryptoAPI) for generating cryptographically secure random numbers. Currently it is not feasible to brute-force Rails’ session IDs.</p>
</blockquote>
<p>The above paragraph describes how the sessionID is generated.</p>
<blockquote>
<p>The CookieStore uses the encrypted cookie jar to provide a secure, encrypted location to store session data. Cookie-based sessions thus provide both integrity as well as confidentiality to their contents. The encryption key, as well as the verification key used for signed cookies, is derived from the secret_key_base configuration value.</p>
<p>As of Rails 5.2 encrypted cookies and sessions are protected using AES GCM encryption. This form of encryption is a type of Authenticated Encryption and couples authentication and encryption in single step while also producing shorter ciphertexts as compared to other algorithms previously used. The key for cookies encrypted with AES GCM are derived using a salt value defined by the config.action_dispatch.authenticated_encrypted_cookie_salt configuration value.</p>
</blockquote>
<p>This paragraph describes that AES GCM is used for encryption starting from Rails 5.2. There is another paragraph below that I didn’t copy, mainly mentioning what was written in the code comments before, that before Rails 4, only HMAC was used for verification, not encryption.</p>
<p>And I found that this document is really well written after reading it. In addition to explaining these mechanisms clearly, it also introduces the Session Fixation Attack and CSRF that we mentioned in the previous article.</p>
<p>If you want to study further, you can refer to the implementation of Cookie related in Rails: <a target="_blank" rel="noopener" href="https://github.com/rails/rails/blob/5-2-stable/actionpack/lib/action_dispatch/middleware/cookies.rb">rails&#x2F;actionpack&#x2F;lib&#x2F;action_dispatch&#x2F;middleware&#x2F;cookies.rb</a>, where the comments have detailed explanations, such as the encryption part:</p>
<pre class="line-numbers language-ruby" data-language="ruby"><code class="language-ruby"><span class="token comment"># Returns a jar that'll automatically encrypt cookie values before sending them to the client and will decrypt them for read.</span>
<span class="token comment"># If the cookie was tampered with by the user (or a 3rd party), +nil+ will be returned.</span>
<span class="token comment">#  </span>
<span class="token comment"># If +secret_key_base+ and +secrets.secret_token+ (deprecated) are both set,</span>
<span class="token comment"># legacy cookies signed with the old key generator will be transparently upgraded.</span>
<span class="token comment">#  </span>
<span class="token comment"># If +config.action_dispatch.encrypted_cookie_salt+ and +config.action_dispatch.encrypted_signed_cookie_salt+</span>
<span class="token comment"># are both set, legacy cookies encrypted with HMAC AES-256-CBC will be transparently upgraded.</span>
<span class="token comment">#  </span>
<span class="token comment"># This jar requires that you set a suitable secret for the verification on your app's +secret_key_base+.</span>
<span class="token comment">#  </span>
<span class="token comment"># Example:</span>
<span class="token comment">#  </span>
<span class="token comment">#   cookies.encrypted[:discount] = 45</span>
<span class="token comment">#   # => Set-Cookie: discount=DIQ7fw==--K3n//8vvnSbGq9dA--7Xh91HfLpwzbj1czhBiwOg==; path=/</span>
<span class="token comment">#  </span>
<span class="token comment">#   cookies.encrypted[:discount] # => 45</span>
<span class="token keyword">def</span> <span class="token method-definition"><span class="token function">encrypted</span></span>
  <span class="token variable">@encrypted</span> <span class="token operator">||=</span> <span class="token class-name">EncryptedKeyRotatingCookieJar</span><span class="token punctuation">.</span><span class="token keyword">new</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">)</span>
<span class="token keyword">end</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>If you scroll down, you can see the complete code of <code>EncryptedKeyRotatingCookieJar</code>, or you can go further down and see <a target="_blank" rel="noopener" href="https://github.com/rails/rails/blob/5-2-stable/activesupport/lib/active_support/message_encryptor.rb">rails&#x2F;activesupport&#x2F;lib&#x2F;active_support&#x2F;message_encryptor.rb</a>, which is responsible for encryption, and the code looks like this:</p>
<pre class="line-numbers language-ruby" data-language="ruby"><code class="language-ruby"><span class="token keyword">def</span> <span class="token method-definition"><span class="token function">_encrypt</span></span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> <span class="token operator">**</span>metadata_options<span class="token punctuation">)</span>
    cipher <span class="token operator">=</span> new_cipher
    cipher<span class="token punctuation">.</span>encrypt
    cipher<span class="token punctuation">.</span>key <span class="token operator">=</span> <span class="token variable">@secret</span>
  
    <span class="token comment"># Rely on OpenSSL for the initialization vector</span>
    iv <span class="token operator">=</span> cipher<span class="token punctuation">.</span>random_iv
    cipher<span class="token punctuation">.</span>auth_data <span class="token operator">=</span> <span class="token string-literal"><span class="token string">""</span></span> <span class="token keyword">if</span> aead_mode<span class="token operator">?</span>
  
    encrypted_data <span class="token operator">=</span> cipher<span class="token punctuation">.</span>update<span class="token punctuation">(</span>Messages<span class="token double-colon punctuation">::</span>Metadata<span class="token punctuation">.</span>wrap<span class="token punctuation">(</span><span class="token variable">@serializer</span><span class="token punctuation">.</span>dump<span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">,</span> metadata_options<span class="token punctuation">)</span><span class="token punctuation">)</span>
    encrypted_data <span class="token operator">&lt;&lt;</span> cipher<span class="token punctuation">.</span>final
  
    blob <span class="token operator">=</span> <span class="token string-literal"><span class="token string">"</span><span class="token interpolation"><span class="token delimiter punctuation">#&#123;</span><span class="token content"><span class="token double-colon punctuation">::</span>Base64<span class="token punctuation">.</span>strict_encode64 encrypted_data</span><span class="token delimiter punctuation">&#125;</span></span><span class="token string">--</span><span class="token interpolation"><span class="token delimiter punctuation">#&#123;</span><span class="token content"><span class="token double-colon punctuation">::</span>Base64<span class="token punctuation">.</span>strict_encode64 iv</span><span class="token delimiter punctuation">&#125;</span></span><span class="token string">"</span></span>
    blob <span class="token operator">=</span> <span class="token string-literal"><span class="token string">"</span><span class="token interpolation"><span class="token delimiter punctuation">#&#123;</span><span class="token content">blob</span><span class="token delimiter punctuation">&#125;</span></span><span class="token string">--</span><span class="token interpolation"><span class="token delimiter punctuation">#&#123;</span><span class="token content"><span class="token double-colon punctuation">::</span>Base64<span class="token punctuation">.</span>strict_encode64 cipher<span class="token punctuation">.</span>auth_tag</span><span class="token delimiter punctuation">&#125;</span></span><span class="token string">"</span></span> <span class="token keyword">if</span> aead_mode<span class="token operator">?</span>
    blob
<span class="token keyword">end</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>The cipher used here comes from openssl, so the bottom layer uses openssl.</p>
<p>That should be enough for now, let’s not go any deeper.</p>
<h2><span id="conclusion">Conclusion</span></h2><p>In this article, we looked at three different ways of storing sessions. The first is express-session, which stores session information in memory; the second is PHP, which stores it in a file; and the last is Rails, which uses the cookie-based session mentioned earlier to encrypt and store information directly in a cookie.</p>
<p>In this series, in the first article, we understood the concept, in the second article, we deepened our understanding of Session by reading RFC again, and in the last article, we directly referred to the implementation of some mainstream frameworks to see how the sessionID we mentioned earlier should be generated, where session information should be stored, and how cookie-based sessions should be implemented.</p>
<p>The purpose of writing this series is to help everyone understand these concepts clearly at once, so that they don’t have to look them up again every time they encounter them in the future.</p>
<p>Finally, I hope this series is helpful to everyone, and if there are any errors, please leave a comment below.</p>
<p>Here is the complete list of articles in this series:</p>
<ol>
<li><a target="_blank" rel="noopener" href="https://medium.com/@hulitw/session-and-cookie-15e47ed838bc">Plain Session and Cookie: Starting with Running a Grocery Store</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/aszx87410/blog/issues/45">Shallow Talk about Session and Cookie: Let’s Read RFC Together</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/aszx87410/blog/issues/46">Deep Dive into Session and Cookie: Implementation in Express, PHP, and Rails</a></li>
</ol>
<pre><code>
</code></pre>

    
    </div>
    
    <div class="columns is-variable is-1 is-multiline is-mobile">
    
        <span class="column is-narrow"><a class="tag is-light article-tag" href="/en/tags/Web/">#Web</a></span>
    
    </div>
    
    
    <div class="columns is-mobile is-multiline article-nav">
        <span class="column is-12-mobile is-half-desktop  article-nav-prev">
            
            <a href="/2019/08/21/en/real-front-end-learning-path/">Solid Front-end Learning Path and Resource Recommendations</a>
            
        </span>
        <span class="column is-12-mobile is-half-desktop  article-nav-next">
            
            <a href="/2019/08/09/en/session-and-cookie-part2/">A Brief Discussion on Session and Cookie: Reading RFC Together</a>
            
        </span>
    </div>
    
</article>




<div class="comments">
    <h3 class="title is-4">Comments</h3>
    <script src="https://utteranc.es/client.js"
        repo="aszx87410/huli-blog"
        issue-term="title"
        theme="github-light"
        crossorigin="anonymous"
        async>
</script>
</div>

    </div>
</section>
    <footer class="footer">
    <div class="container">
        <div class="columns content">
            <div class="column is-narrow has-text-centered">
                &copy; 2024 Huli&nbsp;
                Powered by <a href="http://hexo.io/" target="_blank">Hexo</a> & <a
                        target="_blank" rel="noopener" href="http://github.com/ppoffice/hexo-theme-minos">Minos</a>
            </div>
            <div class="column is-hidden-mobile"></div>

            
            <div class="column is-narrow">
                <div class="columns is-mobile is-multiline is-centered">
                
                    
                <a class="column is-narrow" title="GitHub" target="_blank" rel="noopener" href="https://github.com/ppoffice/hexo-theme-minos">
                    
                    GitHub
                    
                </a>
                
                </div>
            </div>
            
            
<div class="column is-narrow has-text-centered">
    <div class="dropdown is-up is-right is-hoverable" style="margin-top: -0.2em;">
        <div class="dropdown-trigger">
            <button class="button is-small" aria-haspopup="true">
                <span class="icon">
                    <i class="fas fa-globe"></i>
                </span>
                <span>English</span>
                <span class="icon is-small">
            <i class="fas fa-angle-down" aria-hidden="true"></i>
          </span>
            </button>
        </div>
        <div class="dropdown-menu has-text-left" role="menu" style="top:100%">
            <div class="dropdown-content">
            <!-- NOTE: 永遠回到首頁 -->
            
                <a href="/2019/08/09/session-and-cookie-part3/" class="dropdown-item">
                    繁體中文
                </a>
            
            </div>
        </div>
    </div>
</div>

        </div>
    </div>
</footer>
    <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/3.6.3/jquery.min.js"></script>



    
    
    
    
    
    
<script src="//cdnjs.cloudflare.com/ajax/libs/lightgallery/1.6.8/js/lightgallery-all.min.js"></script>
<script>
    (function ($) {
        $(document).ready(function () {
            if (typeof($.fn.lightGallery) === 'function') {
                $('.article.gallery').lightGallery({ selector: '.gallery-item' });
            }
        });
    })(jQuery);
</script>

    
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.0/clipboard.min.js"></script>
    <style>
        .hljs {
            position: relative;
        }

        .hljs .clipboard-btn {
            float: right;
            color: #9a9a9a;
            background: none;
            border: none;
            cursor: pointer;
        }

        .hljs .clipboard-btn:hover {
          color: #8a8a8a;
        }

        .hljs > .clipboard-btn {
            display: none;
            position: absolute;
            right: 4px;
            top: 4px;
        }

        .hljs:hover > .clipboard-btn {
            display: inline;
        }

        .hljs > figcaption > .clipboard-btn {
            margin-right: 4px;
        }
    </style>
    <script>
      $(document).ready(function () {
        $('figure.hljs').each(function(i, figure) {
          var codeId = 'code-' + i;
          var code = figure.querySelector('.code');
          var copyButton = $('<button>Copy <i class="far fa-clipboard"></i></button>');
          code.id = codeId;
          copyButton.addClass('clipboard-btn');
          copyButton.attr('data-clipboard-target-id', codeId);

          var figcaption = figure.querySelector('figcaption');

          if (figcaption) {
            figcaption.append(copyButton[0]);
          } else {
            figure.prepend(copyButton[0]);
          }
        })

        var clipboard = new ClipboardJS('.clipboard-btn', {
          target: function(trigger) {
            return document.getElementById(trigger.getAttribute('data-clipboard-target-id'));
          }
        });
        clipboard.on('success', function(e) {
          e.clearSelection();
        })
      })
    </script>

    
    

    



<script src="/js/script.js?v=3.js"></script>


    
</body>
</html>