<!DOCTYPE html>
<html class="has-navbar-fixed-top" lang="en">
<head>
    <meta charset="utf-8">
<title>My Experience Fixing a Bug in the Open Source Project Spectrum - Huli&#39;s blog</title>
<meta name="viewport" content="width=device-width, initial-scale=1">


            
<link href="https://blog.huli.tw/2019/04/19/fix-spectrum-bug/" rel="alternate" hreflang="zh-TW" />
            
    




    
<link rel="canonical" href="https://blog.huli.tw/2019/04/19/en/fix-spectrum-bug/">
    





    <meta name="description" content="PrefaceRecently, I started my teaching project again. In the first phase, I wrote this article: Using Github Classroom and Travis CI to Build a Homework Submission System. In the second phase, I wrote">
<meta property="og:type" content="article">
<meta property="og:title" content="My Experience Fixing a Bug in the Open Source Project Spectrum">
<meta property="og:url" content="https://blog.huli.tw/2019/04/19/en/fix-spectrum-bug/index.html">
<meta property="og:site_name" content="Huli&#39;s blog">
<meta property="og:description" content="PrefaceRecently, I started my teaching project again. In the first phase, I wrote this article: Using Github Classroom and Travis CI to Build a Homework Submission System. In the second phase, I wrote">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://user-images.githubusercontent.com/2755720/56428306-791b8d80-62f1-11e9-9cad-ac46ddc8052c.png">
<meta property="og:image" content="https://user-images.githubusercontent.com/2755720/56428318-85074f80-62f1-11e9-9134-4f9138eeb035.png">
<meta property="og:image" content="https://user-images.githubusercontent.com/2755720/56428324-8a649a00-62f1-11e9-88d2-f95f8c39b66d.png">
<meta property="og:image" content="https://user-images.githubusercontent.com/2755720/56428342-97818900-62f1-11e9-9771-d8f85426e079.png">
<meta property="og:image" content="https://user-images.githubusercontent.com/2755720/56428348-9cded380-62f1-11e9-9136-0c3283be8505.png">
<meta property="og:image" content="https://user-images.githubusercontent.com/2755720/56428350-a1a38780-62f1-11e9-9bf0-884030c56f93.png">
<meta property="og:image" content="https://user-images.githubusercontent.com/2755720/56428356-a7996880-62f1-11e9-98fd-7670bf8b38fa.png">
<meta property="article:published_time" content="2019-04-19T12:10:00.000Z">
<meta property="article:modified_time" content="2023-06-20T05:10:49.053Z">
<meta property="article:author" content="Huli">
<meta property="article:tag" content="Others">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://user-images.githubusercontent.com/2755720/56428306-791b8d80-62f1-11e9-9cad-ac46ddc8052c.png">



<link rel="alternative" href="/atom.xml" title="My Experience Fixing a Bug in the Open Source Project Spectrum" type="application/atom+xml">



<link rel="icon" href="/img/lidemy_logo.png">


<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Ovo|Source+Code+Pro">


<link rel="stylesheet" href="/css/bulma.css?v=2.css">



<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/lightgallery/1.6.8/css/lightgallery.min.css">


<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/line-numbers/prism-line-numbers.min.css" />


<link rel="stylesheet" href="/css/style.css?v=4.css">





    
    
    
    
    
    
    
    
    
    
<script async src="https://www.googletagmanager.com/gtag/js?id=G-1393J2EVCZ"></script>
<script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-1393J2EVCZ');
</script>


    


<meta name="generator" content="Hexo 6.3.0"></head>
<body>
    <script>
        if (localStorage.getItem('dark-mode')) {
            if (localStorage.getItem('dark-mode') === 'true') {
                document.body.classList.add('dark-mode')
            }
        } else {
            if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                document.body.classList.add('dark-mode')
            }
        }
    </script>
    
<nav class="navbar is-transparent is-fixed-top navbar-main" role="navigation" aria-label="main navigation">
    <div class="container">
        <div class="navbar-brand">
            <a class="navbar-item navbar-logo" href="/en">
                
                    
                    Huli&#39;s blog
                    
                
            </a>
            <div class="navbar-burger">
                <span></span>
                <span></span>
                <span></span>
            </div>
        </div>
        
        <div class="navbar-menu navbar-start">
            
            <a class="navbar-item "
               href="/en/archives">Archive</a>
            
            <a class="navbar-item "
               href="/en/categories">Categories</a>
            
            <a class="navbar-item "
               href="/en/about">About</a>
            
        </div>
        
        <div class="navbar-menu navbar-end">
            
            
            <div class="navbar-item is-hoverable has-dropdown is-hidden-mobile is-hidden-tablet-only toc">
                <a class="navbar-item" title="Table of Contents">
                    Table of Contents
                </a>
                <div class="navbar-dropdown">
                    
                    
                    
                    
                    <a class="navbar-item" href="#preface">1&nbsp;&nbsp;<b>Preface</b></a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#things-are-not-so-smooth">2&nbsp;&nbsp;<b>Things are not so smooth…</b></a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#journey-of-bug-fixing">3&nbsp;&nbsp;<b>Journey of Bug Fixing</b></a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#not-satisfied-lets-fix-another-one">4&nbsp;&nbsp;<b>Not satisfied, let’s fix another one!</b></a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#summary">5&nbsp;&nbsp;<b>Summary</b></a>
                    
                </div>
            </div>
            
            
            <a class="navbar-item" target="_blank" title="Twitter" href="https://twitter.com/aszx87410">
                
                <i class="fab fa-twitter"></i>
                
            </a>
               
            <a class="navbar-item" target="_blank" title="RSS" href="/atom-en.xml">
                
                <i class="fas fa-rss"></i>
                
            </a>
               
            
            <a class="navbar-item btn-dark-mode" title="dark-mode" href="#">
                <div>
                    <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" width="15" height="15" viewBox="0 0 256 256" xml:space="preserve">
                    <defs>
                    </defs>
                    <g style="stroke: none; stroke-width: 0; stroke-dasharray: none; stroke-linecap: butt; stroke-linejoin: miter; stroke-miterlimit: 10; fill: none; fill-rule: nonzero; opacity: 1;" transform="translate(1.4065934065934016 1.4065934065934016) scale(2.81 2.81)" >
                        <path d="M 87.823 60.7 c -0.463 -0.423 -1.142 -0.506 -1.695 -0.214 c -15.834 8.398 -35.266 2.812 -44.232 -12.718 c -8.966 -15.53 -4.09 -35.149 11.101 -44.665 c 0.531 -0.332 0.796 -0.963 0.661 -1.574 c -0.134 -0.612 -0.638 -1.074 -1.259 -1.153 c -9.843 -1.265 -19.59 0.692 -28.193 5.66 C 13.8 12.041 6.356 21.743 3.246 33.35 S 1.732 57.08 7.741 67.487 c 6.008 10.407 15.709 17.851 27.316 20.961 C 38.933 89.486 42.866 90 46.774 90 c 7.795 0 15.489 -2.044 22.42 -6.046 c 8.601 -4.966 15.171 -12.43 18.997 -21.586 C 88.433 61.79 88.285 61.123 87.823 60.7 z" style="stroke: none; stroke-width: 1; stroke-dasharray: none; stroke-linecap: butt; stroke-linejoin: miter; stroke-miterlimit: 10; fill: #ffa716; fill-rule: nonzero; opacity: 1;" transform=" matrix(1 0 0 1 0 0) " stroke-linecap="round" />
                    </g>
                    </svg>
                </div>
            </a>
            
               <a class="navbar-item" href="/2019/04/19/fix-spectrum-bug/">中文</a>
            
            

        </div>
    </div>
</nav>

    <section class="section">
    <div class="container">
      
      <div data-nosnippet class="self-notice">
        If you have any thoughts on my blog or articles and you want to let me know, you can either post a comment below(public) or tell me via this <a href="https://forms.gle/SjJZ4cnNs6NnjXQG8" target="_blank">feedback form</a>
      </div>
      
    <article class="article content gallery" itemscope itemprop="blogPost">
    <h1 class="article-title is-size-3 is-size-4-mobile" itemprop="name">
        
            My Experience Fixing a Bug in the Open Source Project Spectrum
        
    </h1>
    <div class="article-meta columns is-variable is-1 is-multiline is-mobile is-size-7-mobile">
        <span class="column is-narrow">
            <time datetime="2019-04-19T12:10:00.000Z" itemprop="datePublished">19 April 2019</time>
        </span>
        
        <span class="column is-narrow article-category">
            <i class="far fa-folder"></i>
            <a class="article-category-link" href="/en/categories/Others/">Others</a>
        </span>
        
        
        
        <spen data-nosnippet class="column is-narrow">(Translated by ChatGPT)</span>
        
    </div>
    
    <div class="article-entry is-size-6-mobile" itemprop="articleBody">
    
        <h2><span id="preface">Preface</span></h2><p>Recently, I started my teaching project again. In the first phase, I wrote this article: <a target="_blank" rel="noopener" href="https://github.com/aszx87410/blog/issues/27">Using Github Classroom and Travis CI to Build a Homework Submission System</a>. In the second phase, I wrote this article: <a target="_blank" rel="noopener" href="https://github.com/aszx87410/blog/issues/32">AWS Lambda + GitHub API + Google Sheet &#x3D; Automatic Sign-in System</a>. Both of them use existing tools to quickly create systems that meet my needs.</p>
<p>Before the third phase, I hoped that the course could have a discussion forum where students could easily ask questions. I have always used Slack, but the biggest disadvantage of Slack is that the free version eats messages, and many good information is washed away, which is a pity. I hope there is a forum or discussion forum that would be better.</p>
<p>Two years ago, I also wrote an article: <a target="_blank" rel="noopener" href="http://huli.logdown.com/posts/1989995-the-forums-solution-flarum-discourse-github-issue">Self-hosted Forum Solutions: Flarum, Github Issue, NodeBB, Discourse</a>, studied several solutions, and finally chose GitHub Issue. Because it is the simplest and most convenient, but the biggest disadvantage is that students don’t seem to be used to it, because it doesn’t look like a forum when you look left, right, up, and down.</p>
<span id="more"></span>

<p>Recently, I came across this platform by chance: <a target="_blank" rel="noopener" href="https://spectrum.chat/">spectrum</a>. The slogan on the homepage is very clear:</p>
<blockquote>
<p>The community platform for the future.</p>
</blockquote>
<p>After being acquired by GitHub last year, it became completely free, and the paid version’s features became free. In my opinion, it is actually Slack that is “more like a forum”. Let me show you a screenshot:</p>
<img width="1221" alt="sc" src="https://user-images.githubusercontent.com/2755720/56428306-791b8d80-62f1-11e9-9cad-ac46ddc8052c.png">

<p>The leftmost is different workspaces, which is the same as Slack. Then you can see various channels, which is also the same as Slack. The only difference is on the right side. The original Slack message became a discussion thread with a title and content.</p>
<p>So you can probably understand what I’m talking about. This set is similar to Slack, but more suitable as a forum.</p>
<p>Free, backed by GitHub, can have private forums, open source, this is a perfect solution. Except for the lack of a mobile app, there is nothing to pick on, so I decided to use this set!</p>
<h2><span id="things-are-not-so-smooth">Things are not so smooth…</span></h2><p>After trying it out for a few days, I found a huge problem. Although there is no problem in terms of functionality, the experience is extremely poor. This one small flaw is enough for me to give up this platform.</p>
<p>What is the problem? Typesetting.</p>
<p>Spectrum natively supports Markdown, which is very handy to use, but line breaks are a problem. In some places, only blank lines are not useful, and two spaces need to be added at the end to line break. Although I think this is very inconvenient, I can reluctantly accept it.</p>
<p>However! On spectrum, you need two line breaks to really line break.</p>
<p>Here is an example. Line1 and Line2 at the bottom should line break:</p>
<p><img src="https://user-images.githubusercontent.com/2755720/56428318-85074f80-62f1-11e9-9134-4f9138eeb035.png" alt="layout1"></p>
<p>But after posting, it becomes like this:</p>
<p><img src="https://user-images.githubusercontent.com/2755720/56428324-8a649a00-62f1-11e9-88d2-f95f8c39b66d.png" alt="layout2"></p>
<p>Line breaks become spaces. If it is English, it is okay, but if it is Chinese, the typesetting becomes super strange and unacceptable.</p>
<p>I went to the official discussion forum <a target="_blank" rel="noopener" href="https://spectrum.chat/spectrum/general/how-to-input-new-line-when-creating-a-new-post~2e53fc58-990a-433c-8f86-d2e28cdeaf87">to post</a>, thinking that there might be other ways to line break that I don’t know.</p>
<p>The result of the official reply to me was: “Yes, now you have to line break twice to really line break.”</p>
<p>Originally, I was discouraged and wanted to give up, and studied whether there were other solutions. I even thought about whether to write one myself, but when I thought about supporting a lot of functions, I felt it was troublesome and couldn’t make up my mind.</p>
<p>After several days of contemplation, I think Spectrum is a great platform, but the only drawback is the formatting issue. If this issue is resolved, there is no reason not to use it.</p>
<p>If the official team is too busy to fix the bugs, we can fix them ourselves! This is the benefit of open source.</p>
<h2><span id="journey-of-bug-fixing">Journey of Bug Fixing</span></h2><p>The first step to fixing bugs for an open source project is to figure out how to run the entire environment. You need to be able to run it locally to verify whether you have successfully fixed the issue, so the official documentation is very important.</p>
<p>The <a target="_blank" rel="noopener" href="https://github.com/withspectrum/spectrum">spectrum</a> documentation is very comprehensive and provides a series of instructions on what to do. By following these instructions, you can run both the front-end and back-end on your local machine.</p>
<p>While waiting for the installation of these packages, you can try to guess where the problem might be. At that time, I guessed that there might be a problem with the markdown editor, perhaps when converting markdown to HTML, the line breaks were not handled properly, resulting in missing line breaks.</p>
<p>Guessing alone is not enough. The first step is to narrow down the problem and locate it. Find out what happened to the most important part of the post.</p>
<p>In Chrome, we can use React Devtool to see that the post interface is a component called composer. Then in <a target="_blank" rel="noopener" href="https://github.com/withspectrum/spectrum/blob/0cef471b45779adcdfbb22dcc57884712c015e91/src/components/composer/index.js#L500">composer&#x2F;index.js</a>, we can see that it is handled by a component called Inputs.</p>
<p>In <a target="_blank" rel="noopener" href="https://github.com/withspectrum/spectrum/blob/0cef471b45779adcdfbb22dcc57884712c015e91/src/components/composer/inputs.js#L54">Inputs.js</a>, I discovered something amazing. When you press Preview, it sends a request directly to a hardcoded path and displays the result:</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> <span class="token function-variable function">onClick</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">show</span><span class="token operator">:</span> boolean</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  <span class="token function">setShowPreview</span><span class="token punctuation">(</span>show<span class="token punctuation">)</span><span class="token punctuation">;</span>
  
  <span class="token keyword">if</span> <span class="token punctuation">(</span>show<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token function">setPreviewBody</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">'https://convert.spectrum.chat/from'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>
      <span class="token literal-property property">method</span><span class="token operator">:</span> <span class="token string">'POST'</span><span class="token punctuation">,</span>
      body<span class="token punctuation">,</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">res</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>res<span class="token punctuation">.</span>status <span class="token operator">&lt;</span> <span class="token number">200</span> <span class="token operator">||</span> res<span class="token punctuation">.</span>status <span class="token operator">>=</span> <span class="token number">300</span><span class="token punctuation">)</span>
          <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'Oops, something went wrong'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">json</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
        <span class="token function">setPreviewBody</span><span class="token punctuation">(</span>json<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>Since the conversion is done by the server, the next step is to find out what the server is doing.</p>
<p>But I don’t know where <code>https://convert.spectrum.chat/from</code> corresponds to on the server, and how to find out how the server handles it?</p>
<p>Here, we can change our thinking. Although it is true that the preview is sent here, the server must also handle this format conversion when posting, so we can first find out what the server is doing when posting, and there should be some clues.</p>
<p>Then, after posting on the front end, check the Network tab because the backend is GraphQL, so it’s pretty easy to see, and it’s called <code>publushThread</code>.</p>
<p>Immediately go to the server part, and found this file: <a target="_blank" rel="noopener" href="https://github.com/withspectrum/spectrum/blob/0cef471b45779adcdfbb22dcc57884712c015e91/api/mutations/thread/publishThread.js#L76">publishThread.js</a>, and found that it calls <code>processThreadContent</code> to do the conversion.</p>
<p>Follow this function down, and after <a target="_blank" rel="noopener" href="https://github.com/withspectrum/spectrum/blob/0cef471b45779adcdfbb22dcc57884712c015e91/shared/draft-utils/process-thread-content.js#L12">looking at the code</a>, I found that this should be the bottom layer:</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// @flow</span>
<span class="token keyword">import</span> <span class="token punctuation">&#123;</span> stateFromMarkdown <span class="token punctuation">&#125;</span> <span class="token keyword">from</span> <span class="token string">'draft-js-import-markdown'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">&#123;</span> convertFromRaw<span class="token punctuation">,</span> convertToRaw<span class="token punctuation">,</span> EditorState <span class="token punctuation">&#125;</span> <span class="token keyword">from</span> <span class="token string">'draft-js'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">&#123;</span> addEmbedsToEditorState <span class="token punctuation">&#125;</span> <span class="token keyword">from</span> <span class="token string">'./add-embeds-to-draft-js'</span><span class="token punctuation">;</span>
  
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">(</span>type<span class="token operator">:</span> <span class="token string">'TEXT'</span> <span class="token operator">|</span> <span class="token string">'DRAFTJS'</span><span class="token punctuation">,</span> <span class="token literal-property property">body</span><span class="token operator">:</span> <span class="token operator">?</span>string<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token parameter">string</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">let</span> newBody <span class="token operator">=</span> body<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>type <span class="token operator">===</span> <span class="token string">'TEXT'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// workaround react-mentions bug by replacing @[username] with @username</span>
    <span class="token comment">// @see withspectrum/spectrum#4587</span>
    newBody <span class="token operator">=</span> newBody <span class="token operator">?</span> newBody<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">@\[([a-z0-9_-]+)\]</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">,</span> <span class="token string">'@$1'</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token string">''</span><span class="token punctuation">;</span>
    newBody <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>
      <span class="token function">convertToRaw</span><span class="token punctuation">(</span>
        <span class="token function">stateFromMarkdown</span><span class="token punctuation">(</span>newBody<span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>
          <span class="token function-variable function">customBlockFn</span><span class="token operator">:</span> <span class="token parameter">elem</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>elem<span class="token punctuation">.</span>nodeName <span class="token operator">!==</span> <span class="token string">'PRE'</span><span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>
  
            <span class="token keyword">const</span> code <span class="token operator">=</span> elem<span class="token punctuation">.</span>childNodes<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token parameter">node</span> <span class="token operator">=></span> node<span class="token punctuation">.</span>nodeName <span class="token operator">===</span> <span class="token string">'CODE'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>code<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>
  
            <span class="token keyword">const</span> className <span class="token operator">=</span> code<span class="token punctuation">.</span>attributes<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span>
              <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">&#123;</span> name <span class="token punctuation">&#125;</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> name <span class="token operator">===</span> <span class="token string">'class'</span>
            <span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>className<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>
  
            <span class="token keyword">const</span> lang <span class="token operator">=</span> className<span class="token punctuation">.</span>value<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token string">'lang-'</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  
            <span class="token keyword">return</span> <span class="token punctuation">&#123;</span>
              <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
              <span class="token literal-property property">data</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
                <span class="token literal-property property">language</span><span class="token operator">:</span> lang<span class="token punctuation">,</span>
              <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
            <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
          <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
          <span class="token literal-property property">parserOptions</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
            <span class="token literal-property property">atomicImages</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
            <span class="token literal-property property">breaks</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
          <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
      <span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  
  <span class="token comment">// Add automatic embeds to body</span>
  <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token function">addEmbedsToEditorState</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>newBody <span class="token operator">||</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// Ignore errors during automatic embed detection</span>
  <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> newBody <span class="token operator">||</span> <span class="token string">''</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>And I didn’t see any signs of anything wrong. It seemed like everything was normal. At this point, I thought: Do I have to trace down to draft-js or other libraries?</p>
<p>But since I found this, I should first see what it will convert to, and then decide what to do next. So I added a log to this function to print out what it finally converted.</p>
<p>My input was:</p>
<pre class="line-numbers language-none"><code class="language-none">oneline
newline  
thirdline
  
fourline
  
fiveline<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>The output was:</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token punctuation">&#123;</span>
  <span class="token string-property property">"blocks"</span><span class="token operator">:</span><span class="token punctuation">[</span>
    <span class="token punctuation">&#123;</span>
      <span class="token string-property property">"key"</span><span class="token operator">:</span><span class="token string">"bq56i"</span><span class="token punctuation">,</span>
      <span class="token string-property property">"text"</span><span class="token operator">:</span><span class="token string">"oneline\nnewline\nthirdline"</span><span class="token punctuation">,</span>
      <span class="token string-property property">"type"</span><span class="token operator">:</span><span class="token string">"unstyled"</span><span class="token punctuation">,</span>
      <span class="token string-property property">"depth"</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span>
      <span class="token string-property property">"inlineStyleRanges"</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token string-property property">"entityRanges"</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token string-property property">"data"</span><span class="token operator">:</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
    <span class="token punctuation">&#123;</span>
      <span class="token string-property property">"key"</span><span class="token operator">:</span><span class="token string">"9h38b"</span><span class="token punctuation">,</span>
      <span class="token string-property property">"text"</span><span class="token operator">:</span><span class="token string">"fourline"</span><span class="token punctuation">,</span>
      <span class="token string-property property">"type"</span><span class="token operator">:</span><span class="token string">"unstyled"</span><span class="token punctuation">,</span>
      <span class="token string-property property">"depth"</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span>
      <span class="token string-property property">"inlineStyleRanges"</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token string-property property">"entityRanges"</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token string-property property">"data"</span><span class="token operator">:</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
    <span class="token punctuation">&#123;</span>
      <span class="token string-property property">"key"</span><span class="token operator">:</span><span class="token string">"fuprm"</span><span class="token punctuation">,</span>
      <span class="token string-property property">"text"</span><span class="token operator">:</span><span class="token string">"fiveline"</span><span class="token punctuation">,</span>
      <span class="token string-property property">"type"</span><span class="token operator">:</span><span class="token string">"unstyled"</span><span class="token punctuation">,</span>
      <span class="token string-property property">"depth"</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span>
      <span class="token string-property property">"inlineStyleRanges"</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token string-property property">"entityRanges"</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token string-property property">"data"</span><span class="token operator">:</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token string-property property">"entityMap"</span><span class="token operator">:</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>Without printing, it’s nothing, but when I printed it out, it was amazing!</p>
<p>I didn’t expect the above test data to be converted to: <code>&quot;text&quot;:&quot;oneline\nnewline\nthirdline&quot;</code>. It seems that the server’s conversion is completely normal, and the line breaks are converted to <code>\n</code>, and two line breaks are converted to a new block. It seems that the problem is that the front end did not output these line breaks properly.</p>
<p>Then, using a similar method, I used React Devtool to see that the front end display is handled by <a target="_blank" rel="noopener" href="https://github.com/withspectrum/spectrum/blob/be3d7cc2b2bafec6715c7623db59c897902073ff/src/views/thread/components/threadDetail.js#L359">threadDetail.js</a>, and it calls threadRenderer.js, which seems to be the real rendering place.</p>
<p>After finding <a target="_blank" rel="noopener" href="https://github.com/withspectrum/spectrum/blob/c34bb1fa4b9957bcfcc6ff0165582e2f635bf5e7/src/components/threadRenderer/index.js#L4">threadRenderer.js</a>, it was discovered that it simply calls the library <a target="_blank" rel="noopener" href="https://github.com/lokiuz/redraft">redraft</a>.</p>
<p>Okay, although there is something new to study, the answer is getting closer.</p>
<p>After carefully reading the redraft documentation, it seems that it is possible to customize what the output of each type should look like. Further down, in the <a target="_blank" rel="noopener" href="https://github.com/lokiuz/redraft#common-issues">Common issues</a> section, it says:</p>
<blockquote>
<p>Can the multiple spaces between text be persisted?</p>
<p>Add white-space: pre-wrap to a parent div, this way it will preserve spaces and wrap to new lines (as editor js does)</p>
</blockquote>
<p>At this point, the answer is already very clear. The front-end display forgot to add <code>white-space: pre-wrap</code>, so the default behavior treats line breaks as spaces.</p>
<p>When the truth was revealed, I cursed myself in my heart, but it was my own fault. Because this problem is actually quite common on the front-end, and I have used this property many times. However, when I saw this problem, my first thought was to suspect the back-end, and I never thought that it might be a front-end problem, let alone that it could be solved by adding a line of CSS.</p>
<p>Then I posted an <a target="_blank" rel="noopener" href="https://github.com/withspectrum/spectrum/issues/4885">Issue</a> to record the investigation process and cause, and then submitted a <a target="_blank" rel="noopener" href="https://github.com/withspectrum/spectrum/issues/4885">PR</a>. Although it was only one line, it was significant to me. Because once this bug is fixed, this set can immediately be used for other ready-made forum systems.</p>
<p>Their speed is very fast. After submitting the PR, it was merged the next day, and then deployed to production in just one week. They are really efficient.</p>
<h2><span id="not-satisfied-lets-fix-another-one">Not satisfied, let’s fix another one!</span></h2><p>Although it was only one line, the exploration process was very rewarding, and I was happy that the PR was merged. Since one was fixed, let’s see if there are any other easy ones to fix, so we can fix them together.</p>
<p>I looked through the official Issues and found one that looked easy: <a target="_blank" rel="noopener" href="https://github.com/withspectrum/spectrum/issues/4812">Weird image failed rendering in thread body</a>. This Issue is very simple, it’s just that the following bug appears for no reason:</p>
<img width="716" alt="alt" src="https://user-images.githubusercontent.com/2755720/56428342-97818900-62f1-11e9-9771-d8f85426e079.png">

<p>The text covers the image behind it.</p>
<p>The original URL was attached in the Issue, and after clicking it and using devtool to check, it was found that the problem was caused when the browser could not load the image tag. </p>
<p>I had never encountered this problem before, but after trying it myself, I found that the img originally had a margin, but it would fail when the image could not be loaded. My intuition told me that this might be related to <a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Web/CSS/CSS_Box_Model/Mastering_margin_collapsing">margin collapsing</a>.</p>
<p>Later, I tried it myself and found that when the image could not be loaded, the height of the img would become 0, and then the margin would fail. Because of some layout and CSS elements, the text below would cover it, resulting in the image below.</p>
<img width="1306" alt="height" src="https://user-images.githubusercontent.com/2755720/56428348-9cded380-62f1-11e9-9136-0c3283be8505.png">

<p>So is there a good solution?</p>
<p>I found the simplest solution was to add the <code>alt</code> attribute. When the image cannot be loaded, this text will be displayed, and the img will maintain its height, and the margin will work.</p>
<img width="1324" alt="height2" src="https://user-images.githubusercontent.com/2755720/56428350-a1a38780-62f1-11e9-9bf0-884030c56f93.png">

<p>After finding a solution, I first replied to the <a target="_blank" rel="noopener" href="https://github.com/withspectrum/spectrum/issues/4812">Issue</a> and discussed with them to see what they thought.</p>
<p>Later, I found that the alt attribute was actually set when uploading the image, but it might be empty under some boundary conditions, or the user manually removed the alt attribute.</p>
<p>So the final solution was also very simple, just add a default value to alt, <a target="_blank" rel="noopener" href="https://github.com/withspectrum/spectrum/pull/4887">PR: Add default alt text to img</a>:</p>
<pre class="line-numbers language-none"><code class="language-none">-  &lt;img key&#x3D;&#123;key&#125; src&#x3D;&#123;data.src&#125; alt&#x3D;&#123;data.alt&#125; &#x2F;&gt;,
+  &lt;img key&#x3D;&#123;key&#125; src&#x3D;&#123;data.src&#125; alt&#x3D;&#123;data.alt || &#39;Image&#39;&#125; &#x2F;&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<h2><span id="summary">Summary</span></h2><p>Although I only contributed two lines, I was still happy to see my account appear in the release log:</p>
<img width="849" alt="re" src="https://user-images.githubusercontent.com/2755720/56428356-a7996880-62f1-11e9-98fd-7670bf8b38fa.png">

<p>If it were me before, I would never have done such a thing. I would have stopped after finding the bug and waited for the official team to fix it.</p>
<p>But in recent years, I have gradually become familiar with reading other people’s code. Sometimes when I have nothing to do at work, I can take a look at the source code of redux-form or redux, etc. As I read more, I feel that it’s not that scary. Moreover, GitHub has a super useful feature called “Search”, which often allows me to find related source code directly by searching for keywords, saving a lot of time.</p>
<p>When looking at other people’s projects, I think the hardest part is locating the problem. Once you locate the problem, everything else is not that difficult, because you already know which file and which code segment has the problem, and you just need to study in that direction. As for how to locate the problem, here are a few suggestions:</p>
<ol>
<li>Search the code directly to see if you can find the relevant paragraph</li>
<li>Use devtool to find the relevant component</li>
<li>Look at the documentation to see if there are any attached structures</li>
</ol>
<p>When you want to fix a bug, the direction is very clear, and there is no need to look through the entire project. Just find the place you want to fix. This article hopes to share my experience with everyone.</p>
<p>Finally, it’s great to be an engineer, it’s great to have an open source project, and it’s great to be able to fix bugs yourself.</p>

    
    </div>
    
    <div class="columns is-variable is-1 is-multiline is-mobile">
    
        <span class="column is-narrow"><a class="tag is-light article-tag" href="/en/tags/Others/">#Others</a></span>
    
    </div>
    
    
    <div class="columns is-mobile is-multiline article-nav">
        <span class="column is-12-mobile is-half-desktop  article-nav-prev">
            
            <a href="/2019/05/18/en/lidemy-http-challenge/">Behind the Scenes: Design and Easter Eggs of Lidemy HTTP Challenge</a>
            
        </span>
        <span class="column is-12-mobile is-half-desktop  article-nav-next">
            
            <a href="/2019/03/24/en/react-keypress-keydown/">Understanding keyPress and keyDown events in React source code</a>
            
        </span>
    </div>
    
</article>




<div class="comments">
    <h3 class="title is-4">Comments</h3>
    <script src="https://utteranc.es/client.js"
        repo="aszx87410/huli-blog"
        issue-term="title"
        theme="github-light"
        crossorigin="anonymous"
        async>
</script>
</div>

    </div>
</section>
    <footer class="footer">
    <div class="container">
        <div class="columns content">
            <div class="column is-narrow has-text-centered">
                &copy; 2024 Huli&nbsp;
                Powered by <a href="http://hexo.io/" target="_blank">Hexo</a> & <a
                        target="_blank" rel="noopener" href="http://github.com/ppoffice/hexo-theme-minos">Minos</a>
            </div>
            <div class="column is-hidden-mobile"></div>

            
            <div class="column is-narrow">
                <div class="columns is-mobile is-multiline is-centered">
                
                    
                <a class="column is-narrow" title="GitHub" target="_blank" rel="noopener" href="https://github.com/ppoffice/hexo-theme-minos">
                    
                    GitHub
                    
                </a>
                
                </div>
            </div>
            
            
<div class="column is-narrow has-text-centered">
    <div class="dropdown is-up is-right is-hoverable" style="margin-top: -0.2em;">
        <div class="dropdown-trigger">
            <button class="button is-small" aria-haspopup="true">
                <span class="icon">
                    <i class="fas fa-globe"></i>
                </span>
                <span>English</span>
                <span class="icon is-small">
            <i class="fas fa-angle-down" aria-hidden="true"></i>
          </span>
            </button>
        </div>
        <div class="dropdown-menu has-text-left" role="menu" style="top:100%">
            <div class="dropdown-content">
            <!-- NOTE: 永遠回到首頁 -->
            
                <a href="/2019/04/19/fix-spectrum-bug/" class="dropdown-item">
                    繁體中文
                </a>
            
            </div>
        </div>
    </div>
</div>

        </div>
    </div>
</footer>
    <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/3.6.3/jquery.min.js"></script>



    
    
    
    
    
    
<script src="//cdnjs.cloudflare.com/ajax/libs/lightgallery/1.6.8/js/lightgallery-all.min.js"></script>
<script>
    (function ($) {
        $(document).ready(function () {
            if (typeof($.fn.lightGallery) === 'function') {
                $('.article.gallery').lightGallery({ selector: '.gallery-item' });
            }
        });
    })(jQuery);
</script>

    
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.0/clipboard.min.js"></script>
    <style>
        .hljs {
            position: relative;
        }

        .hljs .clipboard-btn {
            float: right;
            color: #9a9a9a;
            background: none;
            border: none;
            cursor: pointer;
        }

        .hljs .clipboard-btn:hover {
          color: #8a8a8a;
        }

        .hljs > .clipboard-btn {
            display: none;
            position: absolute;
            right: 4px;
            top: 4px;
        }

        .hljs:hover > .clipboard-btn {
            display: inline;
        }

        .hljs > figcaption > .clipboard-btn {
            margin-right: 4px;
        }
    </style>
    <script>
      $(document).ready(function () {
        $('figure.hljs').each(function(i, figure) {
          var codeId = 'code-' + i;
          var code = figure.querySelector('.code');
          var copyButton = $('<button>Copy <i class="far fa-clipboard"></i></button>');
          code.id = codeId;
          copyButton.addClass('clipboard-btn');
          copyButton.attr('data-clipboard-target-id', codeId);

          var figcaption = figure.querySelector('figcaption');

          if (figcaption) {
            figcaption.append(copyButton[0]);
          } else {
            figure.prepend(copyButton[0]);
          }
        })

        var clipboard = new ClipboardJS('.clipboard-btn', {
          target: function(trigger) {
            return document.getElementById(trigger.getAttribute('data-clipboard-target-id'));
          }
        });
        clipboard.on('success', function(e) {
          e.clearSelection();
        })
      })
    </script>

    
    

    



<script src="/js/script.js?v=3.js"></script>


    
</body>
</html>