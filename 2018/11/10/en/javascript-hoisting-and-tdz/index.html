<!DOCTYPE html>
<html class="has-navbar-fixed-top" lang="en">
<head>
    <meta charset="utf-8">
<title>I know you understand hoisting, but how deep do you know? - Huli&#39;s blog</title>
<meta name="viewport" content="width=device-width, initial-scale=1">


            
<link href="https://blog.huli.tw/2018/11/10/javascript-hoisting-and-tdz/" rel="alternate" hreflang="zh-TW" />
            
    




    
<link rel="canonical" href="https://blog.huli.tw/2018/11/10/en/javascript-hoisting-and-tdz/">
    





    <meta name="description" content="PrefaceSupplement on June 9, 2021: Thanks to the reader blackr1234 for leaving a comment. This article was published in November 2018, and the output results of the code below are probably based on No">
<meta property="og:type" content="article">
<meta property="og:title" content="I know you understand hoisting, but how deep do you know?">
<meta property="og:url" content="https://blog.huli.tw/2018/11/10/en/javascript-hoisting-and-tdz/index.html">
<meta property="og:site_name" content="Huli&#39;s blog">
<meta property="og:description" content="PrefaceSupplement on June 9, 2021: Thanks to the reader blackr1234 for leaving a comment. This article was published in November 2018, and the output results of the code below are probably based on No">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://user-images.githubusercontent.com/2755720/49352096-5d706b80-f6f1-11e8-82fe-8fbff9004184.png">
<meta property="og:image" content="https://user-images.githubusercontent.com/2755720/49352101-65301000-f6f1-11e8-87db-f0c99a22b7de.png">
<meta property="og:image" content="https://user-images.githubusercontent.com/2755720/49352109-71b46880-f6f1-11e8-864d-892a284e6650.png">
<meta property="article:published_time" content="2018-11-10T13:10:00.000Z">
<meta property="article:modified_time" content="2023-06-20T05:10:49.063Z">
<meta property="article:author" content="Huli">
<meta property="article:tag" content="Front-end">
<meta property="article:tag" content="JavaScript">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://user-images.githubusercontent.com/2755720/49352096-5d706b80-f6f1-11e8-82fe-8fbff9004184.png">



<link rel="alternative" href="/atom.xml" title="I know you understand hoisting, but how deep do you know?" type="application/atom+xml">



<link rel="icon" href="/img/lidemy_logo.png">


<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Ovo|Source+Code+Pro">


<link rel="stylesheet" href="/css/bulma.css?v=2.css">



<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/lightgallery/1.6.8/css/lightgallery.min.css">


<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/line-numbers/prism-line-numbers.min.css" />


<link rel="stylesheet" href="/css/style.css?v=4.css">





    
    
    
    
    
    
    
    
    
    
<script async src="https://www.googletagmanager.com/gtag/js?id=G-1393J2EVCZ"></script>
<script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-1393J2EVCZ');
</script>


    


<meta name="generator" content="Hexo 6.3.0"></head>
<body>
    <script>
        if (localStorage.getItem('dark-mode')) {
            if (localStorage.getItem('dark-mode') === 'true') {
                document.body.classList.add('dark-mode')
            }
        } else {
            if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                document.body.classList.add('dark-mode')
            }
        }
    </script>
    
<nav class="navbar is-transparent is-fixed-top navbar-main" role="navigation" aria-label="main navigation">
    <div class="container">
        <div class="navbar-brand">
            <a class="navbar-item navbar-logo" href="/en">
                
                    
                    Huli&#39;s blog
                    
                
            </a>
            <div class="navbar-burger">
                <span></span>
                <span></span>
                <span></span>
            </div>
        </div>
        
        <div class="navbar-menu navbar-start">
            
            <a class="navbar-item "
               href="/en/archives">Archive</a>
            
            <a class="navbar-item "
               href="/en/categories">Categories</a>
            
            <a class="navbar-item "
               href="/en/about">About</a>
            
        </div>
        
        <div class="navbar-menu navbar-end">
            
            
            <div class="navbar-item is-hoverable has-dropdown is-hidden-mobile is-hidden-tablet-only toc">
                <a class="navbar-item" title="Table of Contents">
                    Table of Contents
                </a>
                <div class="navbar-dropdown">
                    
                    
                    
                    
                    <a class="navbar-item" href="#preface">1&nbsp;&nbsp;<b>Preface</b></a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#what-is-hoisting">2&nbsp;&nbsp;<b>What is hoisting?</b></a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#hoisting-with-let-and-const">3&nbsp;&nbsp;<b>Hoisting with let and const</b></a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#why-do-we-need-hoisting">4&nbsp;&nbsp;<b>Why do we need hoisting?</b></a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#how-does-hoisting-work">5&nbsp;&nbsp;<b>How does hoisting work?</b></a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#compilation-and-interpretation-how-does-the-js-engine-work">6&nbsp;&nbsp;<b>Compilation and Interpretation: How does the JS engine work?</b></a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#operation-of-js-engine">7&nbsp;&nbsp;<b>Operation of JS engine</b></a>
                    
                    
                    
                    <a class="navbar-item" href="#line-1-var-foo-x3d-bar">7.1&nbsp;&nbsp;Line 1: var foo = “bar”</a>
                    
                    
                    
                    <a class="navbar-item" href="#line-2-var-a-x3d-1">7.2&nbsp;&nbsp;Line 2: var a = 1</a>
                    
                    
                    
                    <a class="navbar-item" href="#line-10-bar">7.3&nbsp;&nbsp;Line 10: bar()</a>
                    
                    
                    
                    <a class="navbar-item" href="#line-4-foo-x3d-inside-bar">7.4&nbsp;&nbsp;Line 4: foo = “inside bar”</a>
                    
                    
                    
                    <a class="navbar-item" href="#line-5-var-a-x3d-2">7.5&nbsp;&nbsp;Line 5: var a = 2</a>
                    
                    
                    
                    <a class="navbar-item" href="#line-6-c-x3d-3">7.6&nbsp;&nbsp;Line 6: c = 3</a>
                    
                    
                    
                    <a class="navbar-item" href="#line-7-consolelogc">7.7&nbsp;&nbsp;Line 7: console.log(c)</a>
                    
                    
                    
                    <a class="navbar-item" href="#line-8-consolelogd">7.8&nbsp;&nbsp;Line 8: console.log(d)</a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#summary">8&nbsp;&nbsp;<b>Summary</b></a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#temporal-dead-zone">9&nbsp;&nbsp;<b>Temporal Dead Zone</b></a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#byte-code-reading-experience">10&nbsp;&nbsp;<b>Byte code reading experience</b></a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#conclusion">11&nbsp;&nbsp;<b>Conclusion</b></a>
                    
                </div>
            </div>
            
            
            <a class="navbar-item" target="_blank" title="Twitter" href="https://twitter.com/aszx87410">
                
                <i class="fab fa-twitter"></i>
                
            </a>
               
            <a class="navbar-item" target="_blank" title="RSS" href="/atom-en.xml">
                
                <i class="fas fa-rss"></i>
                
            </a>
               
            
            <a class="navbar-item btn-dark-mode" title="dark-mode" href="#">
                <div>
                    <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" width="15" height="15" viewBox="0 0 256 256" xml:space="preserve">
                    <defs>
                    </defs>
                    <g style="stroke: none; stroke-width: 0; stroke-dasharray: none; stroke-linecap: butt; stroke-linejoin: miter; stroke-miterlimit: 10; fill: none; fill-rule: nonzero; opacity: 1;" transform="translate(1.4065934065934016 1.4065934065934016) scale(2.81 2.81)" >
                        <path d="M 87.823 60.7 c -0.463 -0.423 -1.142 -0.506 -1.695 -0.214 c -15.834 8.398 -35.266 2.812 -44.232 -12.718 c -8.966 -15.53 -4.09 -35.149 11.101 -44.665 c 0.531 -0.332 0.796 -0.963 0.661 -1.574 c -0.134 -0.612 -0.638 -1.074 -1.259 -1.153 c -9.843 -1.265 -19.59 0.692 -28.193 5.66 C 13.8 12.041 6.356 21.743 3.246 33.35 S 1.732 57.08 7.741 67.487 c 6.008 10.407 15.709 17.851 27.316 20.961 C 38.933 89.486 42.866 90 46.774 90 c 7.795 0 15.489 -2.044 22.42 -6.046 c 8.601 -4.966 15.171 -12.43 18.997 -21.586 C 88.433 61.79 88.285 61.123 87.823 60.7 z" style="stroke: none; stroke-width: 1; stroke-dasharray: none; stroke-linecap: butt; stroke-linejoin: miter; stroke-miterlimit: 10; fill: #ffa716; fill-rule: nonzero; opacity: 1;" transform=" matrix(1 0 0 1 0 0) " stroke-linecap="round" />
                    </g>
                    </svg>
                </div>
            </a>
            
               <a class="navbar-item" href="/2018/11/10/javascript-hoisting-and-tdz/">中文</a>
            
            

        </div>
    </div>
</nav>

    <section class="section">
    <div class="container">
      
      <div data-nosnippet class="self-notice">
        If you have any thoughts on my blog or articles and you want to let me know, you can either post a comment below(public) or tell me via this <a href="https://forms.gle/SjJZ4cnNs6NnjXQG8" target="_blank">feedback form</a>
      </div>
      
    <article class="article content gallery" itemscope itemprop="blogPost">
    <h1 class="article-title is-size-3 is-size-4-mobile" itemprop="name">
        
            I know you understand hoisting, but how deep do you know?
        
    </h1>
    <div class="article-meta columns is-variable is-1 is-multiline is-mobile is-size-7-mobile">
        <span class="column is-narrow">
            <time datetime="2018-11-10T13:10:00.000Z" itemprop="datePublished">10 November 2018</time>
        </span>
        
        <span class="column is-narrow article-category">
            <i class="far fa-folder"></i>
            <a class="article-category-link" href="/en/categories/JavaScript/">JavaScript</a>
        </span>
        
        
        
        <spen data-nosnippet class="column is-narrow">(Translated by ChatGPT)</span>
        
    </div>
    
    <div class="article-entry is-size-6-mobile" itemprop="articleBody">
    
        <h1><span id="preface">Preface</span></h1><p>Supplement on June 9, 2021:</p>
<p>Thanks to the reader blackr1234 for leaving a comment. This article was published in November 2018, and the output results of the code below are probably based on Node.js v8.17.0, so the output of some situations may be different from now. For example, accessing the let variable before declaration, the result at that time was: <code>ReferenceError: a is not defined</code>, and the result using Node.js v14 now is: <code>ReferenceError: Cannot access &#39;a&#39; before initialization</code>.</p>
<p>Recently, I have been busy with some teaching-related things, and after preparing some materials, I taught my students about hoisting in JavaScript, which is the concept of “lifting”. For example, the following code:</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span>
<span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token number">10</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>will output <code>undefined</code> instead of <code>ReferenceError: a is not defined</code>. This phenomenon is called <a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-TW/docs/Glossary/Hoisting">Hoisting</a>, and the declaration of the variable is “lifted” to the top.</p>
<p>If you only want to understand the basics of hoisting, it’s almost like this, but later I also taught some knowledge related to <code>let</code> and <code>const</code>. However, the day before I just finished teaching, the next day I immediately saw a related technical article and found that I had taught it wrong. Therefore, I spent some time planning to understand hoisting well.</p>
<p>Many things may not seem like much before you delve into them. You will find that you still have a lot of concepts that you don’t understand when you really jump in and look deeply.</p>
<p>Many people know hoisting, but the degree of understanding is different. I have listed 10 items. If you don’t know any of them, congratulations, this article should bring you some gains.</p>
<ol>
<li>You know what hoisting is</li>
<li>You know that hoisting only lifts declarations, not assignments</li>
<li>You know the priority of hoisting when function declarations, function parameters, and general variable declarations appear at the same time</li>
<li>You know that let and const do not have hoisting</li>
<li>You know that the fourth point is wrong, in fact, there is hoisting, but the expression is different</li>
<li>You know that there is a concept called TDZ (Temporal Dead Zone) related to the fifth point</li>
<li>You have read the ES3 specification and know how it is described inside</li>
<li>You have read the ES6 specification and know how it is described inside</li>
<li>You know the principle behind hoisting</li>
<li>You have seen the code compiled by V8</li>
</ol>
<p>You may ask, “Why do I need to know so deeply? What’s the use?” In fact, I also think that for hoisting, it is enough to know the basics. As long as you declare variables properly, even if you don’t know those, it will not have much impact on daily life or work.</p>
<p>But if you, like me, want to put “proficient in JavaScript” on your resume one day, you cannot escape these things. At the same time, if you are more familiar with these underlying details, you will encounter fewer problems, and you will also understand why hoisting appears. When you want to go further and climb higher on the technical road, I think these details are very important.</p>
<p>Next, let’s take a look at hoisting step by step!</p>
<span id="more"></span>

<h1><span id="what-is-hoisting">What is hoisting?</span></h1><p>In JavaScript, if you try to get the value of a variable that has not been declared, the following error will occur:</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span>
<span class="token comment">// ReferenceError: a is not defined</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>It will return an error of <code>a is not defined</code> because you have not declared this variable, so JavaScript cannot find where this variable is, and naturally throws an error.</p>
<p>But if you write like this, something magical happens:</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span> <span class="token comment">// undefined</span>
<span class="token keyword">var</span> a<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>Since we learned programming, we have learned a concept, “the program runs line by line”. Since it runs line by line, when it reaches the first line, isn’t the variable a not declared yet? Then why doesn’t it throw an error of <code>a is not defined</code>, but outputs <code>undefined</code>?</p>
<p>This phenomenon is called hoisting, which is lifted. The <code>var a</code> in the second line is “lifted” to the top for some reason, so you can “imagine” the above code like this:</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">var</span> a
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span> <span class="token comment">// undefined</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>I will emphasize “imagine” because the position of the code will not be moved, so don’t think of hoisting as JavaScript engine helping you “move” all variable declarations to the top, which is problematic. Its principle has nothing to do with moving code.</p>
<p>Next, there is one thing to pay special attention to, which is that only variable declarations will be hoisted, not assignments. Take a look at the following example:</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span> <span class="token comment">// undefined</span>
<span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token number">5</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>You can “imagine” the above code as follows:</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">var</span> a
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span> <span class="token comment">// undefined</span>
a <span class="token operator">=</span> <span class="token number">5</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>You can split the sentence <code>var a = 5</code> into two steps. The first step is to declare the variable: <code>var a</code>, and the second step is to assign the value: <code>a = 5</code>. Only the variable declaration in the first step will be hoisted, not the assignment in the second step.</p>
<p>At this point, you may think it’s okay, just a little confused. Congratulations, there will be more things to make you even more confused later. Let’s add a few more things and see how complex it can get.</p>
<p>If we do it like this, what will be output?</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token parameter">v</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span>
  <span class="token keyword">var</span> v <span class="token operator">=</span> <span class="token number">3</span>
<span class="token punctuation">&#125;</span>
<span class="token function">test</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>Simply put, according to what we just learned, we can transform the above code into the following form:</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token parameter">v</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
  <span class="token keyword">var</span> v
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span>
  v <span class="token operator">=</span> <span class="token number">3</span>
<span class="token punctuation">&#125;</span>
<span class="token function">test</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>The answer is <code>undefined</code>! Easy peasy.</p>
<p>But wait, the answer is <code>10</code> instead of <code>undefined</code>.</p>
<p>In fact, the transformation process is correct, but one factor was overlooked: the passed-in parameter. After adding this factor, it can be seen as follows:</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token parameter">v</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
  <span class="token keyword">var</span> v <span class="token operator">=</span> <span class="token number">10</span> <span class="token comment">// 因為下面呼叫 test(10)</span>
  <span class="token keyword">var</span> v
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span>
  v <span class="token operator">=</span> <span class="token number">3</span>
<span class="token punctuation">&#125;</span>
<span class="token function">test</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>At this point, you may still ask, “But didn’t I redeclare the variable before logging and not give it a value? Won’t it be overwritten as <code>undefined</code>?” </p>
<p>Let’s look at a simple example:</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">var</span> v <span class="token operator">=</span> <span class="token number">5</span>
<span class="token keyword">var</span> v
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>The answer will be <code>5</code> instead of <code>undefined</code>. To understand this behavior, you can think back to splitting a sentence into two parts, declaration and assignment. If we split it like this and add hoisting, the above code can actually be imagined as follows:</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">var</span> v
<span class="token keyword">var</span> v
v <span class="token operator">=</span> <span class="token number">5</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>Now you know why the answer is 5.</p>
<p>At this point, you may feel like your head is about to explode. Why do you have to remember so many rules? Don’t worry, we have one last example that is guaranteed to make you scream.</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span> <span class="token comment">//[Function: a]</span>
<span class="token keyword">var</span> a
<span class="token keyword">function</span> <span class="token function">a</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>In addition to variable declarations, function declarations will also be hoisted and have higher priority. Therefore, the above code will output <code>function</code> instead of <code>undefined</code>.</p>
<p>Okay, the basic concept of hoisting ends here. Let me summarize the key points for you:</p>
<ol>
<li>Both variable declarations and function declarations will be hoisted.</li>
<li>Only declarations will be hoisted, not assignments.</li>
<li>Don’t forget that there are parameters in functions.</li>
</ol>
<p>Don’t worry, we haven’t talked about the new let and const added in ES6 yet.</p>
<h1><span id="hoisting-with-let-and-const">Hoisting with let and const</span></h1><p>In ES6, we have two new keywords for declaring variables, let and const. The behavior of these two keywords with hoisting is similar, so I will only use let as an example below. Take a look at the following code:</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span> <span class="token comment">// ReferenceError: a is not defined</span>
<span class="token keyword">let</span> a<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>Thank goodness, there are finally not so many rules to remember!</p>
<p>From the above code, it seems that let and const do not have variable hoisting, otherwise this error would not be thrown.</p>
<p>I used to think so naively, until I saw the following example:</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token number">10</span>
<span class="token keyword">function</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span>
  <span class="token keyword">let</span> a
<span class="token punctuation">&#125;</span>
<span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>If let really doesn’t have hoisting, the answer should output <code>10</code>, because the log line will access the variable <code>var a = 10</code> outside. But!!!</p>
<p>The answer is: <code>ReferenceError: a is not defined</code>.</p>
<p>This means that it did hoist, but the behavior after hoisting is different from var, so at first glance, you might think it didn’t hoist.</p>
<p>We will explain this concept in detail later, but before that, let’s make a simple summary.</p>
<p>There are many articles that mention hoisting, and they mostly talk about the behavior of hoisting and the differences between let and const. But I think it’s a pity to only talk about it to this extent.</p>
<p>Because if you only understand to this extent, you will think that hoisting is just a bunch of complicated rules to remember, and it’s not a big deal. Who can remember so many rules? It’s just memorization, right?</p>
<p>This is because the above only lets you understand the “surface” and gives a few different examples to tell you that such behavior will occur, but it does not tell you “why it will happen” or “how it actually works”. If you really want to understand what hoisting is, you must find the answers to the following two questions. Once you find them, I guarantee that your two main veins will be unblocked:</p>
<ol>
<li>Why do we need hoisting?</li>
<li>How does hoisting actually work?</li>
</ol>
<h1><span id="why-do-we-need-hoisting">Why do we need hoisting?</span></h1><p>When asking such a question, you can think of it the other way around: “What if we don’t have hoisting?”</p>
<p>First, we must declare variables before we can use them.</p>
<p>This is actually a good practice. </p>
<p>Secondly, we must declare the function before we can use it. </p>
<p>This is not very convenient, as we may have to put the function declaration at the top of each file to ensure that the code below can call these functions. </p>
<p>Thirdly, it is impossible to achieve mutual function calls. </p>
<p>For example: </p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token punctuation">(</span>omittedCodeBlock<span class="token operator">-</span>7b50ff<span class="token punctuation">)</span> <span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>We call <code>logEvenOrOdd</code> inside the <code>loop</code>, and we also call <code>loop</code> inside <code>logEvenOrOdd</code>. If we don’t have hoisting, the above code cannot be achieved because you cannot simultaneously achieve A on top of B while B is on top of A. </p>
<p>So why do we need hoisting? It is to solve the above problem. </p>
<p>To add to the correctness of this statement, I quote an article for everyone to read. In <a target="_blank" rel="noopener" href="http://dmitrysoshnikov.com/notes/note-4-two-words-about-hoisting/">Note 4. Two words about “hoisting”.</a> the author mentioned that he raised the topic on Twitter and mentioned mutual recursion as one of the reasons for hoisting. Brendan Eich also acknowledged that FDs hoisting is “for mutual recursion &amp; generally to avoid painful bottom-up ML-like order”. </p>
<p>If you want to see the complete conversation screenshot, you can read this article: <a target="_blank" rel="noopener" href="https://www.cnblogs.com/liuhe688/p/5891273.html">JavaScript series: variable hoisting and function hoisting</a>, which is attached at the bottom. </p>
<h1><span id="how-does-hoisting-work">How does hoisting work?</span></h1><p>Now that we know what hoisting is and why we need it, the last missing piece of the puzzle is how hoisting works. </p>
<p>The best way to answer this question is to look at the ECMAScript specification. Just like when you want to study type conversion problems today, the solution is to look at the specification. The reason is simple because those rules are clearly written on it. </p>
<p>ECMAScript has many versions, and the later versions have more specifications. Therefore, for convenience, we use ES3 as an example below. </p>
<p>If you have read the rules of ES3, you will find that you cannot find anything related to hoisting as a keyword, and the paragraph related to this phenomenon is actually in Chapter 10: Execution Contexts. </p>
<p>Here is a very brief introduction to what Execution Contexts (EC) are. Whenever you enter a function, an EC is generated, which stores some information related to this function and puts this EC into the stack. When the function is executed, the EC is popped out. </p>
<p>The schematic diagram is roughly like this, remember that in addition to the EC of the function, there is also a global EC: </p>
<p><img src="https://user-images.githubusercontent.com/2755720/49352096-5d706b80-f6f1-11e8-82fe-8fbff9004184.png" alt="ec"><br>(Source: <a target="_blank" rel="noopener" href="https://medium.freecodecamp.org/lets-learn-javascript-closures-66feb44f6a44">https://medium.freecodecamp.org/lets-learn-javascript-closures-66feb44f6a44</a>) </p>
<p>In short, all the information needed by the function will exist in the EC, which is the execution environment. You can get everything you need from there. </p>
<p>ECMAScript describes it as follows: </p>
<blockquote>
<p>When control is transferred to ECMAScript executable code, control is entering an execution context. Active execution contexts logically form a stack. The top execution context on this logical stack is the running execution context. </p>
</blockquote>
<p>The key point is in <code>10.1.3 Variable Instantiation</code>: </p>
<blockquote>
<p>Every execution context has associated with it a variable object. Variables and functions declared in the source text are added as properties of the variable object. For function code, parameters are added as properties of the variable object.</p>
</blockquote>
<p>Each EC has a corresponding variable object (VO for short), in which the variables and functions declared will be added to the VO. If it is a function, the parameters will also be added to the VO.</p>
<p>First, you can think of VO as just a JavaScript object.</p>
<p>Next, when will VO be used? You will use it when accessing values. For example, in the statement <code>var a = 10</code>, it can be divided into two parts:</p>
<ol>
<li><code>var a</code>: add a property called “a” to VO (if there is no property called “a”) and initialize it to undefined.</li>
<li><code>a = 10</code>: find the property called “a” in VO and set it to 10.</li>
</ol>
<p>(What if it cannot find the property in VO? It will continuously search through the scope chain. If it cannot find it in any layer, an error will be thrown. Although the process of searching and creating the scope chain is related to this article, it is too much to explain. It is better to write another article separately, so I won’t mention it here.)</p>
<p>Next, let’s look at the next paragraph:</p>
<blockquote>
<p>Which object is used as the variable object and what attributes are used for the properties depends on the type of code, but the remainder of the behaviour is generic. On entering an execution context, the properties are bound to the variable object in the following order:</p>
</blockquote>
<p>The most essential sentence is “On entering an execution context, the properties are bound to the variable object in the following order”. When entering an EC, things will be put into VO in the following order:</p>
<p>The next paragraph is a bit long, so I’ll quote part of it:</p>
<blockquote>
<p>For function code: for each formal parameter, as defined in the FormalParameterList, create a property of the variable object whose name is the Identifier and whose attributes are determined by the type of code. The values of the parameters are supplied by the caller as arguments to [[Call]].</p>
<p>If the caller supplies fewer parameter values than there are formal parameters, the extra formal parameters have value undefined.</p>
</blockquote>
<p>In short, for parameters, they will be directly added to VO. If some parameters do not have values, their values will be initialized to undefined.</p>
<p>For example, if my function looks like this:</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token parameter">a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> c</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
<span class="token function">test</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>Then my VO will look like this:</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token punctuation">&#123;</span>
  <span class="token literal-property property">a</span><span class="token operator">:</span> <span class="token number">10</span><span class="token punctuation">,</span>
  <span class="token literal-property property">b</span><span class="token operator">:</span> <span class="token keyword">undefined</span><span class="token punctuation">,</span>
  <span class="token literal-property property">c</span><span class="token operator">:</span> <span class="token keyword">undefined</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>So parameters are the first priority, and then we look at the second one:</p>
<blockquote>
<p>For each FunctionDeclaration in the code, in source text order, create a property of the variable object whose name is the Identifier in the FunctionDeclaration, whose value is the result returned by creating a Function object as described in 13, and whose attributes are determined by the type of code. </p>
<p>If the variable object already has a property with this name, replace its value and attributes. Semantically, this step must follow the creation of FormalParameterList properties.</p>
</blockquote>
<p>For function declarations, a property will also be added to VO. As for the value, it is the result returned after creating the function (you can think of it as a pointer to the function).</p>
<p>Next is the key point: “If there is already an attribute with the same name in VO, overwrite it.” Here’s a small example:</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token parameter">a</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
  <span class="token keyword">function</span> <span class="token function">a</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span class="token function">test</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>The VO will look like this, and the original parameter <code>a</code> is overwritten:</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token punctuation">&#123;</span>
  <span class="token function-variable function">a</span><span class="token operator">:</span> <span class="token keyword">function</span> a
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>Now let’s take a look at how variable declarations should be handled:</p>
<blockquote>
<p>For each VariableDeclaration or VariableDeclarationNoIn in the code, create a property of the variable object whose name is the Identifier in the VariableDeclaration or VariableDeclarationNoIn, whose value is undefined and whose attributes are determined by the type of code. If there is already a property of the variable object with the name of a declared variable, the value of the property and its attributes are not changed. </p>
<p>Semantically, this step must follow the creation of the FormalParameterList and FunctionDeclaration properties. In particular, if a declared variable has the same name as a declared function or formal parameter, the variable declaration does not disturb the existing property.</p>
</blockquote>
<p>For variables, a new property is added to the VO with a value of undefined, and here’s the key point: “If the VO already has this property, the value will not be changed.”</p>
<p>To summarize, when we enter an EC (you can think of it as executing a function, but before running the code inside the function), we do the following three things in order:</p>
<ol>
<li>Put the parameters in the VO and set the values. Whatever is passed in is what it is, and if there is no value, it is set to undefined.</li>
<li>Put the function declaration in the VO, overwriting it if there is already one with the same name.</li>
<li>Put the variable declaration in the VO, ignoring it if there is already one with the same name.</li>
</ol>
<p>After reading and understanding the specification, you can use this theory to explain the code we saw earlier:</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token parameter">v</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span>
  <span class="token keyword">var</span> v <span class="token operator">=</span> <span class="token number">3</span>
<span class="token punctuation">&#125;</span>
<span class="token function">test</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>You can think of each function as having two stages of execution. The first stage is entering the EC, and the second stage is actually executing the code line by line.</p>
<p>When entering the EC, the VO is created. Since there are parameters passed in, v is put into the VO and its value is set to 10. Next, for the variable declaration inside, the VO already has the property v, so it is ignored. Therefore, the VO looks like this:</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token punctuation">&#123;</span>
  <span class="token literal-property property">v</span><span class="token operator">:</span> <span class="token number">10</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>After the VO is created, the code is executed line by line. This is why the second log prints 10, because at that time, the value of v in the VO was indeed 10.</p>
<p>If you change the code to this:</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token parameter">v</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span>
  <span class="token keyword">var</span> v <span class="token operator">=</span> <span class="token number">3</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span>
<span class="token function">test</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>Then the second log will print 3, because after executing the third line, the value in the VO is changed to 3.</p>
<p>The above is the execution process mentioned in the ES3 specification. If you remember this execution process, you don’t have to be afraid of any hoisting-related questions. Just follow the method in the specification to run it correctly.</p>
<p>After understanding this execution process, my first feeling was that everything became clear, and hoisting was no longer a mysterious thing. You just need to pretend that you are a JS engine and follow the process. My second feeling was, how does JS achieve this?</p>
<h1><span id="compilation-and-interpretation-how-does-the-js-engine-work">Compilation and Interpretation: How does the JS engine work?</span></h1><p>Do you remember when I mentioned earlier that when I was learning programming, there was always a concept that “interpretation” meant that the program was executed line by line, and as a language that was interpreted, shouldn’t JS also be executed line by line?</p>
<p>But if it really runs line by line, how can it achieve the hoisting function? It’s impossible to know what line n + 1 is when you execute line n, so it’s impossible to hoist.</p>
<p>I searched the internet for a long time for an answer to this question, and finally found an article that I think is quite reasonable: <a target="_blank" rel="noopener" href="http://rednaxelafx.iteye.com/blog/492667">Virtual Machine Talk (1): Interpreter, Tree Traversal Interpreter, Stack-Based and Register-Based, Hodgepodge</a>.</p>
<p>There are a few points mentioned in the article that I think are very well written and have dispelled many of my previous misconceptions:</p>
<p>First, languages generally only define abstract semantics and do not enforce a specific implementation method. For example, we say that C is a compiled language, but C also has an interpreter. So when we say that a certain programming language is interpreted or compiled, we are actually referring to “most” rather than all.</p>
<p>In other words, when we say that JavaScript is an interpreted language, it does not mean that JavaScript cannot have a compiler, and vice versa.</p>
<p>Second, the biggest difference between an interpreter and a compiler is “execution”.</p>
<p>The compilation step is simply to compile the source code A into the target code B, but you need to ensure that the results of executing A and B are the same.</p>
<p>Interpretation is when you input the source code A, and the output is directly the semantics that you want to execute in your code. How it is done inside is a black box.</p>
<p>There is a good picture in the original article:</p>
<p><img src="https://user-images.githubusercontent.com/2755720/49352101-65301000-f6f1-11e8-87db-f0c99a22b7de.png" alt="compile"></p>
<p>So there can also be compilation inside an interpreter, and this is not conflicting. Or you can write a super simple interpreter that compiles your source code and then executes it.</p>
<p>In fact, many types of interpreters operate by first compiling the source code into some intermediate code before executing it, so the compilation step is still very common, and JS also works this way.</p>
<p>When you abandon the old concept of “JS must be executed line by line” and embrace the idea that “actually mainstream JS engines have a compilation step”, you will not think that hoisting is an impossible thing to achieve.</p>
<p>As we have seen in the specification, we know the operating mode in ES3 and know about VO, but what the specification describes is only abstract, and it does not say where the processing is actually done, and this place is actually the compilation phase.</p>
<p>Speaking of the issue of compilation and interpretation, I have been stuck for a long time because there are many incorrect concepts in the past. Now I am slowly correcting them, and for hoisting, I actually had some confusion before about the difference between the specification and the implementation. Later, I even went to ask the author of You-Dont-Know-JS and was lucky enough to get a reply. Interested people can take a look: <a target="_blank" rel="noopener" href="https://github.com/getify/You-Dont-Know-JS/issues/1375">https://github.com/getify/You-Dont-Know-JS/issues/1375</a>.</p>
<h1><span id="operation-of-js-engine">Operation of JS engine</span></h1><p>As I mentioned above, mainstream JS engines now have a compilation phase, and hoisting is actually processed during this phase. With the introduction of the compilation phase, JS can be divided into two steps: compilation phase and execution phase.</p>
<p>During the compilation phase, all variable and function declarations are processed and added to the scope, and they can be used during execution. This article explains it very well: <a target="_blank" rel="noopener" href="https://john-dugan.com/hoisting-in-javascript/">Hoisting in JavaScript</a>, and I will just modify the code inside as an example.</p>
<p>For example, I have this piece of code:</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">var</span> foo <span class="token operator">=</span> <span class="token string">"bar"</span>
<span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token number">1</span>
<span class="token keyword">function</span> <span class="token function">bar</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    foo <span class="token operator">=</span> <span class="token string">"inside bar"</span>
    <span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token number">2</span>
    c <span class="token operator">=</span> <span class="token number">3</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>d<span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span>
<span class="token function">bar</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>During the compilation phase, the declaration part is processed, so it will be like this:</p>
<pre class="line-numbers language-none"><code class="language-none">Line 1：global scope，我要宣告一個變數叫做 foo
Line 2：global scope，我要宣告一個變數叫做 a
Line 3：global scope，我要宣告一個函式叫做 bar
Line 4：沒有任何變數宣告，不做事
Line 5：bar scope，我要宣告一個變數叫做 a
Line 6：沒有任何變數宣告，不做事
Line 7：沒有任何變數宣告，不做事
Line 8：沒有任何變數宣告，不做事<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>After processing, it looks like this:</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token literal-property property">globalScope</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
  <span class="token literal-property property">foo</span><span class="token operator">:</span> <span class="token keyword">undefined</span><span class="token punctuation">,</span>
  <span class="token literal-property property">a</span><span class="token operator">:</span> <span class="token keyword">undefined</span><span class="token punctuation">,</span>
  <span class="token function-variable function">bar</span><span class="token operator">:</span> <span class="token keyword">function</span>
<span class="token punctuation">&#125;</span>
  
<span class="token literal-property property">barScope</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
  <span class="token literal-property property">a</span><span class="token operator">:</span> <span class="token keyword">undefined</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>Next, enter the execution phase. There are two proprietary terms to remember before introducing them. It is better to understand them with an example:</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token number">10</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>There is a difference between these two lines. When we write the first line, we only need to know “where is the memory location of a”, and we don’t care what its value is.</p>
<p>The second line is “we only care about its value, give me the value”, so even though both lines have <code>a</code>, you can see that what they want to do is different.</p>
<p>We call the <code>a</code> in the first line an LHS (Left hand side) reference, and the <code>a</code> in the second line an RHS (Right hand side) reference. The left and right here refer to the left and right sides relative to the equal sign, but this way of understanding is not precise enough, so it is better to remember it like this:</p>
<p>LHS: Please help me find the location of this variable because I want to assign a value to it.<br>RHS: Please help me find the value of this variable because I want to use this value.</p>
<p>With this concept, let’s take a look at the example code above step by step:</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">var</span> foo <span class="token operator">=</span> <span class="token string">"bar"</span>
<span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token number">1</span>
<span class="token keyword">function</span> <span class="token function">bar</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    foo <span class="token operator">=</span> <span class="token string">"inside bar"</span>
    <span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token number">2</span>
    c <span class="token operator">=</span> <span class="token number">3</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>d<span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span>
<span class="token function">bar</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3><span id="line-1-var-foo-x3d-bar">Line 1: var foo &#x3D; “bar”</span></h3><p>JS engine: global scope, do I have an LHS reference to foo here?<br>Execution result: The scope says yes, so it successfully finds foo and assigns a value to it.</p>
<p>The global scope at this time:</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token punctuation">&#123;</span>
  <span class="token literal-property property">foo</span><span class="token operator">:</span> <span class="token string">"bar"</span><span class="token punctuation">,</span>
  <span class="token literal-property property">a</span><span class="token operator">:</span> <span class="token keyword">undefined</span><span class="token punctuation">,</span>
  <span class="token function-variable function">bar</span><span class="token operator">:</span> <span class="token keyword">function</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3><span id="line-2-var-a-x3d-1">Line 2: var a &#x3D; 1</span></h3><p>JS Engine: Global scope, do I have an LHS reference to a? Have you seen it?<br>Execution result: Scope says yes, so it successfully finds a and assigns it a value.</p>
<p>The global scope at this point:</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token punctuation">&#123;</span>
  <span class="token literal-property property">foo</span><span class="token operator">:</span> <span class="token string">"bar"</span><span class="token punctuation">,</span>
  <span class="token literal-property property">a</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
  <span class="token function-variable function">bar</span><span class="token operator">:</span> <span class="token keyword">function</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3><span id="line-10-bar">Line 10: bar()</span></h3><p>JS Engine: Global scope, do I have an RHS reference to bar? Have you seen it?<br>Execution result: Scope says yes, so it successfully returns the value of bar and calls the function.</p>
<h3><span id="line-4-foo-x3d-inside-bar">Line 4: foo &#x3D; “inside bar”</span></h3><p>JS Engine: Bar scope, do I have an LHS reference to foo? Have you seen it?<br>Execution result: Bar scope says no, so it goes to the previous global scope.<br>JS Engine: Global scope, do I have an LHS reference to foo? Have you seen it?<br>Execution result: Yes, so it successfully finds foo and assigns it a value.</p>
<p>The global scope at this point:</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token punctuation">&#123;</span>
  <span class="token literal-property property">foo</span><span class="token operator">:</span> <span class="token string">"inside bar"</span><span class="token punctuation">,</span>
  <span class="token literal-property property">a</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
  <span class="token function-variable function">bar</span><span class="token operator">:</span> <span class="token keyword">function</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3><span id="line-5-var-a-x3d-2">Line 5: var a &#x3D; 2</span></h3><p>JS Engine: Bar scope, do I have an LHS reference to a? Have you seen it?<br>Execution result: Bar scope says yes, so it successfully finds a and assigns it a value.</p>
<p>The bar scope at this point:</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token punctuation">&#123;</span>
  <span class="token literal-property property">a</span><span class="token operator">:</span> <span class="token number">2</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<h3><span id="line-6-c-x3d-3">Line 6: c &#x3D; 3</span></h3><p>JS Engine: Bar scope, do I have an LHS reference to c? Have you seen it?<br>Execution result: Bar scope says no, so it goes to the previous global scope.<br>JS Engine: Global scope, do I have an LHS reference to c? Have you seen it?<br>Execution result: No.</p>
<p>At this point, there are several possible outcomes. If you are in strict mode (<code>use strict</code>), it will return a <code>ReferenceError: c is not defined</code> error. If you are not in strict mode, the global scope will add c and set it to 3. Here, we assume that we are not in strict mode.</p>
<p>The global scope at this point:</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token punctuation">&#123;</span>
  <span class="token literal-property property">foo</span><span class="token operator">:</span> <span class="token string">"inside bar"</span><span class="token punctuation">,</span>
  <span class="token literal-property property">a</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
  <span class="token function-variable function">bar</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">,</span>
  <span class="token literal-property property">c</span><span class="token operator">:</span> <span class="token number">3</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3><span id="line-7-consolelogc">Line 7: console.log(c)</span></h3><p>JS Engine: Bar scope, do I have an RHS reference to c? Have you seen it?<br>Execution result: Bar scope says no, so it goes to the previous global scope.<br>JS Engine: Global scope, do I have an RHS reference to c? Have you seen it?<br>Execution result: Yes, so it successfully returns the value of c and calls console.log.</p>
<h3><span id="line-8-consolelogd">Line 8: console.log(d)</span></h3><p>JS Engine: Bar scope, do I have an RHS reference to d? Have you seen it?<br>Execution result: Bar scope says no, so it goes to the previous global scope.<br>JS Engine: Global scope, do I have an RHS reference to d? Have you seen it?<br>Execution result: No, so it returns an error <code>ReferenceError: d is not defined</code>.</p>
<p>The above is the working process of the JS engine. For more detailed information, please refer to: <a target="_blank" rel="noopener" href="https://github.com/getify/You-Dont-Know-JS/tree/2nd-ed/scope-closures">You Don’t Know JS: Scope &amp; Closures</a>, <a target="_blank" rel="noopener" href="https://github.com/getify/You-Dont-Know-JS/blob/2nd-ed/scope-closures/ch5.md">Chapter 4: Hoisting</a>, <a target="_blank" rel="noopener" href="https://john-dugan.com/hoisting-in-javascript/">Hoisting in JavaScript</a>.</p>
<h1><span id="summary">Summary</span></h1><p>Let’s review the ten items we mentioned at the beginning:</p>
<ol>
<li>Do you know what hoisting is?</li>
<li>Do you know that hoisting only hoists declarations, not assignments?</li>
<li>Do you know the hoisting priority when function declarations, function parameters, and variable declarations appear together?</li>
<li>Do you know that let and const do not have hoisting?</li>
<li>Do you know that the fourth item is wrong and that they do have hoisting, but the form is different?</li>
<li>Do you know that there is a concept called TDZ (Temporal Dead Zone) related to the fifth item?</li>
<li>Have you read the ES3 specification and know how it is described?</li>
<li>Have you read the ES6 specification and know how it is described?</li>
<li>Do you know the principle behind hoisting?</li>
<li>Have you seen the code compiled by V8?</li>
</ol>
<p>We have covered all seven points in great detail, and what’s left is:</p>
<ol>
<li>You know about the concept of TDZ (Temporal Dead Zone) related to the sixth point.</li>
<li>You have seen how it is described in the ES6 specification.</li>
<li>You have seen the code compiled by V8.</li>
</ol>
<p>I don’t plan to go into detail about the ES6 specification (and I haven’t read it in detail yet), because there are still many changes, but the basic principles remain the same. It’s just that there are some proprietary terms added. If you want to know more, you can refer to this classic article: <a target="_blank" rel="noopener" href="http://dmitrysoshnikov.com/ecmascript/es5-chapter-3-2-lexical-environments-ecmascript-implementation/">ECMA-262-5 in detail. Chapter 3.2. Lexical environments: ECMAScript implementation.</a>.</p>
<p>We have already covered a lot of things related to hoisting, and all the mechanisms related to hoisting have been explained. However, I believe it will still take some time to absorb all of this. But I believe that after you have absorbed it, you will feel refreshed and realize that hoisting is not that complicated.</p>
<p>Next, we will move on to the last part of this article, which is TDZ and V8.</p>
<h1><span id="temporal-dead-zone">Temporal Dead Zone</span></h1><p>Do you remember that we said let and const actually have hoisting? And we gave a small example to verify this.</p>
<p>Let and const do have hoisting. The difference between them and var is that after hoisting, the variable declared by var is initialized to undefined, while the declaration of let and const is not initialized to undefined. And if you try to access it before “assignment”, an error will be thrown.</p>
<p>During the “period” after hoisting and before “assignment”, if you try to access it, an error will be thrown. This period is called the TDZ, which is a term proposed to explain the hoisting behavior of let and const.</p>
<p>We use the following code as an example:</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment">// c 的 TDZ 開始</span>
    <span class="token keyword">var</span> b <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span> <span class="token comment">// 錯誤</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>a <span class="token operator">></span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">let</span> c <span class="token operator">=</span> <span class="token number">10</span> <span class="token comment">// c 的 TDZ 結束</span>
<span class="token punctuation">&#125;</span>
<span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>If you try to access c before line 8 is executed, an error will be thrown. Note that TDZ is not a spatial concept, but a temporal one. For example, in the following code:</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token function">yo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// c 的 TDZ 開始</span>
    <span class="token keyword">let</span> c <span class="token operator">=</span> <span class="token number">10</span> <span class="token comment">// c 的 TDZ 結束</span>
    <span class="token keyword">function</span> <span class="token function">yo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>When you enter the test function, c is already in the TDZ, so when you execute yo and execute <code>console.log(c)</code>, you are still in the TDZ, and you have to wait until <code>let c = 10</code> is executed to end the TDZ.</p>
<p>So it’s not that putting <code>console.log(c)</code> below <code>let c = 10</code> solves the problem, but that it needs to be executed later in the “execution order”.</p>
<p>Or you can ignore these terms and summarize it in one sentence:</p>
<blockquote>
<p>Let and const also have hoisting, but they are not initialized to undefined, and an error will be thrown if you try to access them before assignment.</p>
</blockquote>
<h1><span id="byte-code-reading-experience">Byte code reading experience</span></h1><p>Since we talked about the JS engine above, it would be a pity not to talk about V8. When I was studying hoisting, I always wanted to know one thing: what does the code compiled by V8 look like?</p>
<p>Thanks to this wonderful article <a target="_blank" rel="noopener" href="https://medium.com/dailyjs/understanding-v8s-bytecode-317d46c94775">Understanding V8’s Bytecode</a>, we can try to compile the code into byte code using node.js and try to interpret it.</p>
<p>Before we start, let’s introduce what byte code is. It is a language between high-level languages and machine code. It is not as easy to understand as high-level languages, but it is much easier to understand than machine code, and it is more efficient to execute.</p>
<p>The following figure explains the relationship between them very clearly:</p>
<p><img src="https://user-images.githubusercontent.com/2755720/49352109-71b46880-f6f1-11e8-864d-892a284e6650.png" alt="byte"></p>
<p>Next, we use this simple function as an example to see what it looks like after compilation:</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">funcA</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token number">10</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span>
<span class="token function">funcA</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>Although there is only one function, there will still be a lot of things when running with node.js, so we put the result into a file first: <code>node --print-bytecode test.js &gt; byte_code.txt</code></p>
<p>The compiled result looks like this:</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token punctuation">[</span>generating bytecode <span class="token keyword">for</span> <span class="token keyword">function</span><span class="token operator">:</span> funcA<span class="token punctuation">]</span>
Parameter count <span class="token number">1</span>
Frame size <span class="token number">24</span>
   <span class="token number">76</span> <span class="token constant">E</span><span class="token operator">></span> <span class="token number">0xeefa4feb062</span> @    <span class="token number">0</span> <span class="token operator">:</span> <span class="token number">91</span>                StackCheck 
   <span class="token number">93</span> <span class="token constant">S</span><span class="token operator">></span> <span class="token number">0xeefa4feb063</span> @    <span class="token number">1</span> <span class="token operator">:</span> <span class="token number">03</span> 0a             LdaSmi <span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span>
         <span class="token number">0xeefa4feb065</span> @    <span class="token number">3</span> <span class="token operator">:</span> 1e fb             Star r0
  <span class="token number">100</span> <span class="token constant">S</span><span class="token operator">></span> <span class="token number">0xeefa4feb067</span> @    <span class="token number">5</span> <span class="token operator">:</span> 0a <span class="token number">00</span> <span class="token number">02</span>          LdaGlobal <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span>
         <span class="token number">0xeefa4feb06a</span> @    <span class="token number">8</span> <span class="token operator">:</span> 1e f9             Star r2
  <span class="token number">108</span> <span class="token constant">E</span><span class="token operator">></span> <span class="token number">0xeefa4feb06c</span> @   <span class="token number">10</span> <span class="token operator">:</span> <span class="token number">20</span> f9 <span class="token number">01</span> <span class="token number">04</span>       LdaNamedProperty r2<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span>
         <span class="token number">0xeefa4feb070</span> @   <span class="token number">14</span> <span class="token operator">:</span> 1e fa             Star r1
  <span class="token number">108</span> <span class="token constant">E</span><span class="token operator">></span> <span class="token number">0xeefa4feb072</span> @   <span class="token number">16</span> <span class="token operator">:</span> 4c fa f9 fb <span class="token number">00</span>    CallProperty1 r1<span class="token punctuation">,</span> r2<span class="token punctuation">,</span> r0<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
         <span class="token number">0xeefa4feb077</span> @   <span class="token number">21</span> <span class="token operator">:</span> <span class="token number">04</span>                LdaUndefined 
  <span class="token number">115</span> <span class="token constant">S</span><span class="token operator">></span> <span class="token number">0xeefa4feb078</span> @   <span class="token number">22</span> <span class="token operator">:</span> <span class="token number">95</span>                Return 
Constant <span class="token function">pool</span> <span class="token punctuation">(</span>size <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">)</span>
Handler <span class="token function">Table</span> <span class="token punctuation">(</span>size <span class="token operator">=</span> <span class="token number">16</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>We clear some of the information at the beginning and add comments to let you know what the above code means (I don’t really understand it, and there seems to be little information on this aspect. Please correct me if I’m wrong):</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">StackCheck 
LdaSmi <span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span>                    <span class="token comment">// 把 10 放到 accumulator 裡面</span>
Star r0                        <span class="token comment">// 把 accumulator 的值放到 r0 裡，所以 r0 = 10</span>
LdaGlobal <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span>             <span class="token comment">// 載入一個 Global 的東西到 acc 裡</span>
Star r2                        <span class="token comment">// 把它存到 r2，根據後見之明，r2 應該就是 console</span>
LdaNamedProperty r2<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span>  <span class="token comment">// 載入一個 r2 的 Property（應該就是 log）</span>
Star r1                        <span class="token comment">// 把它存到 r1，也就是 r1 = console.log</span>
CallProperty1 r1<span class="token punctuation">,</span> r2<span class="token punctuation">,</span> r0<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>  <span class="token comment">// console.log.call(console, 10)</span>
LdaUndefined                   <span class="token comment">// 把 undefined 放到 acc</span>
Return                         <span class="token comment">// return undefined</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>Then we reverse the order to look like this:</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">funcA</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span>
    <span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token number">10</span>
<span class="token punctuation">&#125;</span>
<span class="token function">funcA</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>Let’s take a look at what the output byte code looks like. Before explaining, you can compare it with the previous one to see the difference:</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">StackCheck
LdaGlobal <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span>             <span class="token comment">// 載入一個 Global 的東西到 acc 裡</span>
Star r2                        <span class="token comment">// 把它存到 r2，根據後見之明，r2 應該就是 console</span>
LdaNamedProperty r2<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span>  <span class="token comment">// 載入一個 r2 的 Property（應該就是 log）</span>
Star r1                        <span class="token comment">// 把它存到 r1，也就是 r1 = console.log</span>
CallProperty1 r1<span class="token punctuation">,</span> r2<span class="token punctuation">,</span> r0<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>  <span class="token comment">// console.log.call(console, undefined)</span>
LdaSmi <span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span>                    <span class="token comment">// 把 10 放到 accumulator 裡面</span>
Star r0                        <span class="token comment">// 把 accumulator 的值放到 r0 裡，所以 r0 = 10</span>
LdaUndefined                   <span class="token comment">// 把 undefined 放到 acc</span>
Return                         <span class="token comment">// return undefined </span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>Actually, the only difference is that the order has been changed, and r0 is directly logged in the output. I’m not sure if r0 was originally undefined or if it was initialized as undefined elsewhere.</p>
<p>Next, let’s see what happens if we try to print an undeclared variable:</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">funcA</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span>
    <span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token number">10</span>
<span class="token punctuation">&#125;</span>
<span class="token function">funcA</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>Because most of the code is duplicated from before, I won’t comment on it again:</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">StackCheck 
LdaGlobal <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span>
Star r2
LdaNamedProperty r2<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span>
Star r1
LdaGlobal <span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span>  <span class="token comment">// 試圖載入 b 的值，出錯</span>
Star r3
CallProperty1 r1<span class="token punctuation">,</span> r2<span class="token punctuation">,</span> r3<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
LdaSmi <span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span>
Star r0
LdaUndefined 
Return     <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>The key point of the whole paragraph is only the line <code>LdaGlobal</code>, which seems to be loading the value of b. It should be this line that causes the error during execution because b cannot be found in the global scope.</p>
<p>After reading the basics, let’s see what let is compiled into:</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">funcA</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span>
    <span class="token keyword">let</span> a <span class="token operator">=</span> <span class="token number">10</span>
<span class="token punctuation">&#125;</span>
<span class="token function">funcA</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>The compiled result:</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">LdaTheHole                    <span class="token comment">// 把 hole 載入到 acc 去</span>
Star r0                       <span class="token comment">// r0 = hole</span>
StackCheck 
LdaGlobal <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span>            
Star r2                       <span class="token comment">// r2 = console</span>
LdaNamedProperty r2<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span>
Star r1                       <span class="token comment">// r1 = console.log</span>
Ldar r0                       <span class="token comment">// 載入 r0</span>
ThrowReferenceErrorIfHole <span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token comment">// 拋出錯誤</span>
CallProperty1 r1<span class="token punctuation">,</span> r2<span class="token punctuation">,</span> r0<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token comment">// console.log.call(console, r0)</span>
LdaSmi <span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span>
Star r0
LdaUndefined 
Return<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>You will see a mysterious thing called a hole, which is actually what we call the TDZ. That’s why there is a line <code>ThrowReferenceErrorIfHole</code>, which means that if we try to access the value of this hole before the TDZ ends, an error will be thrown.</p>
<p>So far, we have explained how the TDZ actually works during the compilation phase, using this special thing called a hole.</p>
<h1><span id="conclusion">Conclusion</span></h1><p>Recently, I have been trying to fill in some of my basic knowledge of JavaScript. If I hadn’t read two articles, <a target="_blank" rel="noopener" href="http://www.cnblogs.com/leoo2sk/archive/2010/12/19/ecmascript-scope.htm">解读ECMAScript[1]——执行环境、作用域及闭包</a> and <a target="_blank" rel="noopener" href="https://github.com/nightn/front-end-plan/blob/master/js/js-scope.md">JS 作用域</a>, I probably wouldn’t have written this article.</p>
<p>Several points that are frequently tested in JavaScript are well-known: this, prototype, closure, and hoisting. These seemingly unrelated things can be somewhat connected if you can understand the underlying operating model of JavaScript, forming a complete theory.</p>
<p>I also mentioned in the article that the process of explaining the execution environment can be supplemented to explain closures. You will find that many things can actually be integrated. If I have the opportunity in the future, I will turn this into a series and break down those concepts in JavaScript that you think are difficult but actually aren’t.</p>
<p>Before writing this article, I had been brewing it for about a month, constantly looking for information, digesting it, and transforming it into my own understanding. I am also very grateful to the author of the JS scope article and the author of YDKJS for patiently answering my questions.</p>
<p>Finally, I hope this article is helpful to you. If there are any errors, please let me know. Thank you.</p>
<p>References:</p>
<ol>
<li><a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-TW/docs/Glossary/Hoisting">MDN: Hoisting</a></li>
<li><a target="_blank" rel="noopener" href="http://dmitrysoshnikov.com/ecmascript/chapter-2-variable-object/#phases-of-processing-the-context-code">ECMA-262-3 in detail. Chapter 2. Variable object.</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/nightn/front-end-plan/blob/master/js/js-scope.md">JS 作用域</a></li>
<li><a target="_blank" rel="noopener" href="http://benediktmeurer.de/2017/06/29/javascript-optimization-patterns-part2/">JavaScript Optimization Patterns (Part 2)</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/danbev/learning-v8">danbev&#x2F;learning-v8</a></li>
<li><a target="_blank" rel="noopener" href="http://2ality.com/2015/10/why-tdz.html">Why is there a “temporal dead zone” in ES6?</a></li>
<li><a target="_blank" rel="noopener" href="http://exploringjs.com/es6/ch_variables.html#_the-temporal-dead-zone">exploringjs: Variables and scoping #</a></li>
<li><a target="_blank" rel="noopener" href="https://juejin.cn/post/6844903461511774221">由阮一峰老师的一条微博引发的 TDZ 思考</a></li>
<li><a target="_blank" rel="noopener" href="https://segmentfault.com/a/1190000008213835">理解ES6中的暂时死区(TDZ)</a></li>
<li><a target="_blank" rel="noopener" href="http://jsrocks.org/2015/01/temporal-dead-zone-tdz-demystified">TEMPORAL DEAD ZONE (TDZ) DEMYSTIFIED</a></li>
<li><a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Statements/let#Another_example_of_temporal_dead_zone_combined_with_lexical_scoping">MDN: let</a></li>
<li><a target="_blank" rel="noopener" href="https://mrale.ph/blog/2012/09/23/grokking-v8-closures-for-fun.html">Grokking V8 closures for fun (and profit?)</a></li>
<li><a target="_blank" rel="noopener" href="http://www.cnblogs.com/leoo2sk/archive/2010/12/19/ecmascript-scope.htm">解读ECMAScript[1]——执行环境、作用域及闭包</a></li>
</ol>

    
    </div>
    
    <div class="columns is-variable is-1 is-multiline is-mobile">
    
        <span class="column is-narrow"><a class="tag is-light article-tag" href="/en/tags/Front-end/">#Front-end</a></span>
    
        <span class="column is-narrow"><a class="tag is-light article-tag" href="/en/tags/JavaScript/">#JavaScript</a></span>
    
    </div>
    
    
    <div class="columns is-mobile is-multiline article-nav">
        <span class="column is-12-mobile is-half-desktop  article-nav-prev">
            
            <a href="/2018/12/08/en/javascript-closure/">All Functions are Closures: Discussing Scope and Closure in JS</a>
            
        </span>
        <span class="column is-12-mobile is-half-desktop  article-nav-next">
            
            <a href="/2018/10/13/en/pwa-in-action/">PWA Practical Experience Sharing</a>
            
        </span>
    </div>
    
</article>




<div class="comments">
    <h3 class="title is-4">Comments</h3>
    <script src="https://utteranc.es/client.js"
        repo="aszx87410/huli-blog"
        issue-term="title"
        theme="github-light"
        crossorigin="anonymous"
        async>
</script>
</div>

    </div>
</section>
    <footer class="footer">
    <div class="container">
        <div class="columns content">
            <div class="column is-narrow has-text-centered">
                &copy; 2025 Huli&nbsp;
                Powered by <a href="http://hexo.io/" target="_blank">Hexo</a> & <a
                        target="_blank" rel="noopener" href="http://github.com/ppoffice/hexo-theme-minos">Minos</a>
            </div>
            <div class="column is-hidden-mobile"></div>

            
            <div class="column is-narrow">
                <div class="columns is-mobile is-multiline is-centered">
                
                    
                <a class="column is-narrow" title="GitHub" target="_blank" rel="noopener" href="https://github.com/ppoffice/hexo-theme-minos">
                    
                    GitHub
                    
                </a>
                
                </div>
            </div>
            
            
<div class="column is-narrow has-text-centered">
    <div class="dropdown is-up is-right is-hoverable" style="margin-top: -0.2em;">
        <div class="dropdown-trigger">
            <button class="button is-small" aria-haspopup="true">
                <span class="icon">
                    <i class="fas fa-globe"></i>
                </span>
                <span>English</span>
                <span class="icon is-small">
            <i class="fas fa-angle-down" aria-hidden="true"></i>
          </span>
            </button>
        </div>
        <div class="dropdown-menu has-text-left" role="menu" style="top:100%">
            <div class="dropdown-content">
            <!-- NOTE: 永遠回到首頁 -->
            
                <a href="/2018/11/10/javascript-hoisting-and-tdz/" class="dropdown-item">
                    繁體中文
                </a>
            
            </div>
        </div>
    </div>
</div>

        </div>
    </div>
</footer>
    <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/3.6.3/jquery.min.js"></script>



    
    
    
    
    
    
<script src="//cdnjs.cloudflare.com/ajax/libs/lightgallery/1.6.8/js/lightgallery-all.min.js"></script>
<script>
    (function ($) {
        $(document).ready(function () {
            if (typeof($.fn.lightGallery) === 'function') {
                $('.article.gallery').lightGallery({ selector: '.gallery-item' });
            }
        });
    })(jQuery);
</script>

    
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.0/clipboard.min.js"></script>
    <style>
        .hljs {
            position: relative;
        }

        .hljs .clipboard-btn {
            float: right;
            color: #9a9a9a;
            background: none;
            border: none;
            cursor: pointer;
        }

        .hljs .clipboard-btn:hover {
          color: #8a8a8a;
        }

        .hljs > .clipboard-btn {
            display: none;
            position: absolute;
            right: 4px;
            top: 4px;
        }

        .hljs:hover > .clipboard-btn {
            display: inline;
        }

        .hljs > figcaption > .clipboard-btn {
            margin-right: 4px;
        }
    </style>
    <script>
      $(document).ready(function () {
        $('figure.hljs').each(function(i, figure) {
          var codeId = 'code-' + i;
          var code = figure.querySelector('.code');
          var copyButton = $('<button>Copy <i class="far fa-clipboard"></i></button>');
          code.id = codeId;
          copyButton.addClass('clipboard-btn');
          copyButton.attr('data-clipboard-target-id', codeId);

          var figcaption = figure.querySelector('figcaption');

          if (figcaption) {
            figcaption.append(copyButton[0]);
          } else {
            figure.prepend(copyButton[0]);
          }
        })

        var clipboard = new ClipboardJS('.clipboard-btn', {
          target: function(trigger) {
            return document.getElementById(trigger.getAttribute('data-clipboard-target-id'));
          }
        });
        clipboard.on('success', function(e) {
          e.clearSelection();
        })
      })
    </script>

    
    

    



<script src="/js/script.js?v=3.js"></script>


    
</body>
</html>