<!DOCTYPE html>
<html class="has-navbar-fixed-top" lang="zh-tw">
<head>
    <meta charset="utf-8">
<title>自己架一個 Online Judge 系統 - Huli&#39;s blog</title>
<meta name="viewport" content="width=device-width, initial-scale=1">


<link href="https://blog.huli.tw/2020/03/23/build-your-own-online-judge-system/" rel="alternate" hreflang="zh-TW" />


<link href="https://blog.huli.tw/2020/03/23/build-your-own-online-judge-system/" rel="alternate" hreflang="x-default" />


            
<link href="https://blog.huli.tw/2020/03/23/en/build-your-own-online-judge-system/" rel="alternate" hreflang="en" />
            





    
<link rel="canonical" href="https://blog.huli.tw/2020/03/23/build-your-own-online-judge-system/">
    





    <meta name="description" content="前言先稍微介紹一下什麼是 Online Judge（底下簡稱 OJ）系統，簡單來說就是像 leetcode 那樣啦，可以送出程式碼解題，然後讓系統去批改，並且得到最後的結果。底下是 leetcode 的截圖：  在 leetcode 流行以前，最知名的 OJ 大概就是 UVa Online Judge，俗稱 ACM，而台灣的話應該就是 ZeroJudge 比較有名。 如果剛好有需求，想要自己架一個">
<meta property="og:type" content="article">
<meta property="og:title" content="自己架一個 Online Judge 系統">
<meta property="og:url" content="https://blog.huli.tw/2020/03/23/build-your-own-online-judge-system/index.html">
<meta property="og:site_name" content="Huli&#39;s blog">
<meta property="og:description" content="前言先稍微介紹一下什麼是 Online Judge（底下簡稱 OJ）系統，簡單來說就是像 leetcode 那樣啦，可以送出程式碼解題，然後讓系統去批改，並且得到最後的結果。底下是 leetcode 的截圖：  在 leetcode 流行以前，最知名的 OJ 大概就是 UVa Online Judge，俗稱 ACM，而台灣的話應該就是 ZeroJudge 比較有名。 如果剛好有需求，想要自己架一個">
<meta property="og:locale" content="zh_TW">
<meta property="og:image" content="https://static.coderbridge.com/img/aszx87410/47ea051cb4244849908286177e42a38f.png">
<meta property="og:image" content="https://static.coderbridge.com/img/aszx87410/0664ed7eeb6b478db132935202dee433.png">
<meta property="og:image" content="https://static.coderbridge.com/img/aszx87410/950d37d94365471ab8cf0b1f5f820d31.png">
<meta property="og:image" content="https://static.coderbridge.com/img/aszx87410/8d236caa632b42c6bde5c33c06f2ef3f.png">
<meta property="og:image" content="https://static.coderbridge.com/img/aszx87410/016853899af54a40b11801d3e1d5f8d7.png">
<meta property="article:published_time" content="2020-03-23T14:58:31.000Z">
<meta property="article:modified_time" content="2023-05-07T01:15:16.475Z">
<meta property="article:author" content="Huli">
<meta property="article:tag" content="Others">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://static.coderbridge.com/img/aszx87410/47ea051cb4244849908286177e42a38f.png">



<link rel="alternative" href="/atom.xml" title="自己架一個 Online Judge 系統" type="application/atom+xml">



<link rel="icon" href="/img/lidemy_logo.png">


<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Ovo|Source+Code+Pro">


<link rel="stylesheet" href="/css/bulma.css?v=2.css">



<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/lightgallery/1.6.8/css/lightgallery.min.css">


<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/line-numbers/prism-line-numbers.min.css" />


<link rel="stylesheet" href="/css/style.css?v=4.css">





    
    
    
    
    
    
    
    
    
    
<script async src="https://www.googletagmanager.com/gtag/js?id=G-1393J2EVCZ"></script>
<script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-1393J2EVCZ');
</script>


    


<meta name="generator" content="Hexo 6.3.0"></head>
<body>
    <script>
        if (localStorage.getItem('dark-mode')) {
            if (localStorage.getItem('dark-mode') === 'true') {
                document.body.classList.add('dark-mode')
            }
        } else {
            if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                document.body.classList.add('dark-mode')
            }
        }
    </script>
    
<nav class="navbar is-transparent is-fixed-top navbar-main" role="navigation" aria-label="main navigation">
    <div class="container">
        <div class="navbar-brand">
            <a class="navbar-item navbar-logo" href="/">
                
                    
                    Huli&#39;s blog
                    
                
            </a>
            <div class="navbar-burger">
                <span></span>
                <span></span>
                <span></span>
            </div>
        </div>
        
        <div class="navbar-menu navbar-start">
            
            <a class="navbar-item "
               href="/archives">文章列表</a>
            
            <a class="navbar-item "
               href="/categories">分類</a>
            
            <a class="navbar-item "
               href="/recommend">推薦閱讀</a>
            
            <a class="navbar-item "
               href="/about">關於我</a>
            
        </div>
        
        <div class="navbar-menu navbar-end">
            
            
            <div class="navbar-item is-hoverable has-dropdown is-hidden-mobile is-hidden-tablet-only toc">
                <a class="navbar-item" title="目錄">
                    目錄
                </a>
                <div class="navbar-dropdown">
                    
                    
                    
                    
                    <a class="navbar-item" href="#前言">1&nbsp;&nbsp;<b>前言</b></a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#開源-oj-系統">2&nbsp;&nbsp;<b>開源 OJ 系統</b></a>
                    
                    
                    
                    <a class="navbar-item" href="#dmoj">2.1&nbsp;&nbsp;DMOJ</a>
                    
                    
                    
                    <a class="navbar-item" href="#noj">2.2&nbsp;&nbsp;NOJ</a>
                    
                    
                    
                    <a class="navbar-item" href="#qduoj">2.3&nbsp;&nbsp;QDUOJ</a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#進一步研究-qduoj">3&nbsp;&nbsp;<b>進一步研究 QDUOJ</b></a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#自己寫一個-oj">4&nbsp;&nbsp;<b>自己寫一個 OJ</b></a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#總結">5&nbsp;&nbsp;<b>總結</b></a>
                    
                </div>
            </div>
            
            
            <a class="navbar-item" target="_blank" title="Medium" href="https://hulitw.medium.com/">
                
                <i class="fab fa-medium"></i>
                
            </a>
               
            <a class="navbar-item" target="_blank" title="Facebook" href="https://www.facebook.com/huli.blog">
                
                <i class="fab fa-facebook"></i>
                
            </a>
               
            <a class="navbar-item" target="_blank" title="RSS" href="/atom-ch.xml">
                
                <i class="fas fa-rss"></i>
                
            </a>
               
            
            <a class="navbar-item btn-dark-mode" title="dark-mode" href="#">
                <div>
                    <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" width="15" height="15" viewBox="0 0 256 256" xml:space="preserve">
                    <defs>
                    </defs>
                    <g style="stroke: none; stroke-width: 0; stroke-dasharray: none; stroke-linecap: butt; stroke-linejoin: miter; stroke-miterlimit: 10; fill: none; fill-rule: nonzero; opacity: 1;" transform="translate(1.4065934065934016 1.4065934065934016) scale(2.81 2.81)" >
                        <path d="M 87.823 60.7 c -0.463 -0.423 -1.142 -0.506 -1.695 -0.214 c -15.834 8.398 -35.266 2.812 -44.232 -12.718 c -8.966 -15.53 -4.09 -35.149 11.101 -44.665 c 0.531 -0.332 0.796 -0.963 0.661 -1.574 c -0.134 -0.612 -0.638 -1.074 -1.259 -1.153 c -9.843 -1.265 -19.59 0.692 -28.193 5.66 C 13.8 12.041 6.356 21.743 3.246 33.35 S 1.732 57.08 7.741 67.487 c 6.008 10.407 15.709 17.851 27.316 20.961 C 38.933 89.486 42.866 90 46.774 90 c 7.795 0 15.489 -2.044 22.42 -6.046 c 8.601 -4.966 15.171 -12.43 18.997 -21.586 C 88.433 61.79 88.285 61.123 87.823 60.7 z" style="stroke: none; stroke-width: 1; stroke-dasharray: none; stroke-linecap: butt; stroke-linejoin: miter; stroke-miterlimit: 10; fill: #ffa716; fill-rule: nonzero; opacity: 1;" transform=" matrix(1 0 0 1 0 0) " stroke-linecap="round" />
                    </g>
                    </svg>
                </div>
            </a>
            
                <a class="navbar-item" href="/2020/03/23/en/build-your-own-online-judge-system/">English</a>
            
            

        </div>
    </div>
</nav>

    <section class="section">
    <div class="container">
      
      <div data-nosnippet class="self-notice">
        最近開了一個讀者回饋表單，無論是對文章的感想或是對部落格的感想，有什麼想回饋的都可以填表單跟我說：<a href="https://forms.gle/XuWyRC5qtSd2ANta8" target="_blank">表單連結</a>
      </div>
      
    <article class="article content gallery" itemscope itemprop="blogPost">
    <h1 class="article-title is-size-3 is-size-4-mobile" itemprop="name">
        
            自己架一個 Online Judge 系統
        
    </h1>
    <div class="article-meta columns is-variable is-1 is-multiline is-mobile is-size-7-mobile">
        <span class="column is-narrow">
            <time datetime="2020-03-23T14:58:31.000Z" itemprop="datePublished">2020年3月23日</time>
        </span>
        
        <span class="column is-narrow article-category">
            <i class="far fa-folder"></i>
            <a class="article-category-link" href="/categories/Others/">Others</a>
        </span>
        
        
        
    </div>
    
    <div class="article-entry is-size-6-mobile" itemprop="articleBody">
    
        <h2><span id="前言">前言</span></h2><p>先稍微介紹一下什麼是 Online Judge（底下簡稱 OJ）系統，簡單來說就是像 leetcode 那樣啦，可以送出程式碼解題，然後讓系統去批改，並且得到最後的結果。底下是 leetcode 的截圖：</p>
<p><img src="https://static.coderbridge.com/img/aszx87410/47ea051cb4244849908286177e42a38f.png" alt="leetcode 介面"></p>
<p>在 leetcode 流行以前，最知名的 OJ 大概就是 <a target="_blank" rel="noopener" href="https://onlinejudge.org/">UVa Online Judge</a>，俗稱 ACM，而台灣的話應該就是 <a target="_blank" rel="noopener" href="https://zerojudge.tw/">ZeroJudge</a> 比較有名。</p>
<p>如果剛好有需求，想要自己架一個 OJ 的話，該怎麼辦呢？</p>
<span id="more"></span>

<h2><span id="開源-oj-系統">開源 OJ 系統</span></h2><p>在網路上搜尋一下，可以找到幾個開源的 OJ 系統，其中星星數比較多看起來也比較穩定的是底下三個：</p>
<ol>
<li><a target="_blank" rel="noopener" href="https://github.com/DMOJ/online-judge">DMOJ</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/ZsgsDesign/NOJ">NOJ</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/QingdaoU/OnlineJudge">QDUOJ</a></li>
</ol>
<h3><span id="dmoj">DMOJ</span></h3><p><img src="https://static.coderbridge.com/img/aszx87410/0664ed7eeb6b478db132935202dee433.png"></p>
<p>這一套功能看起來最豐富最完整，而且支援的語言最多，可以到 60 幾種！而且還支援 Google, Facebook, Github 這些第三方登入。後端是 Python 寫的，而且一直持續有在維護，<a target="_blank" rel="noopener" href="https://docs.dmoj.ca/#/site/installation">文件</a>也滿完整的。</p>
<p>唯一的缺點大概就是介面比較陽春一點，沒那麼討喜。</p>
<h3><span id="noj">NOJ</span></h3><p><img src="https://static.coderbridge.com/img/aszx87410/950d37d94365471ab8cf0b1f5f820d31.png"></p>
<p>中國南京郵電大學開源出來的系統，是用 Laravel 寫成的。介面使用 Material UI，看起來比較現代，但是文件比較不完整。</p>
<h3><span id="qduoj">QDUOJ</span></h3><p>中國青島大學開源出來的，後端是 Python + Django，前端是 Vue，採用 docker 部署簡單快速，支援的程式語言有：C, C++, Java 跟 Python。介面的部分則是使用 Ant Design。</p>
<p><img src="https://static.coderbridge.com/img/aszx87410/8d236caa632b42c6bde5c33c06f2ef3f.png"></p>
<p>想要架哪一套就是根據自己需求而定，如果 GitHub 上提供的文件完整的話，照著做就行了。若是不完整也可以透過 Issue 提問，英文不好的話也不需要太過擔心，這三個 repo 用中文應該也都可以通。</p>
<p>而我最後選擇的是最後一套，青島大學開源出來的 OJ。會選這一套是因為介面我滿喜歡的，然後是這三套裡面部署最容易的一套。</p>
<p>部署流程在這邊：<a target="_blank" rel="noopener" href="https://github.com/QingdaoU/OnlineJudgeDeploy/tree/2.0">https://github.com/QingdaoU/OnlineJudgeDeploy/tree/2.0</a> ，因為是採用 docker 部署，所以真的容易，基本上就是把 docker-compose.yml 拉下來然後跑個指令就搞定了。</p>
<p>我們可以來看一下 docker-compose.yml 的內容：</p>
<pre class="line-numbers language-none"><code class="language-none">version: &quot;3&quot;
services:

  oj-redis:
    image: redis:4.0-alpine
    container_name: oj-redis
    restart: always
    volumes:
      - .&#x2F;data&#x2F;redis:&#x2F;data
  
  oj-postgres:
    image: postgres:10-alpine
    container_name: oj-postgres
    restart: always
    volumes:
      - .&#x2F;data&#x2F;postgres:&#x2F;var&#x2F;lib&#x2F;postgresql&#x2F;data
    environment:
      - POSTGRES_DB&#x3D;onlinejudge
      - POSTGRES_USER&#x3D;onlinejudge
      - POSTGRES_PASSWORD&#x3D;onlinejudge

  judge-server:
    image: registry.cn-hangzhou.aliyuncs.com&#x2F;onlinejudge&#x2F;judge_server
    container_name: judge-server
    restart: always
    read_only: true
    cap_drop:
      - SETPCAP
      - MKNOD
      - NET_BIND_SERVICE
      - SYS_CHROOT
      - SETFCAP
      - FSETID
    tmpfs:
      - &#x2F;tmp
    volumes:
      - .&#x2F;data&#x2F;backend&#x2F;test_case:&#x2F;test_case:ro
      - .&#x2F;data&#x2F;judge_server&#x2F;log:&#x2F;log
      - .&#x2F;data&#x2F;judge_server&#x2F;run:&#x2F;judger
    environment:
      - SERVICE_URL&#x3D;http:&#x2F;&#x2F;judge-server:8080
      - BACKEND_URL&#x3D;http:&#x2F;&#x2F;oj-backend:8000&#x2F;api&#x2F;judge_server_heartbeat&#x2F;
      - TOKEN&#x3D;CHANGE_THIS
      # - judger_debug&#x3D;1
  
  oj-backend:
    image: registry.cn-hangzhou.aliyuncs.com&#x2F;onlinejudge&#x2F;oj_backend
    container_name: oj-backend
    restart: always
    depends_on:
      - oj-redis
      - oj-postgres
      - judge-server
    volumes:
      - .&#x2F;data&#x2F;backend:&#x2F;data
    environment:
      - POSTGRES_DB&#x3D;onlinejudge
      - POSTGRES_USER&#x3D;onlinejudge
      - POSTGRES_PASSWORD&#x3D;onlinejudge
      - JUDGE_SERVER_TOKEN&#x3D;CHANGE_THIS
      # - FORCE_HTTPS&#x3D;1
      # - STATIC_CDN_HOST&#x3D;cdn.oj.com
    ports:
      - &quot;0.0.0.0:80:8000&quot;
      - &quot;0.0.0.0:443:1443&quot;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>可以看到背後分成 4 個 services：Redis、Postgres、judge-server 跟 oj-backend。</p>
<p>不過我當時的需求還有一個，那就是要支援 JavaScript。為了達成這個目標，只有部署是不夠的，還要來研究一下它到底是怎麼跑的。</p>
<h2><span id="進一步研究-qduoj">進一步研究 QDUOJ</span></h2><p>首先我們來看一下這個系統的架構，在 GitHub 的文件上有寫底下一共分成幾個模組：</p>
<ol>
<li>Backend(Django): <a target="_blank" rel="noopener" href="https://github.com/QingdaoU/OnlineJudge">https://github.com/QingdaoU/OnlineJudge</a></li>
<li>Frontend(Vue): <a target="_blank" rel="noopener" href="https://github.com/QingdaoU/OnlineJudgeFE">https://github.com/QingdaoU/OnlineJudgeFE</a></li>
<li>Judger Sandbox(Seccomp): <a target="_blank" rel="noopener" href="https://github.com/QingdaoU/Judger">https://github.com/QingdaoU/Judger</a></li>
<li>JudgeServer(A wrapper for Judger): <a target="_blank" rel="noopener" href="https://github.com/QingdaoU/JudgeServer">https://github.com/QingdaoU/JudgeServer</a></li>
</ol>
<p>而我們最關心的問題（如何新增語言），已經有人在 Issue 裡問過了：<a target="_blank" rel="noopener" href="https://github.com/QingdaoU/OnlineJudge/issues/149">How to add more language support, such as Ruby</a></p>
<p>裡面提到只要修改這個檔案即可：<a target="_blank" rel="noopener" href="https://github.com/QingdaoU/OnlineJudge/blob/master/judge/languages.py">https://github.com/QingdaoU/OnlineJudge/blob/master/judge/languages.py</a></p>
<p>這檔案就是一些設定，而這邊你也可以大概猜出 Judge Server 會做什麼事情。在這裡，每個語言的設定都會有 compile_command 跟 command，前者是來拿編譯的指令，後者是拿來跑程式的指令。由於這個 OJ 的輸出入都是透過 stdin&#x2F;stdout，所以當你想要新增一種新的程式語言的時候，只要跟系統說該怎麼去執行就好。</p>
<p>相反地，有些 OJ 是採用 function 的方式來填空，例如說開頭提到的 leetcode，這時候若是要新增一個語言就會比較麻煩一些，因為你要額外再提供 function 的模板。</p>
<p>照理來說我們只要再如法泡製，加上這樣的設定就行了：</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python">js_lang_config <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
   <span class="token string">"run"</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span>
       <span class="token string">"exe_name"</span><span class="token punctuation">:</span> <span class="token string">"solution.js"</span><span class="token punctuation">,</span>
       <span class="token string">"command"</span><span class="token punctuation">:</span> <span class="token string">"/usr/bin/nodejs &#123;exe_path&#125;"</span><span class="token punctuation">,</span>
       <span class="token string">"seccomp_rule"</span><span class="token punctuation">:</span> <span class="token string">"general"</span><span class="token punctuation">,</span>
   <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>但若是這樣去跑，會發現有問題，搜了一下發現已經有人反映過：<a target="_blank" rel="noopener" href="https://github.com/QingdaoU/JudgeServer/issues/16">problem with addding js to language configs</a>，解法是把 seccomp_rule 設成 None。</p>
<p>什麼是 seccomp 呢？這就跟 OJ 的原理有關了！大家可以先仔細想想 OJ 中最重要的一個問題：</p>
<blockquote>
<p>要如何安全地執行使用者提交的程式碼？</p>
</blockquote>
<p>若是不知道這問題是在問什麼，可以想像以下情形：</p>
<ol>
<li>有人寫了一行重開機的程式碼怎麼辦？</li>
<li>有人寫了一個無窮迴圈怎麼辦？</li>
<li>有人寫了一個會把主機帳號密碼傳送到外部的程式怎麼辦？</li>
</ol>
<p>由此可以看出，執行程式碼可沒有那麼簡單，而這塊也是 OJ 最核心的一部分。</p>
<p>QDUOJ 的 Judger 原始碼在這邊：<a target="_blank" rel="noopener" href="https://github.com/QingdaoU/Judger/tree/newnew/src">https://github.com/QingdaoU/Judger/tree/newnew/src</a></p>
<p>是用 C 寫的，會 fork 一個新的 process，設定一些規則之後用 <a target="_blank" rel="noopener" href="https://github.com/QingdaoU/Judger/blob/newnew/src/child.c#L163">execve</a> 來執行指令。在<a target="_blank" rel="noopener" href="https://github.com/QingdaoU/Judger/blob/b6414e7a6715eb013b1ffeb7cfb04626a3ff5b4e/src/rules/general.c">程式碼裡面</a>也可以看出是使用 <a target="_blank" rel="noopener" href="https://blog.betamao.me/2019/01/23/Linux%E6%B2%99%E7%AE%B1%E4%B9%8Bseccomp/">seccomp</a> 這個東西來防止我們上面所提到的內容。</p>
<p>總之呢，QDUOJ 分層做得很不錯，執行流程大概是這樣的：</p>
<ol>
<li>進入 Vue 做的前端頁面</li>
<li>送出程式碼，call 後端 API（Python）</li>
<li>後端 API 再呼叫 Judge Server API（Go）</li>
<li>Judge Server API 呼叫 Judger 執行指令（C，execve + seccomp 執行）</li>
</ol>
<p>所以每一個專案負責自己的事項，各司其職。</p>
<p>再講回來前面提到要加上 JavaScript 這一塊，儘管把 seccomp_rule 設成 None 以後，執行 JavaScript 依然會出現錯誤。我研究了一兩天，發現問題是出在題目的記憶體限制太小，我猜測是 Node.js 要執行時本來就會吃比較多記憶體，只要把記憶體改大（例如說 1024MB）就搞定了。</p>
<p>不過還沒結束，還有最後一個問題，那就是 ubuntu 16.04 上的 Node.js 版本滿舊的，要換成新的才能使用 ES6 那些語法，解法是去改 JudgeServer 的 <a target="_blank" rel="noopener" href="https://github.com/Lidemy/JudgeServer/commit/9a98532f0f3504da20d13bd0aec4f4279a2a1fd2">Dockerfile</a>，新增一個安裝 Node.js 新版的指令就好。</p>
<p>都改完以後，就可以來部署自己的版本了！只要先把 docker image build 好，然後更改我們最前面操作的 docker-compose 檔案就可以了。</p>
<p>雖然說上面講的雲淡風輕，但那時候我在找 Node.js 到底為什麼會一直 Runtime error 的時候找到快崩潰，因為錯誤訊息滿不明確的，我一直以為是指令有錯，是後來我才靈機一動想說：「咦，該不會是其他問題吧」，才發現是記憶體問題。</p>
<p>總而言之呢，如果你沒有想要改東西，只是單純想要部署的話，在這邊誠心推薦 QDUOJ，部署真的簡單方便，介面也好看。</p>
<h2><span id="自己寫一個-oj">自己寫一個 OJ</span></h2><p>以前我也曾經嘗試過寫一個 OJ，寫是寫出來了，但是是非常陽春的版本：<a target="_blank" rel="noopener" href="https://lidemy-oj.netlify.com/problems">https://lidemy-oj.netlify.com/problems</a></p>
<p><img src="https://static.coderbridge.com/img/aszx87410/016853899af54a40b11801d3e1d5f8d7.png"></p>
<p>那時候還沒想到用 linux 上的指令來跑，而是因為恰巧發現有 <a target="_blank" rel="noopener" href="https://github.com/patriksimek/vm2">VM2</a> 這個 library，覺得派得上用場，才有了寫這個簡易 OJ 的念頭。</p>
<p>這個簡單的 OJ 只支援 JavaScript，而且是走 leetcode 那種寫 function 的方式而不是標準輸出入，花了一點時間就把 Judger 的雛形寫了出來：</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> <span class="token punctuation">&#123;</span><span class="token constant">VM</span><span class="token punctuation">&#125;</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'vm2'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> lodash <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'lodash'</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> <span class="token constant">RESULT_CODE</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
  <span class="token constant">AC</span><span class="token operator">:</span> <span class="token string">'AC'</span><span class="token punctuation">,</span>
  <span class="token constant">WA</span><span class="token operator">:</span> <span class="token string">'WA'</span><span class="token punctuation">,</span>
  <span class="token constant">CE</span><span class="token operator">:</span> <span class="token string">'CE'</span><span class="token punctuation">,</span>
  <span class="token constant">RE</span><span class="token operator">:</span> <span class="token string">'RE'</span><span class="token punctuation">,</span>
  <span class="token constant">TLE</span><span class="token operator">:</span> <span class="token string">'TLE'</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">class</span> <span class="token class-name">Judge</span> <span class="token punctuation">&#123;</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">schema<span class="token punctuation">,</span> functionCode<span class="token punctuation">,</span> timeout <span class="token operator">=</span> <span class="token number">3000</span></span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>schema <span class="token operator">=</span> schema
    <span class="token keyword">this</span><span class="token punctuation">.</span>functionCode <span class="token operator">=</span> functionCode
    <span class="token keyword">this</span><span class="token punctuation">.</span>vm <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">VM</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
        timeout<span class="token punctuation">,</span>
        <span class="token literal-property property">sandbox</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
          <span class="token literal-property property">__equal</span><span class="token operator">:</span> lodash<span class="token punctuation">.</span>isEqual
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token function">t</span><span class="token punctuation">(</span><span class="token parameter">any</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>any<span class="token punctuation">)</span>
  <span class="token punctuation">&#125;</span>

  <span class="token function">addWrapper</span><span class="token punctuation">(</span><span class="token parameter">schema<span class="token punctuation">,</span> code<span class="token punctuation">,</span> testCase</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
      </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>code<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">
      (() => __equal(</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>schema<span class="token punctuation">.</span>funcName<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">.apply(null, </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">t</span><span class="token punctuation">(</span>testCase<span class="token punctuation">.</span>input<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">), </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">t</span><span class="token punctuation">(</span>testCase<span class="token punctuation">.</span>output<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">))()
    </span><span class="token template-punctuation string">`</span></span>
  <span class="token punctuation">&#125;</span>

  <span class="token function">runTest</span><span class="token punctuation">(</span><span class="token parameter">testCase</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>vm<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>functionCode<span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">return</span> <span class="token constant">RESULT_CODE</span><span class="token punctuation">.</span><span class="token constant">RE</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">const</span> wrapperedCode <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">addWrapper</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>schema<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>functionCode<span class="token punctuation">,</span> testCase<span class="token punctuation">)</span>
    <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>vm<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span>wrapperedCode<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token constant">RESULT_CODE</span><span class="token punctuation">.</span><span class="token constant">AC</span><span class="token operator">:</span> <span class="token constant">RESULT_CODE</span><span class="token punctuation">.</span><span class="token constant">WA</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">return</span> e<span class="token punctuation">.</span>message <span class="token operator">===</span> <span class="token string">'Script execution timed out.'</span> <span class="token operator">?</span> <span class="token constant">RESULT_CODE</span><span class="token punctuation">.</span><span class="token constant">TLE</span> <span class="token operator">:</span> <span class="token constant">RESULT_CODE</span><span class="token punctuation">.</span><span class="token constant">WA</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'err'</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">const</span> testCases <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>schema<span class="token punctuation">.</span>testCases
    <span class="token keyword">const</span> testResult <span class="token operator">=</span> testCases<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">testCase</span> <span class="token operator">=></span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">runTest</span><span class="token punctuation">(</span>testCase<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">const</span> correctCount <span class="token operator">=</span> testResult<span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">sum<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=></span> sum <span class="token operator">+</span> <span class="token punctuation">(</span>res <span class="token operator">===</span> <span class="token string">'AC'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token punctuation">&#123;</span>
      <span class="token literal-property property">score</span><span class="token operator">:</span> Math<span class="token punctuation">.</span><span class="token function">ceil</span><span class="token punctuation">(</span>correctCount <span class="token operator">*</span> <span class="token punctuation">(</span> <span class="token number">100</span> <span class="token operator">/</span> testResult<span class="token punctuation">.</span>length <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token literal-property property">result</span><span class="token operator">:</span> testResult
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">const</span> test1 <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
  <span class="token literal-property property">input</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token literal-property property">output</span><span class="token operator">:</span> <span class="token number">3</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">const</span> test2 <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
  <span class="token literal-property property">input</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token literal-property property">output</span><span class="token operator">:</span> <span class="token number">6</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">const</span> problemSchema <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
  <span class="token literal-property property">funcName</span><span class="token operator">:</span> <span class="token string">'add'</span><span class="token punctuation">,</span>
  <span class="token literal-property property">testCases</span><span class="token operator">:</span> <span class="token punctuation">[</span>test1<span class="token punctuation">,</span> test2<span class="token punctuation">]</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">const</span> input <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">function add(a, b)&#123;
    return 3
  &#125;</span><span class="token template-punctuation string">`</span></span>

<span class="token keyword">const</span> judge <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Judge</span><span class="token punctuation">(</span>problemSchema<span class="token punctuation">,</span> input<span class="token punctuation">)</span>
<span class="token keyword">const</span> result <span class="token operator">=</span> judge<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>重點程式碼是 <code>addWrapper</code> 跟 <code>runTest</code>，在 <code>addWrapper</code> 裡面去執行傳進來的 function code，然後把結果跟 output 做比對，就會回傳 true 或是 false，代表匹配成功或者是失敗，就可以知道答案是不是對的。</p>
<p>然後 problemSchema 是題目的格式，要有一個 funcName 跟 testCases，每一個測資底下都有 input 與 output。藉由以上程式碼，就可以實作出一個 JS function-base 的超簡易 Judger。</p>
<p>不過這個 Judger 缺點很多，而且跟上面提到的執行指令方式根本沒得比。</p>
<p>我後來在研究資料的時候找到一些不錯的開源解法，以後有人想要自己寫的話可以參考考。</p>
<p>第一個是 IOI 開源出來的 sandbox：<a target="_blank" rel="noopener" href="https://github.com/ioi/isolate">isolate</a>，可以安全地執行指令。</p>
<p>第二個更神奇，直接給你 Judge 的 API，而且是免費的：<a target="_blank" rel="noopener" href="https://github.com/judge0/api">Judge0 API</a>。只要按照他的格式把輸入傳進去，就會跟你說判題結果，所以連 Judge Server 都可以不用自己做。</p>
<h2><span id="總結">總結</span></h2><p>之前想要來架個 OJ，所以找了滿多資料，而碰到最大的問題是：「我想要一個支援 JavaScript 的 OJ」，因為滿多都不支援的。後來無奈之下只好自己寫了一個，就是上面提到的用 JS 寫出來的小玩具。雖然說還堪用，但其實許多功能都不完整，就真的只支援最簡單的答題而已。</p>
<p>一直到今年一月，想要來弄個真正的 OJ，原本也一度考慮要不要自己寫，後來想說太麻煩了，不如找現成的來改，把 JS 的支援加上去。雖然一樣有碰到一些問題，但很幸運地最後還是成功了。</p>
<p>最後的成果在這邊：<a target="_blank" rel="noopener" href="https://oj.lidemy.com/">https://oj.lidemy.com/</a></p>
<p>這個 OJ 是為了搭配我最新出的免費線上課程：<a target="_blank" rel="noopener" href="https://lidemy.com/p/alg101-leetcode">[ALG101] 先別急著寫 leetcode</a>，是一堂給初學者的課，希望能藉由一系列簡單的題目把基礎打好，培養程式思維能力，有興趣的朋友們可以來看看。</p>

    
    </div>
    
    <div class="columns is-variable is-1 is-multiline is-mobile">
    
        <span class="column is-narrow"><a class="tag is-light article-tag" href="/tags/Others/">#Others</a></span>
    
    </div>
    
    
    <div class="columns is-mobile is-multiline article-nav">
        <span class="column is-12-mobile is-half-desktop  article-nav-prev">
            
            <a href="/2020/03/24/console-log-bug/">你需要注意的 console.log 問題</a>
            
        </span>
        <span class="column is-12-mobile is-half-desktop  article-nav-next">
            
            <a href="/2020/02/20/let-vs-var-bytecode/">從 V8 bytecode 探討 let 與 var 的效能問題</a>
            
        </span>
    </div>
    
</article>




<div class="comments">
    <h3 class="title is-4">評論</h3>
    <script src="https://utteranc.es/client.js"
        repo="aszx87410/huli-blog"
        issue-term="title"
        theme="github-light"
        crossorigin="anonymous"
        async>
</script>
</div>

    </div>
</section>
    <footer class="footer">
    <div class="container">
        <div class="columns content">
            <div class="column is-narrow has-text-centered">
                &copy; 2025 Huli&nbsp;
                Powered by <a href="http://hexo.io/" target="_blank">Hexo</a> & <a
                        target="_blank" rel="noopener" href="http://github.com/ppoffice/hexo-theme-minos">Minos</a>
            </div>
            <div class="column is-hidden-mobile"></div>

            
            <div class="column is-narrow">
                <div class="columns is-mobile is-multiline is-centered">
                
                    
                <a class="column is-narrow" title="GitHub" target="_blank" rel="noopener" href="https://github.com/ppoffice/hexo-theme-minos">
                    
                    GitHub
                    
                </a>
                
                </div>
            </div>
            
            
<div class="column is-narrow has-text-centered">
    <div class="dropdown is-up is-right is-hoverable" style="margin-top: -0.2em;">
        <div class="dropdown-trigger">
            <button class="button is-small" aria-haspopup="true">
                <span class="icon">
                    <i class="fas fa-globe"></i>
                </span>
                <span>繁體中文</span>
                <span class="icon is-small">
            <i class="fas fa-angle-down" aria-hidden="true"></i>
          </span>
            </button>
        </div>
        <div class="dropdown-menu has-text-left" role="menu" style="top:100%">
            <div class="dropdown-content">
            <!-- NOTE: 永遠回到首頁 -->
            
                <a href="/2020/03/23/en/build-your-own-online-judge-system/" class="dropdown-item">
                    English
                </a>
            
            </div>
        </div>
    </div>
</div>

        </div>
    </div>
</footer>
    <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/3.6.3/jquery.min.js"></script>



    
    
    
    
    
    
<script src="//cdnjs.cloudflare.com/ajax/libs/lightgallery/1.6.8/js/lightgallery-all.min.js"></script>
<script>
    (function ($) {
        $(document).ready(function () {
            if (typeof($.fn.lightGallery) === 'function') {
                $('.article.gallery').lightGallery({ selector: '.gallery-item' });
            }
        });
    })(jQuery);
</script>

    
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.0/clipboard.min.js"></script>
    <style>
        .hljs {
            position: relative;
        }

        .hljs .clipboard-btn {
            float: right;
            color: #9a9a9a;
            background: none;
            border: none;
            cursor: pointer;
        }

        .hljs .clipboard-btn:hover {
          color: #8a8a8a;
        }

        .hljs > .clipboard-btn {
            display: none;
            position: absolute;
            right: 4px;
            top: 4px;
        }

        .hljs:hover > .clipboard-btn {
            display: inline;
        }

        .hljs > figcaption > .clipboard-btn {
            margin-right: 4px;
        }
    </style>
    <script>
      $(document).ready(function () {
        $('figure.hljs').each(function(i, figure) {
          var codeId = 'code-' + i;
          var code = figure.querySelector('.code');
          var copyButton = $('<button>Copy <i class="far fa-clipboard"></i></button>');
          code.id = codeId;
          copyButton.addClass('clipboard-btn');
          copyButton.attr('data-clipboard-target-id', codeId);

          var figcaption = figure.querySelector('figcaption');

          if (figcaption) {
            figcaption.append(copyButton[0]);
          } else {
            figure.prepend(copyButton[0]);
          }
        })

        var clipboard = new ClipboardJS('.clipboard-btn', {
          target: function(trigger) {
            return document.getElementById(trigger.getAttribute('data-clipboard-target-id'));
          }
        });
        clipboard.on('success', function(e) {
          e.clearSelection();
        })
      })
    </script>

    
    

    



<script src="/js/script.js?v=3.js"></script>


    
</body>
</html>