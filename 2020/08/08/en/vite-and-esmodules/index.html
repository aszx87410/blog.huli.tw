<!DOCTYPE html>
<html class="has-navbar-fixed-top" lang="en">
<head>
    <meta charset="utf-8">
<title>Why is Vite so fast? Starting with ES modules - Huli&#39;s blog</title>
<meta name="viewport" content="width=device-width, initial-scale=1">


            
<link href="https://blog.huli.tw/2020/08/08/vite-and-esmodules/" rel="alternate" hreflang="zh-TW" />
            
    




    
<link rel="canonical" href="https://blog.huli.tw/2020/08/08/en/vite-and-esmodules/">
    





    <meta name="description" content="IntroductionHave you ever heard of vite? With a name starting with “v”, you might guess that it’s related to Vue. Yes, it’s another tool developed by the creator of Vue, Evan You. Originally intended">
<meta property="og:type" content="article">
<meta property="og:title" content="Why is Vite so fast? Starting with ES modules">
<meta property="og:url" content="https://blog.huli.tw/2020/08/08/en/vite-and-esmodules/index.html">
<meta property="og:site_name" content="Huli&#39;s blog">
<meta property="og:description" content="IntroductionHave you ever heard of vite? With a name starting with “v”, you might guess that it’s related to Vue. Yes, it’s another tool developed by the creator of Vue, Evan You. Originally intended">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://blog.huli.tw/img/vite-and-esmodules/cover-en.png">
<meta property="article:published_time" content="2020-08-07T15:21:12.000Z">
<meta property="article:modified_time" content="2023-06-20T05:46:56.932Z">
<meta property="article:author" content="Huli">
<meta property="article:tag" content="Front-end">
<meta property="article:tag" content="JavaScript">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://blog.huli.tw/img/vite-and-esmodules/cover-en.png">



<link rel="alternative" href="/atom.xml" title="Why is Vite so fast? Starting with ES modules" type="application/atom+xml">



<link rel="icon" href="/img/lidemy_logo.png">


<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Ovo|Source+Code+Pro">


<link rel="stylesheet" href="/css/bulma.css?v=2.css">



<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/lightgallery/1.6.8/css/lightgallery.min.css">


<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/line-numbers/prism-line-numbers.min.css" />


<link rel="stylesheet" href="/css/style.css?v=4.css">





    
    
    
    
    
    
    
    
    
    
<script async src="https://www.googletagmanager.com/gtag/js?id=G-1393J2EVCZ"></script>
<script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-1393J2EVCZ');
</script>


    


<meta name="generator" content="Hexo 6.3.0"></head>
<body>
    <script>
        if (localStorage.getItem('dark-mode')) {
            if (localStorage.getItem('dark-mode') === 'true') {
                document.body.classList.add('dark-mode')
            }
        } else {
            if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                document.body.classList.add('dark-mode')
            }
        }
    </script>
    
<nav class="navbar is-transparent is-fixed-top navbar-main" role="navigation" aria-label="main navigation">
    <div class="container">
        <div class="navbar-brand">
            <a class="navbar-item navbar-logo" href="/en">
                
                    
                    Huli&#39;s blog
                    
                
            </a>
            <div class="navbar-burger">
                <span></span>
                <span></span>
                <span></span>
            </div>
        </div>
        
        <div class="navbar-menu navbar-start">
            
            <a class="navbar-item "
               href="/en/archives">Archive</a>
            
            <a class="navbar-item "
               href="/en/categories">Categories</a>
            
            <a class="navbar-item "
               href="/en/about">About</a>
            
        </div>
        
        <div class="navbar-menu navbar-end">
            
            
            <div class="navbar-item is-hoverable has-dropdown is-hidden-mobile is-hidden-tablet-only toc">
                <a class="navbar-item" title="Table of Contents">
                    Table of Contents
                </a>
                <div class="navbar-dropdown">
                    
                    
                    
                    
                    <a class="navbar-item" href="#introduction">1&nbsp;&nbsp;<b>Introduction</b></a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#exploring-vite">2&nbsp;&nbsp;<b>Exploring Vite</b></a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#native-es-modules">3&nbsp;&nbsp;<b>Native ES Modules</b></a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#exploring-vite-again">4&nbsp;&nbsp;<b>Exploring Vite again</b></a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#how-about-production">5&nbsp;&nbsp;<b>How about production?</b></a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#conclusion">6&nbsp;&nbsp;<b>Conclusion</b></a>
                    
                </div>
            </div>
            
            
            <a class="navbar-item" target="_blank" title="Twitter" href="https://twitter.com/aszx87410">
                
                <i class="fab fa-twitter"></i>
                
            </a>
               
            <a class="navbar-item" target="_blank" title="RSS" href="/atom-en.xml">
                
                <i class="fas fa-rss"></i>
                
            </a>
               
            
            <a class="navbar-item btn-dark-mode" title="dark-mode" href="#">
                <div>
                    <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" width="15" height="15" viewBox="0 0 256 256" xml:space="preserve">
                    <defs>
                    </defs>
                    <g style="stroke: none; stroke-width: 0; stroke-dasharray: none; stroke-linecap: butt; stroke-linejoin: miter; stroke-miterlimit: 10; fill: none; fill-rule: nonzero; opacity: 1;" transform="translate(1.4065934065934016 1.4065934065934016) scale(2.81 2.81)" >
                        <path d="M 87.823 60.7 c -0.463 -0.423 -1.142 -0.506 -1.695 -0.214 c -15.834 8.398 -35.266 2.812 -44.232 -12.718 c -8.966 -15.53 -4.09 -35.149 11.101 -44.665 c 0.531 -0.332 0.796 -0.963 0.661 -1.574 c -0.134 -0.612 -0.638 -1.074 -1.259 -1.153 c -9.843 -1.265 -19.59 0.692 -28.193 5.66 C 13.8 12.041 6.356 21.743 3.246 33.35 S 1.732 57.08 7.741 67.487 c 6.008 10.407 15.709 17.851 27.316 20.961 C 38.933 89.486 42.866 90 46.774 90 c 7.795 0 15.489 -2.044 22.42 -6.046 c 8.601 -4.966 15.171 -12.43 18.997 -21.586 C 88.433 61.79 88.285 61.123 87.823 60.7 z" style="stroke: none; stroke-width: 1; stroke-dasharray: none; stroke-linecap: butt; stroke-linejoin: miter; stroke-miterlimit: 10; fill: #ffa716; fill-rule: nonzero; opacity: 1;" transform=" matrix(1 0 0 1 0 0) " stroke-linecap="round" />
                    </g>
                    </svg>
                </div>
            </a>
            
               <a class="navbar-item" href="/2020/08/08/vite-and-esmodules/">中文</a>
            
            

        </div>
    </div>
</nav>

    <section class="section">
    <div class="container">
      
      <div data-nosnippet class="self-notice">
        If you have any thoughts on my blog or articles and you want to let me know, you can either post a comment below(public) or tell me via this <a href="https://forms.gle/SjJZ4cnNs6NnjXQG8" target="_blank">feedback form</a>
      </div>
      
    <article class="article content gallery" itemscope itemprop="blogPost">
    <h1 class="article-title is-size-3 is-size-4-mobile" itemprop="name">
        
            Why is Vite so fast? Starting with ES modules
        
    </h1>
    <div class="article-meta columns is-variable is-1 is-multiline is-mobile is-size-7-mobile">
        <span class="column is-narrow">
            <time datetime="2020-08-07T15:21:12.000Z" itemprop="datePublished">8 August 2020</time>
        </span>
        
        <span class="column is-narrow article-category">
            <i class="far fa-folder"></i>
            <a class="article-category-link" href="/en/categories/Front-end/">Front-end</a>
        </span>
        
        
        
        <spen data-nosnippet class="column is-narrow">(Translated by ChatGPT)</span>
        
    </div>
    
    <div class="article-entry is-size-6-mobile" itemprop="articleBody">
    
        <h2><span id="introduction">Introduction</span></h2><p>Have you ever heard of <a target="_blank" rel="noopener" href="https://github.com/vitejs/vite">vite</a>? With a name starting with “v”, you might guess that it’s related to Vue. Yes, it’s another tool developed by the creator of Vue, Evan You. Originally intended for use with <a target="_blank" rel="noopener" href="https://vuepress.vuejs.org/">VuePress</a>, it has proven to be much more versatile.</p>
<p>On the GitHub page for Vite, there are only two sentences:</p>
<blockquote>
<p>Native-ESM powered web dev build tool. It’s fast.</p>
</blockquote>
<p>If you’ve tried it, you’ll know that it really is fast. Vite is a combination of a build tool and a dev server. In this article, we’ll briefly introduce how to use Vite, then talk about ES modules, and finally explore the magic of Vite.</p>
<span id="more"></span>

<h2><span id="exploring-vite">Exploring Vite</span></h2><p>Let’s start by discussing what Vite does. We can see from its positioning that it is a build tool + dev server. Let’s focus on the latter. The dev server is like the webpack dev server + hot module reload that we use with webpack. It provides a local development environment that automatically updates the entire app when we save a file. It’s an indispensable tool for front-end development.</p>
<p>Vite’s concept is similar. It provides a “faster dev server” for us to use during development.</p>
<p>Let’s go through the process.</p>
<p>Although Vite integrates best with Vue, it is not exclusively a Vue tool. In fact, you can use it to develop anything, and Vite also provides a React template.</p>
<p>Let’s use React as an example:</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">npm init vite<span class="token operator">-</span>app react<span class="token operator">-</span>demo <span class="token operator">--</span>template react
cd react<span class="token operator">-</span>demo
npm install
npm run dev<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>With just these four lines of code, you can experience the power of Vite. The first line uses Vite’s tools to generate a boilerplate, and then you can start developing by entering the folder.</p>
<p>After a successful installation, the terminal will tell you that the dev server is running. Then open: <a target="_blank" rel="noopener" href="http://localhost:3000/">http://localhost:3000</a>, and you’ll see the familiar spinning React logo.</p>
<p><img src="/img/vite/vite01.png"></p>
<p>Next, let’s try opening <code>src/App.jsx</code> and making some changes. You’ll see that the React app updates very quickly. Vite is much faster than create-react-app or webpack dev server, both in terms of startup speed and update speed. Some people have compared the two on <a target="_blank" rel="noopener" href="https://twitter.com/swyx/status/1290410811802804226">Twitter</a>, and Vite is clearly the winner.</p>
<p>Why is Vite so fast? It’s because of Native ES Modules. So next, let’s take a look at what Native ES Modules are.</p>
<h2><span id="native-es-modules">Native ES Modules</span></h2><p>Before we continue, I suggest that you first understand the history of module development in JavaScript. You can refer to my previous article: <a href="https://blog.huli.tw/2020/01/21/webpack-newbie-tutorial/">A Beginner’s Guide to Webpack: An Introduction to Modularity and Snowpack</a>.</p>
<p>In the article, I mentioned that there was no native module mechanism in browsers in the early days, so various standards were created, such as CommonJS, AMD, or UMD. However, this changed with ES6, because the ES6 specification finally included modules! We call this ES Modules, or ESM for short.</p>
<p>ESM is a specification that you’ve probably used before, which looks like this:</p>
<pre class="line-numbers language-none"><code class="language-none">&#x2F;&#x2F; a.js
export const PI &#x3D; 3.14

&#x2F;&#x2F; b.js
import &#123; PI &#125; from &#39;.&#x2F;a&#39;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>If you see <code>export</code> and <code>import</code>, it’s probably ESM syntax. In addition to the specification, what’s even more exciting is that all mainstream browsers now natively support ESM!</p>
<p>I’ve created a simple demo website here: <a target="_blank" rel="noopener" href="https://aszx87410.github.io/esm-demo/vanilla/index.html">https://aszx87410.github.io/esm-demo/vanilla/index.html</a></p>
<p>After opening it, you can open the devtool and switch to the network tab. You’ll see that both index.js and utils.js use ESM syntax:</p>
<p><img src="/img/vite/vite02.png"></p>
<p>Vite uses the native ESM loading mechanism, which is Native ESM, allowing the browser to handle these import and export things for you.</p>
<p>Wait, I just emphasized the word “native”. Does that mean there are other things that are not native? Yes, that’s right. The webpack or similar tools you usually use, don’t forget that its name is “bundler”, which is to bundle your JS files and dependencies together. Although you use import and export correctly when writing code, it may have been converted to CommonJS or other forms by babel or webpack when output, and there is also an outer layer to handle the syntax of <code>require</code>.</p>
<p>And this is also the reason why webpack and other bundling tools are slow. They need to statically analyze all files and package dependencies of the app, and then package things together based on this information. When your file becomes larger and larger, the time spent naturally increases because webpack needs to figure out how to package it.</p>
<p>If we can avoid bundling and not package everything together, will it be much faster?</p>
<p>Yes, this is why Vite is so fast.</p>
<h2><span id="exploring-vite-again">Exploring Vite again</span></h2><p>In the earlier article, I mentioned snowpack. In fact, the concept of snowpack is quite similar to Vite, both of which use the Native ESM solution. Instead of bundling everything together, it is better to use the browser well and let the browser handle those complex dependencies.</p>
<p>For example, snowpack will put the node_modules you use in a specific place so that you can import them.</p>
<p>Next, let’s take a look at Vite. Open the demo project we just installed, turn on devtool, and switch to network. It is clear at a glance:</p>
<p><img src="/img/vite/vite03.png"></p>
<p>The principle is quite similar to snowpack, both using ESM to load different packages, which is why there are so many requests in the browser.</p>
<p>Click on <code>main.jsx</code> to see the code inside:</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">import</span> React <span class="token keyword">from</span> <span class="token string">"/@modules/@pika/react/source.development.js"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> ReactDOM <span class="token keyword">from</span> <span class="token string">"/@modules/@pika/react-dom/source.development.js"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token string">"/src/index.css?import"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> App2 <span class="token keyword">from</span> <span class="token string">"/src/App.jsx"</span><span class="token punctuation">;</span>
ReactDOM<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token comment">/* @__PURE__ */</span> React<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span>React<span class="token punctuation">.</span>StrictMode<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token comment">/* @__PURE__ */</span> React<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span>App2<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">"root"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>On the server side, Vite will help us transform the program a bit. Here, it will replace <code>import React from &#39;react&#39;</code> in the program and change the path to its own prepared React build. This is because React official currently does not have an ESM build! What everyone is using now seems to be a mixture of UMD and CommonJS. There are plans for the future, but it may take some time. For details, please refer to: <a target="_blank" rel="noopener" href="https://github.com/facebook/react/issues/11503">#11503 Formalize top-level ES exports</a>.</p>
<p>Although the official version does not exist, someone in the community has already done it, so the community version is used here. By the way, I will add one more thing. The original <code>import React from &#39;react&#39;</code> is called “bare module imports”, and “bare” refers to the <code>react</code> behind it, which is not a file path. According to Evan You, this is undefined behavior in the ESM standard, so it needs to be handled specially.</p>
<p>If we change the ESM small example we tried earlier, <code>import &#123; add &#125; from &#39;./utils.js&#39;</code> to <code>import &#123; add &#125; from &#39;utils.js&#39;</code>, this error will appear:</p>
<blockquote>
<p>Uncaught TypeError: Failed to resolve module specifier “utils.js”. Relative references must start with either “&#x2F;“, “.&#x2F;“, or “..&#x2F;“.</p>
</blockquote>
<p>So it must start with <code>/</code>, <code>./</code>, or <code>../</code>.</p>
<p>Next, let’s take a look at <code>App.jsx</code>:</p>
<pre class="line-numbers language-jsx" data-language="jsx"><code class="language-jsx"><span class="token keyword">import</span> <span class="token punctuation">&#123;</span> createHotContext <span class="token punctuation">&#125;</span> <span class="token keyword">from</span> <span class="token string">"/vite/client"</span><span class="token punctuation">;</span> <span class="token keyword">import</span><span class="token punctuation">.</span>meta<span class="token punctuation">.</span>hot <span class="token operator">=</span> <span class="token function">createHotContext</span><span class="token punctuation">(</span><span class="token string">"/src/App.jsx"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token keyword">import</span> RefreshRuntime <span class="token keyword">from</span> <span class="token string">"/@react-refresh"</span><span class="token punctuation">;</span>  <span class="token keyword">let</span> prevRefreshReg<span class="token punctuation">;</span>  <span class="token keyword">let</span> prevRefreshSig<span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>window<span class="token punctuation">.</span>__vite_plugin_react_preamble_installed__<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span>      <span class="token string">"vite-plugin-react can't detect preamble. Something is wrong. See https://github.com/vitejs/vite-plugin-react/pull/11#discussion_r430879201"</span>    <span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">import</span><span class="token punctuation">.</span>meta<span class="token punctuation">.</span>hot<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    prevRefreshReg <span class="token operator">=</span> window<span class="token punctuation">.</span>$RefreshReg$<span class="token punctuation">;</span>    prevRefreshSig <span class="token operator">=</span> window<span class="token punctuation">.</span>$RefreshSig$<span class="token punctuation">;</span>    window<span class="token punctuation">.</span><span class="token function-variable function">$RefreshReg$</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">type<span class="token punctuation">,</span> id</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>      RefreshRuntime<span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span>type<span class="token punctuation">,</span> <span class="token string">"/Users/huli/Documents/lidemy/test/react-demo/src/App.jsx"</span> <span class="token operator">+</span> <span class="token string">" "</span> <span class="token operator">+</span> id<span class="token punctuation">)</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>    window<span class="token punctuation">.</span>$RefreshSig$ <span class="token operator">=</span> RefreshRuntime<span class="token punctuation">.</span>createSignatureFunctionForTransform<span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span><span class="token keyword">var</span> _s <span class="token operator">=</span> <span class="token function">$RefreshSig$</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> React<span class="token punctuation">,</span> <span class="token punctuation">&#123;</span> useState <span class="token punctuation">&#125;</span> <span class="token keyword">from</span> <span class="token string">"/@modules/@pika/react/source.development.js"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> logo2 <span class="token keyword">from</span> <span class="token string">"/src/logo.svg?import"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token string">"/src/App.css?import"</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">App2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token function">_s</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> <span class="token punctuation">[</span>count<span class="token punctuation">,</span> setCount<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token comment">/* @__PURE__ */</span>React<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">"div"</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>
    <span class="token literal-property property">className</span><span class="token operator">:</span> <span class="token string">"App"</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token comment">/* @__PURE__ */</span>React<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">"header"</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>
    <span class="token literal-property property">className</span><span class="token operator">:</span> <span class="token string">"App-header"</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token comment">/* @__PURE__ */</span>React<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">"img"</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>
    <span class="token literal-property property">src</span><span class="token operator">:</span> logo2<span class="token punctuation">,</span>
    <span class="token literal-property property">className</span><span class="token operator">:</span> <span class="token string">"App-logo"</span><span class="token punctuation">,</span>
    <span class="token literal-property property">alt</span><span class="token operator">:</span> <span class="token string">"logo"</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">/* @__PURE__ */</span>React<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">"p"</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token string">"Hello Vite + React!wwaaaa"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">/* @__PURE__ */</span>React<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">"p"</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token comment">/* @__PURE__ */</span>React<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">"button"</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>
    <span class="token function-variable function">onClick</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">setCount</span><span class="token punctuation">(</span><span class="token parameter">count2</span> <span class="token operator">=></span> count2 <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token string">"count is: "</span><span class="token punctuation">,</span> count<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">/* @__PURE__ */</span>React<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">"p"</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token string">"Edit "</span><span class="token punctuation">,</span> <span class="token comment">/* @__PURE__ */</span>React<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">"code"</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token string">"App.jsx"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">" and save to test HMR updates."</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">/* @__PURE__ */</span>React<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">"a"</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>
    <span class="token literal-property property">className</span><span class="token operator">:</span> <span class="token string">"App-link"</span><span class="token punctuation">,</span>
    <span class="token literal-property property">href</span><span class="token operator">:</span> <span class="token string">"https://reactjs.org"</span><span class="token punctuation">,</span>
    <span class="token literal-property property">target</span><span class="token operator">:</span> <span class="token string">"_blank"</span><span class="token punctuation">,</span>
    <span class="token literal-property property">rel</span><span class="token operator">:</span> <span class="token string">"noopener noreferrer"</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token string">"Learn React"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token function">_s</span><span class="token punctuation">(</span>App2<span class="token punctuation">,</span> <span class="token string">"oDgYfYHkD9Wkv4hrAPCkI/ev3YU="</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

_c <span class="token operator">=</span> App2<span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> App2<span class="token punctuation">;</span>

<span class="token keyword">var</span> _c<span class="token punctuation">;</span>

<span class="token function">$RefreshReg$</span><span class="token punctuation">(</span>_c<span class="token punctuation">,</span> <span class="token string">"App2"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">import</span><span class="token punctuation">.</span>meta<span class="token punctuation">.</span>hot<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    window<span class="token punctuation">.</span>$RefreshReg$ <span class="token operator">=</span> prevRefreshReg<span class="token punctuation">;</span>
    window<span class="token punctuation">.</span>$RefreshSig$ <span class="token operator">=</span> prevRefreshSig<span class="token punctuation">;</span>

    <span class="token keyword">import</span><span class="token punctuation">.</span>meta<span class="token punctuation">.</span>hot<span class="token punctuation">.</span><span class="token function">accept</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    RefreshRuntime<span class="token punctuation">.</span><span class="token function">performReactRefresh</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>You can see that the original jsx has been converted to JS on the server, and there is some code related to HMR (Hot Module Reload). If you try to modify the source code and save it, you will find that the URL of the network request has an additional timestamp:</p>
<p><img src="/img/vite/vite04.png"></p>
<p>It can be guessed that this should be related to cache invalidation, to avoid loading the old one when reloading the module, so a timestamp is added to force re-fetching.</p>
<p>Finally, let’s take a look at how CSS is handled:</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">import</span> <span class="token punctuation">&#123;</span> updateStyle <span class="token punctuation">&#125;</span> <span class="token keyword">from</span> <span class="token string">"/vite/client"</span>
<span class="token keyword">const</span> css <span class="token operator">=</span> <span class="token string">".App &#123;\n  text-align: center;\n&#125;\n\n.App-logo &#123;\n  height: 40vmin;\n  pointer-events: none;\n&#125;\n\n@media (prefers-reduced-motion: no-preference) &#123;\n  .App-logo &#123;\n    animation: App-logo-spin infinite 20s linear;\n  &#125;\n&#125;\n\n.App-header &#123;\n  background-color: #282c34;\n  min-height: 100vh;\n  display: flex;\n  flex-direction: column;\n  align-items: center;\n  justify-content: center;\n  font-size: calc(10px + 2vmin);\n  color: white;\n&#125;\n\n.App-link &#123;\n  color: #61dafb;\n&#125;\n\n@keyframes App-logo-spin &#123;\n  from &#123;\n    transform: rotate(0deg);\n  &#125;\n  to &#123;\n    transform: rotate(360deg);\n  &#125;\n&#125;\n\nbutton &#123;\n  font-size: calc(10px + 2vmin);\n&#125;\n"</span>
<span class="token function">updateStyle</span><span class="token punctuation">(</span><span class="token string">"\"7ac702d2\""</span><span class="token punctuation">,</span> css<span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> css<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>Turn CSS into a string and then call the <code>updateStyle</code> function. As long as Vite is loaded on the client, <code>/vite/client</code> utils will be automatically loaded together, which will handle things like HMR or loading CSS. For example, the <code>updateStyle</code> above is in this file.</p>
<p>Alright, by now we have a general understanding of what Vite is. Why is it faster? Because webpack needs to bundle, but Vite doesn’t, so it doesn’t need to package all of your source code together. It only needs to start a local server so that your <code>import</code> can fetch the correct files. Without the need for packaging, the speed is naturally much faster, and this is the power of Native ESM.</p>
<h2><span id="how-about-production">How about production?</span></h2><p>Just run <code>npx vite build</code> to generate a production build, but the resulting file may disappoint you because, like webpack, it’s a large package of <code>index.js</code> with all the code inside.</p>
<p>This is because production currently uses rollup to build, which is a traditional packaging strategy, no different from webpack. The reason is also stated in <a target="_blank" rel="noopener" href="https://github.com/vitejs/vite#production-build">Vite’s docs</a>:</p>
<blockquote>
<p>Vite does utilize bundling for production builds, because native ES module imports result in waterfall network requests that are simply too punishing for page load time in production.</p>
</blockquote>
<p>Let me explain what this problem is. The problem comes from the dependencies between packages.</p>
<p>Suppose you use a package A that needs to load package B, and package B depends on package C, and so on, creating a long chain of dependencies that extends to the sky. The browser has to wait until all these packages are downloaded before it can start executing JavaScript. This is what the original text refers to as “waterfall network requests,” so using this method in production is problematic.</p>
<p>Especially with HTTP&#x2F;1.1, browsers have a parallel limit, mostly around 5, so if you have 60 dependencies to download, you have to wait for a long time. Although HTTP&#x2F;2 can improve this problem to some extent, it still can’t handle too many things.</p>
<p>So why isn’t there a problem locally? Because the download time of the local server is almost 0! So this is an issue that only occurs in production. And this problem has already been addressed by some, such as <a target="_blank" rel="noopener" href="https://www.pika.dev/about">pika</a>:</p>
<blockquote>
<p>Pika is building a world where third-party libraries can be loaded, cached, and shared across sites.</p>
</blockquote>
<p>As I understand it, it’s a bit like if everyone’s ESM is downloaded from pika, the browser can cache these packages, and the downloaded ones don’t need to be downloaded again, so the speed will be much faster. But of course, there are still other issues to be resolved, such as whether the browser will provide so much space for you to put things, and so on.</p>
<h2><span id="conclusion">Conclusion</span></h2><p>Vite seems to have sparked a small trend recently, with some open-source projects asking if there is a chance to switch to Vite as a dev server. Although snowpack has been out for a while, this use of Native ESM should be better known when Vite becomes popular.</p>
<p>I personally think that when developing locally, ESM can indeed make things much faster, and it’s a direction worth trying. I even think that in the future, this may be the standard development method, replacing the original bundler. And if we can solve the waterfall problem I just mentioned in production, we may be able to produce two targets: one is for modern browsers, which directly uses ESM + ES6 output, saving a lot of build time; the other is for older browsers, which uses the old way with webpack or rollup, etc.</p>
<p>Evan You previously recorded a podcast with Adam Wathan (author of Tailwind CSS), talking about why he wanted to make Vite, the future development direction of Vite, and the problems it may encounter in production builds, etc. I highly recommend everyone to listen to it: <a target="_blank" rel="noopener" href="https://player.fm/series/series-1401837/ep-140-evan-you-reimagining-the-modern-dev-server-with-vite">140: Evan You - Reimagining the Modern Dev Server with Vite</a>.</p>

    
    </div>
    
    <div class="columns is-variable is-1 is-multiline is-mobile">
    
        <span class="column is-narrow"><a class="tag is-light article-tag" href="/en/tags/Front-end/">#Front-end</a></span>
    
        <span class="column is-narrow"><a class="tag is-light article-tag" href="/en/tags/JavaScript/">#JavaScript</a></span>
    
    </div>
    
    
    <div class="columns is-mobile is-multiline article-nav">
        <span class="column is-12-mobile is-half-desktop  article-nav-prev">
            
            <a href="/2020/09/05/en/session-storage-and-html-spec-and-noopener/">Starting a Journey with SessionStorage</a>
            
        </span>
        <span class="column is-12-mobile is-half-desktop  article-nav-next">
            
            <a href="/2020/07/11/en/an-interesting-styled-components-bug/">An interesting styled components bug</a>
            
        </span>
    </div>
    
</article>




<div class="comments">
    <h3 class="title is-4">Comments</h3>
    <script src="https://utteranc.es/client.js"
        repo="aszx87410/huli-blog"
        issue-term="title"
        theme="github-light"
        crossorigin="anonymous"
        async>
</script>
</div>

    </div>
</section>
    <footer class="footer">
    <div class="container">
        <div class="columns content">
            <div class="column is-narrow has-text-centered">
                &copy; 2025 Huli&nbsp;
                Powered by <a href="http://hexo.io/" target="_blank">Hexo</a> & <a
                        target="_blank" rel="noopener" href="http://github.com/ppoffice/hexo-theme-minos">Minos</a>
            </div>
            <div class="column is-hidden-mobile"></div>

            
            <div class="column is-narrow">
                <div class="columns is-mobile is-multiline is-centered">
                
                    
                <a class="column is-narrow" title="GitHub" target="_blank" rel="noopener" href="https://github.com/ppoffice/hexo-theme-minos">
                    
                    GitHub
                    
                </a>
                
                </div>
            </div>
            
            
<div class="column is-narrow has-text-centered">
    <div class="dropdown is-up is-right is-hoverable" style="margin-top: -0.2em;">
        <div class="dropdown-trigger">
            <button class="button is-small" aria-haspopup="true">
                <span class="icon">
                    <i class="fas fa-globe"></i>
                </span>
                <span>English</span>
                <span class="icon is-small">
            <i class="fas fa-angle-down" aria-hidden="true"></i>
          </span>
            </button>
        </div>
        <div class="dropdown-menu has-text-left" role="menu" style="top:100%">
            <div class="dropdown-content">
            <!-- NOTE: 永遠回到首頁 -->
            
                <a href="/2020/08/08/vite-and-esmodules/" class="dropdown-item">
                    繁體中文
                </a>
            
            </div>
        </div>
    </div>
</div>

        </div>
    </div>
</footer>
    <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/3.6.3/jquery.min.js"></script>



    
    
    
    
    
    
<script src="//cdnjs.cloudflare.com/ajax/libs/lightgallery/1.6.8/js/lightgallery-all.min.js"></script>
<script>
    (function ($) {
        $(document).ready(function () {
            if (typeof($.fn.lightGallery) === 'function') {
                $('.article.gallery').lightGallery({ selector: '.gallery-item' });
            }
        });
    })(jQuery);
</script>

    
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.0/clipboard.min.js"></script>
    <style>
        .hljs {
            position: relative;
        }

        .hljs .clipboard-btn {
            float: right;
            color: #9a9a9a;
            background: none;
            border: none;
            cursor: pointer;
        }

        .hljs .clipboard-btn:hover {
          color: #8a8a8a;
        }

        .hljs > .clipboard-btn {
            display: none;
            position: absolute;
            right: 4px;
            top: 4px;
        }

        .hljs:hover > .clipboard-btn {
            display: inline;
        }

        .hljs > figcaption > .clipboard-btn {
            margin-right: 4px;
        }
    </style>
    <script>
      $(document).ready(function () {
        $('figure.hljs').each(function(i, figure) {
          var codeId = 'code-' + i;
          var code = figure.querySelector('.code');
          var copyButton = $('<button>Copy <i class="far fa-clipboard"></i></button>');
          code.id = codeId;
          copyButton.addClass('clipboard-btn');
          copyButton.attr('data-clipboard-target-id', codeId);

          var figcaption = figure.querySelector('figcaption');

          if (figcaption) {
            figcaption.append(copyButton[0]);
          } else {
            figure.prepend(copyButton[0]);
          }
        })

        var clipboard = new ClipboardJS('.clipboard-btn', {
          target: function(trigger) {
            return document.getElementById(trigger.getAttribute('data-clipboard-target-id'));
          }
        });
        clipboard.on('success', function(e) {
          e.clearSelection();
        })
      })
    </script>

    
    

    



<script src="/js/script.js?v=3.js"></script>


    
</body>
</html>