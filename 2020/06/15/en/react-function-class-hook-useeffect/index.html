<!DOCTYPE html>
<html class="has-navbar-fixed-top" lang="en">
<head>
    <meta charset="utf-8">
<title>Differences between class and function components from practical examples - Huli&#39;s blog</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="google-adsense-account" content="ca-pub-1121865251398741">
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1121865251398741"
     crossorigin="anonymous"></script>


            
<link href="https://blog.huli.tw/2020/06/15/react-function-class-hook-useeffect/" rel="alternate" hreflang="zh-TW" />
            
    




    
<link rel="canonical" href="https://blog.huli.tw/2020/06/15/en/react-function-class-hook-useeffect/">
    





    <meta name="description" content="IntroductionTo learn something new, it’s not very useful to just read about it. The best way is to get your hands dirty and start doing it. Since React hooks had just come out when I was about to leav">
<meta property="og:type" content="article">
<meta property="og:title" content="Differences between class and function components from practical examples">
<meta property="og:url" content="https://blog.huli.tw/2020/06/15/en/react-function-class-hook-useeffect/index.html">
<meta property="og:site_name" content="Huli&#39;s blog">
<meta property="og:description" content="IntroductionTo learn something new, it’s not very useful to just read about it. The best way is to get your hands dirty and start doing it. Since React hooks had just come out when I was about to leav">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://blog.huli.tw/img/react-function-class-hook-useeffect/cover-en.png">
<meta property="article:published_time" content="2020-06-15T14:19:37.000Z">
<meta property="article:modified_time" content="2023-06-20T05:46:56.927Z">
<meta property="article:author" content="Huli">
<meta property="article:tag" content="React">
<meta property="article:tag" content="Front-end">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://blog.huli.tw/img/react-function-class-hook-useeffect/cover-en.png">



<link rel="alternative" href="/atom.xml" title="Differences between class and function components from practical examples" type="application/atom+xml">



<link rel="icon" href="/img/lidemy_logo.png">


<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Ovo|Source+Code+Pro">


<link rel="stylesheet" href="/css/bulma.css?v=2.css">



<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/lightgallery/1.6.8/css/lightgallery.min.css">


<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/line-numbers/prism-line-numbers.min.css" />


<link rel="stylesheet" href="/css/style.css?v=4.css">





    
    
    
    
    
    
    
    
    
    
<script async src="https://www.googletagmanager.com/gtag/js?id=G-1393J2EVCZ"></script>
<script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-1393J2EVCZ');
</script>


    


<meta name="generator" content="Hexo 6.3.0"></head>
<body>
    <script>
        if (localStorage.getItem('dark-mode')) {
            if (localStorage.getItem('dark-mode') === 'true') {
                document.body.classList.add('dark-mode')
            }
        } else {
            if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                document.body.classList.add('dark-mode')
            }
        }
    </script>
    
<nav class="navbar is-transparent is-fixed-top navbar-main" role="navigation" aria-label="main navigation">
    <div class="container">
        <div class="navbar-brand">
            <a class="navbar-item navbar-logo" href="/en">
                
                    
                    Huli&#39;s blog
                    
                
            </a>
            <div class="navbar-burger">
                <span></span>
                <span></span>
                <span></span>
            </div>
        </div>
        
        <div class="navbar-menu navbar-start">
            
            <a class="navbar-item "
               href="/en/archives">Archive</a>
            
            <a class="navbar-item "
               href="/en/categories">Categories</a>
            
            <a class="navbar-item "
               href="/en/about">About</a>
            
        </div>
        
        <div class="navbar-menu navbar-end">
            
            
            <div class="navbar-item is-hoverable has-dropdown is-hidden-mobile is-hidden-tablet-only toc">
                <a class="navbar-item" title="Table of Contents">
                    Table of Contents
                </a>
                <div class="navbar-dropdown">
                    
                    
                    
                    
                    <a class="navbar-item" href="#introduction">1&nbsp;&nbsp;<b>Introduction</b></a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#practical-example">2&nbsp;&nbsp;<b>Practical example</b></a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#react-implementation-class-component-version">3&nbsp;&nbsp;<b>React implementation: Class component version</b></a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#the-protagonist-appears-react-hook">4&nbsp;&nbsp;<b>The protagonist appears: React hook</b></a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#the-real-problem">5&nbsp;&nbsp;<b>The Real Problem</b></a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#why-doesnt-your-solution-work">6&nbsp;&nbsp;<b>Why doesn’t your solution work?</b></a>
                    
                    
                    
                    <a class="navbar-item" href="#attempt-1">6.1&nbsp;&nbsp;Attempt 1</a>
                    
                    
                    
                    <a class="navbar-item" href="#attempt-2">6.2&nbsp;&nbsp;Attempt 2</a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#attempt-three">7&nbsp;&nbsp;<b>Attempt Three</b></a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#review-and-reflection">8&nbsp;&nbsp;<b>Review and Reflection</b></a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#summary">9&nbsp;&nbsp;<b>Summary</b></a>
                    
                </div>
            </div>
            
            
            <a class="navbar-item" target="_blank" title="Twitter" href="https://twitter.com/aszx87410">
                
                <i class="fab fa-twitter"></i>
                
            </a>
               
            <a class="navbar-item" target="_blank" title="RSS" href="/atom-en.xml">
                
                <i class="fas fa-rss"></i>
                
            </a>
               
            
            <a class="navbar-item btn-dark-mode" title="dark-mode" href="#">
                <div>
                    <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" width="15" height="15" viewBox="0 0 256 256" xml:space="preserve">
                    <defs>
                    </defs>
                    <g style="stroke: none; stroke-width: 0; stroke-dasharray: none; stroke-linecap: butt; stroke-linejoin: miter; stroke-miterlimit: 10; fill: none; fill-rule: nonzero; opacity: 1;" transform="translate(1.4065934065934016 1.4065934065934016) scale(2.81 2.81)" >
                        <path d="M 87.823 60.7 c -0.463 -0.423 -1.142 -0.506 -1.695 -0.214 c -15.834 8.398 -35.266 2.812 -44.232 -12.718 c -8.966 -15.53 -4.09 -35.149 11.101 -44.665 c 0.531 -0.332 0.796 -0.963 0.661 -1.574 c -0.134 -0.612 -0.638 -1.074 -1.259 -1.153 c -9.843 -1.265 -19.59 0.692 -28.193 5.66 C 13.8 12.041 6.356 21.743 3.246 33.35 S 1.732 57.08 7.741 67.487 c 6.008 10.407 15.709 17.851 27.316 20.961 C 38.933 89.486 42.866 90 46.774 90 c 7.795 0 15.489 -2.044 22.42 -6.046 c 8.601 -4.966 15.171 -12.43 18.997 -21.586 C 88.433 61.79 88.285 61.123 87.823 60.7 z" style="stroke: none; stroke-width: 1; stroke-dasharray: none; stroke-linecap: butt; stroke-linejoin: miter; stroke-miterlimit: 10; fill: #ffa716; fill-rule: nonzero; opacity: 1;" transform=" matrix(1 0 0 1 0 0) " stroke-linecap="round" />
                    </g>
                    </svg>
                </div>
            </a>
            
               <a class="navbar-item" href="/2020/06/15/react-function-class-hook-useeffect/">中文</a>
            
            

        </div>
    </div>
</nav>

    <section class="section">
    <div class="container">
      
      <div data-nosnippet class="self-notice">
        If you have any thoughts on my blog or articles and you want to let me know, you can either post a comment below(public) or tell me via this <a href="https://forms.gle/SjJZ4cnNs6NnjXQG8" target="_blank">feedback form</a>
      </div>
      
    <article class="article content gallery" itemscope itemprop="blogPost">
    <h1 class="article-title is-size-3 is-size-4-mobile" itemprop="name">
        
            Differences between class and function components from practical examples
        
    </h1>
    <div class="article-meta columns is-variable is-1 is-multiline is-mobile is-size-7-mobile">
        <span class="column is-narrow">
            <time datetime="2020-06-15T14:19:37.000Z" itemprop="datePublished">15 June 2020</time>
        </span>
        
        <span class="column is-narrow article-category">
            <i class="far fa-folder"></i>
            <a class="article-category-link" href="/en/categories/React/">React</a>
        </span>
        
        
        
        <spen data-nosnippet class="column is-narrow">(Translated by ChatGPT)</span>
        
    </div>
    
    <div class="article-entry is-size-6-mobile" itemprop="articleBody">
    
        <h2><span id="introduction">Introduction</span></h2><p>To learn something new, it’s not very useful to just read about it. The best way is to get your hands dirty and start doing it. Since React hooks had just come out when I was about to leave my previous job, I had never written hooks before, only seen some basic tutorials. But after starting my new job, I finally started writing function components + hooks.</p>
<p>Although I initially missed the class syntax, I found hooks to be quite good after writing them for a while. In the process of using hooks, I also encountered some common problems that people who are new to them often face. After careful study, I found that the case I want to discuss in this article is quite good. If you can understand this case, you should be able to grasp the fundamental differences between class and function components. Therefore, I wrote this article to record my experience.</p>
<p>By the way, if you have been writing function components for a while, are quite used to hooks, and have read the official documentation and Dan Abramov’s articles carefully, you probably won’t gain any new knowledge from this article. This article is suitable for those who have just switched to function components and are not sure what the differences are between them and class components.</p>
<span id="more"></span>

<h2><span id="practical-example">Practical example</span></h2><p>This case is what I encountered when integrating <a target="_blank" rel="noopener" href="https://developers.google.com/recaptcha">Google reCAPTCHA</a>, so let me first talk about integrating reCAPTCHA.</p>
<p>I believe that most people are familiar with reCAPTCHA because it is quite common on the Internet. There are currently two versions, v2 and v3, and v2 also has several different types, one of which is called the checkbox version, which is the one we see most often that asks you to check the “I’m not a robot” box:</p>
<p><img src="https://static.coderbridge.com/img/aszx87410/2004360581674cf3ae8d223b9ee2b2f5.png"></p>
<p>The integration method is very simple. First, you must load the reCAPTCHA script:</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token operator">&lt;</span>script src<span class="token operator">=</span><span class="token string">"https://www.google.com/recaptcha/api.js?onload=onloadCallback&amp;render=explicit"</span>
    <span class="token keyword">async</span> defer<span class="token operator">></span>
<span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>The <code>onload</code> parameter needs to be passed the name of the callback function, which will be called after the script is loaded. <code>render=explicit</code> tells it that we want to call the code ourselves to render that box (the other implicit method can put attributes in the html element in the form of <code>data-xxx</code>, allowing Google to render that box itself).</p>
<p>After the script is loaded, the callback function you provided will be called, and there will be a global variable <code>grecaptcha</code> that you can use. Then you can use:</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">grecaptcha<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token string">'html_element'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>
    <span class="token literal-property property">sitekey</span> <span class="token operator">:</span> <span class="token string">'your_site_key'</span><span class="token punctuation">,</span>
    <span class="token function-variable function">callback</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">token</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>to turn <code>html_element</code> into the box that displays reCAPTCHA, and get the token through the callback function passed in when the user clicks.</p>
<p>Here I have made a small example: <a target="_blank" rel="noopener" href="https://codepen.io/aszx87410/pen/ExPKRdO?editors=1010">codepen</a>, and the interface looks like this:</p>
<p><img src="https://static.coderbridge.com/img/aszx87410/cea36c0cdd044637b14ef3c079a3ca2d.png"></p>
<p>The code is actually very simple:</p>
<pre class="line-numbers language-none"><code class="language-none">&lt;div id&#x3D;&quot;robot&quot;&gt;&lt;&#x2F;div&gt;
Your token:
&lt;div id&#x3D;&quot;token&quot;&gt;&lt;&#x2F;div&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">window<span class="token punctuation">.</span><span class="token function-variable function">onloadCallback</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  grecaptcha<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span>document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">'#robot'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// test site key from https://developers.google.com/recaptcha/docs/faq</span>
    <span class="token literal-property property">sitekey</span> <span class="token operator">:</span> <span class="token string">'6LeIxAcTAAAAAJcZVRqyHh71UMIEGNQ_MXjiZKhI'</span><span class="token punctuation">,</span>
    <span class="token function-variable function">callback</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">token</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">'#token'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>innerText <span class="token operator">=</span> token
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>Okay, this reCAPTCHA is our protagonist today. After introducing how to use it, let’s take a look at how to implement it in React.</p>
<h2><span id="react-implementation-class-component-version">React implementation: Class component version</span></h2><p>When adding a new component, I always think about one thing first, which is how I want to use it. This is very important because it will determine what the component looks like.</p>
<p>If there is a reCAPTCHA component, I would like to use it like this:</p>
<pre class="line-numbers language-jsx" data-language="jsx"><code class="language-jsx"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">ReCAPTCHA</span></span> <span class="token attr-name">sitekey</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">&#123;</span>siteKey<span class="token punctuation">&#125;</span></span> <span class="token attr-name">onChange</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">&#123;</span>onChange<span class="token punctuation">&#125;</span></span> <span class="token punctuation">/></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>This component should be able to:</p>
<ol>
<li>Automatically load the required script for us</li>
<li>Automatically generate a checkbox element</li>
<li>When the user checks it, pass the token back through onChange</li>
</ol>
<p>Let’s implement this component! The complete code will look like this:</p>
<pre class="line-numbers language-jsx" data-language="jsx"><code class="language-jsx"><span class="token keyword">class</span> <span class="token class-name">ReCAPTCHA</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span> <span class="token punctuation">&#123;</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">props</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>divRef <span class="token operator">=</span> React<span class="token punctuation">.</span><span class="token function">createRef</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>callbackName <span class="token operator">=</span> <span class="token string">"__recaptcha__cb"</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token function">componentDidMount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 檢查是否已經載入完成</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>window<span class="token punctuation">.</span>grecaptcha<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">handleLoad</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  
  <span class="token comment">// 負責來執行 callback function</span>
  <span class="token function-variable function">handleCallback</span> <span class="token operator">=</span> <span class="token parameter">token</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span><span class="token function">onChange</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

  <span class="token function-variable function">handleLoad</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 載入完成，渲染元素</span>
    <span class="token keyword">const</span> <span class="token punctuation">&#123;</span> sitekey <span class="token punctuation">&#125;</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">;</span>
    window<span class="token punctuation">.</span>grecaptcha<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>divRef<span class="token punctuation">.</span>current<span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>
      sitekey<span class="token punctuation">,</span>
      <span class="token literal-property property">callback</span><span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>handleCallback
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

  <span class="token function-variable function">init</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
    window<span class="token punctuation">[</span><span class="token keyword">this</span><span class="token punctuation">.</span>callbackName<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>handleLoad<span class="token punctuation">;</span>
    <span class="token keyword">const</span> script <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">"script"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    script<span class="token punctuation">.</span>src <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">https://www.google.com/recaptcha/api.js?onload=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>callbackName
    <span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">&amp;render=explicit</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
    script<span class="token punctuation">.</span>async <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    document<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>script<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">ref</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">&#123;</span><span class="token keyword">this</span><span class="token punctuation">.</span>divRef<span class="token punctuation">&#125;</span></span> <span class="token punctuation">/></span></span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>In <code>componentDidMount</code>, we check if <code>grecaptcha</code> exists. If it doesn’t, we load it. If it does, we call <code>this.handleLoad</code> and handle the rendering-related issues inside. The loading part dynamically generates a script tag and inserts it into the document, so we don’t have to manually import the script into the HTML, which is much more convenient. The <code>handleLoad</code> part is just calling <code>grecaptcha.render</code> as written above:</p>
<pre class="line-numbers language-jsx" data-language="jsx"><code class="language-jsx"><span class="token function-variable function">handleLoad</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  <span class="token comment">// 載入完成，渲染元素</span>
  <span class="token keyword">const</span> <span class="token punctuation">&#123;</span> sitekey <span class="token punctuation">&#125;</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">;</span>
  window<span class="token punctuation">.</span>grecaptcha<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>divRef<span class="token punctuation">.</span>current<span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>
    sitekey<span class="token punctuation">,</span>
    <span class="token literal-property property">callback</span><span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>handleCallback
  <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>After completing this component, render it on the upper level and pass in an <code>onChange</code> callback function. The interface will look like this:</p>
<p><img src="https://static.coderbridge.com/img/aszx87410/6176df0e2eea4593bbc35439c83a38a6.png"></p>
<p>The complete code will look like this:</p>
<pre class="line-numbers language-jsx" data-language="jsx"><code class="language-jsx"><span class="token keyword">import</span> React<span class="token punctuation">,</span> <span class="token punctuation">&#123;</span> useState <span class="token punctuation">&#125;</span> <span class="token keyword">from</span> <span class="token string">"react"</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">ReCAPTCHA</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span> <span class="token punctuation">&#123;</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">props</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>divRef <span class="token operator">=</span> React<span class="token punctuation">.</span><span class="token function">createRef</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>callbackName <span class="token operator">=</span> <span class="token string">"__recaptcha__cb"</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token function">componentDidMount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 檢查是否已經載入完成</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>window<span class="token punctuation">.</span>grecaptcha<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">handleLoad</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token function-variable function">handleCallback</span> <span class="token operator">=</span> <span class="token parameter">token</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span><span class="token function">onChange</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

  <span class="token function-variable function">handleLoad</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 載入完成，渲染元素</span>
    <span class="token keyword">const</span> <span class="token punctuation">&#123;</span> sitekey <span class="token punctuation">&#125;</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">;</span>
    window<span class="token punctuation">.</span>grecaptcha<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>divRef<span class="token punctuation">.</span>current<span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>
      sitekey<span class="token punctuation">,</span>
      <span class="token literal-property property">callback</span><span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>handleCallback
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

  <span class="token function-variable function">init</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
    window<span class="token punctuation">[</span><span class="token keyword">this</span><span class="token punctuation">.</span>callbackName<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>handleLoad<span class="token punctuation">;</span>
    <span class="token keyword">const</span> script <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">"script"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    script<span class="token punctuation">.</span>src <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">https://www.google.com/recaptcha/api.js?onload=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>callbackName
    <span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">&amp;render=explicit</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
    script<span class="token punctuation">.</span>async <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    document<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>script<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">ref</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">&#123;</span><span class="token keyword">this</span><span class="token punctuation">.</span>divRef<span class="token punctuation">&#125;</span></span> <span class="token punctuation">/></span></span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">const</span> sitekey <span class="token operator">=</span> <span class="token string">"6LeIxAcTAAAAAJcZVRqyHh71UMIEGNQ_MXjiZKhI"</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">App</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>token<span class="token punctuation">,</span> setToken<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">className</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>App<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token plain-text">
      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">ReCAPTCHA</span></span> <span class="token attr-name">sitekey</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">&#123;</span>sitekey<span class="token punctuation">&#125;</span></span> <span class="token attr-name">onChange</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">&#123;</span>setToken<span class="token punctuation">&#125;</span></span> <span class="token punctuation">/></span></span><span class="token plain-text">
      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h2</span><span class="token punctuation">></span></span><span class="token plain-text">Token</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h2</span><span class="token punctuation">></span></span><span class="token plain-text">
      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">></span></span><span class="token punctuation">&#123;</span>token<span class="token punctuation">&#125;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">></span></span><span class="token plain-text">
    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>Here is the complete codesandbox demo: <a target="_blank" rel="noopener" href="https://codesandbox.io/s/practical-rgb-r785j?file=/src/App.js">https://codesandbox.io/s/practical-rgb-r785j?file=/src/App.js</a> (Note: this component actually has some unresolved issues, but since the focus is not on writing the reCAPTCHA library, we won’t mention them too much.)</p>
<p>The key point of this component is actually that we check whether the script has been loaded completely in <code>componentDidMount</code>. If not, we load it first, and then execute <code>window.grecaptcha.render</code> after loading is complete. The <code>window.grecaptcha.render</code> function will only be called once. Unless the component is unmounted and then remounted, <code>window.grecaptcha.render</code> will be called again.</p>
<p>In fact, if you want to call <code>window.grecaptcha.render</code> a second time on the same element (<code>this.divRef</code>), it is not possible and an error message will pop up: <code>Uncaught Error: reCAPTCHA has already been rendered in this element</code>, which tells you that the component has already been rendered.</p>
<p>This article is actually related to this behavior, because this component cannot be rendered again, so our focus is: “<code>window.grecaptcha.render</code> can only be called once, and once the callback function is set, it cannot be changed.”</p>
<p>After understanding this key point, reCAPTCHA can actually exit the stage. Because the appearance of “reCAPTCHA” in this article is only because of this behavior. We can actually simulate this behavior ourselves and rewrite it into a function:</p>
<pre class="line-numbers language-jsx" data-language="jsx"><code class="language-jsx"><span class="token keyword">import</span> React<span class="token punctuation">,</span> <span class="token punctuation">&#123;</span> useState <span class="token punctuation">&#125;</span> <span class="token keyword">from</span> <span class="token string">"react"</span><span class="token punctuation">;</span>

<span class="token keyword">let</span> isCalled <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> grecaptcha <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
  <span class="token function-variable function">render</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">element<span class="token punctuation">,</span> <span class="token punctuation">&#123;</span> callback <span class="token punctuation">&#125;</span></span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>isCalled<span class="token punctuation">)</span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">"You can only call me once"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    isCalled <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    element<span class="token punctuation">.</span>innerText <span class="token operator">=</span> <span class="token string">"click me if you are not robot"</span><span class="token punctuation">;</span>
    element<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">"click"</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token function">callback</span><span class="token punctuation">(</span><span class="token string">"you got token!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">ReCAPTCHA</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span> <span class="token punctuation">&#123;</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">props</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>divRef <span class="token operator">=</span> React<span class="token punctuation">.</span><span class="token function">createRef</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token function">componentDidMount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">handleLoad</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token function-variable function">handleCallback</span> <span class="token operator">=</span> <span class="token parameter">token</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span><span class="token function">onChange</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

  <span class="token function-variable function">handleLoad</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
    grecaptcha<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>divRef<span class="token punctuation">.</span>current<span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>
      <span class="token literal-property property">callback</span><span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>handleCallback
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">ref</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">&#123;</span><span class="token keyword">this</span><span class="token punctuation">.</span>divRef<span class="token punctuation">&#125;</span></span> <span class="token punctuation">/></span></span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">App</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>token<span class="token punctuation">,</span> setToken<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">className</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>App<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token plain-text">
      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">ReCAPTCHA</span></span> <span class="token attr-name">onChange</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">&#123;</span>setToken<span class="token punctuation">&#125;</span></span> <span class="token punctuation">/></span></span><span class="token plain-text">
      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h2</span><span class="token punctuation">></span></span><span class="token plain-text">Token</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h2</span><span class="token punctuation">></span></span><span class="token plain-text">
      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">></span></span><span class="token punctuation">&#123;</span>token<span class="token punctuation">&#125;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">></span></span><span class="token plain-text">
    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>The interface looks like this:</p>
<p><img src="https://static.coderbridge.com/img/aszx87410/fdcf848f290e4ed9ba5de4569d3924cc.png"></p>
<p>The example code that can run is here: <a target="_blank" rel="noopener" href="https://codesandbox.io/s/simulate-grecaptcha-5z90f">https://codesandbox.io/s/simulate-grecaptcha-5z90f</a></p>
<p>It’s just a simple simulation of reCAPTCHA’s behavior. Our focus is only: “<code>grecaptcha.render</code> can only be called once.”</p>
<h2><span id="the-protagonist-appears-react-hook">The protagonist appears: React hook</span></h2><p>After laying out so much of reCAPTCHA’s behavior and class component implementation, it’s finally time for React hook to appear. Let’s directly rewrite the above example using hooks:</p>
<pre class="line-numbers language-jsx" data-language="jsx"><code class="language-jsx"><span class="token keyword">const</span> <span class="token function-variable function">ReCAPTCHA</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">&#123;</span> onChange <span class="token punctuation">&#125;</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">const</span> divRef <span class="token operator">=</span> <span class="token function">useRef</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> <span class="token function-variable function">handleCallback</span> <span class="token operator">=</span> <span class="token parameter">token</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
    <span class="token function">onChange</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> <span class="token function-variable function">handleLoad</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
    grecaptcha<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span>divRef<span class="token punctuation">.</span>current<span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>
      <span class="token literal-property property">callback</span><span class="token operator">:</span> handleCallback
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

  <span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
    <span class="token function">handleLoad</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">ref</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">&#123;</span>divRef<span class="token punctuation">&#125;</span></span> <span class="token punctuation">/></span></span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>The code becomes much cleaner. React hook is awesome!</p>
<p>Currently, we are just following the logic of the previous class component. In <code>componentDidMount</code>, we execute <code>handleLoad</code>, and then call <code>grecaptcha.render</code> inside <code>handleLoad</code> and set the callback function to be handled by <code>handleCallback</code>, and finally pass the token back through <code>props.onChange</code>.</p>
<p>When we try it out, we find that the functionality is completely fine. Here is the complete code: <a target="_blank" rel="noopener" href="https://codesandbox.io/s/simulate-grecaptcha-react-hook-kxerd?file=/src/App.js:391-714">https://codesandbox.io/s/simulate-grecaptcha-react-hook-kxerd?file=/src/App.js:391-714</a></p>
<p>But… is it really okay?</p>
<p>At first glance, it seems like this, but actually it’s not. This is the real point that this article wants to make.</p>
<p>You can think about what the problem might be and continue reading. If you have already figured it out and know how to solve it, congratulations, you have a certain level of familiarity with hooks.</p>
<h2><span id="the-real-problem">The Real Problem</span></h2><p>The previous sections introduced the use of reCAPTCHA and the fact that “<code>grecaptcha.render</code> can only be called once, so the binding of the callback function can only be done once.” This is related to an important issue that this article wants to raise, which is:</p>
<blockquote>
<p>What happens if the <code>onChange</code> prop is changed?</p>
</blockquote>
<p>You might say, “Oh? If it’s changed, it’s changed. What’s the problem?”</p>
<p>I’ll provide a simple example:</p>
<pre class="line-numbers language-jsx" data-language="jsx"><code class="language-jsx"><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">App</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>isOld<span class="token punctuation">,</span> setIsOld<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> <span class="token function-variable function">oldFunction</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"old function"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> <span class="token function-variable function">newFunction</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"new function"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> <span class="token punctuation">(</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">className</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>App<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token plain-text">
      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">ReCAPTCHA</span></span> <span class="token attr-name">onChange</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">&#123;</span>isOld <span class="token operator">?</span> oldFunction <span class="token operator">:</span> newFunction<span class="token punctuation">&#125;</span></span> <span class="token punctuation">/></span></span><span class="token plain-text">
      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span>
        <span class="token attr-name">onClick</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">&#123;</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
          console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"Switch to new function"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token function">setIsOld</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span></span>
      <span class="token punctuation">></span></span><span class="token plain-text">
        change function
      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">></span></span><span class="token plain-text">
    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>This example will determine which function to pass based on the <code>isOld</code> state. By default, it passes <code>oldFunction</code>. After clicking the button, <code>isOld</code> is set to <code>false</code>, so it passes <code>newFunction</code>. You can see which function is called in the console. Now let’s try the example of the hook after modifying it:</p>
<p><img src="https://static.coderbridge.com/img/aszx87410/82ce45b832234064894f7fc4a170b241.gif"></p>
<p>Is it the same as you thought? Even though we changed the <code>onChange</code> prop to the new function, why is the old one still being called? I’ll provide the complete code for you to think about:</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">import</span> React<span class="token punctuation">,</span> <span class="token punctuation">&#123;</span> useState<span class="token punctuation">,</span> useRef<span class="token punctuation">,</span> useEffect <span class="token punctuation">&#125;</span> <span class="token keyword">from</span> <span class="token string">"react"</span><span class="token punctuation">;</span>

<span class="token keyword">let</span> isCalled <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> grecaptcha <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
  <span class="token function-variable function">render</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">element<span class="token punctuation">,</span> <span class="token punctuation">&#123;</span> callback <span class="token punctuation">&#125;</span></span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>isCalled<span class="token punctuation">)</span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">"You can only call me once"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    isCalled <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    element<span class="token punctuation">.</span>innerText <span class="token operator">=</span> <span class="token string">"click me if you are not robot"</span><span class="token punctuation">;</span>
    element<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">"click"</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token function">callback</span><span class="token punctuation">(</span><span class="token string">"you got token!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token function-variable function">ReCAPTCHA</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">&#123;</span> onChange <span class="token punctuation">&#125;</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">const</span> divRef <span class="token operator">=</span> <span class="token function">useRef</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> <span class="token function-variable function">handleCallback</span> <span class="token operator">=</span> <span class="token parameter">token</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
    <span class="token function">onChange</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> <span class="token function-variable function">handleLoad</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
    grecaptcha<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span>divRef<span class="token punctuation">.</span>current<span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>
      <span class="token literal-property property">callback</span><span class="token operator">:</span> handleCallback
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

  <span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
    <span class="token function">handleLoad</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> <span class="token operator">&lt;</span>div ref<span class="token operator">=</span><span class="token punctuation">&#123;</span>divRef<span class="token punctuation">&#125;</span> <span class="token operator">/</span><span class="token operator">></span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">App</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>isOld<span class="token punctuation">,</span> setIsOld<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> <span class="token function-variable function">oldFunction</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"old function"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> <span class="token function-variable function">newFunction</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"new function"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&lt;</span>div className<span class="token operator">=</span><span class="token string">"App"</span><span class="token operator">></span>
      <span class="token operator">&lt;</span>ReCAPTCHA onChange<span class="token operator">=</span><span class="token punctuation">&#123;</span>isOld <span class="token operator">?</span> oldFunction <span class="token operator">:</span> newFunction<span class="token punctuation">&#125;</span> <span class="token operator">/</span><span class="token operator">></span>
      <span class="token operator">&lt;</span>button
        onClick<span class="token operator">=</span><span class="token punctuation">&#123;</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
          console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"Switch to new function"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token function">setIsOld</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span>
      <span class="token operator">></span>
        change <span class="token keyword">function</span>
      <span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">></span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>Runnable example: <a target="_blank" rel="noopener" href="https://codesandbox.io/s/simulate-grecaptcha-react-hook-change-props-chl50?file=/src/App.js">https://codesandbox.io/s/simulate-grecaptcha-react-hook-change-props-chl50?file=/src/App.js</a></p>
<p>While you’re thinking about it, let’s take a look at the previous class component. Does it have this problem?</p>
<p><img src="https://static.coderbridge.com/img/aszx87410/cf6d199aec7a4d7d8c0a1f1398179213.gif"></p>
<p>No, it works perfectly.</p>
<p>(Complete code: <a target="_blank" rel="noopener" href="https://codesandbox.io/s/change-props-onchange-jkm1n?file=/src/App.js">https://codesandbox.io/s/change-props-onchange-jkm1n?file=/src/App.js</a>)</p>
<p>But why does the hook have a problem while the class component doesn’t? Didn’t we use the same logic to rewrite them?</p>
<p>Let’s take a closer look at how the class component works. First, take a look at this important code that simulates it:</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token function-variable function">handleCallback</span> <span class="token operator">=</span> <span class="token parameter">token</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span><span class="token function">onChange</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

<span class="token function-variable function">handleLoad</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  grecaptcha<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>divRef<span class="token punctuation">.</span>current<span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>
    <span class="token literal-property property">callback</span><span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>handleCallback
  <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>When calling <code>grecaptcha.render</code>, we bind the callback function to <code>this.handleCallback</code>, and this function calls <code>this.props.onChange(token)</code>. Therefore, it can always call the latest <code>onChange</code> event in the props without any problems.</p>
<p>What about the hook?</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> <span class="token function-variable function">handleCallback</span> <span class="token operator">=</span> <span class="token parameter">token</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  <span class="token function">onChange</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token function-variable function">handleLoad</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  grecaptcha<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span>divRef<span class="token punctuation">.</span>current<span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>
    <span class="token literal-property property">callback</span><span class="token operator">:</span> handleCallback
  <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

<span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  <span class="token function">handleLoad</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>After the element is first rendered, <code>useEffect</code> inside <code>handleLoad</code> is executed, which binds the callback to <code>handleCallback</code>. Then it calls <code>onChange</code> in the props. It seems fine, right?</p>
<p>No, the problem is much bigger.</p>
<p>The biggest difference between a function and a class component is that “a function component remembers the values passed in at that moment.” This may sound a bit difficult to understand, but as long as you have a good mental model, I believe there is no problem. You need to remember one thing, that is:</p>
<blockquote>
<p>Every time a function component is rendered, the function is “re-called.”</p>
</blockquote>
<p>It may sound a bit redundant, but the key is the word “re-called.” If you think about it in this way, you can understand the key points of function components. Let’s take another look at the process above. I have included a number for each step, so please read it according to the number:</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// 1. 第一次 render，onChange = oldFunction</span>
<span class="token comment">// 2. 呼叫 ReCAPTCHA(&#123; onChange: oldFunction &#125;)</span>
<span class="token comment">// 3. 這邊的 onChange 會等於 oldFunction（這是重點，畫三顆星星必考）</span>
<span class="token keyword">const</span> <span class="token function-variable function">ReCAPTCHA</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">&#123;</span> onChange <span class="token punctuation">&#125;</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  <span class="token comment">// 4. 建立 ref</span>
  <span class="token keyword">const</span> divRef <span class="token operator">=</span> <span class="token function">useRef</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 5. 建立函式 handleCallback</span>
  <span class="token comment">// 11. 當 callback 被觸發時，呼叫 onChange（oldFunction）</span>
  <span class="token comment">// 這是重點，畫五顆星星必考</span>
  <span class="token keyword">const</span> <span class="token function-variable function">handleCallback</span> <span class="token operator">=</span> <span class="token parameter">token</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
    <span class="token function">onChange</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

  <span class="token comment">// 6. 建立函式 handleLoad</span>
  <span class="token comment">// 10. 執行 handleLoad，把 callback 綁定到 handleCallback</span>
  <span class="token keyword">const</span> <span class="token function-variable function">handleLoad</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
    grecaptcha<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span>divRef<span class="token punctuation">.</span>current<span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>
      <span class="token literal-property property">callback</span><span class="token operator">:</span> handleCallback
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

  <span class="token comment">// 7. 宣告 useEffect</span>
  <span class="token comment">// 9. render 完畢，執行 handleLoad</span>
  <span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
    <span class="token function">handleLoad</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 8. render</span>
  <span class="token keyword">return</span> <span class="token operator">&lt;</span>div ref<span class="token operator">=</span><span class="token punctuation">&#123;</span>divRef<span class="token punctuation">&#125;</span> <span class="token operator">/</span><span class="token operator">></span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>When the user clicks “change function,” the process is as follows:</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// 1. 第二次 render，onChange = newFunction</span>
<span class="token comment">// 2. 呼叫 ReCAPTCHA(&#123; onChange: newFunction &#125;)</span>
<span class="token comment">// 3. 這邊的 onChange 會等於 newFunction</span>
<span class="token keyword">const</span> <span class="token function-variable function">ReCAPTCHA</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">&#123;</span> onChange <span class="token punctuation">&#125;</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  <span class="token comment">// 4. 建立 ref</span>
  <span class="token keyword">const</span> divRef <span class="token operator">=</span> <span class="token function">useRef</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 5. 建立函式 handleCallback</span>
  <span class="token keyword">const</span> <span class="token function-variable function">handleCallback</span> <span class="token operator">=</span> <span class="token parameter">token</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
    <span class="token function">onChange</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

  <span class="token comment">// 6. 建立函式 handleLoad</span>
  <span class="token keyword">const</span> <span class="token function-variable function">handleLoad</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
    grecaptcha<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span>divRef<span class="token punctuation">.</span>current<span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>
      <span class="token literal-property property">callback</span><span class="token operator">:</span> handleCallback
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

  <span class="token comment">// 7. 宣告 useEffect</span>
  <span class="token comment">// 9. render 完畢，但因為不是第一次，所以不會執行 handleLoad</span>
  <span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
    <span class="token function">handleLoad</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 8. render</span>
  <span class="token keyword">return</span> <span class="token operator">&lt;</span>div ref<span class="token operator">=</span><span class="token punctuation">&#123;</span>divRef<span class="token punctuation">&#125;</span> <span class="token operator">/</span><span class="token operator">></span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>There are several key points here:</p>
<ol>
<li>The <code>handleCallback</code> in the first render and the <code>handleCallback</code> in the second render are two completely different functions, not the same one.</li>
<li>Therefore, you are binding the first <code>handleCallback</code>, so only the first one will be executed, and the <code>onChange</code> in the first one is <code>oldFunction</code>.</li>
<li>Therefore, even if you change <code>onChange</code>, only the second <code>handleCallback</code> will execute the new <code>newFunction</code>, but the callback you bound is the first <code>handleCallback</code>.</li>
</ol>
<p>The key here is that the “function in the first render” and the “function in the second render” are completely different things. When using hooks, there is an eslint prompt that reminds you to add a dependency array when using useEffect or useCallback, in order to get the latest value.</p>
<p>Actually, when writing the above hook code, eslint prompted us, so let’s fix it according to what it said:</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> <span class="token function-variable function">ReCAPTCHA</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">&#123;</span> onChange <span class="token punctuation">&#125;</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">const</span> divRef <span class="token operator">=</span> <span class="token function">useRef</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 當 onChange 改變時，就會產生新的 handleCallback</span>
  <span class="token keyword">const</span> handleCallback <span class="token operator">=</span> <span class="token function">useCallback</span><span class="token punctuation">(</span>
    <span class="token parameter">token</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
      <span class="token function">onChange</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
    <span class="token punctuation">[</span>onChange<span class="token punctuation">]</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>  

  <span class="token comment">// 當 handleCallback 改變時，就會重新呼叫</span>
  <span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">const</span> <span class="token function-variable function">handleLoad</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
      grecaptcha<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span>divRef<span class="token punctuation">.</span>current<span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>
        <span class="token literal-property property">callback</span><span class="token operator">:</span> handleCallback
      <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
    <span class="token function">handleLoad</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>handleCallback<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> <span class="token operator">&lt;</span>div ref<span class="token operator">=</span><span class="token punctuation">&#123;</span>divRef<span class="token punctuation">&#125;</span> <span class="token operator">/</span><span class="token operator">></span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>It looks like there is no problem, all the dependencies have been fixed, and we can ensure that <code>handleCallback</code> always calls the latest onChange event. Let’s try it out:</p>
<p><img src="https://static.coderbridge.com/img/aszx87410/47ed0b7274e24a039c283c9898a1fdd8.gif"></p>
<p>Oops, it’s not working.</p>
<p>When we change onChange, handleCallback will also change, and then the useEffect section will also be executed again, so <code>grecaptcha.render</code> will be called twice, resulting in this error. Do you remember that I emphasized this earlier? The reason why this problem is more troublesome is that <code>grecaptcha.render</code> can only be called once, so this modification will not work.</p>
<p>Next, I will give you a small test. You can try to open this codesandbox and modify it to see if you can get it right: <a target="_blank" rel="noopener" href="https://codesandbox.io/s/react-hook-change-props-fix-gi10h?file=/src/App.js">https://codesandbox.io/s/react-hook-change-props-fix-gi10h?file=/src/App.js</a></p>
<p>The standard for getting it right is:</p>
<ol>
<li>When you click “click me if you are not robot”, the console will print the old function.</li>
<li>Clicking “change function” will not cause an error.</li>
<li>When you click “click me if you are not robot” again, the console will print the new function.</li>
</ol>
<p>If you achieve these three points, you have succeeded.</p>
<p>I strongly recommend that you try it out on codesandbox immediately, because if you don’t try it out, you may not feel much from the example below. But if you have tried it, you will deeply understand. If you have tried for a while and still haven’t succeeded, you can continue to read the following paragraph, maybe you will find your mistake.</p>
<h2><span id="why-doesnt-your-solution-work">Why doesn’t your solution work?</span></h2><p>First of all, <code>handleLoad</code> can only be called once, so the dependency array in useEffect is definitely an empty array, which is not a problem. And what you need to think about is how to change the callback passed in and <code>handleCallback</code>.</p>
<h3><span id="attempt-1">Attempt 1</span></h3><p>You may have tried this solution, directly changing the dependency of useEffect to an empty array, and leaving everything else unchanged:</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> <span class="token function-variable function">ReCAPTCHA</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">&#123;</span> onChange <span class="token punctuation">&#125;</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">const</span> divRef <span class="token operator">=</span> <span class="token function">useRef</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 當 onChange 改變時，就會產生新的 handleCallback</span>
  <span class="token keyword">const</span> handleCallback <span class="token operator">=</span> <span class="token function">useCallback</span><span class="token punctuation">(</span>
    <span class="token parameter">token</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
      <span class="token function">onChange</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
    <span class="token punctuation">[</span>onChange<span class="token punctuation">]</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">const</span> <span class="token function-variable function">handleLoad</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
      grecaptcha<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span>divRef<span class="token punctuation">.</span>current<span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>
        <span class="token literal-property property">callback</span><span class="token operator">:</span> handleCallback
      <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
    <span class="token function">handleLoad</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> <span class="token operator">&lt;</span>div ref<span class="token operator">=</span><span class="token punctuation">&#123;</span>divRef<span class="token punctuation">&#125;</span> <span class="token operator">/</span><span class="token operator">></span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>It looks reasonable. When onChange changes, I change my handleCallback, and make sure that I can call the latest onChange inside it. Then every time grecaptcha changes, it will call the function I passed in, which is handleCallback, which is very reasonable.</p>
<p>No, you have ignored the mental model emphasized earlier:</p>
<blockquote>
<p>Every time a function component is rendered, the function is “re-called” once.</p>
</blockquote>
<p>I will write the execution order for you to see, please read it in order:</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// 1. 第一次執行，呼叫 ReCAPTCHA(&#123; onChange: oldFunction &#125;)</span>
<span class="token comment">// 5. 第二次執行，呼叫 ReCAPTCHA(&#123; onChange: newFunction &#125;)</span>
<span class="token keyword">const</span> <span class="token function-variable function">ReCAPTCHA</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">&#123;</span> onChange <span class="token punctuation">&#125;</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">const</span> divRef <span class="token operator">=</span> <span class="token function">useRef</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 2. 第一次執行，產生 handleCallback1</span>
  <span class="token comment">// 6. 第二次執行，產生 handleCallback2</span>
  <span class="token comment">// 8. 當 grecaptcha 的 callback 觸發時，會呼叫到的是 handleCallback1</span>
  <span class="token comment">// 而 handleCallback1 裡的 onChange 是 oldFunction</span>
  <span class="token comment">// 因為在建立 handleCallback1 時，傳入的 onChange 是 oldFunction</span>
  <span class="token keyword">const</span> handleCallback <span class="token operator">=</span> <span class="token function">useCallback</span><span class="token punctuation">(</span>
    <span class="token parameter">token</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
      <span class="token function">onChange</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
    <span class="token punctuation">[</span>onChange<span class="token punctuation">]</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 3. 第一次 render，執行這個 function</span>
  <span class="token comment">// 4. 把 grecaptcha 的 callback 設成 handleCallback1</span>
  <span class="token comment">// 7. 第二次 render，不執行這一段</span>
  <span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">const</span> <span class="token function-variable function">handleLoad</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
      grecaptcha<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span>divRef<span class="token punctuation">.</span>current<span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>
        <span class="token literal-property property">callback</span><span class="token operator">:</span> handleCallback
      <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
    <span class="token function">handleLoad</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> <span class="token operator">&lt;</span>div ref<span class="token operator">=</span><span class="token punctuation">&#123;</span>divRef<span class="token punctuation">&#125;</span> <span class="token operator">/</span><span class="token operator">></span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>Or this picture may be easier to understand:</p>
<p><img src="https://static.coderbridge.com/img/aszx87410/7ca5607102a544e4b5095b5f5ab153bd.png"></p>
<p>Each render is a re-call of the function. Your first function call will create a handleCallback, and when props.onChange changes, a new handleCallback will be created, which has the same name but is a different function.</p>
<h3><span id="attempt-2">Attempt 2</span></h3><p>As mentioned earlier, the biggest problem is that “different functions will be generated when onChange changes”, so there must be something “unchanging”.</p>
<p>At this point, you may have a sudden inspiration and think: Isn’t this the time for useRef?</p>
<pre class="line-numbers language-jsx" data-language="jsx"><code class="language-jsx"><span class="token keyword">const</span> <span class="token function-variable function">ReCAPTCHA</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">&#123;</span> onChange <span class="token punctuation">&#125;</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">const</span> divRef <span class="token operator">=</span> <span class="token function">useRef</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> handleCallback <span class="token operator">=</span> <span class="token function">useRef</span><span class="token punctuation">(</span>onChange<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 當 onChange 改變時，去改變 handleCallback.current</span>
  <span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
    handleCallback<span class="token punctuation">.</span>current <span class="token operator">=</span> onChange
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>onChange<span class="token punctuation">]</span><span class="token punctuation">)</span>

  <span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">const</span> <span class="token function-variable function">handleLoad</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
      grecaptcha<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span>divRef<span class="token punctuation">.</span>current<span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>
        <span class="token literal-property property">callback</span><span class="token operator">:</span> handleCallback<span class="token punctuation">.</span>current
      <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
    <span class="token function">handleLoad</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">ref</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">&#123;</span>divRef<span class="token punctuation">&#125;</span></span> <span class="token punctuation">/></span></span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>Pass <code>handleCallback.current</code> to the callback, so that <code>handleCallback.current</code> will be called every time you click, and then I will change <code>handleCallback.current</code> in useEffect along with onChange. It looks very reasonable.</p>
<p>No, it’s still unreasonable. Please see the picture below:</p>
<p><img src="https://static.coderbridge.com/img/aszx87410/6a1e7bfa64a04bcc997235aa493acd71.png"></p>
<p>This is actually a “reassignment” problem. Let’s first consider <code>handleCallback.current</code> as a variable A. In the first render, we set the callback to A at line 13. Then in the second render, we execute: <code>handleCallback.current = newFunction</code>, which means <code>A = newFunction</code>. We have reassigned A, but the original binding to the callback is still the original A and will not change just because you have reassigned A.</p>
<h2><span id="attempt-three">Attempt Three</span></h2><p>At this point, you may think that since the problem seems to be with directly attaching <code>handleCallback.current</code> to the callback, why not declare another function:</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> <span class="token function-variable function">ReCAPTCHA</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">&#123;</span> onChange <span class="token punctuation">&#125;</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">const</span> divRef <span class="token operator">=</span> <span class="token function">useRef</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> cbRef <span class="token operator">=</span> <span class="token function">useRef</span><span class="token punctuation">(</span>onChange<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> <span class="token function-variable function">handleCallback</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
    cbRef<span class="token punctuation">.</span><span class="token function">current</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">&#125;</span> 

  <span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
    cbRef<span class="token punctuation">.</span>current <span class="token operator">=</span> onChange
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>onChange<span class="token punctuation">]</span><span class="token punctuation">)</span>

  <span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">const</span> <span class="token function-variable function">handleLoad</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
      grecaptcha<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span>divRef<span class="token punctuation">.</span>current<span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>
        <span class="token literal-property property">callback</span><span class="token operator">:</span> handleCallback
      <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
    <span class="token function">handleLoad</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> <span class="token operator">&lt;</span>div ref<span class="token operator">=</span><span class="token punctuation">&#123;</span>divRef<span class="token punctuation">&#125;</span> <span class="token operator">/</span><span class="token operator">></span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>Every time you click, it will call <code>handleCallback</code> and then call <code>cbRef.current()</code>. Whenever <code>onChange</code> changes, I will change <code>cbRef.current</code>, which is perfect.</p>
<p>Yes, you did it! And <code>handleCallback</code> can actually be wrapped in <code>useCallback</code>, so that a new <code>handleCallback</code> is not generated every time it is rendered.</p>
<p>Or even better, you don’t even need to declare a function, just use an arrow function:</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> <span class="token function-variable function">ReCAPTCHA</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">&#123;</span> onChange <span class="token punctuation">&#125;</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">const</span> divRef <span class="token operator">=</span> <span class="token function">useRef</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> cbRef <span class="token operator">=</span> <span class="token function">useRef</span><span class="token punctuation">(</span>onChange<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
    cbRef<span class="token punctuation">.</span>current <span class="token operator">=</span> onChange
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>onChange<span class="token punctuation">]</span><span class="token punctuation">)</span>

  <span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">const</span> <span class="token function-variable function">handleLoad</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
      grecaptcha<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span>divRef<span class="token punctuation">.</span>current<span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>
        <span class="token function-variable function">callback</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
          cbRef<span class="token punctuation">.</span><span class="token function">current</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">&#125;</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
    <span class="token function">handleLoad</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> <span class="token operator">&lt;</span>div ref<span class="token operator">=</span><span class="token punctuation">&#123;</span>divRef<span class="token punctuation">&#125;</span> <span class="token operator">/</span><span class="token operator">></span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>The final code looks like this, and you can play with it yourself: <a target="_blank" rel="noopener" href="https://codesandbox.io/s/react-hook-change-props-solution-ll8os?file=/src/App.js">https://codesandbox.io/s/react-hook-change-props-solution-ll8os?file=/src/App.js</a></p>
<h2><span id="review-and-reflection">Review and Reflection</span></h2><p>After going through so many rounds, we finally found a solution. But why didn’t I encounter this problem when I was writing class components before? Because we can always use <code>this.props.onChange</code> to get the latest properties.</p>
<p>But function components are not like this. Each render is a function call, and the props passed in will be the “current” props, and will not change because the props change. This is the biggest difference between function components and class components.</p>
<p>I used to not really understand what Dan meant when he said, “Only by abandoning class components can you truly understand hooks.” But now I understand. When writing class components before, you would think about what to do in each lifecycle, such as “what to do in didMount” and “what to do when updating”. But the focus of hooks is on “every render”.</p>
<p>Class components think in terms of class instances, while hooks think in terms of functions. When writing classes before, you only knew that the <code>render</code> method would be executed every time, and other lifecycles would not.</p>
<p>But function components are “every render will execute the entire function again”, which is very different. Finally, I emphasize this point again:</p>
<blockquote>
<p>Every render of a function component is a new function call.</p>
</blockquote>
<h2><span id="summary">Summary</span></h2><p>Although React hooks seem easy to get started with and have less code, I think the case I mentioned today does not make hooks easier to use in practice, and to some extent, it makes it easier for beginners to write bugs. Or more precisely, the places where bugs occur are different.</p>
<p>When writing classes before, the first obstacle for beginners was understanding <code>this</code>, and the second obstacle was that <code>props</code> and <code>state</code> always got the “latest” instead of the original. The obstacle of function components is closure. If you don’t have the correct mental model, it’s easy to get lost in hooks, after all, writing class components and function components are really different.</p>
<p>I originally thought that switching from class to function was just a different way of writing, but I didn’t expect to change the entire thinking mode, and I sincerely admire the members of the React team, who have brought new things to the front-end field time and time again.</p>
<p>I highly recommend reading Dan’s article on the differences between function components and class components. It’s really great. You can start with this one: <a target="_blank" rel="noopener" href="https://overreacted.io/how-are-function-components-different-from-classes/">How Are Function Components Different from Classes?</a> to understand the differences, and then read this one: <a target="_blank" rel="noopener" href="https://overreacted.io/a-complete-guide-to-useeffect/">A Complete Guide to useEffect</a> to understand <code>useEffect</code>. After reading it, you will have a better understanding of the example I mentioned in this article, and you may even think, “Hey? What are you talking about? Isn’t this very basic?”</p>
<p>The article is almost finished here, and there happens to be a practical case to share while learning hooks.</p>
<p>Finally, special thanks to the front-end colleagues at <a target="_blank" rel="noopener" href="https://www.yourator.co/companies/AIFinancialTechnology">Onedegree</a> for discussing this issue with me.</p>

    
    </div>
    
    <div class="columns is-variable is-1 is-multiline is-mobile">
    
        <span class="column is-narrow"><a class="tag is-light article-tag" href="/en/tags/React/">#React</a></span>
    
        <span class="column is-narrow"><a class="tag is-light article-tag" href="/en/tags/Front-end/">#Front-end</a></span>
    
    </div>
    
    
    <div class="columns is-mobile is-multiline article-nav">
        <span class="column is-12-mobile is-half-desktop  article-nav-prev">
            
            <a href="/2020/07/11/en/an-interesting-styled-components-bug/">An interesting styled components bug</a>
            
        </span>
        <span class="column is-12-mobile is-half-desktop  article-nav-next">
            
            <a href="/2020/05/16/en/introduction-to-regular-expression/">A Simple Guide to Regular Expressions</a>
            
        </span>
    </div>
    
</article>




<div class="comments">
    <h3 class="title is-4">Comments</h3>
    <script src="https://utteranc.es/client.js"
        repo="aszx87410/huli-blog"
        issue-term="title"
        theme="github-light"
        crossorigin="anonymous"
        async>
</script>
</div>

    </div>
</section>
    <footer class="footer">
    <div class="container">
        <div class="columns content">
            <div class="column is-narrow has-text-centered">
                &copy; 2024 Huli&nbsp;
                Powered by <a href="http://hexo.io/" target="_blank">Hexo</a> & <a
                        target="_blank" rel="noopener" href="http://github.com/ppoffice/hexo-theme-minos">Minos</a>
            </div>
            <div class="column is-hidden-mobile"></div>

            
            <div class="column is-narrow">
                <div class="columns is-mobile is-multiline is-centered">
                
                    
                <a class="column is-narrow" title="GitHub" target="_blank" rel="noopener" href="https://github.com/ppoffice/hexo-theme-minos">
                    
                    GitHub
                    
                </a>
                
                </div>
            </div>
            
            
<div class="column is-narrow has-text-centered">
    <div class="dropdown is-up is-right is-hoverable" style="margin-top: -0.2em;">
        <div class="dropdown-trigger">
            <button class="button is-small" aria-haspopup="true">
                <span class="icon">
                    <i class="fas fa-globe"></i>
                </span>
                <span>English</span>
                <span class="icon is-small">
            <i class="fas fa-angle-down" aria-hidden="true"></i>
          </span>
            </button>
        </div>
        <div class="dropdown-menu has-text-left" role="menu" style="top:100%">
            <div class="dropdown-content">
            <!-- NOTE: 永遠回到首頁 -->
            
                <a href="/2020/06/15/react-function-class-hook-useeffect/" class="dropdown-item">
                    繁體中文
                </a>
            
            </div>
        </div>
    </div>
</div>

        </div>
    </div>
</footer>
    <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/3.6.3/jquery.min.js"></script>



    
    
    
    
    
    
<script src="//cdnjs.cloudflare.com/ajax/libs/lightgallery/1.6.8/js/lightgallery-all.min.js"></script>
<script>
    (function ($) {
        $(document).ready(function () {
            if (typeof($.fn.lightGallery) === 'function') {
                $('.article.gallery').lightGallery({ selector: '.gallery-item' });
            }
        });
    })(jQuery);
</script>

    
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.0/clipboard.min.js"></script>
    <style>
        .hljs {
            position: relative;
        }

        .hljs .clipboard-btn {
            float: right;
            color: #9a9a9a;
            background: none;
            border: none;
            cursor: pointer;
        }

        .hljs .clipboard-btn:hover {
          color: #8a8a8a;
        }

        .hljs > .clipboard-btn {
            display: none;
            position: absolute;
            right: 4px;
            top: 4px;
        }

        .hljs:hover > .clipboard-btn {
            display: inline;
        }

        .hljs > figcaption > .clipboard-btn {
            margin-right: 4px;
        }
    </style>
    <script>
      $(document).ready(function () {
        $('figure.hljs').each(function(i, figure) {
          var codeId = 'code-' + i;
          var code = figure.querySelector('.code');
          var copyButton = $('<button>Copy <i class="far fa-clipboard"></i></button>');
          code.id = codeId;
          copyButton.addClass('clipboard-btn');
          copyButton.attr('data-clipboard-target-id', codeId);

          var figcaption = figure.querySelector('figcaption');

          if (figcaption) {
            figcaption.append(copyButton[0]);
          } else {
            figure.prepend(copyButton[0]);
          }
        })

        var clipboard = new ClipboardJS('.clipboard-btn', {
          target: function(trigger) {
            return document.getElementById(trigger.getAttribute('data-clipboard-target-id'));
          }
        });
        clipboard.on('success', function(e) {
          e.clearSelection();
        })
      })
    </script>

    
    

    



<script src="/js/script.js?v=3.js"></script>


    
</body>
</html>