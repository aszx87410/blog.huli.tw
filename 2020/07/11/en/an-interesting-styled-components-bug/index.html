<!DOCTYPE html>
<html class="has-navbar-fixed-top" lang="en">
<head>
    <meta charset="utf-8">
<title>An interesting styled components bug - Huli&#39;s blog</title>
<meta name="viewport" content="width=device-width, initial-scale=1">


<link href="https://blog.huli.tw/2020/07/11/en/an-interesting-styled-components-bug/" rel="alternate" hreflang="en" />


<link href="https://blog.huli.tw/2020/07/11/an-interesting-styled-components-bug/" rel="alternate" hreflang="x-default" />


            
<link href="https://blog.huli.tw/2020/07/11/an-interesting-styled-components-bug/" rel="alternate" hreflang="zh-TW" />
            





    
<link rel="canonical" href="https://blog.huli.tw/2020/07/11/en/an-interesting-styled-components-bug/">
    





    <meta name="description" content="IntroductionWhile making some performance adjustments at work, I accidentally discovered a strange phenomenon. After investigating further, I found a bug that seemed to have gone unnoticed by anyone,">
<meta property="og:type" content="article">
<meta property="og:title" content="An interesting styled components bug">
<meta property="og:url" content="https://blog.huli.tw/2020/07/11/en/an-interesting-styled-components-bug/index.html">
<meta property="og:site_name" content="Huli&#39;s blog">
<meta property="og:description" content="IntroductionWhile making some performance adjustments at work, I accidentally discovered a strange phenomenon. After investigating further, I found a bug that seemed to have gone unnoticed by anyone,">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://blog.huli.tw/img/an-interesting-styled-components-bug/cover-en.png">
<meta property="article:published_time" content="2020-07-11T07:06:54.000Z">
<meta property="article:modified_time" content="2024-02-18T05:48:41.952Z">
<meta property="article:author" content="Huli">
<meta property="article:tag" content="Front-end">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://blog.huli.tw/img/an-interesting-styled-components-bug/cover-en.png">



<link rel="alternative" href="/atom.xml" title="An interesting styled components bug" type="application/atom+xml">



<link rel="icon" href="/img/lidemy_logo.png">


<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Ovo|Source+Code+Pro">


<link rel="stylesheet" href="/css/bulma.css?v=2.css">



<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/lightgallery/1.6.8/css/lightgallery.min.css">


<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/line-numbers/prism-line-numbers.min.css" />


<link rel="stylesheet" href="/css/style.css?v=4.css">





    
    
    
    
    
    
    
    
    
    
<script async src="https://www.googletagmanager.com/gtag/js?id=G-1393J2EVCZ"></script>
<script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-1393J2EVCZ');
</script>


    


<meta name="generator" content="Hexo 6.3.0"></head>
<body>
    <script>
        if (localStorage.getItem('dark-mode')) {
            if (localStorage.getItem('dark-mode') === 'true') {
                document.body.classList.add('dark-mode')
            }
        } else {
            if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                document.body.classList.add('dark-mode')
            }
        }
    </script>
    
<nav class="navbar is-transparent is-fixed-top navbar-main" role="navigation" aria-label="main navigation">
    <div class="container">
        <div class="navbar-brand">
            <a class="navbar-item navbar-logo" href="/en">
                
                    
                    Huli&#39;s blog
                    
                
            </a>
            <div class="navbar-burger">
                <span></span>
                <span></span>
                <span></span>
            </div>
        </div>
        
        <div class="navbar-menu navbar-start">
            
            <a class="navbar-item "
               href="/en/archives">Archive</a>
            
            <a class="navbar-item "
               href="/en/categories">Categories</a>
            
            <a class="navbar-item "
               href="/en/about">About</a>
            
        </div>
        
        <div class="navbar-menu navbar-end">
            
            
            <div class="navbar-item is-hoverable has-dropdown is-hidden-mobile is-hidden-tablet-only toc">
                <a class="navbar-item" title="Table of Contents">
                    Table of Contents
                </a>
                <div class="navbar-dropdown">
                    
                    
                    
                    
                    <a class="navbar-item" href="#introduction">1&nbsp;&nbsp;<b>Introduction</b></a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#the-beginning-of-the-story">2&nbsp;&nbsp;<b>The Beginning of the Story</b></a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#removing-extra-prefixes">3&nbsp;&nbsp;<b>Removing Extra Prefixes</b></a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#results">4&nbsp;&nbsp;<b>Results</b></a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#what-about-the-bug">5&nbsp;&nbsp;<b>What about the bug?</b></a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#follow-up">6&nbsp;&nbsp;<b>Follow-up</b></a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#summary">7&nbsp;&nbsp;<b>Summary</b></a>
                    
                </div>
            </div>
            
            
            <a class="navbar-item" target="_blank" title="Twitter" href="https://twitter.com/aszx87410">
                
                <i class="fab fa-twitter"></i>
                
            </a>
               
            <a class="navbar-item" target="_blank" title="RSS" href="/atom-en.xml">
                
                <i class="fas fa-rss"></i>
                
            </a>
               
            
            <a class="navbar-item btn-dark-mode" title="dark-mode" href="#">
                <div>
                    <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" width="15" height="15" viewBox="0 0 256 256" xml:space="preserve">
                    <defs>
                    </defs>
                    <g style="stroke: none; stroke-width: 0; stroke-dasharray: none; stroke-linecap: butt; stroke-linejoin: miter; stroke-miterlimit: 10; fill: none; fill-rule: nonzero; opacity: 1;" transform="translate(1.4065934065934016 1.4065934065934016) scale(2.81 2.81)" >
                        <path d="M 87.823 60.7 c -0.463 -0.423 -1.142 -0.506 -1.695 -0.214 c -15.834 8.398 -35.266 2.812 -44.232 -12.718 c -8.966 -15.53 -4.09 -35.149 11.101 -44.665 c 0.531 -0.332 0.796 -0.963 0.661 -1.574 c -0.134 -0.612 -0.638 -1.074 -1.259 -1.153 c -9.843 -1.265 -19.59 0.692 -28.193 5.66 C 13.8 12.041 6.356 21.743 3.246 33.35 S 1.732 57.08 7.741 67.487 c 6.008 10.407 15.709 17.851 27.316 20.961 C 38.933 89.486 42.866 90 46.774 90 c 7.795 0 15.489 -2.044 22.42 -6.046 c 8.601 -4.966 15.171 -12.43 18.997 -21.586 C 88.433 61.79 88.285 61.123 87.823 60.7 z" style="stroke: none; stroke-width: 1; stroke-dasharray: none; stroke-linecap: butt; stroke-linejoin: miter; stroke-miterlimit: 10; fill: #ffa716; fill-rule: nonzero; opacity: 1;" transform=" matrix(1 0 0 1 0 0) " stroke-linecap="round" />
                    </g>
                    </svg>
                </div>
            </a>
            
               <a class="navbar-item" href="/2020/07/11/an-interesting-styled-components-bug/">中文</a>
            
            

        </div>
    </div>
</nav>

    <section class="section">
    <div class="container">
      
      <div data-nosnippet class="self-notice">
        If you have any thoughts on my blog or articles and you want to let me know, you can either post a comment below(public) or tell me via this <a href="https://forms.gle/SjJZ4cnNs6NnjXQG8" target="_blank">feedback form</a>
      </div>
      
    <article class="article content gallery" itemscope itemprop="blogPost">
    <h1 class="article-title is-size-3 is-size-4-mobile" itemprop="name">
        
            An interesting styled components bug
        
    </h1>
    <div class="article-meta columns is-variable is-1 is-multiline is-mobile is-size-7-mobile">
        <span class="column is-narrow">
            <time datetime="2020-07-11T07:06:54.000Z" itemprop="datePublished">11 July 2020</time>
        </span>
        
        <span class="column is-narrow article-category">
            <i class="far fa-folder"></i>
            <a class="article-category-link" href="/en/categories/Front-end/">Front-end</a>
        </span>
        
        
        
        <spen data-nosnippet class="column is-narrow">(Translated by ChatGPT)</span>
        
    </div>
    
    <div class="article-entry is-size-6-mobile" itemprop="articleBody">
    
        <h2><span id="introduction">Introduction</span></h2><p>While making some performance adjustments at work, I accidentally discovered a strange phenomenon. After investigating further, I found a bug that seemed to have gone unnoticed by anyone, and I found the cause quite interesting. So I thought I’d write a post to share it with everyone.</p>
<p>This post is not very technical, so you can read it with a story-telling mindset, which will make it more interesting.</p>
<h2><span id="the-beginning-of-the-story">The Beginning of the Story</span></h2><p>The origin of the story is that I was making some adjustments to a website at work, trying to improve its loading speed. When it comes to performance optimization, there are many things that can be done. For example, with regard to the server, the following are more relevant:</p>
<ol>
<li>Use HTTP&#x2F;2</li>
<li>Use gzip or brotli for compression</li>
<li>Use Cache (to speed up revisits)</li>
<li>Use CDN</li>
<li>Reduce TTFB time</li>
</ol>
<p>However, all of the above require assistance from the backend or SRE, and are not very relevant to the frontend. With regard to the frontend, there are many aspects to consider. For example, from the perspective of “reducing resources,” the following can be done:</p>
<ol>
<li>Image format adjustment (compression + webp or other formats)</li>
<li>JS size (ugligy, code splitting, dynamic import)</li>
<li>CSS size (minify, remove unnecessary CSS)</li>
</ol>
<p>From the perspective of “accelerating the loading of important resources,” preload or preconnect hints can be added to indicate to the browser which things should be loaded first.</p>
<p>You can also look at it from the perspective of “reducing JS execution time.” For example, if you are writing React, you can use shouldComponentUpdate, PureComponent, or memo to reduce unnecessary re-renders.</p>
<p>Since the title of this post is “styled components,” the main topic is, of course, centered around CSS.</p>
<span id="more"></span>

<p>In the CSS part, in order to reduce the first loading time, one trick is to inline critical CSS in the HTML, so that you don’t have to make another request to get the CSS back, which saves one round-trip. However, this will also affect the size of the HTML, but not by much.</p>
<p>Anyway, we used this trick on our website and inline CSS in the HTML, which looks like this:</p>
<p><img src="/img/sc/css1.png" alt="css1"></p>
<p>A lot of dense CSS.</p>
<p>And what caught my attention the most were those vendor prefixes:</p>
<p><img src="/img/sc/css2.png" alt="css1"></p>
<p>Due to various historical factors, some CSS properties need to be prefixed to work. For example, if you want to use flexbox on an older version of IE, you need to write: <code>display: -ms-flexbox;</code>. And I looked at the prefixes we have on our website, which are probably:</p>
<ol>
<li>display: -ms-flexbox</li>
<li>display: -webkit-flex</li>
<li>-ms-flex-wrap: wrap</li>
<li>-webkit-flex-wrap: wrap</li>
<li>-ms-transform: rotate(45deg)</li>
<li>-webkit-transform: rotate(45deg)</li>
<li>-ms-letter-spacing: 0.03em</li>
<li>-webkit-letter-spacing: 0.03em</li>
<li>….more</li>
</ol>
<p>These prefixes are all added by styled components. Here’s a brief introduction to styled components. In short, you can use this syntax to add CSS to a component:</p>
<pre class="line-numbers language-jsx" data-language="jsx"><code class="language-jsx"><span class="token keyword">import</span> styled <span class="token keyword">from</span> <span class="token string">'styled-components'</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> Box <span class="token operator">=</span> styled<span class="token punctuation">.</span>div<span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
  background: red;
</span><span class="token template-punctuation string">`</span></span>
<span class="token comment">// use it like this</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Box</span></span> <span class="token punctuation">/></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>The principle behind it is that styled components will convert the style you write into a className and put it on the component for you. Vendor prefixes are also part of what it handles.</p>
<p>Everything seems fine, but there is room for improvement.</p>
<p>In our project, we have already determined the level of browser support, and we don’t need to support IE. Since we don’t need to support IE, many prefixes starting with <code>-ms</code> are not necessary, and removing them will save space, so it’s better to remove them.</p>
<p>But how do we remove them?</p>
<h2><span id="removing-extra-prefixes">Removing Extra Prefixes</span></h2><p>For this need to add the correct prefix to CSS, there is a well-known tool called <a target="_blank" rel="noopener" href="https://github.com/postcss/autoprefixer">Autoprefixer</a>:</p>
<p><img src="/img/sc/autoprefixer.png" alt="autoprefixer"></p>
<p>This tool is very simple. You just need to give it your entire CSS, and it will help you convert it into the correct form, which means:</p>
<ol>
<li>Add necessary prefixes</li>
<li>Remove unnecessary prefixes</li>
</ol>
<p>How does it know what is necessary?</p>
<p>This is the best part. It supports something called <a target="_blank" rel="noopener" href="https://github.com/browserslist/browserslist">Browserslist</a>. Simply put, you can write a file that specifies which browsers your project needs to support, like this:</p>
<pre class="line-numbers language-none"><code class="language-none"># Browsers that we support

defaults
not IE 11
not IE_Mob 11
&gt; 1%<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>You can also use syntax like <code>&gt; 1%</code> to let it grab the usage rate of browsers that are used more than 1% and add them to the list. So with this list and Autoprefixer, you can generate streamlined CSS and remove unnecessary vendor prefixes.</p>
<p>How do you use this tool with styled components?</p>
<p>In styled components, there is something called StyleSheetManager, which added two parameters in v5:</p>
<ol>
<li>disableVendorPrefixes</li>
<li>stylisPlugins</li>
</ol>
<p>The first parameter removes all vendor prefixes, so it won’t automatically add them:</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// example from official docs</span>
<span class="token keyword">import</span> styled<span class="token punctuation">,</span> <span class="token punctuation">&#123;</span> StyleSheetManager <span class="token punctuation">&#125;</span> <span class="token keyword">from</span> <span class="token string">'styled-components'</span>

<span class="token keyword">const</span> Box <span class="token operator">=</span> styled<span class="token punctuation">.</span>div<span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
  color: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span><span class="token parameter">props</span> <span class="token operator">=></span> props<span class="token punctuation">.</span>theme<span class="token punctuation">.</span>color<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">;
  display: flex;
</span><span class="token template-punctuation string">`</span></span>

<span class="token function">render</span><span class="token punctuation">(</span>
  <span class="token operator">&lt;</span>StyleSheetManager disableVendorPrefixes<span class="token operator">></span>
    <span class="token operator">&lt;</span>Box<span class="token operator">></span>If you inspect me<span class="token punctuation">,</span> there are no vendor prefixes <span class="token keyword">for</span> the flexbox style<span class="token punctuation">.</span><span class="token operator">&lt;</span><span class="token operator">/</span>Box<span class="token operator">></span>
  <span class="token operator">&lt;</span><span class="token operator">/</span>StyleSheetManager<span class="token operator">></span>
<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>The second parameter <code>stylisPlugins</code> is actually the key point. The official example is like this:</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">import</span> styled<span class="token punctuation">,</span> <span class="token punctuation">&#123;</span> StyleSheetManager <span class="token punctuation">&#125;</span> <span class="token keyword">from</span> <span class="token string">'styled-components'</span>
<span class="token keyword">import</span> stylisRTLPlugin <span class="token keyword">from</span> <span class="token string">'stylis-plugin-rtl'</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> Box <span class="token operator">=</span> styled<span class="token punctuation">.</span>div<span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
  background: mediumseagreen;
  border-left: 10px solid red;
</span><span class="token template-punctuation string">`</span></span>

<span class="token function">render</span><span class="token punctuation">(</span>
  <span class="token operator">&lt;</span>StyleSheetManager stylisPlugins<span class="token operator">=</span><span class="token punctuation">&#123;</span><span class="token punctuation">[</span>stylisRTLPlugin<span class="token punctuation">]</span><span class="token punctuation">&#125;</span><span class="token operator">></span>
    <span class="token operator">&lt;</span>Box<span class="token operator">></span>My border is now on the right<span class="token operator">!</span><span class="token operator">&lt;</span><span class="token operator">/</span>Box<span class="token operator">></span>
  <span class="token operator">&lt;</span><span class="token operator">/</span>StyleSheetManager<span class="token operator">></span>
<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>Simply put, styled components use a package called stylis in the underlying layer, and this package can pass custom plugins to do some conversion. It sounds like a very promising approach, but the official documentation doesn’t cover it much. So I went to study the code of styled components and found out how to write this plugin by looking at <a target="_blank" rel="noopener" href="https://github.com/styled-components/styled-components/blob/master/packages/styled-components/src/utils/stylis.js#L69">this section</a>:</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">/**
 * When writing a style like
 *
 * &amp; + &amp; &#123;
 *   color: red;
 * &#125;
 *
 * The second ampersand should be a reference to the static component class. stylis
 * has no knowledge of static class so we have to intelligently replace the base selector.
 *
 * https://github.com/thysultan/stylis.js#plugins &lt;- more info about the context phase values
 * "2" means this plugin is taking effect at the very end after all other processing is complete
 */</span>
<span class="token keyword">const</span> <span class="token function-variable function">selfReferenceReplacementPlugin</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">context<span class="token punctuation">,</span> _<span class="token punctuation">,</span> selectors</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>context <span class="token operator">===</span> <span class="token number">2</span> <span class="token operator">&amp;&amp;</span> selectors<span class="token punctuation">.</span>length <span class="token operator">&amp;&amp;</span> selectors<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">lastIndexOf</span><span class="token punctuation">(</span>_selector<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// eslint-disable-next-line no-param-reassign</span>
    selectors<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> selectors<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>_selectorRegexp<span class="token punctuation">,</span> selfReferenceReplacer<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>However, the link attached inside doesn’t seem to have any information related to the plugin… So I turned to study the package that appeared in the example: <a target="_blank" rel="noopener" href="https://github.com/styled-components/stylis-plugin-rtl/blob/master/src/stylis-rtl.js">stylis-plugin-rtl</a>, and its source code is much more detailed:</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// @flow</span>

<span class="token keyword">import</span> cssjanus <span class="token keyword">from</span> <span class="token string">"cssjanus"</span><span class="token punctuation">;</span>

<span class="token comment">// https://github.com/thysultan/stylis.js#plugins</span>
<span class="token keyword">const</span> <span class="token constant">STYLIS_CONTEXTS</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
  <span class="token constant">POST_PROCESS</span><span class="token operator">:</span> <span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">,</span>
  <span class="token constant">PREPARATION</span><span class="token operator">:</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>
  <span class="token constant">NEWLINE</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
  <span class="token constant">PROPERTY</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
  <span class="token constant">SELECTOR_BLOCK</span><span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
  <span class="token constant">AT_RULE</span><span class="token operator">:</span> <span class="token number">3</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> type StylisContextType <span class="token operator">=</span> $Values<span class="token operator">&lt;</span><span class="token keyword">typeof</span> <span class="token constant">STYLIS_CONTEXTS</span><span class="token operator">></span><span class="token punctuation">;</span>

<span class="token comment">// We need to apply cssjanus as early as possible to capture the noflip directives if used</span>
<span class="token comment">// (they are not present at the PROPERTY, SELECTOR_BLOCK, or POST_PROCESS steps)</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token constant">STYLIS_PROPERTY_CONTEXT</span> <span class="token operator">=</span> <span class="token constant">STYLIS_CONTEXTS</span><span class="token punctuation">.</span><span class="token constant">PREPARATION</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">stylisRTLPlugin</span><span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">context</span><span class="token operator">:</span> StylisContextType<span class="token punctuation">,</span> <span class="token literal-property property">content</span><span class="token operator">:</span> string</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token operator">?</span>string <span class="token punctuation">&#123;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>context <span class="token operator">===</span> <span class="token constant">STYLIS_PROPERTY_CONTEXT</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> cssjanus<span class="token punctuation">.</span><span class="token function">transform</span><span class="token punctuation">(</span>content<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">// stable identifier that will not be dropped by minification unless the whole module</span>
<span class="token comment">// is unused</span>
<span class="token comment">/*#__PURE__*/</span>
Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>stylisRTLPlugin<span class="token punctuation">,</span> <span class="token string">"name"</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span> <span class="token literal-property property">value</span><span class="token operator">:</span> <span class="token string">"stylisRTLPlugin"</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> stylisRTLPlugin<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>I have seen similar plugin writing methods before, so I can quickly get into the situation. Stylis will provide you with several different contexts and contents. You can decide what to do based on the context and pass back the processed style.</p>
<p>Therefore, our plugin can be written like this:</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">import</span> autoprefixer <span class="token keyword">from</span> <span class="token string">'autoprefixer'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> postcss <span class="token keyword">from</span> <span class="token string">'postcss'</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token constant">POST_PROCESS_CONTEXT</span> <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">;</span>
<span class="token keyword">function</span> <span class="token function">plugin</span> <span class="token punctuation">(</span><span class="token parameter">context<span class="token punctuation">,</span> content</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>context <span class="token operator">!==</span> <span class="token constant">POST_PROCESS_CONTEXT</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">return</span> content<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">return</span> <span class="token function">postcss</span><span class="token punctuation">(</span><span class="token punctuation">[</span>autoprefixer<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">process</span><span class="token punctuation">(</span>content<span class="token punctuation">)</span><span class="token punctuation">.</span>css<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>Call postcss in the post process stage, and use autoprefixer to convert the content. Finally, you can get clean CSS.</p>
<h2><span id="results">Results</span></h2><p>Here’s how effective it is. Before using it, I counted the number of prefixes in the CSS (directly using global search):</p>
<ul>
<li>-webkit: ~300</li>
<li>-ms: ~200</li>
<li>-moz: ~60</li>
<li>-o: 1</li>
</ul>
<p>A total of about 560.</p>
<p>After using Autoprefixer, it becomes:</p>
<ul>
<li>-webkit: ~300 &#x3D;&gt; 26</li>
<li>-ms: ~200 &#x3D;&gt; 6</li>
<li>-moz: ~60 &#x3D;&gt; 13</li>
<li>-o: 1 &#x3D;&gt; 0</li>
</ul>
<p>From 560 to about 45, reducing about 90% of unnecessary vendor prefixes!</p>
<p>The size of the entire HTML + inline CSS was 43KB after gzip compression before. You can guess how much it became after making this change.</p>
<p>.<br>.<br>.<br>.<br>.<br>.<br>.<br>.<br>.<br>.<br>.<br>.<br>.  </p>
<p>The answer is: 42KB!</p>
<p>Yes, you read that right, it only reduced by 1KB.</p>
<p>When I saw this result, I learned two things:</p>
<ol>
<li>gzip is powerful</li>
<li>Optimization needs to be measured. Sometimes you think you have improved a lot, but you haven’t</li>
</ol>
<p>I guess the reason why it only reduced by 1KB is that after gzip, there is actually not much difference. Although the number of prefixes has been greatly reduced, it won’t really save that much space. The information remembered by gzip may have changed from “300 webkits” to “26 webkits”, but it’s just a reduction in the number, so there is no improvement in file size.</p>
<p>Although the file size has not been reduced much, there are still some improvements. The task has been successfully completed.</p>
<h2><span id="what-about-the-bug">What about the bug?</span></h2><p>Okay, you might be thinking at this point: “I learned a trick… wait, isn’t this article about bugs? Where’s the bug? Why didn’t I see anything that looks like a bug?”</p>
<p>In fact, the bug is hidden in a list I compiled earlier:</p>
<ol>
<li>display: -ms-flexbox</li>
<li>display: -webkit-flex</li>
<li>-ms-flex-wrap: wrap</li>
<li>-webkit-flex-wrap: wrap</li>
<li>-ms-transform: rotate(45deg)</li>
<li>-webkit-transform: rotate(45deg)</li>
<li>-ms-letter-spacing: 0.03em</li>
<li>-webkit-letter-spacing: 0.03em</li>
<li>….more</li>
</ol>
<p>If you look closely, you will notice a strange property called <code>letter-spacing</code>. When I first saw it, I thought I was not skilled enough. After all, I’ve been writing CSS for so many years, and I didn’t know that <code>letter-spacing</code> needed a prefix to work. So I went to caniuse to check it out and found that, as I remembered, it didn’t need one.</p>
<p>So why is it here?</p>
<p>Out of curiosity, I looked at the source code of stylis. By the way, I mentioned earlier that there was no introduction to the plugin in the styled components source code link, which was due to version issues. Stylis was updated to v4 in April 2020, while styled components used v3.5.4.</p>
<p>To be more precise, styled components actually depends on <code>@emotion/stylis v0.8.4</code> (yes, another library called emotion), and this emotion’s stylis depends on the real stylis 3.5.4 version.</p>
<p>So this letter-spacing issue is not just with styled components, but also with emotion. Here’s a demo on codesandbox: <a target="_blank" rel="noopener" href="https://codesandbox.io/s/stylis-bug-6yu6g?file=/src/App.js">https://codesandbox.io/s/stylis-bug-6yu6g?file=/src/App.js</a></p>
<p>When you open it and right-click on the element above, you can see:</p>
<p><img src="/img/sc/code.png" alt="code"></p>
<p>Now that I know it was a version issue, I can find the correct version of the source code to look at, which is a very large file: <a target="_blank" rel="noopener" href="https://github.com/thysultan/stylis.js/blob/v3.5.4/stylis.js">https://github.com/thysultan/stylis.js/blob/v3.5.4/stylis.js</a></p>
<p>I extracted the most essential part, the vendor-prefixed part (with some code omitted):</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">property</span> <span class="token punctuation">(</span><span class="token parameter">input<span class="token punctuation">,</span> first<span class="token punctuation">,</span> second<span class="token punctuation">,</span> third</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">var</span> index <span class="token operator">=</span> <span class="token number">0</span>
  <span class="token keyword">var</span> out <span class="token operator">=</span> input <span class="token operator">+</span> <span class="token string">';'</span>
  <span class="token keyword">var</span> hash <span class="token operator">=</span> <span class="token punctuation">(</span>first<span class="token operator">*</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span>second<span class="token operator">*</span><span class="token number">3</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span>third<span class="token operator">*</span><span class="token number">4</span><span class="token punctuation">)</span>
  <span class="token keyword">var</span> cache

  <span class="token comment">// animation: a, n, i characters</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>hash <span class="token operator">===</span> <span class="token number">944</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> <span class="token function">animation</span><span class="token punctuation">(</span>out<span class="token punctuation">)</span>
  <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>prefix <span class="token operator">===</span> <span class="token number">0</span> <span class="token operator">||</span> <span class="token punctuation">(</span>prefix <span class="token operator">===</span> <span class="token number">2</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">vendor</span><span class="token punctuation">(</span>out<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> out
  <span class="token punctuation">&#125;</span>

  <span class="token comment">// vendor prefix</span>
  <span class="token keyword">switch</span> <span class="token punctuation">(</span>hash<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// text-decoration/text-size-adjust/text-shadow/text-align/text-transform: t, e, x</span>
    <span class="token keyword">case</span> <span class="token number">1015</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
      <span class="token comment">// text-shadow/text-align/text-transform, a</span>
      <span class="token keyword">return</span> out<span class="token punctuation">.</span><span class="token function">charCodeAt</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token number">97</span> <span class="token operator">?</span> webkit <span class="token operator">+</span> out <span class="token operator">+</span> out <span class="token operator">:</span> out
    <span class="token punctuation">&#125;</span>
    <span class="token comment">// filter/fill f, i, l</span>
    <span class="token keyword">case</span> <span class="token number">951</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
      <span class="token comment">// filter, t</span>
      <span class="token keyword">return</span> out<span class="token punctuation">.</span><span class="token function">charCodeAt</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token number">116</span> <span class="token operator">?</span> webkit <span class="token operator">+</span> out <span class="token operator">+</span> out <span class="token operator">:</span> out
    <span class="token punctuation">&#125;</span>
    <span class="token comment">// color/column, c, o, l</span>
    <span class="token keyword">case</span> <span class="token number">963</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
      <span class="token comment">// column, n</span>
      <span class="token keyword">return</span> out<span class="token punctuation">.</span><span class="token function">charCodeAt</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token number">110</span> <span class="token operator">?</span> webkit <span class="token operator">+</span> out <span class="token operator">+</span> out <span class="token operator">:</span> out
    <span class="token punctuation">&#125;</span>
    <span class="token comment">// box-decoration-break, b, o, x</span>
    <span class="token keyword">case</span> <span class="token number">1009</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>out<span class="token punctuation">.</span><span class="token function">charCodeAt</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span> <span class="token operator">!==</span> <span class="token number">100</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">break</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token comment">// mask, m, a, s</span>
    <span class="token comment">// clip-path, c, l, i</span>
    <span class="token keyword">case</span> <span class="token number">969</span><span class="token operator">:</span>
    <span class="token keyword">case</span> <span class="token number">942</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">return</span> webkit <span class="token operator">+</span> out <span class="token operator">+</span> out
    <span class="token punctuation">&#125;</span>
    <span class="token comment">// appearance: a, p, p</span>
    <span class="token keyword">case</span> <span class="token number">978</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">return</span> webkit <span class="token operator">+</span> out <span class="token operator">+</span> moz <span class="token operator">+</span> out <span class="token operator">+</span> out
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>It looks like it adds a comment for each prefix, so I searched for <code>letter-spacing</code> and found nothing. This made things interesting, as it seems that the behavior of adding a vendor prefix to <code>letter-spacing</code> was not intentional.</p>
<p>Next, let’s take a look at how it adds prefixes. It first hashes the property through a custom hash: <code>var hash = (first*2) + (second*3) + (third*4)</code>, then checks the result of the hash and adds the prefix based on the result.</p>
<p>Let’s hash <code>letter-spacing</code>:</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">hash</span><span class="token punctuation">(</span><span class="token parameter">str</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">return</span> str<span class="token punctuation">.</span><span class="token function">charCodeAt</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">2</span> <span class="token operator">+</span>
    str<span class="token punctuation">.</span><span class="token function">charCodeAt</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">3</span> <span class="token operator">+</span>
    str<span class="token punctuation">.</span><span class="token function">charCodeAt</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">4</span>
<span class="token punctuation">&#125;</span> 

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">hash</span><span class="token punctuation">(</span><span class="token string">'letter-spacing'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 983</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>Then search for 983 in the source code:</p>
<p><img src="/img/sc/hash.png" alt="hash"></p>
<p>The mystery is solved!</p>
<p>It turns out to be a bug caused by hash collision! I’ve heard many suggestions that hash functions should not be defined by oneself, but I never thought I would see a real-world case of a collision caused by a custom hash function.</p>
<p>The string <code>user-select</code> also hashes to 983, just like <code>letter-spacing</code>. Therefore, when converting <code>letter-spacing</code>, it will run into this case and add a vendor prefix to <code>letter-spacing</code>.</p>
<p>So let’s correct the title here. It’s not a bug in styled components, but a bug in stylis. However, both styled components and emotion use stylis, so they both have this bug.</p>
<h2><span id="follow-up">Follow-up</span></h2><p>I searched through the repos of styled, emotion, and styled components, and it seems that no one has noticed this issue. However, I did find a PR for emotion that updates stylis to v4: <a target="_blank" rel="noopener" href="https://github.com/emotion-js/emotion/pull/1817">Stylis v4 #1817</a>, which has already been merged recently. So the next version of emotion (which should be a major version update because it’s a breaking change) will not have this issue.</p>
<p>And I also posted an issue to stylis about this: <a target="_blank" rel="noopener" href="https://github.com/thysultan/stylis.js/issues/223">Redundant css vendor prefix for letter-spacing in v3 #223</a>. However, it seems that there is nothing they can do about it, and this is a bug in the old version that has been fixed in the new version, so it will not be fixed in the old version.</p>
<p>Finally, I also posted an issue to styled components about this: <a target="_blank" rel="noopener" href="https://github.com/styled-components/styled-components/issues/3157">Redundant css vendor prefix for letter-spacing #3157</a>, but no one has responded yet.</p>
<p>I also submitted a PR to update the document URL: <a target="_blank" rel="noopener" href="https://github.com/styled-components/styled-components/pull/3156">Update stylis plugin docs url #3156</a>, to avoid others having the same problem finding the plugin documentation.</p>
<h2><span id="summary">Summary</span></h2><p>In fact, I learned a lot from this incident.</p>
<p>The first point is that I discovered an interesting bug caused by hash collision.</p>
<p>The second point is that I originally thought that removing those 500+ prefixes would reduce the file size a bit, but after measuring it, it only reduced 1KB. Many times I forget to consider the factor of gzip. After this incident, I won’t forget it again.</p>
<p>The third point is that I found that I seem to have a mentality of “must fix the bug”, but in the real world, it is not so ideal, after all, there is a priority for doing things.</p>
<p>Although adding prefixes to letter-spacing is indeed a redundant thing, what is the impact? It just increases a little bit of insignificant file size and looks a bit strange. To be honest, it is not a serious bug. Even if it is not fixed, it does not have much impact, and the webpage will not be affected. Therefore, it is a harmless bug.</p>
<p>So through this incident, I have reorganized my mentality when facing bugs.</p>
<p>That’s about it for this article. If your website also uses emotion or styled components, why not check if you also have this letter-spacing issue!</p>

    
    </div>
    
    <div class="columns is-variable is-1 is-multiline is-mobile">
    
        <span class="column is-narrow"><a class="tag is-light article-tag" href="/en/tags/Front-end/">#Front-end</a></span>
    
    </div>
    
    
    <div class="columns is-mobile is-multiline article-nav">
        <span class="column is-12-mobile is-half-desktop  article-nav-prev">
            
            <a href="/2020/08/07/en/vite-and-esmodules/">Why is Vite so fast? Starting with ES modules</a>
            
        </span>
        <span class="column is-12-mobile is-half-desktop  article-nav-next">
            
            <a href="/2020/06/15/en/react-function-class-hook-useeffect/">Differences between class and function components from practical examples</a>
            
        </span>
    </div>
    
</article>




<div class="comments">
    <h3 class="title is-4">Comments</h3>
    <script src="https://utteranc.es/client.js"
        repo="aszx87410/huli-blog"
        issue-term="title"
        theme="github-light"
        crossorigin="anonymous"
        async>
</script>
</div>

    </div>
</section>
    <footer class="footer">
    <div class="container">
        <div class="columns content">
            <div class="column is-narrow has-text-centered">
                &copy; 2025 Huli&nbsp;
                Powered by <a href="http://hexo.io/" target="_blank">Hexo</a> & <a
                        target="_blank" rel="noopener" href="http://github.com/ppoffice/hexo-theme-minos">Minos</a>
            </div>
            <div class="column is-hidden-mobile"></div>

            
            <div class="column is-narrow">
                <div class="columns is-mobile is-multiline is-centered">
                
                    
                <a class="column is-narrow" title="GitHub" target="_blank" rel="noopener" href="https://github.com/ppoffice/hexo-theme-minos">
                    
                    GitHub
                    
                </a>
                
                </div>
            </div>
            
            
<div class="column is-narrow has-text-centered">
    <div class="dropdown is-up is-right is-hoverable" style="margin-top: -0.2em;">
        <div class="dropdown-trigger">
            <button class="button is-small" aria-haspopup="true">
                <span class="icon">
                    <i class="fas fa-globe"></i>
                </span>
                <span>English</span>
                <span class="icon is-small">
            <i class="fas fa-angle-down" aria-hidden="true"></i>
          </span>
            </button>
        </div>
        <div class="dropdown-menu has-text-left" role="menu" style="top:100%">
            <div class="dropdown-content">
            <!-- NOTE: 永遠回到首頁 -->
            
                <a href="/2020/07/11/an-interesting-styled-components-bug/" class="dropdown-item">
                    繁體中文
                </a>
            
            </div>
        </div>
    </div>
</div>

        </div>
    </div>
</footer>
    <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/3.6.3/jquery.min.js"></script>



    
    
    
    
    
    
<script src="//cdnjs.cloudflare.com/ajax/libs/lightgallery/1.6.8/js/lightgallery-all.min.js"></script>
<script>
    (function ($) {
        $(document).ready(function () {
            if (typeof($.fn.lightGallery) === 'function') {
                $('.article.gallery').lightGallery({ selector: '.gallery-item' });
            }
        });
    })(jQuery);
</script>

    
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.0/clipboard.min.js"></script>
    <style>
        .hljs {
            position: relative;
        }

        .hljs .clipboard-btn {
            float: right;
            color: #9a9a9a;
            background: none;
            border: none;
            cursor: pointer;
        }

        .hljs .clipboard-btn:hover {
          color: #8a8a8a;
        }

        .hljs > .clipboard-btn {
            display: none;
            position: absolute;
            right: 4px;
            top: 4px;
        }

        .hljs:hover > .clipboard-btn {
            display: inline;
        }

        .hljs > figcaption > .clipboard-btn {
            margin-right: 4px;
        }
    </style>
    <script>
      $(document).ready(function () {
        $('figure.hljs').each(function(i, figure) {
          var codeId = 'code-' + i;
          var code = figure.querySelector('.code');
          var copyButton = $('<button>Copy <i class="far fa-clipboard"></i></button>');
          code.id = codeId;
          copyButton.addClass('clipboard-btn');
          copyButton.attr('data-clipboard-target-id', codeId);

          var figcaption = figure.querySelector('figcaption');

          if (figcaption) {
            figcaption.append(copyButton[0]);
          } else {
            figure.prepend(copyButton[0]);
          }
        })

        var clipboard = new ClipboardJS('.clipboard-btn', {
          target: function(trigger) {
            return document.getElementById(trigger.getAttribute('data-clipboard-target-id'));
          }
        });
        clipboard.on('success', function(e) {
          e.clearSelection();
        })
      })
    </script>

    
    

    



<script src="/js/script.js?v=3.js"></script>


    
</body>
</html>