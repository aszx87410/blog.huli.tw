<!DOCTYPE html>
<html class="has-navbar-fixed-top" lang="en">
<head>
    <meta charset="utf-8">
<title>WordPress Plugin VikBooking &lt;= 1.5.3 Unauthorized RCE Vulnerability Details - Huli&#39;s blog</title>
<meta name="viewport" content="width=device-width, initial-scale=1">



            
<link href="https://blog.huli.tw/2022/05/20/wordpress-plugin-vikbooking-unauth-rce/" rel="alternate" hreflang="zh-TW" />
            
    




    
<link rel="canonical" href="https://blog.huli.tw/2022/05/20/en/wordpress-plugin-vikbooking-unauth-rce/">
    





    <meta name="description" content="Recently, I was looking at some WordPress plugins and found that it was a good place to practice because there are many plugins there, and each one has source code that can be viewed. You can do black">
<meta property="og:type" content="article">
<meta property="og:title" content="WordPress Plugin VikBooking &lt;&#x3D; 1.5.3 Unauthorized RCE Vulnerability Details">
<meta property="og:url" content="https://blog.huli.tw/2022/05/20/en/wordpress-plugin-vikbooking-unauth-rce/index.html">
<meta property="og:site_name" content="Huli&#39;s blog">
<meta property="og:description" content="Recently, I was looking at some WordPress plugins and found that it was a good place to practice because there are many plugins there, and each one has source code that can be viewed. You can do black">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://blog.huli.tw/img/wordpress-plugin-vikbooking-unauth-rce/cover-en.png">
<meta property="article:published_time" content="2022-05-20T04:00:00.000Z">
<meta property="article:modified_time" content="2023-06-20T05:10:49.082Z">
<meta property="article:author" content="Huli">
<meta property="article:tag" content="Security">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://blog.huli.tw/img/wordpress-plugin-vikbooking-unauth-rce/cover-en.png">



<link rel="alternative" href="/atom.xml" title="WordPress Plugin VikBooking &lt;= 1.5.3 Unauthorized RCE Vulnerability Details" type="application/atom+xml">



<link rel="icon" href="/img/lidemy_logo.png">


<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Ovo|Source+Code+Pro">


<link rel="stylesheet" href="/css/bulma.css?v=2.css">



<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/lightgallery/1.6.8/css/lightgallery.min.css">


<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/line-numbers/prism-line-numbers.min.css" />


<link rel="stylesheet" href="/css/style.css?v=4.css">





    
    
    
    
    
    
    
    
    
    
<script async src="https://www.googletagmanager.com/gtag/js?id=G-1393J2EVCZ"></script>
<script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-1393J2EVCZ');
</script>


    


<meta name="generator" content="Hexo 6.3.0"></head>
<body>
    <script>
        if (localStorage.getItem('dark-mode')) {
            if (localStorage.getItem('dark-mode') === 'true') {
                document.body.classList.add('dark-mode')
            }
        } else {
            if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                document.body.classList.add('dark-mode')
            }
        }
    </script>
    
<nav class="navbar is-transparent is-fixed-top navbar-main" role="navigation" aria-label="main navigation">
    <div class="container">
        <div class="navbar-brand">
            <a class="navbar-item navbar-logo" href="/en">
                
                    
                    Huli&#39;s blog
                    
                
            </a>
            <div class="navbar-burger">
                <span></span>
                <span></span>
                <span></span>
            </div>
        </div>
        
        <div class="navbar-menu navbar-start">
            
            <a class="navbar-item "
               href="/en/archives">Archive</a>
            
            <a class="navbar-item "
               href="/en/categories">Categories</a>
            
            <a class="navbar-item "
               href="/en/about">About</a>
            
        </div>
        
        <div class="navbar-menu navbar-end">
            
            
            <div class="navbar-item is-hoverable has-dropdown is-hidden-mobile is-hidden-tablet-only toc">
                <a class="navbar-item" title="Table of Contents">
                    Table of Contents
                </a>
                <div class="navbar-dropdown">
                    
                    
                    
                    
                    <a class="navbar-item" href="#introduction-to-vikbooking-and-vulnerability-details">1&nbsp;&nbsp;<b>Introduction to VikBooking and Vulnerability Details</b></a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#fix">2&nbsp;&nbsp;<b>Fix</b></a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#conclusion">3&nbsp;&nbsp;<b>Conclusion</b></a>
                    
                </div>
            </div>
            
            
            <a class="navbar-item" target="_blank" title="Twitter" href="https://twitter.com/aszx87410">
                
                <i class="fab fa-twitter"></i>
                
            </a>
               
            <a class="navbar-item" target="_blank" title="RSS" href="/atom-en.xml">
                
                <i class="fas fa-rss"></i>
                
            </a>
               
            
            <a class="navbar-item btn-dark-mode" title="dark-mode" href="#">
                <div>
                    <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" width="15" height="15" viewBox="0 0 256 256" xml:space="preserve">
                    <defs>
                    </defs>
                    <g style="stroke: none; stroke-width: 0; stroke-dasharray: none; stroke-linecap: butt; stroke-linejoin: miter; stroke-miterlimit: 10; fill: none; fill-rule: nonzero; opacity: 1;" transform="translate(1.4065934065934016 1.4065934065934016) scale(2.81 2.81)" >
                        <path d="M 87.823 60.7 c -0.463 -0.423 -1.142 -0.506 -1.695 -0.214 c -15.834 8.398 -35.266 2.812 -44.232 -12.718 c -8.966 -15.53 -4.09 -35.149 11.101 -44.665 c 0.531 -0.332 0.796 -0.963 0.661 -1.574 c -0.134 -0.612 -0.638 -1.074 -1.259 -1.153 c -9.843 -1.265 -19.59 0.692 -28.193 5.66 C 13.8 12.041 6.356 21.743 3.246 33.35 S 1.732 57.08 7.741 67.487 c 6.008 10.407 15.709 17.851 27.316 20.961 C 38.933 89.486 42.866 90 46.774 90 c 7.795 0 15.489 -2.044 22.42 -6.046 c 8.601 -4.966 15.171 -12.43 18.997 -21.586 C 88.433 61.79 88.285 61.123 87.823 60.7 z" style="stroke: none; stroke-width: 1; stroke-dasharray: none; stroke-linecap: butt; stroke-linejoin: miter; stroke-miterlimit: 10; fill: #ffa716; fill-rule: nonzero; opacity: 1;" transform=" matrix(1 0 0 1 0 0) " stroke-linecap="round" />
                    </g>
                    </svg>
                </div>
            </a>
            
               <a class="navbar-item" href="/2022/05/20/wordpress-plugin-vikbooking-unauth-rce/">中文</a>
            
            

        </div>
    </div>
</nav>

    <section class="section">
    <div class="container">
      
      <div data-nosnippet class="self-notice">
        If you have any thoughts on my blog or articles and you want to let me know, you can either post a comment below(public) or tell me via this <a href="https://forms.gle/SjJZ4cnNs6NnjXQG8" target="_blank">feedback form</a>
      </div>
      
    <article class="article content gallery" itemscope itemprop="blogPost">
    <h1 class="article-title is-size-3 is-size-4-mobile" itemprop="name">
        
            WordPress Plugin VikBooking &lt;= 1.5.3 Unauthorized RCE Vulnerability Details
        
    </h1>
    <div class="article-meta columns is-variable is-1 is-multiline is-mobile is-size-7-mobile">
        <span class="column is-narrow">
            <time datetime="2022-05-20T04:00:00.000Z" itemprop="datePublished">20 May 2022</time>
        </span>
        
        <span class="column is-narrow article-category">
            <i class="far fa-folder"></i>
            <a class="article-category-link" href="/en/categories/Security/">Security</a>
        </span>
        
        
        
        <spen data-nosnippet class="column is-narrow">(Translated by ChatGPT)</span>
        
    </div>
    
    <div class="article-entry is-size-6-mobile" itemprop="articleBody">
    
        <p>Recently, I was looking at some WordPress plugins and found that it was a good place to practice because there are many plugins there, and each one has source code that can be viewed. You can do black-box or white-box testing, and installation is also very convenient.</p>
<p>This article will discuss a vulnerability I found a while ago, which uses the most basic and classic attack method, file upload leading to RCE.</p>
<p>Vulnerability ID: <a target="_blank" rel="noopener" href="https://patchstack.com/database/vulnerability/vikbooking/wordpress-vikbooking-hotel-booking-engine-pms-plugin-1-5-3-arbitrary-file-upload-leading-to-rce">CVE-2022-27862<br> WordPress VikBooking Hotel Booking Engine &amp; PMS plugin &lt;&#x3D; 1.5.3 - Arbitrary File Upload leading to RCE</a></p>
<span id="more"></span>

<h2><span id="introduction-to-vikbooking-and-vulnerability-details">Introduction to VikBooking and Vulnerability Details</span></h2><p><a target="_blank" rel="noopener" href="https://wordpress.org/plugins/vikbooking/">VikBooking</a> is a WordPress booking plugin. The demo on the official website looks like this:</p>
<p><img src="/img/wordpress-plugin-vikbooking-unauth-rce/p1-booking-page.png" alt="booking page"></p>
<p>There is no difference from other booking plugins. After completing the booking, the administrator can manage the order in the WordPress backend, and the consumer will also receive an email with a URL to manage their own booking:</p>
<p><img src="/img/wordpress-plugin-vikbooking-unauth-rce/p2-email.png" alt="booking page customer"></p>
<p>Although there is not much on the UI, since we have the source code, we can use white-box testing to see what the implementation is like.</p>
<p>The main operations and logic are in <code>site/controller.php</code>, and each function inside it basically corresponds to an action. I found a method called <code>storesignature</code>, and the code is as follows:</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">storesignature</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
  <span class="token variable">$sid</span> <span class="token operator">=</span> <span class="token class-name static-context">VikRequest</span><span class="token operator">::</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'sid'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">''</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'request'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token variable">$ts</span> <span class="token operator">=</span> <span class="token class-name static-context">VikRequest</span><span class="token operator">::</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'ts'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">''</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'request'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token variable">$psignature</span> <span class="token operator">=</span> <span class="token class-name static-context">VikRequest</span><span class="token operator">::</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'signature'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">''</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'request'</span><span class="token punctuation">,</span> <span class="token constant">VIKREQUEST_ALLOWRAW</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token variable">$ppad_width</span> <span class="token operator">=</span> <span class="token class-name static-context">VikRequest</span><span class="token operator">::</span><span class="token function">getInt</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'pad_width'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">''</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'request'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token variable">$ppad_ratio</span> <span class="token operator">=</span> <span class="token class-name static-context">VikRequest</span><span class="token operator">::</span><span class="token function">getInt</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'pad_ratio'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">''</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'request'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token variable">$pitemid</span> <span class="token operator">=</span> <span class="token class-name static-context">VikRequest</span><span class="token operator">::</span><span class="token function">getInt</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'Itemid'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">''</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'request'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token variable">$ptmpl</span> <span class="token operator">=</span> <span class="token class-name static-context">VikRequest</span><span class="token operator">::</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'tmpl'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">''</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'request'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token variable">$dbo</span> <span class="token operator">=</span> <span class="token class-name static-context">JFactory</span><span class="token operator">::</span><span class="token function">getDBO</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token variable">$mainframe</span> <span class="token operator">=</span> <span class="token class-name static-context">JFactory</span><span class="token operator">::</span><span class="token function">getApplication</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token variable">$q</span> <span class="token operator">=</span> <span class="token string double-quoted-string">"SELECT * FROM `#__vikbooking_orders` WHERE `ts`="</span> <span class="token operator">.</span> <span class="token variable">$dbo</span><span class="token operator">-></span><span class="token function">quote</span><span class="token punctuation">(</span><span class="token variable">$ts</span><span class="token punctuation">)</span> <span class="token operator">.</span> <span class="token string double-quoted-string">" AND `sid`="</span> <span class="token operator">.</span> <span class="token variable">$dbo</span><span class="token operator">-></span><span class="token function">quote</span><span class="token punctuation">(</span><span class="token variable">$sid</span><span class="token punctuation">)</span> <span class="token operator">.</span> <span class="token string double-quoted-string">" AND `status`='confirmed';"</span><span class="token punctuation">;</span>
  <span class="token variable">$dbo</span><span class="token operator">-></span><span class="token function">setQuery</span><span class="token punctuation">(</span><span class="token variable">$q</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token variable">$dbo</span><span class="token operator">-></span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$dbo</span><span class="token operator">-></span><span class="token function">getNumRows</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token class-name static-context">VikError</span><span class="token operator">::</span><span class="token function">raiseWarning</span><span class="token punctuation">(</span><span class="token string single-quoted-string">''</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'Booking not found'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$mainframe</span><span class="token operator">-></span><span class="token function">redirect</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'index.php'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">exit</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  <span class="token variable">$row</span> <span class="token operator">=</span> <span class="token variable">$dbo</span><span class="token operator">-></span><span class="token function">loadAssoc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token variable">$tonight</span> <span class="token operator">=</span> <span class="token function">mktime</span><span class="token punctuation">(</span><span class="token number">23</span><span class="token punctuation">,</span> <span class="token number">59</span><span class="token punctuation">,</span> <span class="token number">59</span><span class="token punctuation">,</span> <span class="token function">date</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'n'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">date</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'j'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">date</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'Y'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$tonight</span> <span class="token operator">></span> <span class="token variable">$row</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'checkout'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token class-name static-context">VikError</span><span class="token operator">::</span><span class="token function">raiseWarning</span><span class="token punctuation">(</span><span class="token string single-quoted-string">''</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'Check-out date is in the past'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$mainframe</span><span class="token operator">-></span><span class="token function">redirect</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'index.php'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">exit</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  <span class="token variable">$customer</span> <span class="token operator">=</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token variable">$q</span> <span class="token operator">=</span> <span class="token string double-quoted-string">"SELECT `c`.*,`co`.`idorder`,`co`.`signature`,`co`.`pax_data`,`co`.`comments` FROM `#__vikbooking_customers` AS `c` LEFT JOIN `#__vikbooking_customers_orders` `co` ON `c`.`id`=`co`.`idcustomer` WHERE `co`.`idorder`="</span><span class="token operator">.</span><span class="token punctuation">(</span><span class="token keyword type-casting">int</span><span class="token punctuation">)</span><span class="token variable">$row</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'id'</span><span class="token punctuation">]</span><span class="token operator">.</span><span class="token string double-quoted-string">";"</span><span class="token punctuation">;</span>
  <span class="token variable">$dbo</span><span class="token operator">-></span><span class="token function">setQuery</span><span class="token punctuation">(</span><span class="token variable">$q</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token variable">$dbo</span><span class="token operator">-></span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$dbo</span><span class="token operator">-></span><span class="token function">getNumRows</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token variable">$customer</span> <span class="token operator">=</span> <span class="token variable">$dbo</span><span class="token operator">-></span><span class="token function">loadAssoc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token variable">$customer</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token class-name static-context">VikError</span><span class="token operator">::</span><span class="token function">raiseWarning</span><span class="token punctuation">(</span><span class="token string single-quoted-string">''</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'Customer not found'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$mainframe</span><span class="token operator">-></span><span class="token function">redirect</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'index.php'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">exit</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  <span class="token comment">//check if the signature has been submitted</span>
  <span class="token variable">$signature_data</span> <span class="token operator">=</span> <span class="token string single-quoted-string">''</span><span class="token punctuation">;</span>
  <span class="token variable">$cont_type</span> <span class="token operator">=</span> <span class="token string single-quoted-string">''</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">empty</span><span class="token punctuation">(</span><span class="token variable">$psignature</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">//check whether the format is accepted</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strpos</span><span class="token punctuation">(</span><span class="token variable">$psignature</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'image/png'</span><span class="token punctuation">)</span> <span class="token operator">!==</span> <span class="token keyword type-declaration">false</span> <span class="token operator">||</span> <span class="token class-name">strpos</span><span class="token punctuation">(</span><span class="token variable">$psignature</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'image/jpeg'</span><span class="token punctuation">)</span> <span class="token operator">!==</span> <span class="token keyword type-declaration">false</span> <span class="token operator">||</span> <span class="token class-name">strpos</span><span class="token punctuation">(</span><span class="token variable">$psignature</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'image/svg'</span><span class="token punctuation">)</span> <span class="token operator">!==</span> <span class="token constant boolean">false</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token variable">$parts</span> <span class="token operator">=</span> <span class="token function">explode</span><span class="token punctuation">(</span><span class="token string single-quoted-string">';base64,'</span><span class="token punctuation">,</span> <span class="token variable">$psignature</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token variable">$cont_type_parts</span> <span class="token operator">=</span> <span class="token function">explode</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'image/'</span><span class="token punctuation">,</span> <span class="token variable">$parts</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token variable">$cont_type</span> <span class="token operator">=</span> <span class="token variable">$cont_type_parts</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">empty</span><span class="token punctuation">(</span><span class="token variable">$parts</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token variable">$signature_data</span> <span class="token operator">=</span> <span class="token function">base64_decode</span><span class="token punctuation">(</span><span class="token variable">$parts</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>
  <span class="token variable">$ret_link</span> <span class="token operator">=</span> <span class="token class-name static-context">JRoute</span><span class="token operator">::</span><span class="token function">rewrite</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'index.php?option=com_vikbooking&amp;task=signature&amp;sid='</span><span class="token operator">.</span><span class="token variable">$row</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'sid'</span><span class="token punctuation">]</span><span class="token operator">.</span><span class="token string single-quoted-string">'&amp;ts='</span><span class="token operator">.</span><span class="token variable">$row</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'ts'</span><span class="token punctuation">]</span><span class="token operator">.</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">empty</span><span class="token punctuation">(</span><span class="token variable">$pitemid</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token string single-quoted-string">'&amp;Itemid='</span><span class="token operator">.</span><span class="token variable">$pitemid</span> <span class="token punctuation">:</span> <span class="token string single-quoted-string">''</span><span class="token punctuation">)</span><span class="token operator">.</span><span class="token punctuation">(</span><span class="token variable">$ptmpl</span> <span class="token operator">==</span> <span class="token string single-quoted-string">'component'</span> <span class="token operator">?</span> <span class="token string single-quoted-string">'&amp;tmpl=component'</span> <span class="token punctuation">:</span> <span class="token string single-quoted-string">''</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token constant boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">empty</span><span class="token punctuation">(</span><span class="token variable">$signature_data</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token class-name static-context">VikError</span><span class="token operator">::</span><span class="token function">raiseWarning</span><span class="token punctuation">(</span><span class="token string single-quoted-string">''</span><span class="token punctuation">,</span> <span class="token class-name static-context">JText</span><span class="token operator">::</span><span class="token function">translate</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'VBOSIGNATUREISEMPTY'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$mainframe</span><span class="token operator">-></span><span class="token function">redirect</span><span class="token punctuation">(</span><span class="token variable">$ret_link</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">exit</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  <span class="token comment">//write file</span>
  <span class="token variable">$sign_fname</span> <span class="token operator">=</span> <span class="token variable">$row</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'id'</span><span class="token punctuation">]</span><span class="token operator">.</span><span class="token string single-quoted-string">'_'</span><span class="token operator">.</span><span class="token variable">$row</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'sid'</span><span class="token punctuation">]</span><span class="token operator">.</span><span class="token string single-quoted-string">'_'</span><span class="token operator">.</span><span class="token variable">$customer</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'id'</span><span class="token punctuation">]</span><span class="token operator">.</span><span class="token string single-quoted-string">'.'</span><span class="token operator">.</span><span class="token variable">$cont_type</span><span class="token punctuation">;</span>
  <span class="token variable">$filepath</span> <span class="token operator">=</span> <span class="token constant">VBO_ADMIN_PATH</span> <span class="token operator">.</span> <span class="token constant">DIRECTORY_SEPARATOR</span> <span class="token operator">.</span> <span class="token string single-quoted-string">'resources'</span> <span class="token operator">.</span> <span class="token constant">DIRECTORY_SEPARATOR</span> <span class="token operator">.</span> <span class="token string single-quoted-string">'idscans'</span> <span class="token operator">.</span> <span class="token constant">DIRECTORY_SEPARATOR</span> <span class="token operator">.</span> <span class="token variable">$sign_fname</span><span class="token punctuation">;</span>
  <span class="token variable">$fp</span> <span class="token operator">=</span> <span class="token function">fopen</span><span class="token punctuation">(</span><span class="token variable">$filepath</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'w+'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token variable">$bytes</span> <span class="token operator">=</span> <span class="token function">fwrite</span><span class="token punctuation">(</span><span class="token variable">$fp</span><span class="token punctuation">,</span> <span class="token variable">$signature_data</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">fclose</span><span class="token punctuation">(</span><span class="token variable">$fp</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$bytes</span> <span class="token operator">!==</span> <span class="token constant boolean">false</span> <span class="token operator">&amp;&amp;</span> <span class="token variable">$bytes</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">//update the signature in the DB</span>
    <span class="token variable">$q</span> <span class="token operator">=</span> <span class="token string double-quoted-string">"UPDATE `#__vikbooking_customers_orders` SET `signature`="</span><span class="token operator">.</span><span class="token variable">$dbo</span><span class="token operator">-></span><span class="token function">quote</span><span class="token punctuation">(</span><span class="token variable">$sign_fname</span><span class="token punctuation">)</span><span class="token operator">.</span><span class="token string double-quoted-string">" WHERE `idorder`="</span><span class="token operator">.</span><span class="token punctuation">(</span><span class="token keyword type-casting">int</span><span class="token punctuation">)</span><span class="token variable">$row</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'id'</span><span class="token punctuation">]</span><span class="token operator">.</span><span class="token string double-quoted-string">";"</span><span class="token punctuation">;</span>
    <span class="token variable">$dbo</span><span class="token operator">-></span><span class="token function">setQuery</span><span class="token punctuation">(</span><span class="token variable">$q</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$dbo</span><span class="token operator">-></span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$mainframe</span><span class="token operator">-></span><span class="token function">enqueueMessage</span><span class="token punctuation">(</span><span class="token class-name static-context">JText</span><span class="token operator">::</span><span class="token function">translate</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'VBOSIGNATURETHANKS'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//resize image for screens with high resolution</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$ppad_ratio</span> <span class="token operator">></span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token variable">$new_width</span> <span class="token operator">=</span> <span class="token function">floor</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token variable">$ppad_width</span> <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token variable">$creativik</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">vikResizer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token variable">$creativik</span><span class="token operator">-></span><span class="token function">proportionalImage</span><span class="token punctuation">(</span><span class="token variable">$filepath</span><span class="token punctuation">,</span> <span class="token variable">$filepath</span><span class="token punctuation">,</span> <span class="token variable">$new_width</span><span class="token punctuation">,</span> <span class="token variable">$new_width</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token comment">//</span>
  <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
    <span class="token class-name static-context">VikError</span><span class="token operator">::</span><span class="token function">raiseWarning</span><span class="token punctuation">(</span><span class="token string single-quoted-string">''</span><span class="token punctuation">,</span> <span class="token class-name static-context">JText</span><span class="token operator">::</span><span class="token function">translate</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'VBOERRSTORESIGNFILE'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  <span class="token variable">$mainframe</span><span class="token operator">-></span><span class="token function">redirect</span><span class="token punctuation">(</span><span class="token variable">$ret_link</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">exit</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>From the function name and code, it can be inferred that it is a function to upload a signature file, and the contents of the file will be base64-encoded first. Therefore, the code decodes it back to binary and writes it to the file. The core code is as follows:</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token variable">$psignature</span> <span class="token operator">=</span> <span class="token class-name static-context">VikRequest</span><span class="token operator">::</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'signature'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">''</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'request'</span><span class="token punctuation">,</span> <span class="token constant">VIKREQUEST_ALLOWRAW</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//check if the signature has been submitted</span>
<span class="token variable">$signature_data</span> <span class="token operator">=</span> <span class="token string single-quoted-string">''</span><span class="token punctuation">;</span>
<span class="token variable">$cont_type</span> <span class="token operator">=</span> <span class="token string single-quoted-string">''</span><span class="token punctuation">;</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">empty</span><span class="token punctuation">(</span><span class="token variable">$psignature</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token comment">//check whether the format is accepted</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strpos</span><span class="token punctuation">(</span><span class="token variable">$psignature</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'image/png'</span><span class="token punctuation">)</span> <span class="token operator">!==</span> <span class="token keyword type-declaration">false</span> <span class="token operator">||</span> <span class="token class-name">strpos</span><span class="token punctuation">(</span><span class="token variable">$psignature</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'image/jpeg'</span><span class="token punctuation">)</span> <span class="token operator">!==</span> <span class="token keyword type-declaration">false</span> <span class="token operator">||</span> <span class="token class-name">strpos</span><span class="token punctuation">(</span><span class="token variable">$psignature</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'image/svg'</span><span class="token punctuation">)</span> <span class="token operator">!==</span> <span class="token constant boolean">false</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token variable">$parts</span> <span class="token operator">=</span> <span class="token function">explode</span><span class="token punctuation">(</span><span class="token string single-quoted-string">';base64,'</span><span class="token punctuation">,</span> <span class="token variable">$psignature</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$cont_type_parts</span> <span class="token operator">=</span> <span class="token function">explode</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'image/'</span><span class="token punctuation">,</span> <span class="token variable">$parts</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$cont_type</span> <span class="token operator">=</span> <span class="token variable">$cont_type_parts</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">empty</span><span class="token punctuation">(</span><span class="token variable">$parts</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token variable">$signature_data</span> <span class="token operator">=</span> <span class="token function">base64_decode</span><span class="token punctuation">(</span><span class="token variable">$parts</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span class="token variable">$ret_link</span> <span class="token operator">=</span> <span class="token class-name static-context">JRoute</span><span class="token operator">::</span><span class="token function">rewrite</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'index.php?option=com_vikbooking&amp;task=signature&amp;sid='</span><span class="token operator">.</span><span class="token variable">$row</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'sid'</span><span class="token punctuation">]</span><span class="token operator">.</span><span class="token string single-quoted-string">'&amp;ts='</span><span class="token operator">.</span><span class="token variable">$row</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'ts'</span><span class="token punctuation">]</span><span class="token operator">.</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">empty</span><span class="token punctuation">(</span><span class="token variable">$pitemid</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token string single-quoted-string">'&amp;Itemid='</span><span class="token operator">.</span><span class="token variable">$pitemid</span> <span class="token punctuation">:</span> <span class="token string single-quoted-string">''</span><span class="token punctuation">)</span><span class="token operator">.</span><span class="token punctuation">(</span><span class="token variable">$ptmpl</span> <span class="token operator">==</span> <span class="token string single-quoted-string">'component'</span> <span class="token operator">?</span> <span class="token string single-quoted-string">'&amp;tmpl=component'</span> <span class="token punctuation">:</span> <span class="token string single-quoted-string">''</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token constant boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">empty</span><span class="token punctuation">(</span><span class="token variable">$signature_data</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token class-name static-context">VikError</span><span class="token operator">::</span><span class="token function">raiseWarning</span><span class="token punctuation">(</span><span class="token string single-quoted-string">''</span><span class="token punctuation">,</span> <span class="token class-name static-context">JText</span><span class="token operator">::</span><span class="token function">translate</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'VBOSIGNATUREISEMPTY'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token variable">$mainframe</span><span class="token operator">-></span><span class="token function">redirect</span><span class="token punctuation">(</span><span class="token variable">$ret_link</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">exit</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span class="token variable">$sign_fname</span> <span class="token operator">=</span> <span class="token variable">$row</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'id'</span><span class="token punctuation">]</span><span class="token operator">.</span><span class="token string single-quoted-string">'_'</span><span class="token operator">.</span><span class="token variable">$row</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'sid'</span><span class="token punctuation">]</span><span class="token operator">.</span><span class="token string single-quoted-string">'_'</span><span class="token operator">.</span><span class="token variable">$customer</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'id'</span><span class="token punctuation">]</span><span class="token operator">.</span><span class="token string single-quoted-string">'.'</span><span class="token operator">.</span><span class="token variable">$cont_type</span><span class="token punctuation">;</span>
<span class="token variable">$filepath</span> <span class="token operator">=</span> <span class="token constant">VBO_ADMIN_PATH</span> <span class="token operator">.</span> <span class="token constant">DIRECTORY_SEPARATOR</span> <span class="token operator">.</span> <span class="token string single-quoted-string">'resources'</span> <span class="token operator">.</span> <span class="token constant">DIRECTORY_SEPARATOR</span> <span class="token operator">.</span> <span class="token string single-quoted-string">'idscans'</span> <span class="token operator">.</span> <span class="token constant">DIRECTORY_SEPARATOR</span> <span class="token operator">.</span> <span class="token variable">$sign_fname</span><span class="token punctuation">;</span>
<span class="token variable">$fp</span> <span class="token operator">=</span> <span class="token function">fopen</span><span class="token punctuation">(</span><span class="token variable">$filepath</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'w+'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$bytes</span> <span class="token operator">=</span> <span class="token function">fwrite</span><span class="token punctuation">(</span><span class="token variable">$fp</span><span class="token punctuation">,</span> <span class="token variable">$signature_data</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">fclose</span><span class="token punctuation">(</span><span class="token variable">$fp</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>From the last paragraph, it can be seen that the content written to the file is <code>$signature_data</code>, and the path is <code>VBO_ADMIN_PATH . DIRECTORY_SEPARATOR . &#39;resources&#39; . DIRECTORY_SEPARATOR . &#39;idscans&#39; . DIRECTORY_SEPARATOR . $sign_fname</code>. If we can control <code>$signature_data</code> and <code>$sign_fname</code>, we have an arbitrary file writing vulnerability. The values of these variables are as follows:</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strpos</span><span class="token punctuation">(</span><span class="token variable">$psignature</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'image/png'</span><span class="token punctuation">)</span> <span class="token operator">!==</span> <span class="token keyword type-declaration">false</span> <span class="token operator">||</span> <span class="token class-name">strpos</span><span class="token punctuation">(</span><span class="token variable">$psignature</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'image/jpeg'</span><span class="token punctuation">)</span> <span class="token operator">!==</span> <span class="token keyword type-declaration">false</span> <span class="token operator">||</span> <span class="token class-name">strpos</span><span class="token punctuation">(</span><span class="token variable">$psignature</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'image/svg'</span><span class="token punctuation">)</span> <span class="token operator">!==</span> <span class="token constant boolean">false</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token variable">$parts</span> <span class="token operator">=</span> <span class="token function">explode</span><span class="token punctuation">(</span><span class="token string single-quoted-string">';base64,'</span><span class="token punctuation">,</span> <span class="token variable">$psignature</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token variable">$cont_type_parts</span> <span class="token operator">=</span> <span class="token function">explode</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'image/'</span><span class="token punctuation">,</span> <span class="token variable">$parts</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token variable">$cont_type</span> <span class="token operator">=</span> <span class="token variable">$cont_type_parts</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">empty</span><span class="token punctuation">(</span><span class="token variable">$parts</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token variable">$signature_data</span> <span class="token operator">=</span> <span class="token function">base64_decode</span><span class="token punctuation">(</span><span class="token variable">$parts</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span class="token variable">$sign_fname</span> <span class="token operator">=</span> <span class="token variable">$row</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'id'</span><span class="token punctuation">]</span><span class="token operator">.</span><span class="token string single-quoted-string">'_'</span><span class="token operator">.</span><span class="token variable">$row</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'sid'</span><span class="token punctuation">]</span><span class="token operator">.</span><span class="token string single-quoted-string">'_'</span><span class="token operator">.</span><span class="token variable">$customer</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'id'</span><span class="token punctuation">]</span><span class="token operator">.</span><span class="token string single-quoted-string">'.'</span><span class="token operator">.</span><span class="token variable">$cont_type</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>A normal <code>$psignature</code> looks like this: <code>data:image/png;base64,image_content</code>.</p>
<p>Here, we first check if <code>$psignature</code> has the specified content type. If so, we use <code>;base64,</code> to split the string. The split parts will become:</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php">parts<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'data:image/png'</span><span class="token punctuation">;</span>
parts<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> image_content<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>Then, we use <code>image/</code> to split <code>parts[0]</code>, and the second part of the data obtained (in the example above, <code>png</code>) is the content type, while <code>parts[1]</code> is directly base64-decoded and used as the file content to be written.</p>
<p>The <code>$sign_fname</code> part of the file name is some ID with the content type just obtained added at the end.</p>
<p>From the above logic, it can be seen that the file content can be controlled arbitrarily, and the file name can also be easily bypassed, like this:</p>
<pre class="line-numbers language-none"><code class="language-none">image&#x2F;png&#x2F;..&#x2F;..&#x2F;..&#x2F;..&#x2F;shell.php;base64,web_shell<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>The check will pass because it contains <code>image/png</code>. After the cut, <code>parts[0]</code> becomes <code>image/png/../../../../shell.php</code>. The resulting content type is <code>png/../../../../shell.php</code>, and the concatenated file name will look like this: <code>id_sid_cid.png/../../../../shell.php</code>. Although this file name looks very unreasonable, it is the file followed by <code>../</code>. However, this is not a problem in PHP. You can see the following example:</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
  <span class="token variable">$filepath</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'not_exist.php/../poc.php'</span><span class="token punctuation">;</span>
  <span class="token variable">$fp</span> <span class="token operator">=</span> <span class="token function">fopen</span><span class="token punctuation">(</span><span class="token variable">$filepath</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'w+'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token variable">$bytes</span> <span class="token operator">=</span> <span class="token function">fwrite</span><span class="token punctuation">(</span><span class="token variable">$fp</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'abc'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">fclose</span><span class="token punctuation">(</span><span class="token variable">$fp</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token delimiter important">?></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>Code like the one above will still write the content to <code>poc.php</code> in the same directory.</p>
<p>After having an arbitrary file writing vulnerability, writing a web shell will result in RCE, as shown below:</p>
<p><img src="/img/wordpress-plugin-vikbooking-unauth-rce/p3-rce.png" alt="rce"></p>
<h2><span id="fix">Fix</span></h2><p>Vikbooking fixed this vulnerability in version 1.5.4 by changing the code that retrieves data and content type to the following:</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">empty</span><span class="token punctuation">(</span><span class="token variable">$psignature</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">/**
     * Implemented safe filtering of base64-encoded signature image
     * to obtain content and file extension.
     *
     * @since       1.15.1 (J) - 1.5.4 (WP)
     */</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">preg_match</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"/^data:image\/(png|jpe?g|svg);base64,([A-Za-z0-9\/=+]+)$/"</span><span class="token punctuation">,</span> <span class="token variable">$psignature</span><span class="token punctuation">,</span> <span class="token variable">$safe_match</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token variable">$signature_data</span> <span class="token operator">=</span> <span class="token function">base64_decode</span><span class="token punctuation">(</span><span class="token variable">$safe_match</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token variable">$cont_type</span> <span class="token operator">=</span> <span class="token variable">$safe_match</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>After changing to use regular expressions to process, it ensures that the matched content type will only be the file extension of the image. In the case where other parameters in the file name cannot be controlled, files cannot be written to arbitrary locations.</p>
<h2><span id="conclusion">Conclusion</span></h2><p>It can only be said that when implementing functions that allow users to upload files, you must be especially careful. This function is particularly prone to problems, such as:</p>
<ol>
<li>The file name is not filtered well, uploading PHP can result in web shell, uploading HTML is XSS</li>
<li>The path is not filtered well, and files can be uploaded to any location</li>
<li>Unpacking may encounter <a target="_blank" rel="noopener" href="https://github.com/snyk/zip-slip-vulnerability">zip slip</a></li>
</ol>
<p>In short, in the future, when implementing similar functions, remember to pay special attention to these issues to avoid writing vulnerable code.</p>

    
    </div>
    
    <div class="columns is-variable is-1 is-multiline is-mobile">
    
        <span class="column is-narrow"><a class="tag is-light article-tag" href="/en/tags/Security/">#Security</a></span>
    
    </div>
    
    
    <div class="columns is-mobile is-multiline article-nav">
        <span class="column is-12-mobile is-half-desktop  article-nav-prev">
            
            <a href="/2022/05/21/en/m0lecon-ctf-2022-writeup/">m0leCon CTF 2022 Notes</a>
            
        </span>
        <span class="column is-12-mobile is-half-desktop  article-nav-next">
            
            <a href="/2022/05/05/en/angstrom-ctf-2022-writeup/">ångstromCTF 2022 Notes</a>
            
        </span>
    </div>
    
</article>




<div class="comments">
    <h3 class="title is-4">Comments</h3>
    <script src="https://utteranc.es/client.js"
        repo="aszx87410/huli-blog"
        issue-term="title"
        theme="github-light"
        crossorigin="anonymous"
        async>
</script>
</div>

    </div>
</section>
    <footer class="footer">
    <div class="container">
        <div class="columns content">
            <div class="column is-narrow has-text-centered">
                &copy; 2024 Huli&nbsp;
                Powered by <a href="http://hexo.io/" target="_blank">Hexo</a> & <a
                        target="_blank" rel="noopener" href="http://github.com/ppoffice/hexo-theme-minos">Minos</a>
            </div>
            <div class="column is-hidden-mobile"></div>

            
            <div class="column is-narrow">
                <div class="columns is-mobile is-multiline is-centered">
                
                    
                <a class="column is-narrow" title="GitHub" target="_blank" rel="noopener" href="https://github.com/ppoffice/hexo-theme-minos">
                    
                    GitHub
                    
                </a>
                
                </div>
            </div>
            
            
<div class="column is-narrow has-text-centered">
    <div class="dropdown is-up is-right is-hoverable" style="margin-top: -0.2em;">
        <div class="dropdown-trigger">
            <button class="button is-small" aria-haspopup="true">
                <span class="icon">
                    <i class="fas fa-globe"></i>
                </span>
                <span>English</span>
                <span class="icon is-small">
            <i class="fas fa-angle-down" aria-hidden="true"></i>
          </span>
            </button>
        </div>
        <div class="dropdown-menu has-text-left" role="menu" style="top:100%">
            <div class="dropdown-content">
            <!-- NOTE: 永遠回到首頁 -->
            
                <a href="/2022/05/20/wordpress-plugin-vikbooking-unauth-rce/" class="dropdown-item">
                    繁體中文
                </a>
            
            </div>
        </div>
    </div>
</div>

        </div>
    </div>
</footer>
    <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/3.6.3/jquery.min.js"></script>



    
    
    
    
    
    
<script src="//cdnjs.cloudflare.com/ajax/libs/lightgallery/1.6.8/js/lightgallery-all.min.js"></script>
<script>
    (function ($) {
        $(document).ready(function () {
            if (typeof($.fn.lightGallery) === 'function') {
                $('.article.gallery').lightGallery({ selector: '.gallery-item' });
            }
        });
    })(jQuery);
</script>

    
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.0/clipboard.min.js"></script>
    <style>
        .hljs {
            position: relative;
        }

        .hljs .clipboard-btn {
            float: right;
            color: #9a9a9a;
            background: none;
            border: none;
            cursor: pointer;
        }

        .hljs .clipboard-btn:hover {
          color: #8a8a8a;
        }

        .hljs > .clipboard-btn {
            display: none;
            position: absolute;
            right: 4px;
            top: 4px;
        }

        .hljs:hover > .clipboard-btn {
            display: inline;
        }

        .hljs > figcaption > .clipboard-btn {
            margin-right: 4px;
        }
    </style>
    <script>
      $(document).ready(function () {
        $('figure.hljs').each(function(i, figure) {
          var codeId = 'code-' + i;
          var code = figure.querySelector('.code');
          var copyButton = $('<button>Copy <i class="far fa-clipboard"></i></button>');
          code.id = codeId;
          copyButton.addClass('clipboard-btn');
          copyButton.attr('data-clipboard-target-id', codeId);

          var figcaption = figure.querySelector('figcaption');

          if (figcaption) {
            figcaption.append(copyButton[0]);
          } else {
            figure.prepend(copyButton[0]);
          }
        })

        var clipboard = new ClipboardJS('.clipboard-btn', {
          target: function(trigger) {
            return document.getElementById(trigger.getAttribute('data-clipboard-target-id'));
          }
        });
        clipboard.on('success', function(e) {
          e.clearSelection();
        })
      })
    </script>

    
    

    



<script src="/js/script.js?v=3.js"></script>


    
</body>
</html>