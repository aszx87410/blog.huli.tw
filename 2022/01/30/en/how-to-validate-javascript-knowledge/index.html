<!DOCTYPE html>
<html class="has-navbar-fixed-top" lang="en">
<head>
    <meta charset="utf-8">
<title>Your JavaScript Knowledge Might Be Wrong - Huli&#39;s blog</title>
<meta name="viewport" content="width=device-width, initial-scale=1">



            
<link href="https://blog.huli.tw/2022/01/30/how-to-validate-javascript-knowledge/" rel="alternate" hreflang="zh-TW" />
            
    




    
<link rel="canonical" href="https://blog.huli.tw/2022/01/30/en/how-to-validate-javascript-knowledge/">
    





    <meta name="description" content="After discussing the history and baggage of JavaScript, let’s talk about JavaScript itself. Have you ever wondered how to know if an author of a JavaScript book or tutorial article has written it corr">
<meta property="og:type" content="article">
<meta property="og:title" content="Your JavaScript Knowledge Might Be Wrong">
<meta property="og:url" content="https://blog.huli.tw/2022/01/30/en/how-to-validate-javascript-knowledge/index.html">
<meta property="og:site_name" content="Huli&#39;s blog">
<meta property="og:description" content="After discussing the history and baggage of JavaScript, let’s talk about JavaScript itself. Have you ever wondered how to know if an author of a JavaScript book or tutorial article has written it corr">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://blog.huli.tw/img/how-to-validate-javascript-knowledge/cover-en.png">
<meta property="article:published_time" content="2022-01-30T09:32:14.000Z">
<meta property="article:modified_time" content="2023-06-20T05:46:56.912Z">
<meta property="article:author" content="Huli">
<meta property="article:tag" content="JavaScript">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://blog.huli.tw/img/how-to-validate-javascript-knowledge/cover-en.png">



<link rel="alternative" href="/atom.xml" title="Your JavaScript Knowledge Might Be Wrong" type="application/atom+xml">



<link rel="icon" href="/img/lidemy_logo.png">


<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Ovo|Source+Code+Pro">


<link rel="stylesheet" href="/css/bulma.css?v=2.css">



<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/lightgallery/1.6.8/css/lightgallery.min.css">


<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/line-numbers/prism-line-numbers.min.css" />


<link rel="stylesheet" href="/css/style.css?v=3.css">





    
    
    
    
    
    
    
    
    
    
<script async src="https://www.googletagmanager.com/gtag/js?id=G-1393J2EVCZ"></script>
<script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-1393J2EVCZ');
</script>


    


<meta name="generator" content="Hexo 6.3.0"></head>
<body>
    <script>
        if (localStorage.getItem('dark-mode')) {
            if (localStorage.getItem('dark-mode') === 'true') {
                document.body.classList.add('dark-mode')
            }
        } else {
            if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                document.body.classList.add('dark-mode')
            }
        }
    </script>
    
<nav class="navbar is-transparent is-fixed-top navbar-main" role="navigation" aria-label="main navigation">
    <div class="container">
        <div class="navbar-brand">
            <a class="navbar-item navbar-logo" href="/en">
                
                    
                    Huli&#39;s blog
                    
                
            </a>
            <div class="navbar-burger">
                <span></span>
                <span></span>
                <span></span>
            </div>
        </div>
        
        <div class="navbar-menu navbar-start">
            
            <a class="navbar-item "
               href="/en/archives">Archive</a>
            
            <a class="navbar-item "
               href="/en/categories">Categories</a>
            
            <a class="navbar-item "
               href="/en/about">About</a>
            
        </div>
        
        <div class="navbar-menu navbar-end">
            
            
            <div class="navbar-item is-hoverable has-dropdown is-hidden-mobile is-hidden-tablet-only toc">
                <a class="navbar-item" title="Table of Contents">
                    Table of Contents
                </a>
                <div class="navbar-dropdown">
                    
                    
                    
                    
                    <a class="navbar-item" href="#ecmascript">1&nbsp;&nbsp;<b>ECMAScript</b></a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#exploring-ecmascript">2&nbsp;&nbsp;<b>Exploring ECMAScript</b></a>
                    
                    
                    
                    <a class="navbar-item" href="#stringprototyperepeat">2.1&nbsp;&nbsp;String.prototype.repeat</a>
                    
                    
                    
                    <a class="navbar-item" href="#typeof">2.2&nbsp;&nbsp;typeof</a>
                    
                    
                    
                    <a class="navbar-item" href="#comments">2.3&nbsp;&nbsp;Comments</a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#talking-about-javascript-engine-source-code">3&nbsp;&nbsp;<b>Talking about JavaScript engine source code</b></a>
                    
                    
                    
                    <a class="navbar-item" href="#stringprototyperepeat">3.1&nbsp;&nbsp;String.prototype.repeat</a>
                    
                    
                    
                    <a class="navbar-item" href="#typeof">3.2&nbsp;&nbsp;typeof</a>
                    
                    
                    
                    <a class="navbar-item" href="#comments">3.3&nbsp;&nbsp;Comments</a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#conclusion">4&nbsp;&nbsp;<b>Conclusion</b></a>
                    
                </div>
            </div>
            
            
            <a class="navbar-item" target="_blank" title="Twitter" href="https://twitter.com/aszx87410">
                
                <i class="fab fa-twitter"></i>
                
            </a>
               
            <a class="navbar-item" target="_blank" title="RSS" href="/atom-en.xml">
                
                <i class="fas fa-rss"></i>
                
            </a>
               
            
            <a class="navbar-item btn-dark-mode" title="dark-mode" href="#">
                <div>
                    <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" width="15" height="15" viewBox="0 0 256 256" xml:space="preserve">
                    <defs>
                    </defs>
                    <g style="stroke: none; stroke-width: 0; stroke-dasharray: none; stroke-linecap: butt; stroke-linejoin: miter; stroke-miterlimit: 10; fill: none; fill-rule: nonzero; opacity: 1;" transform="translate(1.4065934065934016 1.4065934065934016) scale(2.81 2.81)" >
                        <path d="M 87.823 60.7 c -0.463 -0.423 -1.142 -0.506 -1.695 -0.214 c -15.834 8.398 -35.266 2.812 -44.232 -12.718 c -8.966 -15.53 -4.09 -35.149 11.101 -44.665 c 0.531 -0.332 0.796 -0.963 0.661 -1.574 c -0.134 -0.612 -0.638 -1.074 -1.259 -1.153 c -9.843 -1.265 -19.59 0.692 -28.193 5.66 C 13.8 12.041 6.356 21.743 3.246 33.35 S 1.732 57.08 7.741 67.487 c 6.008 10.407 15.709 17.851 27.316 20.961 C 38.933 89.486 42.866 90 46.774 90 c 7.795 0 15.489 -2.044 22.42 -6.046 c 8.601 -4.966 15.171 -12.43 18.997 -21.586 C 88.433 61.79 88.285 61.123 87.823 60.7 z" style="stroke: none; stroke-width: 1; stroke-dasharray: none; stroke-linecap: butt; stroke-linejoin: miter; stroke-miterlimit: 10; fill: #ffa716; fill-rule: nonzero; opacity: 1;" transform=" matrix(1 0 0 1 0 0) " stroke-linecap="round" />
                    </g>
                    </svg>
                </div>
            </a>
            
               <a class="navbar-item" href="/2022/01/30/how-to-validate-javascript-knowledge/">中文</a>
            
            

        </div>
    </div>
</nav>

    <section class="section">
    <div class="container">
      
      <div data-nosnippet class="self-notice">
        If you have any thoughts on my blog or articles and you want to let me know, you can either post a comment below(public) or tell me via this <a href="https://forms.gle/SjJZ4cnNs6NnjXQG8" target="_blank">feedback form</a>
      </div>
      
    <article class="article content gallery" itemscope itemprop="blogPost">
    <h1 class="article-title is-size-3 is-size-4-mobile" itemprop="name">
        
            Your JavaScript Knowledge Might Be Wrong
        
    </h1>
    <div class="article-meta columns is-variable is-1 is-multiline is-mobile is-size-7-mobile">
        <span class="column is-narrow">
            <time datetime="2022-01-30T09:32:14.000Z" itemprop="datePublished">30 January 2022</time>
        </span>
        
        <span class="column is-narrow article-category">
            <i class="far fa-folder"></i>
            <a class="article-category-link" href="/en/categories/JavaScript/">JavaScript</a>
        </span>
        
        
        
        <spen data-nosnippet class="column is-narrow">(Translated by ChatGPT)</span>
        
    </div>
    
    <div class="article-entry is-size-6-mobile" itemprop="articleBody">
    
        <p>After discussing the history and baggage of JavaScript, let’s talk about JavaScript itself.</p>
<p>Have you ever wondered how to know if an author of a JavaScript book or tutorial article has written it correctly? How do you know if the knowledge in the book is correct? As the title suggests, could it be that the JavaScript knowledge you previously knew was actually wrong?</p>
<p>Do you just trust the author because they often write technical articles? Or do you believe it because it’s written the same way on MDN? Or is it because everyone says it, so it must be right?</p>
<p>Some questions do not have standard answers, such as the trolley problem, where different schools of thought will have their own approved answers, and there is no saying which one is necessarily correct.</p>
<p>Fortunately, the world of programming languages is relatively simple. When we talk about JavaScript knowledge, there are two places where you can verify whether this knowledge is correct. The first is called the ECMAScript specification, and the second one, we’ll talk about later.</p>
<span id="more"></span>

<h2><span id="ecmascript">ECMAScript</span></h2><p>In 1995, JavaScript was officially launched as a programming language that could run on Netscape. If you want to ensure cross-browser support, you need a standardized specification that all browsers can follow.</p>
<p>In 1996, Netscape contacted Ecma International (European Computer Manufacturers Association) and established a new technical committee (Technical Committee). Since it was numbered sequentially using numbers, it happened to be numbered 39 at that time, which is the TC39 we are familiar with now.</p>
<p>In 1997, ECMA-262 was officially released, which is the first version of what we commonly call ECMAScript.</p>
<p>Why is it called ECMAScript instead of JavaScript? Because JavaScript had already been registered as a trademark by Sun at that time and was not available for use by the Ecma Association, so it couldn’t be called JavaScript. Therefore, this standard was later called ECMAScript.</p>
<p>As for JavaScript, you can think of it as a programming language that implements the ECMAScript specification. When you want to know the specification of a certain JavaScript feature, it’s not wrong to look at ECMAScript, and the detailed behavior will be recorded in it.</p>
<p>Standards will continue to evolve, and new standards will appear almost every year, incorporating new proposals. For example, as of the time of writing, the latest is ECMAScript 12, which was released in 2021. It is usually referred to as ES12 or ES2021. The commonly heard ES6 is also called ES2015, representing the sixth version of ECMAScript released in 2015.</p>
<p>If you are interested in the history of ECMAScript and these terms, you can refer to the following articles:</p>
<ol>
<li><a target="_blank" rel="noopener" href="https://history.js.org/part-2.html#%E5%91%BD%E5%90%8D%E6%A0%87%E5%87%86">Twenty Years of JavaScript: Standardization</a></li>
<li><a target="_blank" rel="noopener" href="https://ithelp.ithome.com.tw/articles/10213310">Day2 [JavaScript Basics] A Brief Discussion of ECMAScript and JavaScript</a></li>
<li><a target="_blank" rel="noopener" href="https://ithelp.ithome.com.tw/articles/10237660">JavaScript Journey (1): Introduction to ECMA, ECMAScript, JavaScript, and TC39</a></li>
</ol>
<p>Next, let’s take a brief look at what the ECMAScript specification looks like.</p>
<h2><span id="exploring-ecmascript">Exploring ECMAScript</span></h2><p>You can find all versions of ECMAScript on this page: <a target="_blank" rel="noopener" href="https://www.ecma-international.org/publications-and-standards/standards/ecma-262/">https://www.ecma-international.org/publications-and-standards/standards/ecma-262/</a></p>
<p>You can download the PDF directly or view the HTML version online. I would recommend downloading the PDF because the HTML seems to load all the content together, so it takes a long time to load, and there is a risk of crashing when paging.</p>
<p>When we open the ES2021 specification, we will find that it is a huge document with 879 pages. The specification is like a dictionary, it’s for you to look up, not for you to read like a storybook.</p>
<p>But as long as you can use the search function well, you can still quickly find the paragraph you want. Below, let’s take a look at the specifications of three different types of features.</p>
<h3><span id="stringprototyperepeat">String.prototype.repeat</span></h3><p>Search for “String.prototype.repeat”, and you can find the directory. Clicking on the directory will take you directly to the corresponding paragraph: <code>22.1.3.16 String.prototype.repeat</code>, which is as follows:</p>
<p><img src="/img/how-to-validate-javascript-knowledge/ecma-repeat.png"></p>
<p>You can try to read it yourself first.</p>
<p>Specifications are actually similar to programs, like pseudo code, so there are many programming concepts in them. For example, you will see many function calls above, and you need to check the definitions of other functions to understand exactly what they do. However, many functions can be inferred from their names, which shows that function naming is really important.</p>
<p>The above specification basically tells us two things that we may not have known before:</p>
<ol>
<li>If the count is negative or infinite when calling repeat, an error will occur.</li>
<li>Repeat seems to not only work with strings.</li>
</ol>
<p>The second point is actually quite important in JavaScript. In ECMAScript, you will also often see similar cases, which say “The xxx function is intentionally generic”. What does this mean?</p>
<p>Did you notice the first two steps, which are:</p>
<ol>
<li>Let O be ? RequireObjectCoercible(this value).</li>
<li>Let S be ? ToString(O).</li>
</ol>
<p>Aren’t we already dealing with strings? Why do we need to ToString again? And why is it related to this?</p>
<p>When we call <code>&quot;abc&quot;.repeat(3)</code>, we are actually calling the <code>String.prototype.repeat</code> function, and this is <code>&quot;abc&quot;</code>, so it can be considered as <code>String.prototype.repeat.call(&quot;abc&quot;, 3)</code>.</p>
<p>Since it can be converted into this call format, it means that you can also pass something that is not a string into it, for example: <code>String.prototype.repeat.call(123, 3)</code>, and it will not break, it will return <code>&quot;123123123&quot;</code>, and all of this is thanks to the extensibility of the specification definition.</p>
<p>Just now we saw in the specification that it was specially written that this function is intentionally written as generic, so it is not just strings that can be called, as long as it “can be converted into a string”, it can actually use this function. This is also why the first two steps in the specification are to convert this to a string, so that non-strings can also be used.</p>
<p>Here’s another even more interesting example:</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">a</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'hello'</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span>
<span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token class-name">String</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function">repeat</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span>
<span class="token comment">// function a()&#123;console.log('hello')&#125;function a()&#123;console.log('hello')&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>Because functions can be converted into strings, they can of course be passed into repeat, and the toString method of the function will return the entire code of the function, so we get the output we saw at the end.</p>
<p>Regarding prototype and these things above, we will talk about prototype again later.</p>
<p>In short, from the specification, we can see a feature of ECMAScript, which is deliberately making these built-in methods more extensive and applicable to various types, as long as they can be converted into strings.</p>
<h3><span id="typeof">typeof</span></h3><p>Similarly, searching for typeof in the PDF will find <code>13.5.3 The typeof Operator</code>, with the following content:</p>
<p><img src="/img/how-to-validate-javascript-knowledge/ecma-typeof.png"></p>
<p>We can see that typeof will perform some internal operations on the passed-in value, such as <code>IsUnresolvableReference</code> or <code>GetValue</code>, but usually we only care about the table below, which is what each type will return.</p>
<p>In the table, we can see two interesting things. The first thing is the famous bug, <code>typeof null</code> will return object, and this bug has become part of the specification today.</p>
<p>The second thing is that for the specification, objects and functions are actually both <code>Object</code> internally, the only difference is whether they have implemented the <code>[[Call]]</code> method.</p>
<p>In fact, if you look at other sections, you can also see that the term “function object” is used multiple times in the specification, which shows that in the specification, a function is just an object that can be called.</p>
<h3><span id="comments">Comments</span></h3><p>Next, let’s take a look at the syntax of comments. Searching for comments will find <code>12.4 Comments</code>, and below is a partial screenshot:</p>
<p><img src="/img/how-to-validate-javascript-knowledge/ecma-comment.png"></p>
<p>We can see how ECMAScript represents syntax from top to bottom. Comments are divided into two types, MultiLineComment and SingleLineComment, and there are definitions for each below. MultiLineComment is <code>/* MultiLineCommentChars */</code>, and the yellow small font “opt” means optional, which means that MultiLineCommentChars can be omitted, such as <code>/**/</code>, and the definition continues below.</p>
<p>For single-line comments, it looks like this:</p>
<p><img src="/img/how-to-validate-javascript-knowledge/ecma-comment2.png"></p>
<p>In fact, the meaning is similar to that of multi-line comments, and the last line guides us to B.1.3. Let’s take a look at the content there:</p>
<p><img src="/img/how-to-validate-javascript-knowledge/ecma-comment3.png"></p>
<p>Here, HTML-like comments are additionally defined, and it looks like all of them are valid except for some special cases.</p>
<p>We can see that the definition of comments here has been further increased by three types:</p>
<ol>
<li>SingleLineHTMLOpenComment</li>
<li>SingleLineHTMLCloseComment</li>
<li>SingleLineDelimitedComment</li>
</ol>
<p>From the specification, we can get new cold knowledge, which is that single-line comments not only have <code>//</code>, but also HTML comments can be used:</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span> 我是註解
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>

<span class="token comment">// 我也是</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>

<span class="token operator">--</span><span class="token operator">></span> 我也是
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>This is a JavaScript cold knowledge that can only be seen from the specification.</p>
<p>When someone tells you that JavaScript comments only have <code>//</code> and <code>/* */</code>, if you have read the ECMAScript specification, you will know that what they are saying is wrong, and there is more than that.</p>
<p>The above are the three small paragraphs we found from ECMAScript, mainly to let everyone take a look at what the specification looks like.</p>
<p>If you are interested in reading the specification, I would recommend that you first read the ES3 specification, because ES3 is much more complete than the previous two versions, and the number of pages is small, only 188 pages, which can be read like a general book, one page at a time.</p>
<p>Although the wording and underlying mechanisms of the specification have changed somewhat since ES6, I think it is still good to start with ES3 to get familiar with the specification with minimal effort.</p>
<p>If you are interested in reading the specification and want to study it carefully, you can refer to the following two articles:</p>
<ol>
<li><a target="_blank" rel="noopener" href="https://dwatow.github.io/2021/05-08-how-to-read-ecma-262-zh-tw/">Translation: How to read the ECMAScript Specification in Chinese</a></li>
<li><a target="_blank" rel="noopener" href="https://v8.dev/blog/tags/understanding-ecmascript">V8 blog - Understanding ECMAScript</a></li>
</ol>
<p>We mentioned earlier that there are two places where you can verify whether your JavaScript knowledge is correct. The first is the ECMAScript specification, and the second is something you should think about first.</p>
<p>Now it’s time to reveal the answer, and that is: “JavaScript engine source code.”</p>
<h2><span id="talking-about-javascript-engine-source-code">Talking about JavaScript engine source code</span></h2><p>The ECMAScript specification defines how a programming language “should” be, but in fact, how it is actually implemented belongs to the “implementation” part. It’s like a PM defining a product specification, but an engineer may miss something and cause implementation errors, or may not be able to fully comply with the specification for various reasons, resulting in some differences.</p>
<p>So if you find a strange phenomenon in Chrome and find that the behavior is different from the ECMAScript specification, it is very likely that the implementation of the JavaScript engine in Chrome is actually different from the specification, which leads to this difference.</p>
<p>The specification is just a specification, and in the end, we still have to look at the implementation of the engine.</p>
<p>In the case of Chrome, it uses a JavaScript engine called V8 behind the scenes. If you know nothing about JS engines, you can first watch this video: <a target="_blank" rel="noopener" href="https://www.youtube.com/watch?v=p-iiEDtpy6I">Franziska Hinkelmann: JavaScript engines - how do they even? | JSConf EU</a>.</p>
<p>And if you want to see the V8 code, you can see the official version: <a target="_blank" rel="noopener" href="https://chromium.googlesource.com/v8/v8.git">https://chromium.googlesource.com/v8/v8.git</a>, or you can see this version on GitHub: <a target="_blank" rel="noopener" href="https://github.com/v8/v8">https://github.com/v8/v8</a></p>
<p>When reading the ECMAScript specification, we looked at three different functions. Let’s take a look at how these functions are implemented in V8.</p>
<h3><span id="stringprototyperepeat">String.prototype.repeat</span></h3><p>In V8, there is a programming language called Torque, which was born to make it easier to implement the logic in ECMAScript. The syntax is similar to TypeScript. For details, please refer to: <a target="_blank" rel="noopener" href="https://v8.dev/docs/torque">V8 Torque user manual</a></p>
<p>The relevant code for <code>String.prototype.repeat</code> is here: <a target="_blank" rel="noopener" href="https://chromium.googlesource.com/v8/v8.git/+/refs/tags/10.0.51/src/builtins/string-repeat.tq">src&#x2F;builtins&#x2F;string-repeat.tq</a></p>
<pre class="line-numbers language-typescript" data-language="typescript"><code class="language-typescript"><span class="token comment">// https://tc39.github.io/ecma262/#sec-string.prototype.repeat</span>
transitioning javascript builtin <span class="token function">StringPrototypeRepeat</span><span class="token punctuation">(</span>
    js<span class="token operator">-</span>implicit context<span class="token operator">:</span> NativeContext<span class="token punctuation">,</span> receiver<span class="token operator">:</span> JSAny<span class="token punctuation">)</span><span class="token punctuation">(</span>count<span class="token operator">:</span> JSAny<span class="token punctuation">)</span><span class="token operator">:</span> String <span class="token punctuation">&#123;</span>
  <span class="token comment">// 1. Let O be ? RequireObjectCoercible(this value).</span>
  <span class="token comment">// 2. Let S be ? ToString(O).</span>
  <span class="token keyword">const</span> s<span class="token operator">:</span> String <span class="token operator">=</span> <span class="token function">ToThisString</span><span class="token punctuation">(</span>receiver<span class="token punctuation">,</span> kBuiltinName<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 3. Let n be ? ToInteger(count).</span>
    <span class="token function">typeswitch</span> <span class="token punctuation">(</span><span class="token function">ToInteger_Inline</span><span class="token punctuation">(</span>count<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">case</span> <span class="token punctuation">(</span>n<span class="token operator">:</span> Smi<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 4. If n &lt; 0, throw a RangeError exception.</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>n <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> goto InvalidCount<span class="token punctuation">;</span>
        <span class="token comment">// 6. If n is 0, return the empty String.</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>n <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">||</span> s<span class="token punctuation">.</span>length_uint32 <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> goto EmptyString<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>n <span class="token operator">></span> kStringMaxLength<span class="token punctuation">)</span> goto InvalidStringLength<span class="token punctuation">;</span>
        <span class="token comment">// 7. Return the String value that is made from n copies of S appended</span>
        <span class="token comment">// together.</span>
        <span class="token keyword">return</span> <span class="token function">StringRepeat</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> n<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>
      <span class="token keyword">case</span> <span class="token punctuation">(</span>heapNum<span class="token operator">:</span> HeapNumber<span class="token punctuation">)</span><span class="token operator">:</span> deferred <span class="token punctuation">&#123;</span>
        <span class="token function">dcheck</span><span class="token punctuation">(</span><span class="token function">IsNumberNormalized</span><span class="token punctuation">(</span>heapNum<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">const</span> n <span class="token operator">=</span> <span class="token function">LoadHeapNumberValue</span><span class="token punctuation">(</span>heapNum<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 4. If n &lt; 0, throw a RangeError exception.</span>
        <span class="token comment">// 5. If n is +∞, throw a RangeError exception.</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>n <span class="token operator">==</span> <span class="token constant">V8_INFINITY</span> <span class="token operator">||</span> n <span class="token operator">&lt;</span> <span class="token number">0.0</span><span class="token punctuation">)</span> goto InvalidCount<span class="token punctuation">;</span>
        <span class="token comment">// 6. If n is 0, return the empty String.</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>s<span class="token punctuation">.</span>length_uint32 <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> goto EmptyString<span class="token punctuation">;</span>
        goto InvalidStringLength<span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span> label EmptyString <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> kEmptyString<span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span> label InvalidCount deferred <span class="token punctuation">&#123;</span>
    <span class="token function">ThrowRangeError</span><span class="token punctuation">(</span>MessageTemplate<span class="token operator">:</span><span class="token operator">:</span>kInvalidCountValue<span class="token punctuation">,</span> count<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span> label InvalidStringLength deferred <span class="token punctuation">&#123;</span>
    <span class="token function">ThrowInvalidStringLength</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>As you can see, the comment is actually the content of the specification, and the code directly translates the specification. The actual implementation of the <code>repeat</code> function is as follows:</p>
<pre class="line-numbers language-typescript" data-language="typescript"><code class="language-typescript">builtin <span class="token function">StringRepeat</span><span class="token punctuation">(</span>implicit context<span class="token operator">:</span> Context<span class="token punctuation">)</span><span class="token punctuation">(</span>
    <span class="token builtin">string</span><span class="token operator">:</span> String<span class="token punctuation">,</span> count<span class="token operator">:</span> Smi<span class="token punctuation">)</span><span class="token operator">:</span> String <span class="token punctuation">&#123;</span>
  <span class="token function">dcheck</span><span class="token punctuation">(</span>count <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">dcheck</span><span class="token punctuation">(</span><span class="token builtin">string</span> <span class="token operator">!=</span> kEmptyString<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> result<span class="token operator">:</span> String <span class="token operator">=</span> kEmptyString<span class="token punctuation">;</span>
  <span class="token keyword">let</span> powerOfTwoRepeats<span class="token operator">:</span> String <span class="token operator">=</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> n<span class="token operator">:</span> intptr <span class="token operator">=</span> <span class="token generic-function"><span class="token function">Convert</span><span class="token generic class-name"><span class="token operator">&lt;</span>intptr<span class="token operator">></span></span></span><span class="token punctuation">(</span>count<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>n <span class="token operator">&amp;</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> result <span class="token operator">=</span> result <span class="token operator">+</span> powerOfTwoRepeats<span class="token punctuation">;</span>
    n <span class="token operator">=</span> n <span class="token operator">>></span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>n <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">break</span><span class="token punctuation">;</span>
    powerOfTwoRepeats <span class="token operator">=</span> powerOfTwoRepeats <span class="token operator">+</span> powerOfTwoRepeats<span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  <span class="token keyword">return</span> result<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>From here, we can see an interesting detail, which is that when repeating, it is not simply running a loop from 1 to n and then copying n times. This is too slow. Instead, it uses the <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Exponentiation_by_squaring">square and multiply algorithm</a>.</p>
<p>For example, if we want to generate <code>&#39;a&#39;.repeat(8)</code>, the usual method requires 7 additions, but we can first add once to generate <code>aa</code>, then add each other to generate <code>aaaa</code>, and finally add each other once more to get 8 repetitions using three additions (<code>2^3 = 8</code>), saving a lot of string concatenation operations.</p>
<p>From this, we can see that low-level implementations like JavaScript engines must also consider performance.</p>
<h3><span id="typeof">typeof</span></h3><p>The definition of <code>typeof</code> in V8 is here, and the comment also mentions the relevant spec section: <a target="_blank" rel="noopener" href="https://chromium.googlesource.com/v8/v8.git/+/refs/tags/10.0.51/src/objects/objects.h#466">src&#x2F;objects&#x2F;objects.h#466</a></p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">// ES6 section 12.5.6 The typeof Operator</span>
<span class="token keyword">static</span> Handle<span class="token operator">&lt;</span>String<span class="token operator">></span> <span class="token function">TypeOf</span><span class="token punctuation">(</span>Isolate<span class="token operator">*</span> isolate<span class="token punctuation">,</span> Handle<span class="token operator">&lt;</span>Object<span class="token operator">></span> object<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>The implementation is here: <a target="_blank" rel="noopener" href="https://chromium.googlesource.com/v8/v8.git/+/refs/tags/10.0.51/src/objects/objects.cc#870">src&#x2F;objects&#x2F;objects.cc#870</a></p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">// static</span>
Handle<span class="token operator">&lt;</span>String<span class="token operator">></span> Object<span class="token operator">::</span><span class="token function">TypeOf</span><span class="token punctuation">(</span>Isolate<span class="token operator">*</span> isolate<span class="token punctuation">,</span> Handle<span class="token operator">&lt;</span>Object<span class="token operator">></span> object<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>object<span class="token operator">-></span><span class="token function">IsNumber</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> isolate<span class="token operator">-></span><span class="token function">factory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">number_string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>object<span class="token operator">-></span><span class="token function">IsOddball</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token function">handle</span><span class="token punctuation">(</span>Oddball<span class="token operator">::</span><span class="token function">cast</span><span class="token punctuation">(</span><span class="token operator">*</span>object<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">type_of</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> isolate<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>object<span class="token operator">-></span><span class="token function">IsUndetectable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> isolate<span class="token operator">-></span><span class="token function">factory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">undefined_string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>object<span class="token operator">-></span><span class="token function">IsString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> isolate<span class="token operator">-></span><span class="token function">factory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">string_string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>object<span class="token operator">-></span><span class="token function">IsSymbol</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> isolate<span class="token operator">-></span><span class="token function">factory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">symbol_string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>object<span class="token operator">-></span><span class="token function">IsBigInt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> isolate<span class="token operator">-></span><span class="token function">factory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">bigint_string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>object<span class="token operator">-></span><span class="token function">IsCallable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> isolate<span class="token operator">-></span><span class="token function">factory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">function_string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> isolate<span class="token operator">-></span><span class="token function">factory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">object_string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>As you can see, it checks for various types.</p>
<p>Some people may be curious about what Oddball is. <code>null</code>, <code>undefined</code>, <code>true</code>, and <code>false</code> are all stored using this type. I’m not sure of the exact reason, but if you want to delve deeper, you can refer to:</p>
<ol>
<li><a target="_blank" rel="noopener" href="https://github.com/danbev/learning-v8#oddball">Learning Google V8</a></li>
<li><a target="_blank" rel="noopener" href="https://www.davepacheco.net/blog/post/2012-01-13-playing-with-nodev8-postmortem-debugging/">Playing with Node&#x2F;V8 postmortem debugging</a></li>
<li><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/39951011">V8源码边缘试探-黑魔法指针偏移</a></li>
</ol>
<p>But if Oddball already includes <code>undefined</code>, why is there still a check below that also returns undefined? What is this <code>undetectable</code>?</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">if</span> <span class="token punctuation">(</span>object<span class="token operator">-></span><span class="token function">IsUndetectable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">return</span> isolate<span class="token operator">-></span><span class="token function">factory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">undefined_string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>All of this is due to historical baggage.</p>
<p>In the era when IE was prevalent, there was an IE-specific API called <code>document.all</code>, which could be used to get the specified element with <code>document.all(&#39;a&#39;)</code>. At that time, there was also a popular way to detect whether the browser was IE:</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">var</span> isIE <span class="token operator">=</span> <span class="token operator">!</span><span class="token operator">!</span>document<span class="token punctuation">.</span>all
<span class="token keyword">if</span> <span class="token punctuation">(</span>isIE<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
 <span class="token comment">// 呼叫 IE 才有的 API</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>Later, Opera also followed suit and implemented <code>document.all</code>, but ran into a problem. Since it had implemented the IE-specific functionality, if a website used the above method to detect IE, it would be judged as IE. However, Opera did not have those IE-specific APIs, so the webpage would crash with an execution error.</p>
<p>Firefox learned from Opera’s story when implementing this feature. Although it implemented the functionality of <code>document.all</code>, it did some tricks to prevent it from being detected:</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">typeof</span> document<span class="token punctuation">.</span>all <span class="token comment">// undefined</span>
<span class="token operator">!</span><span class="token operator">!</span>document<span class="token punctuation">.</span>all <span class="token comment">// false</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>That is, <code>typeof document.all</code> must be forced to return <code>undefined</code>, and when converted to a boolean, it must also return <code>false</code>. It’s really a master workaround.</p>
<p>Later, other browsers followed this implementation, and this implementation even became part of the standard, appearing in <code>B.3.7 The [[IsHTMLDDA]] Internal Slot</code>.</p>
<p><img src="/img/how-to-validate-javascript-knowledge/ecma-document-all.png"></p>
<p>The IsUndetectable we see in V8 is generated to implement this mechanism. You can see it very clearly in the comments, and the code is in <a target="_blank" rel="noopener" href="https://chromium.googlesource.com/v8/v8.git/+/refs/tags/10.0.51/src/objects/map.h#391">src&#x2F;objects&#x2F;map.h#391</a>:</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// Tells whether the instance is undetectable.</span>
<span class="token comment">// An undetectable object is a special class of JSObject: 'typeof' operator</span>
<span class="token comment">// returns undefined, ToBoolean returns false. Otherwise it behaves like</span>
<span class="token comment">// a normal JS object.  It is useful for implementing undetectable</span>
<span class="token comment">// document.all in Firefox &amp; Safari.</span>
<span class="token comment">// See https://bugzilla.mozilla.org/show_bug.cgi?id=248549.</span>
<span class="token constant">DECL_BOOLEAN_ACCESSORS</span><span class="token punctuation">(</span>is_undetectable<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>At this point, you might want to open Chrome devtool and play with <code>document.all</code> to experience this historical baggage.</p>
<p>Chrome also had a bug because of this historical baggage. You can refer to <a target="_blank" rel="noopener" href="https://programmerall.com/article/5623928123/">What is the bug of V8’s typeof null returning “undefined”</a> for the relevant story. The above paragraph is also written based on this article.</p>
<h3><span id="comments">Comments</span></h3><p>As mentioned earlier, JavaScript actually has several little-known comment formats, such as <code>&lt;!--</code> and <code>--&gt;</code>. Regarding the syntax in V8, you can refer to this file: <a target="_blank" rel="noopener" href="https://github.com/v8/v8/blob/master/src/parsing/scanner-inl.h">&#x2F;src&#x2F;parsing&#x2F;scanner-inl.h</a>. We extract a few paragraphs:</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">case</span> Token<span class="token operator">::</span>LT<span class="token operator">:</span>
  <span class="token comment">// &lt; &lt;= &lt;&lt; &lt;&lt;= &lt;!--</span>
  <span class="token function">Advance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>c0_ <span class="token operator">==</span> <span class="token char">'='</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token function">Select</span><span class="token punctuation">(</span>Token<span class="token operator">::</span>LTE<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>c0_ <span class="token operator">==</span> <span class="token char">'&lt;'</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token function">Select</span><span class="token punctuation">(</span><span class="token char">'='</span><span class="token punctuation">,</span> Token<span class="token operator">::</span>ASSIGN_SHL<span class="token punctuation">,</span> Token<span class="token operator">::</span>SHL<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>c0_ <span class="token operator">==</span> <span class="token char">'!'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    token <span class="token operator">=</span> <span class="token function">ScanHtmlComment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">continue</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  <span class="token keyword">return</span> Token<span class="token operator">::</span>LT<span class="token punctuation">;</span>

<span class="token keyword">case</span> Token<span class="token operator">::</span>SUB<span class="token operator">:</span>
  <span class="token comment">// - -- --> -=</span>
  <span class="token function">Advance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>c0_ <span class="token operator">==</span> <span class="token char">'-'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token function">Advance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>c0_ <span class="token operator">==</span> <span class="token char">'>'</span> <span class="token operator">&amp;&amp;</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>after_line_terminator<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token comment">// For compatibility with SpiderMonkey, we skip lines that</span>
      <span class="token comment">// start with an HTML comment end '-->'.</span>
      token <span class="token operator">=</span> <span class="token function">SkipSingleHTMLComment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">continue</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">return</span> Token<span class="token operator">::</span>DEC<span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>c0_ <span class="token operator">==</span> <span class="token char">'='</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token function">Select</span><span class="token punctuation">(</span>Token<span class="token operator">::</span>ASSIGN_SUB<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> Token<span class="token operator">::</span>SUB<span class="token punctuation">;</span>

<span class="token keyword">case</span> Token<span class="token operator">::</span>DIV<span class="token operator">:</span>
  <span class="token comment">// /  // /* /=</span>
  <span class="token function">Advance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>c0_ <span class="token operator">==</span> <span class="token char">'/'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    base<span class="token operator">::</span>uc32 c <span class="token operator">=</span> <span class="token function">Peek</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>c <span class="token operator">==</span> <span class="token char">'#'</span> <span class="token operator">||</span> c <span class="token operator">==</span> <span class="token char">'@'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token function">Advance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">Advance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      token <span class="token operator">=</span> <span class="token function">SkipSourceURLComment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">continue</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    token <span class="token operator">=</span> <span class="token function">SkipSingleLineComment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">continue</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>c0_ <span class="token operator">==</span> <span class="token char">'*'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    token <span class="token operator">=</span> <span class="token function">SkipMultiLineComment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">continue</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>c0_ <span class="token operator">==</span> <span class="token char">'='</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token function">Select</span><span class="token punctuation">(</span>Token<span class="token operator">::</span>ASSIGN_DIV<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> Token<span class="token operator">::</span>DIV<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>If you encounter <code>&lt;!</code>, call <code>ScanHtmlComment</code>.</p>
<p>If you encounter <code>--&gt;</code> and it is at the beginning, call <code>SkipSingleHTMLComment</code>. This paragraph also tells us one thing, that <code>--&gt;</code> must be at the beginning, otherwise it will cause an error (here the beginning refers to no other meaningful statement before it, but spaces and comments are allowed).</p>
<p>If you encounter <code>//</code>, check if it is followed by <code>#</code> or <code>@</code>. If so, call <code>SkipSourceURLComment</code>. This is actually the syntax of source map. For details, please refer to <a target="_blank" rel="noopener" href="https://developers.google.com/web/updates/2013/06/sourceMappingURL-and-sourceURL-syntax-changed">sourceMappingURL and sourceURL syntax changed</a> and <a target="_blank" rel="noopener" href="https://blog.techbridge.cc/2021/03/28/how-source-map-works/">How source map works</a>.</p>
<p>Otherwise, call <code>SkipSingleLineComment</code>.</p>
<p>If it is <code>/*</code>, call <code>SkipMultiLineComment</code>.</p>
<p>The corresponding functions called above are all in <a target="_blank" rel="noopener" href="https://github.com/v8/v8/blob/master/src/parsing/scanner.cc">src&#x2F;parsing&#x2F;scanner.cc</a>. Let’s take a more interesting one, <code>ScanHtmlComment</code>, which will be called when encountering <code>&lt;!</code>:</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">Token<span class="token operator">::</span>Value Scanner<span class="token operator">::</span><span class="token function">ScanHtmlComment</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token comment">// Check for &lt;!-- comments.</span>
  <span class="token function">DCHECK_EQ</span><span class="token punctuation">(</span>c0_<span class="token punctuation">,</span> <span class="token char">'!'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">Advance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>c0_ <span class="token operator">!=</span> <span class="token char">'-'</span> <span class="token operator">||</span> <span class="token function">Peek</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token char">'-'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token function">PushBack</span><span class="token punctuation">(</span><span class="token char">'!'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// undo Advance()</span>
    <span class="token keyword">return</span> Token<span class="token operator">::</span>LT<span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  <span class="token function">Advance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  found_html_comment_ <span class="token operator">=</span> true<span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token function">SkipSingleHTMLComment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>Here, it will continue to look down and see if it is <code>--</code>. If not, it will undo the operation and return <code>Token::LT</code>, which is <code>&lt;</code>. Otherwise, call <code>SkipSingleHTMLComment</code>.</p>
<p>The code for <code>SkipSingleHTMLComment</code> is also very simple:</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">Token<span class="token operator">::</span>Value Scanner<span class="token operator">::</span><span class="token function">SkipSingleHTMLComment</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>flags_<span class="token punctuation">.</span><span class="token function">is_module</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token function">ReportScannerError</span><span class="token punctuation">(</span><span class="token function">source_pos</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> MessageTemplate<span class="token operator">::</span>kHtmlCommentInModule<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> Token<span class="token operator">::</span>ILLEGAL<span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  <span class="token keyword">return</span> <span class="token function">SkipSingleLineComment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>According to the specification, check if <code>flags_.is_module()</code> is true. If so, throw an error. If you want to reproduce this situation, you can create a <code>test.mjs</code> file, use <code>&lt;!--</code> as a comment, and run it with Node.js to get an error:</p>
<pre class="line-numbers language-none"><code class="language-none">&lt;!-- 我是註解
   ^

SyntaxError: HTML comments are not allowed in modules<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>And <code>&lt;!--</code> can also cause a fun phenomenon. Most of the time, whether there are spaces between operators does not affect the result, for example, <code>a+b&gt;3</code> and <code>a + b &gt; 3</code> have the same result. But because <code>&lt;!--</code> is a complete syntax, so:</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token number">1</span>
<span class="token keyword">var</span> b <span class="token operator">=</span> <span class="token number">0</span> <span class="token operator">&lt;</span> <span class="token operator">!</span><span class="token operator">--</span>a 
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span> <span class="token comment">// 0</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span> <span class="token comment">// true</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>The execution process is to first <code>--a</code>, make a 0, then <code>!</code> to make it 1, and then <code>0 &lt; 1</code> is true, so b is true.</p>
<p>But if you change <code>&lt; !--</code> to <code>&lt;!--</code>:</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token number">1</span>
<span class="token keyword">var</span> b <span class="token operator">=</span> <span class="token number">0</span> <span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span>a 
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span> <span class="token comment">// 1</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span> <span class="token comment">// 0</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>Then there is no operation, because everything after <code>&lt;!--</code> is a comment. So it’s just <code>var a = 1</code> and <code>var b = 0</code>.</p>
<p>By the way, when searching for implementation code, it is not easy to find what you are looking for in the vast sea of code. I’ll share a method I use, which is to use Google. You can directly search for keywords or use filters to search for code, like this: <code>typeof inurl:https://chromium.googlesource.com/v8/v8.git</code>.</p>
<p>If the code is on GitHub, you can also use this very useful website called <a target="_blank" rel="noopener" href="https://grep.app/search?q=typeof&filter%5Brepo%5D%5B0%5D=v8/v8">grep.app</a> to search for content in a specified GitHub repo.</p>
<h2><span id="conclusion">Conclusion</span></h2><p>When you obtain knowledge about JavaScript from anywhere (including this article), it may not necessarily be correct.</p>
<p>If you want to confirm, there are two levels to verify whether this knowledge is correct. The first level is “whether it conforms to the ECMAScript specification”, which can be achieved by finding the corresponding paragraph in ECMAScript. If I refer to ECMAScript in my article, I will try to attach the reference paragraph to facilitate everyone to verify it themselves.</p>
<p>The second level is “whether it conforms to the implementation of the JavaScript engine”, because sometimes the implementation may not be consistent with the specification, and there may be time issues, such as being included in the specification but not yet implemented, or even the other way around.</p>
<p>In fact, there is not only one JavaScript engine, and Firefox uses another engine called <a target="_blank" rel="noopener" href="https://spidermonkey.dev/">SpiderMonkey</a> which is different from V8.</p>
<p>If you want to try reading the specification after reading this article, but don’t know where to start, I’ll give you a question to find the answer from the specification: “Assuming <code>s</code> is any string, are <code>s.toUpperCase().toLowerCase()</code> and <code>s.toLowerCase()</code> always equal? If not, please give a counterexample.”</p>

    
    </div>
    
    <div class="columns is-variable is-1 is-multiline is-mobile">
    
        <span class="column is-narrow"><a class="tag is-light article-tag" href="/en/tags/JavaScript/">#JavaScript</a></span>
    
    </div>
    
    
    <div class="columns is-mobile is-multiline article-nav">
        <span class="column is-12-mobile is-half-desktop  article-nav-prev">
            
            <a href="/2022/02/02/en/origin-trials-try-new-feature/">Trying out new features with Chrome Origin Trials</a>
            
        </span>
        <span class="column is-12-mobile is-half-desktop  article-nav-next">
            
            <a href="/2022/01/19/en/sql-injection-in-action/">SQL injection in action: Speeding up under restrictions</a>
            
        </span>
    </div>
    
</article>




<div class="comments">
    <h3 class="title is-4">Comments</h3>
    <script src="https://utteranc.es/client.js"
        repo="aszx87410/huli-blog"
        issue-term="title"
        theme="github-light"
        crossorigin="anonymous"
        async>
</script>
</div>

    </div>
</section>
    <footer class="footer">
    <div class="container">
        <div class="columns content">
            <div class="column is-narrow has-text-centered">
                &copy; 2023 Huli&nbsp;
                Powered by <a href="http://hexo.io/" target="_blank">Hexo</a> & <a
                        target="_blank" rel="noopener" href="http://github.com/ppoffice/hexo-theme-minos">Minos</a>
            </div>
            <div class="column is-hidden-mobile"></div>

            
            <div class="column is-narrow">
                <div class="columns is-mobile is-multiline is-centered">
                
                    
                <a class="column is-narrow" title="GitHub" target="_blank" rel="noopener" href="https://github.com/ppoffice/hexo-theme-minos">
                    
                    GitHub
                    
                </a>
                
                </div>
            </div>
            
            
<div class="column is-narrow has-text-centered">
    <div class="dropdown is-up is-right is-hoverable" style="margin-top: -0.2em;">
        <div class="dropdown-trigger">
            <button class="button is-small" aria-haspopup="true">
                <span class="icon">
                    <i class="fas fa-globe"></i>
                </span>
                <span>English</span>
                <span class="icon is-small">
            <i class="fas fa-angle-down" aria-hidden="true"></i>
          </span>
            </button>
        </div>
        <div class="dropdown-menu has-text-left" role="menu" style="top:100%">
            <div class="dropdown-content">
            <!-- NOTE: 永遠回到首頁 -->
            
                <a href="/2022/01/30/how-to-validate-javascript-knowledge/" class="dropdown-item">
                    繁體中文
                </a>
            
            </div>
        </div>
    </div>
</div>

        </div>
    </div>
</footer>
    <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/3.6.3/jquery.min.js"></script>



    
    
    
    
    
    
<script src="//cdnjs.cloudflare.com/ajax/libs/lightgallery/1.6.8/js/lightgallery-all.min.js"></script>
<script>
    (function ($) {
        $(document).ready(function () {
            if (typeof($.fn.lightGallery) === 'function') {
                $('.article.gallery').lightGallery({ selector: '.gallery-item' });
            }
        });
    })(jQuery);
</script>

    
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.0/clipboard.min.js"></script>
    <style>
        .hljs {
            position: relative;
        }

        .hljs .clipboard-btn {
            float: right;
            color: #9a9a9a;
            background: none;
            border: none;
            cursor: pointer;
        }

        .hljs .clipboard-btn:hover {
          color: #8a8a8a;
        }

        .hljs > .clipboard-btn {
            display: none;
            position: absolute;
            right: 4px;
            top: 4px;
        }

        .hljs:hover > .clipboard-btn {
            display: inline;
        }

        .hljs > figcaption > .clipboard-btn {
            margin-right: 4px;
        }
    </style>
    <script>
      $(document).ready(function () {
        $('figure.hljs').each(function(i, figure) {
          var codeId = 'code-' + i;
          var code = figure.querySelector('.code');
          var copyButton = $('<button>Copy <i class="far fa-clipboard"></i></button>');
          code.id = codeId;
          copyButton.addClass('clipboard-btn');
          copyButton.attr('data-clipboard-target-id', codeId);

          var figcaption = figure.querySelector('figcaption');

          if (figcaption) {
            figcaption.append(copyButton[0]);
          } else {
            figure.prepend(copyButton[0]);
          }
        })

        var clipboard = new ClipboardJS('.clipboard-btn', {
          target: function(trigger) {
            return document.getElementById(trigger.getAttribute('data-clipboard-target-id'));
          }
        });
        clipboard.on('success', function(e) {
          e.clearSelection();
        })
      })
    </script>

    
    

    



<script src="/js/script.js?v=3.js"></script>


    
</body>
</html>