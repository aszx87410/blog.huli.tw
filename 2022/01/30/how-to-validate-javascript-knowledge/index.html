<!DOCTYPE html>
<html class="has-navbar-fixed-top" lang="zh-tw">
<head>
    <meta charset="utf-8">
<title>你知道的 JavaScript 知識都有可能是錯的 - Huli&#39;s blog</title>
<meta name="viewport" content="width=device-width, initial-scale=1">



            
<link href="https://blog.huli.tw/2022/01/30/en/how-to-validate-javascript-knowledge/" rel="alternate" hreflang="en" />
            
    




    
<link rel="canonical" href="https://blog.huli.tw/2022/01/30/how-to-validate-javascript-knowledge/">
    





    <meta name="description" content="談完了 JavaScript 的歷史以及包袱以後，我們來談談 JavaScript 本身。 不知道大家有沒有想過一個問題，當你看到一本 JavaScript 書籍或是教學文章的時候，你要怎麼知道作者沒有寫錯？要怎麼知道書裡講的知識是正確的？就如同標題所說，會不會你以前知道的 JavaScript 知識其實是錯的？ 因為作者常寫技術文章，所以就相信他嗎？還是說看到 MDN 上面也是這樣寫，因此就信了">
<meta property="og:type" content="article">
<meta property="og:title" content="你知道的 JavaScript 知識都有可能是錯的">
<meta property="og:url" content="https://blog.huli.tw/2022/01/30/how-to-validate-javascript-knowledge/index.html">
<meta property="og:site_name" content="Huli&#39;s blog">
<meta property="og:description" content="談完了 JavaScript 的歷史以及包袱以後，我們來談談 JavaScript 本身。 不知道大家有沒有想過一個問題，當你看到一本 JavaScript 書籍或是教學文章的時候，你要怎麼知道作者沒有寫錯？要怎麼知道書裡講的知識是正確的？就如同標題所說，會不會你以前知道的 JavaScript 知識其實是錯的？ 因為作者常寫技術文章，所以就相信他嗎？還是說看到 MDN 上面也是這樣寫，因此就信了">
<meta property="og:locale" content="zh_TW">
<meta property="og:image" content="https://blog.huli.tw/img/how-to-validate-javascript-knowledge/ecma-repeat.png">
<meta property="og:image" content="https://blog.huli.tw/img/how-to-validate-javascript-knowledge/ecma-typeof.png">
<meta property="og:image" content="https://blog.huli.tw/img/how-to-validate-javascript-knowledge/ecma-comment.png">
<meta property="og:image" content="https://blog.huli.tw/img/how-to-validate-javascript-knowledge/ecma-comment2.png">
<meta property="og:image" content="https://blog.huli.tw/img/how-to-validate-javascript-knowledge/ecma-comment3.png">
<meta property="og:image" content="https://blog.huli.tw/img/how-to-validate-javascript-knowledge/ecma-document-all.png">
<meta property="article:published_time" content="2022-01-30T09:32:14.000Z">
<meta property="article:modified_time" content="2023-05-07T01:15:16.482Z">
<meta property="article:author" content="Huli">
<meta property="article:tag" content="JavaScript">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://blog.huli.tw/img/how-to-validate-javascript-knowledge/ecma-repeat.png">



<link rel="alternative" href="/atom.xml" title="你知道的 JavaScript 知識都有可能是錯的" type="application/atom+xml">



<link rel="icon" href="/img/lidemy_logo.png">


<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Ovo|Source+Code+Pro">


<link rel="stylesheet" href="/css/bulma.css?v=2.css">



<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/lightgallery/1.6.8/css/lightgallery.min.css">


<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/line-numbers/prism-line-numbers.min.css" />


<link rel="stylesheet" href="/css/style.css?v=4.css">





    
    
    
    
    
    
    
    
    
    
<script async src="https://www.googletagmanager.com/gtag/js?id=G-1393J2EVCZ"></script>
<script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-1393J2EVCZ');
</script>


    


<meta name="generator" content="Hexo 6.3.0"></head>
<body>
    <script>
        if (localStorage.getItem('dark-mode')) {
            if (localStorage.getItem('dark-mode') === 'true') {
                document.body.classList.add('dark-mode')
            }
        } else {
            if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                document.body.classList.add('dark-mode')
            }
        }
    </script>
    
<nav class="navbar is-transparent is-fixed-top navbar-main" role="navigation" aria-label="main navigation">
    <div class="container">
        <div class="navbar-brand">
            <a class="navbar-item navbar-logo" href="/">
                
                    
                    Huli&#39;s blog
                    
                
            </a>
            <div class="navbar-burger">
                <span></span>
                <span></span>
                <span></span>
            </div>
        </div>
        
        <div class="navbar-menu navbar-start">
            
            <a class="navbar-item "
               href="/archives">文章列表</a>
            
            <a class="navbar-item "
               href="/categories">分類</a>
            
            <a class="navbar-item "
               href="/recommend">推薦閱讀</a>
            
            <a class="navbar-item "
               href="/about">關於我</a>
            
        </div>
        
        <div class="navbar-menu navbar-end">
            
            
            <div class="navbar-item is-hoverable has-dropdown is-hidden-mobile is-hidden-tablet-only toc">
                <a class="navbar-item" title="目錄">
                    目錄
                </a>
                <div class="navbar-dropdown">
                    
                    
                    
                    
                    <a class="navbar-item" href="#ecmascript">1&nbsp;&nbsp;<b>ECMAScript</b></a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#初探-ecmascript">2&nbsp;&nbsp;<b>初探 ECMAScript</b></a>
                    
                    
                    
                    <a class="navbar-item" href="#stringprototyperepeat">2.1&nbsp;&nbsp;String.prototype.repeat</a>
                    
                    
                    
                    <a class="navbar-item" href="#typeof">2.2&nbsp;&nbsp;typeof</a>
                    
                    
                    
                    <a class="navbar-item" href="#comments">2.3&nbsp;&nbsp;Comments</a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#淺談-javascript-引擎原始碼">3&nbsp;&nbsp;<b>淺談 JavaScript 引擎原始碼</b></a>
                    
                    
                    
                    <a class="navbar-item" href="#stringprototyperepeat">3.1&nbsp;&nbsp;String.prototype.repeat</a>
                    
                    
                    
                    <a class="navbar-item" href="#typeof">3.2&nbsp;&nbsp;typeof</a>
                    
                    
                    
                    <a class="navbar-item" href="#comments">3.3&nbsp;&nbsp;Comments</a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#結語">4&nbsp;&nbsp;<b>結語</b></a>
                    
                </div>
            </div>
            
            
            <a class="navbar-item" target="_blank" title="Medium" href="https://hulitw.medium.com/">
                
                <i class="fab fa-medium"></i>
                
            </a>
               
            <a class="navbar-item" target="_blank" title="Facebook" href="https://www.facebook.com/huli.blog">
                
                <i class="fab fa-facebook"></i>
                
            </a>
               
            <a class="navbar-item" target="_blank" title="RSS" href="/atom-ch.xml">
                
                <i class="fas fa-rss"></i>
                
            </a>
               
            
            <a class="navbar-item btn-dark-mode" title="dark-mode" href="#">
                <div>
                    <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" width="15" height="15" viewBox="0 0 256 256" xml:space="preserve">
                    <defs>
                    </defs>
                    <g style="stroke: none; stroke-width: 0; stroke-dasharray: none; stroke-linecap: butt; stroke-linejoin: miter; stroke-miterlimit: 10; fill: none; fill-rule: nonzero; opacity: 1;" transform="translate(1.4065934065934016 1.4065934065934016) scale(2.81 2.81)" >
                        <path d="M 87.823 60.7 c -0.463 -0.423 -1.142 -0.506 -1.695 -0.214 c -15.834 8.398 -35.266 2.812 -44.232 -12.718 c -8.966 -15.53 -4.09 -35.149 11.101 -44.665 c 0.531 -0.332 0.796 -0.963 0.661 -1.574 c -0.134 -0.612 -0.638 -1.074 -1.259 -1.153 c -9.843 -1.265 -19.59 0.692 -28.193 5.66 C 13.8 12.041 6.356 21.743 3.246 33.35 S 1.732 57.08 7.741 67.487 c 6.008 10.407 15.709 17.851 27.316 20.961 C 38.933 89.486 42.866 90 46.774 90 c 7.795 0 15.489 -2.044 22.42 -6.046 c 8.601 -4.966 15.171 -12.43 18.997 -21.586 C 88.433 61.79 88.285 61.123 87.823 60.7 z" style="stroke: none; stroke-width: 1; stroke-dasharray: none; stroke-linecap: butt; stroke-linejoin: miter; stroke-miterlimit: 10; fill: #ffa716; fill-rule: nonzero; opacity: 1;" transform=" matrix(1 0 0 1 0 0) " stroke-linecap="round" />
                    </g>
                    </svg>
                </div>
            </a>
            
                <a class="navbar-item" href="/2022/01/30/en/how-to-validate-javascript-knowledge/">English</a>
            
            

        </div>
    </div>
</nav>

    <section class="section">
    <div class="container">
      
      <div data-nosnippet class="self-notice">
        最近開了一個讀者回饋表單，無論是對文章的感想或是對部落格的感想，有什麼想回饋的都可以填表單跟我說：<a href="https://forms.gle/XuWyRC5qtSd2ANta8" target="_blank">表單連結</a>
      </div>
      
    <article class="article content gallery" itemscope itemprop="blogPost">
    <h1 class="article-title is-size-3 is-size-4-mobile" itemprop="name">
        
            你知道的 JavaScript 知識都有可能是錯的
        
    </h1>
    <div class="article-meta columns is-variable is-1 is-multiline is-mobile is-size-7-mobile">
        <span class="column is-narrow">
            <time datetime="2022-01-30T09:32:14.000Z" itemprop="datePublished">2022年1月30日</time>
        </span>
        
        <span class="column is-narrow article-category">
            <i class="far fa-folder"></i>
            <a class="article-category-link" href="/categories/JavaScript/">JavaScript</a>
        </span>
        
        
        
    </div>
    
    <div class="article-entry is-size-6-mobile" itemprop="articleBody">
    
        <p>談完了 JavaScript 的歷史以及包袱以後，我們來談談 JavaScript 本身。</p>
<p>不知道大家有沒有想過一個問題，當你看到一本 JavaScript 書籍或是教學文章的時候，你要怎麼知道作者沒有寫錯？要怎麼知道書裡講的知識是正確的？就如同標題所說，會不會你以前知道的 JavaScript 知識其實是錯的？</p>
<p>因為作者常寫技術文章，所以就相信他嗎？還是說看到 MDN 上面也是這樣寫，因此就信了？又或是大家都這樣講，所以鐵定沒錯？</p>
<p>有些問題是沒有標準答案的，例如說電車難題，不同的流派都會有各自認可的答案，並沒有說哪個就一定是對的。</p>
<p>但幸好程式語言的世界比較單純，當我們提到 JavaScript 的知識時，有兩個地方可以讓你驗證這個知識是否正確，第一個叫做 ECMAScript 規格，第二個大家可以先想想，我們待會再提。</p>
<span id="more"></span>

<h2><span id="ecmascript">ECMAScript</span></h2><p>1995 年的時候 JavaScript 正式推出，那時候只是個可以在 Netscape 上跑的程式語言，如果想要保證跨瀏覽器的支援度的話，需要的是一個標準化的規範，讓各家瀏覽器都遵循著標準。</p>
<p>在 1996 年時網景聯繫了 Ecma International（European Computer Manufacturers Association，歐洲電腦製造商協會），成立了新的技術委員會（Technical Committee），因為是用數字來依序編號，那時候正好編到 39，就是我們現在熟悉的 TC39。</p>
<p>1997 年時，正式發佈了 ECMA-262 第一版，也就是我們俗稱的 ECMAScript 第一版。</p>
<p>為什麼是叫做 ECMAScript，而不是 JavaScript 呢？因為 JavaScript 在那時已經被 Sun 註冊為商標，而且不開放給 Ecma 協會使用，所以沒辦法叫做 JavaScript，因此後來這個標準就稱之為 ECMAScript 了。</p>
<p>至於 JavaScript 的話，你可以視為是去實作 ECMAScript 這個規範的程式語言。當你想知道某個 JavaScript 的功能的規範是什麼，去看 ECMAScript 準沒錯，詳細的行為都會記載在裡面。</p>
<p>而標準是會持續進化的，幾乎每一年都會有新的標準出現，納入新的提案。例如說截止撰寫當下，最新的是 2021 年推出的 ECMAScript 第 12 版，通常又被稱之為 ES12 或是 ES2021，大家常聽到的 ES6 也被稱為 ES2015，代表是在 2015 年推出的 ECMAScript 第 6 版。</p>
<p>如果你對 ECMAScript 的歷史以及這些名詞有興趣，可以參考底下文章：</p>
<ol>
<li><a target="_blank" rel="noopener" href="https://cn.history.js.org/part-2.html#%E5%91%BD%E5%90%8D%E6%A0%87%E5%87%86">JavaScript 二十年：創立標準</a></li>
<li><a target="_blank" rel="noopener" href="https://ithelp.ithome.com.tw/articles/10213310">Day2 [JavaScript 基礎] 淺談 ECMAScript 與 JavaScript</a></li>
<li><a target="_blank" rel="noopener" href="https://ithelp.ithome.com.tw/articles/10237660">JavaScript 之旅 (1)：介紹 ECMA、ECMAScript、JavaScript 和 TC39</a></li>
</ol>
<p>接著，我們就來簡單看看 ECMAScript 的規格到底長什麼樣子。</p>
<h2><span id="初探-ecmascript">初探 ECMAScript</span></h2><p>ECMAScript 的所有版本都可以在這個頁面中找到：<a target="_blank" rel="noopener" href="https://www.ecma-international.org/publications-and-standards/standards/ecma-262/">https://www.ecma-international.org/publications-and-standards/standards/ecma-262/</a></p>
<p>可以直接下載 PDF 檔，也可以用線上的 HTML 版本觀看，我會建議大家直接下載 PDF，因為 HTML 似乎是全部內容一起載入，所以要載很久，而且有分頁當掉的風險。</p>
<p>我們打開 ES2021 的規格，會發現這是一個有著 879 頁的超級龐大文件。規格就像是字典一樣，是讓你拿來查的，不是讓你一頁一頁當故事書看的。</p>
<p>但只要能善用搜尋功能，還是很快就可以找到我們想要的段落。底下我們來看看三個不同種類的功能的規格。</p>
<h3><span id="stringprototyperepeat">String.prototype.repeat</span></h3><p>搜尋「String.prototype.repeat」，可以找到目錄的地方，點了目錄就可以直接跳到相對應的段落：<code>22.1.3.16 String.prototype.repeat</code>，內容如下：</p>
<p><img src="/img/how-to-validate-javascript-knowledge/ecma-repeat.png"></p>
<p>大家可以自己先試著讀一遍看看。</p>
<p>規格這種東西其實跟程式有點像，就像是虛擬碼（pseudo code）那樣，所以有很多程式的概念在裡面，例如說上面你就會看到有很多 function call，需要去查看其他 function 的定義才能了解確切到底做了什麼。不過，許多函式從命名就可以推測出做的事情，可見函式命名真的很重要。</p>
<p>上面的規格中基本上告訴了我們兩件以前可能不知道的事情：</p>
<ol>
<li>呼叫 repeat 時如果 count 是負數或是無限大，就會出錯</li>
<li>repeat 似乎不是只有字串可以用</li>
</ol>
<p>第二點其實在 JavaScript 中是滿重要的一件事情，在 ECMAScript 你也會很常看到類似的案例，寫著：「The xxx function is intentionally generic」，這是什麼意思呢？</p>
<p>不知道你有沒有注意到前兩個步驟，分別是：</p>
<ol>
<li>Let O be ? RequireObjectCoercible(this value).</li>
<li>Let S be ? ToString(O).</li>
</ol>
<p>我們不是已經是字串了嗎？為什麼還要再 ToString？又為什麼跟 this 有關？</p>
<p>當我們在呼叫 <code>&quot;abc&quot;.repeat(3)</code> 的時候，其實是在呼叫 <code>String.prototype.repeat</code> 這個函式，然後 this 是 <code>&quot;abc&quot;</code>，因此可以視為是 <code>String.prototype.repeat.call(&quot;abc&quot;, 3)</code>。</p>
<p>既然可以轉換成這樣的呼叫方式，就代表你也可以傳一個不是字串的東西進去，例如說：<code>String.prototype.repeat.call(123, 3)</code>，而且不會壞掉，會回傳 <code>&quot;123123123&quot;</code>，而這一切都要歸功於規格定義時的延展性。</p>
<p>剛剛我們有在規格中看到它有特別寫說這個函式是故意寫成 generic 的，為的就是不只有字串可以呼叫，只要「可以變成字串」，其實都可以使用這個函式，這也是為什麼規格中的前兩步就是把 this 轉成字串，這樣才能確保非字串也可以使用。</p>
<p>再舉一個更奇耙的例子：</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">a</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'hello'</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span>
<span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token class-name">String</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function">repeat</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span>
<span class="token comment">// function a()&#123;console.log('hello')&#125;function a()&#123;console.log('hello')&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>因為函式可以轉成字串，所以當然也可以丟進去 repeat 裡面，而函式的 toString 方法會回傳函式的整個程式碼，因此才有了最後看到的輸出。</p>
<p>有關於 prototype 跟上面這些東西，我們之後提到 prototype 時應該會再講一次。</p>
<p>總之呢，從規格中我們看出 ECMAScript 的一個特性，就是故意把這些內建的方法做得更廣泛，適用於各種型態，只要能轉成字串都可以丟進去。</p>
<h3><span id="typeof">typeof</span></h3><p>一樣在 PDF 中搜尋 typeof，會找到 <code>13.5.3 The typeof Operator</code>，內容如下：</p>
<p><img src="/img/how-to-validate-javascript-knowledge/ecma-typeof.png"></p>
<p>可以看到 typeof 會先對傳入的值進行一些內部的操作，像是 <code>IsUnresolvableReference</code> 或是 <code>GetValue</code> 之類的，但通常我們關心的只有下面那張表格，就是每個型態會回傳的東西。</p>
<p>表格中可以看到兩件有趣的事情，第一件事情就是著名的 bug，<code>typeof null</code> 會回傳 object，這個 bug 到今天已經變成了規格的一部分。</p>
<p>第二件事情是對於規格來說，object 跟 function 其實內部都是 <code>Object</code>，只差在有沒有實作 <code>[[Call]]</code> 這個方法。</p>
<p>事實上，如果看其他段落的話，你也可以看到在規格中多次使用了 <code>function object</code> 這個說法，就可以知道在規格中 function 就只是「可以被呼叫（callable）的物件」</p>
<h3><span id="comments">Comments</span></h3><p>接著我們來看一下註解的語法，搜尋 comments，可以找到 <code>12.4 Comments</code>，底下是部分截圖：</p>
<p><img src="/img/how-to-validate-javascript-knowledge/ecma-comment.png"></p>
<p>可以看到 ECMAScript 是怎麼表示語法的，由上讀到下，Comment 分成兩種，MultiLineComment 跟 SingleLineComment，而底下有各自的定義，MultiLineComment 就是 <code>/* MultiLineCommentChars */</code>，那個黃色小字 opt 指的是 optional，意思就是沒有 MultiLineCommentChars 也可以，例如說 <code>/**/</code>，而底下又繼續往下定義，我就不再一一解釋了。</p>
<p>單行註解的地方則是這樣：</p>
<p><img src="/img/how-to-validate-javascript-knowledge/ecma-comment2.png"></p>
<p>其實意思跟多行註解差不多，而最後一行則是把我們引導至了 B.1.3，我們來看一下那邊的內容：</p>
<p><img src="/img/how-to-validate-javascript-knowledge/ecma-comment3.png"></p>
<p>這邊額外定義了 HTML-like Comments，看起來除了一些特殊狀況之外，都是合法的用法。</p>
<p>我們可以看到這裡將註解的定義再額外增加了三種：</p>
<ol>
<li>SingleLineHTMLOpenComment</li>
<li>SingleLineHTMLCloseComment</li>
<li>SingleLineDelimitedComment</li>
</ol>
<p>從規格中我們可以得到新的冷知識，那就是單行註解其實不只有 <code>//</code>，連 HTML 的也可以使用：</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span> 我是註解
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>

<span class="token comment">// 我也是</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>

<span class="token operator">--</span><span class="token operator">></span> 我也是
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>這就是只能從規格中才能看到的 JavaScript 冷知識。</p>
<p>當有人告訴你 JavaScript 的註解只有 <code>//</code> 跟 <code>/* */</code> 時，你只要有看過 ECMAScript 規格，就可以知道他講的是錯的，其實不只。</p>
<p>以上就是我們從 ECMAScript 中找出的三個小段落，主要是想讓大家稍微看一下規格長什麼樣子。</p>
<p>如果你對閱讀規格有興趣的話，我會建議大家先去看 ES3 的規格，因為 ES3 比起前兩版完整度高了許多，而頁數又少，只有 188 頁而已，是可以當作一般書籍來看，可以一頁一頁翻的那種。</p>
<p>雖然說從 ES6 以後規格的用詞跟底層的機制有一些變動，但我認為從 ES3 開始看規格還是挺不錯的，至少可以用最少的力氣去熟悉規格。</p>
<p>若是看一看開始對規格產生興趣，想要仔細研究的話，可以參考底下兩篇文章：</p>
<ol>
<li><a target="_blank" rel="noopener" href="https://dwatow.github.io/2021/05-08-how-to-read-ecma-262-zh-tw/">翻譯 如何閱讀 ECMAScript Specification 中文版</a></li>
<li><a target="_blank" rel="noopener" href="https://v8.dev/blog/tags/understanding-ecmascript">V8 blog - Understanding ECMAScript</a></li>
</ol>
<p>前面我們有提到過有兩個地方可以讓你驗證 JavaScript 的知識是否正確，第一個是 ECMAScript 規格，而第二個則是請大家先自己想一想。</p>
<p>現在要來公布答案了，第二個就是：「JavaScript 引擎原始碼」。</p>
<h2><span id="淺談-javascript-引擎原始碼">淺談 JavaScript 引擎原始碼</span></h2><p>ECMAScript 規格定義了一個程式語言「應該如何」，但實際上到底是怎麼樣，就屬於「實作」的部分了，就像是 PM 定義了一個產品規格，但工程師有可能漏看導致實作錯誤，也有可能因為各種原因沒辦法完全遵守規格，會產生一些差異。</p>
<p>所以假如你在 Chrome 上面發現了一個奇怪的現象，去查了 ECMAScript 規格後也發現行為不同，很有可能就是 Chrome 裡 JavaScript 引擎的實作其實跟規格不一樣，才導致這種差異。</p>
<p>規格只是規格，最後我們使用時還是要看引擎的實作為何。</p>
<p>以 Chrome 來說，背後使用一個叫做 V8 的 JavaScript 引擎，如果你對 JS 引擎一無所知，可以先看一下這個影片：<a target="_blank" rel="noopener" href="https://www.youtube.com/watch?v=p-iiEDtpy6I">Franziska Hinkelmann: JavaScript engines - how do they even? | JSConf EU</a>。</p>
<p>而如果想要看 V8 的程式碼，可以看官方版：<a target="_blank" rel="noopener" href="https://chromium.googlesource.com/v8/v8.git">https://chromium.googlesource.com/v8/v8.git</a>，也可以看這個在 GitHub 上的版本：<a target="_blank" rel="noopener" href="https://github.com/v8/v8">https://github.com/v8/v8</a></p>
<p>在看 ECMAScript 規格時，我們看了三個不同的功能，底下就讓我們來看看這些功能在 V8 中是怎麼被實作的。</p>
<h3><span id="stringprototyperepeat">String.prototype.repeat</span></h3><p>在 V8 中有一個程式語言叫做 Torque，是為了更方便去實作 ECMAScript 中的邏輯而誕生的，語法跟 TypeScript 有點類似，詳情可參考：<a target="_blank" rel="noopener" href="https://v8.dev/docs/torque">V8 Torque user manual</a></p>
<p>有關於 <code>String.prototype.repeat</code> 的相關程式碼在這：<a target="_blank" rel="noopener" href="https://chromium.googlesource.com/v8/v8.git/+/refs/tags/10.0.51/src/builtins/string-repeat.tq">src&#x2F;builtins&#x2F;string-repeat.tq</a></p>
<pre class="line-numbers language-typescript" data-language="typescript"><code class="language-typescript"><span class="token comment">// https://tc39.github.io/ecma262/#sec-string.prototype.repeat</span>
transitioning javascript builtin <span class="token function">StringPrototypeRepeat</span><span class="token punctuation">(</span>
    js<span class="token operator">-</span>implicit context<span class="token operator">:</span> NativeContext<span class="token punctuation">,</span> receiver<span class="token operator">:</span> JSAny<span class="token punctuation">)</span><span class="token punctuation">(</span>count<span class="token operator">:</span> JSAny<span class="token punctuation">)</span><span class="token operator">:</span> String <span class="token punctuation">&#123;</span>
  <span class="token comment">// 1. Let O be ? RequireObjectCoercible(this value).</span>
  <span class="token comment">// 2. Let S be ? ToString(O).</span>
  <span class="token keyword">const</span> s<span class="token operator">:</span> String <span class="token operator">=</span> <span class="token function">ToThisString</span><span class="token punctuation">(</span>receiver<span class="token punctuation">,</span> kBuiltinName<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 3. Let n be ? ToInteger(count).</span>
    <span class="token function">typeswitch</span> <span class="token punctuation">(</span><span class="token function">ToInteger_Inline</span><span class="token punctuation">(</span>count<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">case</span> <span class="token punctuation">(</span>n<span class="token operator">:</span> Smi<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 4. If n &lt; 0, throw a RangeError exception.</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>n <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> goto InvalidCount<span class="token punctuation">;</span>
        <span class="token comment">// 6. If n is 0, return the empty String.</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>n <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">||</span> s<span class="token punctuation">.</span>length_uint32 <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> goto EmptyString<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>n <span class="token operator">></span> kStringMaxLength<span class="token punctuation">)</span> goto InvalidStringLength<span class="token punctuation">;</span>
        <span class="token comment">// 7. Return the String value that is made from n copies of S appended</span>
        <span class="token comment">// together.</span>
        <span class="token keyword">return</span> <span class="token function">StringRepeat</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> n<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>
      <span class="token keyword">case</span> <span class="token punctuation">(</span>heapNum<span class="token operator">:</span> HeapNumber<span class="token punctuation">)</span><span class="token operator">:</span> deferred <span class="token punctuation">&#123;</span>
        <span class="token function">dcheck</span><span class="token punctuation">(</span><span class="token function">IsNumberNormalized</span><span class="token punctuation">(</span>heapNum<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">const</span> n <span class="token operator">=</span> <span class="token function">LoadHeapNumberValue</span><span class="token punctuation">(</span>heapNum<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 4. If n &lt; 0, throw a RangeError exception.</span>
        <span class="token comment">// 5. If n is +∞, throw a RangeError exception.</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>n <span class="token operator">==</span> <span class="token constant">V8_INFINITY</span> <span class="token operator">||</span> n <span class="token operator">&lt;</span> <span class="token number">0.0</span><span class="token punctuation">)</span> goto InvalidCount<span class="token punctuation">;</span>
        <span class="token comment">// 6. If n is 0, return the empty String.</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>s<span class="token punctuation">.</span>length_uint32 <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> goto EmptyString<span class="token punctuation">;</span>
        goto InvalidStringLength<span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span> label EmptyString <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> kEmptyString<span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span> label InvalidCount deferred <span class="token punctuation">&#123;</span>
    <span class="token function">ThrowRangeError</span><span class="token punctuation">(</span>MessageTemplate<span class="token operator">:</span><span class="token operator">:</span>kInvalidCountValue<span class="token punctuation">,</span> count<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span> label InvalidStringLength deferred <span class="token punctuation">&#123;</span>
    <span class="token function">ThrowInvalidStringLength</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>可以看到註解其實就是規格的內容，而程式碼就是直接把規格翻譯過去，真正在實作 repeat 的程式碼則是這一段：</p>
<pre class="line-numbers language-typescript" data-language="typescript"><code class="language-typescript">builtin <span class="token function">StringRepeat</span><span class="token punctuation">(</span>implicit context<span class="token operator">:</span> Context<span class="token punctuation">)</span><span class="token punctuation">(</span>
    <span class="token builtin">string</span><span class="token operator">:</span> String<span class="token punctuation">,</span> count<span class="token operator">:</span> Smi<span class="token punctuation">)</span><span class="token operator">:</span> String <span class="token punctuation">&#123;</span>
  <span class="token function">dcheck</span><span class="token punctuation">(</span>count <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">dcheck</span><span class="token punctuation">(</span><span class="token builtin">string</span> <span class="token operator">!=</span> kEmptyString<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> result<span class="token operator">:</span> String <span class="token operator">=</span> kEmptyString<span class="token punctuation">;</span>
  <span class="token keyword">let</span> powerOfTwoRepeats<span class="token operator">:</span> String <span class="token operator">=</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> n<span class="token operator">:</span> intptr <span class="token operator">=</span> <span class="token generic-function"><span class="token function">Convert</span><span class="token generic class-name"><span class="token operator">&lt;</span>intptr<span class="token operator">></span></span></span><span class="token punctuation">(</span>count<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>n <span class="token operator">&amp;</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> result <span class="token operator">=</span> result <span class="token operator">+</span> powerOfTwoRepeats<span class="token punctuation">;</span>
    n <span class="token operator">=</span> n <span class="token operator">>></span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>n <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">break</span><span class="token punctuation">;</span>
    powerOfTwoRepeats <span class="token operator">=</span> powerOfTwoRepeats <span class="token operator">+</span> powerOfTwoRepeats<span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  <span class="token keyword">return</span> result<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>從這邊可以看到一個有趣的小細節，那就是在 repeat 的時候，並不是直接跑一個 1 到 n 的迴圈，然後複製 n 遍，這樣太慢了，而是利用了<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E5%B9%B3%E6%96%B9%E6%B1%82%E5%B9%82">平方求冪</a>的演算法。</p>
<p>舉例來說，假設我們要產生 <code>&#39;a&#39;.repeat(8)</code>，一般的做法需要 7 次加法，但其實我們可以先加一次產生 aa，然後再互加產生 aaaa，最後再互加一次，就可以用三次加法做出 8 次重複（<code>2^3 = 8</code>），省下了不少字串相加的操作。</p>
<p>從中可以看出，像是 JavaScript 引擎這種接近底層的實作，必須要把效能也考慮在內。</p>
<h3><span id="typeof">typeof</span></h3><p>V8 裡面對於 typeof 的定義在這裡，註解裡面一樣有寫到相關的 spec 段落：<a target="_blank" rel="noopener" href="https://chromium.googlesource.com/v8/v8.git/+/refs/tags/10.0.51/src/objects/objects.h#466">src&#x2F;objects&#x2F;objects.h#466</a></p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">// ES6 section 12.5.6 The typeof Operator</span>
<span class="token keyword">static</span> Handle<span class="token operator">&lt;</span>String<span class="token operator">></span> <span class="token function">TypeOf</span><span class="token punctuation">(</span>Isolate<span class="token operator">*</span> isolate<span class="token punctuation">,</span> Handle<span class="token operator">&lt;</span>Object<span class="token operator">></span> object<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>實作則是在這邊：<a target="_blank" rel="noopener" href="https://chromium.googlesource.com/v8/v8.git/+/refs/tags/10.0.51/src/objects/objects.cc#870">src&#x2F;objects&#x2F;objects.cc#870</a></p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">// static</span>
Handle<span class="token operator">&lt;</span>String<span class="token operator">></span> Object<span class="token operator">::</span><span class="token function">TypeOf</span><span class="token punctuation">(</span>Isolate<span class="token operator">*</span> isolate<span class="token punctuation">,</span> Handle<span class="token operator">&lt;</span>Object<span class="token operator">></span> object<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>object<span class="token operator">-></span><span class="token function">IsNumber</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> isolate<span class="token operator">-></span><span class="token function">factory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">number_string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>object<span class="token operator">-></span><span class="token function">IsOddball</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token function">handle</span><span class="token punctuation">(</span>Oddball<span class="token operator">::</span><span class="token function">cast</span><span class="token punctuation">(</span><span class="token operator">*</span>object<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">type_of</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> isolate<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>object<span class="token operator">-></span><span class="token function">IsUndetectable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> isolate<span class="token operator">-></span><span class="token function">factory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">undefined_string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>object<span class="token operator">-></span><span class="token function">IsString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> isolate<span class="token operator">-></span><span class="token function">factory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">string_string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>object<span class="token operator">-></span><span class="token function">IsSymbol</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> isolate<span class="token operator">-></span><span class="token function">factory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">symbol_string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>object<span class="token operator">-></span><span class="token function">IsBigInt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> isolate<span class="token operator">-></span><span class="token function">factory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">bigint_string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>object<span class="token operator">-></span><span class="token function">IsCallable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> isolate<span class="token operator">-></span><span class="token function">factory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">function_string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> isolate<span class="token operator">-></span><span class="token function">factory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">object_string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>可以看到裡面針對各種型態都進行了檢查。</p>
<p>有些人可能會很好奇上面的 Oddball 是什麼，<code>null</code>、<code>undefined</code>、<code>true</code> 跟 <code>false</code> 都是用這個型態來存的，詳細原因我也不太清楚，想深入研究可參考：</p>
<ol>
<li><a target="_blank" rel="noopener" href="https://github.com/danbev/learning-v8#oddball">Learning Google V8</a></li>
<li><a target="_blank" rel="noopener" href="https://www.davepacheco.net/blog/post/2012-01-13-playing-with-nodev8-postmortem-debugging/">Playing with Node&#x2F;V8 postmortem debugging</a></li>
<li><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/39951011">V8源码边缘试探-黑魔法指针偏移</a></li>
</ol>
<p>不過如果 Oddball 裡面已經包含了 <code>undefined</code>，為什麼底下還有一個檢查，也會回傳 undefined 呢？這個 undetectable 是什麼呢？</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">if</span> <span class="token punctuation">(</span>object<span class="token operator">-></span><span class="token function">IsUndetectable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">return</span> isolate<span class="token operator">-></span><span class="token function">factory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">undefined_string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>這一切的一切都是因為一個歷史包袱。</p>
<p>在那個 IE 盛行的年代，有一個 IE 專屬的 API，叫做：<code>document.all</code>，可以用 <code>document.all(&#39;a&#39;)</code> 來拿到指定的元素。而那時候也因為這個 IE 專屬的功能，流行著一種偵測瀏覽器是否為 IE 的做法：</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">var</span> isIE <span class="token operator">=</span> <span class="token operator">!</span><span class="token operator">!</span>document<span class="token punctuation">.</span>all
<span class="token keyword">if</span> <span class="token punctuation">(</span>isIE<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
 <span class="token comment">// 呼叫 IE 才有的 API</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>後來 Opera 也跟上，實作了 <code>document.all</code>，可是碰到了一個問題，那就是既然實作了，如果網站有用到上面判斷 IE 的方法的話，就會被判定為是 IE，可是 Opera 並沒有那些 IE 專屬的 API，於是網頁就會爆炸，執行錯誤。</p>
<p>Firefox 在實作這個功能時從 Opera 的故事中學到了教訓，雖然實作了 <code>document.all</code> 的功能，可是卻動了一些手腳，讓它沒辦法被偵測到：</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">typeof</span> document<span class="token punctuation">.</span>all <span class="token comment">// undefined</span>
<span class="token operator">!</span><span class="token operator">!</span>document<span class="token punctuation">.</span>all <span class="token comment">// false</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>也就是說，<code>typeof document.all</code> 必須強制回傳 <code>undefined</code>，而且 toBoolean 的時候也必須回傳 <code>false</code>，真是 workaround 大師。</p>
<p>而到後來其他瀏覽器也跟上這個實作，這個實作到最後甚至變成了標準的一環，出現在 <code>B.3.7 The [[IsHTMLDDA]] Internal Slot</code> 之中：</p>
<p><img src="/img/how-to-validate-javascript-knowledge/ecma-document-all.png"></p>
<p>我們在 V8 看到的 IsUndetectable，就是為了實作這個機制而產生，可以在註解裡面看得很清楚，程式碼在 <a target="_blank" rel="noopener" href="https://chromium.googlesource.com/v8/v8.git/+/refs/tags/10.0.51/src/objects/map.h#391">src&#x2F;objects&#x2F;map.h#391</a>：</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// Tells whether the instance is undetectable.</span>
<span class="token comment">// An undetectable object is a special class of JSObject: 'typeof' operator</span>
<span class="token comment">// returns undefined, ToBoolean returns false. Otherwise it behaves like</span>
<span class="token comment">// a normal JS object.  It is useful for implementing undetectable</span>
<span class="token comment">// document.all in Firefox &amp; Safari.</span>
<span class="token comment">// See https://bugzilla.mozilla.org/show_bug.cgi?id=248549.</span>
<span class="token constant">DECL_BOOLEAN_ACCESSORS</span><span class="token punctuation">(</span>is_undetectable<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>看到這邊，大家不妨去打開 Chrome devtool，把玩一下 <code>document.all</code>，親自體驗這個歷史包袱。</p>
<p>Chrome 也因為這個歷史包袱，曾經出現過一個 bug，相關的故事可以參考：<a target="_blank" rel="noopener" href="https://programmerall.com/article/5623928123/">What is the bug of V8’s typeof null returning “undefined”</a>，上述段落也是參考這篇文章寫的。</p>
<h3><span id="comments">Comments</span></h3><p>前面有提到過 JavaScript 其實還有幾種鮮為人知的註解方式，像是 <code>&lt;!--</code> 跟 <code>--&gt;</code>，在 V8 中有關於語法的部分，可以看這個檔案：<a target="_blank" rel="noopener" href="https://github.com/v8/v8/blob/master/src/parsing/scanner-inl.h">&#x2F;src&#x2F;parsing&#x2F;scanner-inl.h</a>，我們擷取幾個段落：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">case</span> Token<span class="token operator">::</span>LT<span class="token operator">:</span>
  <span class="token comment">// &lt; &lt;= &lt;&lt; &lt;&lt;= &lt;!--</span>
  <span class="token function">Advance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>c0_ <span class="token operator">==</span> <span class="token char">'='</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token function">Select</span><span class="token punctuation">(</span>Token<span class="token operator">::</span>LTE<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>c0_ <span class="token operator">==</span> <span class="token char">'&lt;'</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token function">Select</span><span class="token punctuation">(</span><span class="token char">'='</span><span class="token punctuation">,</span> Token<span class="token operator">::</span>ASSIGN_SHL<span class="token punctuation">,</span> Token<span class="token operator">::</span>SHL<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>c0_ <span class="token operator">==</span> <span class="token char">'!'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    token <span class="token operator">=</span> <span class="token function">ScanHtmlComment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">continue</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  <span class="token keyword">return</span> Token<span class="token operator">::</span>LT<span class="token punctuation">;</span>

<span class="token keyword">case</span> Token<span class="token operator">::</span>SUB<span class="token operator">:</span>
  <span class="token comment">// - -- --> -=</span>
  <span class="token function">Advance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>c0_ <span class="token operator">==</span> <span class="token char">'-'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token function">Advance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>c0_ <span class="token operator">==</span> <span class="token char">'>'</span> <span class="token operator">&amp;&amp;</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>after_line_terminator<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token comment">// For compatibility with SpiderMonkey, we skip lines that</span>
      <span class="token comment">// start with an HTML comment end '-->'.</span>
      token <span class="token operator">=</span> <span class="token function">SkipSingleHTMLComment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">continue</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">return</span> Token<span class="token operator">::</span>DEC<span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>c0_ <span class="token operator">==</span> <span class="token char">'='</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token function">Select</span><span class="token punctuation">(</span>Token<span class="token operator">::</span>ASSIGN_SUB<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> Token<span class="token operator">::</span>SUB<span class="token punctuation">;</span>

<span class="token keyword">case</span> Token<span class="token operator">::</span>DIV<span class="token operator">:</span>
  <span class="token comment">// /  // /* /=</span>
  <span class="token function">Advance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>c0_ <span class="token operator">==</span> <span class="token char">'/'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    base<span class="token operator">::</span>uc32 c <span class="token operator">=</span> <span class="token function">Peek</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>c <span class="token operator">==</span> <span class="token char">'#'</span> <span class="token operator">||</span> c <span class="token operator">==</span> <span class="token char">'@'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token function">Advance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">Advance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      token <span class="token operator">=</span> <span class="token function">SkipSourceURLComment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">continue</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    token <span class="token operator">=</span> <span class="token function">SkipSingleLineComment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">continue</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>c0_ <span class="token operator">==</span> <span class="token char">'*'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    token <span class="token operator">=</span> <span class="token function">SkipMultiLineComment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">continue</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>c0_ <span class="token operator">==</span> <span class="token char">'='</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token function">Select</span><span class="token punctuation">(</span>Token<span class="token operator">::</span>ASSIGN_DIV<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> Token<span class="token operator">::</span>DIV<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>如果碰到 <code>&lt;!</code>，就呼叫 <code>ScanHtmlComment</code>。</p>
<p>如果碰到 <code>--&gt;</code> 而且是在開頭，就呼叫 <code>SkipSingleHTMLComment</code>，這段也告訴了我們一件事，就是 <code>--&gt;</code> 一定要在開頭，不是開頭就會出錯（這邊指的開頭是前面沒有其他有意義的敘述，但空格跟註解是可以的）。</p>
<p>如果碰到 <code>//</code>，檢查後面是不是 <code>#</code> 或是 <code>@</code>，是的話就呼叫 <code>SkipSourceURLComment</code>，這其實就是 source map 的語法，詳情可以參考：<a target="_blank" rel="noopener" href="https://developers.google.com/web/updates/2013/06/sourceMappingURL-and-sourceURL-syntax-changed">sourceMappingURL and sourceURL syntax changed</a> 跟 <a target="_blank" rel="noopener" href="https://blog.techbridge.cc/2021/03/28/how-source-map-works/">Source map 運作原理</a>。</p>
<p>不是的話就呼叫 <code>SkipSingleLineComment</code>。</p>
<p>如果是 <code>/*</code> 的話則呼叫 <code>SkipMultiLineComment</code>。</p>
<p>上面呼叫的相對應的函式都在 <a target="_blank" rel="noopener" href="https://github.com/v8/v8/blob/master/src/parsing/scanner.cc">src&#x2F;parsing&#x2F;scanner.cc</a> 中，我們看一個比較有趣的，碰到 <code>&lt;!</code> 會呼叫的 <code>ScanHtmlComment </code>：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">Token<span class="token operator">::</span>Value Scanner<span class="token operator">::</span><span class="token function">ScanHtmlComment</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token comment">// Check for &lt;!-- comments.</span>
  <span class="token function">DCHECK_EQ</span><span class="token punctuation">(</span>c0_<span class="token punctuation">,</span> <span class="token char">'!'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">Advance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>c0_ <span class="token operator">!=</span> <span class="token char">'-'</span> <span class="token operator">||</span> <span class="token function">Peek</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token char">'-'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token function">PushBack</span><span class="token punctuation">(</span><span class="token char">'!'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// undo Advance()</span>
    <span class="token keyword">return</span> Token<span class="token operator">::</span>LT<span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  <span class="token function">Advance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  found_html_comment_ <span class="token operator">=</span> true<span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token function">SkipSingleHTMLComment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>這邊會繼續往下看，看後面是不是 <code>--</code>，如果不是的話會復原操作，然後回傳 <code>Token::LT</code>，也就是 <code>&lt;</code>；是的話則呼叫 <code>SkipSingleHTMLComment</code>。</p>
<p>而 <code>SkipSingleHTMLComment</code> 的程式碼也很簡單：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">Token<span class="token operator">::</span>Value Scanner<span class="token operator">::</span><span class="token function">SkipSingleHTMLComment</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>flags_<span class="token punctuation">.</span><span class="token function">is_module</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token function">ReportScannerError</span><span class="token punctuation">(</span><span class="token function">source_pos</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> MessageTemplate<span class="token operator">::</span>kHtmlCommentInModule<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> Token<span class="token operator">::</span>ILLEGAL<span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  <span class="token keyword">return</span> <span class="token function">SkipSingleLineComment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>按照規格中說的，檢查 <code>flags_.is_module()</code> 是不是 true，是的話就拋出錯誤。如果想重現這個狀況，可以新建一個 <code>test.mjs</code> 的檔案，裡面用 <code>&lt;!--</code> 當作註解，用 Node.js 執行後就會噴錯：</p>
<pre class="line-numbers language-none"><code class="language-none">&lt;!-- 我是註解
   ^

SyntaxError: HTML comments are not allowed in modules<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>而 <code>&lt;!--</code> 可以當作註解，也會造成一個很好玩的現象。大多數時候運算子之間有沒有空格，通常不會影響結果，例如說 <code>a+b&gt;3</code> 跟 <code>a + b &gt; 3</code> 結果是一樣的，但因為 <code>&lt;!--</code> 是一整組的語法，所以：</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token number">1</span>
<span class="token keyword">var</span> b <span class="token operator">=</span> <span class="token number">0</span> <span class="token operator">&lt;</span> <span class="token operator">!</span><span class="token operator">--</span>a 
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span> <span class="token comment">// 0</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span> <span class="token comment">// true</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>執行的過程是先 <code>--a</code>，把 a 變成 0，接著 <code>!</code> 過後變成 1，然後 <code>0 &lt; 1</code> 是 true，所以 b 就是 true。</p>
<p>但如果把 <code>&lt; !--</code> 改成 <code>&lt;!--</code>：</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token number">1</span>
<span class="token keyword">var</span> b <span class="token operator">=</span> <span class="token number">0</span> <span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span>a 
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span> <span class="token comment">// 1</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span> <span class="token comment">// 0</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>那就變成沒有任何運算操作，因為 <code>&lt;!--</code> 後面都是註解，所以就是單純的 <code>var a = 1</code> 跟 <code>var b = 0</code> 而已。</p>
<p>話說在找尋實作的程式碼時，要從茫茫 code 海中找到自己關注的地方不是件容易的事情，分享一個我自己會用的方法，就是 google。直接搜尋關鍵字，或是利用 filter 去幫你搜尋程式碼，像這樣：<code>typeof inurl:https://chromium.googlesource.com/v8/v8.git</code>。</p>
<p>如果程式碼在 GitHub 的話，也可以用這個很好用的網站，叫做 <a target="_blank" rel="noopener" href="https://grep.app/search?q=typeof&filter%5Brepo%5D%5B0%5D=v8/v8">grep.app</a>，可以指定 GitHub repo 去搜尋內容。</p>
<h2><span id="結語">結語</span></h2><p>當你從任何地方（也包括這篇文章）得到關於 JavaScript 的知識時，都不一定是正確的。</p>
<p>如果想確認的話，有兩個層面可以驗證這個知識是否正確，第一個層面是「是否符合 ECMAScript 的規範」，這點可以透過去尋找 ECMAScript 中相對應的段落來達成。我的文章中如果有參考到 ECMAScript，都會盡量附上參考的段落，方便大家自己去驗證。</p>
<p>第二個層面則是「是否符合 JavaScript 引擎的實作」，因為有時候實作不一定會跟規格一致，而且會有時間的問題，例如說已經被納入規範，但還沒實作，或甚至是反過來。</p>
<p>而 JavaScript 引擎其實也不只一個，像是 Firefox 在使用的 <a target="_blank" rel="noopener" href="https://spidermonkey.dev/">SpiderMonkey</a> 就是另一個不同於 V8 的引擎。</p>
<p>如果你看完這篇文章以後想試試看閱讀規格，卻又不知道該從何下手的話，那我來出一個問題，請你從規格中找出答案：「假設 <code>s</code> 是任意字串，請問 <code>s.toUpperCase().toLowerCase()</code> 跟 <code>s.toLowerCase()</code> 是否永遠相等？如果否，請舉一個反例」</p>

    
    </div>
    
    <div class="columns is-variable is-1 is-multiline is-mobile">
    
        <span class="column is-narrow"><a class="tag is-light article-tag" href="/tags/JavaScript/">#JavaScript</a></span>
    
    </div>
    
    
    <div class="columns is-mobile is-multiline article-nav">
        <span class="column is-12-mobile is-half-desktop  article-nav-prev">
            
            <a href="/2022/02/02/origin-trials-try-new-feature/">透過 Chrome Origin Trials 搶先試用新功能</a>
            
        </span>
        <span class="column is-12-mobile is-half-desktop  article-nav-next">
            
            <a href="/2022/01/19/sql-injection-in-action/">SQL injection 實戰：在限制底下提升速度</a>
            
        </span>
    </div>
    
</article>




<div class="comments">
    <h3 class="title is-4">評論</h3>
    <script src="https://utteranc.es/client.js"
        repo="aszx87410/huli-blog"
        issue-term="title"
        theme="github-light"
        crossorigin="anonymous"
        async>
</script>
</div>

    </div>
</section>
    <footer class="footer">
    <div class="container">
        <div class="columns content">
            <div class="column is-narrow has-text-centered">
                &copy; 2024 Huli&nbsp;
                Powered by <a href="http://hexo.io/" target="_blank">Hexo</a> & <a
                        target="_blank" rel="noopener" href="http://github.com/ppoffice/hexo-theme-minos">Minos</a>
            </div>
            <div class="column is-hidden-mobile"></div>

            
            <div class="column is-narrow">
                <div class="columns is-mobile is-multiline is-centered">
                
                    
                <a class="column is-narrow" title="GitHub" target="_blank" rel="noopener" href="https://github.com/ppoffice/hexo-theme-minos">
                    
                    GitHub
                    
                </a>
                
                </div>
            </div>
            
            
<div class="column is-narrow has-text-centered">
    <div class="dropdown is-up is-right is-hoverable" style="margin-top: -0.2em;">
        <div class="dropdown-trigger">
            <button class="button is-small" aria-haspopup="true">
                <span class="icon">
                    <i class="fas fa-globe"></i>
                </span>
                <span>繁體中文</span>
                <span class="icon is-small">
            <i class="fas fa-angle-down" aria-hidden="true"></i>
          </span>
            </button>
        </div>
        <div class="dropdown-menu has-text-left" role="menu" style="top:100%">
            <div class="dropdown-content">
            <!-- NOTE: 永遠回到首頁 -->
            
                <a href="/2022/01/30/en/how-to-validate-javascript-knowledge/" class="dropdown-item">
                    English
                </a>
            
            </div>
        </div>
    </div>
</div>

        </div>
    </div>
</footer>
    <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/3.6.3/jquery.min.js"></script>



    
    
    
    
    
    
<script src="//cdnjs.cloudflare.com/ajax/libs/lightgallery/1.6.8/js/lightgallery-all.min.js"></script>
<script>
    (function ($) {
        $(document).ready(function () {
            if (typeof($.fn.lightGallery) === 'function') {
                $('.article.gallery').lightGallery({ selector: '.gallery-item' });
            }
        });
    })(jQuery);
</script>

    
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.0/clipboard.min.js"></script>
    <style>
        .hljs {
            position: relative;
        }

        .hljs .clipboard-btn {
            float: right;
            color: #9a9a9a;
            background: none;
            border: none;
            cursor: pointer;
        }

        .hljs .clipboard-btn:hover {
          color: #8a8a8a;
        }

        .hljs > .clipboard-btn {
            display: none;
            position: absolute;
            right: 4px;
            top: 4px;
        }

        .hljs:hover > .clipboard-btn {
            display: inline;
        }

        .hljs > figcaption > .clipboard-btn {
            margin-right: 4px;
        }
    </style>
    <script>
      $(document).ready(function () {
        $('figure.hljs').each(function(i, figure) {
          var codeId = 'code-' + i;
          var code = figure.querySelector('.code');
          var copyButton = $('<button>Copy <i class="far fa-clipboard"></i></button>');
          code.id = codeId;
          copyButton.addClass('clipboard-btn');
          copyButton.attr('data-clipboard-target-id', codeId);

          var figcaption = figure.querySelector('figcaption');

          if (figcaption) {
            figcaption.append(copyButton[0]);
          } else {
            figure.prepend(copyButton[0]);
          }
        })

        var clipboard = new ClipboardJS('.clipboard-btn', {
          target: function(trigger) {
            return document.getElementById(trigger.getAttribute('data-clipboard-target-id'));
          }
        });
        clipboard.on('success', function(e) {
          e.clearSelection();
        })
      })
    </script>

    
    

    



<script src="/js/script.js?v=3.js"></script>


    
</body>
</html>