<!DOCTYPE html>
<html class="has-navbar-fixed-top" lang="zh-tw">
<head>
    <meta charset="utf-8">
<title>有缺陷的重設密碼機制如何演變成帳號奪取漏洞？以 Matters 為例 - Huli&#39;s blog</title>
<meta name="viewport" content="width=device-width, initial-scale=1">


<link href="https://blog.huli.tw/2022/01/04/reset-password-vulnerability/" rel="alternate" hreflang="zh-TW" />


<link href="https://blog.huli.tw/2022/01/04/reset-password-vulnerability/" rel="alternate" hreflang="x-default" />


<link href="https://blog.huli.tw/2022/01/04/en/reset-password-vulnerability/" rel="alternate" hreflang="en" />
    




    
<link rel="canonical" href="https://blog.huli.tw/2022/01/04/reset-password-vulnerability/">
    





    <meta name="description" content="重設密碼是幾乎所有網站都有的機制，最常見的是透過 email 寄送一個重設密碼的連結，點進去連結以後就可以幫這個帳號設定新的密碼。這個機制雖然常見，卻有一些關於安全性的小細節要注意。 這次要來寫的，是我在今年六月底的時候回報的由重設密碼功能引起的帳號奪取（account takeover）漏洞。">
<meta property="og:type" content="article">
<meta property="og:title" content="有缺陷的重設密碼機制如何演變成帳號奪取漏洞？以 Matters 為例">
<meta property="og:url" content="https://blog.huli.tw/2022/01/04/reset-password-vulnerability/index.html">
<meta property="og:site_name" content="Huli&#39;s blog">
<meta property="og:description" content="重設密碼是幾乎所有網站都有的機制，最常見的是透過 email 寄送一個重設密碼的連結，點進去連結以後就可以幫這個帳號設定新的密碼。這個機制雖然常見，卻有一些關於安全性的小細節要注意。 這次要來寫的，是我在今年六月底的時候回報的由重設密碼功能引起的帳號奪取（account takeover）漏洞。">
<meta property="og:locale" content="zh_TW">
<meta property="og:image" content="https://blog.huli.tw/img/reset-password-vulnerability/matters.png">
<meta property="article:published_time" content="2022-01-04T04:00:00.000Z">
<meta property="article:modified_time" content="2023-05-07T01:15:16.489Z">
<meta property="article:author" content="Huli">
<meta property="article:tag" content="Security">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://blog.huli.tw/img/reset-password-vulnerability/matters.png">



<link rel="alternative" href="/atom.xml" title="有缺陷的重設密碼機制如何演變成帳號奪取漏洞？以 Matters 為例" type="application/atom+xml">



<link rel="icon" href="/img/lidemy_logo.png">


<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Ovo|Source+Code+Pro">


<link rel="stylesheet" href="/css/bulma.css?v=2.css">



<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/lightgallery/1.6.8/css/lightgallery.min.css">


<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/line-numbers/prism-line-numbers.min.css" />


<link rel="stylesheet" href="/css/style.css?v=4.css">





    
    
    
    
    
    
    
    
    
    
<script async src="https://www.googletagmanager.com/gtag/js?id=G-1393J2EVCZ"></script>
<script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-1393J2EVCZ');
</script>


    


<meta name="generator" content="Hexo 6.3.0"></head>
<body>
    <script>
        if (localStorage.getItem('dark-mode')) {
            if (localStorage.getItem('dark-mode') === 'true') {
                document.body.classList.add('dark-mode')
            }
        } else {
            if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                document.body.classList.add('dark-mode')
            }
        }
    </script>
    
<nav class="navbar is-transparent is-fixed-top navbar-main" role="navigation" aria-label="main navigation">
    <div class="container">
        <div class="navbar-brand">
            <a class="navbar-item navbar-logo" href="/">
                
                    
                    Huli&#39;s blog
                    
                
            </a>
            <div class="navbar-burger">
                <span></span>
                <span></span>
                <span></span>
            </div>
        </div>
        
        <div class="navbar-menu navbar-start">
            
            <a class="navbar-item "
               href="/archives">文章列表</a>
            
            <a class="navbar-item "
               href="/categories">分類</a>
            
            <a class="navbar-item "
               href="/recommend">推薦閱讀</a>
            
            <a class="navbar-item "
               href="/about">關於我</a>
            
        </div>
        
        <div class="navbar-menu navbar-end">
            
            
            <div class="navbar-item is-hoverable has-dropdown is-hidden-mobile is-hidden-tablet-only toc">
                <a class="navbar-item" title="目錄">
                    目錄
                </a>
                <div class="navbar-dropdown">
                    
                    
                    
                    
                    <a class="navbar-item" href="#典型的重設密碼功能">1&nbsp;&nbsp;<b>典型的重設密碼功能</b></a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#matters-的重設密碼機制">2&nbsp;&nbsp;<b>Matters 的重設密碼機制</b></a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#rate-limiting">3&nbsp;&nbsp;<b>Rate limiting</b></a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#同時存在的驗證碼">4&nbsp;&nbsp;<b>同時存在的驗證碼</b></a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#建議修補方式">5&nbsp;&nbsp;<b>建議修補方式</b></a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#總結">6&nbsp;&nbsp;<b>總結</b></a>
                    
                </div>
            </div>
            
            
            <a class="navbar-item" target="_blank" title="Medium" href="https://hulitw.medium.com/">
                
                <i class="fab fa-medium"></i>
                
            </a>
               
            <a class="navbar-item" target="_blank" title="Facebook" href="https://www.facebook.com/huli.blog">
                
                <i class="fab fa-facebook"></i>
                
            </a>
               
            <a class="navbar-item" target="_blank" title="RSS" href="/atom-ch.xml">
                
                <i class="fas fa-rss"></i>
                
            </a>
               
            
            <a class="navbar-item btn-dark-mode" title="dark-mode" href="#">
                <div>
                    <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" width="15" height="15" viewBox="0 0 256 256" xml:space="preserve">
                    <defs>
                    </defs>
                    <g style="stroke: none; stroke-width: 0; stroke-dasharray: none; stroke-linecap: butt; stroke-linejoin: miter; stroke-miterlimit: 10; fill: none; fill-rule: nonzero; opacity: 1;" transform="translate(1.4065934065934016 1.4065934065934016) scale(2.81 2.81)" >
                        <path d="M 87.823 60.7 c -0.463 -0.423 -1.142 -0.506 -1.695 -0.214 c -15.834 8.398 -35.266 2.812 -44.232 -12.718 c -8.966 -15.53 -4.09 -35.149 11.101 -44.665 c 0.531 -0.332 0.796 -0.963 0.661 -1.574 c -0.134 -0.612 -0.638 -1.074 -1.259 -1.153 c -9.843 -1.265 -19.59 0.692 -28.193 5.66 C 13.8 12.041 6.356 21.743 3.246 33.35 S 1.732 57.08 7.741 67.487 c 6.008 10.407 15.709 17.851 27.316 20.961 C 38.933 89.486 42.866 90 46.774 90 c 7.795 0 15.489 -2.044 22.42 -6.046 c 8.601 -4.966 15.171 -12.43 18.997 -21.586 C 88.433 61.79 88.285 61.123 87.823 60.7 z" style="stroke: none; stroke-width: 1; stroke-dasharray: none; stroke-linecap: butt; stroke-linejoin: miter; stroke-miterlimit: 10; fill: #ffa716; fill-rule: nonzero; opacity: 1;" transform=" matrix(1 0 0 1 0 0) " stroke-linecap="round" />
                    </g>
                    </svg>
                </div>
            </a>
            
                <a class="navbar-item" href="/2022/01/04/en/reset-password-vulnerability/">English</a>
            
            

        </div>
    </div>
</nav>

    <section class="section">
    <div class="container">
      
      <div data-nosnippet class="self-notice">
        如果有什麼想回饋的（如對文章或部落格的感想），除了留言以外也能填表單跟我說：<a href="https://forms.gle/XuWyRC5qtSd2ANta8" target="_blank">表單連結</a>。若是對更多 JavaScript 知識有興趣，歡迎參考我的新書<a target="_blank" rel="noopener" href="https://www.tenlong.com.tw/products/9786267757048">《JavaScript 重修就好》</a>
      </div>
      
    <article class="article content gallery" itemscope itemprop="blogPost">
    <h1 class="article-title is-size-3 is-size-4-mobile" itemprop="name">
        
            有缺陷的重設密碼機制如何演變成帳號奪取漏洞？以 Matters 為例
        
    </h1>
    <div class="article-meta columns is-variable is-1 is-multiline is-mobile is-size-7-mobile">
        <span class="column is-narrow">
            <time datetime="2022-01-04T04:00:00.000Z" itemprop="datePublished">2022年1月4日</time>
        </span>
        
        <span class="column is-narrow article-category">
            <i class="far fa-folder"></i>
            <a class="article-category-link" href="/categories/Security/">Security</a>
        </span>
        
        
        
    </div>
    
    <div class="article-entry is-size-6-mobile" itemprop="articleBody">
    
        <p>重設密碼是幾乎所有網站都有的機制，最常見的是透過 email 寄送一個重設密碼的連結，點進去連結以後就可以幫這個帳號設定新的密碼。這個機制雖然常見，卻有一些關於安全性的小細節要注意。</p>
<p>這次要來寫的，是我在今年六月底的時候回報的由重設密碼功能引起的帳號奪取（account takeover）漏洞。</p>
<span id="more"></span>

<p><a target="_blank" rel="noopener" href="https://matters.news/">Matters News</a> 是一個去中心化而且應用加密貨幣相關技術的寫作社群平台，我以前曾經寫過一篇<a target="_blank" rel="noopener" href="https://tech-blog.cymetrics.io/posts/huli/prevent-xss-might-be-harder-than-you-thought/">《防止 XSS 可能比想像中困難》</a>分享我怎麼找到他們的 XSS 漏洞。</p>
<p>在談這次的漏洞之前，我們先來看看一般重設密碼的功能是如何設計的。</p>
<p>話說，如果你好奇為什麼密碼只能重設，而不是「找回密碼」，可以先參考這一篇：<a target="_blank" rel="noopener" href="https://tech-blog.cymetrics.io/posts/huli/why-only-reset-password-not-retrieve-password/">為什麼忘記密碼時只能重設，不把舊密碼告訴我？</a></p>
<h2><span id="典型的重設密碼功能">典型的重設密碼功能</span></h2><p>基本上忘記密碼的流程都大同小異，不外乎就是：</p>
<ol>
<li>使用者填入當初註冊帳號時的 email</li>
<li>系統寄送重設密碼的連結到第一步的 email</li>
<li>使用者點擊信中的連結，前往重設密碼頁面</li>
<li>使用者輸入新的密碼，送出表單</li>
<li>密碼重設成功，使用者可以利用新的密碼登入</li>
</ol>
<p>這個流程如果要是安全的，就必須確保：</p>
<ol>
<li>系統寄送信件的目的地，真的是使用者本人的 email</li>
<li>重設密碼的連結無法被猜出來</li>
</ol>
<p>先來談談第一點，有些人會想說：「這不是很基本嗎？我填入 <a href="mailto:&#117;&#115;&#x65;&#x72;&#x40;&#x65;&#x78;&#x61;&#x6d;&#x70;&#108;&#101;&#46;&#99;&#111;&#109;">&#117;&#115;&#x65;&#x72;&#x40;&#x65;&#x78;&#x61;&#x6d;&#x70;&#108;&#101;&#46;&#99;&#111;&#109;</a>，當然是把信件寄送給 <a href="mailto:&#x75;&#x73;&#x65;&#114;&#x40;&#x65;&#x78;&#97;&#x6d;&#112;&#x6c;&#101;&#46;&#99;&#x6f;&#x6d;">&#x75;&#x73;&#x65;&#114;&#x40;&#x65;&#x78;&#97;&#x6d;&#112;&#x6c;&#101;&#46;&#99;&#x6f;&#x6d;</a> 啊！」</p>
<p>不不不，這可不一定，有些系統在接收 email 這個參數時，居然可以是一個陣列，所以你可以填入：<code>[&quot;victim@example.com&quot;, &quot;attacker@example.com&quot;]</code>，然後 attacker 就會收到 victim 的重設密碼信件！</p>
<p>聽起來很不可思議，但確實發生過：</p>
<ol>
<li><a target="_blank" rel="noopener" href="https://hackerone.com/reports/322985">Ability to reset password for account</a></li>
<li><a target="_blank" rel="noopener" href="https://hackerone.com/reports/1175081">Full account takeover of any user through reset password</a></li>
</ol>
<p>再來談談第二點，如果重設密碼的連結可以被猜出來，就代表攻擊者可以代替 user 重設密碼。</p>
<p>或更精確地說，重設密碼的 token 不能被猜出來。</p>
<p>舉例來說，如果重設密碼的連結長得像這樣：<code>https://example.com/reset-password?token=user@example.com</code>，那我就可以幫任何人重設密碼了，顯然很不安全。</p>
<p>所以一般來說，token 都會產生一組 unique id，例如說 UUID v4，長得像這樣：<code>2c59d26a-f99a-425e-bb69-91e7c6ffe54d</code>，有 128 個 bit，也就是 2^128 種組合，要猜中的可能性微乎其微。</p>
<p>若是產生的 token 強度不夠的話，就會提高暴力破解成功的機率。</p>
<p>不過要特別注意的是儘管如此，有些系統的漏洞在其他地方，例如說寄送 email 時，重設密碼的網址或是 host 是可以控制的！像是只要在 request header 裡面加上 <code>X-Forwarded-Host: abc.com</code>，重設密碼的連結就會變成：<code>https://abc.com/reset-password?token=...</code>，使用者收到信以後如果不小心點了連結，這個 token 就會發到攻擊者的伺服器去，他一樣可以利用這個 token 來重設密碼，進行帳號奪取。</p>
<p>這也是有發生過實際案例的：</p>
<ol>
<li><a target="_blank" rel="noopener" href="https://hackerone.com/reports/226659">Password Reset link hijacking via Host Header Poisoning</a></li>
<li><a target="_blank" rel="noopener" href="https://hackerone.com/reports/182670">Email link poisoning &#x2F; Host header attack</a></li>
</ol>
<p>除了這些以外，其實還有許多小細節要注意，例如說：</p>
<ol>
<li>重設密碼的 token 應該只能使用一次</li>
<li>重設密碼的 token 應該要有過期時間</li>
<li>如果使用者產生了新的重設密碼 token，舊的應該要廢棄</li>
</ol>
<p>之所以會有這些限制，也是為了降低暴力破解的可行性。</p>
<p>假設時間無限的話，理論上暴力破解絕對可以猜出 token，因此防止暴力破解的重點有兩個，一個是盡量增加破解所需的時間，讓這個時間大到超過一千年或更久，第二個重點是限制時間，而實際的方法有幾種，例如說：</p>
<ol>
<li>把基數加大，例如說六碼數字的可能性只有一百萬種，但若是換成六碼英文加數字就有 20 億種，要猜測的數量多了 2000 倍，就需要花更多時間</li>
<li>把可猜測的時間降低，例如說 300 秒後 token 就會過期，假設可能性有 1 億種，那每秒必須要猜 30 萬種才能保證猜中</li>
</ol>
<p>接著，我們就來看一下 Matters 的重設密碼機制出了什麼事情。</p>
<h2><span id="matters-的重設密碼機制">Matters 的重設密碼機制</span></h2><p>下圖是 Matters 重設密碼的畫面，一樣是填入 email，然後寄一個連結到信箱：</p>
<p><img src="/img/reset-password-vulnerability/matters.png"></p>
<p>重設密碼的 request 長這樣：</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token punctuation">&#123;</span>
   <span class="token string-property property">"operationName"</span><span class="token operator">:</span><span class="token string">"SendVerificationCode"</span><span class="token punctuation">,</span>
   <span class="token string-property property">"variables"</span><span class="token operator">:</span><span class="token punctuation">&#123;</span>
      <span class="token string-property property">"input"</span><span class="token operator">:</span><span class="token punctuation">&#123;</span>
         <span class="token string-property property">"email"</span><span class="token operator">:</span><span class="token string">"user@example.com"</span><span class="token punctuation">,</span>
         <span class="token string-property property">"type"</span><span class="token operator">:</span><span class="token string">"password_reset"</span><span class="token punctuation">,</span>
         <span class="token string-property property">"redirectUrl"</span><span class="token operator">:</span><span class="token string">"https://matters.news/forget?email=user%40example.com"</span>
      <span class="token punctuation">&#125;</span>
   <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>這是我收到的連結：<code>https://matters.news/forget?email=user%40example.com&amp;code=UYBQ912rhd_9s3TfywZnk1kQl6PCaDjPlXuNX3Df&amp;type=password_reset</code></p>
<p>從這邊其實我們就可以發現第一個問題，就是看起來收到的連結的前半段是由 <code>redirectUrl</code> 所控制的。如果我們攔截 request 以後修改 <code>redirectUrl</code> 參數，修改成 <code>https://cymetrics.io</code>，會發現信箱內收到的連結確實變成由 <code>https://cymetrics.io</code> 開頭！</p>
<p>如此一來，就有了前面所說的漏洞，如果使用者點了信中的連結，那我們的 server 就會收到 token，就可以幫使用者重設密碼。</p>
<p>接著我們看一下有沒有暴力破解的問題，token 本身看起來複雜度滿高的，長度是 40 個字，由大小寫英文字母、數字以及底線所組成。</p>
<p>雖然看起來應該不會有問題，但 Matters 是開源的，所以我們可以直接去看一下 <code>SendVerificationCode</code> 是如何實作的，程式碼在這邊：<a target="_blank" rel="noopener" href="https://github.com/thematters/matters-server/blob/v3.19.0/src/mutations/user/sendVerificationCode.ts">https://github.com/thematters/matters-server/blob/v3.19.0/src/mutations/user/sendVerificationCode.ts</a></p>
<p>我們關注的是產生 code 的地方，主要是這一段：</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// insert record</span>
<span class="token keyword">const</span> <span class="token punctuation">&#123;</span> code <span class="token punctuation">&#125;</span> <span class="token operator">=</span> <span class="token keyword">await</span> userService<span class="token punctuation">.</span><span class="token function">createVerificationCode</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
  <span class="token literal-property property">userId</span><span class="token operator">:</span> viewer<span class="token punctuation">.</span>id<span class="token punctuation">,</span>
  email<span class="token punctuation">,</span>
  type<span class="token punctuation">,</span>
  <span class="token literal-property property">strong</span><span class="token operator">:</span> <span class="token operator">!</span><span class="token operator">!</span>redirectUrl<span class="token punctuation">,</span> <span class="token comment">// strong random code for link</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>而這個 <code>userService.createVerificationCode</code> 的程式碼則是在這裡：<a target="_blank" rel="noopener" href="https://github.com/thematters/matters-server/blob/v3.19.0/src/connectors/userService.ts#L1500">https://github.com/thematters/matters-server/blob/v3.19.0/src/connectors/userService.ts#L1500</a></p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token function-variable function">createVerificationCode</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">&#123;</span>
  userId<span class="token punctuation">,</span>
  email<span class="token punctuation">,</span>
  type<span class="token punctuation">,</span>
  strong<span class="token punctuation">,</span>
  expiredAt<span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
  userId<span class="token operator">?</span><span class="token operator">:</span> string <span class="token operator">|</span> <span class="token keyword">null</span>
  <span class="token literal-property property">email</span><span class="token operator">:</span> string
  <span class="token literal-property property">type</span><span class="token operator">:</span> string
  strong<span class="token operator">?</span><span class="token operator">:</span> boolean
  expiredAt<span class="token operator">?</span><span class="token operator">:</span> Date
<span class="token punctuation">&#125;</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">const</span> code <span class="token operator">=</span> strong <span class="token operator">?</span> <span class="token function">nanoid</span><span class="token punctuation">(</span><span class="token number">40</span><span class="token punctuation">)</span> <span class="token operator">:</span> _<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token number">100000</span><span class="token punctuation">,</span> <span class="token number">999999</span><span class="token punctuation">)</span>

  <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">baseCreate</span><span class="token punctuation">(</span>
    <span class="token punctuation">&#123;</span>
      <span class="token literal-property property">uuid</span><span class="token operator">:</span> <span class="token function">v4</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      userId<span class="token punctuation">,</span>
      email<span class="token punctuation">,</span>
      type<span class="token punctuation">,</span>
      code<span class="token punctuation">,</span>
      <span class="token literal-property property">expiredAt</span><span class="token operator">:</span>
        expiredAt <span class="token operator">||</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span>Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token constant">VERIFICATION_CODE_EXIPRED_AFTER</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
    <span class="token string">'verification_code'</span>
  <span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>從這邊我們看到一個重點，就是在系統內 code 的產生分兩種類型，strong 的是 <code>nanoid(40)</code>，不 strong 的則是 100000~999999 的六碼數字，而這個 strong 的參數是由有沒有傳入 <code>redirectUrl</code> 而決定的。</p>
<p>也就是說，如果我們在建立 reset password 的驗證碼時把 <code>redirectUrl</code> 參數拿掉，code 就會從原本的 40 個字，瞬間降低成六位數的數字！</p>
<p>而驗證碼的過期時間 <code>VERIFICATION_CODE_EXIPRED_AFTER</code> 是五分鐘，也就是 300 秒，900000&#x2F;300 &#x3D; 3000，只要我們一秒能發送 3000 個 request 到 server，就能暴力破解 reset password 的 token，進而奪取使用者帳號。</p>
<p>但其實這樣的說法不太精確，因為我們可以發 3000 個，不代表 server 就可以處理 3000 個，所以還要看 server 能接受的 request 數量，而且在這之前，還有另一個限制要繞過。</p>
<h2><span id="rate-limiting">Rate limiting</span></h2><p>增加暴力破解難度的方法之一就是 rate limiting，許多網站或是 WAF 都有這個功能，能夠阻止短時間內大量的 request。</p>
<p>而 Matters 的 rate limit 是用 nginx 來處理，程式碼在這裡：<a target="_blank" rel="noopener" href="https://github.com/thematters/matters-server/blob/v3.19.0/.ebextensions/rate-limit-connections.config">https://github.com/thematters/matters-server/blob/v3.19.0/.ebextensions/rate-limit-connections.config</a></p>
<pre class="line-numbers language-none"><code class="language-none">limit_req_zone $http_x_forwarded_for zone&#x3D;application:16m rate&#x3D;5r&#x2F;s;

limit_req zone&#x3D;application burst&#x3D;20 nodelay;
limit_req_status 429;
limit_conn_status 429;

# pass real IP from client to NGINX
real_ip_header X-Forwarded-For;
set_real_ip_from 0.0.0.0&#x2F;0;

server &#123;
    # set error page for HTTP code 429
    error_page 429 @ratelimit;
    location @ratelimit &#123;
        return 429 &#39;[&quot;Connection Limit Exceeded&quot;]\n&#39;;
    &#125;

    listen 80;

    # 底下省略
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>nginx 的 rate limit 基本上都是以 IP 為主，如果真的想繞過的話可以嘗試看看 <a target="_blank" rel="noopener" href="https://rhinosecuritylabs.com/aws/bypassing-ip-based-blocking-aws/">IP rotate</a>，一個簡單的方式是去 AWS 上開很多 API gateway 當 proxy，然後你就有了一堆不同的 IP 可以輪流使用。</p>
<p>但這邊還用不上這個技巧，因為在設定中可以看到它使用了 <code>$http_x_forwarded_for</code> 這個參數，如果沒有管理好的話，可以自己傳入 <code>X-Forwarded-For</code> 來偽造任意 IP，藉此繞過 rate limit 的限制。</p>
<p>而 Matters 在這邊顯然沒有設置好，因此 rate limit 算是虛設。</p>
<p>做到這邊，只要我們能夠一秒發送 3000 個 request 就能做出 POC，證明攻擊確實可行，但還有沒有其他的方法，能讓這個數字再小一點呢？</p>
<h2><span id="同時存在的驗證碼">同時存在的驗證碼</span></h2><p>在開頭的時候有提過重設密碼有一些小細節要注意，像是：</p>
<ol>
<li>重設密碼的 token 應該只能使用一次</li>
<li>重設密碼的 token 應該要有過期時間</li>
<li>如果使用者產生了新的重設密碼 token，舊的應該要廢棄</li>
</ol>
<p>而 Matters 前兩點都做了，就是唯獨第三點沒有做好。從程式碼中我們可以看出當新的驗證碼建立時，舊的並不會刪除或是標記為廢棄。</p>
<p>這會有什麼影響呢？我們來算個簡單的數學吧！</p>
<p>驗證碼的組合總共有 900,000 種，我們有 300 秒的時間可以攻擊，如果可以在這段時間內發送 900,000 個 request 而且 server 也有處理，就一定可以猜到重設密碼的驗證碼。</p>
<p>若是我們改成先不要猜，而是先發送 1000 次的重設密碼請求，因為舊的驗證碼依然有效，所以這時我們猜一次，猜中任何一組的機率就是 1000&#x2F;900000 &#x3D; 1&#x2F;900，變成原本的 1000 倍。</p>
<p>猜 1000 次的話，猜中的機率就是「1 - 每次都猜不中的機率」，大約是 <code>1 - (899/900)^1000</code> &#x3D; 67%，如果猜到 5000 次的話，猜中的機率就是 <code>1 - (899/900)^5000</code> &#x3D; 99.6%。</p>
<p>也就是說，我們只要發送 1000 個重設密碼的請求外加 5000 個確認驗證碼的請求，總共 6000 個請求，就有 99.6% 的機率可以正確猜到至少一組驗證碼！</p>
<p>可以寫個簡單的小程式來驗證我們的機率計算：</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> _ <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'lodash'</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> rounds <span class="token operator">=</span> <span class="token number">100000</span> <span class="token comment">// 跑十萬輪取平均 </span>
<span class="token keyword">const</span> guessRounds <span class="token operator">=</span> <span class="token number">5000</span> <span class="token comment">// 猜 5000 次</span>
<span class="token keyword">const</span> tokenCount <span class="token operator">=</span> <span class="token number">1000</span> <span class="token comment">// 1000 個合法驗證碼</span>
<span class="token keyword">let</span> winCount <span class="token operator">=</span> <span class="token number">0</span> 

<span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">let</span> r<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> r<span class="token operator">&lt;</span>rounds<span class="token punctuation">;</span> r<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">let</span> ans <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
  <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">let</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span>tokenCount<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    ans<span class="token punctuation">[</span>_<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token number">100000</span><span class="token punctuation">,</span> <span class="token number">999999</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">true</span>
  <span class="token punctuation">&#125;</span>
  <span class="token keyword">let</span> isWin <span class="token operator">=</span> <span class="token boolean">false</span>
  <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">let</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span>guessRounds<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">const</span> guessNumber <span class="token operator">=</span> _<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token number">100000</span><span class="token punctuation">,</span> <span class="token number">999999</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ans<span class="token punctuation">[</span>guessNumber<span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      isWin <span class="token operator">=</span> <span class="token boolean">true</span>
      <span class="token keyword">break</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>isWin<span class="token punctuation">)</span> winCount<span class="token operator">++</span>
<span class="token punctuation">&#125;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>winCount<span class="token operator">*</span><span class="token number">100</span> <span class="token operator">/</span> rounds<span class="token punctuation">)</span>
<span class="token comment">// 輸出：99.626，我們算出的機率差不多</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>原本要發 900,001 個 request 才能有 100% 的機率可以猜中，現在只要犧牲一點點正確性，變成 99.6% 的機率猜中，就可以把 request 數量降低到 6000 次，低了 150 倍！</p>
<p>原本我們在五分鐘內一秒要發 3000 個 request，現在一秒只要 20 個 request 就好（其實這邊也只是大略計算，因為是有順序性的，必須要等 1000 個發送驗證碼的 request 結束後才能開始猜，而這 1000 個可能又會花個幾秒，但這邊為了方便計算先忽略不計，對整體的影響不大）</p>
<p>就因為這個重設密碼的小缺陷，沒有把上一組驗證碼淘汰掉，導致我們可以產生多組驗證碼，大幅降低暴力破解的難度。只要能在五分鐘內發送 6000 個 request，就有 99.6% 的機率可以更改一組帳號的密碼。</p>
<p>由於這是重設密碼功能，所以改完密碼之後你就可以直接用他的身份登入系統，達成帳號奪取，把其他人的帳號都變成是你的。如果想要擴大影響性的話，可以奪取管理員的帳號，就有機會進入管理後台進行更多操作。</p>
<h2><span id="建議修補方式">建議修補方式</span></h2><p>第一個要修的地方是重設密碼的小缺陷，在使用者產生新的驗證碼時，舊的應該要被淘汰掉，保證永遠只有最新的一組可以通過驗證，這樣攻擊者猜中的機率就永遠是 1&#x2F;n，而不會像上面的範例那樣，可以把機率提高 1000 倍或更多倍。</p>
<p>第二個則是驗證碼的產生不該由 <code>redirectUrl</code> 參數來決定，而是應該由驗證碼的 type 來決定，如果是 reset password，就一定要是 strong，這樣子就會用 <code>nanoid(40)</code> 來產生，猜中的機率就變得微乎其微，大幅降低暴力破解的可行性。</p>
<p>第三個是 redirectUrl 不應該從前端傳入，而是直接把網址寫在後端。如果真的要從前端傳入，那後端要做好完善的檢查，確保 redirectUrl 傳入的是合法的路徑，而不是讓攻擊者可以傳入任意網址（不過如果攻擊者能結合 <a target="_blank" rel="noopener" href="https://tech-blog.cymetrics.io/posts/huli/open-redirect/">open redirect</a>，又是另外一回事了）</p>
<p>最後一個則是 nginx 的 rate limit 限制不應該用 <code>X-Forwarded-For</code> 來決定，就算真的要用這個，也要確保它的值無法由攻擊者自行傳入。</p>
<h2><span id="總結">總結</span></h2><p>重設密碼機制看似簡單，但其實一不小心還是有可能做出有漏洞的機制，導致攻擊者有機可趁，在 HackTricks 上有個頁面專門在講 reset password 可能會有的問題：<a target="_blank" rel="noopener" href="https://book.hacktricks.xyz/pentesting-web/reset-password">Reset&#x2F;Forgotten Password Bypass</a>，除了這篇提到的以外還有更多的問題，整理得很詳細，很值得參考看看。</p>
<p>如果你以為只有一般的網站會有這種問題，那你就錯了。一名資安研究員 Laxman Muthiyah 發現可以用 concurrent 的方式繞過 <a target="_blank" rel="noopener" href="https://thezerohack.com/hack-any-instagram">Instagram</a> 的 rate limiting，成功發送 200 個 request，並且用 1000 台機器產生出 20 萬個 request，就有 20% 的機率攻擊成功。</p>
<p>只要有 5000 台機器，就能拿下任何帳號。5000 台聽起來很多，成本應該很高對吧？但如果善用 cloud service 的話，他估算可能只需要 150 美金左右即可達成一次攻擊（因為算小時收費，只要開一兩個小時即可）</p>
<p>而他也在去年七月用同樣的手法繞過<a target="_blank" rel="noopener" href="https://thezerohack.com/how-i-might-have-hacked-any-microsoft-account">微軟</a>的 rate limiting，並且拿到 5 萬美金的獎金。</p>
<p>像這種漏洞如果能成功被利用，就能夠直接奪取他人的帳號，影響很大，需要多加注意相關的安全性。看到這裡，大家不妨也檢查一下自家的重設密碼機制是否安全。</p>
<p>最後，這次找到漏洞以後一樣有回報給 Matters，底下是完整時間軸：</p>
<p><code>2021-06-24</code> 回報漏洞給 Matters<br><code>2021-06-25</code> 收到 Matters 回覆，確認漏洞存在<br><code>2021-08-20</code> Matters 修復部分功能，產生新的驗證碼時會淘汰舊的<br><code>2021-08-26</code> Matters 確認漏洞評級為 High，獎金為 150 USD<br><code>2021-10-28</code> 關心後續修復狀況，確認是否修補完畢<br><code>2021-11-30</code> Matters 增強 non-strong 的驗證碼基數<br><code>2021-12-02</code> 文章初稿完成，與 Matters 確認是否可發布<br><code>2021-12-21</code> Matters 確認問題已修復完畢以及可發布文章</p>

    
    </div>
    
    <div class="columns is-variable is-1 is-multiline is-mobile">
    
        <span class="column is-narrow"><a class="tag is-light article-tag" href="/tags/Security/">#Security</a></span>
    
    </div>
    
    
    <div class="columns is-mobile is-multiline article-nav">
        <span class="column is-12-mobile is-half-desktop  article-nav-prev">
            
            <a href="/2022/01/15/js-history/">從歷史開始認識 JavaScript</a>
            
        </span>
        <span class="column is-12-mobile is-half-desktop  article-nav-next">
            
            <a href="/2021/12/18/what-is-log4j-and-log4shell/">從監視攝影機理解 Log4j 跟 Log4Shell 漏洞</a>
            
        </span>
    </div>
    
</article>




<div class="comments">
    <h3 class="title is-4">評論</h3>
    <script src="https://utteranc.es/client.js"
        repo="aszx87410/huli-blog"
        issue-term="title"
        theme="github-light"
        crossorigin="anonymous"
        async>
</script>
</div>

    </div>
</section>
    <footer class="footer">
    <div class="container">
        <div class="columns content">
            <div class="column is-narrow has-text-centered">
                &copy; 2025 Huli&nbsp;
                Powered by <a href="http://hexo.io/" target="_blank">Hexo</a> & <a
                        target="_blank" rel="noopener" href="http://github.com/ppoffice/hexo-theme-minos">Minos</a>
            </div>
            <div class="column is-hidden-mobile"></div>

            
            <div class="column is-narrow">
                <div class="columns is-mobile is-multiline is-centered">
                
                    
                <a class="column is-narrow" title="GitHub" target="_blank" rel="noopener" href="https://github.com/ppoffice/hexo-theme-minos">
                    
                    GitHub
                    
                </a>
                
                </div>
            </div>
            
            
<div class="column is-narrow has-text-centered">
    <div class="dropdown is-up is-right is-hoverable" style="margin-top: -0.2em;">
        <div class="dropdown-trigger">
            <button class="button is-small" aria-haspopup="true">
                <span class="icon">
                    <i class="fas fa-globe"></i>
                </span>
                <span>繁體中文</span>
                <span class="icon is-small">
            <i class="fas fa-angle-down" aria-hidden="true"></i>
          </span>
            </button>
        </div>
        <div class="dropdown-menu has-text-left" role="menu" style="top:100%">
            <div class="dropdown-content">
            <!-- NOTE: 永遠回到首頁 -->
            
                <a href="/2022/01/04/en/reset-password-vulnerability/" class="dropdown-item">
                    English
                </a>
            
            </div>
        </div>
    </div>
</div>

        </div>
    </div>
</footer>
    <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/3.6.3/jquery.min.js"></script>



    
    
    
    
    
    
<script src="//cdnjs.cloudflare.com/ajax/libs/lightgallery/1.6.8/js/lightgallery-all.min.js"></script>
<script>
    (function ($) {
        $(document).ready(function () {
            if (typeof($.fn.lightGallery) === 'function') {
                $('.article.gallery').lightGallery({ selector: '.gallery-item' });
            }
        });
    })(jQuery);
</script>

    
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.0/clipboard.min.js"></script>
    <style>
        .hljs {
            position: relative;
        }

        .hljs .clipboard-btn {
            float: right;
            color: #9a9a9a;
            background: none;
            border: none;
            cursor: pointer;
        }

        .hljs .clipboard-btn:hover {
          color: #8a8a8a;
        }

        .hljs > .clipboard-btn {
            display: none;
            position: absolute;
            right: 4px;
            top: 4px;
        }

        .hljs:hover > .clipboard-btn {
            display: inline;
        }

        .hljs > figcaption > .clipboard-btn {
            margin-right: 4px;
        }
    </style>
    <script>
      $(document).ready(function () {
        $('figure.hljs').each(function(i, figure) {
          var codeId = 'code-' + i;
          var code = figure.querySelector('.code');
          var copyButton = $('<button>Copy <i class="far fa-clipboard"></i></button>');
          code.id = codeId;
          copyButton.addClass('clipboard-btn');
          copyButton.attr('data-clipboard-target-id', codeId);

          var figcaption = figure.querySelector('figcaption');

          if (figcaption) {
            figcaption.append(copyButton[0]);
          } else {
            figure.prepend(copyButton[0]);
          }
        })

        var clipboard = new ClipboardJS('.clipboard-btn', {
          target: function(trigger) {
            return document.getElementById(trigger.getAttribute('data-clipboard-target-id'));
          }
        });
        clipboard.on('success', function(e) {
          e.clearSelection();
        })
      })
    </script>

    
    

    



<script src="/js/script.js?v=3.js"></script>


    
</body>
</html>