<!DOCTYPE html>
<html class="has-navbar-fixed-top" lang="en">
<head>
    <meta charset="utf-8">
<title>Details of Amelia &lt; 1.0.49 Sensitive Information Disclosure Vulnerability - Huli&#39;s blog</title>
<meta name="viewport" content="width=device-width, initial-scale=1">



            
<link href="https://blog.huli.tw/2022/03/30/wordpress-plugin-amelia-sensitive-information-disclosure/" rel="alternate" hreflang="zh-TW" />
            
    




    
<link rel="canonical" href="https://blog.huli.tw/2022/03/30/en/wordpress-plugin-amelia-sensitive-information-disclosure/">
    





    <meta name="description" content="Amelia is a WordPress plugin developed by TMS that allows you to easily add a booking system to your WordPress website, such as for clinics, hair salons, or tutoring, making it ideal for setting up a">
<meta property="og:type" content="article">
<meta property="og:title" content="Details of Amelia &lt; 1.0.49 Sensitive Information Disclosure Vulnerability">
<meta property="og:url" content="https://blog.huli.tw/2022/03/30/en/wordpress-plugin-amelia-sensitive-information-disclosure/index.html">
<meta property="og:site_name" content="Huli&#39;s blog">
<meta property="og:description" content="Amelia is a WordPress plugin developed by TMS that allows you to easily add a booking system to your WordPress website, such as for clinics, hair salons, or tutoring, making it ideal for setting up a">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://blog.huli.tw/img/wordpress-plugin-amelia-sensitive-information-disclosure/cover-en.png">
<meta property="article:published_time" content="2022-03-30T04:00:00.000Z">
<meta property="article:modified_time" content="2023-06-20T05:10:49.082Z">
<meta property="article:author" content="Huli">
<meta property="article:tag" content="Security">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://blog.huli.tw/img/wordpress-plugin-amelia-sensitive-information-disclosure/cover-en.png">



<link rel="alternative" href="/atom.xml" title="Details of Amelia &lt; 1.0.49 Sensitive Information Disclosure Vulnerability" type="application/atom+xml">



<link rel="icon" href="/img/lidemy_logo.png">


<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Ovo|Source+Code+Pro">


<link rel="stylesheet" href="/css/bulma.css?v=2.css">



<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/lightgallery/1.6.8/css/lightgallery.min.css">


<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/line-numbers/prism-line-numbers.min.css" />


<link rel="stylesheet" href="/css/style.css?v=4.css">





    
    
    
    
    
    
    
    
    
    
<script async src="https://www.googletagmanager.com/gtag/js?id=G-1393J2EVCZ"></script>
<script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-1393J2EVCZ');
</script>


    


<meta name="generator" content="Hexo 6.3.0"></head>
<body>
    <script>
        if (localStorage.getItem('dark-mode')) {
            if (localStorage.getItem('dark-mode') === 'true') {
                document.body.classList.add('dark-mode')
            }
        } else {
            if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                document.body.classList.add('dark-mode')
            }
        }
    </script>
    
<nav class="navbar is-transparent is-fixed-top navbar-main" role="navigation" aria-label="main navigation">
    <div class="container">
        <div class="navbar-brand">
            <a class="navbar-item navbar-logo" href="/en">
                
                    
                    Huli&#39;s blog
                    
                
            </a>
            <div class="navbar-burger">
                <span></span>
                <span></span>
                <span></span>
            </div>
        </div>
        
        <div class="navbar-menu navbar-start">
            
            <a class="navbar-item "
               href="/en/archives">Archive</a>
            
            <a class="navbar-item "
               href="/en/categories">Categories</a>
            
            <a class="navbar-item "
               href="/en/about">About</a>
            
        </div>
        
        <div class="navbar-menu navbar-end">
            
            
            <div class="navbar-item is-hoverable has-dropdown is-hidden-mobile is-hidden-tablet-only toc">
                <a class="navbar-item" title="Table of Contents">
                    Table of Contents
                </a>
                <div class="navbar-dropdown">
                    
                    
                    
                    
                    <a class="navbar-item" href="#introduction-to-amelia">1&nbsp;&nbsp;<b>Introduction to Amelia</b></a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#introduction-to-wordpress-plugins-and-amelia-architecture">2&nbsp;&nbsp;<b>Introduction to WordPress Plugins and Amelia Architecture</b></a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#cve-2022-0720-amelia-lt-1047-customer-arbitrary-appointments-update-and-sensitive-data-disclosure">3&nbsp;&nbsp;<b>CVE-2022-0720: Amelia &amp;lt; 1.0.47 - Customer+ Arbitrary Appointments Update and Sensitive Data Disclosure</b></a>
                    
                    
                    
                    <a class="navbar-item" href="#fix">3.1&nbsp;&nbsp;Fix</a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#cve-2022-0825-amelia-lt-1049-customer-arbitrary-appointments-status-update">4&nbsp;&nbsp;<b>CVE-2022-0825: Amelia &amp;lt; 1.0.49 - Customer+ Arbitrary Appointments Status Update</b></a>
                    
                    
                    
                    <a class="navbar-item" href="#fix">4.1&nbsp;&nbsp;Fix</a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#cve-2022-0837-amelia-lt-1048-customer-sms-service-abuse-and-sensitive-data-disclosure">5&nbsp;&nbsp;<b>CVE-2022-0837: Amelia &amp;lt; 1.0.48 - Customer+ SMS Service Abuse and Sensitive Data Disclosure</b></a>
                    
                    
                    
                    <a class="navbar-item" href="#fix">5.1&nbsp;&nbsp;Fix</a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#conclusion">6&nbsp;&nbsp;<b>Conclusion</b></a>
                    
                </div>
            </div>
            
            
            <a class="navbar-item" target="_blank" title="Twitter" href="https://twitter.com/aszx87410">
                
                <i class="fab fa-twitter"></i>
                
            </a>
               
            <a class="navbar-item" target="_blank" title="RSS" href="/atom-en.xml">
                
                <i class="fas fa-rss"></i>
                
            </a>
               
            
            <a class="navbar-item btn-dark-mode" title="dark-mode" href="#">
                <div>
                    <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" width="15" height="15" viewBox="0 0 256 256" xml:space="preserve">
                    <defs>
                    </defs>
                    <g style="stroke: none; stroke-width: 0; stroke-dasharray: none; stroke-linecap: butt; stroke-linejoin: miter; stroke-miterlimit: 10; fill: none; fill-rule: nonzero; opacity: 1;" transform="translate(1.4065934065934016 1.4065934065934016) scale(2.81 2.81)" >
                        <path d="M 87.823 60.7 c -0.463 -0.423 -1.142 -0.506 -1.695 -0.214 c -15.834 8.398 -35.266 2.812 -44.232 -12.718 c -8.966 -15.53 -4.09 -35.149 11.101 -44.665 c 0.531 -0.332 0.796 -0.963 0.661 -1.574 c -0.134 -0.612 -0.638 -1.074 -1.259 -1.153 c -9.843 -1.265 -19.59 0.692 -28.193 5.66 C 13.8 12.041 6.356 21.743 3.246 33.35 S 1.732 57.08 7.741 67.487 c 6.008 10.407 15.709 17.851 27.316 20.961 C 38.933 89.486 42.866 90 46.774 90 c 7.795 0 15.489 -2.044 22.42 -6.046 c 8.601 -4.966 15.171 -12.43 18.997 -21.586 C 88.433 61.79 88.285 61.123 87.823 60.7 z" style="stroke: none; stroke-width: 1; stroke-dasharray: none; stroke-linecap: butt; stroke-linejoin: miter; stroke-miterlimit: 10; fill: #ffa716; fill-rule: nonzero; opacity: 1;" transform=" matrix(1 0 0 1 0 0) " stroke-linecap="round" />
                    </g>
                    </svg>
                </div>
            </a>
            
               <a class="navbar-item" href="/2022/03/30/wordpress-plugin-amelia-sensitive-information-disclosure/">中文</a>
            
            

        </div>
    </div>
</nav>

    <section class="section">
    <div class="container">
      
      <div data-nosnippet class="self-notice">
        If you have any thoughts on my blog or articles and you want to let me know, you can either post a comment below(public) or tell me via this <a href="https://forms.gle/SjJZ4cnNs6NnjXQG8" target="_blank">feedback form</a>
      </div>
      
    <article class="article content gallery" itemscope itemprop="blogPost">
    <h1 class="article-title is-size-3 is-size-4-mobile" itemprop="name">
        
            Details of Amelia &lt; 1.0.49 Sensitive Information Disclosure Vulnerability
        
    </h1>
    <div class="article-meta columns is-variable is-1 is-multiline is-mobile is-size-7-mobile">
        <span class="column is-narrow">
            <time datetime="2022-03-30T04:00:00.000Z" itemprop="datePublished">30 March 2022</time>
        </span>
        
        <span class="column is-narrow article-category">
            <i class="far fa-folder"></i>
            <a class="article-category-link" href="/en/categories/Security/">Security</a>
        </span>
        
        
        
        <spen data-nosnippet class="column is-narrow">(Translated by ChatGPT)</span>
        
    </div>
    
    <div class="article-entry is-size-6-mobile" itemprop="articleBody">
    
        <p><a target="_blank" rel="noopener" href="https://tw.wordpress.org/plugins/ameliabooking/">Amelia</a> is a WordPress plugin developed by TMS that allows you to easily add a booking system to your WordPress website, such as for clinics, hair salons, or tutoring, making it ideal for setting up a simple reservation system. According to official WordPress statistics, approximately 40,000 websites have installed this plugin.</p>
<p>In early March, I conducted some research on the source code of the Amelia system and found three vulnerabilities that all involve sensitive information disclosure:</p>
<ul>
<li><code>CVE-2022-0720</code> Amelia &lt; 1.0.47 - Customer+ Arbitrary Appointments Update and Sensitive Data Disclosure (CVSS 6.3)</li>
<li><code>CVE-2022-0825</code> Amelia &lt; 1.0.49 - Customer+ Arbitrary Appointments Status Update (CVSS 6.3)</li>
<li><code>CVE-2022-0837</code> Amelia &lt; 1.0.48 - Customer+ SMS Service Abuse and Sensitive Data Disclosure (CVSS 5.4)</li>
</ul>
<p>If attackers exploit these vulnerabilities, they can obtain all consumer data, including names, phone numbers, and reservation information.</p>
<p>Below, I will briefly introduce the architecture of Amelia and the details of these three vulnerabilities.</p>
<span id="more"></span>

<h2><span id="introduction-to-amelia">Introduction to Amelia</span></h2><p>After installing Amelia, you can add a reservation page that looks something like this:</p>
<p><img src="/img/wordpress-plugin-amelia-sensitive-information-disclosure/p1-intro-1.png" alt="intro1"></p>
<p>When making a reservation, you need to provide some basic information, such as your name and email address, and once entered, the reservation is complete:</p>
<p><img src="/img/wordpress-plugin-amelia-sensitive-information-disclosure/p2-intro-2.png" alt="intro2"></p>
<p>After completing the reservation, Amelia will create a low-privilege account in the WordPress system for you and send a password reset link to the email address you provided. Once the account is activated, you can log in to WordPress to manage your reservation:</p>
<p><img src="/img/wordpress-plugin-amelia-sensitive-information-disclosure/p3-intro-3.png" alt="intro3"></p>
<p>After introducing how to use it, let’s take a look at the more technical aspects.</p>
<h2><span id="introduction-to-wordpress-plugins-and-amelia-architecture">Introduction to WordPress Plugins and Amelia Architecture</span></h2><p>There are many WordPress plugins, each with a different writing style, but because they are plugins, they call the functions provided by WordPress to register events.</p>
<p>The <code>add_action</code> function plays a very important role. You can add a hook to a specific action, and when that action is triggered, it will call the function you provided.</p>
<p>Actions starting with <code>wp_ajax_nopriv_</code> can be called through <code>wp-admin/admin-ajax.php</code>, and the relevant code excerpt is as follows (<a target="_blank" rel="noopener" href="https://github.com/WordPress/WordPress/blob/master/wp-admin/admin-ajax.php">admin-ajax.php</a>):</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>

<span class="token variable">$action</span> <span class="token operator">=</span> <span class="token variable">$_REQUEST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'action'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token function">is_user_logged_in</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token comment">// If no action is registered, return a Bad Request response.</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span> <span class="token function">has_action</span><span class="token punctuation">(</span> <span class="token string double-quoted-string">"wp_ajax_<span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token variable">$action</span><span class="token punctuation">&#125;</span></span>"</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token function">wp_die</span><span class="token punctuation">(</span> <span class="token string single-quoted-string">'0'</span><span class="token punctuation">,</span> <span class="token number">400</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token comment">/**
   * Fires authenticated Ajax actions for logged-in users.
   *
   * The dynamic portion of the hook name, `$action`, refers
   * to the name of the Ajax action callback being fired.
   *
   * @since 2.1.0
   */</span>
  <span class="token function">do_action</span><span class="token punctuation">(</span> <span class="token string double-quoted-string">"wp_ajax_<span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token variable">$action</span><span class="token punctuation">&#125;</span></span>"</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
  <span class="token comment">// If no action is registered, return a Bad Request response.</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span> <span class="token function">has_action</span><span class="token punctuation">(</span> <span class="token string double-quoted-string">"wp_ajax_nopriv_<span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token variable">$action</span><span class="token punctuation">&#125;</span></span>"</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token function">wp_die</span><span class="token punctuation">(</span> <span class="token string single-quoted-string">'0'</span><span class="token punctuation">,</span> <span class="token number">400</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token comment">/**
   * Fires non-authenticated Ajax actions for logged-out users.
   *
   * The dynamic portion of the hook name, `$action`, refers
   * to the name of the Ajax action callback being fired.
   *
   * @since 2.8.0
   */</span>
  <span class="token function">do_action</span><span class="token punctuation">(</span> <span class="token string double-quoted-string">"wp_ajax_nopriv_<span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token variable">$action</span><span class="token punctuation">&#125;</span></span>"</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token delimiter important">?></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>For Amelia, two hooks are registered in <code>ameliabooking.php</code>:</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token comment">/** Isolate API calls */</span>
<span class="token function">add_action</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'wp_ajax_wpamelia_api'</span><span class="token punctuation">,</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'AmeliaBooking\Plugin'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'wpAmeliaApiCall'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">add_action</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'wp_ajax_nopriv_wpamelia_api'</span><span class="token punctuation">,</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'AmeliaBooking\Plugin'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'wpAmeliaApiCall'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p><code>nopriv</code> means that no permission (not logged in) is required to call it, and without it, you need to log in to the WordPress system to call it. Many plugins choose to handle authentication-related logic themselves, so they will redirect both actions to the same place.</p>
<p>The <code>wpAmeliaApiCall</code> function registers routes:</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token comment">/**
 * API Call
 *
 * @throws \InvalidArgumentException
 */</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">function</span> <span class="token function-definition function">wpAmeliaApiCall</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">/** @var Container $container */</span>
        <span class="token variable">$container</span> <span class="token operator">=</span> <span class="token keyword">require</span> <span class="token constant">AMELIA_PATH</span> <span class="token operator">.</span> <span class="token string single-quoted-string">'/src/Infrastructure/ContainerConfig/container.php'</span><span class="token punctuation">;</span>

        <span class="token variable">$app</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">App</span><span class="token punctuation">(</span><span class="token variable">$container</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// Initialize all API routes</span>
        <span class="token class-name static-context">Routes</span><span class="token operator">::</span><span class="token function">routes</span><span class="token punctuation">(</span><span class="token variable">$app</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token variable">$app</span><span class="token operator">-></span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">exit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> <span class="token variable">$e</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">echo</span> <span class="token string single-quoted-string">'ERROR: '</span> <span class="token operator">.</span> <span class="token variable">$e</span><span class="token operator">-></span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>Under <code>src/Infrastructure/Routes</code>, there are many folders and files that handle different routes. For example, user-related routes are in <code>src/Infrastructure/Routes/User/User.php</code>, and the relevant code excerpt is as follows:</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token comment">/**
 * Class User
 *
 * @package AmeliaBooking\Infrastructure\Routes\User
 */</span>
<span class="token keyword">class</span> <span class="token class-name-definition class-name">User</span>
<span class="token punctuation">&#123;</span>
    <span class="token comment">/**
     * @param App $app
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">function</span> <span class="token function-definition function">routes</span><span class="token punctuation">(</span><span class="token class-name type-declaration">App</span> <span class="token variable">$app</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        <span class="token variable">$app</span><span class="token operator">-></span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'/users/wp-users'</span><span class="token punctuation">,</span> <span class="token class-name static-context">GetWPUsersController</span><span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$app</span><span class="token operator">-></span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'/users/authenticate'</span><span class="token punctuation">,</span> <span class="token class-name static-context">LoginCabinetController</span><span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$app</span><span class="token operator">-></span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'/users/logout'</span><span class="token punctuation">,</span> <span class="token class-name static-context">LogoutCabinetController</span><span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// Customers</span>
        <span class="token variable">$app</span><span class="token operator">-></span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'/users/customers/&#123;id:[0-9]+&#125;'</span><span class="token punctuation">,</span> <span class="token class-name static-context">GetCustomerController</span><span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$app</span><span class="token operator">-></span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'/users/customers'</span><span class="token punctuation">,</span> <span class="token class-name static-context">GetCustomersController</span><span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$app</span><span class="token operator">-></span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'/users/customers'</span><span class="token punctuation">,</span> <span class="token class-name static-context">AddCustomerController</span><span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$app</span><span class="token operator">-></span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'/users/customers/&#123;id:[0-9]+&#125;'</span><span class="token punctuation">,</span> <span class="token class-name static-context">UpdateCustomerController</span><span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$app</span><span class="token operator">-></span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'/users/customers/delete/&#123;id:[0-9]+&#125;'</span><span class="token punctuation">,</span> <span class="token class-name static-context">DeleteUserController</span><span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$app</span><span class="token operator">-></span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'/users/customers/effect/&#123;id:[0-9]+&#125;'</span><span class="token punctuation">,</span> <span class="token class-name static-context">GetUserDeleteEffectController</span><span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$app</span><span class="token operator">-></span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'/users/customers/reauthorize'</span><span class="token punctuation">,</span> <span class="token class-name static-context">ReauthorizeController</span><span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// Providers</span>
        <span class="token variable">$app</span><span class="token operator">-></span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'/users/providers/&#123;id:[0-9]+&#125;'</span><span class="token punctuation">,</span> <span class="token class-name static-context">GetProviderController</span><span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$app</span><span class="token operator">-></span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'/users/providers'</span><span class="token punctuation">,</span> <span class="token class-name static-context">GetProvidersController</span><span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$app</span><span class="token operator">-></span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'/users/providers'</span><span class="token punctuation">,</span> <span class="token class-name static-context">AddProviderController</span><span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$app</span><span class="token operator">-></span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'/users/providers/&#123;id:[0-9]+&#125;'</span><span class="token punctuation">,</span> <span class="token class-name static-context">UpdateProviderController</span><span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$app</span><span class="token operator">-></span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'/users/providers/status/&#123;id:[0-9]+&#125;'</span><span class="token punctuation">,</span> <span class="token class-name static-context">UpdateProviderStatusController</span><span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$app</span><span class="token operator">-></span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'/users/providers/delete/&#123;id:[0-9]+&#125;'</span><span class="token punctuation">,</span> <span class="token class-name static-context">DeleteUserController</span><span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$app</span><span class="token operator">-></span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'/users/providers/effect/&#123;id:[0-9]+&#125;'</span><span class="token punctuation">,</span> <span class="token class-name static-context">GetUserDeleteEffectController</span><span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// Current User</span>
        <span class="token variable">$app</span><span class="token operator">-></span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'/users/current'</span><span class="token punctuation">,</span> <span class="token class-name static-context">GetCurrentUserController</span><span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>So how do we actually call these routes? In <code>src/Infrastructure/ContainerConfig/request.php</code>, some transformations are made for the query string of the request:</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>

<span class="token keyword">use</span> <span class="token package">Slim<span class="token punctuation">\</span>Http<span class="token punctuation">\</span>Request</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token package">Slim<span class="token punctuation">\</span>Http<span class="token punctuation">\</span>Uri</span><span class="token punctuation">;</span>

<span class="token variable">$entries</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'request'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token class-name class-name-fully-qualified type-declaration">AmeliaBooking<span class="token punctuation">\</span>Infrastructure<span class="token punctuation">\</span>Common<span class="token punctuation">\</span>Container</span> <span class="token variable">$c</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

    <span class="token variable">$curUri</span> <span class="token operator">=</span> <span class="token class-name static-context">Uri</span><span class="token operator">::</span><span class="token function">createFromEnvironment</span><span class="token punctuation">(</span><span class="token variable">$c</span><span class="token operator">-></span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'environment'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 附註：AMELIA_ACTION_SLUG = "action=wpamelia_api&amp;call="</span>
    <span class="token variable">$newRoute</span> <span class="token operator">=</span> <span class="token function">str_replace</span><span class="token punctuation">(</span>
        <span class="token punctuation">[</span><span class="token string single-quoted-string">'XDEBUG_SESSION_START=PHPSTORM&amp;'</span> <span class="token operator">.</span> <span class="token constant">AMELIA_ACTION_SLUG</span><span class="token punctuation">,</span> <span class="token constant">AMELIA_ACTION_SLUG</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token string single-quoted-string">''</span><span class="token punctuation">,</span>
        <span class="token variable">$curUri</span><span class="token operator">-></span><span class="token function">getQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token variable">$newPath</span> <span class="token operator">=</span> <span class="token function">strpos</span><span class="token punctuation">(</span><span class="token variable">$newRoute</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'&amp;'</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token function">substr</span><span class="token punctuation">(</span>
        <span class="token variable">$newRoute</span><span class="token punctuation">,</span>
        <span class="token number">0</span><span class="token punctuation">,</span>
        <span class="token function">strpos</span><span class="token punctuation">(</span><span class="token variable">$newRoute</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'&amp;'</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token variable">$newRoute</span><span class="token punctuation">;</span>

    <span class="token variable">$newQuery</span> <span class="token operator">=</span> <span class="token function">strpos</span><span class="token punctuation">(</span><span class="token variable">$newRoute</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'&amp;'</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token function">substr</span><span class="token punctuation">(</span>
        <span class="token variable">$newRoute</span><span class="token punctuation">,</span>
        <span class="token function">strpos</span><span class="token punctuation">(</span><span class="token variable">$newRoute</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'&amp;'</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span>
    <span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token string single-quoted-string">''</span><span class="token punctuation">;</span>

   <span class="token variable">$request</span> <span class="token operator">=</span> <span class="token class-name static-context">Request</span><span class="token operator">::</span><span class="token function">createFromEnvironment</span><span class="token punctuation">(</span><span class="token variable">$c</span><span class="token operator">-></span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'environment'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
       <span class="token operator">-></span><span class="token function">withUri</span><span class="token punctuation">(</span>
           <span class="token variable">$curUri</span>
               <span class="token operator">-></span><span class="token function">withPath</span><span class="token punctuation">(</span><span class="token variable">$newPath</span><span class="token punctuation">)</span>
               <span class="token operator">-></span><span class="token function">withQuery</span><span class="token punctuation">(</span><span class="token variable">$newQuery</span><span class="token punctuation">)</span>
       <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">method_exists</span><span class="token punctuation">(</span><span class="token variable">$request</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'getParam'</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token variable">$request</span><span class="token operator">-></span><span class="token function">getParam</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'showAmeliaErrors'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token function">ini_set</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'display_errors'</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">ini_set</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'display_startup_errors'</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">error_reporting</span><span class="token punctuation">(</span><span class="token constant">E_ALL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">return</span> <span class="token variable">$request</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>Simply put, when your request URL looks like this: <code>/wordpress/wp-admin/admin-ajax.php?action=wpamelia_api&amp;call=/users/wp-users</code>, the query string is <code>action=wpamelia_api&amp;call=/users/wp-users</code>. The part that matches AMELIA_ACTION_SLUG is replaced with a blank space, and it becomes <code>/users/wp-users</code>, which corresponds to the route seen in the file above and is then processed by the Slim PHP framework.</p>
<p><code>/users/wp-users</code> corresponds to <code>GetWPUsersController::class</code>. Let’s take a look at the code for the controller:</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>

<span class="token keyword">namespace</span> <span class="token package">AmeliaBooking<span class="token punctuation">\</span>Application<span class="token punctuation">\</span>Controller<span class="token punctuation">\</span>User</span><span class="token punctuation">;</span>

<span class="token keyword">use</span> <span class="token package">AmeliaBooking<span class="token punctuation">\</span>Application<span class="token punctuation">\</span>Commands<span class="token punctuation">\</span>User<span class="token punctuation">\</span>GetWPUsersCommand</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token package">AmeliaBooking<span class="token punctuation">\</span>Application<span class="token punctuation">\</span>Controller<span class="token punctuation">\</span>Controller</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token package">Slim<span class="token punctuation">\</span>Http<span class="token punctuation">\</span>Request</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * Class GetWPUsersController
 *
 * @package AmeliaBooking\Application\Controller\User
 */</span>
<span class="token keyword">class</span> <span class="token class-name-definition class-name">GetWPUsersController</span> <span class="token keyword">extends</span> <span class="token class-name">Controller</span>
<span class="token punctuation">&#123;</span>
    <span class="token comment">/**
     * Instantiates the Get WP Users command to hand it over to the Command Handler
     *
     * @param Request $request
     * @param         $args
     *
     * @return GetWPUsersCommand
     * @throws \RuntimeException
     */</span>
    <span class="token keyword">protected</span> <span class="token keyword">function</span> <span class="token function-definition function">instantiateCommand</span><span class="token punctuation">(</span><span class="token class-name type-declaration">Request</span> <span class="token variable">$request</span><span class="token punctuation">,</span> <span class="token variable">$args</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        <span class="token variable">$command</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">GetWPUsersCommand</span><span class="token punctuation">(</span><span class="token variable">$args</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$command</span><span class="token operator">-></span><span class="token function">setField</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'id'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword type-casting">int</span><span class="token punctuation">)</span><span class="token variable">$request</span><span class="token operator">-></span><span class="token function">getQueryParam</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'id'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$command</span><span class="token operator">-></span><span class="token function">setField</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'role'</span><span class="token punctuation">,</span> <span class="token variable">$request</span><span class="token operator">-></span><span class="token function">getQueryParam</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'role'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$requestBody</span> <span class="token operator">=</span> <span class="token variable">$request</span><span class="token operator">-></span><span class="token function">getParsedBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$this</span><span class="token operator">-></span><span class="token function">setCommandFields</span><span class="token punctuation">(</span><span class="token variable">$command</span><span class="token punctuation">,</span> <span class="token variable">$requestBody</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> <span class="token variable">$command</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>Here, the Command Pattern in design patterns is used to wrap each action into a command. Who handles this command? Each controller inherits <code>AmeliaBooking\Application\Controller\Controller</code>, so the handling code is inside:</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token comment">/**
 * @param Request  $request
 * @param Response $response
 * @param          $args
 *
 * @return Response
 * @throws \InvalidArgumentException
 * @throws \RuntimeException
 */</span>
<span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">__invoke</span><span class="token punctuation">(</span><span class="token class-name type-declaration">Request</span> <span class="token variable">$request</span><span class="token punctuation">,</span> <span class="token class-name type-declaration">Response</span> <span class="token variable">$response</span><span class="token punctuation">,</span> <span class="token variable">$args</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token comment">/** @var Command $command */</span>
    <span class="token variable">$command</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-></span><span class="token function">instantiateCommand</span><span class="token punctuation">(</span><span class="token variable">$request</span><span class="token punctuation">,</span> <span class="token variable">$args</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">wp_verify_nonce</span><span class="token punctuation">(</span><span class="token variable">$command</span><span class="token operator">-></span><span class="token function">getField</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'ameliaNonce'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'ajax-nonce'</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
        <span class="token punctuation">(</span>
            <span class="token variable">$command</span> <span class="token keyword">instanceof</span> <span class="token class-name">DeleteUserCommand</span> <span class="token operator">||</span>
            <span class="token variable">$command</span> <span class="token keyword">instanceof</span> <span class="token class-name">DeletePackageCommand</span> <span class="token operator">||</span>
            <span class="token variable">$command</span> <span class="token keyword">instanceof</span> <span class="token class-name">DeleteCategoryCommand</span> <span class="token operator">||</span>
            <span class="token variable">$command</span> <span class="token keyword">instanceof</span> <span class="token class-name">DeleteServiceCommand</span> <span class="token operator">||</span>
            <span class="token variable">$command</span> <span class="token keyword">instanceof</span> <span class="token class-name">DeleteExtraCommand</span> <span class="token operator">||</span>
            <span class="token variable">$command</span> <span class="token keyword">instanceof</span> <span class="token class-name">DeleteLocationCommand</span> <span class="token operator">||</span>
            <span class="token variable">$command</span> <span class="token keyword">instanceof</span> <span class="token class-name">DeleteEventCommand</span> <span class="token operator">||</span>
            <span class="token variable">$command</span> <span class="token keyword">instanceof</span> <span class="token class-name">DeletePaymentCommand</span> <span class="token operator">||</span>
            <span class="token variable">$command</span> <span class="token keyword">instanceof</span> <span class="token class-name">DeleteCouponCommand</span> <span class="token operator">||</span>
            <span class="token variable">$command</span> <span class="token keyword">instanceof</span> <span class="token class-name">DeleteCustomFieldCommand</span> <span class="token operator">||</span>
            <span class="token variable">$command</span> <span class="token keyword">instanceof</span> <span class="token class-name">DeleteAppointmentCommand</span> <span class="token operator">||</span>
            <span class="token variable">$command</span> <span class="token keyword">instanceof</span> <span class="token class-name">DeleteBookingCommand</span> <span class="token operator">||</span>
            <span class="token variable">$command</span> <span class="token keyword">instanceof</span> <span class="token class-name">DeleteEventBookingCommand</span> <span class="token operator">||</span>
            <span class="token variable">$command</span> <span class="token keyword">instanceof</span> <span class="token class-name">DeletePackageCustomerCommand</span> <span class="token operator">||</span>
            <span class="token variable">$command</span> <span class="token keyword">instanceof</span> <span class="token class-name">DeleteNotificationCommand</span>
        <span class="token punctuation">)</span>
    <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token variable">$response</span><span class="token operator">-></span><span class="token function">withStatus</span><span class="token punctuation">(</span><span class="token keyword static-context">self</span><span class="token operator">::</span><span class="token constant">STATUS_INTERNAL_SERVER_ERROR</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">/** @var CommandResult $commandResult */</span>
    <span class="token variable">$commandResult</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">commandBus</span><span class="token operator">-></span><span class="token function">handle</span><span class="token punctuation">(</span><span class="token variable">$command</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$commandResult</span><span class="token operator">-></span><span class="token function">getUrl</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!==</span> <span class="token constant">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token variable">$this</span><span class="token operator">-></span><span class="token function">emitSuccessEvent</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-></span><span class="token property">eventBus</span><span class="token punctuation">,</span> <span class="token variable">$commandResult</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">/** @var Response $response */</span>
        <span class="token variable">$response</span> <span class="token operator">=</span> <span class="token variable">$response</span><span class="token operator">-></span><span class="token function">withHeader</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'Location'</span><span class="token punctuation">,</span> <span class="token variable">$commandResult</span><span class="token operator">-></span><span class="token function">getUrl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$response</span> <span class="token operator">=</span> <span class="token variable">$response</span><span class="token operator">-></span><span class="token function">withStatus</span><span class="token punctuation">(</span><span class="token keyword static-context">self</span><span class="token operator">::</span><span class="token constant">STATUS_REDIRECT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> <span class="token variable">$response</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$commandResult</span><span class="token operator">-></span><span class="token function">hasAttachment</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token constant boolean">false</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token variable">$responseBody</span> <span class="token operator">=</span> <span class="token punctuation">[</span>
            <span class="token string single-quoted-string">'message'</span> <span class="token operator">=></span> <span class="token variable">$commandResult</span><span class="token operator">-></span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token string single-quoted-string">'data'</span>    <span class="token operator">=></span> <span class="token variable">$commandResult</span><span class="token operator">-></span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">]</span><span class="token punctuation">;</span>

        <span class="token variable">$this</span><span class="token operator">-></span><span class="token function">emitSuccessEvent</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-></span><span class="token property">eventBus</span><span class="token punctuation">,</span> <span class="token variable">$commandResult</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">switch</span> <span class="token punctuation">(</span><span class="token variable">$commandResult</span><span class="token operator">-></span><span class="token function">getResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">case</span> <span class="token punctuation">(</span><span class="token class-name static-context">CommandResult</span><span class="token operator">::</span><span class="token constant">RESULT_SUCCESS</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                <span class="token variable">$response</span> <span class="token operator">=</span> <span class="token variable">$response</span><span class="token operator">-></span><span class="token function">withStatus</span><span class="token punctuation">(</span><span class="token keyword static-context">self</span><span class="token operator">::</span><span class="token constant">STATUS_OK</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> <span class="token punctuation">(</span><span class="token class-name static-context">CommandResult</span><span class="token operator">::</span><span class="token constant">RESULT_CONFLICT</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                <span class="token variable">$response</span> <span class="token operator">=</span> <span class="token variable">$response</span><span class="token operator">-></span><span class="token function">withStatus</span><span class="token punctuation">(</span><span class="token keyword static-context">self</span><span class="token operator">::</span><span class="token constant">STATUS_CONFLICT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">default</span><span class="token punctuation">:</span>
                <span class="token variable">$response</span> <span class="token operator">=</span> <span class="token variable">$response</span><span class="token operator">-></span><span class="token function">withStatus</span><span class="token punctuation">(</span><span class="token keyword static-context">self</span><span class="token operator">::</span><span class="token constant">STATUS_INTERNAL_SERVER_ERROR</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token comment">/** @var Response $response */</span>
        <span class="token variable">$response</span> <span class="token operator">=</span> <span class="token variable">$response</span><span class="token operator">-></span><span class="token function">withHeader</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'Content-Type'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'application/json;charset=utf-8'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$response</span> <span class="token operator">=</span> <span class="token variable">$response</span><span class="token operator">-></span><span class="token function">write</span><span class="token punctuation">(</span>
            <span class="token function">json_encode</span><span class="token punctuation">(</span>
                <span class="token variable">$commandResult</span><span class="token operator">-></span><span class="token function">hasDataInResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">?</span>
                    <span class="token variable">$responseBody</span> <span class="token punctuation">:</span> <span class="token function">array_merge</span><span class="token punctuation">(</span><span class="token variable">$responseBody</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string single-quoted-string">'data'</span> <span class="token operator">=></span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
            <span class="token punctuation">)</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">return</span> <span class="token variable">$response</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>Here, after instantiating a command, it is passed to the commandBus for processing: <code>$this-&gt;commandBus-&gt;handle($command)</code>. The code is in <code>src/Infrastructure/ContainerConfig/command.bus.php</code>, excerpted below:</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>

<span class="token function">defined</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'ABSPATH'</span><span class="token punctuation">)</span> <span class="token keyword">or</span> <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'No script kiddies please!'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// @codingStandardsIgnoreStart</span>
<span class="token variable">$entries</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'command.bus'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token variable">$c</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token variable">$commands</span> <span class="token operator">=</span> <span class="token punctuation">[</span>
        <span class="token comment">// User</span>
        <span class="token class-name class-name-fully-qualified static-context">User<span class="token punctuation">\</span>DeleteUserCommand</span><span class="token operator">::</span><span class="token keyword">class</span>                             <span class="token operator">=></span> <span class="token keyword">new</span> <span class="token class-name class-name-fully-qualified">User<span class="token punctuation">\</span>DeleteUserCommandHandler</span><span class="token punctuation">(</span><span class="token variable">$c</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token class-name class-name-fully-qualified static-context">User<span class="token punctuation">\</span>GetCurrentUserCommand</span><span class="token operator">::</span><span class="token keyword">class</span>                         <span class="token operator">=></span> <span class="token keyword">new</span> <span class="token class-name class-name-fully-qualified">User<span class="token punctuation">\</span>GetCurrentUserCommandHandler</span><span class="token punctuation">(</span><span class="token variable">$c</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token class-name class-name-fully-qualified static-context">User<span class="token punctuation">\</span>GetUserDeleteEffectCommand</span><span class="token operator">::</span><span class="token keyword">class</span>                    <span class="token operator">=></span> <span class="token keyword">new</span> <span class="token class-name class-name-fully-qualified">User<span class="token punctuation">\</span>GetUserDeleteEffectCommandHandler</span><span class="token punctuation">(</span><span class="token variable">$c</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token class-name class-name-fully-qualified static-context">User<span class="token punctuation">\</span>GetWPUsersCommand</span><span class="token operator">::</span><span class="token keyword">class</span>                             <span class="token operator">=></span> <span class="token keyword">new</span> <span class="token class-name class-name-fully-qualified">User<span class="token punctuation">\</span>GetWPUsersCommandHandler</span><span class="token punctuation">(</span><span class="token variable">$c</span><span class="token punctuation">)</span><span class="token punctuation">,</span>

        <span class="token comment">// more commands...</span>
    <span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token class-name class-name-fully-qualified static-context">League<span class="token punctuation">\</span>Tactician<span class="token punctuation">\</span>Setup<span class="token punctuation">\</span>QuickStart</span><span class="token operator">::</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token variable">$commands</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
<span class="token comment">// @codingStandardsIgnoreEnd</span>
</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>From this, we can see that our <code>GetWPUsersCommand</code> will be handled by <code>User\GetWPUsersCommandHandler</code>, so the main logic is inside:</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token keyword">class</span> <span class="token class-name-definition class-name">GetWPUsersCommandHandler</span> <span class="token keyword">extends</span> <span class="token class-name">CommandHandler</span>
<span class="token punctuation">&#123;</span>
    <span class="token comment">/**
     * @param GetWPUsersCommand $command
     *
     * @return CommandResult
     * @throws AccessDeniedException
     * @throws InvalidArgumentException
     * @throws \AmeliaBooking\Infrastructure\Common\Exceptions\QueryExecutionException
     * @throws \Interop\Container\Exception\ContainerException
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">handle</span><span class="token punctuation">(</span><span class="token class-name type-declaration">GetWPUsersCommand</span> <span class="token variable">$command</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token variable">$this</span><span class="token operator">-></span><span class="token function">getContainer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">getPermissionsService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">currentUserCanRead</span><span class="token punctuation">(</span><span class="token class-name static-context">Entities</span><span class="token operator">::</span><span class="token constant">EMPLOYEES</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">AccessDeniedException</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'You are not allowed to read employees.'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token variable">$this</span><span class="token operator">-></span><span class="token function">getContainer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">getPermissionsService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">currentUserCanRead</span><span class="token punctuation">(</span><span class="token class-name static-context">Entities</span><span class="token operator">::</span><span class="token constant">CUSTOMERS</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">AccessDeniedException</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'You are not allowed to read customers.'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token variable">$result</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CommandResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token variable">$this</span><span class="token operator">-></span><span class="token function">checkMandatoryFields</span><span class="token punctuation">(</span><span class="token variable">$command</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">/** @var UserService $userService */</span>
        <span class="token variable">$userService</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">container</span><span class="token operator">-></span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'users.service'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token variable">$adminIds</span> <span class="token operator">=</span> <span class="token variable">$userService</span><span class="token operator">-></span><span class="token function">getWpUserIdsByRoles</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'administrator'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">/** @var WPUserRepository $wpUserRepository */</span>
        <span class="token variable">$wpUserRepository</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-></span><span class="token function">getContainer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'domain.wpUsers.repository'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token variable">$result</span><span class="token operator">-></span><span class="token function">setResult</span><span class="token punctuation">(</span><span class="token class-name static-context">CommandResult</span><span class="token operator">::</span><span class="token constant">RESULT_SUCCESS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$result</span><span class="token operator">-></span><span class="token function">setMessage</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'Successfully retrieved users.'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token variable">$result</span><span class="token operator">-></span><span class="token function">setData</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
            <span class="token class-name static-context">Entities</span><span class="token operator">::</span><span class="token constant">USER</span> <span class="token operator">.</span> <span class="token string single-quoted-string">'s'</span> <span class="token operator">=></span> <span class="token variable">$wpUserRepository</span><span class="token operator">-></span><span class="token function">getAllNonRelatedWPUsers</span><span class="token punctuation">(</span><span class="token variable">$command</span><span class="token operator">-></span><span class="token function">getFields</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token variable">$adminIds</span><span class="token punctuation">)</span>
        <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> <span class="token variable">$result</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>We can see that the business logic is inside the <code>handle</code> function. First, the permissions are checked, then the relevant data is fetched through <code>userService</code>, and then <code>$result-&gt;setData</code> is used to set the data to be returned. Finally, the result is returned and handed over to other infra-related code for processing.</p>
<p>In addition, in the controller, we can see the permission check related to the command:</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">wp_verify_nonce</span><span class="token punctuation">(</span><span class="token variable">$command</span><span class="token operator">-></span><span class="token function">getField</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'ameliaNonce'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'ajax-nonce'</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
  <span class="token punctuation">(</span>
      <span class="token variable">$command</span> <span class="token keyword">instanceof</span> <span class="token class-name">DeleteUserCommand</span> <span class="token operator">||</span>
      <span class="token variable">$command</span> <span class="token keyword">instanceof</span> <span class="token class-name">DeletePackageCommand</span> <span class="token operator">||</span>
      <span class="token variable">$command</span> <span class="token keyword">instanceof</span> <span class="token class-name">DeleteCategoryCommand</span> <span class="token operator">||</span>
      <span class="token variable">$command</span> <span class="token keyword">instanceof</span> <span class="token class-name">DeleteServiceCommand</span> <span class="token operator">||</span>
      <span class="token variable">$command</span> <span class="token keyword">instanceof</span> <span class="token class-name">DeleteExtraCommand</span> <span class="token operator">||</span>
      <span class="token variable">$command</span> <span class="token keyword">instanceof</span> <span class="token class-name">DeleteLocationCommand</span> <span class="token operator">||</span>
      <span class="token variable">$command</span> <span class="token keyword">instanceof</span> <span class="token class-name">DeleteEventCommand</span> <span class="token operator">||</span>
      <span class="token variable">$command</span> <span class="token keyword">instanceof</span> <span class="token class-name">DeletePaymentCommand</span> <span class="token operator">||</span>
      <span class="token variable">$command</span> <span class="token keyword">instanceof</span> <span class="token class-name">DeleteCouponCommand</span> <span class="token operator">||</span>
      <span class="token variable">$command</span> <span class="token keyword">instanceof</span> <span class="token class-name">DeleteCustomFieldCommand</span> <span class="token operator">||</span>
      <span class="token variable">$command</span> <span class="token keyword">instanceof</span> <span class="token class-name">DeleteAppointmentCommand</span> <span class="token operator">||</span>
      <span class="token variable">$command</span> <span class="token keyword">instanceof</span> <span class="token class-name">DeleteBookingCommand</span> <span class="token operator">||</span>
      <span class="token variable">$command</span> <span class="token keyword">instanceof</span> <span class="token class-name">DeleteEventBookingCommand</span> <span class="token operator">||</span>
      <span class="token variable">$command</span> <span class="token keyword">instanceof</span> <span class="token class-name">DeletePackageCustomerCommand</span> <span class="token operator">||</span>
      <span class="token variable">$command</span> <span class="token keyword">instanceof</span> <span class="token class-name">DeleteNotificationCommand</span>
  <span class="token punctuation">)</span>
<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">return</span> <span class="token variable">$response</span><span class="token operator">-></span><span class="token function">withStatus</span><span class="token punctuation">(</span><span class="token keyword static-context">self</span><span class="token operator">::</span><span class="token constant">STATUS_INTERNAL_SERVER_ERROR</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>If it is one of these delete commands, it needs to pass the check of <code>wp_verify_nonce</code>. What is this?</p>
<p><code>wp_verify_nonce</code> is a function provided by WordPress for security checks, corresponding to the function <code>wp_create_nonce</code>. In the WordPress backend management page, there is a line of code like this: <code>var wpAmeliaNonce = &#39;&lt;?php echo wp_create_nonce(&#39;ajax-nonce&#39;); ?&gt;&#39;;</code>, which generates a nonce named <code>ajax-nonce</code>. This nonce is actually the result of hashing some strings.</p>
<p>If you don’t have the salt used for hashing, it’s basically impossible to forge a nonce, because the salt is usually very long and randomly generated at installation:</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token function">define</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'AUTH_KEY'</span><span class="token punctuation">,</span>         <span class="token string single-quoted-string">' Xakm&lt;o xQy rw4EMsLKM-?!T+,PFF&#125;)H4lzcW57AF0U@N@&lt; >M%G4Yt>f`z]MON'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">define</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'SECURE_AUTH_KEY'</span><span class="token punctuation">,</span>  <span class="token string single-quoted-string">'LzJ&#125;op]mr|6+![P&#125;Ak:uNdJCJZd>(Hx.-Mh#Tz)pCIU#uGEnfFz|f ;;eU%/U^O~'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">define</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'LOGGED_IN_KEY'</span><span class="token punctuation">,</span>    <span class="token string single-quoted-string">'|i|Ux`9&lt;p-h$aFf(qnT:sDO:D1P^wZ$$/Ra@miTJi9G;ddp_&lt;q&#125;6H1)o|a +&amp;JCM'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">define</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'NONCE_KEY'</span><span class="token punctuation">,</span>        <span class="token string single-quoted-string">'%:R&#123;[P|,s.KuMltH5&#125;cI;/k&lt;Gx~j!f0I)m_sIyu+&amp;NJZ)-iO>z7X>QYR0Z_XnZ@|'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">define</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'AUTH_SALT'</span><span class="token punctuation">,</span>        <span class="token string single-quoted-string">'eZyT)-Naw]F8CwA*VaW#q*|.)g@o&#125;||wf~@C-YSt&#125;(dh_r6EbI#A,y|nU2&#123;B#JBW'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">define</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'SECURE_AUTH_SALT'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'!=oLUTXh,QW=H `&#125;`L|9/^4-3 STz&#125;,T(w&#125;W&lt;I`.JjPi)&lt;Bmf1v,HpGe&#125;T1:Xt7n'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">define</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'LOGGED_IN_SALT'</span><span class="token punctuation">,</span>   <span class="token string single-quoted-string">'+XSqHc;@Q*K_b|Z?NC[3H!!EONbh.n&lt;+=uKR:>*c(u`g~EJBf#8u#R&#123;mUEZrozmm'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">define</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'NONCE_SALT'</span><span class="token punctuation">,</span>       <span class="token string single-quoted-string">'h`GXHhD>SLWVfg1(1(N&#123;;.V!MoE(SfbA_ksP@&amp;`+AycHcAV$+?@3q+rxV&#123;%^VyKT'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>Therefore, through <code>wp_verify_nonce</code>, we can ensure that only logged-in users can use certain functions, because if you are not logged in, you cannot get the nonce.</p>
<p>The above is the basic structure and processing flow of Amelia, which is the most beautiful one I have seen among several plugins. Everything is organized very well, and the structure is cut well. There won’t be a bunch of miscellaneous code, and it’s easy to find things. Just go to the routes to see the URL and the corresponding controller, and then follow the line to find the command and command handler.</p>
<p>Next, let’s talk about the three vulnerabilities mentioned at the beginning.</p>
<h2><span id="cve-2022-0720-amelia-lt-1047-customer-arbitrary-appointments-update-and-sensitive-data-disclosure">CVE-2022-0720: Amelia &lt; 1.0.47 - Customer+ Arbitrary Appointments Update and Sensitive Data Disclosure</span></h2><p>There are two modules related to managing bookings, one called Appointment and the other called Booking. They have a one-to-many relationship, where one Appointment can correspond to multiple Bookings. The relevant routes are as follows:</p>
<p><code>src/Infrastructure/Routes/Booking/Appointment/Appointment.php</code></p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token keyword">class</span> <span class="token class-name-definition class-name">Appointment</span>
<span class="token punctuation">&#123;</span>
    <span class="token comment">/**
     * @param App $app
     *
     * @throws \InvalidArgumentException
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">function</span> <span class="token function-definition function">routes</span><span class="token punctuation">(</span><span class="token class-name type-declaration">App</span> <span class="token variable">$app</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        <span class="token variable">$app</span><span class="token operator">-></span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'/appointments'</span><span class="token punctuation">,</span> <span class="token class-name static-context">GetAppointmentsController</span><span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$app</span><span class="token operator">-></span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'/appointments/&#123;id:[0-9]+&#125;'</span><span class="token punctuation">,</span> <span class="token class-name static-context">GetAppointmentController</span><span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$app</span><span class="token operator">-></span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'/appointments'</span><span class="token punctuation">,</span> <span class="token class-name static-context">AddAppointmentController</span><span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$app</span><span class="token operator">-></span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'/appointments/delete/&#123;id:[0-9]+&#125;'</span><span class="token punctuation">,</span> <span class="token class-name static-context">DeleteAppointmentController</span><span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$app</span><span class="token operator">-></span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'/appointments/&#123;id:[0-9]+&#125;'</span><span class="token punctuation">,</span> <span class="token class-name static-context">UpdateAppointmentController</span><span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$app</span><span class="token operator">-></span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'/appointments/status/&#123;id:[0-9]+&#125;'</span><span class="token punctuation">,</span> <span class="token class-name static-context">UpdateAppointmentStatusController</span><span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$app</span><span class="token operator">-></span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'/appointments/time/&#123;id:[0-9]+&#125;'</span><span class="token punctuation">,</span> <span class="token class-name static-context">UpdateAppointmentTimeController</span><span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>Let’s take the route <code>/appointments/&#123;id:[0-9]+&#125;</code> for displaying the appointment as an example. It corresponds to <code>GetAppointmentController</code>, which calls <code>GetAppointmentCommandHandler</code> in the controller. The code inside is as follows:</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token variable">$customerAS</span><span class="token operator">-></span><span class="token function">removeBookingsForOtherCustomers</span><span class="token punctuation">(</span><span class="token variable">$user</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Collection</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token variable">$appointment</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>Before returning the data, all bookings that do not belong to the user are filtered out, so other people’s data cannot be seen, and permission management is well done.</p>
<p>The route for updating the appointment corresponds to <code>UpdateAppointmentController</code>, which in turn corresponds to <code>UpdateAppointmentCommandHandler.php</code>. Some of the code is as follows:</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">/** @var AbstractUser $user */</span>
    <span class="token variable">$user</span> <span class="token operator">=</span> <span class="token variable">$userAS</span><span class="token operator">-></span><span class="token function">authorization</span><span class="token punctuation">(</span>
        <span class="token variable">$command</span><span class="token operator">-></span><span class="token function">getPage</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token string single-quoted-string">'cabinet'</span> <span class="token operator">?</span> <span class="token variable">$command</span><span class="token operator">-></span><span class="token function">getToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token class-name return-type">null</span><span class="token punctuation">,</span>
        <span class="token variable">$command</span><span class="token operator">-></span><span class="token function">getCabinetType</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">AuthorizationException</span> <span class="token variable">$e</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token variable">$result</span><span class="token operator">-></span><span class="token function">setResult</span><span class="token punctuation">(</span><span class="token class-name static-context">CommandResult</span><span class="token operator">::</span><span class="token constant">RESULT_ERROR</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$result</span><span class="token operator">-></span><span class="token function">setData</span><span class="token punctuation">(</span>
        <span class="token punctuation">[</span>
            <span class="token string single-quoted-string">'reauthorize'</span> <span class="token operator">=></span> <span class="token constant boolean">true</span>
        <span class="token punctuation">]</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token variable">$result</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$userAS</span><span class="token operator">-></span><span class="token function">isProvider</span><span class="token punctuation">(</span><span class="token variable">$user</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token variable">$settingsDS</span><span class="token operator">-></span><span class="token function">getSetting</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'roles'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'allowWriteAppointments'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">AccessDeniedException</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'You are not allowed to update appointment'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">// update appointment</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>Two things are checked at the beginning. The first is whether the user is logged in, so even if there is no nonce, this route can still be accessed, but it will be blocked here. The second is the user’s identity. If it is a provider, permission is checked.</p>
<p>In Amelia, there are basically several roles: customer, provider, and administrator. So as long as we are not a provider, we can pass this check.</p>
<p>It was mentioned earlier that by simply booking a service through Amelia’s plugin, a customer account can be registered in the WordPress system, which can log in to WordPress to manage their previous appointments.</p>
<p>Therefore, there is a vulnerability in the permission check here. A user with a customer identity can pass this check and tamper with other people’s appointments. Although it looks ordinary, when the user modifies their own appointment on the front end, they use another <code>/bookings/&#123;id&#125;</code> API. I guess this appointment API is default for providers, so it did not consider the situation of customers.</p>
<p>What else can be done besides modifying bookings? Let’s take a look at the updated response:</p>
<p><img src="/img/wordpress-plugin-amelia-sensitive-information-disclosure/p4-update.png" alt="update booking"></p>
<p>We can see that there is an info field in the response, which contains the personal information of the original customer, including name and phone number, etc. This field is stored when <code>processBooking</code> in <code>src/Application/Services/Reservation/AbstractReservationService.php</code> is called:</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token variable">$appointmentData</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'bookings'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'info'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">json_encode</span><span class="token punctuation">(</span>
<span class="token punctuation">[</span>
    <span class="token string single-quoted-string">'firstName'</span> <span class="token operator">=></span> <span class="token variable">$appointmentData</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'bookings'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'customer'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'firstName'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token string single-quoted-string">'lastName'</span>  <span class="token operator">=></span> <span class="token variable">$appointmentData</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'bookings'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'customer'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'lastName'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token string single-quoted-string">'phone'</span>     <span class="token operator">=></span> <span class="token variable">$appointmentData</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'bookings'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'customer'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'phone'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token string single-quoted-string">'locale'</span>    <span class="token operator">=></span> <span class="token variable">$appointmentData</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'locale'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token string single-quoted-string">'timeZone'</span>  <span class="token operator">=></span> <span class="token variable">$appointmentData</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'timeZone'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token string single-quoted-string">'urlParams'</span> <span class="token operator">=></span> <span class="token operator">!</span><span class="token keyword">empty</span><span class="token punctuation">(</span><span class="token variable">$appointmentData</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'urlParams'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token variable">$appointmentData</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'urlParams'</span><span class="token punctuation">]</span> <span class="token punctuation">:</span> <span class="token constant">null</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>To sum up, because the permission check was not done well, customers can update other people’s appointments and see the personal information of customers. And the appointment ID is a serial number, so by simply enumerating it, all personal information of everyone in the system can be retrieved.</p>
<h3><span id="fix">Fix</span></h3><p>In version 1.0.47, two changes were made. The first is to add permission check for customers for the issue I reported:</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$userAS</span><span class="token operator">-></span><span class="token function">isCustomer</span><span class="token punctuation">(</span><span class="token variable">$user</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">AccessDeniedException</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'You are not allowed to update appointment'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>The second change is the permission check of routes, which has changed from negative list to positive list. Only a few specific commands do not require login:</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">validateNonce</span><span class="token punctuation">(</span><span class="token variable">$request</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$request</span><span class="token operator">-></span><span class="token function">getMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token string single-quoted-string">'POST'</span> <span class="token operator">&amp;&amp;</span>
        <span class="token operator">!</span><span class="token keyword static-context">self</span><span class="token operator">::</span><span class="token function">getToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
        <span class="token operator">!</span><span class="token punctuation">(</span><span class="token variable">$this</span> <span class="token keyword">instanceof</span> <span class="token class-name">LoginCabinetCommand</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
        <span class="token operator">!</span><span class="token punctuation">(</span><span class="token variable">$this</span> <span class="token keyword">instanceof</span> <span class="token class-name">AddBookingCommand</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
        <span class="token operator">!</span><span class="token punctuation">(</span><span class="token variable">$this</span> <span class="token keyword">instanceof</span> <span class="token class-name">AddStatsCommand</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
        <span class="token operator">!</span><span class="token punctuation">(</span><span class="token variable">$this</span> <span class="token keyword">instanceof</span> <span class="token class-name">MolliePaymentCommand</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
        <span class="token operator">!</span><span class="token punctuation">(</span><span class="token variable">$this</span> <span class="token keyword">instanceof</span> <span class="token class-name">MolliePaymentNotifyCommand</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
        <span class="token operator">!</span><span class="token punctuation">(</span><span class="token variable">$this</span> <span class="token keyword">instanceof</span> <span class="token class-name">PayPalPaymentCommand</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
        <span class="token operator">!</span><span class="token punctuation">(</span><span class="token variable">$this</span> <span class="token keyword">instanceof</span> <span class="token class-name">PayPalPaymentCallbackCommand</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
        <span class="token operator">!</span><span class="token punctuation">(</span><span class="token variable">$this</span> <span class="token keyword">instanceof</span> <span class="token class-name">RazorpayPaymentCommand</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
        <span class="token operator">!</span><span class="token punctuation">(</span><span class="token variable">$this</span> <span class="token keyword">instanceof</span> <span class="token class-name">WooCommercePaymentCommand</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
        <span class="token operator">!</span><span class="token punctuation">(</span><span class="token variable">$this</span> <span class="token keyword">instanceof</span> <span class="token class-name">SuccessfulBookingCommand</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token function">wp_verify_nonce</span><span class="token punctuation">(</span><span class="token variable">$request</span><span class="token operator">-></span><span class="token function">getQueryParams</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'ameliaNonce'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'ajax-nonce'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">return</span> <span class="token constant boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2><span id="cve-2022-0825-amelia-lt-1049-customer-arbitrary-appointments-status-update">CVE-2022-0825: Amelia &lt; 1.0.49 - Customer+ Arbitrary Appointments Status Update</span></h2><p>This vulnerability is similar to the previous one, both of which are related to permission management. The route for this vulnerability is <code>$app-&gt;post(&#39;/appointments/status/&#123;id:[0-9]+&#125;&#39;, UpdateAppointmentStatusController::class);</code>, and the corresponding code is in <code>src/Application/Commands/Booking/Appointment/UpdateAppointmentStatusCommandHandler.php</code>. Permission check is done at the beginning:</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token variable">$this</span><span class="token operator">-></span><span class="token function">getContainer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">getPermissionsService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">currentUserCanWriteStatus</span><span class="token punctuation">(</span><span class="token class-name static-context">Entities</span><span class="token operator">::</span><span class="token constant">APPOINTMENTS</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">AccessDeniedException</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'You are not allowed to update appointment status'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">// update appointment</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>Let’s continue to see how <code>currentUserCanWriteStatus</code> is implemented:</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">currentUserCanWriteStatus</span><span class="token punctuation">(</span><span class="token variable">$object</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> <span class="token variable">$this</span><span class="token operator">-></span><span class="token function">userCan</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-></span><span class="token property">currentUser</span><span class="token punctuation">,</span> <span class="token variable">$object</span><span class="token punctuation">,</span> <span class="token keyword static-context">self</span><span class="token operator">::</span><span class="token constant">WRITE_STATUS_PERMISSIONS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>Scrolling down, we can find <code>userCan</code>:</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">userCan</span><span class="token punctuation">(</span><span class="token variable">$user</span><span class="token punctuation">,</span> <span class="token variable">$object</span><span class="token punctuation">,</span> <span class="token variable">$permission</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$user</span> <span class="token keyword">instanceof</span> <span class="token class-name">Admin</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token constant boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">return</span> <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">permissionsChecker</span><span class="token operator">-></span><span class="token function">checkPermissions</span><span class="token punctuation">(</span><span class="token variable">$user</span><span class="token punctuation">,</span> <span class="token variable">$object</span><span class="token punctuation">,</span> <span class="token variable">$permission</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>Going one level deeper, we can see the implementation of <code>checkPermissions</code> in <code>src/Infrastructure/WP/PermissionsService/PermissionsChecker.php</code>:</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">checkPermissions</span><span class="token punctuation">(</span><span class="token variable">$user</span><span class="token punctuation">,</span> <span class="token variable">$object</span><span class="token punctuation">,</span> <span class="token variable">$permission</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token comment">// Admin can do all</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$user</span> <span class="token keyword">instanceof</span> <span class="token class-name">Admin</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token constant boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// Get the WP role name of the user, rollback to customer by default</span>
    <span class="token variable">$wpRoleName</span> <span class="token operator">=</span> <span class="token variable">$user</span> <span class="token operator">!==</span> <span class="token constant">null</span> <span class="token operator">?</span> <span class="token string single-quoted-string">'wpamelia-'</span> <span class="token operator">.</span> <span class="token variable">$user</span><span class="token operator">-></span><span class="token function">getType</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token string single-quoted-string">'wpamelia-customer'</span><span class="token punctuation">;</span>
    <span class="token comment">// Get the wp name of capability we are looking for.</span>
    <span class="token variable">$wpCapability</span> <span class="token operator">=</span> <span class="token string double-quoted-string">"amelia_<span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token variable">$permission</span><span class="token punctuation">&#125;</span></span>_<span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token variable">$object</span><span class="token punctuation">&#125;</span></span>"</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$user</span> <span class="token operator">!==</span> <span class="token constant">null</span> <span class="token operator">&amp;&amp;</span> <span class="token variable">$user</span><span class="token operator">-></span><span class="token function">getExternalId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!==</span> <span class="token constant">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token function">user_can</span><span class="token punctuation">(</span><span class="token variable">$user</span><span class="token operator">-></span><span class="token function">getExternalId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token variable">$wpCapability</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// If user is guest check does it have capability</span>
    <span class="token variable">$wpRole</span> <span class="token operator">=</span> <span class="token function">get_role</span><span class="token punctuation">(</span><span class="token variable">$wpRoleName</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token variable">$wpRole</span> <span class="token operator">!==</span> <span class="token constant">null</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$wpRole</span><span class="token operator">-></span><span class="token property">capabilities</span><span class="token punctuation">[</span><span class="token variable">$wpCapability</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">?</span>
        <span class="token punctuation">(</span><span class="token keyword type-casting">bool</span><span class="token punctuation">)</span><span class="token variable">$wpRole</span><span class="token operator">-></span><span class="token property">capabilities</span><span class="token punctuation">[</span><span class="token variable">$wpCapability</span><span class="token punctuation">]</span> <span class="token punctuation">:</span> <span class="token constant boolean">false</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>One thing to note here is that if the user is <code>null</code>, they will be treated as a <code>customer</code>. The actual permission check is done in the <code>capabilities</code> table in <code>src/Infrastructure/WP/config/Roles.php</code>:</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token comment">// Customer</span>
<span class="token punctuation">[</span>
    <span class="token string single-quoted-string">'name'</span>         <span class="token operator">=></span> <span class="token string single-quoted-string">'wpamelia-customer'</span><span class="token punctuation">,</span>
    <span class="token string single-quoted-string">'label'</span>        <span class="token operator">=></span> <span class="token function">__</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'Amelia Customer'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'amelia'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token string single-quoted-string">'capabilities'</span> <span class="token operator">=></span> <span class="token punctuation">[</span>
        <span class="token string single-quoted-string">'read'</span>                             <span class="token operator">=></span> <span class="token constant boolean">true</span><span class="token punctuation">,</span>
        <span class="token string single-quoted-string">'amelia_read_menu'</span>                 <span class="token operator">=></span> <span class="token constant boolean">true</span><span class="token punctuation">,</span>
        <span class="token string single-quoted-string">'amelia_read_calendar'</span>             <span class="token operator">=></span> <span class="token constant boolean">true</span><span class="token punctuation">,</span>
        <span class="token string single-quoted-string">'amelia_read_appointments'</span>         <span class="token operator">=></span> <span class="token constant boolean">true</span><span class="token punctuation">,</span>
        <span class="token string single-quoted-string">'amelia_read_events'</span>               <span class="token operator">=></span> <span class="token constant boolean">true</span><span class="token punctuation">,</span>
        <span class="token string single-quoted-string">'amelia_write_status_appointments'</span> <span class="token operator">=></span> <span class="token constant boolean">true</span><span class="token punctuation">,</span>
        <span class="token string single-quoted-string">'amelia_write_time_appointments'</span>   <span class="token operator">=></span> <span class="token constant boolean">true</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">]</span><span class="token punctuation">,</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>Where <code>amelia_write_status_appointments</code> is true, indicating that the customer has permission to update the status.</p>
<p>The rest of the process is the same as the previous vulnerability. After updating the appointment, the data is returned as a whole, and the consumer’s personal information can be seen through the <code>info</code> field. Additionally, this vulnerability was pre-auth before version 1.0.47 because the permission check for routes had not yet been positively listed, so even without logging in, this command could be accessed. Furthermore, if the user is null, they are assumed to be a customer by default, completing the entire attack chain:</p>
<p><img src="/img/wordpress-plugin-amelia-sensitive-information-disclosure/p5-unauth-status.png" alt="update booking status"></p>
<h3><span id="fix">Fix</span></h3><p>In version 1.0.49, the <code>amelia_write_status_appointments</code> permission for customers was removed.</p>
<h2><span id="cve-2022-0837-amelia-lt-1048-customer-sms-service-abuse-and-sensitive-data-disclosure">CVE-2022-0837: Amelia &lt; 1.0.48 - Customer+ SMS Service Abuse and Sensitive Data Disclosure</span></h2><p>Let’s look at the last vulnerability related to permission checks. The problematic route is <code>$app-&gt;post(&#39;/notifications/sms&#39;, SendAmeliaSmsApiRequestController::class);</code>, which corresponds to <code>SendAmeliaSmsApiRequestCommandHandler</code>:</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">handle</span><span class="token punctuation">(</span><span class="token class-name type-declaration">SendAmeliaSmsApiRequestCommand</span> <span class="token variable">$command</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token variable">$result</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CommandResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/** @var SMSAPIServiceInterface $smsApiService */</span>
    <span class="token variable">$smsApiService</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-></span><span class="token function">getContainer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'application.smsApi.service'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Call method dynamically and pass data to the function. Method name is the request field.</span>
    <span class="token variable">$apiResponse</span> <span class="token operator">=</span> <span class="token variable">$smsApiService</span><span class="token operator">-></span><span class="token punctuation">&#123;</span><span class="token variable">$command</span><span class="token operator">-></span><span class="token function">getField</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'action'</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token punctuation">(</span><span class="token variable">$command</span><span class="token operator">-></span><span class="token function">getField</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'data'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token variable">$result</span><span class="token operator">-></span><span class="token function">setResult</span><span class="token punctuation">(</span><span class="token class-name static-context">CommandResult</span><span class="token operator">::</span><span class="token constant">RESULT_SUCCESS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$result</span><span class="token operator">-></span><span class="token function">setMessage</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'Amelia SMS API request successful'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$result</span><span class="token operator">-></span><span class="token function">setData</span><span class="token punctuation">(</span><span class="token variable">$apiResponse</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token variable">$result</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>As we can see, there is no permission check here, and we can control the parameters passed to this endpoint:</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token variable">$apiResponse</span> <span class="token operator">=</span> <span class="token variable">$smsApiService</span><span class="token operator">-></span><span class="token punctuation">&#123;</span><span class="token variable">$command</span><span class="token operator">-></span><span class="token function">getField</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'action'</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token punctuation">(</span><span class="token variable">$command</span><span class="token operator">-></span><span class="token function">getField</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'data'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>There are several methods in <code>smsApiService</code>, and among them, <code>getUserInfo</code>, which can obtain the administrator’s personal information, <code>getPaymentHistory</code>, which can obtain payment records, and <code>testNotification</code>, which can send test SMS messages, all have only one parameter:</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">getUserInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token variable">$route</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'auth/info'</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token variable">$this</span><span class="token operator">-></span><span class="token function">sendRequest</span><span class="token punctuation">(</span><span class="token variable">$route</span><span class="token punctuation">,</span> <span class="token constant boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">getPaymentHistory</span><span class="token punctuation">(</span><span class="token variable">$data</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token variable">$route</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'/payment/history'</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token variable">$this</span><span class="token operator">-></span><span class="token function">sendRequest</span><span class="token punctuation">(</span><span class="token variable">$route</span><span class="token punctuation">,</span> <span class="token constant boolean">true</span><span class="token punctuation">,</span> <span class="token variable">$data</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">testNotification</span><span class="token punctuation">(</span><span class="token variable">$data</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token variable">$route</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'/sms/send'</span><span class="token punctuation">;</span>

    <span class="token comment">/** @var SettingsService $settingsService */</span>
    <span class="token variable">$settingsService</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">container</span><span class="token operator">-></span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'domain.settings.service'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/** @var EmailNotificationService $notificationService */</span>
    <span class="token variable">$notificationService</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">container</span><span class="token operator">-></span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'application.emailNotification.service'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/** @var PlaceholderService $placeholderService */</span>
    <span class="token variable">$placeholderService</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">container</span><span class="token operator">-></span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"application.placeholder.<span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token variable">$data</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'type'</span><span class="token punctuation">]</span><span class="token punctuation">&#125;</span></span>.service"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token variable">$appointmentsSettings</span> <span class="token operator">=</span> <span class="token variable">$settingsService</span><span class="token operator">-></span><span class="token function">getCategorySettings</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'appointments'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token variable">$notification</span> <span class="token operator">=</span> <span class="token variable">$notificationService</span><span class="token operator">-></span><span class="token function">getById</span><span class="token punctuation">(</span><span class="token variable">$data</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'notificationTemplate'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token variable">$dummyData</span> <span class="token operator">=</span> <span class="token variable">$placeholderService</span><span class="token operator">-></span><span class="token function">getPlaceholdersDummyData</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'sms'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token variable">$isForCustomer</span> <span class="token operator">=</span> <span class="token variable">$notification</span><span class="token operator">-></span><span class="token function">getSendTo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token class-name static-context">NotificationSendTo</span><span class="token operator">::</span><span class="token constant">CUSTOMER</span><span class="token punctuation">;</span>

    <span class="token variable">$placeholderStringRec</span>  <span class="token operator">=</span> <span class="token string single-quoted-string">'recurring'</span> <span class="token operator">.</span> <span class="token string single-quoted-string">'Placeholders'</span> <span class="token operator">.</span> <span class="token punctuation">(</span><span class="token variable">$isForCustomer</span> <span class="token operator">?</span> <span class="token string single-quoted-string">'Customer'</span> <span class="token punctuation">:</span> <span class="token string single-quoted-string">''</span><span class="token punctuation">)</span> <span class="token operator">.</span> <span class="token string single-quoted-string">'Sms'</span><span class="token punctuation">;</span>
    <span class="token variable">$placeholderStringPack</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'package'</span> <span class="token operator">.</span> <span class="token string single-quoted-string">'Placeholders'</span> <span class="token operator">.</span> <span class="token punctuation">(</span><span class="token variable">$isForCustomer</span> <span class="token operator">?</span> <span class="token string single-quoted-string">'Customer'</span> <span class="token punctuation">:</span> <span class="token string single-quoted-string">''</span><span class="token punctuation">)</span> <span class="token operator">.</span> <span class="token string single-quoted-string">'Sms'</span><span class="token punctuation">;</span>

    <span class="token variable">$dummyData</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'recurring_appointments_details'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token variable">$placeholderService</span><span class="token operator">-></span><span class="token function">applyPlaceholders</span><span class="token punctuation">(</span><span class="token variable">$appointmentsSettings</span><span class="token punctuation">[</span><span class="token variable">$placeholderStringRec</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token variable">$dummyData</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$dummyData</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'package_appointments_details'</span><span class="token punctuation">]</span>   <span class="token operator">=</span>  <span class="token variable">$placeholderService</span><span class="token operator">-></span><span class="token function">applyPlaceholders</span><span class="token punctuation">(</span><span class="token variable">$appointmentsSettings</span><span class="token punctuation">[</span><span class="token variable">$placeholderStringPack</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token variable">$dummyData</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


    <span class="token variable">$body</span> <span class="token operator">=</span> <span class="token variable">$placeholderService</span><span class="token operator">-></span><span class="token function">applyPlaceholders</span><span class="token punctuation">(</span>
        <span class="token variable">$notification</span><span class="token operator">-></span><span class="token function">getContent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token variable">$dummyData</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token variable">$data</span> <span class="token operator">=</span> <span class="token punctuation">[</span>
        <span class="token string single-quoted-string">'to'</span>   <span class="token operator">=></span> <span class="token variable">$data</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'recipientPhone'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token string single-quoted-string">'from'</span> <span class="token operator">=></span> <span class="token variable">$settingsService</span><span class="token operator">-></span><span class="token function">getSetting</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'notifications'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'smsAlphaSenderId'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token string single-quoted-string">'body'</span> <span class="token operator">=></span> <span class="token variable">$body</span>
    <span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token variable">$this</span><span class="token operator">-></span><span class="token function">sendRequest</span><span class="token punctuation">(</span><span class="token variable">$route</span><span class="token punctuation">,</span> <span class="token constant boolean">true</span><span class="token punctuation">,</span> <span class="token variable">$data</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>Actual test screenshots:</p>
<p><img src="/img/wordpress-plugin-amelia-sensitive-information-disclosure/p6-sms1.png" alt="sms1"></p>
<p>Sending a test SMS:</p>
<p><img src="/img/wordpress-plugin-amelia-sensitive-information-disclosure/p7-sms2.png" alt="sms2"></p>
<p>Sending a test SMS also costs money, and we can burn the administrator’s money by continuously hitting this endpoint.</p>
<h3><span id="fix">Fix</span></h3><p>In version 1.0.48, permission checks were added to the controller:</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token variable">$this</span><span class="token operator">-></span><span class="token function">getContainer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">getPermissionsService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">currentUserCanWrite</span><span class="token punctuation">(</span><span class="token class-name static-context">Entities</span><span class="token operator">::</span><span class="token constant">NOTIFICATIONS</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">AccessDeniedException</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'You are not allowed to send test email'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<h2><span id="conclusion">Conclusion</span></h2><p>As software development becomes more and more complex, developers often overlook basic permission checks and make incorrect assumptions about permissions. For example, although the appointment-related APIs are for providers, consumers cannot see these APIs on the front end, but the code of WordPress plugins is open, and anyone who reads the code can find all the API paths.</p>
<p>When implementing various functions, remember to put permission checks first, and only continue with the process after confirming that the current user has permission to operate on the desired resource.</p>
<p>Finally, here is the timeline:</p>
<p><code>2022-02-20</code> Reported the appointment update vulnerability through WPScan, retaining CVE-2022-0720<br><code>2022-03-01</code> Released version 1.0.47, fixing CVE-2022-0720, and some information was made public on <a target="_blank" rel="noopener" href="https://wpscan.com/vulnerability/435ef99c-9210-46c7-80a4-09cd4d3d00cf">WPScan</a><br><code>2022-03-02</code> Reported the appointment status update vulnerability through WPScan, retaining CVE-2022-0825<br><code>2022-03-03</code> Reported SMS-related vulnerabilities through WPScan, retaining CVE-2022-0837<br><code>2022-03-09</code> Released version 1.0.48, fixing CVE-2022-0837, and some information was made public on <a target="_blank" rel="noopener" href="https://wpscan.com/vulnerability/0882e5c0-f319-4994-9346-aa18438fda6a">WPScan</a><br><code>2022-03-14</code> Released version 1.0.49, fixing CVE-2022-0825, and some information was made public on <a target="_blank" rel="noopener" href="https://wpscan.com/vulnerability/1a92a65f-e9df-41b5-9a1c-8e24ee9bf50e">WPScan</a><br><code>2022-03-26</code> Vulnerability details were made public on WPScan<br><code>2022-03-30</code> Article published</p>

    
    </div>
    
    <div class="columns is-variable is-1 is-multiline is-mobile">
    
        <span class="column is-narrow"><a class="tag is-light article-tag" href="/en/tags/Security/">#Security</a></span>
    
    </div>
    
    
    <div class="columns is-mobile is-multiline article-nav">
        <span class="column is-12-mobile is-half-desktop  article-nav-prev">
            
            <a href="/2022/04/06/en/erpnext-ssrf-and-xss-to-account-takeover/">SSRF and Account Takeover via XSS in ERPNext</a>
            
        </span>
        <span class="column is-12-mobile is-half-desktop  article-nav-next">
            
            <a href="/2022/03/30/en/amelia-wordpress-plugin-sensitive-data-exposure-detail/">Sensitive Data Disclosure in WordPress Plugin Amelia &lt; 1.0.49</a>
            
        </span>
    </div>
    
</article>




<div class="comments">
    <h3 class="title is-4">Comments</h3>
    <script src="https://utteranc.es/client.js"
        repo="aszx87410/huli-blog"
        issue-term="title"
        theme="github-light"
        crossorigin="anonymous"
        async>
</script>
</div>

    </div>
</section>
    <footer class="footer">
    <div class="container">
        <div class="columns content">
            <div class="column is-narrow has-text-centered">
                &copy; 2024 Huli&nbsp;
                Powered by <a href="http://hexo.io/" target="_blank">Hexo</a> & <a
                        target="_blank" rel="noopener" href="http://github.com/ppoffice/hexo-theme-minos">Minos</a>
            </div>
            <div class="column is-hidden-mobile"></div>

            
            <div class="column is-narrow">
                <div class="columns is-mobile is-multiline is-centered">
                
                    
                <a class="column is-narrow" title="GitHub" target="_blank" rel="noopener" href="https://github.com/ppoffice/hexo-theme-minos">
                    
                    GitHub
                    
                </a>
                
                </div>
            </div>
            
            
<div class="column is-narrow has-text-centered">
    <div class="dropdown is-up is-right is-hoverable" style="margin-top: -0.2em;">
        <div class="dropdown-trigger">
            <button class="button is-small" aria-haspopup="true">
                <span class="icon">
                    <i class="fas fa-globe"></i>
                </span>
                <span>English</span>
                <span class="icon is-small">
            <i class="fas fa-angle-down" aria-hidden="true"></i>
          </span>
            </button>
        </div>
        <div class="dropdown-menu has-text-left" role="menu" style="top:100%">
            <div class="dropdown-content">
            <!-- NOTE: 永遠回到首頁 -->
            
                <a href="/2022/03/30/wordpress-plugin-amelia-sensitive-information-disclosure/" class="dropdown-item">
                    繁體中文
                </a>
            
            </div>
        </div>
    </div>
</div>

        </div>
    </div>
</footer>
    <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/3.6.3/jquery.min.js"></script>



    
    
    
    
    
    
<script src="//cdnjs.cloudflare.com/ajax/libs/lightgallery/1.6.8/js/lightgallery-all.min.js"></script>
<script>
    (function ($) {
        $(document).ready(function () {
            if (typeof($.fn.lightGallery) === 'function') {
                $('.article.gallery').lightGallery({ selector: '.gallery-item' });
            }
        });
    })(jQuery);
</script>

    
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.0/clipboard.min.js"></script>
    <style>
        .hljs {
            position: relative;
        }

        .hljs .clipboard-btn {
            float: right;
            color: #9a9a9a;
            background: none;
            border: none;
            cursor: pointer;
        }

        .hljs .clipboard-btn:hover {
          color: #8a8a8a;
        }

        .hljs > .clipboard-btn {
            display: none;
            position: absolute;
            right: 4px;
            top: 4px;
        }

        .hljs:hover > .clipboard-btn {
            display: inline;
        }

        .hljs > figcaption > .clipboard-btn {
            margin-right: 4px;
        }
    </style>
    <script>
      $(document).ready(function () {
        $('figure.hljs').each(function(i, figure) {
          var codeId = 'code-' + i;
          var code = figure.querySelector('.code');
          var copyButton = $('<button>Copy <i class="far fa-clipboard"></i></button>');
          code.id = codeId;
          copyButton.addClass('clipboard-btn');
          copyButton.attr('data-clipboard-target-id', codeId);

          var figcaption = figure.querySelector('figcaption');

          if (figcaption) {
            figcaption.append(copyButton[0]);
          } else {
            figure.prepend(copyButton[0]);
          }
        })

        var clipboard = new ClipboardJS('.clipboard-btn', {
          target: function(trigger) {
            return document.getElementById(trigger.getAttribute('data-clipboard-target-id'));
          }
        });
        clipboard.on('success', function(e) {
          e.clearSelection();
        })
      })
    </script>

    
    

    



<script src="/js/script.js?v=3.js"></script>


    
</body>
</html>