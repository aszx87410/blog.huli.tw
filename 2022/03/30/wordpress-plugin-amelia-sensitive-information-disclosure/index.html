<!DOCTYPE html>
<html class="has-navbar-fixed-top" lang="zh-tw">
<head>
    <meta charset="utf-8">
<title>WordPress Plugin Amelia &lt; 1.0.49 敏感資訊洩露漏洞細節 - Huli&#39;s blog</title>
<meta name="viewport" content="width=device-width, initial-scale=1">



            
<link href="https://blog.huli.tw/2022/03/30/en/wordpress-plugin-amelia-sensitive-information-disclosure/" rel="alternate" hreflang="en" />
            
    




    
<link rel="canonical" href="https://blog.huli.tw/2022/03/30/wordpress-plugin-amelia-sensitive-information-disclosure/">
    





    <meta name="description" content="Amelia 是一個由 TMS 公司所開發的 WordPress 外掛，能夠輕鬆幫你的 WordPress 網站加上預約系統的功能，例如說診所、理髮廳或是家教等等，都很適合使用這個外掛來架一個簡單的預約系統。根據 WordPress 官方的統計，大約有 40,000 個網站都安裝了這個 plugin。 在三月初的時候我針對 Amelia 這套系統的原始碼做了一些研究，找到了三個都是敏感資訊洩露的漏">
<meta property="og:type" content="article">
<meta property="og:title" content="WordPress Plugin Amelia &lt; 1.0.49 敏感資訊洩露漏洞細節">
<meta property="og:url" content="https://blog.huli.tw/2022/03/30/wordpress-plugin-amelia-sensitive-information-disclosure/index.html">
<meta property="og:site_name" content="Huli&#39;s blog">
<meta property="og:description" content="Amelia 是一個由 TMS 公司所開發的 WordPress 外掛，能夠輕鬆幫你的 WordPress 網站加上預約系統的功能，例如說診所、理髮廳或是家教等等，都很適合使用這個外掛來架一個簡單的預約系統。根據 WordPress 官方的統計，大約有 40,000 個網站都安裝了這個 plugin。 在三月初的時候我針對 Amelia 這套系統的原始碼做了一些研究，找到了三個都是敏感資訊洩露的漏">
<meta property="og:locale" content="zh_TW">
<meta property="og:image" content="https://blog.huli.tw/img/wordpress-plugin-amelia-sensitive-information-disclosure/cover.png">
<meta property="article:published_time" content="2022-03-30T04:00:00.000Z">
<meta property="article:modified_time" content="2023-06-18T10:19:20.558Z">
<meta property="article:author" content="Huli">
<meta property="article:tag" content="Security">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://blog.huli.tw/img/wordpress-plugin-amelia-sensitive-information-disclosure/cover.png">



<link rel="alternative" href="/atom.xml" title="WordPress Plugin Amelia &lt; 1.0.49 敏感資訊洩露漏洞細節" type="application/atom+xml">



<link rel="icon" href="/img/lidemy_logo.png">


<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Ovo|Source+Code+Pro">


<link rel="stylesheet" href="/css/bulma.css?v=2.css">



<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/lightgallery/1.6.8/css/lightgallery.min.css">


<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/line-numbers/prism-line-numbers.min.css" />


<link rel="stylesheet" href="/css/style.css?v=4.css">





    
    
    
    
    
    
    
    
    
    
<script async src="https://www.googletagmanager.com/gtag/js?id=G-1393J2EVCZ"></script>
<script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-1393J2EVCZ');
</script>


    


<meta name="generator" content="Hexo 6.3.0"></head>
<body>
    <script>
        if (localStorage.getItem('dark-mode')) {
            if (localStorage.getItem('dark-mode') === 'true') {
                document.body.classList.add('dark-mode')
            }
        } else {
            if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                document.body.classList.add('dark-mode')
            }
        }
    </script>
    
<nav class="navbar is-transparent is-fixed-top navbar-main" role="navigation" aria-label="main navigation">
    <div class="container">
        <div class="navbar-brand">
            <a class="navbar-item navbar-logo" href="/">
                
                    
                    Huli&#39;s blog
                    
                
            </a>
            <div class="navbar-burger">
                <span></span>
                <span></span>
                <span></span>
            </div>
        </div>
        
        <div class="navbar-menu navbar-start">
            
            <a class="navbar-item "
               href="/archives">文章列表</a>
            
            <a class="navbar-item "
               href="/categories">分類</a>
            
            <a class="navbar-item "
               href="/recommend">推薦閱讀</a>
            
            <a class="navbar-item "
               href="/about">關於我</a>
            
        </div>
        
        <div class="navbar-menu navbar-end">
            
            
            <div class="navbar-item is-hoverable has-dropdown is-hidden-mobile is-hidden-tablet-only toc">
                <a class="navbar-item" title="目錄">
                    目錄
                </a>
                <div class="navbar-dropdown">
                    
                    
                    
                    
                    <a class="navbar-item" href="#amelia-基本介紹">1&nbsp;&nbsp;<b>Amelia 基本介紹</b></a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#wordpress-外掛與-amelia-架構介紹">2&nbsp;&nbsp;<b>WordPress 外掛與 Amelia 架構介紹</b></a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#cve-2022-0720-amelia-lt-1047-customer-arbitrary-appointments-update-and-sensitive-data-disclosure">3&nbsp;&nbsp;<b>CVE-2022-0720: Amelia &amp;lt; 1.0.47 - Customer+ Arbitrary Appointments Update and Sensitive Data Disclosure</b></a>
                    
                    
                    
                    <a class="navbar-item" href="#修復方式">3.1&nbsp;&nbsp;修復方式</a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#cve-2022-0825-amelia-lt-1049-customer-arbitrary-appointments-status-update">4&nbsp;&nbsp;<b>CVE-2022-0825: Amelia &amp;lt; 1.0.49 - Customer+ Arbitrary Appointments Status Update</b></a>
                    
                    
                    
                    <a class="navbar-item" href="#修復方式">4.1&nbsp;&nbsp;修復方式</a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#cve-2022-0837-amelia-lt-1048-customer-sms-service-abuse-and-sensitive-data-disclosure">5&nbsp;&nbsp;<b>CVE-2022-0837: Amelia &amp;lt; 1.0.48 - Customer+ SMS Service Abuse and Sensitive Data Disclosure</b></a>
                    
                    
                    
                    <a class="navbar-item" href="#修復方式">5.1&nbsp;&nbsp;修復方式</a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#總結">6&nbsp;&nbsp;<b>總結</b></a>
                    
                </div>
            </div>
            
            
            <a class="navbar-item" target="_blank" title="Medium" href="https://hulitw.medium.com/">
                
                <i class="fab fa-medium"></i>
                
            </a>
               
            <a class="navbar-item" target="_blank" title="Facebook" href="https://www.facebook.com/huli.blog">
                
                <i class="fab fa-facebook"></i>
                
            </a>
               
            <a class="navbar-item" target="_blank" title="RSS" href="/atom-ch.xml">
                
                <i class="fas fa-rss"></i>
                
            </a>
               
            
            <a class="navbar-item btn-dark-mode" title="dark-mode" href="#">
                <div>
                    <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" width="15" height="15" viewBox="0 0 256 256" xml:space="preserve">
                    <defs>
                    </defs>
                    <g style="stroke: none; stroke-width: 0; stroke-dasharray: none; stroke-linecap: butt; stroke-linejoin: miter; stroke-miterlimit: 10; fill: none; fill-rule: nonzero; opacity: 1;" transform="translate(1.4065934065934016 1.4065934065934016) scale(2.81 2.81)" >
                        <path d="M 87.823 60.7 c -0.463 -0.423 -1.142 -0.506 -1.695 -0.214 c -15.834 8.398 -35.266 2.812 -44.232 -12.718 c -8.966 -15.53 -4.09 -35.149 11.101 -44.665 c 0.531 -0.332 0.796 -0.963 0.661 -1.574 c -0.134 -0.612 -0.638 -1.074 -1.259 -1.153 c -9.843 -1.265 -19.59 0.692 -28.193 5.66 C 13.8 12.041 6.356 21.743 3.246 33.35 S 1.732 57.08 7.741 67.487 c 6.008 10.407 15.709 17.851 27.316 20.961 C 38.933 89.486 42.866 90 46.774 90 c 7.795 0 15.489 -2.044 22.42 -6.046 c 8.601 -4.966 15.171 -12.43 18.997 -21.586 C 88.433 61.79 88.285 61.123 87.823 60.7 z" style="stroke: none; stroke-width: 1; stroke-dasharray: none; stroke-linecap: butt; stroke-linejoin: miter; stroke-miterlimit: 10; fill: #ffa716; fill-rule: nonzero; opacity: 1;" transform=" matrix(1 0 0 1 0 0) " stroke-linecap="round" />
                    </g>
                    </svg>
                </div>
            </a>
            
                <a class="navbar-item" href="/2022/03/30/en/wordpress-plugin-amelia-sensitive-information-disclosure/">English</a>
            
            

        </div>
    </div>
</nav>

    <section class="section">
    <div class="container">
      
      <div data-nosnippet class="self-notice">
        最近開了一個讀者回饋表單，無論是對文章的感想或是對部落格的感想，有什麼想回饋的都可以填表單跟我說：<a href="https://forms.gle/XuWyRC5qtSd2ANta8" target="_blank">表單連結</a>
      </div>
      
    <article class="article content gallery" itemscope itemprop="blogPost">
    <h1 class="article-title is-size-3 is-size-4-mobile" itemprop="name">
        
            WordPress Plugin Amelia &lt; 1.0.49 敏感資訊洩露漏洞細節
        
    </h1>
    <div class="article-meta columns is-variable is-1 is-multiline is-mobile is-size-7-mobile">
        <span class="column is-narrow">
            <time datetime="2022-03-30T04:00:00.000Z" itemprop="datePublished">2022年3月30日</time>
        </span>
        
        <span class="column is-narrow article-category">
            <i class="far fa-folder"></i>
            <a class="article-category-link" href="/categories/Security/">Security</a>
        </span>
        
        
        
    </div>
    
    <div class="article-entry is-size-6-mobile" itemprop="articleBody">
    
        <p><a target="_blank" rel="noopener" href="https://tw.wordpress.org/plugins/ameliabooking/">Amelia</a> 是一個由 TMS 公司所開發的 WordPress 外掛，能夠輕鬆幫你的 WordPress 網站加上預約系統的功能，例如說診所、理髮廳或是家教等等，都很適合使用這個外掛來架一個簡單的預約系統。根據 WordPress 官方的統計，大約有 40,000 個網站都安裝了這個 plugin。</p>
<p>在三月初的時候我針對 Amelia 這套系統的原始碼做了一些研究，找到了三個都是敏感資訊洩露的漏洞：</p>
<ul>
<li><code>CVE-2022-0720</code> Amelia &lt; 1.0.47 - Customer+ Arbitrary Appointments Update and Sensitive Data Disclosure (CVSS 6.3)</li>
<li><code>CVE-2022-0825</code> Amelia &lt; 1.0.49 - Customer+ Arbitrary Appointments Status Update (CVSS 6.3)</li>
<li><code>CVE-2022-0837</code> Amelia &lt; 1.0.48 - Customer+ SMS Service Abuse and Sensitive Data Disclosure (CVSS 5.4)</li>
</ul>
<p>如果被攻擊者利用這些漏洞，可以取得所有消費者的資料，包括姓名、電話以及預約資訊。</p>
<p>底下我會簡單介紹一下 Amelia 的架構以及這三個漏洞的細節。</p>
<span id="more"></span>

<h2><span id="amelia-基本介紹">Amelia 基本介紹</span></h2><p>安裝好 Amelia 以後，你可以新增一個預約頁面，大概是長這樣：</p>
<p><img src="/img/wordpress-plugin-amelia-sensitive-information-disclosure/p1-intro-1.png" alt="intro1"></p>
<p>在預約時需要提供一些基本資料，例如說姓名以及 email 等等，輸入後即可完成預約：</p>
<p><img src="/img/wordpress-plugin-amelia-sensitive-information-disclosure/p2-intro-2.png" alt="intro2"></p>
<p>完成預約以後，Amelia 會幫你在 WordPress 系統裡面新增一個低權限的帳號，並且把重設密碼的連結寄到剛剛提供的信箱。帳號開通以後，就可以登入 WordPress 管理剛剛的預約：</p>
<p><img src="/img/wordpress-plugin-amelia-sensitive-information-disclosure/p3-intro-3.png" alt="intro3"></p>
<p>使用方式介紹完以後，我們來看一下更技術的部分。</p>
<h2><span id="wordpress-外掛與-amelia-架構介紹">WordPress 外掛與 Amelia 架構介紹</span></h2><p>WordPress 的外掛有很多，每一個的寫法都不太一樣，但因為是外掛，所以會呼叫 WordPress 提供的函式來註冊事件。</p>
<p><code>add_action</code> 這個函式就扮演著很重要的角色，你可以幫特定的 action 加上一個 hook，當這個 action 被觸發時，就會呼叫到你提供的函式。</p>
<p>其中由 <code>wp_ajax_nopriv_</code> 開頭的 action，可以透過 <code>wp-admin/admin-ajax.php</code> 來呼叫，相關程式碼節錄如下（<a target="_blank" rel="noopener" href="https://github.com/WordPress/WordPress/blob/master/wp-admin/admin-ajax.php">admin-ajax.php</a>）：</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>

<span class="token variable">$action</span> <span class="token operator">=</span> <span class="token variable">$_REQUEST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'action'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token function">is_user_logged_in</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token comment">// If no action is registered, return a Bad Request response.</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span> <span class="token function">has_action</span><span class="token punctuation">(</span> <span class="token string double-quoted-string">"wp_ajax_<span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token variable">$action</span><span class="token punctuation">&#125;</span></span>"</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token function">wp_die</span><span class="token punctuation">(</span> <span class="token string single-quoted-string">'0'</span><span class="token punctuation">,</span> <span class="token number">400</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token comment">/**
   * Fires authenticated Ajax actions for logged-in users.
   *
   * The dynamic portion of the hook name, `$action`, refers
   * to the name of the Ajax action callback being fired.
   *
   * @since 2.1.0
   */</span>
  <span class="token function">do_action</span><span class="token punctuation">(</span> <span class="token string double-quoted-string">"wp_ajax_<span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token variable">$action</span><span class="token punctuation">&#125;</span></span>"</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
  <span class="token comment">// If no action is registered, return a Bad Request response.</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span> <span class="token function">has_action</span><span class="token punctuation">(</span> <span class="token string double-quoted-string">"wp_ajax_nopriv_<span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token variable">$action</span><span class="token punctuation">&#125;</span></span>"</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token function">wp_die</span><span class="token punctuation">(</span> <span class="token string single-quoted-string">'0'</span><span class="token punctuation">,</span> <span class="token number">400</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token comment">/**
   * Fires non-authenticated Ajax actions for logged-out users.
   *
   * The dynamic portion of the hook name, `$action`, refers
   * to the name of the Ajax action callback being fired.
   *
   * @since 2.8.0
   */</span>
  <span class="token function">do_action</span><span class="token punctuation">(</span> <span class="token string double-quoted-string">"wp_ajax_nopriv_<span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token variable">$action</span><span class="token punctuation">&#125;</span></span>"</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token delimiter important">?></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>以 Amelia 來說，在 <code>ameliabooking.php</code> 中註冊了兩個 hook：</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token comment">/** Isolate API calls */</span>
<span class="token function">add_action</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'wp_ajax_wpamelia_api'</span><span class="token punctuation">,</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'AmeliaBooking\Plugin'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'wpAmeliaApiCall'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">add_action</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'wp_ajax_nopriv_wpamelia_api'</span><span class="token punctuation">,</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'AmeliaBooking\Plugin'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'wpAmeliaApiCall'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>有 <code>nopriv</code> 的代表沒有權限（未登入）也可以呼叫，沒有的代表需要登入 WordPress 系統才能呼叫，而許多的 plugin 會選擇自己處理身份驗證相關的邏輯，所以會把兩個動作都導到同一個地方。</p>
<p>而 <code>wpAmeliaApiCall</code> 這個函式則是註冊了 routes：</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token comment">/**
 * API Call
 *
 * @throws \InvalidArgumentException
 */</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">function</span> <span class="token function-definition function">wpAmeliaApiCall</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">/** @var Container $container */</span>
        <span class="token variable">$container</span> <span class="token operator">=</span> <span class="token keyword">require</span> <span class="token constant">AMELIA_PATH</span> <span class="token operator">.</span> <span class="token string single-quoted-string">'/src/Infrastructure/ContainerConfig/container.php'</span><span class="token punctuation">;</span>

        <span class="token variable">$app</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">App</span><span class="token punctuation">(</span><span class="token variable">$container</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// Initialize all API routes</span>
        <span class="token class-name static-context">Routes</span><span class="token operator">::</span><span class="token function">routes</span><span class="token punctuation">(</span><span class="token variable">$app</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token variable">$app</span><span class="token operator">-></span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">exit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> <span class="token variable">$e</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">echo</span> <span class="token string single-quoted-string">'ERROR: '</span> <span class="token operator">.</span> <span class="token variable">$e</span><span class="token operator">-></span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>在 <code>src/Infrastructure/Routes</code> 底下有許多的資料夾跟檔案，裡面負責處理不同的路由，舉例來說，User 相關的路由在 <code>src/Infrastructure/Routes/User/User.php</code>，相關程式碼節錄如下：</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token comment">/**
 * Class User
 *
 * @package AmeliaBooking\Infrastructure\Routes\User
 */</span>
<span class="token keyword">class</span> <span class="token class-name-definition class-name">User</span>
<span class="token punctuation">&#123;</span>
    <span class="token comment">/**
     * @param App $app
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">function</span> <span class="token function-definition function">routes</span><span class="token punctuation">(</span><span class="token class-name type-declaration">App</span> <span class="token variable">$app</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        <span class="token variable">$app</span><span class="token operator">-></span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'/users/wp-users'</span><span class="token punctuation">,</span> <span class="token class-name static-context">GetWPUsersController</span><span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$app</span><span class="token operator">-></span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'/users/authenticate'</span><span class="token punctuation">,</span> <span class="token class-name static-context">LoginCabinetController</span><span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$app</span><span class="token operator">-></span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'/users/logout'</span><span class="token punctuation">,</span> <span class="token class-name static-context">LogoutCabinetController</span><span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// Customers</span>
        <span class="token variable">$app</span><span class="token operator">-></span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'/users/customers/&#123;id:[0-9]+&#125;'</span><span class="token punctuation">,</span> <span class="token class-name static-context">GetCustomerController</span><span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$app</span><span class="token operator">-></span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'/users/customers'</span><span class="token punctuation">,</span> <span class="token class-name static-context">GetCustomersController</span><span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$app</span><span class="token operator">-></span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'/users/customers'</span><span class="token punctuation">,</span> <span class="token class-name static-context">AddCustomerController</span><span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$app</span><span class="token operator">-></span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'/users/customers/&#123;id:[0-9]+&#125;'</span><span class="token punctuation">,</span> <span class="token class-name static-context">UpdateCustomerController</span><span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$app</span><span class="token operator">-></span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'/users/customers/delete/&#123;id:[0-9]+&#125;'</span><span class="token punctuation">,</span> <span class="token class-name static-context">DeleteUserController</span><span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$app</span><span class="token operator">-></span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'/users/customers/effect/&#123;id:[0-9]+&#125;'</span><span class="token punctuation">,</span> <span class="token class-name static-context">GetUserDeleteEffectController</span><span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$app</span><span class="token operator">-></span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'/users/customers/reauthorize'</span><span class="token punctuation">,</span> <span class="token class-name static-context">ReauthorizeController</span><span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// Providers</span>
        <span class="token variable">$app</span><span class="token operator">-></span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'/users/providers/&#123;id:[0-9]+&#125;'</span><span class="token punctuation">,</span> <span class="token class-name static-context">GetProviderController</span><span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$app</span><span class="token operator">-></span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'/users/providers'</span><span class="token punctuation">,</span> <span class="token class-name static-context">GetProvidersController</span><span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$app</span><span class="token operator">-></span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'/users/providers'</span><span class="token punctuation">,</span> <span class="token class-name static-context">AddProviderController</span><span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$app</span><span class="token operator">-></span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'/users/providers/&#123;id:[0-9]+&#125;'</span><span class="token punctuation">,</span> <span class="token class-name static-context">UpdateProviderController</span><span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$app</span><span class="token operator">-></span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'/users/providers/status/&#123;id:[0-9]+&#125;'</span><span class="token punctuation">,</span> <span class="token class-name static-context">UpdateProviderStatusController</span><span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$app</span><span class="token operator">-></span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'/users/providers/delete/&#123;id:[0-9]+&#125;'</span><span class="token punctuation">,</span> <span class="token class-name static-context">DeleteUserController</span><span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$app</span><span class="token operator">-></span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'/users/providers/effect/&#123;id:[0-9]+&#125;'</span><span class="token punctuation">,</span> <span class="token class-name static-context">GetUserDeleteEffectController</span><span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// Current User</span>
        <span class="token variable">$app</span><span class="token operator">-></span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'/users/current'</span><span class="token punctuation">,</span> <span class="token class-name static-context">GetCurrentUserController</span><span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>那實際上到底要怎麼呼叫到這些路由呢？在 <code>src/Infrastructure/ContainerConfig/request.php</code> 中，針對 request 的 query string 做了一些轉換：</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>

<span class="token keyword">use</span> <span class="token package">Slim<span class="token punctuation">\</span>Http<span class="token punctuation">\</span>Request</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token package">Slim<span class="token punctuation">\</span>Http<span class="token punctuation">\</span>Uri</span><span class="token punctuation">;</span>

<span class="token variable">$entries</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'request'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token class-name class-name-fully-qualified type-declaration">AmeliaBooking<span class="token punctuation">\</span>Infrastructure<span class="token punctuation">\</span>Common<span class="token punctuation">\</span>Container</span> <span class="token variable">$c</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

    <span class="token variable">$curUri</span> <span class="token operator">=</span> <span class="token class-name static-context">Uri</span><span class="token operator">::</span><span class="token function">createFromEnvironment</span><span class="token punctuation">(</span><span class="token variable">$c</span><span class="token operator">-></span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'environment'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 附註：AMELIA_ACTION_SLUG = "action=wpamelia_api&amp;call="</span>
    <span class="token variable">$newRoute</span> <span class="token operator">=</span> <span class="token function">str_replace</span><span class="token punctuation">(</span>
        <span class="token punctuation">[</span><span class="token string single-quoted-string">'XDEBUG_SESSION_START=PHPSTORM&amp;'</span> <span class="token operator">.</span> <span class="token constant">AMELIA_ACTION_SLUG</span><span class="token punctuation">,</span> <span class="token constant">AMELIA_ACTION_SLUG</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token string single-quoted-string">''</span><span class="token punctuation">,</span>
        <span class="token variable">$curUri</span><span class="token operator">-></span><span class="token function">getQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token variable">$newPath</span> <span class="token operator">=</span> <span class="token function">strpos</span><span class="token punctuation">(</span><span class="token variable">$newRoute</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'&amp;'</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token function">substr</span><span class="token punctuation">(</span>
        <span class="token variable">$newRoute</span><span class="token punctuation">,</span>
        <span class="token number">0</span><span class="token punctuation">,</span>
        <span class="token function">strpos</span><span class="token punctuation">(</span><span class="token variable">$newRoute</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'&amp;'</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token variable">$newRoute</span><span class="token punctuation">;</span>

    <span class="token variable">$newQuery</span> <span class="token operator">=</span> <span class="token function">strpos</span><span class="token punctuation">(</span><span class="token variable">$newRoute</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'&amp;'</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token function">substr</span><span class="token punctuation">(</span>
        <span class="token variable">$newRoute</span><span class="token punctuation">,</span>
        <span class="token function">strpos</span><span class="token punctuation">(</span><span class="token variable">$newRoute</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'&amp;'</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span>
    <span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token string single-quoted-string">''</span><span class="token punctuation">;</span>

   <span class="token variable">$request</span> <span class="token operator">=</span> <span class="token class-name static-context">Request</span><span class="token operator">::</span><span class="token function">createFromEnvironment</span><span class="token punctuation">(</span><span class="token variable">$c</span><span class="token operator">-></span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'environment'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
       <span class="token operator">-></span><span class="token function">withUri</span><span class="token punctuation">(</span>
           <span class="token variable">$curUri</span>
               <span class="token operator">-></span><span class="token function">withPath</span><span class="token punctuation">(</span><span class="token variable">$newPath</span><span class="token punctuation">)</span>
               <span class="token operator">-></span><span class="token function">withQuery</span><span class="token punctuation">(</span><span class="token variable">$newQuery</span><span class="token punctuation">)</span>
       <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">method_exists</span><span class="token punctuation">(</span><span class="token variable">$request</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'getParam'</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token variable">$request</span><span class="token operator">-></span><span class="token function">getParam</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'showAmeliaErrors'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token function">ini_set</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'display_errors'</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">ini_set</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'display_startup_errors'</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">error_reporting</span><span class="token punctuation">(</span><span class="token constant">E_ALL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">return</span> <span class="token variable">$request</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>簡單來說呢，當你的 request URL 長這樣的時候：<code>/wordpress/wp-admin/admin-ajax.php?action=wpamelia_api&amp;call=/users/wp-users</code>，query string 就是 <code>action=wpamelia_api&amp;call=/users/wp-users</code>，符合 AMELIA_ACTION_SLUG 的地方被換成空白之後，就變成了 <code>/users/wp-users</code>，就對應到了上面的檔案看到的路由，重新交由 Slim 這個 PHP 框架去處理。</p>
<p>而 <code>/users/wp-users</code> 對應到的是 <code>GetWPUsersController::class</code>，讓我們來看一下 controller 的程式碼：</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>

<span class="token keyword">namespace</span> <span class="token package">AmeliaBooking<span class="token punctuation">\</span>Application<span class="token punctuation">\</span>Controller<span class="token punctuation">\</span>User</span><span class="token punctuation">;</span>

<span class="token keyword">use</span> <span class="token package">AmeliaBooking<span class="token punctuation">\</span>Application<span class="token punctuation">\</span>Commands<span class="token punctuation">\</span>User<span class="token punctuation">\</span>GetWPUsersCommand</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token package">AmeliaBooking<span class="token punctuation">\</span>Application<span class="token punctuation">\</span>Controller<span class="token punctuation">\</span>Controller</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token package">Slim<span class="token punctuation">\</span>Http<span class="token punctuation">\</span>Request</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * Class GetWPUsersController
 *
 * @package AmeliaBooking\Application\Controller\User
 */</span>
<span class="token keyword">class</span> <span class="token class-name-definition class-name">GetWPUsersController</span> <span class="token keyword">extends</span> <span class="token class-name">Controller</span>
<span class="token punctuation">&#123;</span>
    <span class="token comment">/**
     * Instantiates the Get WP Users command to hand it over to the Command Handler
     *
     * @param Request $request
     * @param         $args
     *
     * @return GetWPUsersCommand
     * @throws \RuntimeException
     */</span>
    <span class="token keyword">protected</span> <span class="token keyword">function</span> <span class="token function-definition function">instantiateCommand</span><span class="token punctuation">(</span><span class="token class-name type-declaration">Request</span> <span class="token variable">$request</span><span class="token punctuation">,</span> <span class="token variable">$args</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        <span class="token variable">$command</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">GetWPUsersCommand</span><span class="token punctuation">(</span><span class="token variable">$args</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$command</span><span class="token operator">-></span><span class="token function">setField</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'id'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword type-casting">int</span><span class="token punctuation">)</span><span class="token variable">$request</span><span class="token operator">-></span><span class="token function">getQueryParam</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'id'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$command</span><span class="token operator">-></span><span class="token function">setField</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'role'</span><span class="token punctuation">,</span> <span class="token variable">$request</span><span class="token operator">-></span><span class="token function">getQueryParam</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'role'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$requestBody</span> <span class="token operator">=</span> <span class="token variable">$request</span><span class="token operator">-></span><span class="token function">getParsedBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$this</span><span class="token operator">-></span><span class="token function">setCommandFields</span><span class="token punctuation">(</span><span class="token variable">$command</span><span class="token punctuation">,</span> <span class="token variable">$requestBody</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> <span class="token variable">$command</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>這邊使用了設計模式中的 Command Pattern，把每一個動作都包裝成一個指令，那這個指令會被誰處理呢？每一個 controller 都繼承了 <code>AmeliaBooking\Application\Controller\Controller</code>，所以處理的程式碼就在裡面：</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token comment">/**
 * @param Request  $request
 * @param Response $response
 * @param          $args
 *
 * @return Response
 * @throws \InvalidArgumentException
 * @throws \RuntimeException
 */</span>
<span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">__invoke</span><span class="token punctuation">(</span><span class="token class-name type-declaration">Request</span> <span class="token variable">$request</span><span class="token punctuation">,</span> <span class="token class-name type-declaration">Response</span> <span class="token variable">$response</span><span class="token punctuation">,</span> <span class="token variable">$args</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token comment">/** @var Command $command */</span>
    <span class="token variable">$command</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-></span><span class="token function">instantiateCommand</span><span class="token punctuation">(</span><span class="token variable">$request</span><span class="token punctuation">,</span> <span class="token variable">$args</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">wp_verify_nonce</span><span class="token punctuation">(</span><span class="token variable">$command</span><span class="token operator">-></span><span class="token function">getField</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'ameliaNonce'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'ajax-nonce'</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
        <span class="token punctuation">(</span>
            <span class="token variable">$command</span> <span class="token keyword">instanceof</span> <span class="token class-name">DeleteUserCommand</span> <span class="token operator">||</span>
            <span class="token variable">$command</span> <span class="token keyword">instanceof</span> <span class="token class-name">DeletePackageCommand</span> <span class="token operator">||</span>
            <span class="token variable">$command</span> <span class="token keyword">instanceof</span> <span class="token class-name">DeleteCategoryCommand</span> <span class="token operator">||</span>
            <span class="token variable">$command</span> <span class="token keyword">instanceof</span> <span class="token class-name">DeleteServiceCommand</span> <span class="token operator">||</span>
            <span class="token variable">$command</span> <span class="token keyword">instanceof</span> <span class="token class-name">DeleteExtraCommand</span> <span class="token operator">||</span>
            <span class="token variable">$command</span> <span class="token keyword">instanceof</span> <span class="token class-name">DeleteLocationCommand</span> <span class="token operator">||</span>
            <span class="token variable">$command</span> <span class="token keyword">instanceof</span> <span class="token class-name">DeleteEventCommand</span> <span class="token operator">||</span>
            <span class="token variable">$command</span> <span class="token keyword">instanceof</span> <span class="token class-name">DeletePaymentCommand</span> <span class="token operator">||</span>
            <span class="token variable">$command</span> <span class="token keyword">instanceof</span> <span class="token class-name">DeleteCouponCommand</span> <span class="token operator">||</span>
            <span class="token variable">$command</span> <span class="token keyword">instanceof</span> <span class="token class-name">DeleteCustomFieldCommand</span> <span class="token operator">||</span>
            <span class="token variable">$command</span> <span class="token keyword">instanceof</span> <span class="token class-name">DeleteAppointmentCommand</span> <span class="token operator">||</span>
            <span class="token variable">$command</span> <span class="token keyword">instanceof</span> <span class="token class-name">DeleteBookingCommand</span> <span class="token operator">||</span>
            <span class="token variable">$command</span> <span class="token keyword">instanceof</span> <span class="token class-name">DeleteEventBookingCommand</span> <span class="token operator">||</span>
            <span class="token variable">$command</span> <span class="token keyword">instanceof</span> <span class="token class-name">DeletePackageCustomerCommand</span> <span class="token operator">||</span>
            <span class="token variable">$command</span> <span class="token keyword">instanceof</span> <span class="token class-name">DeleteNotificationCommand</span>
        <span class="token punctuation">)</span>
    <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token variable">$response</span><span class="token operator">-></span><span class="token function">withStatus</span><span class="token punctuation">(</span><span class="token keyword static-context">self</span><span class="token operator">::</span><span class="token constant">STATUS_INTERNAL_SERVER_ERROR</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">/** @var CommandResult $commandResult */</span>
    <span class="token variable">$commandResult</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">commandBus</span><span class="token operator">-></span><span class="token function">handle</span><span class="token punctuation">(</span><span class="token variable">$command</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$commandResult</span><span class="token operator">-></span><span class="token function">getUrl</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!==</span> <span class="token constant">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token variable">$this</span><span class="token operator">-></span><span class="token function">emitSuccessEvent</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-></span><span class="token property">eventBus</span><span class="token punctuation">,</span> <span class="token variable">$commandResult</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">/** @var Response $response */</span>
        <span class="token variable">$response</span> <span class="token operator">=</span> <span class="token variable">$response</span><span class="token operator">-></span><span class="token function">withHeader</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'Location'</span><span class="token punctuation">,</span> <span class="token variable">$commandResult</span><span class="token operator">-></span><span class="token function">getUrl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$response</span> <span class="token operator">=</span> <span class="token variable">$response</span><span class="token operator">-></span><span class="token function">withStatus</span><span class="token punctuation">(</span><span class="token keyword static-context">self</span><span class="token operator">::</span><span class="token constant">STATUS_REDIRECT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> <span class="token variable">$response</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$commandResult</span><span class="token operator">-></span><span class="token function">hasAttachment</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token constant boolean">false</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token variable">$responseBody</span> <span class="token operator">=</span> <span class="token punctuation">[</span>
            <span class="token string single-quoted-string">'message'</span> <span class="token operator">=></span> <span class="token variable">$commandResult</span><span class="token operator">-></span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token string single-quoted-string">'data'</span>    <span class="token operator">=></span> <span class="token variable">$commandResult</span><span class="token operator">-></span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">]</span><span class="token punctuation">;</span>

        <span class="token variable">$this</span><span class="token operator">-></span><span class="token function">emitSuccessEvent</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-></span><span class="token property">eventBus</span><span class="token punctuation">,</span> <span class="token variable">$commandResult</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">switch</span> <span class="token punctuation">(</span><span class="token variable">$commandResult</span><span class="token operator">-></span><span class="token function">getResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">case</span> <span class="token punctuation">(</span><span class="token class-name static-context">CommandResult</span><span class="token operator">::</span><span class="token constant">RESULT_SUCCESS</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                <span class="token variable">$response</span> <span class="token operator">=</span> <span class="token variable">$response</span><span class="token operator">-></span><span class="token function">withStatus</span><span class="token punctuation">(</span><span class="token keyword static-context">self</span><span class="token operator">::</span><span class="token constant">STATUS_OK</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> <span class="token punctuation">(</span><span class="token class-name static-context">CommandResult</span><span class="token operator">::</span><span class="token constant">RESULT_CONFLICT</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                <span class="token variable">$response</span> <span class="token operator">=</span> <span class="token variable">$response</span><span class="token operator">-></span><span class="token function">withStatus</span><span class="token punctuation">(</span><span class="token keyword static-context">self</span><span class="token operator">::</span><span class="token constant">STATUS_CONFLICT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">default</span><span class="token punctuation">:</span>
                <span class="token variable">$response</span> <span class="token operator">=</span> <span class="token variable">$response</span><span class="token operator">-></span><span class="token function">withStatus</span><span class="token punctuation">(</span><span class="token keyword static-context">self</span><span class="token operator">::</span><span class="token constant">STATUS_INTERNAL_SERVER_ERROR</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token comment">/** @var Response $response */</span>
        <span class="token variable">$response</span> <span class="token operator">=</span> <span class="token variable">$response</span><span class="token operator">-></span><span class="token function">withHeader</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'Content-Type'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'application/json;charset=utf-8'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$response</span> <span class="token operator">=</span> <span class="token variable">$response</span><span class="token operator">-></span><span class="token function">write</span><span class="token punctuation">(</span>
            <span class="token function">json_encode</span><span class="token punctuation">(</span>
                <span class="token variable">$commandResult</span><span class="token operator">-></span><span class="token function">hasDataInResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">?</span>
                    <span class="token variable">$responseBody</span> <span class="token punctuation">:</span> <span class="token function">array_merge</span><span class="token punctuation">(</span><span class="token variable">$responseBody</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string single-quoted-string">'data'</span> <span class="token operator">=></span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
            <span class="token punctuation">)</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">return</span> <span class="token variable">$response</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>這邊先實例化一個指令之後，再丟到 commandBus 去做處理：<code>$this-&gt;commandBus-&gt;handle($command)</code>，程式碼在 <code>src/Infrastructure/ContainerConfig/command.bus.php</code>，節錄部分：</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>

<span class="token function">defined</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'ABSPATH'</span><span class="token punctuation">)</span> <span class="token keyword">or</span> <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'No script kiddies please!'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// @codingStandardsIgnoreStart</span>
<span class="token variable">$entries</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'command.bus'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token variable">$c</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token variable">$commands</span> <span class="token operator">=</span> <span class="token punctuation">[</span>
        <span class="token comment">// User</span>
        <span class="token class-name class-name-fully-qualified static-context">User<span class="token punctuation">\</span>DeleteUserCommand</span><span class="token operator">::</span><span class="token keyword">class</span>                             <span class="token operator">=></span> <span class="token keyword">new</span> <span class="token class-name class-name-fully-qualified">User<span class="token punctuation">\</span>DeleteUserCommandHandler</span><span class="token punctuation">(</span><span class="token variable">$c</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token class-name class-name-fully-qualified static-context">User<span class="token punctuation">\</span>GetCurrentUserCommand</span><span class="token operator">::</span><span class="token keyword">class</span>                         <span class="token operator">=></span> <span class="token keyword">new</span> <span class="token class-name class-name-fully-qualified">User<span class="token punctuation">\</span>GetCurrentUserCommandHandler</span><span class="token punctuation">(</span><span class="token variable">$c</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token class-name class-name-fully-qualified static-context">User<span class="token punctuation">\</span>GetUserDeleteEffectCommand</span><span class="token operator">::</span><span class="token keyword">class</span>                    <span class="token operator">=></span> <span class="token keyword">new</span> <span class="token class-name class-name-fully-qualified">User<span class="token punctuation">\</span>GetUserDeleteEffectCommandHandler</span><span class="token punctuation">(</span><span class="token variable">$c</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token class-name class-name-fully-qualified static-context">User<span class="token punctuation">\</span>GetWPUsersCommand</span><span class="token operator">::</span><span class="token keyword">class</span>                             <span class="token operator">=></span> <span class="token keyword">new</span> <span class="token class-name class-name-fully-qualified">User<span class="token punctuation">\</span>GetWPUsersCommandHandler</span><span class="token punctuation">(</span><span class="token variable">$c</span><span class="token punctuation">)</span><span class="token punctuation">,</span>

        <span class="token comment">// more commands...</span>
    <span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token class-name class-name-fully-qualified static-context">League<span class="token punctuation">\</span>Tactician<span class="token punctuation">\</span>Setup<span class="token punctuation">\</span>QuickStart</span><span class="token operator">::</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token variable">$commands</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
<span class="token comment">// @codingStandardsIgnoreEnd</span>
</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>從中可以看出我們的 <code>GetWPUsersCommand</code> 會被 <code>User\GetWPUsersCommandHandler</code> 處理，所以主要的邏輯就在這裡面：</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token keyword">class</span> <span class="token class-name-definition class-name">GetWPUsersCommandHandler</span> <span class="token keyword">extends</span> <span class="token class-name">CommandHandler</span>
<span class="token punctuation">&#123;</span>
    <span class="token comment">/**
     * @param GetWPUsersCommand $command
     *
     * @return CommandResult
     * @throws AccessDeniedException
     * @throws InvalidArgumentException
     * @throws \AmeliaBooking\Infrastructure\Common\Exceptions\QueryExecutionException
     * @throws \Interop\Container\Exception\ContainerException
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">handle</span><span class="token punctuation">(</span><span class="token class-name type-declaration">GetWPUsersCommand</span> <span class="token variable">$command</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token variable">$this</span><span class="token operator">-></span><span class="token function">getContainer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">getPermissionsService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">currentUserCanRead</span><span class="token punctuation">(</span><span class="token class-name static-context">Entities</span><span class="token operator">::</span><span class="token constant">EMPLOYEES</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">AccessDeniedException</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'You are not allowed to read employees.'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token variable">$this</span><span class="token operator">-></span><span class="token function">getContainer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">getPermissionsService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">currentUserCanRead</span><span class="token punctuation">(</span><span class="token class-name static-context">Entities</span><span class="token operator">::</span><span class="token constant">CUSTOMERS</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">AccessDeniedException</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'You are not allowed to read customers.'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token variable">$result</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CommandResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token variable">$this</span><span class="token operator">-></span><span class="token function">checkMandatoryFields</span><span class="token punctuation">(</span><span class="token variable">$command</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">/** @var UserService $userService */</span>
        <span class="token variable">$userService</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">container</span><span class="token operator">-></span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'users.service'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token variable">$adminIds</span> <span class="token operator">=</span> <span class="token variable">$userService</span><span class="token operator">-></span><span class="token function">getWpUserIdsByRoles</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'administrator'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">/** @var WPUserRepository $wpUserRepository */</span>
        <span class="token variable">$wpUserRepository</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-></span><span class="token function">getContainer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'domain.wpUsers.repository'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token variable">$result</span><span class="token operator">-></span><span class="token function">setResult</span><span class="token punctuation">(</span><span class="token class-name static-context">CommandResult</span><span class="token operator">::</span><span class="token constant">RESULT_SUCCESS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$result</span><span class="token operator">-></span><span class="token function">setMessage</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'Successfully retrieved users.'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token variable">$result</span><span class="token operator">-></span><span class="token function">setData</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
            <span class="token class-name static-context">Entities</span><span class="token operator">::</span><span class="token constant">USER</span> <span class="token operator">.</span> <span class="token string single-quoted-string">'s'</span> <span class="token operator">=></span> <span class="token variable">$wpUserRepository</span><span class="token operator">-></span><span class="token function">getAllNonRelatedWPUsers</span><span class="token punctuation">(</span><span class="token variable">$command</span><span class="token operator">-></span><span class="token function">getFields</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token variable">$adminIds</span><span class="token punctuation">)</span>
        <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> <span class="token variable">$result</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>可以看到業務邏輯都在 <code>handle</code> 這個函式裡面，裡面先檢查了權限，接著透過 <code>userService</code> 抓取相關資料，再來用 <code>$result-&gt;setData</code> 設置要回傳的資料，最後回傳結果，交給其他 infra 相關程式碼處理。</p>
<p>另外，在 controller 中可以看到 command 相關的權限檢查：</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">wp_verify_nonce</span><span class="token punctuation">(</span><span class="token variable">$command</span><span class="token operator">-></span><span class="token function">getField</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'ameliaNonce'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'ajax-nonce'</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
  <span class="token punctuation">(</span>
      <span class="token variable">$command</span> <span class="token keyword">instanceof</span> <span class="token class-name">DeleteUserCommand</span> <span class="token operator">||</span>
      <span class="token variable">$command</span> <span class="token keyword">instanceof</span> <span class="token class-name">DeletePackageCommand</span> <span class="token operator">||</span>
      <span class="token variable">$command</span> <span class="token keyword">instanceof</span> <span class="token class-name">DeleteCategoryCommand</span> <span class="token operator">||</span>
      <span class="token variable">$command</span> <span class="token keyword">instanceof</span> <span class="token class-name">DeleteServiceCommand</span> <span class="token operator">||</span>
      <span class="token variable">$command</span> <span class="token keyword">instanceof</span> <span class="token class-name">DeleteExtraCommand</span> <span class="token operator">||</span>
      <span class="token variable">$command</span> <span class="token keyword">instanceof</span> <span class="token class-name">DeleteLocationCommand</span> <span class="token operator">||</span>
      <span class="token variable">$command</span> <span class="token keyword">instanceof</span> <span class="token class-name">DeleteEventCommand</span> <span class="token operator">||</span>
      <span class="token variable">$command</span> <span class="token keyword">instanceof</span> <span class="token class-name">DeletePaymentCommand</span> <span class="token operator">||</span>
      <span class="token variable">$command</span> <span class="token keyword">instanceof</span> <span class="token class-name">DeleteCouponCommand</span> <span class="token operator">||</span>
      <span class="token variable">$command</span> <span class="token keyword">instanceof</span> <span class="token class-name">DeleteCustomFieldCommand</span> <span class="token operator">||</span>
      <span class="token variable">$command</span> <span class="token keyword">instanceof</span> <span class="token class-name">DeleteAppointmentCommand</span> <span class="token operator">||</span>
      <span class="token variable">$command</span> <span class="token keyword">instanceof</span> <span class="token class-name">DeleteBookingCommand</span> <span class="token operator">||</span>
      <span class="token variable">$command</span> <span class="token keyword">instanceof</span> <span class="token class-name">DeleteEventBookingCommand</span> <span class="token operator">||</span>
      <span class="token variable">$command</span> <span class="token keyword">instanceof</span> <span class="token class-name">DeletePackageCustomerCommand</span> <span class="token operator">||</span>
      <span class="token variable">$command</span> <span class="token keyword">instanceof</span> <span class="token class-name">DeleteNotificationCommand</span>
  <span class="token punctuation">)</span>
<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">return</span> <span class="token variable">$response</span><span class="token operator">-></span><span class="token function">withStatus</span><span class="token punctuation">(</span><span class="token keyword static-context">self</span><span class="token operator">::</span><span class="token constant">STATUS_INTERNAL_SERVER_ERROR</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>如果是這些 delete 的指令，就需要通過 <code>wp_verify_nonce</code> 的檢查，這是什麼東西呢？</p>
<p><code>wp_verify_nonce</code> 是 WordPress 提供用於安全性檢查的函式，對應的函式是 <code>wp_create_nonce</code>，在 WordPress 後台管理頁面有這樣一行程式碼：<code>var wpAmeliaNonce = &#39;&lt;?php echo wp_create_nonce(&#39;ajax-nonce&#39;); ?&gt;&#39;;</code>，會產生一個名稱為 <code>ajax-nonce</code> 的 nonce，而這個 nonce 其實就是把一些字串 hash 過後的結果。</p>
<p>如果你拿不到 hash 時用的 salt，基本上不可能偽造出 nonce，因為 salt 預設都非常長，而且都是安裝時隨機產生的：</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token function">define</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'AUTH_KEY'</span><span class="token punctuation">,</span>         <span class="token string single-quoted-string">' Xakm&lt;o xQy rw4EMsLKM-?!T+,PFF&#125;)H4lzcW57AF0U@N@&lt; >M%G4Yt>f`z]MON'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">define</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'SECURE_AUTH_KEY'</span><span class="token punctuation">,</span>  <span class="token string single-quoted-string">'LzJ&#125;op]mr|6+![P&#125;Ak:uNdJCJZd>(Hx.-Mh#Tz)pCIU#uGEnfFz|f ;;eU%/U^O~'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">define</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'LOGGED_IN_KEY'</span><span class="token punctuation">,</span>    <span class="token string single-quoted-string">'|i|Ux`9&lt;p-h$aFf(qnT:sDO:D1P^wZ$$/Ra@miTJi9G;ddp_&lt;q&#125;6H1)o|a +&amp;JCM'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">define</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'NONCE_KEY'</span><span class="token punctuation">,</span>        <span class="token string single-quoted-string">'%:R&#123;[P|,s.KuMltH5&#125;cI;/k&lt;Gx~j!f0I)m_sIyu+&amp;NJZ)-iO>z7X>QYR0Z_XnZ@|'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">define</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'AUTH_SALT'</span><span class="token punctuation">,</span>        <span class="token string single-quoted-string">'eZyT)-Naw]F8CwA*VaW#q*|.)g@o&#125;||wf~@C-YSt&#125;(dh_r6EbI#A,y|nU2&#123;B#JBW'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">define</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'SECURE_AUTH_SALT'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'!=oLUTXh,QW=H `&#125;`L|9/^4-3 STz&#125;,T(w&#125;W&lt;I`.JjPi)&lt;Bmf1v,HpGe&#125;T1:Xt7n'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">define</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'LOGGED_IN_SALT'</span><span class="token punctuation">,</span>   <span class="token string single-quoted-string">'+XSqHc;@Q*K_b|Z?NC[3H!!EONbh.n&lt;+=uKR:>*c(u`g~EJBf#8u#R&#123;mUEZrozmm'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">define</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'NONCE_SALT'</span><span class="token punctuation">,</span>       <span class="token string single-quoted-string">'h`GXHhD>SLWVfg1(1(N&#123;;.V!MoE(SfbA_ksP@&amp;`+AycHcAV$+?@3q+rxV&#123;%^VyKT'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>因此，透過 <code>wp_verify_nonce</code>，我們可以確保只有已登入的使用者能使用到某些功能，因為沒登入的話拿不到 nonce。</p>
<p>以上就是 Amelia 的基本架構跟處理流程，是我看過的幾個 plugin 中最為漂亮的一個，東西都整理得很好，架構也切得不錯，不會出現一堆雜七雜八的程式碼，要找東西也很好找，只要去 routes 看一下網址跟對應的 controller，循線找到 command 跟 command handler 即可。</p>
<p>接著，就來談談開頭提到的那三個漏洞。</p>
<h2><span id="cve-2022-0720-amelia-lt-1047-customer-arbitrary-appointments-update-and-sensitive-data-disclosure">CVE-2022-0720: Amelia &lt; 1.0.47 - Customer+ Arbitrary Appointments Update and Sensitive Data Disclosure</span></h2><p>管理訂房相關的模組有兩個，一個叫做 Appointment，另一個叫做 Booking，他們是一對多的關係，一個 Appointment 底下可以對應到多個 Booking，相關路由如下：</p>
<p><code>src/Infrastructure/Routes/Booking/Appointment/Appointment.php</code></p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token keyword">class</span> <span class="token class-name-definition class-name">Appointment</span>
<span class="token punctuation">&#123;</span>
    <span class="token comment">/**
     * @param App $app
     *
     * @throws \InvalidArgumentException
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">function</span> <span class="token function-definition function">routes</span><span class="token punctuation">(</span><span class="token class-name type-declaration">App</span> <span class="token variable">$app</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        <span class="token variable">$app</span><span class="token operator">-></span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'/appointments'</span><span class="token punctuation">,</span> <span class="token class-name static-context">GetAppointmentsController</span><span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$app</span><span class="token operator">-></span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'/appointments/&#123;id:[0-9]+&#125;'</span><span class="token punctuation">,</span> <span class="token class-name static-context">GetAppointmentController</span><span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$app</span><span class="token operator">-></span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'/appointments'</span><span class="token punctuation">,</span> <span class="token class-name static-context">AddAppointmentController</span><span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$app</span><span class="token operator">-></span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'/appointments/delete/&#123;id:[0-9]+&#125;'</span><span class="token punctuation">,</span> <span class="token class-name static-context">DeleteAppointmentController</span><span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$app</span><span class="token operator">-></span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'/appointments/&#123;id:[0-9]+&#125;'</span><span class="token punctuation">,</span> <span class="token class-name static-context">UpdateAppointmentController</span><span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$app</span><span class="token operator">-></span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'/appointments/status/&#123;id:[0-9]+&#125;'</span><span class="token punctuation">,</span> <span class="token class-name static-context">UpdateAppointmentStatusController</span><span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$app</span><span class="token operator">-></span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'/appointments/time/&#123;id:[0-9]+&#125;'</span><span class="token punctuation">,</span> <span class="token class-name static-context">UpdateAppointmentTimeController</span><span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>以顯示 appointment 的路由 <code>/appointments/&#123;id:[0-9]+&#125;</code> 為例，對應到 <code>GetAppointmentController</code>，在 controller 中會去呼叫 <code>GetAppointmentCommandHandler</code>，裡面有段程式碼是這樣的：</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token variable">$customerAS</span><span class="token operator">-></span><span class="token function">removeBookingsForOtherCustomers</span><span class="token punctuation">(</span><span class="token variable">$user</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Collection</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token variable">$appointment</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>在回傳資料前，會把不屬於自己的 booking 全部都過濾掉，所以看不到其他人的資料，有做好權限管理。</p>
<p>而更新 appointment 的路由對應到的 controller 是 <code>UpdateAppointmentController</code>，又對應到了 <code>UpdateAppointmentCommandHandler.php</code>，部分程式碼如下：</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">/** @var AbstractUser $user */</span>
    <span class="token variable">$user</span> <span class="token operator">=</span> <span class="token variable">$userAS</span><span class="token operator">-></span><span class="token function">authorization</span><span class="token punctuation">(</span>
        <span class="token variable">$command</span><span class="token operator">-></span><span class="token function">getPage</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token string single-quoted-string">'cabinet'</span> <span class="token operator">?</span> <span class="token variable">$command</span><span class="token operator">-></span><span class="token function">getToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token class-name return-type">null</span><span class="token punctuation">,</span>
        <span class="token variable">$command</span><span class="token operator">-></span><span class="token function">getCabinetType</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">AuthorizationException</span> <span class="token variable">$e</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token variable">$result</span><span class="token operator">-></span><span class="token function">setResult</span><span class="token punctuation">(</span><span class="token class-name static-context">CommandResult</span><span class="token operator">::</span><span class="token constant">RESULT_ERROR</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$result</span><span class="token operator">-></span><span class="token function">setData</span><span class="token punctuation">(</span>
        <span class="token punctuation">[</span>
            <span class="token string single-quoted-string">'reauthorize'</span> <span class="token operator">=></span> <span class="token constant boolean">true</span>
        <span class="token punctuation">]</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token variable">$result</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$userAS</span><span class="token operator">-></span><span class="token function">isProvider</span><span class="token punctuation">(</span><span class="token variable">$user</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token variable">$settingsDS</span><span class="token operator">-></span><span class="token function">getSetting</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'roles'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'allowWriteAppointments'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">AccessDeniedException</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'You are not allowed to update appointment'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">// update appointment</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>開頭有檢查了兩樣東西，第一樣是使用者是否登入，所以儘管沒有 nonce 也可以進來這個路由，在這邊還是會被擋下來。第二樣則是使用者的身份，如果是 provider 才會檢查有沒有權限。</p>
<p>在 Amelia 中基本上有幾個角色，消費者（Customer)、服務提供者（Provider）以及管理員（Admin），所以只要我們不是 provider，就可以通過這邊的檢查。</p>
<p>開頭有提過只要透過 Amelia 的外掛隨便預約一個服務，就可以在 WordPress 的系統中註冊一個 customer 的帳號，這組帳號可以登入 WordPress，來管理自己之前的預約。</p>
<p>因此，這邊的權限檢查是有漏洞的，一個 customer 身份的使用者可以通過這邊的檢查，去竄改其他人的預約。雖然看起來好像很普通，但其實使用者在前台修改自己的預約時，用的是另外一個 <code>/bookings/&#123;id&#125;</code> 的 API，這個 appointment 的 API 我猜預設是給 provider 使用的，所以才沒考慮到 customer 的狀況。</p>
<p>那除了修改 booking 以外，還可以幹嘛呢？我們來看一下更新完的 response：</p>
<p><img src="/img/wordpress-plugin-amelia-sensitive-information-disclosure/p4-update.png" alt="update booking"></p>
<p>我們可以看到 response 中有個 info 欄位，裡面有原本消費者的個人資料，包括姓名以及電話等等，這個欄位是在 <code>src/Application/Services/Reservation/AbstractReservationService.php</code> 中的 <code>processBooking</code> 時儲存的：</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token variable">$appointmentData</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'bookings'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'info'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">json_encode</span><span class="token punctuation">(</span>
<span class="token punctuation">[</span>
    <span class="token string single-quoted-string">'firstName'</span> <span class="token operator">=></span> <span class="token variable">$appointmentData</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'bookings'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'customer'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'firstName'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token string single-quoted-string">'lastName'</span>  <span class="token operator">=></span> <span class="token variable">$appointmentData</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'bookings'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'customer'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'lastName'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token string single-quoted-string">'phone'</span>     <span class="token operator">=></span> <span class="token variable">$appointmentData</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'bookings'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'customer'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'phone'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token string single-quoted-string">'locale'</span>    <span class="token operator">=></span> <span class="token variable">$appointmentData</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'locale'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token string single-quoted-string">'timeZone'</span>  <span class="token operator">=></span> <span class="token variable">$appointmentData</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'timeZone'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token string single-quoted-string">'urlParams'</span> <span class="token operator">=></span> <span class="token operator">!</span><span class="token keyword">empty</span><span class="token punctuation">(</span><span class="token variable">$appointmentData</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'urlParams'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token variable">$appointmentData</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'urlParams'</span><span class="token punctuation">]</span> <span class="token punctuation">:</span> <span class="token constant">null</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>總結一下，因為權限檢查沒做好，所以 customer 可以更新其他人的預約，並且看到消費者的個人資料，而 appointment 的 ID 是流水號，所以直接列舉一下，就可以把系統中所有人的個資都撈出來。</p>
<h3><span id="修復方式">修復方式</span></h3><p>在 1.0.47 版中，有做出了兩個變動，第一個是針對我回報的問題，加上了對於 customer 的權限檢查：</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$userAS</span><span class="token operator">-></span><span class="token function">isCustomer</span><span class="token punctuation">(</span><span class="token variable">$user</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">AccessDeniedException</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'You are not allowed to update appointment'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>第二個改動則是 routes 的權限檢查，從負面表列變成正面表列，只有幾個特定的 command 不需登入：</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">validateNonce</span><span class="token punctuation">(</span><span class="token variable">$request</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$request</span><span class="token operator">-></span><span class="token function">getMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token string single-quoted-string">'POST'</span> <span class="token operator">&amp;&amp;</span>
        <span class="token operator">!</span><span class="token keyword static-context">self</span><span class="token operator">::</span><span class="token function">getToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
        <span class="token operator">!</span><span class="token punctuation">(</span><span class="token variable">$this</span> <span class="token keyword">instanceof</span> <span class="token class-name">LoginCabinetCommand</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
        <span class="token operator">!</span><span class="token punctuation">(</span><span class="token variable">$this</span> <span class="token keyword">instanceof</span> <span class="token class-name">AddBookingCommand</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
        <span class="token operator">!</span><span class="token punctuation">(</span><span class="token variable">$this</span> <span class="token keyword">instanceof</span> <span class="token class-name">AddStatsCommand</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
        <span class="token operator">!</span><span class="token punctuation">(</span><span class="token variable">$this</span> <span class="token keyword">instanceof</span> <span class="token class-name">MolliePaymentCommand</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
        <span class="token operator">!</span><span class="token punctuation">(</span><span class="token variable">$this</span> <span class="token keyword">instanceof</span> <span class="token class-name">MolliePaymentNotifyCommand</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
        <span class="token operator">!</span><span class="token punctuation">(</span><span class="token variable">$this</span> <span class="token keyword">instanceof</span> <span class="token class-name">PayPalPaymentCommand</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
        <span class="token operator">!</span><span class="token punctuation">(</span><span class="token variable">$this</span> <span class="token keyword">instanceof</span> <span class="token class-name">PayPalPaymentCallbackCommand</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
        <span class="token operator">!</span><span class="token punctuation">(</span><span class="token variable">$this</span> <span class="token keyword">instanceof</span> <span class="token class-name">RazorpayPaymentCommand</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
        <span class="token operator">!</span><span class="token punctuation">(</span><span class="token variable">$this</span> <span class="token keyword">instanceof</span> <span class="token class-name">WooCommercePaymentCommand</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
        <span class="token operator">!</span><span class="token punctuation">(</span><span class="token variable">$this</span> <span class="token keyword">instanceof</span> <span class="token class-name">SuccessfulBookingCommand</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token function">wp_verify_nonce</span><span class="token punctuation">(</span><span class="token variable">$request</span><span class="token operator">-></span><span class="token function">getQueryParams</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'ameliaNonce'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'ajax-nonce'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">return</span> <span class="token constant boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2><span id="cve-2022-0825-amelia-lt-1049-customer-arbitrary-appointments-status-update">CVE-2022-0825: Amelia &lt; 1.0.49 - Customer+ Arbitrary Appointments Status Update</span></h2><p>這個漏洞跟上一個類似，都是屬於權限管理的問題，而這個漏洞的路由是 <code>$app-&gt;post(&#39;/appointments/status/&#123;id:[0-9]+&#125;&#39;, UpdateAppointmentStatusController::class);</code>，對應到的程式碼在 <code>src/Application/Commands/Booking/Appointment/UpdateAppointmentStatusCommandHandler.php</code>，開頭有先做權限檢查：</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token variable">$this</span><span class="token operator">-></span><span class="token function">getContainer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">getPermissionsService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">currentUserCanWriteStatus</span><span class="token punctuation">(</span><span class="token class-name static-context">Entities</span><span class="token operator">::</span><span class="token constant">APPOINTMENTS</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">AccessDeniedException</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'You are not allowed to update appointment status'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">// update appointment</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>我們繼續往下追，去看看 <code>currentUserCanWriteStatus</code> 是怎麼實作的：</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">currentUserCanWriteStatus</span><span class="token punctuation">(</span><span class="token variable">$object</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> <span class="token variable">$this</span><span class="token operator">-></span><span class="token function">userCan</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-></span><span class="token property">currentUser</span><span class="token punctuation">,</span> <span class="token variable">$object</span><span class="token punctuation">,</span> <span class="token keyword static-context">self</span><span class="token operator">::</span><span class="token constant">WRITE_STATUS_PERMISSIONS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>再往下追，找到 <code>userCan</code>：</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">userCan</span><span class="token punctuation">(</span><span class="token variable">$user</span><span class="token punctuation">,</span> <span class="token variable">$object</span><span class="token punctuation">,</span> <span class="token variable">$permission</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$user</span> <span class="token keyword">instanceof</span> <span class="token class-name">Admin</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token constant boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">return</span> <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">permissionsChecker</span><span class="token operator">-></span><span class="token function">checkPermissions</span><span class="token punctuation">(</span><span class="token variable">$user</span><span class="token punctuation">,</span> <span class="token variable">$object</span><span class="token punctuation">,</span> <span class="token variable">$permission</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>再往下一層，在 <code>src/Infrastructure/WP/PermissionsService/PermissionsChecker.php</code> 中可以看到 <code>checkPermissions</code> 的實作：</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">checkPermissions</span><span class="token punctuation">(</span><span class="token variable">$user</span><span class="token punctuation">,</span> <span class="token variable">$object</span><span class="token punctuation">,</span> <span class="token variable">$permission</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token comment">// Admin can do all</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$user</span> <span class="token keyword">instanceof</span> <span class="token class-name">Admin</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token constant boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// Get the WP role name of the user, rollback to customer by default</span>
    <span class="token variable">$wpRoleName</span> <span class="token operator">=</span> <span class="token variable">$user</span> <span class="token operator">!==</span> <span class="token constant">null</span> <span class="token operator">?</span> <span class="token string single-quoted-string">'wpamelia-'</span> <span class="token operator">.</span> <span class="token variable">$user</span><span class="token operator">-></span><span class="token function">getType</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token string single-quoted-string">'wpamelia-customer'</span><span class="token punctuation">;</span>
    <span class="token comment">// Get the wp name of capability we are looking for.</span>
    <span class="token variable">$wpCapability</span> <span class="token operator">=</span> <span class="token string double-quoted-string">"amelia_<span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token variable">$permission</span><span class="token punctuation">&#125;</span></span>_<span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token variable">$object</span><span class="token punctuation">&#125;</span></span>"</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$user</span> <span class="token operator">!==</span> <span class="token constant">null</span> <span class="token operator">&amp;&amp;</span> <span class="token variable">$user</span><span class="token operator">-></span><span class="token function">getExternalId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!==</span> <span class="token constant">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token function">user_can</span><span class="token punctuation">(</span><span class="token variable">$user</span><span class="token operator">-></span><span class="token function">getExternalId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token variable">$wpCapability</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// If user is guest check does it have capability</span>
    <span class="token variable">$wpRole</span> <span class="token operator">=</span> <span class="token function">get_role</span><span class="token punctuation">(</span><span class="token variable">$wpRoleName</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token variable">$wpRole</span> <span class="token operator">!==</span> <span class="token constant">null</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$wpRole</span><span class="token operator">-></span><span class="token property">capabilities</span><span class="token punctuation">[</span><span class="token variable">$wpCapability</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">?</span>
        <span class="token punctuation">(</span><span class="token keyword type-casting">bool</span><span class="token punctuation">)</span><span class="token variable">$wpRole</span><span class="token operator">-></span><span class="token property">capabilities</span><span class="token punctuation">[</span><span class="token variable">$wpCapability</span><span class="token punctuation">]</span> <span class="token punctuation">:</span> <span class="token constant boolean">false</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>這邊有個值得注意的地方，就是如果 user 是 <code>null</code> 的話，會被當成 <code>customer</code> 來看待，而實際檢查有沒有權限要看 capabilities 這個 table，在 <code>src/Infrastructure/WP/config/Roles.php</code>：</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token comment">// Customer</span>
<span class="token punctuation">[</span>
    <span class="token string single-quoted-string">'name'</span>         <span class="token operator">=></span> <span class="token string single-quoted-string">'wpamelia-customer'</span><span class="token punctuation">,</span>
    <span class="token string single-quoted-string">'label'</span>        <span class="token operator">=></span> <span class="token function">__</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'Amelia Customer'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'amelia'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token string single-quoted-string">'capabilities'</span> <span class="token operator">=></span> <span class="token punctuation">[</span>
        <span class="token string single-quoted-string">'read'</span>                             <span class="token operator">=></span> <span class="token constant boolean">true</span><span class="token punctuation">,</span>
        <span class="token string single-quoted-string">'amelia_read_menu'</span>                 <span class="token operator">=></span> <span class="token constant boolean">true</span><span class="token punctuation">,</span>
        <span class="token string single-quoted-string">'amelia_read_calendar'</span>             <span class="token operator">=></span> <span class="token constant boolean">true</span><span class="token punctuation">,</span>
        <span class="token string single-quoted-string">'amelia_read_appointments'</span>         <span class="token operator">=></span> <span class="token constant boolean">true</span><span class="token punctuation">,</span>
        <span class="token string single-quoted-string">'amelia_read_events'</span>               <span class="token operator">=></span> <span class="token constant boolean">true</span><span class="token punctuation">,</span>
        <span class="token string single-quoted-string">'amelia_write_status_appointments'</span> <span class="token operator">=></span> <span class="token constant boolean">true</span><span class="token punctuation">,</span>
        <span class="token string single-quoted-string">'amelia_write_time_appointments'</span>   <span class="token operator">=></span> <span class="token constant boolean">true</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">]</span><span class="token punctuation">,</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>其中 <code>amelia_write_status_appointments</code> 是 true，代表 customer 有權限更新狀態。</p>
<p>剩下的部分就跟上一個漏洞一樣了，更新 appointment 之後資料會整包回傳，透過 info 這個欄位可以看到消費者的個人資料。另外，這個漏洞在 1.0.47 以前會是 pre-auth 的，因為 1.0.47 以前 routes 的權限檢查還沒變成正面表列，所以沒登入也可以存取到這個指令，再加上 user 是 null 的話預設是消費者身份，完成了整條攻擊鏈的串接：</p>
<p><img src="/img/wordpress-plugin-amelia-sensitive-information-disclosure/p5-unauth-status.png" alt="update booking status"></p>
<h3><span id="修復方式">修復方式</span></h3><p>在 1.0.49 版中，移除了 customer 的 <code>amelia_write_status_appointments</code> 這個權限。</p>
<h2><span id="cve-2022-0837-amelia-lt-1048-customer-sms-service-abuse-and-sensitive-data-disclosure">CVE-2022-0837: Amelia &lt; 1.0.48 - Customer+ SMS Service Abuse and Sensitive Data Disclosure</span></h2><p>來看最後一個權限檢查相關漏洞，出問題的路由是 <code>$app-&gt;post(&#39;/notifications/sms&#39;, SendAmeliaSmsApiRequestController::class);</code>，對應到的是 <code>SendAmeliaSmsApiRequestCommandHandler</code>：</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">handle</span><span class="token punctuation">(</span><span class="token class-name type-declaration">SendAmeliaSmsApiRequestCommand</span> <span class="token variable">$command</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token variable">$result</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CommandResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/** @var SMSAPIServiceInterface $smsApiService */</span>
    <span class="token variable">$smsApiService</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-></span><span class="token function">getContainer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'application.smsApi.service'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Call method dynamically and pass data to the function. Method name is the request field.</span>
    <span class="token variable">$apiResponse</span> <span class="token operator">=</span> <span class="token variable">$smsApiService</span><span class="token operator">-></span><span class="token punctuation">&#123;</span><span class="token variable">$command</span><span class="token operator">-></span><span class="token function">getField</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'action'</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token punctuation">(</span><span class="token variable">$command</span><span class="token operator">-></span><span class="token function">getField</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'data'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token variable">$result</span><span class="token operator">-></span><span class="token function">setResult</span><span class="token punctuation">(</span><span class="token class-name static-context">CommandResult</span><span class="token operator">::</span><span class="token constant">RESULT_SUCCESS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$result</span><span class="token operator">-></span><span class="token function">setMessage</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'Amelia SMS API request successful'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$result</span><span class="token operator">-></span><span class="token function">setData</span><span class="token punctuation">(</span><span class="token variable">$apiResponse</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token variable">$result</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>可以看到這邊沒有做任何的權限檢查，而我們可以控制傳到這邊的參數：</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token variable">$apiResponse</span> <span class="token operator">=</span> <span class="token variable">$smsApiService</span><span class="token operator">-></span><span class="token punctuation">&#123;</span><span class="token variable">$command</span><span class="token operator">-></span><span class="token function">getField</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'action'</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token punctuation">(</span><span class="token variable">$command</span><span class="token operator">-></span><span class="token function">getField</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'data'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>在 smsApiService 中有不少方法，而其中只有一個參數的包括可以拿到管理員個人資訊的 <code>getUserInfo</code>，可以拿到付款紀錄的 <code>getPaymentHistory</code>，以及可以發送測試簡訊的 <code>testNotification</code>：</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">getUserInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token variable">$route</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'auth/info'</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token variable">$this</span><span class="token operator">-></span><span class="token function">sendRequest</span><span class="token punctuation">(</span><span class="token variable">$route</span><span class="token punctuation">,</span> <span class="token constant boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">getPaymentHistory</span><span class="token punctuation">(</span><span class="token variable">$data</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token variable">$route</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'/payment/history'</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token variable">$this</span><span class="token operator">-></span><span class="token function">sendRequest</span><span class="token punctuation">(</span><span class="token variable">$route</span><span class="token punctuation">,</span> <span class="token constant boolean">true</span><span class="token punctuation">,</span> <span class="token variable">$data</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">testNotification</span><span class="token punctuation">(</span><span class="token variable">$data</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token variable">$route</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'/sms/send'</span><span class="token punctuation">;</span>

    <span class="token comment">/** @var SettingsService $settingsService */</span>
    <span class="token variable">$settingsService</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">container</span><span class="token operator">-></span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'domain.settings.service'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/** @var EmailNotificationService $notificationService */</span>
    <span class="token variable">$notificationService</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">container</span><span class="token operator">-></span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'application.emailNotification.service'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/** @var PlaceholderService $placeholderService */</span>
    <span class="token variable">$placeholderService</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">container</span><span class="token operator">-></span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"application.placeholder.<span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token variable">$data</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'type'</span><span class="token punctuation">]</span><span class="token punctuation">&#125;</span></span>.service"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token variable">$appointmentsSettings</span> <span class="token operator">=</span> <span class="token variable">$settingsService</span><span class="token operator">-></span><span class="token function">getCategorySettings</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'appointments'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token variable">$notification</span> <span class="token operator">=</span> <span class="token variable">$notificationService</span><span class="token operator">-></span><span class="token function">getById</span><span class="token punctuation">(</span><span class="token variable">$data</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'notificationTemplate'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token variable">$dummyData</span> <span class="token operator">=</span> <span class="token variable">$placeholderService</span><span class="token operator">-></span><span class="token function">getPlaceholdersDummyData</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'sms'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token variable">$isForCustomer</span> <span class="token operator">=</span> <span class="token variable">$notification</span><span class="token operator">-></span><span class="token function">getSendTo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token class-name static-context">NotificationSendTo</span><span class="token operator">::</span><span class="token constant">CUSTOMER</span><span class="token punctuation">;</span>

    <span class="token variable">$placeholderStringRec</span>  <span class="token operator">=</span> <span class="token string single-quoted-string">'recurring'</span> <span class="token operator">.</span> <span class="token string single-quoted-string">'Placeholders'</span> <span class="token operator">.</span> <span class="token punctuation">(</span><span class="token variable">$isForCustomer</span> <span class="token operator">?</span> <span class="token string single-quoted-string">'Customer'</span> <span class="token punctuation">:</span> <span class="token string single-quoted-string">''</span><span class="token punctuation">)</span> <span class="token operator">.</span> <span class="token string single-quoted-string">'Sms'</span><span class="token punctuation">;</span>
    <span class="token variable">$placeholderStringPack</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'package'</span> <span class="token operator">.</span> <span class="token string single-quoted-string">'Placeholders'</span> <span class="token operator">.</span> <span class="token punctuation">(</span><span class="token variable">$isForCustomer</span> <span class="token operator">?</span> <span class="token string single-quoted-string">'Customer'</span> <span class="token punctuation">:</span> <span class="token string single-quoted-string">''</span><span class="token punctuation">)</span> <span class="token operator">.</span> <span class="token string single-quoted-string">'Sms'</span><span class="token punctuation">;</span>

    <span class="token variable">$dummyData</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'recurring_appointments_details'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token variable">$placeholderService</span><span class="token operator">-></span><span class="token function">applyPlaceholders</span><span class="token punctuation">(</span><span class="token variable">$appointmentsSettings</span><span class="token punctuation">[</span><span class="token variable">$placeholderStringRec</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token variable">$dummyData</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$dummyData</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'package_appointments_details'</span><span class="token punctuation">]</span>   <span class="token operator">=</span>  <span class="token variable">$placeholderService</span><span class="token operator">-></span><span class="token function">applyPlaceholders</span><span class="token punctuation">(</span><span class="token variable">$appointmentsSettings</span><span class="token punctuation">[</span><span class="token variable">$placeholderStringPack</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token variable">$dummyData</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


    <span class="token variable">$body</span> <span class="token operator">=</span> <span class="token variable">$placeholderService</span><span class="token operator">-></span><span class="token function">applyPlaceholders</span><span class="token punctuation">(</span>
        <span class="token variable">$notification</span><span class="token operator">-></span><span class="token function">getContent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token variable">$dummyData</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token variable">$data</span> <span class="token operator">=</span> <span class="token punctuation">[</span>
        <span class="token string single-quoted-string">'to'</span>   <span class="token operator">=></span> <span class="token variable">$data</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'recipientPhone'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token string single-quoted-string">'from'</span> <span class="token operator">=></span> <span class="token variable">$settingsService</span><span class="token operator">-></span><span class="token function">getSetting</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'notifications'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'smsAlphaSenderId'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token string single-quoted-string">'body'</span> <span class="token operator">=></span> <span class="token variable">$body</span>
    <span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token variable">$this</span><span class="token operator">-></span><span class="token function">sendRequest</span><span class="token punctuation">(</span><span class="token variable">$route</span><span class="token punctuation">,</span> <span class="token constant boolean">true</span><span class="token punctuation">,</span> <span class="token variable">$data</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>實際測試截圖：</p>
<p><img src="/img/wordpress-plugin-amelia-sensitive-information-disclosure/p6-sms1.png" alt="sms1"></p>
<p>發送測試簡訊：</p>
<p><img src="/img/wordpress-plugin-amelia-sensitive-information-disclosure/p7-sms2.png" alt="sms2"></p>
<p>發送測試簡訊也是要扣錢的，我們只要一直打這個 endpoint，就會一直發送測試簡訊然後一直扣款，可以利用這個漏洞把管理員的錢燒光。</p>
<h3><span id="修復方式">修復方式</span></h3><p>在 1.0.48 版中，於 controller 內加上了權限檢查：</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token variable">$this</span><span class="token operator">-></span><span class="token function">getContainer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">getPermissionsService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">currentUserCanWrite</span><span class="token punctuation">(</span><span class="token class-name static-context">Entities</span><span class="token operator">::</span><span class="token constant">NOTIFICATIONS</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">AccessDeniedException</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'You are not allowed to send test email'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<h2><span id="總結">總結</span></h2><p>當開發的軟體變得愈來愈複雜，開發者往往容易忽略一些基本的權限檢查，以及對於權限有著錯誤的假設。舉例來說，雖然 appointment 相關的 API 是給 provider 用的，前端的消費者看不到這些 API，但是 WordPress 外掛的程式碼都是開放的，任何人只要看了程式碼，都能找出所有的 API 路徑。</p>
<p>在實作各種功能時，要記得把權限檢查放在第一位，確認當前的使用者對於欲操作的資源有權限以後，才繼續後面的流程。</p>
<p>最後附上時間軸：</p>
<p><code>2022-02-20</code> 透過 WPScan 回報更新預約漏洞，保留 CVE-2022-0720<br><code>2022-03-01</code> 發布 1.0.47 版，修復 CVE-2022-0720，部分資訊公開於 <a target="_blank" rel="noopener" href="https://wpscan.com/vulnerability/435ef99c-9210-46c7-80a4-09cd4d3d00cf">WPScan</a><br><code>2022-03-02</code> 透過 WPScan 回報更新預約狀態漏洞，保留 CVE-2022-0825<br><code>2022-03-03</code> 透過 WPScan 回報 SMS 相關漏洞，保留 CVE-2022-0837<br><code>2022-03-09</code> 發布 1.0.48 版，修復 CVE-2022-0837，部分資訊公開於 <a target="_blank" rel="noopener" href="https://wpscan.com/vulnerability/0882e5c0-f319-4994-9346-aa18438fda6a">WPScan</a><br><code>2022-03-14</code> 發布 1.0.49 版，修復 CVE-2022-0825，部分資訊公開於 <a target="_blank" rel="noopener" href="https://wpscan.com/vulnerability/1a92a65f-e9df-41b5-9a1c-8e24ee9bf50e">WPScan</a><br><code>2022-03-26</code> 漏洞細節公開於 WPScan<br><code>2022-03-30</code> 文章發佈</p>

    
    </div>
    
    <div class="columns is-variable is-1 is-multiline is-mobile">
    
        <span class="column is-narrow"><a class="tag is-light article-tag" href="/tags/Security/">#Security</a></span>
    
    </div>
    
    
    <div class="columns is-mobile is-multiline article-nav">
        <span class="column is-12-mobile is-half-desktop  article-nav-prev">
            
            <a href="/2022/04/07/iframe-and-window-open/">iframe 與 window.open 黑魔法</a>
            
        </span>
        <span class="column is-12-mobile is-half-desktop  article-nav-next">
            
            <a href="/2022/03/27/linectf-2022-writeup/">LINE CTF 2022 筆記</a>
            
        </span>
    </div>
    
</article>




<div class="comments">
    <h3 class="title is-4">評論</h3>
    <script src="https://utteranc.es/client.js"
        repo="aszx87410/huli-blog"
        issue-term="title"
        theme="github-light"
        crossorigin="anonymous"
        async>
</script>
</div>

    </div>
</section>
    <footer class="footer">
    <div class="container">
        <div class="columns content">
            <div class="column is-narrow has-text-centered">
                &copy; 2023 Huli&nbsp;
                Powered by <a href="http://hexo.io/" target="_blank">Hexo</a> & <a
                        target="_blank" rel="noopener" href="http://github.com/ppoffice/hexo-theme-minos">Minos</a>
            </div>
            <div class="column is-hidden-mobile"></div>

            
            <div class="column is-narrow">
                <div class="columns is-mobile is-multiline is-centered">
                
                    
                <a class="column is-narrow" title="GitHub" target="_blank" rel="noopener" href="https://github.com/ppoffice/hexo-theme-minos">
                    
                    GitHub
                    
                </a>
                
                </div>
            </div>
            
            
<div class="column is-narrow has-text-centered">
    <div class="dropdown is-up is-right is-hoverable" style="margin-top: -0.2em;">
        <div class="dropdown-trigger">
            <button class="button is-small" aria-haspopup="true">
                <span class="icon">
                    <i class="fas fa-globe"></i>
                </span>
                <span>繁體中文</span>
                <span class="icon is-small">
            <i class="fas fa-angle-down" aria-hidden="true"></i>
          </span>
            </button>
        </div>
        <div class="dropdown-menu has-text-left" role="menu" style="top:100%">
            <div class="dropdown-content">
            <!-- NOTE: 永遠回到首頁 -->
            
                <a href="/2022/03/30/en/wordpress-plugin-amelia-sensitive-information-disclosure/" class="dropdown-item">
                    English
                </a>
            
            </div>
        </div>
    </div>
</div>

        </div>
    </div>
</footer>
    <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/3.6.3/jquery.min.js"></script>



    
    
    
    
    
    
<script src="//cdnjs.cloudflare.com/ajax/libs/lightgallery/1.6.8/js/lightgallery-all.min.js"></script>
<script>
    (function ($) {
        $(document).ready(function () {
            if (typeof($.fn.lightGallery) === 'function') {
                $('.article.gallery').lightGallery({ selector: '.gallery-item' });
            }
        });
    })(jQuery);
</script>

    
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.0/clipboard.min.js"></script>
    <style>
        .hljs {
            position: relative;
        }

        .hljs .clipboard-btn {
            float: right;
            color: #9a9a9a;
            background: none;
            border: none;
            cursor: pointer;
        }

        .hljs .clipboard-btn:hover {
          color: #8a8a8a;
        }

        .hljs > .clipboard-btn {
            display: none;
            position: absolute;
            right: 4px;
            top: 4px;
        }

        .hljs:hover > .clipboard-btn {
            display: inline;
        }

        .hljs > figcaption > .clipboard-btn {
            margin-right: 4px;
        }
    </style>
    <script>
      $(document).ready(function () {
        $('figure.hljs').each(function(i, figure) {
          var codeId = 'code-' + i;
          var code = figure.querySelector('.code');
          var copyButton = $('<button>Copy <i class="far fa-clipboard"></i></button>');
          code.id = codeId;
          copyButton.addClass('clipboard-btn');
          copyButton.attr('data-clipboard-target-id', codeId);

          var figcaption = figure.querySelector('figcaption');

          if (figcaption) {
            figcaption.append(copyButton[0]);
          } else {
            figure.prepend(copyButton[0]);
          }
        })

        var clipboard = new ClipboardJS('.clipboard-btn', {
          target: function(trigger) {
            return document.getElementById(trigger.getAttribute('data-clipboard-target-id'));
          }
        });
        clipboard.on('success', function(e) {
          e.clearSelection();
        })
      })
    </script>

    
    

    



<script src="/js/script.js?v=3.js"></script>


    
</body>
</html>